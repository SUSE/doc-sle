<?xml version="1.0" encoding="UTF-8"?>
<sect2 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="system_repair.xml" version="5.0" xml:id="sec.trouble.data.recover.rescue">
 <title>使用救援系统</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info><indexterm>
 <primary>应急系统</primary></indexterm><indexterm>
 <primary>系统</primary>
 <secondary>应急</secondary></indexterm>
 <para>
  有多种原因会造成系统无法正常启动和运行。系统崩溃后造成文件系统损坏、配置文件损坏或引导加载程序配置损坏是最常见的原因。
 </para>
 <para>
  为了帮助您解决这些状况，<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 提供了一套您可以引导的救援系统。该救援系统是一个小型 Linux 系统，可以装载到一个 RAM 磁盘并以 root 文件系统的形式装入，使您可以从外部访问 Linux 分区。使用该救援系统，可以恢复或修改系统中任何一个重要的方面：
 </para>
 <itemizedlist mark="bullet" spacing="normal">
  <listitem>
   <para>
    操作任意类型的配置文件。
   </para>
  </listitem>
  <listitem>
   <para>
    检查文件系统中的缺陷和启动自动修复进程。
   </para>
  </listitem>
  <listitem>
   <para>
    访问<quote>更改 root</quote>环境下的已安装系统。
   </para>
  </listitem>
  <listitem>
   <para>
    检查、修改和重新安装引导加载程序配置。
   </para>
  </listitem>
  <listitem>
   <para>
    从安装有误的设备驱动程序或不可用内核恢复。
   </para>
  </listitem>
  <listitem>
   <para>
    使用 parted 命令调整分区大小。在 GNU Parted 网站 <link xlink:href="http://www.gnu.org/software/parted/parted.html"/> 上可以找到有关该工具的更多信息。
   </para>
  </listitem>
 </itemizedlist>
 <para>
  该救援系统可以从各种来源和位置进行装载。最简单的选择是从原始安装媒体上引导该救援系统。
 </para>
 <note os="sles" arch="zseries">
  <title>在 IBM z Systems 上启动救援系统</title>
  <para>
   在 IBM z Systems 上，可将安装系统用于救援。要启动救援系统，请根据<xref linkend="sec.zseries.rescue"/>中的说明操作。
  </para>
 </note>
 <procedure><indexterm>
  <primary>救援系统</primary>
  <secondary>从媒体启动</secondary></indexterm>
  <step>
   <para>
    将安装媒体插入 DVD 驱动器中。
   </para>
  </step>
  <step>
   <para>
    重引导系统。
   </para>
  </step>
  <step>
   <para>
    在引导屏幕上按 <keycap>F4</keycap> 并选择 <guimenu>DVD-ROM</guimenu>。然后从主屏幕选择<guimenu>救援系统</guimenu>。
   </para>
  </step>
  <step>
   <para>
    在 <literal>Rescue: </literal>提示符处输入 <literal>root</literal>。无需口令。
   </para>
  </step>
 </procedure>
 <procedure xml:id="proc.trouble.data.recover.rescue.network"><indexterm>
  <primary> 救援系统</primary>
  <secondary> 从网络源启动</secondary></indexterm> 
  <para>
   如果硬件设置不包含 DVD 驱动器，可以从网络源引导该救援系统。以下示例适用于远程引导的情形，如果使用另一引导媒体（例如 DVD），则要相应地修改 <filename>info</filename> 文件，并像正常安装一样进行引导。
  </para>
  <step>
   <para>
    输入 PXE 引导设置的配置，添加以下行：<literal>install=<replaceable>protocol</replaceable>://<replaceable>instsource</replaceable></literal> 和<literal>rescue=1</literal>。但如果需要启动修复系统，请使用 <literal>repair=1</literal>。如同正常安装的情况一样，<replaceable>protocol</replaceable> 代表任何一种所支持的网络协议（NFS、HTTP、FTP 等）；<replaceable>instsource</replaceable> 代表网络安装源的路径。
   </para>
  </step>
  <step>
   <para>
    如<xref linkend="sec.deployment.prep_boot.wol"/>中所述，使用<quote>网络唤醒</quote><phrase os="sles;sled">引导系统。</phrase>
   </para>
  </step>
  <step>
   <para>
    在 <literal>Rescue: </literal>提示符处输入 <literal>root</literal>。无需口令。
   </para>
  </step>
 </procedure>
 <para>
  一旦进入该救援系统，便可通过 <keycombo><keycap function="alt"/><keycap>F1</keycap></keycombo> 到 <keycombo><keycap function="alt"/><keycap>F6</keycap></keycombo> 键来访问虚拟控制台。
 </para>
 <para>
  可以在 <filename>/bin</filename> 目录下找到外壳和许多其他有用的实用程序，如 mount 程序。<filename>/sbin</filename> 目录包含重要的用于查看和修复文件系统的文件和网络实用程序。此目录还包含用于系统维护的最重要的二进制文件，如 <command>fdisk</command>、<command>mkfs</command>、<command>mkswap</command>、<command>mount</command> 和 <command>shutdown</command>，以及用于维护网络的 <command>ip</command> 和 <command>ss</command>。目录 <filename>/usr/bin</filename> 包含 vi 编辑器、find、less 和 SSH。
 </para>
 <para>
  要查看系统讯息，请使用命令 <command>dmesg</command>，或使用 <command>journalctl</command> 查看系统日志。
 </para>
 <sect3 xml:id="sec.trouble.data.recover.rescue.file">
  <title>检查和操作配置文件</title>
  <para>
   举一个可以通过该救援系统修复配置的例子，假设有一个被损坏的配置文件，使该系统无法正常引导。您可以通过救援系统修复该配置文件。
  </para>
  <procedure>
   <para>
    要操作配置文件，请执行以下步骤：
   </para>
   <step>
    <para>
     用上述方法之一启动救援系统。
    </para>
   </step>
   <step>
    <para>
     要在救援系统中装入位于 <filename>/dev/sda6</filename> 下的 root 文件系统，请使用如下命令：
    </para>
<screen>mount /dev/sda6 /mnt</screen>
    <para>
     系统所有目录现在均位于 <filename>/mnt</filename> 之下
    </para>
   </step>
   <step>
    <para>
     将目录切换为所装入的 root 文件系统：
    </para>
<screen>cd /mnt</screen>
   </step>
   <step>
    <para>
     在 vi 编辑器中打开有问题的配置文件。调整并保存配置。
    </para>
   </step>
   <step>
    <para>
     从救援系统中卸载 root 文件系统：
    </para>
<screen>umount /mnt</screen>
   </step>
   <step>
    <para>
     重引导计算机。
    </para>
   </step>
  </procedure>
 </sect3>
 <sect3 xml:id="sec.trouble.data.recover.rescue.filesystem">
  <title>修复和检查文件系统</title><indexterm>
  <primary>文件系统</primary>
  <secondary>修复</secondary></indexterm>
  <para>
   通常，不能在正在运行的系统上修复文件系统。如果遇到严重问题，您甚至都无法装入 root 文件系统，系统引导可能以显示 <quote>kernel panic</quote> 结束。在这种情况下，唯一的方法是从外部修复系统。该系统包含的实用程序可检查并修复 <literal>btrfs</literal>、<literal>ext2</literal>、<literal>ext3</literal>、<literal>ext4</literal>、<literal>reiserfs</literal>、<literal>xfs</literal>、<literal>dosfs</literal> 和 <literal>vfat</literal> 文件系统。您可以试试命令 <command>fsck.</command> <replaceable>文件系统</replaceable>，例如，如果需要对 <literal>btrfs</literal> 进行文件系统检查，请使用 <command>fsck.btrfs</command>。
  </para>

 </sect3>
 <sect3 xml:id="sec.trouble.data.recover.rescue.access">
  <title>访问已安装系统</title>
  <para>
   如果需要从救援系统访问已安装系统，需要在<emphasis>更改 root</emphasis> 环境中执行此操作。例如，修改引导加载程序配置或执行硬件配置实用程序。
  </para>
  <para>
   要设置基于已安装系统的更改 root 环境，请执行以下步骤：
  </para>
  <procedure>
   <step>
    <para>
     运行 <command>lsblk</command> 以检查哪个节点对应于根分区。在本例中，该节点为 <filename>/dev/sda2</filename>：
    </para>
<screen>lsblk
NAME        MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT
sda           8:0    0 149,1G  0 disk
├─sda1        8:1    0     2G  0 part  [SWAP]
├─sda2        8:2    0    20G  0 part  /
└─sda3        8:3    0   127G  0 part
  └─cr_home 254:0    0   127G  0 crypt /home</screen>
   </step>
   <step>
    <para>
     从安装的系统装入根分区：
    </para>
<screen>mount /dev/sda2 /mnt</screen>
   </step>
   <step>
    <para>
     装入 <filename>/proc</filename>、<filename>/dev</filename> 和 <filename>/sys</filename> 分区：
    </para>
<screen>mount -t proc none /mnt/proc
mount --rbind /dev /mnt/dev
mount --rbind /sys /mnt/sys</screen>
   </step>
   <step>
    <para>
     现在可以<quote>更改根分区</quote>为新的环境，并保留 <systemitem>bash</systemitem> 外壳：
    </para>
<screen>chroot /mnt /bin/bash</screen>
   </step>
   <step>
    <para>
     最后，装入已安装系统的剩余分区：
    </para>
<screen>mount -a</screen>
   </step>
   <step>
    <para>
     现在可以访问已安装系统了。在重引导系统之前，请用 <command>umount </command> <option>-a</option> 卸载分区并用 <quote>exit</quote> 退出<command>更改 root</command>环境。
    </para>
   </step>
  </procedure>
  <warning>
   <title>限制</title>
   <para>
    尽管对已安装系统的文件和应用程序有完全访问权，但仍有一些限制。运行的内核是用救援系统引导的那个，不是用更改 root 环境引导的那个。它仅支持关键硬件，如果内核版本不完全相同，则无法从已安装系统中添加内核模块。始终用 <command>uname -r</command> 检查当前正在运行的（救援）内核版本，然后查明更改 root 环境中 <filename>/lib/modules</filename> 目录下是否有匹配的子目录。如果是，可以使用已安装模块；否则，需要在其他媒体（例如闪盘）上提供模块的正确版本。很多时候，救援内核版本与已安装模块不同，这样您完全无法访问声卡等。也不可能启动图形用户界面。
   </para>
   <para>
    还应注意，在使用 <quote>F1</quote> 到 <keycombo><keycap function="alt"/><keycap>F6</keycap></keycombo> 键切换控制台时，要退出<keycombo><keycap function="alt"/><keycap>更改 root</keycap></keycombo>环境。
   </para>
  </warning>
 </sect3>
 <sect3 xml:id="sec.trouble.data.recover.rescue.grub">
  <title>修改和重新安装引导加载程序</title>
  <para>
   有时，系统无法引导是因为引导加载程序配置已损坏。例如，如果没有正常工作的引导加载程序，启动例程将无法将物理驱动器转化为 Linux 文件系统中的实际位置。
  </para>
  <para>
   要检查引导加载程序配置并重新安装引导加载程序，请执行以下步骤：
  </para>
  <procedure>
   <step>
    <para>
     如<xref linkend="sec.trouble.data.recover.rescue.access"/> 中所述执行必要的步骤以访问已安装系统。
    </para>
   </step>
   <step>
    <para>
     检查系统上是否已安装 GRUB 2 引导加载程序。如果未安装，请安装 <systemitem>grub2</systemitem> 包并运行
    </para>
<screen>grub2-install /dev/sda</screen>
   </step>
   <step>
    <para>
     根据<xref linkend="cha.grub2"/>中所述的 GRUB 2 配置原则，检查下列文件是否正确配置，并根据需要应用修复。
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       <filename>/etc/default/grub</filename>
      </para>
     </listitem>
     <listitem>
      <para>
       <filename>/boot/grub2/device.map</filename>（选用文件，手动创建后才存在）
      </para>
     </listitem>
     <listitem>
      <para>
       <filename>/boot/grub2/grub.cfg</filename>（此文件是系统生成的，不要编辑）
      </para>
     </listitem>
     <listitem>
      <para>
       <filename>/etc/sysconfig/bootloader</filename>
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     使用以下命令序列重新安装引导加载程序：
    </para>
<screen>grub2-mkconfig -o /boot/grub2/grub.cfg</screen>
   </step>
   <step>
    <para>
     卸载分区，从<quote>更改 root</quote>环境中注销并重引导该系统：
    </para>
<screen>umount -a
exit
reboot</screen>
   </step>
  </procedure>
 </sect3>
 <sect3 xml:id="sec.trouble.data.recover.rescue.dud">
  <title>修复内核安装</title>
  <para>
   内核更新会产生新的 bug，这样会影响系统运行。例如，系统某个硬件的驱动程序有故障，您就无法访问和使用该硬件。在这种情况下，需还原到上一个工作内核（如果在系统上可用），或从安装媒体安装原始内核。
  </para>
  <tip>
   <title>如何在更新后保留最后几个内核</title>
   <para>
    为了防止内核更新出现故障后无法进行引导，请使用内核多版本功能，并告知 <systemitem>libzypp</systemitem> 在更新后保留哪些内核。
   </para>
   <para>
    例如，要始终保留最后两个内核和当前正在运行的内核，请将
   </para>
<screen>multiversion.kernels = latest,latest-1,running</screen>
   <para>
    添加到 <filename>/etc/zypp/zypp.conf</filename> 文件。有关详细信息，请参见<xref linkend="cha.tuning.multikernel"/>。
   </para>
  </tip>
  <para>
   类似的情况是，当您需要重新安装或更新不受 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 支持的设备的已损坏驱动程序时。例如，当硬件供应商使用特定设备时，比如硬件 RAID 控制器，它需要一个二进制驱动程序才能被操作系统识别。供应商通常会发布含有固定版或更新版必要驱动程序的驱动程序更新磁盘 (DUD)。
  </para>
  <para>
   这两种情况下，您都需要以救援模式访问已安装系统，并修复内核相关问题，否则系统可能无法正确引导：
  </para>
  <procedure>
   <step>
    <para>
     从 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 安装媒体引导。
    </para>
   </step>
   <step>
    <para>
     如果您正在从内核更新故障中恢复，请跳过此步骤。如果需要使用驱动程序更新磁盘 (DUD)，请在出现引导菜单后按 <keycap>F6</keycap> 装载驱动程序更新，并选择驱动程序更新的路径或 URL，然后确认<guimenu>是</guimenu>。
    </para>
   </step>
   <step>
    <para>
     从引导菜单中选择<guimenu>救援系统</guimenu>，并按 <keycap function="enter"/>。如果选择使用 DUD，将要求您指定储存驱动程序更新的位置。
    </para>
   </step>
   <step>
    <para>
     在 <literal>Rescue: </literal>提示符处输入 <literal>root</literal>。无需口令。
    </para>
   </step>
   <step>
    <para>
     手动将目标系统和<quote>更改 root</quote>装入新环境。有关详细信息，请参见<xref linkend="sec.trouble.data.recover.rescue.access"/>。
    </para>
   </step>
   <step>
    <para>
     如果使用的是 DUD，请安装/重新安装/更新有故障的设备驱动程序包。始终确保已安装的内核版本与您正在安装的驱动程序版本完全相同。
    </para>
    <para>
     如果要修复有故障的内核更新安装，可以从安装媒体使用以下过程安装原始内核。
    </para>
    <substeps performance="required">
     <step>
      <para>
       使用 <command>hwinfo --cdrom</command> 命令确定您的 DVD 设备信息，使用 <command>mount /dev/sr0 /mnt</command> 命令装入设备。
      </para>
     </step>
     <step>
      <para>
       导航到 DVD 上储存内核文件的目录，例如，<command>cd /mnt/suse/x86_64/</command>。
      </para>
     </step>
     <step>
      <para>
       使用 <command>rpm -i</command> 命令安装具有您风格的必需 <systemitem>kernel-*</systemitem>、<systemitem>kernel-*-base</systemitem> 和 <systemitem>kernel-*-extra</systemitem> 包。
      </para>
     </step>

    </substeps>
   </step>
   <step>
    <para>
     更新配置文件，必要时可重初始化引导加载程序。有关详细信息，请参见<xref linkend="sec.trouble.data.recover.rescue.grub"/>。
    </para>
   </step>
   <step>
    <para>
     从系统驱动器中删除所有可引导的媒体，然后重引导。
    </para>
   </step>
  </procedure>
 </sect3>
</sect2>
