<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_migration.xml" version="5.0" xml:id="cha.update.spmigration">
 <title>Service Pack-Migration</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>Ja</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    Für das Upgrade auf einen neuen Service Pack stehen in SUSE ein grafisches Tool und ein Kommandozeilenwerkzeug zur Verfügung. Diese sind einfache Kommandozeilenwerkzeuge, eine intuitive grafische Benutzeroberfläche, Unterstützung für das <quote>Rollback</quote> von Service Packs und dergleichen mehr. In diesem Kapitel wird die Ausführung einer Service Pack-Migration mit diesen Tools Schritt für Schritt erläutert.
   </para>
  </abstract>
 </info>
 <sect1 xml:id="sec.update.migr.conceptual-overview">
  <title>Konzeptüberblick</title>

  <para>
   SUSE veröffentlicht in regelmäßigen Abständen neue Service Packs für die SUSE Linux Enterprise-Produktfamilie. Um den Kunden die Migration auf einen neuen Service Pack zu erleichtern und die Ausfallzeiten so kurz wie möglich zu halten, unterstützt SUSE eine Online-Migration bei laufendem System.
  </para>

  <para>
   Ab SLE 12 SP2 werden anstelle von YaST-Wagon die YaST-Migration (GUI) und die Zypper-Migration (Kommandozeile) verwendet. Folgende Funktionen werden unterstützt:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Das System befindet sich bis zur Aktualisierung des ersten RPM stets in einem definierten Status
    </para>
   </listitem>
   <listitem>
    <para>
     Der Vorgang kann bis zur Aktualisierung des ersten RPM jederzeit abgebrochen werden
    </para>
   </listitem>
   <listitem>
    <para>
     Unkomplizierte Wiederherstellung bei einem Fehler
    </para>
   </listitem>
   <listitem>
    <para>
     <quote>Rollback</quote> über Systemtools; keine Sicherung/Wiederherstellung erforderlich
    </para>
   </listitem>
   <listitem>
    <para>
     Verwendung aller aktiven Repositorys
    </para>
   </listitem>
   <listitem>
    <para>
     Möglichkeit zum Überspringen eines Service Packs
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.supported-scenarios-and-versions">
  <title>Unterstützte Softwareszenarien und Produktversionen</title>

  <para>
   SUSE unterstützt folgende Szenarios (offline oder online):
  </para>

  <variablelist>
   <varlistentry>
    <term>Online</term>
    <listitem>
     <para>
      SUSE Customer Center (SCC), Subscription Management Tool (SMT), SUSE Manager
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Offline</term>
    <listitem>
     <para>
      Boot-DVD, Flash-Laufwerk, ISO-Image, AutoYaST, <quote>reines RPM</quote> und Drittanbieter-Tools
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   Migrationen aus folgenden Versionen werden unterstützt:
  </para>

  <variablelist>
   <varlistentry>
    <term>Online</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 12
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Offline</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 11 SP3/SP4, SUSE Linux Enterprise 12
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Manuell/Drittanbieter</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 12
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec.update.migr.workflow">
  <title>Arbeitsfluss der Service Pack-Migration</title>

  <para>
   Eine Service Pack-Migration kann mit YaST, <command>zypper</command> oder AutoYAST ausgeführt werden.
  </para>

  <para>
   Vor dem Beginn einer Service Pack-Migration muss das System beim SUSE Customer Center registriert werden. Eine Migration kann nicht mit selbsterstellenden Repositorys, die von DVDs abgeleitet werden, durchgeführt werden.
  </para>

  <para>
   Unabhängig von der Methode besteht eine Service Pack-Migration jedoch immer aus den folgenden Schritten:
  </para>

  <orderedlist>
   <listitem>
    <para>
     Suchen von möglichen Migrationszielen auf den registrierten Systemen
    </para>
   </listitem>
   <listitem>
    <para>
     Auswahl eines Migrationsziels
    </para>
   </listitem>
   <listitem>
    <para>
     Anfordern und Aktivieren neuer Repositorys
    </para>
   </listitem>
   <listitem>
    <para>
     Ausführen der Migration
    </para>
   </listitem>
  </orderedlist>



  <para>
   Die Liste der Migrationsziele ist abhängig von den installierten und registrierten Produkten. Falls Sie eine Erweiterung installiert haben, für die das neue Service Pack noch nicht zur Verfügung steht, wird Ihnen unter Umständen gar kein Migrationsziel angeboten.
  </para>

  <para>
   Die Liste der Migrationsziele, die für Ihren Host verfügbar sind, wird immer aus dem SUSE Customer Center abgerufen und hängt von den installierten Produkten oder Erweiterungen ab.
  </para>
 </sect1>
 <sect1 xml:id="sec.update.migr.cancel.spm">
  <title>Abbrechen einer Service Pack-Migration</title>

  <para>
   Während des Migrationsvorgangs kann eine Service Pack-Migration nur in ganz bestimmten Phasen abgebrochen werden:
  </para>

  <orderedlist>
   <listitem>
    <para>
     Bis zum Beginn des Paketupgrades erfolgen auf dem System nur minimale Änderungen, beispielsweise für Services und Repositorys. Stellen Sie <filename>/etc/zypp/repos.d/*</filename> wieder her, um zum vorherigen Zustand zurückzukehren.
    </para>
   </listitem>
   <listitem>
    <para>
     Nach Beginn des Paketupgrades können Sie mithilfe eines Snapper-Snapshots zum vorherigen Zustand zurückkehren (siehe <xref linkend="cha.snapper"/>).
    </para>
   </listitem>
   <listitem>
    <para>
     Nach der Auswahl des Migrationsziels ändert das SUSE Customer Center die Repository-Daten. Wenn Sie diesen Zustand manuell zurücksetzen möchten, verwenden Sie <command>SUSEConnect</command> <option>--rollback</option>.
    </para>
   </listitem>
  </orderedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.yast.onlinemigr">
  <title>Migrieren mit dem Tool für die Online-Migration (YaST)</title>

  <para>
   Für eine Service Pack-Migration mit YaST verwenden Sie das Tool für die <guimenu>Online-Migration</guimenu>. YaST installiert standardmäßig keine Pakete aus Repositorys von Drittanbietern. Wurde ein Paket aus einem Repository eines Drittanbieters installiert, verhindert YaST, dass das Paket durch das gleiche Paket aus SUSE ersetzt wird.
  </para>

  <note>
   <title>Reduzieren des Installationsumfangs</title>
   <para>
    Bei der SP-Migration installiert YaST alle empfohlenen Pakete. Vor allem bei benutzerdefinierten Minimalinstallationen kann dies den Installationsumfang auf dem System beträchtlich erhöhen. 
   </para>
   <para>
    Sie können dieses Standardverhalten ändern und dafür sorgen, dass nur erforderliche Pakete installiert werden, indem Sie <filename>/etc/zypp/zypp.conf</filename> anpassen und die folgende Variable festlegen:
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   Dadurch ändert sich das Verhalten sämtlicher Paketvorgänge, z. B. Installationen von Patches oder neuen Paketen.
  </para>

  <para>
   Gehen Sie wie folgt vor, um die Service Pack-Migration zu starten:
  </para>

  <procedure xml:id="pro.update.migr.yast">
   <step>
    <para>
     Führen Sie die YaST-Online-Aktualisierung aus, um die neuesten Paketaktualisierungen für Ihr System zu erhalten.
    </para>
   </step>
   <step>
    <para>
     Installieren Sie das Paket
     <package>yast2-migration</package>
     und seine abhängigen Komponenten (in YaST unter <menuchoice> <guimenu>Software</guimenu> <guimenu>Software installieren oder löschen</guimenu> </menuchoice>).
    </para>
   </step>
   <step>
    <para>
     Starten Sie YaST neu, damit das neu installierte Modul im Kontrollzentrum angezeigt wird.
    </para>
   </step>
   <step>
    <para>
     Starten Sie in YaST <menuchoice> <guimenu>System</guimenu> <guimenu>Online-Migration</guimenu> </menuchoice>. YaST zeigt die möglichen Migrationsziele und eine Zusammenfassung an. Falls für Ihr System mehrere Migrationsziele verfügbar sind, wählen Sie eines davon in der Liste aus.
    </para>
   </step>
   <step>
    <para>
     Wählen Sie ein Migrationsziel in der Liste aus und setzen Sie den Vorgang mit <guimenu>Weiter</guimenu> fort.
    </para>
   </step>
   <step>
    <para>
     Falls das Migrationstool Aktualisierungs-Repositorys anbietet, sollten Sie mit <guimenu>Ja</guimenu> fortfahren.
    </para>
   </step>
   <step>
    <para>
     <remark>toms 2015-09-09: FATE#319140</remark> Falls das Tool für die Online-Migration alte Repositorys von DVD oder einem lokalen Server findet, empfiehlt es sich dringend, diese zu deaktivieren. Alte Repositorys stammen aus einem früheren SP. Alle alten Repositorys aus SCC oder SMT werden automatisch entfernt.
    </para>
   </step>
   <step>
    <para>
     Prüfen Sie die Zusammenfassung und klicken Sie dann auf <guimenu>Weiter</guimenu>, um mit der Migration fortzufahren. Bestätigen Sie die Migration mit <guimenu>Aktualisierung starten</guimenu>.
    </para>
    <remark>toms 2016-07-13: What to do in case of problems?</remark>
   </step>
   <step>
    <para>
     Starten Sie Ihr System nach einer erfolgreichen Migration neu.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.zypper.onlinemigr">
  <title>Migration mit Zypper</title>

  <para>
   Für eine Service Pack-Migration mit Zypper verwenden Sie das Kommandozeilenwerkzeug <command>zypper</command> <option>migration</option>.
  </para>

  <note>
   <title>Reduzieren des Installationsumfangs</title>
   <para>
    Bei der SP-Migration installiert YaST alle empfohlenen Pakete. Vor allem bei benutzerdefinierten Minimalinstallationen kann dies den Installationsumfang auf dem System beträchtlich erhöhen. 
   </para>
   <para>
    Sie können dieses Standardverhalten ändern und dafür sorgen, dass nur erforderliche Pakete installiert werden, indem Sie <filename>/etc/zypp/zypp.conf</filename> anpassen und die folgende Variable festlegen:
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   Dadurch ändert sich das Verhalten sämtlicher Paketvorgänge, z. B. Installationen von Patches oder neuen Paketen. Wenn Sie das Verhalten von Zypper für einen einzelnen Aufruf ändern möchten, fügen Sie in Ihrer Kommandozeile den Parameter <option>--no-recommends</option> hinzu.
  </para>

  <para>
   Gehen Sie wie folgt vor, um die Service Pack-Migration zu starten:
  </para>

  <procedure xml:id="pro.update.migr.zypper">
   <step>
    <para>
     Falls noch nicht erfolgt, registrieren Sie Ihren SUSE Linux Enterprise-Rechner:
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --regcode <replaceable>YOUR_REGISTRATION_CODE</replaceable></screen>
   </step>
   <step>
    <para>
     Installieren Sie die neuesten Aktualisierungen:
    </para>
<screen><prompt>root # </prompt><command>zypper</command> patch</screen>
   </step>
   <step>
    <para>
     Installieren Sie die Pakete
     <package>zypper-migration-plugin</package>
     und ihre Abhängigkeiten:
    </para>
<screen><prompt>root # </prompt><command>zypper</command> migration</screen>
   </step>
   <step>
    <para>
     Führen Sie <command>zypper</command> <option>migration</option> aus:
    </para>
<screen><prompt>root # </prompt><command>zypper</command> migration
Executing 'zypper  patch-check'

Refreshing service 'SUSE_Linux_Enterprise_Server_12_x86_64'.
Loading repository data...
Reading installed packages...
0 patches needed (0 security patches)

Available migrations:

    1 | SUSE Linux Enterprise Server 12 SP1 x86_64
    2 | SUSE Linux Enterprise Server 12 SP2 x86_64</screen>
    <para>
     Beachten Sie folgende Hinweise zum Migrationsvorgang:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Falls für Ihr System mehrere Migrationsziele verfügbar sind, können Sie in Zypper einen SP in der Liste auswählen. Dies entspricht dem Überspringen eines oder mehrerer SPs. Denken Sie daran, dass die Online-Migration für Basisprodukte (SLES, SLED) nur zwischen den SPs einer Hauptversion verfügbar ist.
      </para>
     </listitem>
     <listitem>
      <para>
       Zypper verwendet standardmäßig die Option <option>--no-allow-vendor-change</option>, die an <command>zypper</command> <option>dup</option> weitergeleitet wird. Wurde ein Paket aus einem Repository eines Drittanbieters installiert, verhindert diese Option, dass das Paket durch das gleiche Paket aus SUSE ersetzt wird.
      </para>
     </listitem>
     <listitem>
      <para>
       <remark>toms 2015-09-09: FATE#319140</remark> Falls Zypper alte Repositorys von DVD oder einem lokalen Server findet, empfiehlt es sich dringend, diese zu deaktivieren. Alte SCC- oder SMT-Repositorys werden automatisch entfernt.
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     Prüfen Sie alle Änderungen, insbesondere die Pakete, die entfernt werden. Geben Sie <literal>y</literal> ein, um fortzufahren (die Anzahl der Pakete, die aktualisiert werden können, ist von System zu System unterschiedlich):
    </para>
<screen>266 packages to upgrade, 54 to downgrade, 17 new, 8 to reinstall, 5 to remove, 1 to change arch.
Overall download size: 285.1 MiB. Already cached: 0 B  After the operation, additional 139.8 MiB will be used.
Continue? [y/n/? shows all options] (y):</screen>
    <para>
     Verwenden Sie zum Blättern in Ihrer Shell die Tasten <keycombo> <keycap function="shift"/> <keycap function="pageup"/> </keycombo> oder <keycombo> <keycap function="shift"/> <keycap function="pagedown"/> </keycombo>.
    </para>
   </step>
   <step>
    <para>
     Starten Sie Ihr System nach einer erfolgreichen Migration neu.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.plainzypper.onlinemigr">
  <title>Migrieren mit Plain Zypper</title>

  <para>
   Wenn Sie die YaST-Migration oder die Zypper-Migration nicht verwenden können, haben Sie die Möglichkeit, die Migration mit einer einfachen Zypper-Version (Plain Zypper) und einigen manuellen Interaktionen durchzuführen. Gehen Sie wie folgt vor, um eine Service Pack-Migration zu starten:
  </para>

  <procedure>
   <step>
    <para>
     Aktualisieren Sie die Paketverwaltungstools mit den alten SUSE Linux Enterprise-Repositorys:
    </para>
<screen><prompt>root # </prompt><command>zypper</command> patch--updatestack-only</screen>
   </step>
   <step>
    <para>
     Wenn das System registriert wurde, muss seine Registrierung aufgehoben werden:
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --de-register</screen>
   </step>
   <step>
    <para>
     Entfernen Sie die alten Installationsquellen und Repositorys und passen Sie die Repositorys von Drittanbietern an.
    </para>
   </step>
   <step>
    <para>
     Fügen Sie die neuen Installationsquellen hinzu (lokale Quellen oder Remote-Quellen):
    </para>
<screen><prompt>root # </prompt><command>zypper</command> addrepo <replaceable>REPOSITORY</replaceable></screen>
    <para>
     Sie können auch das SUSE Customer Center oder das Subscription Management Tool verwenden. Das Kommando für SUSE Linux Enterprise 12 SP1 unter x86-64 lautet wie folgt:
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> -p SLES/12.2/x86_64 <replaceable>OPTIONS</replaceable></screen>
   </step>
   <step>
    <para>
     Schließen Sie die Migration ab:
    </para>
<screen><prompt>root # </prompt><command>zypper</command> ref -f -s
<prompt>root # </prompt><command>zypper</command> dup --no-allow-vendor-change --no-recommends</screen>
    <para>
     Das erste Kommando aktualisiert alle Services und Repositorys. Das zweite Kommando führt ein Distributionsupgrade durch. Hier sind die beiden letzten Optionen wichtig: <option>-no-allow-vendor-change</option> stellt sicher, dass RPMs von Drittanbietern keine RPMs aus dem Basissystem überschreiben. Die Option <option>--no-recommends</option> sorgt dafür, dass Pakete, die während der Erstinstallation abgewählt wurden, nicht erneut hinzugefügt werden.
    </para>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec.update.migr.ownscripts.onlinemigr">
  <title>Manuelle Migration</title>
  <remark>toms 2016-07-13: Is this supported?</remark>
  <para>
   Für eine manuelle Migration oder eine Migration mit eigenen Skripten ist eine profunde Kenntnis der Systemkomponenten erforderlich. Daher ist das folgende Verfahren nur für Experten geeignet.
  </para>

  <para>
   Gehen Sie wie folgt vor, um Ihr System manuell zu migrieren:
  </para>

  <procedure>
   <step>
    <para>
     Bereiten Sie Ihr System vor:
    </para>
    <substeps>
     <step>
      <para>
       Heben Sie die Registrierung Ihres aktuellen Systems in SCC auf:
      </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --de-register</screen>
     </step>
     <step>
      <para>
       Deaktivieren Sie alte Installationsquellen, die von einer DVD stammen. Prüfen Sie beispielsweise <filename>/etc/zypp/repos.d/SLES12-12-0.repo</filename>.
      </para>
     </step>
     <step>
      <para>
       Suchen Sie nach Repositorys von Drittanbietern und passen Sie die URL an.
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     Entscheiden Sie, ob Sie Remote-Repositorys über das SUSE Customer Center oder lokale Repositorys hinzufügen möchten:
    </para>
    <variablelist>
     <varlistentry>
      <term>Remote-Installationsquelle über SCC</term>
      <listitem>
       <para>
        Fügen Sie über den Online-Kanal neue Installationsquellen hinzu:
       </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> -p SLES/12.2/x86_64 -r <replaceable>CODE</replaceable> -e <replaceable>EMAIL</replaceable></screen>
       <para>
        Prüfen Sie, ob das System ordnungsgemäß registriert ist:
       </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --status</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Lokale Installationsquelle</term>
      <listitem>
       <para>
        Fügen Sie eine lokale Installationsquelle hinzu:
       </para>
<screen><prompt>root # </prompt><command>zypper</command> ar -f http://example.com/media/SLES12SP1/
<prompt>root # </prompt><command>zypper</command> ar dvd:///?devices=/dev/sr0 SLES12SP1</screen>
      </listitem>
     </varlistentry>
    </variablelist>
   </step>
   <step>
    <para>
     Aktualisieren Sie alle Repositorys:
    </para>
<screen><prompt>root # </prompt><command>zypper</command> --releasever 12.2 ref -f -s</screen>
   </step>
   <step>
    <para>
     Führen Sie das Distributionsupgrade mit <command>zypper dup</command> durch:
    </para>
<screen><prompt>root # </prompt><command>zypper</command> --releasever 12.2 dup --no-allow-vendor-change --recommends</screen>
   </step>
   <step>
    <para>
     Falls noch nicht erfolgt, registrieren Sie das System.
    </para>
   </step>
   <step>
    <para>
     Prüfen Sie, ob das System ordnungsgemäß registriert wurde:
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --status</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.rollback">
  <title>Rollback eines Service Packs</title>

  <para>
   Falls ein Service Pack nicht ordnungsgemäß ausgeführt wurde, unterstützt SUSE Linux Enterprise die Zurücksetzung auf den Zustand vor Beginn der Service Pack-Migration.
  </para>

  <procedure xml:id="pro.update.migr.rollback">
   <step>
    <para>
     Rufen Sie eine Liste sämtlicher Snapper-Snapshots ab:
    </para>
    <screen><prompt>root # </prompt><command>snapper</command> list</screen>
    <para>
     Prüfen Sie die Ausgabe und wählen Sie für den nächsten Schritt eine Nummer aus. Ausführliche Informationen zu Snapper finden Sie im <xref linkend="cha.snapper"/>.
    </para>
   </step>
   <step>
    <para>
     Wählen Sie einen Snapper-Snapshot für das Rollback aus. Geben Sie die Nummer aus dem vorherigen Schritt an:
    </para>
<screen><prompt>root # </prompt><command>snapper</command> rollback <replaceable>NUMBER</replaceable></screen>
   </step>
   <step>
    <para>
     Stellen Sie den Bootloader wieder her (ausführliche Informationen hierzu finden Sie im <xref linkend="cha.grub2"/>):
    </para>
<screen><prompt>root # </prompt><command>grub2</command> boot menu</screen>
    <para>
     Die Registrierung wird während des Bootvorgangs automatisch zurückgesetzt.
    </para>
   </step>
   <step>
    <para>
     Prüfen Sie, ob das System ordnungsgemäß registriert wurde (weitere Informationen finden Sie in <xref linkend="sec.update.registersystem"/>):
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --status</screen>
   </step>
   <step>
    <para>
     Falls erforderlich, reparieren Sie die Registrierung:
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --rollback</screen>
   </step>
  </procedure>
 </sect1>
</chapter>
