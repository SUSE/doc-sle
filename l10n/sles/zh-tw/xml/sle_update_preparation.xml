<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_preparation.xml" version="5.0" xml:id="cha-update-preparation">
 <title>準備升級</title>
 <info>
  <abstract>
   <para>
    在開始升級程序之前，請先確認您的系統已準備妥當。除了其他工作以外，準備工作還包括備份資料和檢查版本說明。下一章將引導您完成這些步驟。
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <remark>jufa 2021-02-09: suggestion to give this chapter a facelift: 
 Chapter 3: Preparing the upgrade - Intro - Procedure w check system version,
 release notes, back-up, listing packages, create proposal</remark>
 
 
 <sect1 xml:id="sec-update-preparation-update">
  <title>確定系統是最新的</title>

  <para os="sles;sled">
   <remark>jufa 2021-02-09: add what to do if the system is older? check what
    is meant with patch level. check if update path is supported,
    link to sec-upgrade-path-supported</remark>
   僅支援從最新的修補層級升級系統。<phrase os="sles;sled"></phrase>執行 <command>zypper patch</command><phrase os="sles;sled"> 或啟動 YaST 模組 <guimenu>Online-Update</guimenu></phrase>，以確定已安裝最新的系統更新。
  </para>

  


 </sect1>
 <sect1 xml:id="sec-update-preparation-relnotes">
  <title>閱讀版本說明</title>

  <para>
   如需所有變更、新功能和已知問題的清單，請參閱<link xlink:href="https://www.suse.com/releasenotes/">版本說明</link>。安裝媒體上的 <filename>docu</filename> 目錄中也提供了版本說明。
  </para>

  <para>
   版本說明通常僅包含兩個連續版本之間的變更。<phrase os="sles;sled">如果您跳過了一或多個 Service Pack，另請檢查所跳過 Service Pack 的版本說明。</phrase>
  </para>

  <para>
   查看版本說明以確定：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     您的硬體是否有特殊注意事項
    </para>
   </listitem>
   <listitem>
    <para>
     目前所使用的任何軟體套件是否發生了重大變更
    </para>
   </listitem>
   <listitem>
    <para>
     您的安裝是否需要特殊預防措施
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec-update-preparation-backup">
  <title>製作</title>

  <para>
   升級前，將現有組態檔案複製到另一個媒體 (例如磁帶裝置、抽取式硬碟等)，以備份資料。此作業主要適用於儲存在 <filename>/etc</filename> 中的檔案，以及 <filename>/var</filename> 和 <filename>/opt</filename> 中的一些目錄和檔案。您最好也將 <filename>/home</filename> (即 <envar>HOME</envar> 目錄) 中的使用者資料複製到備份媒體。
  </para>

  <para>
   以 <systemitem class="username">root</systemitem> 身分備份所有資料。只有 <systemitem class="username">root</systemitem> 對所有本地檔案具有足夠的權限。
  </para>

  <para os="sles;sled">
   <remark>jufa 2021-02-09: check if backup function still exists and how it
    works. rework para accordingly: alternative for data back up</remark>
   如果您在 YaST 中選取了「<guimenu>更新現有系統</guimenu>」做為安裝模式，則可以選擇稍後執行 (系統) 備份。您可以選擇包含所有已修改的檔案以及 <filename>/etc/sysconfig</filename> 目錄中的檔案。不過，這並不是一個完整備份，因為缺少上述的所有其他重要目錄。您可在 <filename>/var/adm/backup</filename> 目錄中找到該備份。
  </para>
 </sect1>
 <sect1 xml:id="sec-update-preparation-packagelist">
  <title>列出已安裝的套件和儲存庫</title>

  <para>
   <remark>jufa 2021-02-08: explain importance and purposeof this list.
    Clarify if requirement or suggestion?
    Used for reverting changes or to set-up new system?</remark>
   例如，在全新安裝某個新的主要 SLE 版本或回復到舊版本時，您可以儲存已安裝套件的清單。
  </para>

  <note>
   <para>
    <remark>jufa: check if manual editing is still relevant 2021-02-09</remark>
    請注意，並非所有已安裝的套件或使用的儲存庫在 SUSE Linux Enterprise 的較新版本中都可用。有些套件或儲存庫可能已被重新命名，有些可能已被取代。還有可能提供的一些套件只是用於舊版，而預設會使用另一個替代它的套件。因此，可能需要手動編輯一些檔案。您可使用任何文字編輯器進行編輯。
   </para>
  </note>

  <procedure>
   <step>
    <para>
     建立包含全部所用儲存庫清單的檔案 <filename>repositories.bak.repo</filename>：
    </para>
<screen><prompt role="root"># </prompt><command>zypper</command> lr -e repositories.bak</screen>
   </step>
   <step>
    <para>
     此外，建立包含全部已安裝套件清單的檔案 <filename>installed-software.bak</filename>：
    </para>
<screen><prompt role="root"># </prompt><command>rpm</command> -qa --queryformat '%{NAME}\n' &gt;
     installed-software.bak</screen>
   </step>
   <step>
    <para>
     備份這兩個檔案。使用以下指令可還原儲存庫和已安裝的套件：
    </para>
<screen os="sles;sled"><prompt role="root"># </prompt><command>zypper</command> ar repositories.bak.repo
<prompt role="root"># </prompt><command>zypper</command> install $(cat installed-software.bak)
</screen>

    <note os="sles;sled" xml:id="note-update-prep-backup-package-amount">
     <title>更新至新的主要版本後，套件數量會相應增加</title>
     <para>
      升級至新主要版本的系統 (SLE <replaceable>X+1</replaceable>) 包含的套件可能比初始系統 (SLE <replaceable>X</replaceable>) 的多，也會比選取相同模式執行的 SLE <replaceable>X+1</replaceable> 全新安裝所包含的套件多。原因如下：
     </para>
     <itemizedlist>
      <listitem>
       <para>
        套件經過分割，以便使用者能更細微地選取套件。例如，SLE 11 上的 37 個 <package>texlive</package> 套件已拆分成 SLE 15 上的 3000 多個套件。
       </para>
      </listitem>
      <listitem>
       <para>
        分割套件後，在升級程序中會安裝所有新套件，以與舊版本保持相同的功能。但是，SLE <replaceable>X+1</replaceable> 全新安裝的新預設設定可能不會安裝所有套件。
       </para>
      </listitem>
      <listitem>
       <para>
        出於相容原因，可能會保留 SLE <replaceable>X</replaceable> 中的舊套件。
       </para>
      </listitem>
      <listitem>
       <para>
        套件相依項和模式範圍可能已發生變化。
       </para>
      </listitem>
     </itemizedlist>
    </note>
    
   </step>
  </procedure>
 </sect1>
 <sect1 os="sles" xml:id="sec-update-preparation-sle11">
  <title>從 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 11 SP4 升級</title>

  <para>
   如果您在 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 11 SP4 上使用的是 MySQL、PostgreSQL 或基於 Java MD5 的證書，請依以下各節中所述準備系統。此外，請務必查看本章的其他各節，以瞭解其他需要執行的準備工作。
  </para>

  <sect2 xml:id="sec-update-preparation-sle11-postgresql">
   <title>移轉 PostgreSQL 資料庫</title>
   
   <para>
    如果您在 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 11 上使用的是 PostgreSQL 資料庫，則需要升級資料庫。如需詳細資訊，請參閱 <xref linkend="sec-update-preparation-postgresql"/>。
   </para>
  </sect2>

  <sect2 xml:id="sec-update-preparation-sle11-mariadb">
   <title>移轉 MySQL 資料庫</title>
   <remark>toms 2015-09-03: already reviewed by Ondrej and Kristýna.</remark>
   <para>
    從 SUSE Linux Enterprise 12 開始，SUSE 使用 MariaDB 而不是 MySQL。在開始任何升級操作之前，強烈建議您備份資料庫。
   </para>
   <para>
    若要執行資料庫移轉，請執行以下步驟：
   </para>
   <procedure>
    <step>
     <para>
      登入到 SUSE Linux Enterprise 11 機器。
     </para>
    </step>
    <step>
     <para>
      建立傾印檔案：
     </para>
<screen><prompt role="root"># </prompt><command>mysqldump</command> -u root -p --all-databases &gt; mysql_backup.sql</screen>
     <para>
      依預設，<command>mysqldump</command> 不會傾印 <literal>INFORMATION_SCHEMA</literal> 或 <literal>performance_schema</literal> 資料庫。如需詳細資訊，請參閱<link xlink:href="https://dev.mysql.com/doc/refman/5.5/en/mysqldump.html"/>。
     </para>
    </step>
    <step>
     <para>
      將您的傾印檔案、組態檔案 <filename>/etc/my.cnf</filename> 以及目錄 <filename>/etc/mysql/</filename> 儲存在安全位置以供日後調查 (<emphasis>不要</emphasis>用於安裝！)。
     </para>
    </step>
    <step>
     <para>
      執行 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 升級。升級後，以前的組態檔案 <filename>/etc/my.cnf</filename> 仍將保持不變。可以在檔案 <filename>/etc/my.cnf.rpmnew</filename> 中找到新組態。
     </para>
    </step>
    <step>
     <para>
      根據需要設定 MariaDB 資料庫。<emphasis>不要</emphasis>使用以前的組態檔案和目錄，只是將其用做提醒，並對其進行改編。
     </para>
    </step>
    <step>
     <para>
      確定啟動 MariaDB 伺服器：
     </para>
<screen><prompt role="root"># </prompt><command>systemctl</command> start mariadb</screen>
     <para>
      如果您希望每次開機時都啟動 MariaDB 伺服器，請啟用以下服務：
     </para>
<screen><prompt role="root"># </prompt><command>systemctl</command> enable mariadb</screen>
    </step>
    <step>
     <para>
      透過連接到資料庫來驗證 MariaDB 是否正常執行：
     </para>
<screen><prompt role="root"># </prompt><command>mariadb</command> -u root -p</screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec-update-preparation-sle11-ssl">
   <title>建立用於 Java 應用程式的非 MD5 伺服器證書</title>
   <remark>toms 2016-07-27: from bsc#970153, c#24</remark>
   <remark>jufa 2021-02-09: FIXME check if still relevant, check which versions are affected</remark>
   <para>
    做為安全措施，Java 中不再支援以 MD5 為基礎的證書。若您之前建立的證書為 MD5 證書，請執行以下步驟來重新建立證書：
   </para>
   <procedure>
    <step>
     <para>
      開啟終端機，並以 <systemitem class="username">root</systemitem> 身分登入。
     </para>
    </step>
    <step>
     <para>
      建立私密金鑰：
     </para>
<screen><prompt role="root"># </prompt><command>openssl</command> genrsa -out server.key 1024</screen>
     <para>
      如需增強式金鑰，請以更大的數字 (例如 <literal>4096</literal>) 取代 <literal>1024</literal>。
     </para>
    </step>
    <step>
     <para>
      建立證書簽署申請 (CSR)：
     </para>
<screen><prompt role="root"># </prompt><command>openssl</command> req -new -key server.key -out server.csr</screen>
    </step>
    <step>
     <para>
      自行簽署證書：
     </para>
<screen><prompt role="root"># </prompt><command>openssl</command> x509 -req -days 365 -in server.csr -signkey server.key -out server.crt</screen>
    </step>
    <step>
     <para>
      建立 PEM 檔案：
     </para>
<screen><prompt role="root"># </prompt><command>cat</command> server.key server.crt &gt; server.pem</screen>
    </step>
    <step>
     <para>
      將 <filename>server.crt</filename>、<filename>server.csr</filename>、<filename>server.key</filename> 與 <filename>server.pem</filename> 檔案置於可在其中找到金鑰的相應目錄中。例如，對於 Tomcat，此目錄為 <filename>/etc/tomcat/ssl/</filename>。
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 os="sles" xml:id="sec-update-preparation-postgresql">
  <title>移轉 PostgreSQL 資料庫</title>

  <para>
   
   <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> <phrase role="productnumber"><phrase os="sles;sled">15 SP4</phrase></phrase> 隨附 PostgreSQL 資料庫版本 10、12 和 13。雖然預設版本是版本 13，但我們仍會透過 <literal>Legacy</literal> 模組提供版本 10 和 12，以便您可以從 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 的早期版本升級。
  </para>

  <para>
   由於需要完成資料庫的移轉工作，因此無法使用自動升級程序。您需要以手動方式執行從一個版本到另一個版本的移轉。
  </para>

  <para>
   透過 <command>pg_upgrade</command> 指令來執行移轉程序，這種方法可替代傳統的傾印和重新載入。與<quote>傾印和重新載入</quote>方法相比，<command>pg_upgrade</command> 可縮短移轉所需的時間。
  </para>

  <para>
   每個 PostgreSQL 版本的程式檔案儲存在不同版本的相關目錄中。例如，版本 9.6 的程式檔案儲存在 <filename>/usr/lib/postgresql96/</filename> 中；版本 10 的儲存在 <filename>/usr/lib/postgresql10/</filename> 中；版本 13 的儲存在 <filename>/usr/lib/postgres13/</filename> 中。請注意，PostgreSQL 主要版本 9.6 與 10 的版本控制規則有所不同。如需詳細資料，請參閱<link xlink:href="https://www.postgresql.org/support/versioning/"/>。
  </para>

  <important>
   <title>從 SLE 11 升級</title>
   <para>
    從 SLE 11 升級時，將會解除安裝 <systemitem>postgresql94</systemitem>，不可用於將資料庫移轉至更高的 PostgreSQL 版本。因此，在這種情況下，請務必先移轉 PostgreSQL 資料庫，<emphasis>然後</emphasis>再升級系統。
   </para>
  </important>

  <para>
   以下程序描述如何將資料庫從版本 12 移轉至版本 13。使用不同的版本做為起始或目標時，請相應地取代版本編號。
  </para>

  <para>
   若要執行資料庫移轉，請執行以下步驟：
  </para>

  <procedure>
   <step>
    <para>
     確定滿足以下前提條件：
    </para>
    <itemizedlist>
     <listitem>
      <para>
       如果尚未這麼做，請透過維護更新將舊 PostgreSQL 版本的任何套件升級至最新版本。
      </para>
     </listitem>
     <listitem>
      <para>
       建立現有資料庫的備份。
      </para>
     </listitem>
     <listitem>
      <para>
       安裝新 PostgreSQL 主要版本的套件。對於 SLE 15 SP4，這表示需要安裝 <package>postgresql13-server</package> 及其相依的所有套件。
      </para>
     </listitem>
     <listitem>
      <para>
       安裝包含 <command>pg_upgrade</command> 指令的 <package>postgresql13-contrib</package> 套件。
      </para>
     </listitem>
     <listitem>
      <para>
       確定 PostgreSQL 資料區域 (預設為 <filename>/var/lib/pgsql/data</filename>) 中有足夠的可用空間。如果可用空間非常有限，請對每個資料庫使用以下 SQL 指令，以嘗試減少大小 (這可能需要花費很長時間！)：
      </para>
<screen>VACUUM FULL</screen>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     使用下列任一指令停止 PostgreSQL 伺服器：
    </para>
<screen><prompt role="root"># </prompt><command>/usr/sbin/rcpostgresql</command> stop</screen>
    <para>
     或
    </para>
<screen><prompt role="root"># </prompt>systemctl stop postgresql.service</screen>
    <para>
     (取決於要用做升級起始版本的 SLE 版本)。
    </para>
   </step>
   <step>
    <para>
     重新命名舊資料目錄：
    </para>
<screen><prompt role="root"># </prompt><command>mv</command> /var/lib/pgsql/data /var/lib/pgsql/data.old</screen>
   </step>
   <step>
    <para>
     使用 <command>initdb</command> 手動啟始化新的資料庫例項，或者啟動再停止 PostgreSQL，如此即可自動完成啟始化：
    </para>
<screen><prompt role="root"># </prompt><command>/usr/sbin/rcpostgresql</command> start
<prompt role="root"># </prompt><command>/usr/sbin/rcpostgresql</command> stop</screen>
    <para>
     或
    </para>
<screen><prompt role="root"># </prompt>systemctl start postgresql.service
<prompt role="root"># </prompt>systemctl stop postgresql.service</screen>
    <para>
     (取決於要用做升級起始版本的 SLE 版本)。
    </para>
   </step>
   <step>
    <para>
     如果您在舊版本中變更了組態檔案，請考慮將這些變更移至新的組態檔案。可能受影響的檔案包括 <filename>postgresql.auto.conf</filename>、<filename>postgresql.conf</filename>、<filename>pg_hba.conf</filename> 和 <filename>pg_ident.conf</filename>。這些檔案的舊版本位於 <filename>/var/lib/pgsql/data.old/</filename> 中，新版本可在 <filename>/var/lib/pgsql/data</filename> 中找到。
    </para>
    <para>
     請注意，不建議複製舊組態檔案，因為這可能會覆寫新選項、新預設值和變更的備註。
    </para>
   </step>
   <step>
    <para>
     以 <systemitem class="username">postgres</systemitem> 使用者身分啟動移轉程序：
    </para>
<screen><prompt role="root"># </prompt>su - postgres
postgres &gt; <command>pg_upgrade</command> \
 --old-datadir "/var/lib/pgsql/data.old" \
 --new-datadir "/var/lib/pgsql/data" \
 --old-bindir "/usr/lib/postgresql12/bin/" \
 --new-bindir "/usr/lib/postgresql13/bin/"</screen>
   </step>
   <step>
    <para>
     使用下列任一指令啟動新資料庫例項：
    </para>
<screen><prompt role="root"># </prompt><command>/usr/sbin/rcpostgresql</command> start</screen>
    <para>
     或
    </para>
<screen><prompt role="root"># </prompt>systemctl start postgresql.service</screen>
    <para>
     (取決於要用做升級起始版本的 SLE 版本)。
    </para>
   </step>
   <step>
    <para>
     檢查移轉是否成功。測試範圍取決於使用案例，沒有任何普通的工具可以自動完成此步驟。
    </para>
   </step>
   <step>
    <para>
     移除所有舊 PostgreSQL 套件和舊資料目錄：
    </para>
<screen><prompt role="root"># </prompt><command>zypper</command> search -s postgresql12| xargs zypper rm -u
<prompt role="root"># </prompt><command>rm</command> -rf /var/lib/pgsql/data.old</screen>
   </step>
  </procedure>

  <para>
   如需升級資料庫或使用邏輯複製等替代方法的詳細資訊，請參閱 <link xlink:href="https://www.postgresql.org/docs/13/upgrading.html"/> 上的官方 PostgreSQL 文件。
  </para>
 </sect1>
 <sect1 xml:id="sec-update-preparation-vms">
  <title>關閉虛擬機器客體</title>

  <para>
   如果您的機器用做 KVM <phrase os="sles;sled">或 Xen</phrase> 的虛擬機器主機伺服器，請務必在更新前正常關閉所有執行中的虛擬機器客體。否則，您可能會在更新之後無法存取這些客體作業系統。
  </para>
 </sect1>
 <sect1 os="sles;sled" xml:id="sec-update-preparation-rmt">
  <title>調整 SMT 用戶端設定</title>

  <para>
   如果您要升級的機器已註冊為 SMT 伺服器的用戶端，請注意以下事項：
  </para>

  <para>
   檢查主機上的 <command>clientSetup4SMT.sh</command> 程序檔版本是否最新。較舊版 SMT 的 <command>clientSetup4SMT.sh</command> 無法管理 SMT 12 用戶端。如果您在 SMT 伺服器上定期套用軟體修補程式，那麼位於 <filename>&lt;SMT 主機名稱&gt;/repo/tools/clientSetup4SMT.sh</filename> 處的 <command>clientSetup4SMT.sh</command> 永遠都是最新版本。
  </para>

  <para>
   如果將機器升級至更新版本的 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 失敗，請依<xref linkend="pro-sec-update-prep-smt-de-register" xrefstyle="select:label"/>中所述，從 SMT 伺服器中取消註冊該機器。然後重新啟動升級程序。
  </para>

  <procedure xml:id="pro-sec-update-prep-smt-de-register">
   <title>從 SMT 伺服器中取消註冊 SUSE Linux Enterprise 用戶端</title>
   <step>
    <para>
     登入用戶端機器。
    </para>
   </step>
   <step>
    <para>
     以下步驟視用戶端的目前作業系統而定：
    </para>
    <itemizedlist>
     <listitem>
      <para>
       對於 SUSE Linux Enterprise 11，請執行以下指令：
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> suse_register -E
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/SUSEConnect
<prompt>&gt; </prompt><command>sudo</command> rm -rf /etc/zypp/credentials.d/*
<prompt>&gt; </prompt><command>sudo</command> rm -rf /etc/zypp/repos.d/*
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/zypp/services.d/*
<prompt>&gt; </prompt><command>sudo</command> rm -f /var/cache/SuseRegister/*
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/suseRegister*
<prompt>&gt; </prompt><command>sudo</command> rm -f /var/cache/SuseRegister/lastzmdconfig.cache
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/zmd/deviceid
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/zmd/secret</screen>
     </listitem>
     <listitem>
      <para>
       對於 SUSE Linux Enterprise 12，請執行以下指令：
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> SUSEConnect --de-register
<prompt>&gt; </prompt><command>sudo</command> SUSEConnect --cleanup
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/SUSEConnect
<prompt>&gt; </prompt><command>sudo</command> rm -rf /etc/zypp/credentials.d/*
<prompt>&gt; </prompt><command>sudo</command> rm -rf /etc/zypp/repos.d/*
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/zypp/services.d/*</screen>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     登入 SMT 伺服器。
    </para>
   </step>
   <step>
    <para>
     列出所有用戶端註冊，以檢查是否已成功取消註冊該用戶端：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> smt-list-registrations</screen>
   </step>
   <step>
    <para>
     如果該用戶端的主機名稱仍列在此指令的輸出中，請從第一欄取得該用戶端的<literal>唯一 ID</literal>。(可能列出了該用戶端的多個 ID。)
    </para>
   </step>
   <step>
    <para>
     刪除此用戶端的註冊：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> smt-delete-registration -g <replaceable>UNIQUE_ID</replaceable></screen>
   </step>
   <step>
    <para>
     如果列出了該用戶端的多個 ID，請針對每個唯一 ID 重複上述步驟。
    </para>
   </step>
   <step>
    <para>
     重新執行以下指令，以檢查現在是否已成功取消註冊該用戶端：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> smt-list-registrations</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-update-preparation-disk">
  <title>磁碟空間</title>

  <para>
   軟體通常會隨著版本更新而擴增。因此在更新之前，請先檢視可用的分割區空間。如果您懷疑磁碟空間不足，請先備份資料，再透過調整分割區大小等方法來增大可用空間。每個分割區應該佔用多大空間並沒有常規可循。空間需求將依特定的磁碟分割設定檔和選取軟體而有差異。
  </para>

  <note os="sles;sled">
   <title>在 YaST 中自動檢查是否有足夠空間</title>
   <para>
    在更新過程中，YaST 會檢查可用磁碟空間的容量，並在安裝大小可能超出可用空間時向使用者顯示警告。在此情況下，執行更新可能會導致<emphasis>系統無法使用</emphasis>！除非您有執行的把握 (透過事先測試取得)，您才可以跳過該警告並繼續進行更新。
   </para>
  </note>

  <sect2 os="sles;sled" xml:id="sec-update-preparation-disk-space">
   <title>檢查非 Btrfs 檔案系統上的磁碟空間</title>
   <para>
    請使用 <command>df</command> 指令列出可用的磁碟空間。例如，在 <xref linkend="ex-update-df"/> 中，根分割區為 <filename>/dev/sda3</filename> (掛接位置是 <filename>/</filename>)。
   </para>
   <example xml:id="ex-update-df">
    <title>使用 <command>df -h</command> 來列示</title>

<screen os="sles">Filesystem     Size  Used Avail Use% Mounted on
/dev/sda3       74G   22G   53G  29% /
tmpfs          506M     0  506M   0% /dev/shm
/dev/sda5      116G  5.8G  111G   5% /home
/dev/sda1       44G    4G   40G   9% /data</screen>
   </example>
  </sect2>

  <sect2 xml:id="sec-update-preparation-disk-btrfs-on-root">
   <title>檢查 Btrfs 根檔案系統上的磁碟空間</title>
   
   <para>
    在 Btrfs 檔案系統上，<command>df</command> 的輸出可能有誤導性，因為除了原始資料配置的空間以外，Btrfs 檔案系統也會配置並使用中繼資料的空間。
   </para>
   <para>
    因此，即使看上去仍有大量的可用空間，Btrfs 檔案系統也可能會報告空間不足。在這種情況下，為中繼資料配置的所有空間均會用盡。<phrase os="sles">如需如何檢查 Btrfs 檔案系統上已用和可用空間的詳細資料，請參閱<xref linkend="sec-filesystems-major-btrfs-suse-space"/>。</phrase>如需詳細資訊，請參閱 <phrase os="sles;sled"><command>man 8 btrfs-filesystem</command> 和 </phrase><link xlink:href="https://btrfs.wiki.kernel.org/index.php/FAQ"/>。
   </para>
   
   <para os="sles;sled">
    如果在機器上使用 Btrfs 做為根檔案系統，請確定有足夠的可用空間。檢查所有已掛接分割區上的可用空間。在最壞的情況下，升級程序需要將目前根檔案系統的所有磁碟空間 (不含 <filename>/.snapshot</filename>) 用於存放新快照。
   </para>
   
   <para>
    下列建議已證實值得採納：
   </para>
   <itemizedlist>
    <listitem>
     <para>
      包括 Btrfs 在內的所有檔案系統都需要有足夠的可用磁碟空間來下載和安裝大型 RPM。只有在安裝新 RPM 之後，舊 RPM 的空間才會釋放。
     </para>
    </listitem>
    <listitem>
     <para>
      對於包含快照的 Btrfs，至少需要有目前安裝所需的可用空間。建議提供兩倍於目前安裝大小的可用空間。
     </para>
     <para>
      如果沒有足夠的可用空間，您可以嘗試使用 <command>snapper</command> 刪除舊快照：
     </para>
<screen><prompt role="root"># </prompt><command>snapper</command> list
<prompt role="root"># </prompt><command>snapper</command> delete NUMBER</screen>
     <para>
      但是，這種做法並不總是有用。在移轉之前，大部份快照只會佔用極少的空間。
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-autoyast-profiles" os="sles">
  <title>AutoYaST 設定檔中的變更 (從 SLE 12 到 15)</title>

  <para>
   若要瞭解如何移轉 AutoYaST 設定檔，請參閱<xref linkend="appendix-ay-12vs15"/>。
  </para>
 </sect1>
 <sect1 xml:id="sec-update-preparation-smt-to-rmt" os="sles">
  <title>升級訂閱管理工具 (SMT) 伺服器</title>

  <para>
   對於執行 SMT 的伺服器，需要執行特殊的升級程序。請參閱《<citetitle>Repository mirror Tool Guide</citetitle>》中的<xref linkend="cha-rmt-migrate"/>。
  </para>
 </sect1>
 <sect1 os="sles" xml:id="sec-update-preparation-multiversion">
  <title>暫時停用核心多版本支援</title>

  <para>
   <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 允許您在 <filename>/etc/zypp/zypp.conf</filename> 中啟用相應設定來安裝多個核心版本。為了升級到某個 Service Pack，需要暫時停用對此功能的支援。當更新成功完成後，可重新啟用多版本支援。若要停用多版本支援，請在 <filename>/etc/zypp/zypp.conf</filename> 中為各行加上備註。結果應類似如下內容：
  </para>

<screen>#multiversion = provides:multiversion(kernel)
#multiversion.kernels = latest,running</screen>

  <para>
   若要在成功更新後重新啟用此功能，請移除備註符號。如需更多有關多版本支援的詳細資訊，請參閱<xref linkend="sec-tuning-multikernel-enable"/>。
  </para>
 </sect1>
 <sect1 xml:id="sec-update-preparation-zseries" os="sles">
  <title>在 IBM Z 上升級</title>

  <para>
   在 IBM Z 上升級 SUSE Linux Enterprise 安裝需要設定 <command>Upgrade=1</command> 核心參數 (例如，透過 parmfile 設定)。請參閱<xref linkend="sec-appdendix-parm" xrefstyle="HeadingOnPage"/>。
  </para>
 </sect1>
 <sect1 xml:id="sec-update-preparation-ppc" os="sles" arch="power">
  <title>IBM POWER：啟動 X 伺服器</title>

  <para>
   在 SLES 12 for IBM POWER 上，顯示管理員設定為預設不啟動本地 X 伺服器。SLES 12 SP1 上的設定則相反，顯示管理員現在會啟動 X 伺服器。
  </para>

  <para>
   為了避免升級期間出現問題，<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 設定不會自動變更。如果想要在升級後讓顯示管理員啟動 X 伺服器，請依如下所示在 <filename>/etc/sysconfig/displaymanager</filename> 中變更 <envar>DISPLAYMANAGER_STARTS_XSERVER</envar> 的設定：
  </para>

<screen>DISPLAYMANAGER_STARTS_XSERVER="yes"</screen>
 </sect1>
</chapter>
