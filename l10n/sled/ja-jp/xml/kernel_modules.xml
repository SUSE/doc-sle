<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="kernel_modules.xml" version="5.0" xml:id="cha-mod">
 <title>カーネルモジュールの管理</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <para>
   Linuxはモノリシックカーネルですが、カーネルモジュールを使用して拡張することができます。カーネルモジュールは、オンデマンドでカーネルに挿入したり、カーネルから削除したりできる特別なオブジェクトです。実際面では、カーネルモジュール自体に含まれないドライバやインタフェースを追加および削除できます。Linuxは、カーネルモジュールを管理するためのコマンドをいくつか備えています。
 </para>
 <sect1 xml:id="sec-mod-lsmod">
  <title>lsmodおよびmodinfoによるロード済みモジュールの一覧作成</title>
  <para>
    <command>lsmod</command>コマンドを使用すると、現在ロードされているカーネルモジュールを表示できます。コマンドの出力は次のようになります。
  </para>
  <screen><prompt>&gt; </prompt>lsmod
Module                  Size  Used by
snd_usb_audio         188416  2
snd_usbmidi_lib        36864  1 snd_usb_audio
hid_plantronics        16384  0
snd_rawmidi            36864  1 snd_usbmidi_lib
snd_seq_device         16384  1 snd_rawmidi
fuse                  106496  3
nfsv3                  45056  1
nfs_acl                16384  1 nfsv3</screen>
  <para>
    出力は3つの列に分かれています。<literal>Module</literal>列には、ロード済みモジュールの名前が一覧にされ、<literal>Size</literal>列には各モジュールのサイズが表示されます。<literal>Used by</literal>列には、参照モジュールの数と名前が表示されます。このリストは完全ではない場合があるので注意してください。
  </para>
  <para>
    特定のカーネルモジュールに関する詳細情報を表示するには、<command>modinfo <replaceable>MODULE_NAME</replaceable></command>コマンドを使用します。<replaceable>MODULE_NAME</replaceable>には、目的のカーネルモジュールの名前を指定します。<command>modinfo</command>バイナリは、ユーザのPATH環境変数に存在しない<filename>/sbin</filename>ディレクトリにあるので注意してください。つまり、<command>modinfo</command>コマンドを標準ユーザとして実行する場合、バイナリのフルパスを指定する必要があります。
  </para>
  <screen><prompt>&gt; </prompt>/sbin/modinfo kvm
filename:       /lib/modules/5.3.18-57-default/kernel/arch/x86/kvm/kvm.ko.xz
license:        GPL
author:         Qumranet
suserelease:    SLE15-SP3
srcversion:     3D8FBA9060D4537359A06FC
depends:        irqbypass
supported:      yes
retpoline:      Y
intree:         Y
name:           kvm
vermagic:       5.3.18-57-default SMP mod_unload modversions 
      </screen>
  </sect1>
  <sect1 xml:id="sec-mod-modprobe">
    <title>カーネルモジュールの追加と削除</title>
    <para>
      <systemitem>insmod</systemitem>と<systemitem>rmmod</systemitem>を使用してカーネルモジュールを追加および削除できますが、これらの代わりに<systemitem>modprobe</systemitem>ツールを使用することをお勧めします。<systemitem>modprobe</systemitem>には、依存関係の自動解決やブラックリスト化など、重要な利点がいくつかあります。
    </para>
    <para>
      パラメータを指定せずに使用すると、<systemitem>modprobe</systemitem>コマンドは、指定したカーネルモジュールをインストールします。<systemitem>modprobe</systemitem>はルート特権で実行する必要があります。
    </para>
    <screen><prompt>&gt; </prompt><command>sudo</command> modprobe acpi</screen>
    <para>
      カーネルモジュールを削除するには、<command>-r</command>パラメータを使用します。
    </para>
    <screen><prompt>&gt; </prompt><command>sudo</command> modprobe -r acpi</screen>
    <sect2 xml:id="sec-mod-modprobe-d">
    <title>ブート時のカーネルモジュールの自動ロード</title>
    <para>
      カーネルモジュールを手動でロードする代わりに、<systemitem>system-modules-load.service</systemitem>サービスを使用してブートプロセス中に自動的にロードできます。カーネルモジュールを有効にするには、<filename>.conf</filename>ファイルを<filename>/etc/modules-load.d/</filename>ディレクトリに追加します。次の例のように、設定ファイルにモジュールと同じ名前を付けることをお勧めします。</para>
    <screen>/etc/modules-load.d/rt2800usb.conf</screen>
    <para>
      設定ファイルには目的のカーネルモジュールの名前を記述する必要があります(例: <literal>rt2800usb</literal>)。
    </para>
    <para>
      ここで説明する方法を使用すると、パラメータなしでカーネルモジュールをロードできます。特定のオプションを指定してカーネルモジュールをロードする必要がある場合は、代わりに<filename>/etc/modprobe.d/</filename>ディレクトリに設定ファイルを追加します。ファイルには拡張子<filename>.conf</filename>を付ける必要があります。ファイルの名前は、<literal>priority-modulename.conf</literal>という命名規則に従う必要があります。たとえば、<filename>50-thinkfan.conf</filename>のようにします。設定ファイルには、カーネルモジュールの名前と目的のパラメータを記述する必要があります。次のコマンド例を使用すると、カーネルモジュールの名前とそのパラメータが記述された設定ファイルを作成できます。</para>
      <screen><prompt>&gt; </prompt>echo "options thinkpad_acpi fan_control=1" | sudo tee /etc/modprobe.d/thinkfan.conf</screen>

      <note>
        <title>カーネルモジュールのロード</title>
        <para>
          ほとんどのカーネルモジュールは、デバイスが検出されたときか、ユーザ空間によって特定の機能が要求されたときに、システムによって自動的にロードされます。したがって、ほとんどの場合、モジュールを手動で<filename>/etc/modules-load.d/</filename>に追加する必要はありません。
         </para>
        </note>

    </sect2>
    <sect2 xml:id="sec-mod-modprobe-blacklist">
    <title>modprobeによるカーネルモジュールのブラックリスト化</title>
    <para>
      カーネルモジュールをブラックリスト化すると、そのカーネルモジュールはブートプロセス中にロードされなくなります。これは、システムで問題を引き起こす疑いがあるモジュールを無効にする場合に便利です。なお、カーネルモジュールをブラックリスト化しても、<systemitem>insmod</systemitem>ツールまたは<systemitem>modprobe</systemitem>ツールを使用してそのカーネルモジュールを手動でロードできます。
    </para>
    <para>
      モジュールをブラックリストに登録するには、次の内容を含むファイル<filename>/etc/modprobe.d/60-blacklist-<replaceable>MODULE_NAME</replaceable>.conf</filename>を作成します。
    </para>
    <screen>blacklist <replaceable>MODULE_NAME</replaceable></screen>
    <para>
      rootとして<command>dracut</command>コマンドを実行して新しい<systemitem>initrd</systemitem>イメージを生成し、マシンを再起動します(<replaceable>NAME</replaceable>を現在のinitrdの名前に置き換え、<replaceable>KERNELVERSION</replaceable>を現在実行中のカーネルに置き換えます)。
    </para>
    <screen><prompt>&gt; </prompt>su
echo "blacklist nouveau" &gt;&gt; /etc/modprobe.d/60-blacklist-nouveau.conf
/usr/bin/dracut --logfile /var/log/YaST2/mkinitrd.log --force /boot/$initrd-<replaceable>NAME</replaceable> $<replaceable>KERNELVERSION</replaceable>
reboot</screen>
    <para>
      カーネルモジュールを一時的にのみ無効にするには、ブート時にオンザフライでブラックリスト化します。そのためには、ブート画面が表示されたら<keycap>E</keycap>キーを押します。最小限のエディタが表示され、そこでブートパラメータを変更できます。次のような行を見つけます。
    </para>
    <screen>linux /boot/vmlinuz...splash= silent quiet showopts</screen>
    <para>
      行の最後に<command>modprobe.blacklist=<replaceable>MODULE_NAME</replaceable></command>コマンドを追加します。例:
    </para>
    <screen>linux /boot/vmlinuz...splash= silent quiet showopts modprobe.blacklist=nouveau</screen>
    <para>
      <keycap>F10</keycap>キーまたは<keycombo><keycap function="control"/><keycap>X</keycap></keycombo>キーを押し、指定した設定でブートします。
    </para>
    <para>
      GRUBを使用してカーネルモジュールを完全にブラックリスト化するには、<filename>/etc/default/grub</filename>ファイルを編集用に開き、<command>GRUB_CMD_LINUX</command>コマンドに<command>modprobe.blacklist=<replaceable>MODULE_NAME</replaceable></command>オプションを追加します。次に<command>sudo grub2-mkconfig -o /boot/grub2/grub.cfg</command>コマンドを実行して、変更を有効にします。
    </para>
    </sect2>
 </sect1>
</chapter>
