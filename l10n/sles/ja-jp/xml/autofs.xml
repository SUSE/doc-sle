<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="autofs.xml" version="5.0" xml:id="cha-autofs">
 <title>autofsによるオンデマンドマウント</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    <systemitem>autofs</systemitem>は、指定したディレクトリをオンデマンドベースで自動的にマウントするプログラムです。これは高い効率を実現するためにカーネルモジュールに基づいており、ローカルディレクトリとネットワーク共有の両方を管理できます。これらの自動的なマウントポイントは、アクセスがあった場合にのみマウントされ、非アクティブな状態が一定時間続くとアンマウントされます。このオンデマンドの動作によって帯域幅が節約され、<filename>/etc/fstab</filename>で管理する静的マウントよりも高いパフォーマンスが得られます。<systemitem>autofs</systemitem>は制御スクリプトですが、<command>automount</command>は実際の自動マウントを実行するコマンド(デーモン)です。
   </para>
  </abstract>
 </info>
 <sect1 xml:id="sec-autofs-installation">
  <title>インストール</title>

  <para>
   デフォルトでは、<systemitem>autofs</systemitem>は<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>にインストールされません。その自動マウント機能を利用するには、最初に、次のコマンドを使用してインストールします。
  </para>

<screen><prompt>&gt; </prompt><command>sudo</command> zypper install autofs</screen>
 </sect1>
 <sect1 xml:id="sec-autofs-configuration">
  <title>設定</title>

  <para>
   <command>vim</command>などのテキストエディタで設定ファイルを編集して、<systemitem>autofs</systemitem>を手動で設定する必要があります。<systemitem>autofs</systemitem>の基本的な設定手順は2つあります。<emphasis></emphasis>「マスタ」マップファイルを使用する手順と、特定のマップファイルを使用する手順です。
  </para>

  <sect2 xml:id="sec-autofs-configuration-master-map">
   <title>マスタマップファイル</title>
   <para>
    <systemitem>autofs</systemitem>のデフォルトのマスタ設定ファイルは<filename>/etc/auto.master</filename>です。その場所を変更するには、<filename>/etc/sysconfig/autofs</filename>内の<option>DEFAULT_MASTER_MAP_NAME</option>オプションの値を変更します。次に、<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>のデフォルトのマスタ設定ファイルの内容を示します。
   </para>
<screen>#
# Sample auto.master file
# This is an automounter map and it has the following format
# key [ -mount-options-separated-by-comma ] location
# For details of the format look at autofs(5).<co xml:id="co-autofs-manpage"/>
#
#/misc  /etc/auto.misc<co xml:id="co-autofs-map"/>
#/net -hosts
#
# Include /etc/auto.master.d/*.autofs<co xml:id="co-autofs-include"/>
#
#+dir:/etc/auto.master.d
#
# Include central master map if it can be found using
# nsswitch sources.
#
# Note that if there are entries for /net or /misc (as
# above) in the included master map any keys that are the
# same will not be seen as the first read key seen takes
# precedence.
#
+auto.master<co xml:id="co-autofs-plus"/></screen>
   <calloutlist>
    <callout arearefs="co-autofs-manpage">
     <para>
      自動マウント機能のマップの形式については、<systemitem>autofs</systemitem>のマニュアルページ(<command>man 5
      autofs</command>)で多くの貴重な情報が提供されています。
     </para>
    </callout>
    <callout arearefs="co-autofs-map">
     <para>
      デフォルトではコメント化(#)されていますが、これは単純な自動マウント機能のマッピング構文の例です。
     </para>
    </callout>
    <callout arearefs="co-autofs-include">
     <para>
      マスタマップファイルを複数のファイルに分割する必要がある場合、この行のコメント化を解除し、マッピング(サフィックスは<literal>.autofs</literal>)を<filename>/etc/auto.master.d/</filename>ディレクトリに配置します。
     </para>
    </callout>
    <callout arearefs="co-autofs-plus">
     <para>
      <literal>+auto.master</literal>により、NIS <phrase os="sles;osuse">(NISの詳細については、<xref linkend="sec-nis-server"/>を参照)</phrase>を使用していてもそのマスタマップが確実に見つかるようになります。
     </para>
    </callout>
   </calloutlist>
   <para>
    <filename>auto.master</filename>のエントリには3つのフィールドがあり、構文は次のとおりです。
   </para>
<screen>mount point      map name      options</screen>
   <variablelist>
    <varlistentry>
     <term>mount point</term>
     <listitem>
      <para>
       <systemitem>autofs</systemitem>ファイルシステムをマウントする基本の場所(<literal>/home</literal>など)。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>map name</term>
     <listitem>
      <para>
       マウントに使用するマップソースの名前。マップファイルの構文については、<xref linkend="sec-autofs-mapfiles"/>を参照してください。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>options</term>
     <listitem>
      <para>
       これらのオプションを指定した場合、指定したマップ内のすべてのエントリにデフォルトとして適用されます。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <tip>
    <title>詳細情報</title>
    <para>
     オプションの<literal>map-type</literal>、<literal>format</literal>、および<literal>options</literal>の特定の値の詳細については、<guimenu>auto.master</guimenu>のマニュアルページ(<command>man 5 auto.master</command>)を参照してください。
    </para>
   </tip>
   <para>
    <filename>auto.master</filename>の次のエントリは、<systemitem>autofs</systemitem>に対し、<filename>/etc/auto.smb</filename>内を検索して<filename>/smb</filename>ディレクトリにマウントポイントを作成するよう指示します。
   </para>
<screen>/smb   /etc/auto.smb</screen>
   <sect3 xml:id="sec-autofs-directmount">
    <title>直接マウント</title>
    <para>
     直接マウントは、関連するマップファイル内で指定されたパスにマウントポイントを作成します。<filename>auto.master</filename>でマウントポイントを指定するのではなく、マウントポイントフィールドを<literal>/-</literal>に置き換えます。たとえば、次の行は、<systemitem>autofs</systemitem>に対し、<filename>auto.smb</filename>で指定された場所にマウントポイントを作成するよう指示します。
    </para>
<screen>/-        /etc/auto.smb</screen>
    <tip>
     <title>フルパスを使用しないマップ</title>
     <para>
      ローカルまたはネットワークのフルパスでマップファイルを指定していない場合、マップファイルはネームサービススイッチ(NSS)設定を使用して検索されます。
     </para>
<screen>/-        auto.smb</screen>
    </tip>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-autofs-mapfiles">
   <title>マップファイル</title>
   <important>
    <title>他のタイプのマップ</title>
    <para>
     <systemitem>autofs</systemitem>による自動マウントのマップタイプとしては<emphasis></emphasis>「ファイル」が最も一般的ですが、他のタイプもあります。マップは、コマンドの出力や、LDAPまたはデータベースのクエリ結果で指定することもできます。マップタイプの詳細については、<command>man 5 auto.master</command>マニュアルページを参照してください。
    </para>
   </important>
   <para>
    マップファイルは、ソースの場所(ローカルまたはネットワーク)と、ソースをローカルにマウントするためのマウントポイントを指定します。マップの全般的な形式はマスタマップと同様です。異なるのは、<emphasis>options</emphasis>をエントリの最後ではなくmount pointとlocationの間に記述する点です。
   </para>
<screen>mount point      options      location</screen>
   <para>
    マップファイルが実行可能ファイルとしてマークされていないことを確認してください。<command>chmod -x <replaceable>MAP_FILE</replaceable></command>を実行することにより、実行可能ビットを削除することができます。
   </para>
   <variablelist>
    <varlistentry>
     <term>mount point</term>
     <listitem>
      <para>
       ソースの場所をどこにマウントするかを指定します。ここには、<emphasis>で指定されたベースマウントポイントに追加する1つのディレクトリ名(</emphasis><filename>auto.master</filename>「間接」マウント)、またはマウントポイントのフルパス(直接マウント、<xref linkend="sec-autofs-directmount"/>を参照)のいずれかを指定できます。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>options</term>
     <listitem>
      <para>
       関連するエントリのマウントオプションを、カンマで区切ったオプションのリストで指定します。このマップファイルのオプションも<filename>auto.master</filename>に含まれている場合、これらが追加されます。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>location</term>
     <listitem>
      <para>
       ファイルシステムのマウント元の場所を指定します。通常は、標準の表記方法<literal>host_name:path_name</literal>によるNFSまたはSMBボリュームです。マウントするファイルシステムが「/」で始まる場合(ローカルの<filename>/dev</filename>エントリやsmbfs共有など)、<literal>:/dev/sda1</literal>のように、コロン記号「:」のプレフィクスを付ける必要があります。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-autofs-debugging">
  <title>操作とデバッグ</title>

  <para>
   このセクションでは、<systemitem>autofs</systemitem>サービスの操作を制御する方法と、自動マウント機能の操作を調整する際に詳細なデバッグ情報を表示する方法の概要について説明します。
  </para>

  <sect2 xml:id="sec-autofs-debugging-service">
   <title><systemitem>autofs</systemitem>サービスの制御</title>
   <para>
    <systemitem>autofs</systemitem>サービスの動作は、<systemitem class="daemon">systemd</systemitem>によって制御されます。<systemitem>autofs</systemitem>用の<command>systemctl</command>コマンドの一般的な構文は、次のとおりです。
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl <replaceable>SUB_COMMAND</replaceable> autofs</screen>
   <para>
    ここで<replaceable>SUB_COMMAND</replaceable>は以下のいずれかです。
   </para>
   <variablelist>
    <varlistentry>
     <term>enable</term>
     <listitem>
      <para>
       ブート時に自動マウント機能のデーモンを起動します。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>start</term>
     <listitem>
      <para>
       自動マウント機能のデーモンを起動します。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>stop</term>
     <listitem>
      <para>
       自動マウント機能のデーモンを停止します。自動マウントポイントにはアクセスできません。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>status</term>
     <listitem>
      <para>
       <systemitem>autofs</systemitem>サービスの現在のステータスと、関連するログファイルの一部を出力します。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>restart</term>
     <listitem>
      <para>
       自動マウント機能を停止して起動します。実行中のデーモンをすべて終了し、新しいデーモンを起動します。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>reload</term>
     <listitem>
      <para>
       現在の<filename>auto.master</filename>マップを確認して、エントリに変更があるデーモンを再起動し、新しいエントリがある場合は新しいデーモンを起動します。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec-autofs-debugging-problems">
   <title>自動マウント機能の問題のデバッグ</title>
   <para>
    <systemitem>autofs</systemitem>でディレクトリをマウントする際に問題が発生する場合は、<command>automount</command>デーモンを手動で実行して出力メッセージを確認してください。
   </para>
   <procedure>
    <step>
     <para>
      <systemitem>autofs</systemitem>を停止します。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl stop autofs</screen>
    </step>
    <step>
     <para>
      1つの端末から、フォアグラウンドで<command>automount</command>を手動で実行し、詳細な出力を生成します。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> automount -f -v</screen>
    </step>
    <step>
     <para>
      別の端末から、マウントポイントにアクセスして(たとえば、<command>cd</command>または<command>ls</command>を使用して)、自動マウントファイルシステムをマウントしてみます。
     </para>
    </step>
    <step>
     <para>
      1番目の端末から、<command>automount</command>の出力で、マウントに失敗した理由またはマウントが試行されていない理由についての詳細情報がないかどうかを確認します。
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-autofs-nfs">
  <title>NFS共有の自動マウント</title>

  <para>
   次の手順は、ネットワーク上で利用可能なNFS共有を自動マウントするよう<systemitem>autofs</systemitem>を設定する方法を示しています。この方法は上で説明した情報を利用しています。また、NFSのエクスポートを熟知していることが前提です。NFSの詳細については、<xref linkend="cha-nfs"/>を参照してください。
  </para>

  <procedure>
   <step>
    <para>
     マスタマップファイル<filename>/etc/auto.master</filename>を編集します。
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> vim /etc/auto.master</screen>
    <para>
     <filename>/etc/auto.master</filename>の最後に新しいNFSマウント用の新しいエントリを追加します。
    </para>
<screen>/nfs      /etc/auto.nfs      --timeout=10</screen>
    <para>
     これは、ベースマウントポイントは<filename>/nfs</filename>で、NFS共有は<filename>/etc/auto.nfs</filename>マップで指定されていることを<systemitem>autofs</systemitem>に伝え、非アクティブな状態が10秒間続いたらこのマップ内のすべての共有を自動的にアンマウントするよう指示します。
    </para>
   </step>
   <step>
    <para>
     NFS共有用の新しいマップファイルを作成します。
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> vim /etc/auto.nfs</screen>
    <para>
     通常、<filename>/etc/auto.nfs</filename>には、各NFS共有に対して別個の行が含まれます。形式については、<xref linkend="sec-autofs-mapfiles"/>を参照してください。マウントポイントおよびNFS共有のネットワークアドレスを記述する行を追加します。
    </para>
<screen>export      jupiter.com:/home/geeko/doc/export</screen>
    <para>
     上述の行は、要求があると、<literal>jupiter.com</literal>ホスト上の<filename>/home/geeko/doc/export</filename>ディレクトリがローカルホスト上の<filename>/nfs/export</filename>ディレクトリ(<filename>/nfs</filename>は<filename>auto.master</filename>マップから取得)に自動マウントされることを意味します。<filename>/nfs/export</filename>ディレクトリは、<systemitem>autofs</systemitem>によって自動的に作成されます。
    </para>
   </step>
   <step>
    <para>
     以前に同じNFS共有を静的にマウントしていた場合、必要に応じて<filename>/etc/fstab</filename>の関連する行をコメント化します。行は次のようになります。
    </para>
<screen>#jupiter.com:/home/geeko/doc/export /nfs/export nfs defaults 0 0</screen>
   </step>
   <step>
    <para>
     <systemitem>autofs</systemitem>を再ロードし、動作しているかどうかを確認します。
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl restart autofs</screen>
<screen># ls -l /nfs/export
total 20
drwxr-xr-x  5 1001 users 4096 Jan 14  2017 .images/
drwxr-xr-x 10 1001 users 4096 Aug 16  2017 .profiled/
drwxr-xr-x  3 1001 users 4096 Aug 30  2017 .tmp/
drwxr-xr-x  4 1001 users 4096 Apr 25 08:56 manual/</screen>
    <para>
     リモート共有上にあるファイルのリストを参照できる場合、<systemitem>autofs</systemitem>は機能しています。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-autofs-advanced">
  <title>詳細トピック</title>

  <para>
   このセクションでは、<systemitem>autofs</systemitem>の基本的な説明よりも詳しいトピックについて説明します。ここで説明するのは、ネットワーク上で利用可能なNFS共有の自動マウント、マップファイルでのワイルドカードの使用、およびCIFSファイルシステムに固有の情報です。
  </para>

  <sect2 xml:id="sec-autofs-advanced-net">
   <title><filename>/net</filename> mount point</title>
   <para>
    このヘルパーマウントポイントは、大量のNFS共有を使用する場合に便利です。<filename>/net</filename>には、ローカルネットワーク上にあるすべてのNFS共有がオンデマンドで自動マウントされます。このエントリはすでに<filename>auto.master</filename>ファイルに存在しているため、エントリのコメント化を解除して<systemitem>autofs</systemitem>を再起動するだけで済みます。
   </para>
<screen>/net      -hosts</screen>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl restart autofs</screen>
   <para>
    たとえば、<literal>jupiter</literal>という名前のサーバと<filename>/export</filename>という名前のNFS共有がある場合、
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> cd /net/jupiter/export</screen>
   <para>
    コマンドラインで次のように入力してマウントできます。
   </para>
  </sect2>

  <sect2 xml:id="sec-autofs-advanced-wildcards">
   <title>ワイルドカードを使用したサブディレクトリの自動マウント</title>
   <para>
    個別に自動マウントする必要があるサブディレクトリが含まれるディレクトリがある場合(代表的なケースは、個々のユーザのホームディレクトリが内部にある<filename>/home</filename>ディレクトリ)、<systemitem>autofs</systemitem>には便利な解決方法が備わっています。
   </para>
   <para>
    ホームディレクトリの場合は、<filename>auto.master</filename>に次の行を追加します。
   </para>
<screen>/home      /etc/auto.home</screen>
   <para>
    続いて、<filename>/etc/auto.home</filename>ファイルに正しいマッピングを追加し、ユーザのホームディレクトリが自動的にマウントされるようにする必要があります。1つの解決方法は、各ディレクトリに対して個別のエントリを作成することです。
   </para>
<screen>wilber      jupiter.com:/home/wilber
penguin      jupiter.com:/home/penguin
tux      jupiter.com:/home/tux
[...]</screen>
   <para>
    これは、<filename>auto.home</filename>内にあるユーザのリストを管理する必要があるため、効率的とはいえません。マウントポイントの代わりにアスタリスク「*」を使用し、マウントするディレクトリの代わりにアンパサンド「&amp;」を使用します。
   </para>
<screen>*      jupiter:/home/&amp;</screen>
  </sect2>

  <sect2 xml:id="sec-autofs-advanced-cifs">
   <title>CIFSファイルシステムの自動マウント</title>
   <para>
    SMB/CIFS共有を自動マウントする場合(SMB/CIFSプロトコルの詳細については、<xref linkend="cha-samba"/>を参照)、マップファイルの構文を変更する必要があります。オプションフィールドに<option>-fstype=cifs</option>を追加し、共有の場所にコロン「:」のプレフィクスを付けます。
   </para>
<screen>mount point      -fstype=cifs      ://jupiter.com/export</screen>
  </sect2>
 </sect1>
</chapter>
