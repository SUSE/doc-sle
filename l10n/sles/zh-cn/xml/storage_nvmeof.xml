<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="storage_nvmeof.xml" version="5.0" xml:id="cha-nvmeof" xml:lang="zh-cn">
 <title>NVMe over Fabric</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>是</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    本章介绍如何设置 NVMe over Fabric 主机和目标。
   </para>
  </abstract>
 </info>
 <sect1 xml:id="cha-nvmeof-overview">
  <title>概述</title>
  <para>
   <emphasis>NVM Express</emphasis> (<emphasis>NVMe</emphasis>) 是有关访问非易失性储存（通常是 SSD 磁盘）的接口标准。与 SATA 相比，NVMe 支持的速度要高得多，并且延迟更低。
  </para>
  <para>
   <emphasis>NVMe over Fabric</emphasis> 是用于通过不同网络结构访问 NVMe 储存的体系结构。这些网络结构有 <emphasis>RDMA</emphasis> 或<emphasis>基于光纤通道的 NVMe</emphasis> (<emphasis>FC-NVMe</emphasis>) 等。NVMe over Fabric 的作用类似于 iSCSI。为提高容错能力，NVMe over Fabric 内置了多路径支持。
  </para>
  <para>
   <emphasis>NVMe 主机</emphasis>是指连接到 NVMe 目标的计算机。<emphasis>NVMe 目标</emphasis>是指共享其 NVMe 块设备的计算机。
  </para>
  <para>
   SUSE Linux Enterprise Server <phrase role="productnumber">12 SP5</phrase> 支持 NVMe。提供了可用于 NVMe 块储存以及 NVMe over Fabric 目标和主机的内核模块。
  </para>
  <para>
   要查看您的硬件是否有任何特殊注意事项，请参见<xref linkend="cha-nvmeof-hardware"/>。
  </para>
 </sect1>
 <sect1 xml:id="sec-nvmeof-host-configuration">
  <title>设置 NVMe over Fabric 主机</title>
  <para>
   要使用 NVMe over Fabric，必须在目标上使用支持的联网方法。支持的方法包括基于光纤通道的 NVMe 和 RDMA。以下几节介绍如何将主机连接到 NVMe 目标。
  </para>
  <sect2 xml:id="sec-nvmeof-host-configuration-cli">
   <title>安装命令行客户端</title>
   <para>
    要使用 NVMe over Fabric，需要安装 <command>nvme</command> 命令行工具。请使用 <command>zypper</command> 安装该工具：
   </para>
   <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>zypper in nvme-cli</command></screen>
   <para>
    使用 <command>nvme --help</command> 可列出所有可用的子命令。我们提供了 <command>nvme</command> 子命令的手册页。执行 <command>man nvme-<replaceable>SUBCOMMAND</replaceable></command> 可查阅相关的手册页。例如，要查看 <option>discover</option> 子命令的手册页，请执行 <command>man nvme-discover</command>。
   </para>
  </sect2>
  <sect2 xml:id="sec-nvmeof-host-configuration-target-discovery">
   <title>发现 NVMe over Fabric 目标</title>
   <para>
    要列出 NVMe over Fabric 目标上的可用 NVMe 子系统，您需要有发现控制器地址和服务 ID。
   </para>
   <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>nvme discover -t <replaceable>TRANSPORT</replaceable> -a <replaceable>DISCOVERY_CONTROLLER_ADDRESS</replaceable> -s <replaceable>SERVICE_ID</replaceable></command></screen>
   <para>
    将 <replaceable>TRANSPORT</replaceable> 替换为底层传输媒体：<option>loop</option>、<option>rdma</option> 或 <option>fc</option>。将 <replaceable>DISCOVERY_CONTROLLER_ADDRESS</replaceable> 替换为发现控制器的地址。对于 RDMA，此地址应是 IPv4 地址。将 <replaceable>SERVICE_ID</replaceable> 替换为传输服务 ID。如果服务基于 IP（例如 RDMA），则服务 ID 指定端口号。对于光纤通道，不需要提供服务 ID。
   </para>
   <para>
    NVMe 主机只会看到它们有权连接的子系统。
   </para>
   <para>
    示例：
   </para>
   <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>nvme discover -t rdma -a 10.0.0.1 -s 4420</command></screen>
   <para>
    有关更多细节，请参见 <command>man nvme-discover</command>。
   </para>
  </sect2>
  <sect2 xml:id="sec-nvmeof-host-configuration-connect-target">
   <title>连接 NVMe over Fabric 目标</title>
   <para>
    识别 NVMe 子系统后，便可以使用 <command>nvme connect</command> 命令来连接它。
   </para>
   <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>nvme connect -t <replaceable>transport</replaceable> -a <replaceable>DISCOVERY_CONTROLLER_ADDRESS</replaceable> -s <replaceable>SERVICE_ID</replaceable> -n <replaceable>SUBSYSTTEM_NQN</replaceable></command></screen>
   <para>
    将 <replaceable>TRANSPORT</replaceable> 替换为底层传输媒体：<option>loop</option>、<option>rdma</option> 或 <option>fc</option>。将 <replaceable>DISCOVERY_CONTROLLER_ADDRESS</replaceable> 替换为发现控制器的地址。对于 RDMA，此地址应是 IPv4 地址。将 <replaceable>SERVICE_ID</replaceable> 替换为传输服务 ID。如果服务基于 IP（例如 RDMA），则此 ID 指定端口号。将 <replaceable>SUBSYSTEM_NQN</replaceable> 替换为发现命令找到的所需子系统的 NVMe 限定名称。<emphasis>NQN</emphasis> 是 <emphasis>NVMe 限定名称</emphasis> (NVMe Qualified Name) 的缩写。NQN 必须唯一。
   </para>
   <para>示例：</para>
   <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>nvme connect -t rdma -a 10.0.0.1 -s 4420 -n nqn.2014-08.com.example:nvme:nvm-subsystem-sn-d78432</command></screen>
   <para>
    或者，使用 <command>nvme connect-all</command> 连接到发现的所有名称空间。有关高级用法，请参见 <command>man nvme-connect</command> 和 <command>man nvme-connect-all</command>。
   </para>
  </sect2>
  <sect2 xml:id="sec-nvmeof-host-configuration-multipathing">
   <title>多路径</title>
   <para>
    NVMe 本机多路径默认处于禁用状态。要打印多路径设备的布局，请使用命令 <command>nvme list-subsys</command>。要启用 NVMe 本机多路径，请将 <option>nvme-core.multipath=on</option> 添加为引导参数。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-nvmeof-target-configuration">
  <title>设置 NVMe over Fabric 目标</title>
  <sect2 xml:id="sec-nvmeof-target-configuration-cli">
   <title>安装命令行客户端</title>
   <para>
    要配置 NVMe over Fabric 目标，需要安装 <command>nvmetcli</command> 命令行工具。请使用 <command>zypper</command> 安装该工具：
   </para>
   <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>zypper in nvmetcli</command></screen>
   <para>
    <command> 上提供了 </command>nvmetcli<link xlink:href="http://git.infradead.org/users/hch/nvmetcli.git/blob_plain/HEAD:/Documentation/nvmetcli.txt"/> 的最新文档.
   </para>
  </sect2>
  <sect2 xml:id="sec-nvmeof-target-configuration-steps">
   <title>配置步骤</title>
   <para>
    下面的过程举例说明如何设置 NVMe over Fabric 目标。
   </para>
   <para>
    配置储存在树型结构中。使用 <command>cd</command> 命令可导航。使用 <command>ls</command> 可列出对象。您可以使用 <command>create</command> 创建新对象。
   </para>
   <procedure>
    <step>
     <para>
      启动 <command>nvmectli</command> 交互外壳：
     </para>
     <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>nvmetcli</command></screen>
    </step>
    <step>
     <para>
      创建新端口：
     </para>
<screen><prompt>(nvmetcli)&gt; </prompt><command>cd ports</command>
<prompt>(nvmetcli)&gt; </prompt><command>create 1</command>
<prompt>(nvmetcli)&gt; </prompt><command>ls 1/</command>
o- 1
  o- referrals
  o- subsystems</screen>
    </step>
    <step>
     <para>创建 NVMe 子系统：</para>
<screen><prompt>(nvmetcli)&gt; </prompt><command>cd /subsystems</command>
<prompt>(nvmetcli)&gt; </prompt><command>create nqn.2014-08.org.nvmexpress:NVMf:uuid:c36f2c23-354d-416c-95de-f2b8ec353a82</command>
<prompt>(nvmetcli)&gt; </prompt><command>cd nqn.2014-08.org.nvmexpress:NVMf:uuid:c36f2c23-354d-416c-95de-f2b8ec353a82/</command>
<prompt>(nvmetcli)&gt; </prompt><command>ls</command>
o- nqn.2014-08.org.nvmexpress:NVMf:uuid:c36f2c23-354d-416c-95de-f2b8ec353a82
  o- allowed_hosts
  o- namespaces</screen>
    </step>
    <step>
     <para>
      创建新的名称空间，并在其中设置 NVMe 设备。
     </para>
<screen><prompt>(nvmetcli)&gt; </prompt><command>cd namespaces</command>
<prompt>(nvmetcli)&gt; </prompt><command>create 1</command>
<prompt>(nvmetcli)&gt; </prompt><command>cd 1</command>
<prompt>(nvmetcli)&gt; </prompt><command>set device path=/dev/nvme0n1</command>
Parameter path is now '/dev/nvme0n1'.</screen>
    </step>
    <step>
     <para>
      启用先前创建的名称空间：
     </para>
<screen><prompt>(nvmetcli)&gt; </prompt><command>cd ..</command>
<prompt>(nvmetcli)&gt; </prompt><command>enable</command>
The Namespace has been enabled.</screen>
    </step>
    <step>
     <para>
      显示创建的名称空间：
     </para>
<screen><prompt>(nvmetcli)&gt; </prompt><command>cd ..</command>
<prompt>(nvmetcli)&gt; </prompt><command>ls</command>
o- nqn.2014-08.org.nvmexpress:NVMf:uuid:c36f2c23-354d-416c-95de-f2b8ec353a82
  o- allowed_hosts
  o- namespaces
    o- 1</screen>
    </step>
    <step>
     <para>
      允许所有主机使用该子系统。只有在安全环境中才可这样做。
     </para>
<screen><prompt>(nvmetcli)&gt; </prompt><command>set attr allow_any_host=1</command>
Parameter allow_any_host is now '1'.</screen>
     <para>
      或者，可以只允许特定的主机建立连接：
     </para>
<screen><prompt>(nvmetcli)&gt; </prompt><command>cd nqn.2014-08.org.nvmexpress:NVMf:uuid:c36f2c23-354d-416c-95de-f2b8ec353a82/allowed_hosts/</command>
<prompt>(nvmetcli)&gt; </prompt><command>create hostnqn</command></screen>
    </step>
    <step>
     <para>
      列出创建的所有对象：
     </para>
<screen><prompt>(nvmetcli)&gt; </prompt><command>cd /</command>
<prompt>(nvmetcli)&gt; </prompt><command>ls</command>
o- /
  o- hosts
  o- ports
  | o- 1
  |   o- referrals
  |   o- subsystems
  o- subsystems
    o- nqn.2014-08.org.nvmexpress:NVMf:uuid:c36f2c23-354d-416c-95de-f2b8ec353a82
      o- allowed_hosts
      o- namespaces
        o- 1</screen>
    </step>
    <step>
     <para>
      使目标可通过 RDMA 使用：
     </para>
<screen><prompt>(nvmetcli)&gt; </prompt><command>cd ports/1/</command>
<prompt>(nvmetcli)&gt; </prompt><command>set addr adrfam=ipv4 trtype=rdma traddr=10.0.0.1 trsvcid=4420</command>
Parameter trtype is now 'rdma'.
Parameter adrfam is now 'ipv4'.
Parameter trsvcid is now '4420'.
Parameter traddr is now '10.0.0.1'.</screen>
     <para>
      或者，使目标可通过光纤通道使用：
     </para>
<screen><prompt>(nvmetcli)&gt; </prompt><command>cd ports/1/</command>
<prompt>(nvmetcli)&gt; </prompt><command>set addr adrfam=fc trtype=fc traddr=nn-0x1000000044001123:pn-0x2000000055001123 trsvcid=none</command></screen>
    </step>
   </procedure>
  </sect2>
  <sect2 xml:id="sec-nvmeof-target-configuration-backup-configuration">
   <title>备份和恢复目标配置</title>
   <para>
    可使用以下命令在 JSON 文件中保存目标配置：
   </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> <command>nvmetcli</command>
<prompt>(nvmetcli)&gt; </prompt><command>saveconfig nvme-target-backup.json</command></screen>
    <para>
     要恢复配置，请使用：
    </para>
    <screen><prompt>(nvmetcli)&gt; </prompt><command>restore nvme-target-backup.json</command></screen>
    <para>
     您还可以擦除当前配置：
    </para>
    <screen><prompt>(nvmetcli)&gt; </prompt><command>clear</command></screen>
  </sect2>
 </sect1>
 <sect1 xml:id="cha-nvmeof-hardware">
  <title>特殊硬件配置</title>
  <sect2 xml:id="cha-nvmeof-hardware-overview">
   <title>概述</title>
   <para>
    有些硬件需要特殊的配置才能正常工作。请浏览以下章节的标题，确定您是否使用了所提到的设备或供应商。
   </para>
  </sect2>
  <sect2 xml:id="cha-nvmeof-hardware-broadcom">
   <title>Broadcom</title>
   <para>
    如果您在使用 <emphasis>Broadcom Emulex LightPulse Fibre Channel SCSI</emphasis> 驱动程序，请在 <literal>lpfc</literal> 模块的目标和主机中添加内核配置参数：
   </para>
   <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>echo "options lpfc lpfc_enable_fc4_type=3" &gt; /etc/modprobe.d/lpfc.conf</command></screen>
   <para>
    确保 Broadcom 适配器固件的版本至少为 11.2.156.27。另外确保已安装最新版本的
    <package>nvme-cli</package>, <package>nvmetlci</package> 和内核。
   </para>
   <para>
    要启用光纤通道端口作为 NVMe 目标，请设置模块参数 <option>lpfc_enable_nvmet=<replaceable> COMMA_SEPARATED_WWPNS</replaceable></option>。系统只会为目标模式配置列出的 WWPN。可将光纤通道端口配置为目标<emphasis>或</emphasis>发起端。
   </para>
  </sect2>
  <sect2 xml:id="sec-nvmeof-hardware-marvell">
   <title>Marvell</title>
   <para>
    QLE269x 和 QLE27xx 适配器上都支持 FC-NVMe。Marvell® QLogic® QLA2xxx 光纤通道驱动程序中默认会启用 FC-NVMe 支持。
   </para>
   <para>
    要确认 NVMe 是否已启用，请运行以下命令：
   </para>
   <screen><prompt>tux &gt; </prompt>cat /sys/module/qla2xxx/parameters/ql2xnvmeenable</screen>
   <para>
    如果显示 <literal>1</literal>，则表明 NVMe 已启用，显示 <literal>0</literal> 表示 NVMe 已禁用。
   </para>

   <para>
    然后，检查以下命令的输出，确保 Marvell 适配器固件的版本不低于 8.08.204。
   </para>
   <screen><prompt>tux &gt; </prompt>cat /sys/class/scsi_host/host0/fw_version</screen>

   <para>
    最后，确保已安装适用于 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 的最新版本（
    <package>nvme-cli</package>、 <package>QConvergeConsoleCLI</package>）及内核。例如，您可以运行
   </para>
   <screen><prompt role="root">root # </prompt>zypper lu &amp;&amp; zypper pchk</screen>
   <para>
    来检查更新和增补程序。
   </para>

   <para>
    有关安装的更多细节，请参考下列 Marvell 用户指南中的 FC-NVMe 部分：
   </para>
   <itemizedlist>
    <listitem>
     <para>
      <link xlink:href="http://driverdownloads.qlogic.com/QLogicDriverDownloads_UI/ShowEula.aspx?resourceid=32769&amp;docid=96728&amp;ProductCategory=39&amp;Product=1259&amp;Os=126"/>
     </para>
    </listitem>
    <listitem>
     <para>
      <link xlink:href="http://driverdownloads.qlogic.com/QLogicDriverDownloads_UI/ShowEula.aspx?resourceid=32761&amp;docid=96726&amp;ProductCategory=39&amp;Product=1261&amp;Os=126"/>
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
 </sect1>
 <sect1 xml:id="cha-nvmeof-more-information">
  <title>更多信息</title>
  <para>
   有关 <command>nvme</command> 命令的功能的更多细节，请参考 <command>nvme nvme-help</command>。
  </para>
  <para>
   以下链接提供了 NVMe 和 NVMe over Fabric 的简介：
  </para>
  <itemizedlist>
   <listitem>
    <para><link xlink:href="http://nvmexpress.org/"/></para>
   </listitem>
   <listitem>
    <para><link xlink:href="http://www.nvmexpress.org/wp-content/uploads/NVMe_Over_Fabrics.pdf"/></para>
   </listitem>
   <listitem>
    <para><link xlink:href="https://storpool.com/blog/demystifying-what-is-nvmeof"/></para>
   </listitem>
   <listitem>
    <para><link xlink:href="https://medium.com/@metebalci/a-quick-tour-of-nvm-express-nvme-3da2246ce4ef"/></para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
