<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_migration.xml" version="5.0" xml:id="cha.update.spmigration">
 <title>Migration de Service Packs</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>oui</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    SUSE offre un outil graphique et de ligne de commande pour effectuer la mise à niveau vers un nouveau Service Pack. Il s'agit d'outils de ligne de commande simples, d'une interface utilisateur graphique intuitive, d'une prise en charge pour le <quote>retour à l'état initial</quote> des Service Packs et d'autres fonctions. Ce chapitre explique comment effectuer une migration de Service Packs étape par étape à l'aide de ces outils.
   </para>
  </abstract>
 </info>
 <sect1 xml:id="sec.update.migr.conceptual-overview">
  <title>Présentation conceptuelle</title>

  <para>
   SUSE publie régulièrement de nouveaux Service Packs pour la gamme de produits SUSE Linux Enterprise. Pour faciliter la migration vers un nouveau Service Pack et minimiser les temps hors service, SUSE prend en charge la migration en ligne pendant que le système est en cours d'exécution.
  </para>

  <para>
   À partir de SLE 12 SP2, YaST Wagon a été remplacé par la migration de YaST (pour l'interface graphique) et la migration de Zypper (pour la ligne de commande). Les fonctions prises en charge sont les suivantes :
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Le système est toujours dans un état défini jusqu'à la mise à jour du premier RPM.
    </para>
   </listitem>
   <listitem>
    <para>
     L'annulation est possible jusqu'à la mise à jour du premier RPM.
    </para>
   </listitem>
   <listitem>
    <para>
     La récupération est simple en cas d'erreur.
    </para>
   </listitem>
   <listitem>
    <para>
     <quote>Retour à l'état initial</quote> à l'aide des outils système ; aucune sauvegarde/restauration nécessaire.
    </para>
   </listitem>
   <listitem>
    <para>
     Utilisation de tous les dépôts actifs.
    </para>
   </listitem>
   <listitem>
    <para>
     La possibilité d'ignorer un Service Pack.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.supported-scenarios-and-versions">
  <title>Versions de produits et scénarios logiciels pris en charge</title>

  <para>
   SUSE prend en charge les scénarios suivants, que ce soit en ligne ou hors ligne :
  </para>

  <variablelist>
   <varlistentry>
    <term>En ligne</term>
    <listitem>
     <para>
      SUSE Customer Center (SCC), SMT (Subscription Management Tool), SUSE Manager
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Hors ligne</term>
    <listitem>
     <para>
      DVD de démarrage, lecteur flash, image ISO, AutoYaST, <quote>plain RPM</quote> et outils tiers
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   La migration à partir des versions suivantes est prise en charge :
  </para>

  <variablelist>
   <varlistentry>
    <term>En ligne</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 12
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Hors ligne</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 11 SP3/SP4, SUSE Linux Enterprise 12
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Mode manuel ou fournisseurs tiers</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 12
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec.update.migr.workflow">
  <title>Déroulement de la migration des Service Packs</title>

  <para>
   Une migration de Service Pack peut être exécutée à l'aide des outils YaST, <command>zypper</command> ou AutoYaST.
  </para>

  <para>
   Avant de pouvoir démarrer la migration d'un Service Pack, votre système doit être enregistré auprès du SUSE Customer Center. Il n'est pas possible d'effectuer une migration à l'aide de dépôts créés de manière autonome dérivés de DVD.
  </para>

  <para>
   Quelle que soit la méthode utilisée, la migration de Service Packs comporte les étapes suivantes :
  </para>

  <orderedlist>
   <listitem>
    <para>
     L'identification de cibles de migration possibles sur vos systèmes enregistrés
    </para>
   </listitem>
   <listitem>
    <para>
     La sélection d'une cible de migration
    </para>
   </listitem>
   <listitem>
    <para>
     La demande et l'activation de nouveaux dépôts
    </para>
   </listitem>
   <listitem>
    <para>
     L'exécution de la migration
    </para>
   </listitem>
  </orderedlist>



  <para>
   La liste des cibles de migration dépend des produits que vous avez installés et enregistrés. Si vous avez une extension installée pour laquelle le nouveau Service Pack n'est pas encore disponible, il se peut qu'aucune cible de migration ne vous soit proposée.
  </para>

  <para>
   La liste des cibles de migration disponibles pour votre hôte sera toujours récupérée à partir du SUSE Customer Center et dépend des produits ou des extensions installées.
  </para>
 </sect1>
 <sect1 xml:id="sec.update.migr.cancel.spm">
  <title>Annulation de la migration d'un Service Pack</title>

  <para>
   La migration d'un Service Pack peut uniquement être annulée à certains stades au cours du processus de migration :
  </para>

  <orderedlist>
   <listitem>
    <para>
     Jusqu'au démarrage de la mise à niveau du paquetage, les modifications sur le système sont minimes et concernent par exemple, les services et dépôts. Restaurez <filename>/etc/zypp/repos.d/*</filename> pour revenir à l'état précédent.
    </para>
   </listitem>
   <listitem>
    <para>
     Après le démarrage de la mise à niveau du paquetage, vous pouvez revenir à l'état précédent à l'aide d'un instantané Snapper (reportez-vous au manuel <xref linkend="cha.snapper"/>).
    </para>
   </listitem>
   <listitem>
    <para>
     Une fois la cible de migration sélectionnée, SUSE Customer Center modifie les données du dépôt. Pour rétablir cet état manuellement, utilisez <command>SUSEConnect</command><option>--rollback</option>.
    </para>
   </listitem>
  </orderedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.yast.onlinemigr">
  <title>Migration à l'aide de l'outil de migration en ligne (YaST)</title>

  <para>
   Pour effectuer une migration de Service Packs à l'aide de YaST, utilisez l'outil de <guimenu>migration en ligne</guimenu>. Par défaut, YaST n'installe pas les paquetages à partir d'un dépôt tiers. Si un paquetage a été installé à partir d'un dépôt tiers, YaST empêche le remplacement des paquetages par les mêmes provenant de SUSE.
  </para>

  <note>
   <title>réduction de la taille de l'installation</title>
   <para>
    Lorsque vous effectuez la migration de Service Packs, YaST installe tous les paquetages recommandés. En particulier dans le cas d'installations minimales personnalisées, cela peut augmenter considérablement la taille de l'installation sur le système.
   </para>
   <para>
    Pour modifier ce comportement par défaut et autoriser uniquement les paquetages requis, adaptez <filename>/etc/zypp/zypp.conf</filename> et définissez la variable suivante :
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   Cette opération modifie le comportement de toutes les opérations de paquetages, telles que l'installation de correctifs ou de nouveaux paquetages.
  </para>

  <para>
   Pour démarrer la migration de Service Packs, procédez comme suit :
  </para>

  <procedure xml:id="pro.update.migr.yast">
   <step>
    <para>
     Exécutez la mise à jour en ligne de YaST pour obtenir les dernières mises à jour des paquetages de votre système.
    </para>
   </step>
   <step>
    <para>
     Installez le paquetage 
     <package>yast2-migration</package>
     et ses dépendances (dans YaST sous<menuchoice> <guimenu>Logiciels</guimenu> <guimenu>Gestion des logiciels</guimenu></menuchoice>).
    </para>
   </step>
   <step>
    <para>
     Redémarrez YaST, car dans le cas contraire, le nouveau module installé ne s'affiche pas dans SUSE Control Center.
    </para>
   </step>
   <step>
    <para>
     Dans YaST, accédez à <menuchoice><guimenu>Système</guimenu> <guimenu>Migration en ligne</guimenu></menuchoice>. YaST affiche les cibles de migration possibles ainsi qu'un récapitulatif. Si plusieurs cibles de migration sont disponibles pour votre système, sélectionnez-en une dans la liste.
    </para>
   </step>
   <step>
    <para>
     Sélectionnez une cible de migration à partir de la liste et cliquez sur <guimenu>Suivant</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Si l'outil de migration propose des dépôts de mise à jour, il est recommandé de cliquer sur <guimenu>Oui</guimenu>.
    </para>
   </step>
   <step>
    <para>
     <remark>toms 2015-09-09: FATE#319140</remark> Si l'outil de migration en ligne détecte des dépôts obsolètes provenant d'un DVD ou d'un serveur local, il est vivement recommandé de les désactiver. Les dépôts obsolètes proviennent d'un ancien Service Pack. Tous les anciens dépôts de SCC ou SMT sont automatiquement supprimés.
    </para>
   </step>
   <step>
    <para>
     Vérifiez le récapitulatif et procédez à la migration en cliquant sur <guimenu>Suivant</guimenu>. Confirmez en cliquant sur <guimenu>Start Update</guimenu> (Démarrer la mise à jour).
    </para>
    <remark>toms 2016-07-13: What to do in case of problems?</remark>
   </step>
   <step>
    <para>
     Une fois la migration réussie, redémarrez votre système.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.zypper.onlinemigr">
  <title>Migration à l'aide de Zypper</title>

  <para>
   Pour effectuer une migration de Service Packs à l'aide de Zypper, utilisez de l'outil de ligne de commande <command>zypper</command> <option>migration</option>.
  </para>

  <note>
   <title>réduction de la taille de l'installation</title>
   <para>
    Lorsque vous effectuez la migration de Service Packs, YaST installe tous les paquetages recommandés. En particulier dans le cas d'installations minimales personnalisées, cela peut augmenter considérablement la taille de l'installation sur le système.
   </para>
   <para>
    Pour modifier ce comportement par défaut et autoriser uniquement les paquetages requis, adaptez <filename>/etc/zypp/zypp.conf</filename> et définissez la variable suivante :
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   Cette opération modifie le comportement de toutes les opérations de paquetages, telles que l'installation de correctifs ou de nouveaux paquetages. Pour modifier le comportement de Zypper pour une seule invocation, ajoutez le paramètre <option>--no-recommends</option> à votre ligne de commande.
  </para>

  <para>
   Pour démarrer la migration de Service Packs, procédez comme suit :
  </para>

  <procedure xml:id="pro.update.migr.zypper">
   <step>
    <para>
     Enregistrez votre machine SUSE Linux Enterprise si ce n'est pas déjà fait :
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --regcode <replaceable>YOUR_REGISTRATION_CODE</replaceable></screen>
   </step>
   <step>
    <para>
     Installez les dernières mises à jour :
    </para>
<screen><prompt>root # </prompt><command>zypper</command> patch</screen>
   </step>
   <step>
    <para>
     Installez les paquetages
     <package>zypper-migration-plugin</package>
     et leurs dépendances :
    </para>
<screen><prompt>root # </prompt><command>zypper</command> migration</screen>
   </step>
   <step>
    <para>
     Exécutez <command>zypper</command> <option>migration</option> :
    </para>
<screen><prompt>root # </prompt><command>zypper</command> migration
Executing 'zypper  patch-check'

Refreshing service 'SUSE_Linux_Enterprise_Server_12_x86_64'.
Loading repository data...
Reading installed packages...
0 patches needed (0 security patches)

Available migrations:

    1 | SUSE Linux Enterprise Server 12 SP1 x86_64
    2 | SUSE Linux Enterprise Server 12 SP2 x86_64</screen>
    <para>
     Quelques remarques concernant le processus de migration :
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Si plusieurs cibles de migration sont disponibles pour votre système, Zypper vous autorise à sélectionner un Service Pack dans la liste. Cette opération revient à ignorer un ou plusieurs Service Packs. N'oubliez pas, la migration en ligne pour les produits de base (SLES, SLED) reste uniquement disponible entre les Service Packs d'une version majeure.
      </para>
     </listitem>
     <listitem>
      <para>
       Par défaut, Zypper utilise l'option <option>--no-allow-vendor-change </option> transmise à <command>zypper</command> <option>dup</option> Si un paquetage a été installé à partir d'un dépôt tiers, cette option empêche le remplacement des paquetages par les mêmes provenant de SUSE.
      </para>
     </listitem>
     <listitem>
      <para>
       <remark>toms 2015-09-09: FATE#319140</remark> Si Zypper détecte des dépôts obsolètes provenant d'un DVD ou d'un serveur local, il est vivement recommandé de les désactiver. Les anciens dépôts de SCC ou SMT sont supprimés automatiquement.
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     Passez en revue toutes les modifications, en particulier les paquetages qui vont être supprimés. Poursuivez en saisissant <literal>y</literal> (le nombre exact de paquetages à mettre à niveau peut varier sur votre système) :
    </para>
<screen>266 packages to upgrade, 54 to downgrade, 17 new, 8 to reinstall, 5 to remove, 1 to change arch.
Overall download size: 285.1 MiB. Already cached: 0 B  After the operation, additional 139.8 MiB will be used.
Continue? [y/n/? shows all options] (y):</screen>
    <para>
     Utilisez les touches de défilement <keycombo> <keycap function="shift"/> <keycap function="pageup"/> </keycombo> ou <keycombo> <keycap function="shift"/> <keycap function="pagedown"/> </keycombo> dans votre shell.
    </para>
   </step>
   <step>
    <para>
     Une fois la migration réussie, redémarrez votre système.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.plainzypper.onlinemigr">
  <title>Migration à l'aide de Plain Zypper</title>

  <para>
   Si vous ne pouvez pas utiliser la migration YaST ou Zypper, vous pouvez toujours effectuer la migration à l'aide de Zypper brut et de certaines interactions manuelles. Pour démarrer une migration de Service Packs, procédez comme suit :
  </para>

  <procedure>
   <step>
    <para>
     Mettez à jour les outils de gestion des paquetages avec les anciens dépôts SUSE Linux Enterprise :
    </para>
<screen><prompt>root # </prompt><command>zypper</command> patch--updatestack-only</screen>
   </step>
   <step>
    <para>
     Si le système a été enregistré, vous devez annuler son enregistrement :
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --de-register</screen>
   </step>
   <step>
    <para>
     Supprimez les anciens dépôts et sources d'installation et ajustez les dépôts tiers.
    </para>
   </step>
   <step>
    <para>
     Ajoutez les nouvelles sources d'installation, qu'elles soient locales ou distantes (pour la marque de réservation <replaceable>DÉPÔT</replaceable>, reportez-vous à la section <xref linkend="tab.update.nmm.repositories.sp2"/>) :
    </para>
<screen><prompt>root # </prompt><command>zypper</command> addrepo <replaceable>REPOSITORY</replaceable></screen>
    <para>
     Vous pouvez également utiliser l'outil SMT ou SUSE Customer Center. La commande pour SUSE Linux Enterprise 12 SP1 sous x86-64 est la suivante :
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> -p SLES/12.2/x86_64 <replaceable>OPTIONS</replaceable></screen>
    <para>
     N'oubliez pas que les mises à niveau simultanées sur plusieurs architectures ne sont pas prises en charge.
    </para>
   </step>
   <step>
    <para>
     Finalisez la migration :
    </para>
<screen><prompt>root # </prompt><command>zypper</command> ref -f -s
<prompt>root # </prompt><command>zypper</command> dup --no-allow-vendor-change --no-recommends</screen>
    <para>
     La première commande mettra à jour tous les services et dépôts. La seconde commande effectue une mise à niveau de distribution. Ici, les deux dernières options sont importantes : <option>-no-allow-vendor-change</option> permet de s'assurer que les RPM tiers n'écrasent pas ceux du système de base. L'option <option>--no-recommends</option> permet de s'assurer que les paquetages désélectionnés au cours de l'installation initiale ne sont pas ajoutés à ce stade.
    </para>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec.update.migr.ownscripts.onlinemigr">
  <title>Migration manuelle</title>
  <remark>toms 2016-07-13: Is this supported?</remark>
  <para>
   La migration manuelle ou avec des scripts personnalisés requiert une connaissance plus approfondie des éléments de votre système. Par conséquent, la procédure suivante est uniquement recommandée aux experts.
  </para>

  <para>
   Pour faire migrer votre système manuellement, procédez comme suit :
  </para>

  <procedure>
   <step>
    <para>
     Préparez votre système :
    </para>
    <substeps>
     <step>
      <para>
       Annulez l'enregistrement de votre système actuel à partir de SCC :
      </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --de-register</screen>
     </step>
     <step>
      <para>
       Désactivez les anciennes sources d'installation provenant d'un DVD. Par exemple, inspectez <filename>/etc/zypp/repos.d/SLES12-12-0.repo</filename>.
      </para>
     </step>
     <step>
      <para>
       Recherchez des dépôts tiers et adaptez l'URL.
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     Décidez si vous souhaitez ajouter des dépôts distants à l'aide de SUSE Customer Center ou ajouter des dépôts locaux :
    </para>
    <variablelist>
     <varlistentry>
      <term>Source d'installation à distance via SCC</term>
      <listitem>
       <para>
        Ajoutez de nouvelles sources d'installation via le canal en ligne :
       </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> -p SLES/12.2/x86_64 -r <replaceable>CODE</replaceable> -e <replaceable>EMAIL</replaceable></screen>
       <para>
        Vérifiez si le système a été correctement enregistré :
       </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --status</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Source d'installation locale</term>
      <listitem>
       <para>
        Ajoutez une source d'installation locale :
       </para>
<screen><prompt>root # </prompt><command>zypper</command> ar -f http://example.com/media/SLES12SP2/
<prompt>root # </prompt><command>zypper</command> ar dvd:///?devices=/dev/sr0 SLES12SP2</screen>
      </listitem>
     </varlistentry>
    </variablelist>
   </step>
   <step>
    <para>
     Rafraîchissez tous les dépôts :
    </para>
<screen><prompt>root # </prompt><command>zypper</command> --releasever 12.2 ref -f -s</screen>
   </step>
   <step>
    <para>
     Effectuez la mise à niveau de distribution en exécutant la commande <command>zypper dup</command> :
    </para>
<screen><prompt>root # </prompt><command>zypper</command> --releasever 12.2 dup --no-allow-vendor-change --recommends</screen>
   </step>
   <step>
    <para>
     Enregistrez le système si ce n'est déjà fait.
    </para>
   </step>
   <step>
    <para>
     Vérifiez que le système a été correctement enregistré :
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --status</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.rollback">
  <title>Restauration de l'état initial d'un Service Pack</title>

  <para>
   Si un Service Pack ne fonctionne pas pour vous, SUSE Linux Enterprise prend en charge le rétablissement de l'état qu'il avait avant le démarrage de la migration du Service Pack.
  </para>

  <procedure xml:id="pro.update.migr.rollback">
   <step>
    <para>
     Obtenez une liste des instantanés Snapper :
    </para>
    <screen><prompt>root # </prompt><command>snapper</command> list</screen>
    <para>
     Passez en revue son résultat et choisissez un nombre pour l'étape suivante. Pour plus de détails concernant Snapper, reportez-vous au <xref linkend="cha.snapper"/>.
    </para>
   </step>
   <step>
    <para>
     Sélectionnez un instantané Snapper dont l'état initial doit être restauré. Indiquez le numéro renseigné à l'étape précédente :
    </para>
<screen><prompt>root # </prompt><command>snapper</command> rollback <replaceable>NUMBER</replaceable></screen>
   </step>
   <step>
    <para>
     Restaurez le chargeur de démarrage (pour des détails, reportez-vous au <xref linkend="cha.grub2"/>) :
    </para>
<screen><prompt>root # </prompt><command>grub2</command> boot menu</screen>
    <para>
     Au cours du démarrage, l'enregistrement est réinitialisé automatiquement.
    </para>
   </step>
   <step>
    <para>
     Vérifiez si le système a été correctement enregistré (reportez-vous aussi à la <xref linkend="sec.update.registersystem"/> pour plus d'informations) :
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --status</screen>
   </step>
   <step>
    <para>
     Si nécessaire, réparez l'enregistrement :
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --rollback</screen>
   </step>
  </procedure>
 </sect1>
</chapter>
