<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ulp.xml" version="5.0" xml:id="cha-ulp" xml:lang="ja">
 <title>ユーザ空間ライブパッチ</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    このドキュメントでは、ユーザ空間ライブパッチの基本的な原則と使用法について説明します。
   </para>
  </abstract>
 </info>
 <sect1 xml:id="sec-ulp">
  <title>ユーザ空間ライブパッチについて</title>

  <para>
   ユーザ空間ライブパッチ(ULP)とは、実行中のプロセスで使用されるライブラリに、中断することなくパッチを適用するプロセスのことです。ライブパッチ操作は、<systemitem>libpulp</systemitem>の一部である<systemitem>ulp</systemitem>ツールを使用して実行されます。
  </para>

  <para>
   <systemitem>libpulp</systemitem>は、ユーザ空間ライブパッチを可能にするフレームワークです。ライブラリをライブパッチ可能にしたり、ライブパッチ(<systemitem>ulp</systemitem>バイナリ)を適用したりするための<systemitem>libpulp.so</systemitem>ライブラリとツールで構成されています。
  </para>

  <sect2 xml:id="sec-ulp-prereqs">
   <title>前提条件</title>
   <para>
    ULPを機能させるには、2つの要件を満たす必要があります。
   </para>
   <itemizedlist>
    <listitem>
     <para>
      ライブパッチを可能にするには、ライブラリを<option>-fpatchable-function-entry</option> GCCフラグでコンパイルする必要があります。ライブラリのソースコードを変更する必要はありません。
     </para>
    </listitem>
    <listitem>
     <para>
      プロセスは<systemitem>libpulp.so</systemitem>ライブラリをプリロードする必要があります。
     </para>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="sec-ulp-libpulp">
   <title>libpulpの使用</title>
   <para>
    アプリケーションで<systemitem>libpulp</systemitem>を使用するには、次の手順を実行する必要があります。
   </para>
   <orderedlist>
    <listitem>
     <para>
      ライブラリをライブパッチ可能にします。
     </para>
    </listitem>
    <listitem>
     <para>
      アプリケーションを起動する際には、<systemitem>libpulp</systemitem>を<command>LD_PRELOAD=/usr/lib64/libpulp.so ./<replaceable>APPLICATION</replaceable></command>コマンドを使用してプリロードします。
     </para>
    </listitem>
   </orderedlist>
   <sect3 xml:id="sec-ulp-prep-lib">
    <title>ライブラリをライブパッチ可能にする準備</title>
    <para>
     ライブラリをライブパッチ可能にするには、すべての関数呼び出しに<literal>NOP</literal>プロローグが含まれている必要があります。GCCバージョン8以降、およびSUSE Linux Enterprise Serverに付属のGCCバージョンは、特にその目的のために<option>-fpatchable-function-entry</option>を提供します。したがって、AMD64/Intel 64アーキテクチャでは、Cで記述されたライブラリを<option>-fpatchable-function-entry=16,14</option>フラグでコンパイルすれば、ライブパッチ可能になります。
    </para>
    <para>
     glibc、libssl.so.1.1、およびlibcrypto.so.1.1ライブラリは、SUSE Linux Enterprise 15 SP4ではすでにライブパッチ可能です。
    </para>
   </sect3>
   <sect3 xml:id="sec-ulp-livepatch-check">
    <title>ライブラリがライブパッチ可能かどうかの確認</title>
    <para>
     ライブラリがライブパッチ可能かどうかを確認するには、次のコマンドを使用します。
    </para>
<screen>ulp livepatchable <replaceable>LIBRARY</replaceable></screen>
   </sect3>
   <sect3 xml:id="sec-ulp-apply-livepatch">
    <title>ライブパッチの適用</title>
    <para>
     ライブパッチは、次のような、<systemitem>ulp trigger</systemitem>コマンドを使用して適用されます。
    </para>
<screen>ulp trigger -p <replaceable>PID</replaceable> <replaceable>LIVEPATCH</replaceable>.ulp</screen>
    <para>
     この例では、<literal>PID</literal>はパッチを適用するライブラリを使用する実行中のプロセスのPIDで、<literal>LIVEPATCH.ulp</literal>は実際のライブパッチファイルです。
    </para>
    <para>
     <literal>live patching succeeded</literal>メッセージは、ライブパッチ操作が成功したことを示します。
    </para>
   </sect3>
   <sect3 xml:id="sec-ulp-revert-livepatch">
    <title>ライブパッチを元に戻す</title>
    <para>
     <command>ulp trigger</command>を使用してライブパッチを元に戻すことができます。ライブパッチを元に戻すには、2つの方法があります。適切な<filename>.rev</filename>パッチを適用することで、ライブパッチを元に戻すことができます。
    </para>
<screen>ulp trigger -p <replaceable>PID</replaceable> <replaceable>LIVEPATCH</replaceable>.rev</screen>
    <para>
     または、特定のライブラリに関連付けられているすべてのパッチを削除することもできます。例:
    </para>
<screen>ulp trigger -p <replaceable>PID</replaceable> --revert-all=<replaceable>LIBRARY</replaceable></screen>
    <para>
     上記の例では、<replaceable>LIBRARY</replaceable>は実際のライブラリを指しています。例: <systemitem>libcrypto.so.1.1</systemitem>
    </para>
    <para>
     後者のアプローチは、元のライブパッチのソースコードが利用できない場合や、ターゲットアプリケーションが安全でない可能性のあるコードを実行せずに、特定の古いパッチを削除して新しいパッチを適用する場合に役立ちます。例:
    </para>
<screen>ulp trigger -p <replaceable>PID</replaceable>  --revert-all=libcrypto.so.1.1 new_livepatch2.ulp</screen>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-ulp-info">
  <title>詳細情報</title>

  <para>
   <systemitem>libpulp</systemitem>に関する詳細については、プロジェクトの<link xlink:href="https://github.com/SUSE/libpulp">Gitリポジトリ</link>を参照してください。
  </para>
 </sect1>
</chapter>
