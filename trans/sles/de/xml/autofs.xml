<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xml:base="autofs.xml" id="cha.autofs">
 <title>Bedarfsweises Einhängen mit autofs</title><indexterm> <primary>AutoFS</primary></indexterm>
 <abstract>
  <para>
   Das Programm <systemitem>autofs</systemitem> hängt automatisch festgelegte Verzeichnisse bedarfsweise ein. Das Programm beruht auf einem Kernel-Modul, das für hohe Effizienz sorgt, und kann sowohl lokale Verzeichnisse als auch Netzwerkfreigaben verwalten. Diese automatischen Einhängepunkte werden nur dann eingehängt, wenn auf sie zugegriffen wird; nach einem bestimmten Zeitraum ohne Aktivität werden sie wieder ausgehängt. Dieses bedarfsweise Verfahren spart Bandweite und bewirkt höhere Leistungen als das statische Einhängen mit <filename>/etc/fstab</filename>. <systemitem>autofs</systemitem> ist das Steuerungsskript und <command>automount</command> das Kommando (der Daemon), mit dem das automatische Einhängen ausgeführt wird.
  </para>
 </abstract>
 <sect1 id="sec.autofs.installation">
  <title>Installation</title>

  <para>
   <systemitem>autofs</systemitem> ist nicht standardmäßig in <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> installiert. Zum Nutzen der Funktionen für das automatische Einhängen installieren Sie das Programm zunächst mit
  </para>

<screen>sudo zypper install autofs</screen>
 </sect1>
 <sect1 id="sec.autofs.configuration">
  <title>Konfiguration</title>

  <para>
   <systemitem>autofs</systemitem> muss manuell konfiguriert werden. Bearbeiten Sie hierzu die Konfigurationsdateien mit einem Texteditor, z. B. <command>vim</command>. Die Konfiguration von <systemitem>autofs</systemitem> umfasst zwei grundlegende Schritte: die <emphasis>master</emphasis>-Zuordnungsdatei und bestimmte Zuordnungsdateien.
  </para>

  <sect2 id="sec.autofs.configuration.master_map">
   <title>Die Master-Zuordnungsdatei</title>
   <para>
    Die standardmäßige Master-Konfigurationsdatei für <systemitem>autofs</systemitem> ist <filename>/etc/auto.master</filename>. Soll der Speicherort dieser Datei geändert werden, bearbeiten Sie den Wert der Option <option>DEFAULT_MASTER_MAP_NAME</option> in <filename>/etc/sysconfig/autofs</filename>. Beispiel für <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>:
   </para>
<screen>#
# Sample auto.master file
# This is an automounter map and it has the following format
# key [ -mount-options-separated-by-comma ] location
# For details of the format look at autofs(5).<co id="co.autofs.manpage"/>
#
#/misc  /etc/auto.misc<co id="co.autofs.map"/>
#/net -hosts
#
# Include /etc/auto.master.d/*.autofs<co id="co.autofs.include"/>
#
#+dir:/etc/auto.master.d
#
# Include central master map if it can be found using
# nsswitch sources.
#
# Note that if there are entries for /net or /misc (as
# above) in the included master map any keys that are the
# same will not be seen as the first read key seen takes
# precedence.
#
+auto.master<co id="co.autofs.plus"/></screen>
   <calloutlist>
    <callout arearefs="co.autofs.manpage">
     <para>
      Auf der man-Seite zu <systemitem>autofs</systemitem> (<command>man 5 autofs</command>) finden Sie viele nützliche Informationen zum Format der Automounter-Zuordnungen.
     </para>
    </callout>
    <callout arearefs="co.autofs.map">
     <para>
      Diese einfache Syntax für die Automounter-Zuordnung ist standardmäßig auskommentiert (#), liefert jedoch ein gutes Beispiel.
     </para>
    </callout>
    <callout arearefs="co.autofs.include">
     <para>
      Falls die Master-Zuordnung in mehrere Dateien aufgeteilt werden muss, heben Sie die Auskommentierung der Zeile auf und platzieren Sie die Zuordnungen (mit dem Suffix <literal>.autofs</literal>) im Verzeichnis <filename>/etc/auto.master.d/</filename>.
     </para>
    </callout>
    <callout arearefs="co.autofs.plus">
     <para>
      <literal>+auto.master</literal> sorgt dafür, dass die richtige Master-Zuordnung auch bei Verwendung von NIS<phrase os="sles"> problemlos auffindbar ist (weitere Informationen zu NIS siehe <xref linkend="sec.nis.server"/>)</phrase>.
     </para>
    </callout>
   </calloutlist>
   <para>
    Die Einträge in <filename>auto.master</filename> enthalten drei Felder mit der folgenden Syntax:
   </para>
<screen>mount point      map name      options</screen>
   <variablelist>
    <varlistentry>
     <term>Einhängepunkt</term>
     <listitem>
      <para>
       Basisspeicherort, an dem das <systemitem>autofs</systemitem>-Dateisystem angehängt wird, z. B. <literal>/home</literal>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Zuordnungsname</term>
     <listitem>
      <para>
       Name einer Zuordnungsquelle für das Einhängen. Weitere Informationen zur Syntax der Zuordnungsdateien finden Sie in <xref linkend="autofs.mapfiles"/>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Optionen</term>
     <listitem>
      <para>
       Diese Optionen (sofern angegeben) werden als Standardeinstellungen für alle Einträge in der Zuordnung angewendet.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <tip>
    <para>
     Weitere Informationen zu den einzelnen Werten für die optionalen Angaben <literal>map-type</literal> (Zuordnungstyp), <literal>format</literal> (Format) und <literal>options</literal> (Optionen) finden Sie auf der man-Seite zu <guimenu>auto.master</guimenu> (<command>man 5 auto.master</command>).
    </para>
   </tip>
   <para>
    Der folgende Eintrag in <filename>auto.master</filename> weist <systemitem>autofs</systemitem> an, in <filename>/etc/auto.smb</filename> nachzuschlagen und Einhängepunkte im Verzeichnis <filename>/smb</filename> zu erstellen.
   </para>
<screen>/smb   /etc/auto.smb</screen>
   <sect3 id="autofs.directmount">
    <title>Direktes Einhängen</title>
    <para>
     Beim direkten Einhängen wird ein Einhängepunkt im Pfad erstellt, der in der entsprechenden Zuordnungsdatei angegeben ist. Geben Sie in <filename>auto.master</filename> nicht den Einhängepunkt an, sondern ersetzen Sie den Eintrag im Feld für den Einhängepunkt durch <literal>/-</literal>. Die folgende Zeile weist <systemitem>autofs</systemitem> beispielsweise an, einen Einhängepunkt im Pfad zu erstellen, der in <filename>auto.smb</filename> angegeben ist:
    </para>
<screen>/-        /etc/auto.smb</screen>
    <tip>
     <title>Zuordnungen ohne vollständigen Pfad</title>
     <para>
      Wenn die Zuordnungsdatei nicht mit dem vollständigen lokalen Pfad oder Netzwerkpfad angegeben ist, wird die Datei über die NSS-Konfiguration (Name Service Switch) ermittelt:
     </para>
<screen>/-        auto.smb</screen>
    </tip>
   </sect3>
  </sect2>

  <sect2 id="autofs.mapfiles">
   <title>Zuordnungsdateien</title>
   <important>
    <title>Andere Zuordnungstypen</title>
    <para>
     <emphasis>Dateien</emphasis> sind der häufigste Zuordnungstyp für das automatische Einhängen mit <systemitem>autofs</systemitem>, es gibt jedoch noch weitere Typen. Eine Zuordnungsspezifikation kann beispielsweise die Ausgabe eines Kommandos oder auch das Ergebnis einer LDAP- oder Datenbankabfrage sein. Weitere Informationen zu Zuordnungstypen finden Sie auf der man-Seite <command>man 5 auto.master</command>.
    </para>
   </important>
   <para>
    Zuordnungsdateien bestimmen den Speicherort der Quelle (lokal oder im Netzwerk) sowie den Einhängepunkt, an dem die Quelle lokal eingehängt werden soll. Für die Zuordnungen gilt ein ähnliches allgemeines Format wie für die Master-Zuordnung. Der Unterschied ist, dass die <emphasis>Optionen</emphasis> zwischen dem Einhängepunkt und dem Speicherort angegeben sind, also nicht am Ende des Eintrags:
   </para>
<screen>mount point      options      location</screen>
   <variablelist>
    <varlistentry>
     <term>Einhängepunkt</term>
     <listitem>
      <para>
       Gibt an, wo der Quellspeicherort eingehängt werden soll. Dies kann entweder der Name eines einzelnen Verzeichnisses sein (<emphasis>indirektes</emphasis> Einhängen), das dem in <filename>auto.master</filename> angegebenem Basiseinhängepunkt hinzugefügt werden soll, oder der vollständige Pfad des Einhängepunkts (direktes Einhängen, siehe <xref linkend="autofs.directmount"/>).
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Optionen</term>
     <listitem>
      <para>
       Zeigt eine optionale, durch Kommas getrennte Liste der Einhängeoptionen für die entsprechenden Einträge an. Wenn <filename>auto.master</filename> ebenfalls Optionen für diese Zuordnungsdatei enthält, werden diese Optionen an das Ende der Liste angehängt.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>location</term>
     <listitem>
      <para>
       Gibt den Pfad an, von dem aus das Dateisystem eingehängt werden soll. Dies ist in der Regel ein NFS- oder SMB-Volume mit dem üblichen Format <literal>Hostname:Pfadname</literal>. Wenn das einzuhängende Dateisystem mit einem Schrägstrich (/) beginnt (z. B. lokale <filename>/dev</filename>-Einträge oder smbfs-Freigaben), muss ein Doppelpunkt (:) vorangestellt werden, z. B. <literal>:/dev/sda1</literal>.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>
 </sect1>
 <sect1 id="sec.autofs.debugging">
  <title>Funktionsweise und Fehlersuche</title>

  <para>
   In diesem Abschnitt wird erläutert, wie Sie die Funktionsweise des <systemitem>autofs</systemitem>-Dienstes steuern und weitere Fehlersuchinformationen durch zusätzliche Einstellungen für die Automounter-Funktionsweise abrufen.
  </para>

  <sect2 id="sec.autofs.debugging.service">
   <title>Steuern des <systemitem>autofs</systemitem>-Dienstes</title>
   <para>
    Die Funktionsweise des <systemitem>autofs</systemitem>-Dienstes wird mit dem Kommando <systemitem class="daemon">systemd</systemitem> gesteuert. Die allgemeine Syntax für das Kommando <command>systemctl</command> für <systemitem>autofs</systemitem> lautet
   </para>
<screen>sudo systemctl <replaceable>sub-command</replaceable> autofs.service</screen>
   <para>
    wobei <replaceable>sub-command</replaceable> einen der folgenden Werte annehmen kann:
   </para>
   <variablelist>
    <varlistentry>
     <term>Aktivieren</term>
     <listitem>
      <para>
       Startet den Automounter-Daemon beim Booten.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>start</term>
     <listitem>
      <para>
       Startet den Automounter-Daemon.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>stop</term>
     <listitem>
      <para>
       Stoppt den Automounter-Daemon. Automatische Einhängepunkte sind nicht verfügbar.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>status</term>
     <listitem>
      <para>
       Gibt den aktuellen Status des <systemitem>autofs</systemitem>-Dienstes zusammen mit einem Teil einer zugehörigen Protokolldatei aus.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>restart</term>
     <listitem>
      <para>
       Stoppt und startet den Automounter, wobei alle laufenden Daemons beendet und neue Daemons gestartet werden.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>reload</term>
     <listitem>
      <para>
       Prüft die aktuelle <filename>auto.master</filename>-Zuordnung, startet die Daemons neu, deren Einträge geändert wurden, und startet neue Daemons für neue Einträge.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 id="sec.autofs.debugging.problems">
   <title>Fehlersuche bei Automounter-Problemen</title>
   <para>
    Falls Probleme beim Einhängen von Verzeichnissen mit <systemitem>autofs</systemitem> auftreten, führen Sie den <command>automount</command>-Daemon manuell aus und beachten Sie die Ausgabemeldungen:
   </para>
   <procedure>
    <step performance="required">
     <para>
      Stoppen Sie <systemitem>autofs</systemitem>.
     </para>
<screen>sudo systemctl stop autofs.service</screen>
    </step>
    <step performance="required">
     <para>
      Führen Sie <command>automount</command> auf einem Terminal manuell im Vordergrund aus und aktivieren Sie die ausführliche Ausgabe.
     </para>
<screen>sudo automount -f -v</screen>
    </step>
    <step performance="required">
     <para>
      Greifen Sie auf einem anderen Terminal auf die Einhängepunkte zu (z. B. <command>cd</command> oder <command>ls</command>) und versuchen Sie, die automatisch einzuhängenden Dateisysteme einhängen zu lassen.
     </para>
    </step>
    <step performance="required">
     <para>
      Ermitteln Sie anhand der Ausgabe von <command>automount</command> auf dem ersten Terminal, warum das Einhängen fehlgeschlagen ist oder gar nicht erst versucht wurde.
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 id="sec.autofs.nfs">
  <title>Automatisches Einhängen als NFS-Freigabe</title>

  <para>
   Das nachfolgende Verfahren zeigt, wie Sie <systemitem>autofs</systemitem> für das automatische Einhängen einer NFS-Freigabe konfigurieren, die sich im Netzwerk befindet. Hierbei werden die oben aufgeführten Informationen verwendet und es wird vorausgesetzt, dass Sie mit NFS-Exporten vertraut sind. Weitere Informationen zu NFS finden Sie in <xref linkend="cha.nfs"/>.
  </para>

  <procedure>
   <step performance="required">
    <para>
     Bearbeiten Sie die Master-Zuordnungsdatei <filename>/etc/auto.master</filename>:
    </para>
<screen>sudo vim /etc/auto.master</screen>
    <para>
     Fügen Sie einen neuen Eintrag für den neuen NFS-Einhängepunkt am Ende von <filename>/etc/auto.master</filename> an:
    </para>
<screen>/nfs      /etc/auto.nfs      --timeout=10</screen>
    <para>
     Hiermit erhält <systemitem>autofs</systemitem> die folgenden Informationen: Der Basiseinhängepunkt lautet <filename>/nfs</filename>, die NFS-Freigaben sind in der Zuordnung <filename>/etc/auto.nfs</filename> angegeben und alle Freigaben in dieser Zuordnung werden nach 10 Sekunden Inaktivität automatisch ausgehängt.
    </para>
   </step>
   <step performance="required">
    <para>
     Erstellen Sie eine neue Zuordnungsdatei für NFS-Freigaben:
    </para>
<screen>sudo vim /etc/auto.nfs</screen>
    <para>
     <filename>/etc/auto.nfs</filename> enthält in der Regel je eine separate Zeile pro NFS-Freigabe. Das Format wird in <xref linkend="autofs.mapfiles"/> beschrieben. Fügen Sie die Zeile ein, in der der Einhängepunkt und die Netzwerkadresse der NFS-Freigabe aufgeführt sind:
    </para>
<screen>export      jupiter.com:/home/geeko/doc/export</screen>
    <para>
     Mit der obigen Zeile wird das Verzeichnis <filename>/home/geeko/doc/export</filename> auf dem Host <literal>jupiter.com</literal> bei Bedarf automatisch in das Verzeichnis <filename>/nfs/export</filename> auf dem lokalen Host eingehängt (<filename>/nfs</filename> wird aus der <filename>auto.master</filename>-Zuordnung entnommen). Das Verzeichnis <filename>/nfs/export</filename> wird automatisch durch <systemitem>autofs</systemitem> angelegt.
    </para>
   </step>
   <step performance="required">
    <para>
     Falls Sie dieselbe NFS-Freigabe bereits statisch eingehängt haben, kommentieren Sie optional die zugehörige Zeile in <filename>/etc/fstab</filename> aus. Ein Beispiel für diese Zeile:
    </para>
<screen>#jupiter.com:/home/geeko/doc/export /nfs/export nfs defaults 0 0</screen>
   </step>
   <step performance="required">
    <para>
     Laden Sie <systemitem>autofs</systemitem> neu und prüfen Sie die Funktionsweise:
    </para>
<screen>sudo systemctl restart autofs.service</screen>
<screen># ls -l /nfs/export
total 20
drwxr-xr-x  6 1001 users 4096 Oct 25 08:56 ./
drwxr-xr-x  3 root root     0 Apr  1 09:47 ../
drwxr-xr-x  5 1001 users 4096 Jan 14  2013 .images/
drwxr-xr-x 10 1001 users 4096 Aug 16  2013 .profiled/
drwxr-xr-x  3 1001 users 4096 Aug 30  2013 .tmp/
drwxr-xr-x  4 1001 users 4096 Oct 25 08:56 SLE-12-manual/</screen>
    <para>
     Wenn die Liste der Dateien auf der entfernten Freigabe angezeigt wird, funktioniert <systemitem>autofs</systemitem> einwandfrei.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 id="sec.autofs.advanced">
  <title>Weitere Themen</title>

  <para>
   Dieser Abschnitt befasst sich mit Themen, die über die grundlegende Einführung in <systemitem>autofs</systemitem> hinausgehen: automatisches Einhängen von NFS-Freigaben, die sich im Netzwerk befinden, Verwenden von Platzhalterzeichen in Zuordnungsdateien sowie spezielle Informationen für das CIFS-Dateisystem.
  </para>

  <sect2 id="sec.autofs.advanced.net">
   <title><filename>/net</filename>-Einhängepunkt</title>
   <para>
    Dieser Helper-Einhängepunkt ist nützlich, wenn zahlreiche NFS-Freigaben vorhanden sind. Mit <filename>/net</filename> werden bei Bedarf alle NFS-Freigaben im lokalen Netzwerk automatisch eingehängt. Dieser Eintrag ist in der <filename>auto.master</filename>-Datei bereits vorhanden. Kommentieren Sie diesen Eintrag aus und starten Sie <systemitem>autofs</systemitem> neu:
   </para>
<screen>/net      -hosts</screen>
<screen>systemctl restart autofs.service</screen>
   <para>
    Wenn Sie beispielsweise einen Server mit dem Namen <literal>jupiter</literal> nutzen, auf dem sich eine NFS-Freigabe mit dem Namen <filename>/export</filename> befindet, hängen Sie es mit folgendem Kommando
   </para>
<screen># cd /net/jupiter/export</screen>
   <para>
    an der Befehlszeile ein.
   </para>
  </sect2>

  <sect2 id="sec.autofs.advanced.wildcards">
   <title>Verwenden von Platzhalterzeichen beim automatischen Einhängen von Unterverzeichnissen</title>
   <para>
    Wenn ein Verzeichnis mit Unterverzeichnissen vorliegt, die einzeln automatisch eingehängt werden sollen – beispielsweise das Verzeichnis <filename>/home</filename> mit den Benutzerverzeichnissen der verschiedenen Benutzer –, dann bietet <systemitem>autofs</systemitem> eine praktische Lösung.
   </para>
   <para>
    Für Benutzerverzeichnisse fügen Sie die folgende Zeile in <filename>auto.master</filename> ein:
   </para>
<screen>/home      /etc/auto.home</screen>
   <para>
    Ergänzen Sie nun die Datei <filename>/etc/auto.home</filename> mit der richtigen Zuordnung, so dass die Benutzerverzeichnisse der einzelnen Benutzer automatisch eingehängt werden. Erstellen Sie beispielsweise separate Einträge für die Verzeichnisse:
   </para>
<screen>wilber      jupiter.com:/home/wilber
penguin      jupiter.com:/home/penguin
tux      jupiter.com:/home/tux
[...]</screen>
   <para>
    Dies ist äußerst umständlich, da Sie die Liste der Benutzer in <filename>auto.home</filename> verwalten müssen. Statt des Einhängepunkts können Sie ein Sternchen (*) angeben und statt des einzuhängenden Verzeichnisses das Und-Zeichen (&amp;):
   </para>
<screen>*      jupiter:/home/&amp;</screen>
  </sect2>

  <sect2 id="sec.autofs.advanced.cifs">
   <title>Automatisches Einhängen des CIFS-Dateisystems</title>
   <para>
    Soll eine SMB/CIFS-Freigabe automatisch eingehängt werden (weitere Informationen zum SMB/CIFS-Protokoll siehe <xref linkend="cha.samba"/>), müssen Sie die Syntax der Zuordnungsdatei bearbeiten. Fügen Sie <option>-fstype=cifs</option> in das Optionsfeld ein und stellen Sie dem Speicherort der Freigabe einen Doppelpunkt (:) voran.
   </para>
<screen>mount point      -fstype=cifs      ://jupiter.com/export</screen>
  </sect2>
 </sect1>
</chapter>
