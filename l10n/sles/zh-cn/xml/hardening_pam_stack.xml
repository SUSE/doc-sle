<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook50-profile.xsl"
 type="text/xml"
 title="Profiling step"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="hardening_pam_stack.xml" version="5.0" xml:id="sec-sec-prot-general-pam">
 <info>
  <title>使用 PAM 进行口令和登录管理</title>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
    <para>
     Linux-PAM（适用于 Linux 的可插入身份验证模块）是一组共享库，可让本地系统管理员选择应用程序该如何对用户进行身份验证。
    </para>

    <para>
     强烈建议您熟悉 PAM 的功能以及如何利用此体系结构为某个环境提供最佳身份验证设置。您可以完成此配置一次并在所有系统中实施此配置（标准），也可以针对各个主机进行增强（增强安全性 — 按主机/服务/应用程序进行增强）。重点了解该体系结构的灵活性。
    </para>

    <para>
     要了解有关 PAM 体系结构的详细信息，请参见 <filename>/usr/share/doc/packages/pam</filename> 目录中的 PAM 文档（提供多种格式）。
    </para>

    <para>
     下面讨论的是如何修改默认 PAM 堆栈的示例（特别是围绕口令政策展开），例如口令强度、口令重复使用和帐户锁定。虽然只涉及了少数几种可能性，但它们是一个良好的开端，向您展示了 PAM 的灵活性。
    </para>
    <important>
        <title><command>pam-config</command> 限制</title>
        <para>
            <command>pam-config</command> 工具可用于配置包含全局选项的 common-{account,auth,password,session} PAM 配置文件。这些文件包含以下注释：
        </para>
        <screen># This file is autogenerated by pam-config. All changes
# will be overwritten.</screen>
        <para>
            个别服务文件（例如 <filename>login、password、sshd</filename> 和 <filename>su</filename>）必须直接编辑。您可以选择直接编辑所有文件，而不使用 <command>pam-config</command>，虽然 <command>pam-config</command> 包含转换较旧配置、更新当前配置和健全性检查等有用功能。有关详细信息，请参见 <command>man 8 pam-config</command>。
        </para>
    </important>

    <sect2 xml:id="sec-sec-prot-general-pam-pw-strength">
     <title>口令强度</title>
     <para>
      <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 可利用 <systemitem class="library">pam_cracklib</systemitem> 库测试弱口令，并在确定口令明显较弱时建议使用较强的口令。以下参数示例可能属于公司口令策略的一部分，或者由于审计约束而需要的某些设置。
     </para>
     <para>
      PAM 库遵循定义的流程。通常，设计完美堆栈的最佳方式是考虑所有要求和策略并绘制流程图。
     </para>
     <table>
      <title>口令强制执行的示例规则/约束</title>
      <tgroup cols="3">
       <tbody>
        <row>
         <entry>
          <para>
           <systemitem class="library">pam_cracklib.so</systemitem>
          </para>
         </entry>
         <entry>
          <para>
           <literal>minlen=8</literal>
          </para>
         </entry>
         <entry>
          <para>
           口令的最小长度为 8
          </para>
         </entry>
        </row>
        <row>
         <entry>
          <para>
           <systemitem class="library">pam_cracklib.so</systemitem>
          </para>
         </entry>
         <entry>
          <para>
           <literal>lcredit=-1</literal>
          </para>
         </entry>
         <entry>
          <para>
           小写字母的最少数量为 1
          </para>
         </entry>
        </row>
        <row>
         <entry>
          <para>
           <systemitem class="library">pam_cracklib.so</systemitem>
          </para>
         </entry>
         <entry>
          <para>
           <literal>ucredit=-1</literal>
          </para>
         </entry>
         <entry>
          <para>
           大写字母的最少数量为 1
          </para>
         </entry>
        </row>
        <row>
         <entry>
          <para>
           <systemitem class="library">pam_cracklib.so</systemitem>
          </para>
         </entry>
         <entry>
          <para>
           <literal>dcredit=-1</literal>
          </para>
         </entry>
         <entry>
          <para>
           数字的最少数量为 1
          </para>
         </entry>
        </row>
        <row>
         <entry>
          <para>
           <systemitem class="library">pam_cracklib.so</systemitem>
          </para>
         </entry>
         <entry>
          <para>
           <literal>ocredit=-1</literal>
          </para>
         </entry>
         <entry>
          <para>
           其他字符的最少数量为 1
          </para>
         </entry>
        </row>
       </tbody>
      </tgroup>
     </table>
     <para>
      要设置这些口令限制，请使用 <command>pam-config</command> 工具指定您要配置的参数。例如，可使用如下命令修改最小长度参数：
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> pam-config -a --cracklib-minlen=8 --cracklib-retry=3 \
--cracklib-lcredit=-1 --cracklib-ucredit=-1 --cracklib-dcredit=-1 \
--cracklib-ocredit=-1 --cracklib</screen>
     <para>
      现在校验新口令限制是否适用于新口令。登录非 root 帐户并使用 <command>passwd</command> 命令更改口令。请注意，如果您在 root 下运行 <command>passwd</command> 命令，则不会强制执行上述要求。
     </para>
    </sect2>

    <sect2 xml:id="sec-sec-prot-general-pam-pw-previous">
     <title>限制使用先前的口令</title>
     <para>
      pam_pwhistory 模块可用于配置无法重复使用的先前口令数量。以下命令可在系统上实施口令限制，如此至少六个月内无法重复使用某个口令。
     </para>
     <screen><prompt>&gt; </prompt><command>sudo</command> pam-config -a --pwhistory --pwhistory-remember=26</screen>
     <para>
      回想一下，在<xref linkend="sec-sec-prot-general-pw-aging"/>中我们将 <literal>PASS_MIN_DAYS</literal> 设置为 <literal>7</literal>，该选项指定了两次口令更改之间的最少天数。因此，如果 <systemitem>pam_unix</systemitem> 配置为记住 <literal>26</literal> 个口令，则至少六个月（26*7 天）内无法重复使用先前曾使用过的口令。
     </para>
     <para>
      <command>pam-config</command> 命令生成的 PAM 配置 (<filename>/etc/pam.d/common-auth</filename>) 如下所示：
     </para>
     <screen>auth      required   pam_env.so
auth      required   pam_unix.so     try_first_pass
account   required   pam_unix.so     try_first_pass
password  requisit   pam_cracklib.so
password  required   pam_pwhistory.so        remember=26
password  optional   pam_gnome_keyring.so    use_authtok
password  required   pam_unix.so     use_authtok nullok shadow try_first_pass
session   required   pam_limits.so
session   required   pam_unix.so     try_first_pass
session   optional   pam_umask.so</screen>
    </sect2>

    <sect2 xml:id="sec-sec-prot-general-pam-lock-accounts">
     <title>登录失败次数太多后锁定用户帐户</title>
     <para>
      在到达所定义的 ssh、login、su 或 sudo 失败尝试次数后锁定帐户是一种常见的安全做法。但如果应用程序、管理员或 <systemitem class="username">root</systemitem> 用户被锁定，则可能会导致服务中断。
     </para>
     <important>
      <title>拒绝服务攻击</title>
      <para>
       攻击者可能会通过故意造成登录失败，轻易地滥用口令失败计数来发起拒绝服务攻击。
      </para>
      <para>
       请仅在必要时才使用口令失败计数。将锁定限制在必要的最小范围，且不要锁定关键帐户。请记住，锁定不仅会应用于人类用户，而且还会应用于用来提供服务的系统帐户。
      </para>
     </important>
     <para>
      <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 默认不会锁定帐户，而是提供 PAM 模块 <command>pam_tally2</command> 来方便实现口令失败计数。将以下行添加到 <filename>/etc/pam.d/login</filename> 的最前面可在六次登录失败之后锁定所有用户（<systemitem class="username">root</systemitem> 除外），并在十分钟后自动解锁帐户：
     </para>
<screen>auth required pam_tally2.so deny=6 unlock_time=600</screen>
     <para>
         下面是一个完整的 <filename>/etc/pam.d/login</filename> 文件示例：
     </para>
<screen>#%PAM-1.0
auth     requisite      pam_nologin.so
auth     include        common-auth
auth     required       pam_tally2.so deny=6 unlock_time=600
account  include        common-account
account  required       pam_tally2.so
password include        common-password
session  required       pam_loginuid.so
session  include        common-session
#session  optional       pam_lastlog.so nowtmp showfailed
session  optional       pam_mail.so standard</screen>
     <para>
      您也可以锁定 <systemitem class="username">root</systemitem>，不过显然您必须非常确定要执行此操作：
     </para>
<screen>auth required pam_tally2.so deny=6 even_deny_root unlock_time=600</screen>
     <para>
      您可以为 root 用户定义不同的锁定时间：
     </para>
     <screen>auth required pam_tally2.so deny=6 root_unlock_time=120  unlock_time=600</screen>
    <para>
     如果您希望必须由管理员来解锁帐户，请不要使用 <literal>unlock_time</literal> 选项。下面两个示例命令显示失败的登录尝试次数以及如何锁定用户帐户：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>pam_tally2 -u <replaceable>username</replaceable></command>
Login           Failures Latest failure     From
username            6    12/17/19 13:49:43  pts/1

<prompt>&gt; </prompt><command>sudo</command> <command>pam_tally2 -r -u <replaceable>username</replaceable></command></screen>

     <para>
      尝试访问的默认位置记录在 <filename>/var/log/tallylog</filename> 中。
     </para>
     <para>
      如果用户在登录超时失效后或在管理员重设置其帐户之后成功登录，计数器将重设置为 0。
     </para>
     <para>
      配置其他登录服务，以在 <filename>/etc/pam.d/</filename> 下其各自的配置文件中使用 <command>pam_tally2</command>：<filename>sshd、su、sudo、sudo-i</filename> 和 <filename>su-l</filename>。
     </para>
 </sect2>
</sect1>
