<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_samba.xml" version="5.0" xml:id="cha-samba">
 <title>Samba</title>
 <info>
  <abstract>
   <para>
    Sambaを使用すると、macOS、Windows、OS/2マシンに対するファイルサーバおよびプリントサーバをUnixマシン上に構築できます。Sambaは、今や成熟の域に達したかなり複雑な製品です。YaSTで、または環境設定ファイルを手動で編集することで、Sambaを設定します。
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <important>
  <title>SMB1は無効になる</title>
  <para>
   Sambaバージョン4.17以降、SMB1プロトコルはSLEで無効になり、サポートされなくなります。
  </para>
 </important>
 <sect1 xml:id="sec-samba-term">
  <title>用語集</title>

  <para>
   ここでは、SambaのマニュアルやYaSTモジュールで使用される用語について説明します。
  </para>

  <variablelist>
   <varlistentry>
    <term>SMBプロトコル</term>
    <listitem>
     <para>
      SambaはSMB(サーバメッセージブロック)プロトコルを使用します。SMBは<phrase role="productname">NetBIOS</phrase>サービスを基にしています。Microsoftは、他のメーカーのソフトウェアがMicrosoftオペレーティングシステムを実行しているサーバへの接続を確立できるように、このプロトコルをリリースしました。SambaはTCP/IPプロトコルの上にSMBプロトコルを実装します。つまり、TCP/IPをすべてのクライアントにインストールして有効にする必要があります。
     </para>
     <tip arch="zseries" os="sles">
      <title>IBM Z: NetBIOSのサポート</title>
      <para>
       IBM ZではSMB over TCP/IPのみがサポートされています。これら2つのシステムではNetBIOSをサポートしていません。
      </para>
     </tip>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>CIFSプロトコル</term>
    <listitem>
     <para>
      CIFS (Common Internet File System)プロトコルは、SMB1とも呼ばれるSMBプロトコルの初期バージョンです。CIFSはTCP/IP上で使用する標準のリモートファイルシステムで、ユーザグループによる共同作業およびインターネット間でのドキュメントの共有ができるようにします。
     </para>
     <para>
      SMB1はSMB2に置き換えられ、Microsoft Windows Vista™の一部として最初にリリースされました。これは、Microsoft Windows 8™およびMicrosoft Windows Server 2012ではSMB3で置き換えられました。最新バージョンのSambaでは、セキュリティ上の理由によりデフォルトでSMB1は無効になっています。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NetBIOS</term>
    <listitem>
     <para>
      <phrase role="productname">NetBIOS</phrase>は、ネットワーク上のコンピュータ間の名前解決と通信のために設計されたソフトウェアインタフェース(API)です。これにより、ネットワークに接続されたマシンが、それ自体の名前を維持できます。予約を行えば、これらのマシンを名前によって指定できます。名前を確認する一元的なプロセスはありません。ネットワーク上のマシンでは、すでに使用済みの名前でない限り、名前をいくつでも予約できます。NetBIOSはさまざまなネットワークプロトコルの上に実装できます。比較的単純でルーティング不可能な実装の1つは、<phrase role="productname">NetBEUI</phrase>と呼ばれます(これはNetBIOS APIと混同されることが多くあります)。NetBIOSは、Novell IPX/SPXプロトコルの上でもサポートされています。バージョン3.2以降、SambaはIPv4とIPv6の両方でNetBIOSをサポートしています。
     </para>
     <para>
      TCP/IP経由で送信されたNetBIOS名は、<filename>/etc/hosts</filename>で使用されている名前、またはDNSで定義された名前とまったく共通点がありません。NetBIOSは独自の、完全に独立した名前付け規則を使用しています。しかし、管理を容易にするために、またはDNSをネイティブで使用するために、DNSホスト名に対応する名前を使用することをお勧めします。これはSambaが使用するデフォルトでもあります。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Sambaサーバ</term>
    <listitem>
     <para>
      Sambaサーバは、SMB/CIFSサービスおよびNetBIOS over IPネーミングサービスをクライアントに提供します。Linuxの場合、3種類のSambaサーバデーモン(SMB/CIFSサービス用<literal>smbd</literal>、ネーミングサービス用<literal>nmbd</literal>、認証用<literal>winbind</literal>)が用意されています。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Sambaクライアント</term>
    <listitem>
     <para>
      Sambaクライアントは、SMBプロトコルを介してSambaサーバからSambaサービスを使用するシステムです。WindowsやmacOSなどの一般的なオペレーティングシステムは、SMBプロトコルをサポートしています。TCP/IPプロトコルは、すべてのコンピュータにインストールする必要があります。Sambaは、異なるUNIXフレーバーに対してクライアントを提供します。Linuxでは、SMB用のカーネルモジュールがあり、LinuxシステムレベルでのSMBリソースの統合が可能です。Sambaクライアントに対していずれのデーモンも実行する必要はありません。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>共有</term>
    <listitem>
     <para>
      SMBサーバは、そのクライアントに対し、「共有」によってリソースを提供します。<emphasis></emphasis>共有はサーバ上のディレクトリ(サブディレクトリを含む)とプリンタです。共有は「共有名」を使用してエクスポートされ、この名前でアクセスできます。<emphasis></emphasis>共有名にはどのような名前も設定できます。エクスポートディレクトリの名前である必要はありません。共有プリンタにも名前が割り当てられています。クライアントは名前で共有ディレクトリとプリンタにアクセスできます。
     </para>
     <para>
      慣例により、ドル記号(<literal>$</literal>)で終わる共有名は非表示になります。つまり、Windowsコンピュータを使用して使用可能な共有を参照している場合、共有は表示されません。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>DC</term>
    <listitem>
     <para>
      ドメインコントローラ(DC)は、ドメインのアカウントを処理するサーバです。データレプリケーションの場合、単一ドメインに複数のドメインコントローラを含めることができます。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 
 <sect1 xml:id="sec-samba-install" os="sles;osuse">
  <title>Sambaサーバのインストール</title>

  <para>
   Sambaサーバをインストールするには、YaSTを起動して、<menuchoice><guimenu>ソフトウェア</guimenu> <guimenu>ソフトウェア管理</guimenu></menuchoice>の順に選択します。<menuchoice><guimenu>表示</guimenu> <guimenu>パターン</guimenu></menuchoice>の順に選択し、<guimenu>ファイルサーバ</guimenu>を選択します。必要なパッケージのインストールを確認して、インストールプロセスを完了します。
  </para>
 </sect1>
 <sect1 xml:id="sec-samba-serv-start" os="sles;osuse">
  <title>Sambaの起動および停止</title>

  <para>
   Sambaサーバは、自動(ブート中)か手動で起動または停止できます。ポリシーの開始および停止は、<xref linkend="sec-samba-yast2-conf"/>で説明しているように、YaST Sambaサーバ設定の一部です。
  </para>

  <para>
   コマンドラインで、「<command>systemctl stop smb nmb</command>」と入力して、Sambaに必要なサービスを停止し、「<command>systemctl start nmb smb</command>」と入力して起動します。<literal>smb</literal>サービスは、必要に応じて<literal>winbind</literal>を処理します。
  </para>

  <tip>
   <title><systemitem>winbind</systemitem></title>
   <para>
    <systemitem>winbind</systemitem>は、独立したサービスであり、個別の<systemitem>samba-winbind</systemitem>パッケージとしても提供されます。
   </para>
  </tip>
 </sect1>
 <sect1 xml:id="sec-samba-serv-inst" os="sles;osuse">
  <title>Sambaサーバの設定</title>

  <para>
   <phrase role="productname"><phrase os="sles">SUSE® Linux Enterprise Server</phrase></phrase>のSambaサーバは、YaSTを使って、または手動で設定することができます。手動で設定を行えば細かい点まで調整できますが、YaSTのGUIほど便利ではありません。
  </para>

  <sect2 xml:id="sec-samba-yast2-conf">
   <title>YaSTによるSambaサーバの設定</title>
   <para>
    Sambaサーバを設定するには、YaSTを起動して、<menuchoice><guimenu>ネットワークサービス</guimenu><guimenu>Sambaサーバ</guimenu></menuchoice>の順に選択します。
   </para>
   <sect3 xml:id="sec-samba-yast2-conf-inst">
    <title>初期Samba設定</title>
    <para>
     このモジュールを初めて起動すると、<guimenu>Sambaインストール</guimenu>ダイアログが起動して、サーバ管理に関していくつかの基本的な事項を決定するように要求されます。設定の最後に、Samba管理者パスワードを要求されます(<guimenu>Sambaルートパスワード</guimenu>)。次回起動時には、<guimenu>Samba Configuration</guimenu>ダイアログが表示されます。
    </para>
    <para>
     <guimenu>Sambaインストール</guimenu>ダイアログは、次の2つのステップとオプションの詳細設定で構成されています。
    </para>
    <variablelist>
     <varlistentry>
      <term>ワークグループまたはドメイン名</term>
      <listitem>
       <para>
        <guimenu>Workgroup or Domain Name</guimenu>から既存の名前を選択するか、新しい名前を入力し、<guimenu>次へ</guimenu>を入力します。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Sambaサーバのタイプ</term>
      <listitem>
       <para>
        次のステップでは、サーバをPDC(プライマリドメインコントローラ)として機能させるか、BDC(バックアップドメインコントローラ)として機能させるか、またはドメインコントローラとしては機能させないかを指定します。<guimenu>次へ</guimenu>で続行します。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     詳細なサーバ設定に進まない場合は、<guimenu>OK</guimenu>を選択して確認します。次に、最後のポップアップボックスで、<guimenu>Sambaルートパスワード</guimenu>を設定します。
    </para>
    <para>
     この設定はすべて、後から<guimenu>Sambaの設定</guimenu>ダイアログで<guimenu>起動</guimenu>、<guimenu>共有</guimenu>、<guimenu>識別情報</guimenu>、<guimenu>信頼されたドメイン</guimenu>、<guimenu>LDAP設定</guimenu>の各タブを使用して変更することができます。
    </para>
   </sect3>
   <sect3 xml:id="sec-samba-server-new-protocol">
    <title>サーバ上でSMBプロトコルの現在のバージョンを有効にする</title>
    <para>
     現在のバージョンの<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>または他の最新のLinuxバージョンを実行しているクライアントで、安全ではないSMB1/CIFSプロトコルはデフォルトで無効になっています。ただし、Sambaの既存のインスタンスはSMB1/CIFSバージョンのプロトコルを使用する共有にのみサービスを提供するように設定できます。このようなクライアントとやり取りするためには、少なくともSMB 2.1プロトコルを使用して共有にサービスを提供するようにSambaを設定する必要があります。
    </para>
    <para>
     たとえば、SMB1/CIFSのUnix拡張機能に依存する、SMB1のみが使用可能な設定があります。これらの拡張機能は、より新しいバージョンのプロトコルには移植されていません。このような状況にある場合は、設定を変更することを検討するか、<xref linkend="sec-samba-client-old-server"/>を参照してください。
    </para>
    <para>
     これを行うには、設定ファイル<filename>/etc/samba/smb.conf</filename>で、グローバルパラメータ<literal>server max protocol = SMB2_10</literal>を設定します。すべての可能な値のリストについては、<command>man smb.conf</command>を参照してください。
    </para>
   </sect3>
   <sect3 xml:id="sec-samba-yast2-conf-adv">
    <title>Sambaの詳細設定</title>
    <para>
     Sambaサーバモジュールの初回起動中、2つの初期化ステップ(<xref linkend="sec-samba-yast2-conf-inst"/>参照)の直後に<guimenu>Sambaの設定</guimenu>ダイアログが表示されます。ここでは、Sambaサーバの設定を編集することができます。
    </para>
    <para>
     設定を編集し終わったら、<guimenu>OK</guimenu>をクリックして設定を保存します。
    </para>
    <sect4 xml:id="sec-samba-yast2-conf-adv-start">
     <title>サーバを起動する</title>
     <para>
      <guimenu>Start Up</guimenu>タブで、Sambaサーバの起動に関する設定を行います。システムのブート時に毎回サービスが起動されるようにするには、<guimenu>During Boot</guimenu>を選択します。手動起動を有効化するには、<guimenu>Manually</guimenu>を選択します。Sambaサーバの起動の詳細については、<xref linkend="sec-samba-serv-start"/>を参照してください。
     </para>
     <para>
      このタブで、ファイアウォールのポートを開くこともできます。そのためには、<guimenu>Open Port in Firewall</guimenu>を選択します。複数のネットワークインタフェースがある場合は、<guimenu>Firewall Details</guimenu>をクリックし、インタフェースを選択した後、<guimenu>OK</guimenu>をクリックして、Sambaサービス用のネットワークインタフェースを選択します。
     </para>
    </sect4>
    <sect4 xml:id="sec-samba-yast2-conf-adv-shares">
     <title>共有</title>
     <para>
      <guimenu>共有</guimenu>タブで、有効にするSambaの共有を指定します。homesおよびプリンタなど、事前定義済みの共有がいくつかあります。<guimenu>状態の変更</guimenu>を使用して、<guimenu>有効</guimenu>と<guimenu>無効</guimenu>の間で切り替えます。新規の共有を追加するには<guimenu>追加</guimenu>、共有を削除するには<guimenu>削除</guimenu>をクリックします。
     </para>
     <para>
      <guimenu>ユーザにディレクトリの共有を許可する</guimenu>を選択すると、<guimenu>許可するグループ</guimenu>中のグループメンバーに、各自のディレクトリを他のユーザと共有させることができます。たとえば、ローカルの範囲の<systemitem>users</systemitem>、あるいはドメインの範囲では<systemitem>DOMAIN\Users</systemitem>を設定します。また、ユーザにはファイルシステムへのアクセスを許可するパーミッションがあることを確認してください。<guimenu>最大共有数</guimenu>で、共有の最大数を制限することができます。認証なしでユーザ共用へのアクセスを許可するには、<guimenu>ゲストアクセスを許可</guimenu>を有効にします。
     </para>
    </sect4>
    <sect4 xml:id="sec-samba-yast2-conf-adv-identity">
     <title>ID</title>
     <para>
      <guimenu>識別情報</guimenu>タブで、ホストが関連付けられているドメイン(<guimenu>基本設定</guimenu>)と、ネットワークで代替ホスト名を使用するかどうか(<guimenu>NetBIOSホスト名</guimenu>)を指定します。名前解決にMicrosoft Windows Internet Name Service(WINS)を使用することもできます。この場合、<guimenu>Use WINS for Hostname Resolution</guimenu>を有効にし、DHCP経由でWINSサーバを取得(<guimenu>Retrieve WINS server via DHCP</guimenu>を使用)するかどうか決定します。<phrase os="sles;osuse">TDBデータベースではなくLDAPなど、</phrase>エキスパートグローバル設定またはユーザ認証ソースを設定するには、<guimenu>詳細設定</guimenu>をクリックします。
     </para>
    </sect4>
    <sect4 xml:id="sec-samba-yast2-conf-adv-trusted">
     <title>信頼されたドメイン</title>
     <para>
      他のドメインのユーザを、自分のドメインにアクセスさせるには、<guimenu>Trusted Domains</guimenu>タブで適切な設定を行います。新しいドメインを追加するには、<guimenu>追加</guimenu>をクリックします。選択したドメインを削除するには、<guimenu>削除</guimenu>をクリックします。
     </para>
    </sect4>
    <sect4 xml:id="sec-samba-yast2-conf-adv-ldap">
     <title>LDAP設定</title>
     <para>
      <guimenu>LDAP Settings</guimenu>タブでは、認証に使用するLDAPサーバを設定することができます。LDAPサーバへの接続をテストするには、<guimenu>Test Connection</guimenu>をクリックします。エキスパートLDAP設定を設定するか、デフォルト値を使用する場合、<guimenu>詳細な設定</guimenu>をクリックします。
     </para>
     <para>
      LDAP設定に関する詳細については、<xref linkend="cha-security-ldap"/>を参照してください。
     </para>
    </sect4>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-samba-serv-inst-manual">
   <title>サーバの手動設定</title>
   <para>
    Sambaをサーバとして使用する場合は、<systemitem class="resource">samba</systemitem>をインストールします。Sambaの主要設定ファイルは、 <filename>/etc/samba/smb.conf </filename>です。このファイルは2つの論理部分に分けられます。<literal>[global]</literal>セクションには、中心的なグローバル設定が含まれます。次のデフォルトのセクションには、個別のファイルとプリンタ共有が入っています。
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      [homes]
     </para>
    </listitem>
    <listitem>
     <para>
      [プロファイル]
     </para>
    </listitem>
    <listitem>
     <para>
      [users]
     </para>
    </listitem>
    <listitem>
     <para>
      [グループ]
     </para>
    </listitem>
    <listitem>
     <para>
      [プリンタ]
     </para>
    </listitem>
    <listitem>
     <para>
      [印刷$]
     </para>
    </listitem>
   </itemizedlist>
   <para>
    この方法を使用すると、共有のオプションを<literal>[global]</literal>セクションで別々にまたはグローバルに設定することができます。これにより、環境設定ファイルが理解しやすくなります。
   </para>
   <sect3 xml:id="sec-samba-smb-conf-Erlaeuterung">
    <title>グローバルセクション</title>
    <para>
     <literal>[global]</literal>セクションの次のパラメータは、ネットワークの設定に応じた必要条件を満たし、Windows環境で他のマシンがSMBを経由してこのSambaサーバにアクセスできるようにするために変更が必要です。
    </para>
    <remark>ke: Important entries missing?</remark>
    <variablelist>
     <varlistentry>
      <term><literal>workgroup = WORKGROUP</literal></term>
      <listitem>
       <para>
        この行は、Sambaサーバをワークグループに割り当てます。<literal>WORKGROUP</literal>を実際のネットワーク環境にある適切なワークグループに置き換えてください。DNS名がネットワーク内の他のマシンに割り当てられていなければ、SambaサーバがDNS名の下に表示されます。DNS名が使用できない場合は、<literal>netbiosname=<replaceable>MYNAME</replaceable></literal>を使用してサーバ名を設定します。このパラメータに関する詳細については、<systemitem>smb.conf</systemitem>のマニュアルページを参照してください。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>os level = 20</literal></term>
      <listitem>
       <para>
        このパラメータは、SambaサーバがワークグループのLMB(ローカルマスタブラウザ)になるかどうかのきっかけとなります。Sambaサーバの設定が誤っていた場合に、既存のWindowsネットワークに支障が出ないよう、小さな値(たとえば<literal>2</literal>)を選択します。このトピックの詳細については、『Samba 3 Howto』のネットワークブラウジングの章を参照してください。『Samba 3 Howto』の詳細については、<xref linkend="sec-samba-info"/>を参照してください。
       </para>
       <para>
        ネットワーク内に他のSMBサーバ(たとえば、Windows 2000サーバ)が存在せず、ローカル環境に存在するすべてのシステムのリストをSambaサーバに保存する場合は、<literal>os level</literal>の値を大きくします(たとえば、<literal>65</literal>)。これでSambaサーバが、ローカルネットワークのLMBとして選択されました。
       </para>
       <para>
        この設定を変更するときは、それが既存のWindowsネットワーク環境にどう影響するかを慎重に検討する必要があります。はじめに、隔離されたネットワークで、または影響の少ない時間帯に、変更をテストしてください。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>wins support</literal>と<literal>wins server</literal></term>
      <listitem>
       <para>
        アクティブなWINSサーバをもつ既存のWindowsネットワークにSambaサーバを参加させる場合は、<option>wins server</option>オプションを有効にし、その値をWINSサーバのIPアドレスに設定します。
       </para>
       <para>
        各Windowsマシンの接続先サブネットが異なり、互いを認識させなければならない場合は、WINSサーバをセットアップする必要があります。SambaサーバをWINSサーバなどにするには、<literal>wins support = Yes</literal>オプションを設定します。ネットワーク内でこの設定が有効なSambaサーバは1台だけであることを確認します。<filename>smb.conf</filename>ファイル内で、オプション<literal>wins server</literal>と<literal>wins support</literal>は同時に有効にしないでください。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="sec-samba-smb-conf-shares">
    <title>共有</title>
    <para>
     次の例では、SMBクライアントがCD-ROMドライブとユーザディレクトリ(<literal>homes</literal>)を利用できるようにする方法を示します。
    </para>
    <variablelist>
     <varlistentry>
      <term>[cdrom]</term>
      <listitem>
       <para>
        CD-ROMドライブが誤って利用可能になるのを避けるため、これらの行はコメントマーク(この場合はセミコロン)で無効にします。最初の列のセミコロンを削除し、CD-ROMドライブをSambaと共有します。
       </para>
       <example xml:id="dat-cd-rom">
        <title>CD-ROMの共有</title>
<screen>[cdrom]
       comment = Linux CD-ROM
       path = /media/cdrom
       locking = No</screen>
       </example>
       <variablelist>
        <varlistentry>
         <term><option>[cdrom]</option>および<option>コメント</option></term>
         <listitem>
          <para>
           <literal>[cdrom]</literal>セクションエントリは、ネットワーク上のすべてのSMBクライアントが認識できる共有の名前です。さらに<literal>comment</literal>を追加して、共有を説明することができます。
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><option>path = /media/cdrom</option></term>
         <listitem>
          <para>
           <option>path</option>オプションで、<filename>/media/cdrom</filename>ディレクトリをエクスポートします。
          </para>
         </listitem>
        </varlistentry>
       </variablelist>
       <para>
        デフォルトを非常に制約的に設定することによって、このシステム上に存在するユーザのみがこの種の共有を利用できるようになります。この共有をあらゆるユーザに開放する場合は、設定に<literal>guest ok = yes</literal>という行を追加します。この設定は、ネットワーク上の全ユーザに読み込み許可を与えます。このパラメータを使用する場合には、相当な注意を払うことをお勧めします。またこのパラメータを<literal>[global]</literal>セクションで使用する場合には、さらに注意が必要です。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>[homes]</option></term>
      <listitem>
       <para>
        <option>[homes]</option>共有は、ここでは特に重要です。ユーザがLinuxファイルサーバの有効なアカウントとパスワードを持ち、独自のホームディレクトリを持っていればそれに接続することができます。
       </para>
       <example xml:id="dat-homes-frei">
        <title>[homes]共有</title>
<screen>[homes]
        comment = Home Directories
        valid users = %S
        browseable = No
        read only = No
        inherit acls = Yes</screen>
       </example>
       <variablelist>
        <varlistentry>
         <term>[homes]</term>
         <listitem>
          <para>
           SMBサーバに接続しているユーザの共有名を他の共有が使用していない限り、<literal>[homes]</literal>共有ディレクティブを使用して共有が動的に生成されます。生成される共有の名前は、ユーザ名になります。
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><option>valid users = %S</option></term>
         <listitem>
          <para>
           <literal>%S</literal> は、接続が正常に確立されたときに、具体的な共有名に置き換えられます。<option>［homes］</option>共有の場合、これは常にユーザ名です。したがって、ユーザの共有に対するアクセス権は、そのユーザだけに付与されます。
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><option>browseable = No</option></term>
         <listitem>
          <para>
           この設定を行うと、共有がネットワーク環境で認識されなくなります。
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><option>read only = No</option></term>
         <listitem>
          <para>
           デフォルトでは、Sambaは<literal>read only = Yes</literal>パラメータによって、エクスポートされた共有への書き込みアクセスを禁止します。共有に書き込めるように設定するには、<literal>read only = No</literal>値を設定します。これは<literal>writable = Yes</literal>と同値です。
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><option>create mask = 0640</option></term>
         <listitem>
          <para>
           MS Windows NTベース以外のシステムは、UNIXのパーミッションの概念を理解しないので、ファイルの作成時にパーミッションを割り当てることができません。<literal>create mask</literal>パラメータは、新しく作成されたファイルに割り当てられるアクセス権を定義します。これは書き込み可能な共有にのみ適用されます。事実上、この設定は、所有者が読み込みおよび書き込み権限を持ち、所有者のプライマリグループのメンバーが読み込み権限を持っていることを意味します。<option>valid users = %S</option>は、グループに読み込み権限がある場合でも読み込みアクセスを禁止します。グループに読み書き権を付与する場合は、<option>valid users = %S</option>という行を無効にしてください。
          </para>
         </listitem>
        </varlistentry>
       </variablelist>
      </listitem>
     </varlistentry>
    </variablelist>
    <warning>
     <title><literal>NFS</literal>マウントをSambaと共有しない</title>
     <para>
      <literal>NFS</literal>マウントのSambaとの共有は、データが失われる可能性があるため、サポートされていません。ファイルサーバにSambaを直接インストールするか、<literal>iSCSI</literal>などの代替方法を使用することを検討してください。
     </para>
    </warning>
   </sect3>
   <sect3 xml:id="sec-samba-rechte">
    <title>セキュリティレベル</title>
    <para>
     セキュリティを向上させるため、各共有へのアクセスは、パスワードによって保護されています。SMBでは、次の方法で権限を確認できます。
    </para>
    <variablelist>
     <varlistentry>
      <term>ユーザレベルのセキュリティ(<literal>セキュリティ=ユーザ</literal>)</term>
      <listitem>
       <para>
        このセキュリティレベルは、ユーザという概念をSMBに取り入れています。各ユーザは、サーバにパスワードを登録する必要があります。登録後、エクスポートされた個々の共有へのアクセスは、ユーザ名に応じてサーバが許可します。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>ADSレベルのセキュリティ(<literal>セキュリティ=ADS</literal>)</term>
      <listitem>
       <para>
        このモードでは、Sambaはアクティブディレクトリ環境のドメインメンバーとして動作します。このモードで操作するには、Sambaを実行しているコンピュータにKerberosがインストールされ設定済みであることが必要です。Sambaを使用してコンピュータをADSレルムに結合させる必要があります。これは、YaSTの<guimenu>Windowsドメインメンバーシップ</guimenu>モジュールを使用して行います。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>ドメインレベルのセキュリティ(<literal>セキュリティ=ドメイン</literal>)</term>
      <listitem>
       <para>
        このモードは、マシンがWindows NTドメインに参加している場合にのみ正しく動作します。Sambaは、Windows Serverと同じ方法で、ユーザ名とパスワードをWindowsプライマリまたはバックアップドメインコントローラに渡すことにより検証を試みます。暗号化されたパスワードパラメータが<literal>yes</literal>に設定されている必要があります。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     共有、ユーザ、サーバ、またはドメインレベルのセキュリティの設定は、サーバ全体に適用されます。個別の共有ごとに、ある共有には共有レベルのセキュリティ、別の共有にはユーザレベルセキュリティを設定するといったことはできません。しかし、システム上に設定したIPアドレスごとに、別のSambaサーバを実行することは可能です。
    </para>
    <para>
     この詳細については、『Samba 3 HOWTO』を参照してください。つのシステムに複数のサーバをセットアップする場合は、オプション<option>interfaces</option>および<option>bind interfaces only</option>に注意してください。
    </para>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-samba-client-inst">
  <title>クライアントの設定</title>

  <para>
   クライアントは、TCP/IP経由でのみSambaサーバにアクセスできます。IPX経由のNetBEUIおよびNetBIOSは、Sambaで使用できません。
  </para>

  <sect2 xml:id="sec-samba-client-inst-yast">
   <title>YaSTによるSambaクライアントの設定</title>
   <para>
    SambaクライアントをSambaサーバまたはWindowsサーバ上のリソース(ファイルまたはプリンタ)にアクセスするように設定します。WindowsまたはActive Directoryのドメインまたはワークグループを、<menuchoice> <guimenu>ネットワークサービス</guimenu>
    <guimenu>Windowsドメインメンバーシップ</guimenu></menuchoice>の順に選択して表示したダイアログに入力します。<guimenu>Linuxの認証にもSMBの情報を使用する</guimenu>を有効にした場合、ユーザ認証は、Samba、Windows、またはKerberosのサーバ上で実行されます。
   </para>
   <para>
    <guimenu>エキスパート設定</guimenu>をクリックして、高度な設定オプションを設定します。たとえば、認証による自動的なサーバホームディレクトリのマウントを有効化するには、<guimenu>サーバディレクトリのマウント</guimenu>のテーブルを使用します。これにより、CIFS上でホストされると、ホームディレクトリにアクセスできるようになります。詳細については、<systemitem>pam_mount</systemitem>のマニュアルページを参照してください。
   </para>
   <para>
    すべての設定を完了したら、ダイアログを確認して設定を終了します。
   </para>
  </sect2>

  <sect2 xml:id="sec-samba-client-old-server">
   <title>クライアント上へのSMB1/CIFS共有のマウント</title>
   <para>
    SMBネットワークプロトコルの最初のバージョン、SMB1またはCIFSは、古くて安全ではないプロトコルであるため、開発者であるMicrosoftによって推奨されていません。セキュリティ上の理由から、<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>の<command>mount</command>コマンドは、デフォルトでより新しいプロトコルバージョン（SMB 2.1、SMB 3.0、またはSMB 3.02)のみを使用して、SMB共有をマウントします。
   </para>
   <para>
    ただし、この変更は<command>mount</command>および<filename>/etc/fstab</filename>を介したマウンティングのみ影響します。SMB1は、明示的に要求することで引き続き使用できます。使用する情報は、以下のとおりです。
   </para>
   <itemizedlist>
    <listitem>
     <para>
      <command>smbclient</command>ツール。
     </para>
    </listitem>
    <listitem>
     <para>
      <phrase os="sles;sled">SUSE Linux Enterprise Server</phrase>に付属するSambaサーバソフトウェア。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    SMB1のみ使用可能なため、このデフォルト設定により接続障害が生じる次のような設定があります。
   </para>
   <itemizedlist>
    <listitem>
     <para>
      より新しいSMBプロトコルバージョンをサポートしないSMBサーバを使用した設定。Windowsでは、Windows ７およびWindows Server 2008以降、SMB 2.1のサポートを提供しています。
     </para>
    </listitem>
    <listitem>
     <para>
      SMB1/CIFSのUnix拡張機能に依存する設定。これらの拡張機能は、より新しいバージョンのプロトコルには移植されていません。
     </para>
    </listitem>
   </itemizedlist>
   <important>
    <title>システムセキュリティの低減</title>
    <para>
     下に記載される指示に従うと、セキュリティの問題に対処できる場合があります。問題に関する詳細については、<link xlink:href="https://blogs.technet.microsoft.com/filecab/2016/09/16/stop-using-smb1/"/>を参照してください。
    </para>
    <para>
     できるだけ早くサーバをアップグレードすると、より安全なSMBバージョンにすることができます。
    </para>
    <para os="sles;osuse">
     <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>で適切なプロトコルバージョンを有効化する方法については、<xref linkend="sec-samba-server-new-protocol"/>を参照してください。
    </para>
   </important>
   <para>
    現在の<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>カーネルでSMB1共有を有効にする必要がある場合は、使用する<command>mount</command>コマンドラインに<option>vers=1.0</option>オプションを追加します。
   </para>
<screen><prompt role="root"># </prompt>mount -t cifs //<replaceable>HOST</replaceable>/<replaceable>SHARE</replaceable> /<replaceable>MOUNT_POINT</replaceable> –o username=<replaceable>USER_ID</replaceable>,<emphasis role="bold">vers=1.0</emphasis></screen>
   <para>
    または、<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>のインストール内でSMB1共有をグローバルに有効にすることもできます。有効にするには、<filename>/etc/samba/smb.conf</filename>の<literal>[global]</literal>セクションの下に次のコマンドを追加します。
   </para>
   
<screen>        client min protocol = CORE</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-samba-anmeld-serv">
  <title>ログインサーバとしてのSamba</title>

  <para>
   ビジネス設定では、セントラルインスタンスで登録されているユーザにのみアクセスを許可するのが望ましい場合が多いです。Windowsベースのネットワークでは、このタスクはPDC (プライマリドメインコントローラ)によって処理されます。WindowsサーバをPDCとして使用することもできますが、Sambaサーバを使用しても処理できます。<xref linkend="dat-samba-smb-conf-dom"/>に示すように、<filename>smb.conf</filename>の<literal>[global]</literal>セクションにエントリを追加する必要があります。
  </para>

  <example xml:id="dat-samba-smb-conf-dom">
   <title>smb.confファイルのグローバルセクション</title>
<screen>[global]
    workgroup = WORKGROUP
    domain logons = Yes
    domain master = Yes</screen>
  </example>

  <para>
   ユーザアカウントとパスワードをWindowsに準拠した暗号化形式で作成する必要があります。そのためにはコマンド<command>smbpasswd</command> <option>-a name</option>を実行します。さらに次のコマンドを使用して、Windows ドメイン概念で必要になるコンピュータのドメインアカウントを作成します。
  </para>

<screen>useradd hostname
smbpasswd -a -m hostname</screen>

  <para>
   <command>useradd</command>コマンドを使用すると、ドル記号が追加されます。コマンド<command>smbpasswd</command>を指定すると、パラメータ<option>-m</option>を使用したときにドル記号が自動的に挿入されます。コメント付きの設定例(<filename>/usr/share/doc/packages/Samba/examples/smb.conf.SuSE</filename>)には、この作業を自動化するための設定が含まれています。
  </para>

<screen>add machine script = /usr/sbin/useradd -g nogroup -c "NT Machine Account" \
-s /bin/false %m
     </screen>

  <para>
   Sambaがこのスクリプトを正常に実行できるようにするため、必要な管理者権限を持つSambaユーザを選択して、<systemitem class="groupname">ntadmin</systemitem>グループに追加します。これにより、このLinuxグループに属するすべてのユーザに対し、次のコマンドによって<literal>Domain Admin</literal>ステータスを割り当てることができます。
  </para>

<screen>net groupmap add ntgroup="Domain Admins" unixgroup=ntadmin</screen>
 </sect1>
 <sect1 xml:id="sec-samba-adnet" os="sles;osuse">
  <title>Active Directoryネットワーク内のSambaサーバ</title>

  <para>
   LinuxサーバとWindowsサーバの両方を利用する場合、2つの独立した認証システムまたはネットワークを作成するか、または単一の中央認証システムを持つ単一のネットワークに両方のサーバを接続します。SambaはActive Directoryドメイン(AD)と連携できるため、お使いの<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>をActive Directoryドメインに参加させることができます。
  </para>

  <para>
   Active Directoryドメインに参加させるには、次の手順に従います。
  </para>

  <procedure>
   <step>
    <para>
     <systemitem class="username">root</systemitem>としてログインし、YaSTを起動します。
    </para>
   </step>
   <step>
    <para>
     <menuchoice> <guimenu>ネットワークサービス</guimenu> <guimenu>Windowsドメインメンバーシップ</guimenu> </menuchoice>の順に選択します。
    </para>
   </step>
   <step>
    <para>
     <guimenu>Windowsドメインメンバーシップ</guimenu>画面の<guimenu>ドメインまたはワークグループ</guimenu>フィールドに、参加するドメインを入力します。
    </para>
    <figure>
     <title>Windowsドメインメンバーシップの決定</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="ad_sambaclient.png" width="75%"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="ad_sambaclient.png"/>
      </imageobject>
     </mediaobject>
    </figure>
   </step>
   <step>
    <para>
     ServerでLinux認証にSMBソースを使用する場合は、<guimenu>Linuxの認証にもSMBの情報を用いる</guimenu>を選択します。
    </para>
   </step>
   <step>
    <para>
     ドメインへの参加を確認するメッセージが表示されたら、<guimenu>OK</guimenu>をクリックします。
    </para>
   </step>
   <step>
    <para>
     Active DirectoryサーバのWindows管理者用パスワードを入力し、<guimenu>OK</guimenu>をクリックします。
    </para>
    <para>
     Active Directoryドメインコントローラから、すべての認証データを取得できるようになりました。
    </para>
   </step>
  </procedure>

  <tip>
   <title>識別情報マッピング</title>
   <para>
    複数のSambaサーバが存在する環境では、UIDとGIDが常に作成されるわけではありません。ユーザに割り当てられるUIDは、最初のログイン順になるため、サーバ間でUIDの競合が生じます。この問題を解決するには、識別情報マッピングを利用する必要があります。詳しくは「<link xlink:href="https://www.samba.org/samba/docs/man/Samba-HOWTO-Collection/idmapper.html"/>」を参照してください。
   </para>
  </tip>
 </sect1>
 <sect1 xml:id="sec-samba-advanced">
  <title>詳細トピック</title>

  <para>
   このセクションでは、Sambaスイートのクライアントとサーバの両方の部分を管理するためのより高度なテクニックを紹介します。
  </para>

  <sect2 xml:id="sec-automount-systemd">
   <title><systemitem class="daemon">systemd</systemitem>を使用したCIFSファイルシステムの自動化</title>
   <para>
    <systemitem class="daemon">systemd</systemitem>を使用して起動時にCIFS共有をマウントできます。そのためには、以下の説明に従って進めます。
   </para>
   <procedure>
    <step>
     <para>
      マウントポイントを作成します。
     </para>
<screen><prompt>&gt; </prompt>mkdir -p <replaceable>PATH_SERVER_SHARED_FOLDER</replaceable></screen>
     <para>
      ここで、<replaceable>PATH_SERVER_SHARED_FOLDER</replaceable>はこのステップでは<literal>/cifs/shared</literal>です。
     </para>
    </step>
    <step>
     <para>
      <systemitem class="daemon">systemd</systemitem>ユニットファイルを作成します。前のステップで指定したパスからファイル名が生成されますが、「/」は「-」に置換されます。たとえば、次のようになります。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> touch /etc/systemd/system/cifs-shared.mount</screen>
     <para>
      次の内容が続きます。
     </para>
<screen>
[Unit]
Description=CIFS share from The-Server

[Mount]
What=//The-Server/Shared-Folder
Where=/cifs/shared
Type=cifs
Options=rw,username=vagrant,password=admin

[Install]
WantedBy=multi-user.target
            </screen>
    </step>
    <step>
     <para>
      サービスを有効化します。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl enable cifs-shared.mount</screen>
    </step>
    <step>
     <para>
      サービスを開始します。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl start cifs-shared.mount</screen>
     <para>
      サービスが実行中であることを確認するには、次のコマンドを実行します。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl status cifs-shared.mount</screen>
    </step>
    <step>
     <para>
      CIFS共有パスが使用可能であることを確認するには、次のコマンドを実行します。
     </para>
<screen><prompt>&gt; </prompt> cd /cifs/shared
<prompt>&gt; </prompt>ls -l

total 0
-rwxrwxrwx. 1 root    root    0 Oct 24 22:31 hello-world-cifs.txt
drwxrwxrwx. 2 root    root    0 Oct 24 22:31 subfolder
-rw-r--r--. 1 vagrant vagrant 0 Oct 28 21:51 testfile.txt
            </screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec-samba-advanced-compress">
   <title>Btrfsでの透過的なファイル圧縮</title>
   <para>
    Sambaでは、クライアントは、Btrfsファイルシステムに配置されている共有のファイルおよびディレクトリの圧縮フラグをリモートで操作できます。Windowsエクスプローラでは、<menuchoice><guimenu>ファイル</guimenu><guimenu>プロパティ</guimenu><guimenu>詳細</guimenu></menuchoice>ダイアログを使用することで、ファイル/ディレクトリに透過的な圧縮対象のフラグを付けることができます。
   </para>
   <figure>
    <title>Windowsエクスプローラの<guimenu>属性の詳細</guimenu>ダイアログ</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="samba_win_expl_advattr.png" width="75%"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="samba_win_expl_advattr.png"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    圧縮対象フラグが付いたファイルは、アクセスまたは変更があると、基礎となるファイルシステムによって透過的に圧縮および圧縮解除されます。通常、これによってファイルアクセス時に余分なCPUオーバーヘッドが生じますが、ストレージ容量の節約になります。新しいファイルとディレクトリは、FILE_NO_COMPRESSIONオプションを指定して作成しない限り、親ディレクトリの圧縮フラグを継承します。
   </para>
   <para>
    Windowsエクスプローラでは、圧縮ファイルとディレクトリは、未圧縮のファイル/ディレクトリとは視覚的に見分けが付くように表示されます。
   </para>
   <figure>
    <title>Windowsエクスプローラでの圧縮ファイルのディレクトリリスト</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="samba_win_expl_view_compressed.png" width="75%"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="samba_win_expl_view_compressed.png"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    Samba共有の圧縮を有効にするには、手動で、
   </para>
<screen>vfs objects = btrfs</screen>
   <para>
    <filename>/etc/samba/smb.conf</filename>に共有設定を追加して実行するか、YaSTを使用して<menuchoice><guimenu>ネットワークサービス</guimenu><guimenu>Sambaサーバ</guimenu><guimenu>追加</guimenu></menuchoice>の順に選択して<guimenu>btrfs機能を利用する</guimenu>をオンにします。
   </para>
   <para os="sles">
    Btrfsでの圧縮の概要については、<xref linkend="sec-filesystems-major-btrfs-compress"/>を参照してください。
   </para>
  </sect2>

  <sect2 xml:id="sec-samba-advanced-snapshots">
   <title>スナップショット</title>
   <para>
    スナップショット(シャドウコピーとも呼ばれる)は、特定の時点におけるファイルシステムサブボリュームの状態のコピーです。Snapperは、Linuxでこれらのスナップショットを管理するためのツールです。スナップショットは、BtrfsファイルシステムまたはシンプロビジョニングされたLVMボリュームでサポートされています。Sambaスイートは、サーバ側とクライアント側の両方で、FSRVPプロトコルを介したリモートスナップショットの管理をサポートしています。
   </para>
   <sect3 xml:id="sec-samba-advanced-snapshots-client">
    <title>以前のバージョン</title>
    <para>
     Sambaサーバ上のスナップショットは、以前のバージョンのファイルまたはディレクトリとしてリモートWindowsクライアントに公開できます。
    </para>
    <para>
     Sambaサーバでスナップショットを有効にするには、次の条件を満たしている必要があります。
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       SMBネットワーク共有がBtrfsサブボリューム上に存在している。
      </para>
     </listitem>
     <listitem>
      <para>
       SMBネットワーク共有のパスに、関連するSnapper環境設定ファイルが含まれている。次のコマンドを使用して、Snapperファイルを作成できます。
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> snapper -c &lt;cfg_name&gt; create-config <option>/path/to/share</option></screen>
      <para>
       Snapperの詳細については、<xref linkend="cha-snapper"/>を参照してください。
      </para>
     </listitem>
     <listitem>
      <para>
       スナップショットディレクトリツリーでは、関連するユーザにアクセスを許可する必要があります。詳細については、vfs_snapperマニュアルページの「PERMISSIONS」のセクション(<command>man 8 vfs_snapper</command>)を参照してください。
      </para>
     </listitem>
    </itemizedlist>
    <para>
     リモートスナップショットをサポートするには、<filename>/etc/samba/smb.conf</filename>ファイルを変更する必要があります。変更するには、<menuchoice><guimenu>YaST</guimenu><guimenu>ネットワークサービス</guimenu><guimenu>Sambaサーバ</guimenu></menuchoice>の順に選択するか、または次のコマンドを使用して関連する共有セクションを手動で拡張します。
    </para>
<screen>vfs objects = snapper</screen>
    <para>
     手動での<filename>smb.conf</filename>への変更を有効にするために、Sambaサービスを再起動する必要がある点に注意してください。
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl restart nmb smb</screen>
    <figure xml:id="fig-yast2-samba-snapshot">
     <title>スナップショットが有効な新しいSamba共有の追加</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="yast2_samba_snapshot.png" width="75%"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="yast2_samba_snapshot.png"/>
      </imageobject>
     </mediaobject>
    </figure>
    <para>
     設定後、Samba共有パスでSnapperによって作成されたスナップショットには、Windowsエクスプローラのファイルまたはディレクトリの<guimenu>以前のバージョン</guimenu>タブからアクセスできます。
    </para>
    <figure xml:id="fig-samba-win-explorer">
     <title>Windowsエクスプローラの<guimenu>以前のバージョン</guimenu>タブ</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="samba_winexpl_previous_versions.png" width="75%"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="samba_winexpl_previous_versions.png"/>
      </imageobject>
     </mediaobject>
    </figure>
   </sect3>
   <sect3 xml:id="sec-samba-advanced-snapshots-server">
    <title>リモート共有スナップショット</title>
    <para>
     デフォルトでは、スナップショットは、SnapperコマンドラインユーティリティまたはSnapperのタイムライン機能を使用して、Sambaサーバ上でローカルでのみ作成および削除できます。
    </para>
    <para>
     Sambaは、リモートホストからの共有スナップショット作成および削除要求をFSRVP (File Server Remote VSS Protocol)を使用して処理するように設定できます。
    </para>
    <para>
     <xref linkend="sec-samba-advanced-snapshots-client"/>で説明されている環境設定と前提条件に加え、<filename>/etc/samba/smb.conf</filename>に次のグローバル設定が必要です。
    </para>
<screen>[global]
rpc_daemon:fssd = fork
registry shares = yes
include = registry</screen>
    <para>
     その後、FSRVPクライアント(Sambaの<command>rpcclient</command>およびWindows Server 2012 <command>DiskShadow.exe</command>を含む)は、特定の共有のスナップショットを作成または削除したり、スナップショットを新しい共有として公開したりするようSambaに命令できます。
    </para>
   </sect3>
   <sect3 xml:id="sec-samba-advanced-snapshots-client-linux">
    <title><command>rpcclient</command>によるLinuxからのスナップショットのリモート管理</title>
    <para>
     <systemitem>samba-client</systemitem>パッケージには、特定の共有の作成と公開をWindows/Sambaサーバにリモートで要求できるFSRVPクライアントが含まれています。<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>の既存のツールを使用して、公開された共有をマウントし、そのファイルをバックアップできます。サーバへの要求は、<command>rpcclient</command>バイナリを使用して送信されます。
    </para>
    <example>
     <title><command>rpcclient</command>を使用したWindows Server 2012共有スナップショットの要求</title>
     <para>
      <literal>win-server.example.com</literal>サーバに<literal>EXAMPLE</literal>ドメインの管理者として接続します。
     </para>
<screen><prompt role="root"># </prompt>rpcclient -U '<replaceable>EXAMPLE</replaceable>\Administrator' ncacn_np:<replaceable>win-server.example.com</replaceable>[ndr64,sign]
Enter EXAMPLE/Administrator's password:</screen>
     <para>
      <command>rpcclient</command>にSMB共有が表示されることを確認します。
     </para>
<screen><prompt role="root"># </prompt>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)</screen>
     <para>
      SMB共有がスナップショットの作成をサポートしていることを確認します。
     </para>
<screen><prompt role="root"># </prompt>rpcclient $&gt; fss_is_path_sup windows_server_2012_share \
UNC \\WIN-SERVER\windows_server_2012_share\ supports shadow copy requests</screen>
     <para>
      共有スナップショットの作成を要求します。
     </para>
<screen><prompt role="root"># </prompt>rpcclient $&gt; fss_create_expose backup ro windows_server_2012_share
13fe880e-e232-493d-87e9-402f21019fb6: shadow-copy set created
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
\\WIN-SERVER\windows_server_2012_share\ shadow-copy added to set
13fe880e-e232-493d-87e9-402f21019fb6: prepare completed in 0 secs
13fe880e-e232-493d-87e9-402f21019fb6: commit completed in 1 secs
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
share windows_server_2012_share@{1C26544E-8251-445F-BE89-D1E0A3938777} \
exposed as a snapshot of \\WIN-SERVER\windows_server_2012_share\</screen>
     <para>
      スナップショット共有がサーバによって公開されたことを確認します。
     </para>
<screen><prompt role="root"># </prompt>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)

netname: windows_server_2012_share@{1C26544E-8251-445F-BE89-D1E0A3938777}
remark: (null)
path:   \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy{F6E6507E-F537-11E3-9404-B8AC6F927453}\Shares\windows_server_2012_share\
password:       (null)</screen>
     <para>
      スナップショット共有の削除を試みます。
     </para>
<screen><prompt role="root"># </prompt>rpcclient $&gt; fss_delete windows_server_2012_share \
13fe880e-e232-493d-87e9-402f21019fb6 1c26544e-8251-445f-be89-d1e0a3938777
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
\\WIN-SERVER\windows_server_2012_share\ shadow-copy deleted</screen>
     <para>
      スナップショット共有がサーバによって削除されたことを確認します。
     </para>
<screen><prompt role="root"># </prompt>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)</screen>
    </example>
   </sect3>
   <sect3 xml:id="sec-samba-advanced-snapshots-client-winserver">
    <title><command>DiskShadow.exe</command>によるWindowsからのスナップショットのリモート管理</title>
    <para>
     WindowsクライアントからLinux Samba上でSMB共有のスナップショットを管理することもできます。Windows Server 2012には、<xref linkend="sec-samba-advanced-snapshots-client-linux"/>で説明した<command>rpcclient</command>コマンドと同様にリモート共有を管理できる<command>DiskShadow.exe</command>ユーティリティが含まれています。最初にSambaサーバを慎重に設定する必要がある点に注意してください。
    </para>
    <para>
     以下は、Windowsクライアントが共有のスナップショットを管理できるようにSambaサーバを設定する手順の例です。<replaceable>EXAMPLE</replaceable>はテスト環境で使用されるActive Directoryドメイン、<uri>fsrvp-server.example.com</uri>はSambaサーバのホスト名、<filename>/srv/smb</filename>はSMB共有のパスである点に注意してください。
    </para>
    <procedure>
     <title>Sambaサーバの詳細な設定</title>
     <step>
      <para>
       YaSTを介してActive Directoryドメインに参加します。<phrase os="sles;osuse">詳細については、<xref linkend="sec-samba-adnet"/>を参照してください。</phrase>
      </para>
     </step>
     <step>
      <para>
       Active DirectoryドメインのDNSエントリが正しいことを確認します。
      </para>
<screen>fsrvp-server:~ # net -U 'Administrator' ads dns register \
fsrvp-server.example.com &lt;IP address&gt;
Successfully registered hostname with DNS</screen>
     </step>
     <step>
      <para>
       Btrfsサブボリュームを<filename>/srv/smb</filename>に作成します。
      </para>
<screen>fsrvp-server:~ # btrfs subvolume create /srv/smb</screen>
     </step>
     <step>
      <para>
       パス<filename>/srv/smb</filename>にSnapper環境設定ファイルを作成します。
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; create-config /srv/smb</screen>
     </step>
     <step>
      <para>
       パス<filename>/srv/smb</filename>に新しい共有を作成し、YaSTの<guimenu>スナップショットを公開する</guimenu>チェックボックスをオンにします。<xref linkend="sec-samba-advanced-snapshots-server"/>に説明されているように、次のスニペットを<filename>/etc/samba/smb.conf</filename>のグローバルセクションに追加します。
      </para>
<screen>[global]
 rpc_daemon:fssd = fork
 registry shares = yes
 include = registry</screen>
     </step>
     <step>
      <para>
       <command>systemctl restart nmb smb</command>コマンドを使用して、Sambaを再起動します。
      </para>
     </step>
     <step>
      <para>
       Snapperのパーミッションを設定します。
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; set-config \
ALLOW_USERS="EXAMPLE\\\\Administrator EXAMPLE\\\\win-client$"</screen>
      <para>
       <literal>ALLOW_USERS</literal>のすべてのインスタンスが<filename>.snapshots</filename>サブディレクトリへのアクセスも許可されていることを確認します。
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; set-config SYNC_ACL=yes</screen>
      <important>
       <title>パスのエスケープ</title>
       <para>
        「\」エスケープには注意してください。<filename>/etc/snapper/configs/&lt;snapper_config&gt;</filename>に保存された値を確実に1回エスケープするには、2回エスケープします。
       </para>
      </important>
      <para>
       「EXAMPLE\win-client$」はWindowsクライアントのコンピュータアカウントに対応します。Windowsは、このアカウントが認証されている間に初期FSRVP要求を発行します。
      </para>
     </step>
     <step>
      <para>
       Windowsクライアントアカウントに必要な特権を付与します。
      </para>
<screen>fsrvp-server:~ # net -U 'Administrator' rpc rights grant \
"EXAMPLE\\win-client$" SeBackupPrivilege
Successfully granted rights.</screen>
      <para>
       「EXAMPLE\Administrator」ユーザの場合、すでに特権が付与されているため、上のコマンドは必要ありません。
      </para>
     </step>
    </procedure>
    <procedure>
     <title>Windowsクライアントのセットアップと<command>DiskShadow.exe</command>の実行</title>
     <step>
      <para>
       Windows Server 2012 (ホスト名の例:WIN-CLIENT)をブートします。
      </para>
     </step>
     <step>
      <para>
       <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>と同じActive DirectoryドメインEXAMPLEに参加します。
      </para>
     </step>
     <step>
      <para>
       再起動します。
      </para>
     </step>
     <step>
      <para>
       Powershellを開きます。
      </para>
     </step>
     <step>
      <para>
       <command>DiskShadow.exe</command>を起動し、バックアップ手順を開始します。
      </para>
<screen>PS C:\Users\Administrator.EXAMPLE&gt; diskshadow.exe
Microsoft DiskShadow version 1.0
Copyright (C) 2012 Microsoft Corporation
On computer:  WIN-CLIENT,  6/17/2014 3:53:54 PM

DISKSHADOW&gt; begin backup</screen>
     </step>
     <step>
      <para>
       プログラムの終了、リセット、および再起動にわたってシャドウコピーが保持されるように指定します。
      </para>
<screen>DISKSHADOW&gt; set context PERSISTENT</screen>
     </step>
     <step>
      <para>
       指定した共有がスナップショットをサポートしているかどうかを確認し、スナップショットを作成します。
      </para>
<screen>DISKSHADOW&gt; add volume \\fsrvp-server\sles_snapper

DISKSHADOW&gt; create
Alias VSS_SHADOW_1 for shadow ID {de4ddca4-4978-4805-8776-cdf82d190a4a} set as \
 environment variable.
Alias VSS_SHADOW_SET for shadow set ID {c58e1452-c554-400e-a266-d11d5c837cb1} \
 set as environment variable.

Querying all shadow copies with the shadow copy set ID \
 {c58e1452-c554-400e-a266-d11d5c837cb1}

 * Shadow copy ID = {de4ddca4-4978-4805-8776-cdf82d190a4a}     %VSS_SHADOW_1%
    - Shadow copy set: {c58e1452-c554-400e-a266-d11d5c837cb1}  %VSS_SHADOW_SET%
    - Original count of shadow copies = 1
    - Original volume name: \\FSRVP-SERVER\SLES_SNAPPER\ \
      [volume not on this machine]
    - Creation time: 6/17/2014 3:54:43 PM
    - Shadow copy device name:
      \\FSRVP-SERVER\SLES_SNAPPER@{31afd84a-44a7-41be-b9b0-751898756faa}
    - Originating machine: FSRVP-SERVER
    - Service machine: win-client.example.com
    - Not exposed
    - Provider ID: {89300202-3cec-4981-9171-19f59559e0f2}
    - Attributes:  No_Auto_Release Persistent FileShare

Number of shadow copies listed: 1</screen>
     </step>
     <step>
      <para>
       バックアップ手順を終了します。
      </para>
<screen>DISKSHADOW&gt; end backup</screen>
     </step>
     <step>
      <para>
       スナップショットが作成された後、その削除を試み、削除されたことを確認します。
      </para>
<screen>DISKSHADOW&gt; delete shadows volume \\FSRVP-SERVER\SLES_SNAPPER\
Deleting shadow copy {de4ddca4-4978-4805-8776-cdf82d190a4a} on volume \
 \\FSRVP-SERVER\SLES_SNAPPER\ from provider \
{89300202-3cec-4981-9171-19f59559e0f2} [Attributes: 0x04000009]...

Number of shadow copies deleted: 1

DISKSHADOW&gt; list shadows all

Querying all shadow copies on the computer ...
No shadow copies found in system.</screen>
     </step>
    </procedure>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-samba-info">
  <title>詳細情報</title>

  <itemizedlist>
   <listitem>
    <formalpara>
     <title>マニュアルページ:</title>
     <para>
      <package>samba</package>パッケージでインストールされるすべての<command>man</command>ページのリストを表示するには、<command>apropos samba</command>を実行します。<command>man <replaceable>NAME_OF_MAN_PAGE</replaceable></command>を使用してマニュアルページを開きます。
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>SUSE-specific READMEファイル:</title>
     <para>
      パッケージ<package>samba-client</package>には、<filename>/usr/share/doc/packages/samba/README.SUSE</filename>が含まれます。
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>追加のパッケージドキュメント:</title>
     <para>
      <command>zypper install samba-doc</command>を使用して、パッケージ<systemitem>samba-doc</systemitem>をインストールします。
     </para>
    </formalpara>
    <para>
     このドキュメントは<filename>/usr/share/doc/packages/samba</filename>にインストールされます。マニュアルページのHTMLバージョンと設定例のライブラリ(<filename>smb.conf.SUSE</filename>など)が含まれています。
    </para>
   </listitem>
   <listitem>
    <formalpara>
     <title>オンラインマニュアル:</title>
     <para>
      Samba wikiには、広範囲なユーザマニュアルが含まれています<citetitle></citetitle>(<link xlink:href="https://wiki.samba.org/index.php/User_Documentation"/>)。
     </para>
    </formalpara>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
