<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_samba.xml" version="5.0" xml:id="cha.samba">
 <title>Samba</title>
 <info>
      <abstract>
        <para>
    Mit Samba kann ein Unix-Computer als Datei- und Druckserver für Mac OS X-, Windows- und OS/2-Computer konfiguriert werden. Samba ist mittlerweile ein sehr umfassendes und komplexes Produkt. Konfigurieren Sie Samba mit YaST oder indem Sie die Konfigurationsdatei manuell bearbeiten.
   </para>
      </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:bugtracker>
          </dm:bugtracker>
        <dm:translation>Ja</dm:translation>
      </dm:docmanager>
    </info>
    <indexterm xml:id="idx.Samba" class="startofrange"> <primary>Samba</primary> </indexterm> <indexterm> <primary>SMB</primary> <see>Samba</see> </indexterm> <indexterm> <primary>Mac OS X</primary> <secondary>Dateien freigeben</secondary> </indexterm> <indexterm> <primary>Windows</primary> <secondary>Dateien freigeben</secondary> </indexterm> <indexterm> <primary>OS/2</primary> <secondary>Dateien freigeben</secondary> </indexterm> <indexterm> <primary>Linux</primary> <secondary>Dateien freigeben mit einem anderen Betriebssystem</secondary> </indexterm>
 <sect1 xml:id="sec.samba.term">
  <title>Terminologie</title>

  <para>
   Im Folgenden werden einige Begriffe erläutert, die in der Samba-Dokumentation und im YaST-Modul verwendet werden.
  </para>

  <variablelist>
   <varlistentry>
    <term>SMB-Protokoll</term>
    <listitem>
     <para>
      <indexterm> <primary>Samba</primary> <secondary>SMB</secondary> </indexterm> <indexterm> <primary>protocols</primary> <secondary>SMB</secondary> </indexterm> <indexterm> <primary>smbd</primary> </indexterm> Samba verwendet das SMB-Protokoll (Server Message Block), das auf den <phrase role="productname">NetBIOS</phrase>-Diensten basiert. Microsoft veröffentlichte das Protokoll, damit auch andere Softwarehersteller Anbindungen an ein Microsoft-Domänennetzwerk einrichten konnten. Samba setzt das SMB- auf das TCP/IP-Protokoll auf. Entsprechend muss auf allen Clients das TCP/IP-Protokoll installiert sein. <indexterm> <primary>Samba</primary> <secondary>TCP/IP und</secondary> </indexterm>
     </para>
     <tip arch="zseries" os="sles">
      <title>IBM System z: Unterstützung für NetBIOS</title>
      <para>
       IBM-System z unterstützt nur SMB über TCP/IP. NetBIOS-Unterstützung ist auf diesen Systemen nicht verfügbar.
      </para>
     </tip>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>CIFS-Protokoll</term>
    <listitem>
     <para>
      <indexterm> <primary>Samba</primary> <secondary>CIFS</secondary> </indexterm> <indexterm> <primary>Protokolle</primary> <secondary>CIFS</secondary> </indexterm> Das CIFS-Protokoll (Common Internet File System) ist ein weiteres von Samba unterstütztes Protokoll. CIFS definiert ein Standardprotokoll für den Fernzugriff auf Dateisysteme über das Netzwerk, das Benutzergruppen die netzwerkweite Zusammenarbeit und gemeinsame Dokumentbenutzung ermöglicht.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NetBIOS</term>
    <listitem>
     <para>
      <indexterm> <primary>NetBIOS</primary> </indexterm> NetBIOS ist eine Softwareschnittstelle (API) für die Kommunikation zwischen Computern, die einen Name Service bereitstellen. Mit diesem Dienst können die an das Netzwerk angeschlossenen Computer Namen für sich reservieren. Nach dieser Reservierung können die Computer anhand ihrer Namen adressiert werden. Für die Überprüfung der Namen gibt es keine zentrale Instanz. Jeder Computer im Netzwerk kann beliebig viele Namen reservieren, solange die Namen noch nicht Gebrauch sind. Die NetBIOS-Schnittstelle kann in unterschiedlichen Netzwerkarchitekturen implementiert werden. Eine Implementierung, die relativ eng mit der Netzwerkhardware arbeitet, ist <phrase role="productname">NetBEUI</phrase> (häufig auch als <phrase role="productname">NetBIOS</phrase> bezeichnet). Mit NetBIOS implementierte Netzwerkprotokolle sind IPX (NetBIOS über TCP/IP) von Novell und TCP/IP.
     </para>
     <para>
      Die per TCP/IP übermittelten NetBIOS-Namen haben nichts mit den in der Datei <filename>/etc/hosts</filename> oder per DNS vergebenen Namen zu tun. NetBIOS ist ein eigener, vollständig unabhängiger Namensraum. Es empfiehlt sich jedoch, für eine einfachere Administration NetBIOS-Namen zu vergeben, die den jeweiligen DNS-Hostnamen entsprechen, oder DNS nativ zu verwenden. Für einen Samba-Server ist dies die Voreinstellung.
     </para><indexterm> <primary>Samba </primary><secondary>Namen</secondary></indexterm>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Samba-Server</term>
    <listitem><indexterm> <primary>Samba</primary><secondary>Server</secondary></indexterm>
     <para>
      Samba-Server stellt SMB/CIFS-Dienste sowie NetBIOS over IP-Namensdienste für Clients zur Verfügung. Für Linux gibt es drei Dämonen für Samba-Server: smbd für SMB/CIFS-Dienste, nmbd für Naming Services und winbind für Authentifizierung.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Samba-Client</term>
    <listitem><indexterm xml:id="idx.Samba_clients" class="startofrange"> <primary>Samba</primary> <secondary>Clients</secondary> </indexterm>
     <para>
      Der Samba-Client ist ein System, das Samba-Dienste von einem Samba-Server über das SMB-Protokoll nutzt. Das Samba-Protokoll wird von allen gängigen Betriebssystemen wie Mac OS X, Windows und OS/2 unterstützt. Auf den Computern muss das TCP/IP-Protokoll installiert sein. Für die verschiedenen UNIX-Versionen stellt Samba einen Client zur Verfügung. Für Linux gibt es zudem ein Dateisystem-Kernel-Modul für SMB, das die Integration von SMB-Ressourcen auf Linux-Systemebene ermöglicht. Sie brauchen für den Samba-Client keinen Dämon auszuführen.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Freigaben</term>
    <listitem>
     <para>
      <indexterm> <primary>Samba</primary> <secondary>Freigaben</secondary> </indexterm>SMB-Server stellen den Clients Ressourcen in Form von Freigaben (Shares) zur Verfügung. Freigaben sind Drucker und Verzeichnisse mit ihren Unterverzeichnissen auf dem Server. Eine Freigabe wird unter einem eigenen Namen exportiert und kann von Clients unter diesem Namen angesprochen werden. Der Freigabename kann frei vergeben werden. Er muss nicht dem Namen des exportierten Verzeichnisses entsprechen. Ebenso wird einem Drucker ein Name zugeordnet. Clients können mit diesem Namen auf den Drucker zugreifen. <indexterm> <primary>Drucken</primary> <secondary>Samba</secondary> </indexterm> <indexterm> <primary>Samba</primary> <secondary>Drucker</secondary> </indexterm> <indexterm class="endofrange" startref="idx.Samba_clients"/>
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>DC</term>
    <listitem>
     <para>
      <indexterm> <primary>Samba</primary> <secondary>DC</secondary> </indexterm> Ein Domänencontroller (DC) ist ein Server, der Konten in der Domäne verwaltet. Zur Datenreplikation stehen zusätzliche Domain Controller in einer Domäne zur Verfügung.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec.samba.install">
  <title>Installieren eines Samba-Servers</title>

  <para>
   Zur Installation eines Samba-Servers starten Sie YaST, und wählen Sie <menuchoice><guimenu>Software</guimenu> <guimenu>Software installieren oder löschen</guimenu></menuchoice>. Wählen Sie <menuchoice><guimenu>Anzeigen</guimenu> <guimenu>Schemata</guimenu></menuchoice> und dann <guimenu>Dateiserver</guimenu>. Bestätigen Sie die Installation der erforderlichen Pakete, um den Installationsvorgang abzuschließen.
  </para>
 </sect1>
 <sect1 xml:id="sec.samba.serv.start" os="sles">
  <title>Starten und Stoppen von Samba</title>

  <para>
   Sie können den Samba-Server automatisch (beim Booten) oder manuell starten bzw. stoppen. Start- und Stopprichtlinien sind Teil der Samba-Serverkonfiguration mit YaST, die in <xref linkend="sec.samba.yast2.conf"/> beschrieben ist.
  </para>

  <para>
   Beenden Sie die Dienste für Samba. Geben Sie hierzu in einer Befehlszeile den Befehl <command>systemctl stop smb nmb</command> ein und starten Sie die Dienste dann mit <command>systemctl start nmb smb</command> neu. <literal>winbind</literal> wird bei Bedarf durch den Dienst <literal>smb</literal> eingestellt.
  </para>

  <tip>
   <para>
    <systemitem>winbind</systemitem> ist ein unabhängiger Dienst und wird als solcher auch als einzelnes <systemitem>samba-winbind</systemitem>-Paket angeboten.
   </para>
  </tip><indexterm> <primary>Samba</primary> <secondary>Starten</secondary> </indexterm> <indexterm> <primary>Samba</primary> <secondary>Stoppen</secondary> </indexterm>
 </sect1>
 <sect1 xml:id="sec.samba.serv.inst">
  <title>Konfigurieren eines Samba-Servers</title><indexterm> <primary>Samba</primary> <secondary>Installieren</secondary> </indexterm> <indexterm> <primary>Samba</primary> <secondary>Server</secondary> </indexterm> <indexterm> <primary>Samba</primary> <secondary>Konfigurieren</secondary> </indexterm> <indexterm> <primary>Konfigurieren</primary> <secondary>Samba</secondary> </indexterm>

  <para os="sles">
   Es gibt zwei Möglichkeiten, Samba-Server in <phrase role="productname"><phrase os="sles">SUSE® Linux Enterprise Server</phrase></phrase> zu konfigurieren: mit YaST oder manuell. Bei der manuellen Konfiguration können Sie mehr Details einstellen, allerdings müssen Sie ohne den Komfort der Bedienoberfläche von YaST zurechtkommen.
  </para>



  <sect2 xml:id="sec.samba.yast2.conf" os="sles">
   <title>Konfigurieren eines Samba-Servers mit YaST</title>
   <para>
    Um einen Samba-Server zu konfigurieren, starten Sie YaST und wählen Sie <menuchoice><guimenu>Netzwerkdienste</guimenu><guimenu>Samba-Server</guimenu></menuchoice>.
   </para>
   <sect3 xml:id="sec.samba.yast2.conf.inst">
    <title>Anfängliche Samba-Konfiguration</title>
    <para>
     Wenn Sie dieses Modul zum ersten Mal starten, wird das Dialogfeld <guimenu>Samba-Installation</guimenu> geöffnet, und Sie werden aufgefordert, einige grundlegende Entscheidungen zur Verwaltung des Servers zu treffen. Am Ende des Konfigurationsvorgangs werden Sie aufgefordert, das Samba-Administratorpasswort (<guimenu>Samba-Root-Passwort</guimenu>) einzugeben). Bei späteren Starts wird das Dialogfeld <guimenu>Samba-Konfiguration </guimenu> geöffnet.
    </para>
    <para>
     Der Dialog <guimenu>Samba-Installation</guimenu> umfasst zwei Schritte und optionale detaillierte Einstellungen:
    </para>
    <variablelist>
     <varlistentry>
      <term>Arbeitsgruppe oder Domäne</term>
      <listitem>
       <para>
        Wählen Sie unter <guimenu>Arbeitsgruppe oder Domäne</guimenu> eine Arbeitsgruppe oder Domäne aus oder geben Sie eine neue ein und klicken Sie auf <guimenu>Weiter</guimenu>.
       </para>

      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Samba-Servertyp</term>
      <listitem>
       <para>
        Geben Sie im nächsten Schritt an, ob Ihr Server als Primary Domain Controller (PDC), Backup Domain Controller (BDC) oder gar nicht als Domain Controller agieren soll. Fahren Sie mit <guimenu>Weiter</guimenu> fort.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     Falls Sie keine detaillierte Serverkonfiguration vornehmen möchten, bestätigen Sie dies mit <guimenu>OK</guimenu>. Legen Sie dann im abschließenden Popup-Feld das <guimenu>root-Passwort für Samba</guimenu> fest.
    </para>
    <para>
     Sie können alle Einstellungen später im Dialogfeld <guimenu>Samba-Konfiguration</guimenu> auf den Karteireitern <guimenu>Start</guimenu>, <guimenu>Freigaben</guimenu>, <guimenu>Identität</guimenu>, <guimenu>Verbürgte Domänen</guimenu> und <guimenu>LDAP-Einstellungen</guimenu> ändern.
    </para>
   </sect3>
   <sect3 xml:id="sec.samba.yast2.conf.adv">
    <title>Erweiterte Samba-Konfiguration</title>
    <para>
     Beim ersten Start des Samba-Servermoduls wird das Dialogfeld <guimenu>Samba-Konfiguration</guimenu> direkt nach den beiden Anfangsschritten (siehe <xref linkend="sec.samba.yast2.conf.inst"/>) geöffnet. Hier passen Sie Ihre Samba-Server-Konfiguration an.
    </para>
    <para>
     Klicken Sie nach dem Bearbeiten Ihrer Konfiguration auf <guimenu>OK</guimenu>, um Ihre Einstellungen zu speichern.
    </para>
    <sect4 xml:id="sec.samba.yast2.conf.adv.start">
     <title>Starten des Servers</title>
     <para>
      Auf dem Karteireiter <guimenu>Start</guimenu> können Sie den Start des Samba-Servers konfigurieren. Um den Dienst bei jedem Systemboot zu starten, wählen Sie <guimenu>During Boot</guimenu> (Beim Systemstart). Um den manuellen Start zu aktivieren, wählen Sie <guimenu>Manually</guimenu> (Manuell). Weitere Informationen zum Starten eines Samba-Servers erhalten Sie in <xref linkend="sec.samba.serv.start"/>.
     </para>
     <para>
      Auf diesem Karteireiter können Sie auch Ports in Ihrer Firewall öffnen. Wählen Sie hierfür <guimenu>Open Port in Firewall</guimenu> (Firewall-Port öffnen). Wenn mehrere Netzwerkschnittstellen vorhanden sind, wählen Sie die Netzwerkschnittstelle für Samba-Dienste, indem Sie auf <guimenu>Firewall-Details</guimenu> klicken, die Schnittstellen auswählen und dann auf <guimenu>OK</guimenu> klicken.
     </para>

    </sect4>
    <sect4 xml:id="sec.samba.yast2.conf.adv.shares">
     <title>Freigaben</title>
     <para>
      Legen Sie auf dem Karteireiter <guimenu>Freigaben</guimenu> die zu aktivierenden Samba-Freigaben fest. Es gibt einige vordefinierte Freigaben wie Home-Verzeichnisse und Drucker. Mit <guimenu>Status wechseln</guimenu> können Sie zwischen den Statuswerten <guimenu>Aktiviert</guimenu> und <guimenu>Deaktiviert</guimenu> wechseln. Klicken Sie auf <guimenu>Hinzufügen</guimenu>, um neue Freigaben hinzuzufügen, bzw. auf <guimenu>Löschen</guimenu>, um die ausgewählte Freigabe zu entfernen.
     </para>

     <para>
      Mit <guimenu>Benutzern die Freigabe ihrer Verzeichnisse erlauben</guimenu> können Mitglieder der Gruppe in <guimenu>Zulässige Gruppe</guimenu> ihre eigenen Verzeichnisse für andere Benutzer freigeben. Zum Beispiel <systemitem>users</systemitem> für eine lokale Reichweite oder <systemitem>DOMAIN\Users</systemitem> für eine domänenweite Freigabe. Der Benutzer muss außerdem sicherstellen, dass die Berechtigungen des Dateisystems den Zugriff zulassen. Mit <guimenu>Maximale Anzahl an Freigaben</guimenu> begrenzen Sie die Gesamtzahl der erstellbaren Freigaben. Wenn Sie den Zugriff auf Benutzerfreigaben ohne Authentifizierung zulassen möchten, aktivieren Sie <guimenu>Gastzugriff erlauben</guimenu>.

     </para>
    </sect4>
    <sect4 xml:id="sec.samba.yast2.conf.adv.identity">
     <title>Identität</title>
     <para>
      Auf dem Karteireiter <guimenu>Identität</guimenu> legen Sie fest, zu welcher Domäne der Host gehört (<guimenu>Grundeinstellungen</guimenu>) und ob ein alternativer Hostname im Netzwerk (<guimenu>NetBIOS-Hostname</guimenu>) verwendet werden soll. Microsoft Windows Internet Name Service (WINS) kann auch zur Namensauflösung benutzt werden. Aktivieren Sie in diesem Fall <guimenu>WINS zur Hostnamenauflösung verwenden</guimenu> und entscheiden Sie, ob Sie <guimenu>WINS-Server via DHCP abrufen</guimenu> möchten. Zum Festlegen globaler Einstellungen für Experten oder einer Quelle zur Benutzerauthentifizierung (<phrase os="sles">zum Beispiel LDAP- anstelle von TDB-Datenbank</phrase>) klicken Sie auf <guimenu>Erweiterte Einstellungen</guimenu>.

     </para>

    </sect4>
    <sect4 xml:id="sec.samba.yast2.conf.adv.trusted">
     <title>Verbürgte Domänen</title>
     <para>
      Sie ermöglichen Benutzern anderer Domänen den Zugriff auf Ihre Domäne, indem Sie die entsprechenden Einstellungen in dem Karteireiter <guimenu>Verbürgte Domänen</guimenu> vornehmen. Klicken Sie zum Hinzufügen einer neuen Domäne auf <guimenu>Hinzufügen</guimenu>. Zum Entfernen der ausgewählten Domäne klicken Sie auf <guimenu>Löschen</guimenu>.
     </para>
    </sect4>
    <sect4 xml:id="sec.samba.yast2.conf.adv.ldap">
     <title>LDAP-Einstellungen</title>
     <para>
      In dem Karteireiter <guimenu>LDAP-Einstellungen</guimenu> können Sie den LDAP-Server für die Authentifizierung festlegen. Um die Verbindung mit Ihrem LDAP-Server zu testen, klicken Sie auf <guimenu>Verbindung testen</guimenu>. LDAP-Einstellungen für Experten oder die Verwendung von Standardwerten können Sie festlegen, wenn Sie auf <guimenu>Erweiterte Einstellungen</guimenu> klicken.
     </para>
     <para>
      Weitere Informationen zur LDAP-Konfiguration finden Sie unter <xref linkend="cha.security.ldap"/>.
     </para>
    </sect4>
   </sect3>
  </sect2>



  <sect2 xml:id="sec.samba.serv.inst.manual" os="sles">
   <title>Manuelles Konfigurieren des Servers</title>
   <para>
    <indexterm> <primary>Samba</primary> <secondary>Konfigurieren</secondary> </indexterm> <indexterm> <primary>Konfigurieren</primary> <secondary>Samba</secondary> </indexterm> <indexterm> <primary>Konfigurationsdateien</primary> <secondary>smb.conf</secondary> </indexterm> Wenn Sie Samba als Server verwenden möchten, installieren Sie <systemitem class="resource">samba</systemitem>. Die Hauptkonfigurationsdatei für Samba ist <filename>/etc/samba/smb.conf</filename>. Diese Datei kann in zwei logische Bereiche aufgeteilt werden. Der Abschnitt <literal>[global]</literal> enthält die zentralen und globalen Einstellungen. Die folgenden Abschnitte enthalten die einzelnen Datei- und Druckerfreigaben:
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      [homes]
     </para>
    </listitem>
    <listitem>
     <para>
      [Profile]
     </para>
    </listitem>
    <listitem>
     <para>
      [Benutzer]
     </para>
    </listitem>
    <listitem>
     <para>
      [Gruppen]
     </para>
    </listitem>
    <listitem>
     <para>
      [Drucker]
     </para>
    </listitem>
    <listitem>
     <para>
      [drucken$]
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Mit dieser Vorgehensweise können Details der Freigaben unterschiedlich oder im Abschnitt <literal>[global]</literal> übergreifend festgelegt werden. Letzteres trägt zur Übersichtlichkeit der Konfigurationsdatei bei.
   </para>
   <sect3 xml:id="sec.samba.smb.conf.Erlaeuterung">
    <title>Der Abschnitt „global"</title>
    <para>
     Die folgenden Parameter im Abschnitt <literal>[global]</literal> sind den Gegebenheiten Ihres Netzwerkes anzupassen, damit Ihr Samba-Server in einer Windows-Umgebung von anderen Computern über SMB erreichbar ist.
    </para>
    <remark>ke: Important entries missing?</remark>
    <variablelist>
     <varlistentry>
      <term><literal>Arbeitsgruppe = ARBEITSGRUPPE</literal>
      </term>
      <listitem>
       <para>
        Mit dieser Zeile wird der Samba-Server einer Arbeitsgruppe zugeordnet. Ersetzen Sie <literal>ARBEITSGRUPPE</literal> durch eine entsprechende Arbeitsgruppe Ihrer Netzwerkumgebung. Der Samba-Server erscheint mit seinem DNS-Namen, sofern der Name noch nicht an ein anderes Gerät im Netzwerk vergeben ist. Wenn der DNS-Name nicht verfügbar ist, kann der Servername mithilfe von <literal>netbiosname=<replaceable>MEINNAME</replaceable></literal> festgelegt werden. Weitere Details zu diesem Parameter finden Sie auf der man-Seite <systemitem>smb.conf</systemitem>.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>os level = 20</literal>
      </term>
      <listitem>
       <para>
        Anhand dieses Parameters entscheidet Ihr Samba-Server, ob er versucht, LMB (Local Master Browser) für seine Arbeitsgruppe zu werden. Wählen Sie einen niedrigen Wert wie etwa <literal>2</literal>, damit ein vorhandenes Windows-Netz nicht durch einen falsch konfigurierten Samba-Server gestört wird. Weitere Informationen zu diesem wichtigen Thema finden Sie im Kapitel „Netzwerk-Browser" im Samba 3-HOWTO; weitere Informationen zum Samba 3-HOWTO finden Sie unter <xref linkend="sec.samba.info"/>.
       </para>
       <para>
        Wenn im Netzwerk kein anderer SMB-Server (z. B. ein Windows 2000-Server) vorhanden ist und der Samba-Server eine Liste aller in der lokalen Umgebung vorhandenen Systeme verwalten soll, setzen Sie den Parameter <literal>os level</literal> auf einen höheren Wert (z. B. <literal>65</literal>). Der Samba-Server wird dann als LMB für das lokale Netzwerk ausgewählt.
       </para>
       <para>
        Beim Ändern dieses Werts sollten Sie besonders vorsichtig sein, da dies den Betrieb einer vorhandenen Windows-Netzwerkumgebung stören könnte. Testen Sie Änderungen zuerst in einem isolierten Netzwerk oder zu unkritischen Zeiten.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal/>wins support und wins server<literal/>
      </term>
      <listitem>
       <para>
        Wenn Sie den Samba-Server in ein vorhandenes Windows-Netzwerk integrieren möchten, in dem bereits ein WINS-Server betrieben wird, aktivieren Sie den Parameter <option>wins server</option> und setzen Sie seinen Wert auf die IP-Adresse des WINS-Servers.
       </para>
       <para>
        Sie müssen einen WINS-Server einrichten, wenn Ihre Windows-Systeme in getrennten Subnetzen betrieben werden und sich gegenseitig erkennen sollen. Um einen Samba-Server als WINS-Server festzulegen, setzen Sie die Option <literal>wins support = Yes</literal>. Stellen Sie sicher, dass diese Einstellung nur auf einem einzigen Samba-Server im Netzwerk aktiviert wird. Die Optionen <literal>wins server</literal> und <literal>wins support</literal> dürfen in der Datei <filename>smb.conf</filename> niemals gleichzeitig aktiviert sein.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="sec.samba.smb.conf.shares">
    <title>Freigaben</title><indexterm> <primary>Samba</primary> <secondary>Freigaben</secondary> </indexterm>
    <para>
     In den folgenden Beispielen werden einerseits das CD-ROM-Laufwerk und andererseits die Verzeichnisse der Nutzer (<literal>homes</literal>) für SMB-Clients freigegeben.
    </para>
    <variablelist>
     <varlistentry>
      <term>[cdrom]</term>
      <listitem>
       <para>
        Um die versehentliche Freigabe eines CD-ROM-Laufwerks zu verhindern, sind alle erforderlichen Zeilen dieser Freigabe durch Kommentarzeichen (hier Semikolons) deaktiviert. Entfernen Sie die Semikolons in der ersten Spalte, um das CD-ROM-Laufwerk für Samba freizugeben.
       </para>
       <example xml:id="dat.cd.rom">
        <title>Eine CD-ROM-Freigabe</title>
<screen>[cdrom]
       comment = Linux CD-ROM
       path = /media/cdrom
       locking = No</screen>
       </example>
       <variablelist>
        <varlistentry>
         <term><option>[cdrom]</option> und <option>comment</option>
         </term>
         <listitem>
          <para>
           Der Abschnittseintrag <literal>[cdrom]</literal> stellt den Namen der Freigabe dar, die von allen SMB-Clients im Netzwerk gesehen werden kann. Zur Beschreibung dieser Freigabe kann ein zusätzlicher <literal>comment</literal> hinzugefügt werden.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><option>path = /media/cdrom</option>
         </term>
         <listitem>
          <para>
           <option>path</option> exportiert das Verzeichnis <filename>/media/cdrom</filename>.
          </para>
         </listitem>
        </varlistentry>
       </variablelist>
       <para>
        Diese Art der Freigabe ist aufgrund einer bewusst restriktiv gewählten Voreinstellung lediglich für die auf dem System vorhandenen Benutzer verfügbar. Soll die Freigabe für alle Benutzer bereitgestellt werden, fügen Sie der Konfiguration die Zeile <literal>guest ok = yes</literal> hinzu. Durch diese Einstellung erhalten alle Benutzer im Netzwerk Leseberechtigungen. Es wird empfohlen, diesen Parameter sehr vorsichtig zu verwenden. Dies gilt umso mehr für die Verwendung dieses Parameters im Abschnitt <literal>[global]</literal>.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>[homes]</option>
      </term>
      <listitem>
       <para>
        Eine besondere Stellung nimmt die Freigabe <option>[homes]</option> ein. Hat der Benutzer auf dem Linux-Dateiserver ein gültiges Konto und ein eigenes Home-Verzeichnis, so kann er eine Verbindung zu diesem herstellen.
       </para>
       <example xml:id="dat.homes.frei">
        <title>Freigabe [homes]</title>
<screen>[homes]
	comment = Home Directories
	valid users = %S
	browseable = No
	read only = No
	inherit acls = Yes</screen>
       </example>
       <variablelist>
        <varlistentry>
         <term>[homes]</term>
         <listitem>
          <para>
           Insoweit keine ausdrückliche Freigabe mit dem Freigabenamen des Benutzers existiert, der die Verbindung zum SMB-Server herstellt, wird aufgrund der <literal>[homes]</literal>-Freigabe dynamisch eine Freigabe generiert. Dabei ist der Freigabename identisch mit dem Benutzernamen.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><option>valid users = %S</option>
         </term>
         <listitem>
          <para>
           <literal>%S</literal> wird nach erfolgreichem Verbindungsaufbau durch den konkreten Freigabenamen ersetzt. Bei einer <option>[homes]</option>-Freigabe ist dies immer der Benutzername. Aus diesem Grund werden die Zugriffsberechtigungen auf die Freigabe eines Benutzers immer exklusiv auf den Eigentümer des Benutzerverzeichnisses beschränkt.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><option>browseable = No</option>
         </term>
         <listitem>
          <para>
           Durch diese Einstellung wird die Freigabe in der Netzwerkumgebung unsichtbar gemacht.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><option>read only = No</option>
         </term>
         <listitem>
          <para>
           Samba untersagt Schreibzugriff auf exportierte Freigaben standardmäßig mit dem Parameter <literal>read only = Yes</literal>. Soll also ein Verzeichnis als schreibbar freigegeben werden, muss der Wert <literal>read only = No</literal> festgesetzt werden, was dem Wert <literal>writeable = Yes</literal> entspricht.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><option>create mask = 0640</option>
         </term>
         <listitem>
          <para>
           Nicht auf MS Windows NT basierende Systeme kennen das Konzept der Unix-Zugriffsberechtigungen nicht, sodass sie beim Erstellen einer Datei keine Berechtigungen zuweisen können. Der Parameter <literal>create mask</literal> legt fest, welche Zugriffsberechtigungen neu erstellten Dateien zugewiesen werden. Dies gilt jedoch nur für Freigaben mit Schreibberechtigung. Konkret wird hier dem Eigentümer das Lesen und Schreiben und den Mitgliedern der primären Gruppe des Eigentümers das Lesen erlaubt. <option>valid users = %S</option> verhindert den Lesezugriff auch dann, wenn die Gruppe über Leseberechtigungen verfügt. Um der Gruppe Lese- oder Schreibzugriff zu gewähren, deaktivieren Sie die Zeile <option>valid users = %S</option>.
          </para>
         </listitem>
        </varlistentry>
       </variablelist>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="sec.samba.rechte">
    <title>Sicherheitsstufen (Security Levels)</title><indexterm xml:id="idx.Samba_security" class="startofrange"> <primary>Samba</primary> <secondary>Sicherheit</secondary> </indexterm> <indexterm> <primary>Sicherheit</primary> <secondary>Samba</secondary> </indexterm> <indexterm> <primary>Samba</primary> <secondary>Berechtigungen</secondary> </indexterm>
    <para>
     Jeder Zugriff auf eine Freigabe kann für mehr Sicherheit durch ein Passwort geschützt werden. SMB bietet die folgenden Möglichkeiten zur Überprüfung von Berechtigungen:
    </para>
    <variablelist>
     <varlistentry>
      <term>Sicherheitsstufe „Benutzer" (<literal>security = user</literal>)</term>
      <listitem>
       <para>
        Diese Variante führt das Konzept des Benutzers in SMB ein. Jeder Benutzer muss sich beim Server mit seinem Passwort anmelden. Nach der Authentifizierung kann der Server dann abhängig vom Benutzernamen Zugriff auf die einzelnen exportierten Freigaben gewähren.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term>Sicherheitsstufe „ADS" (<literal>security = ADS</literal>)</term>
      <listitem>
       <para>
        In diesem Modus fungiert Samba als Domänenmitglied in einer Active Directory-Umgebung. Für den Betrieb in diesem Modus muss auf dem Computer, auf dem Samba ausgeführt wird, Kerberos installiert und konfiguriert sein. Der Computer, auf dem Samba verwendet wird, muss in den ADS-Bereich integriert sein. Dies kann mithilfe des YaST-Moduls <guimenu>Windows-Domänenmitgliedschaft</guimenu> erreicht werden.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Sicherheitsstufe „Domäne" (<literal>security = domain</literal>)</term>
      <listitem>
       <para>
        Dieser Modus funktioniert nur korrekt, wenn der Computer in eine Windows NT-Domäne integriert wurde. Samba versucht, den Benutzernamen und das Passwort zu validieren, indem es diese an einen Window NT-Primär-Controller oder Backup Domain Controller weiterleitet. Ein Windows NT-Server wäre ausreichend. Er erwartet, dass der Parameter für das verschlüsselte Passwort auf <literal>ja</literal> festgelegt wurde.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     Die Sicherheit auf Freigabe-, Benutzer-, Server- und Domänenebene (Share, User, Server und Domain Level Security) gilt für den gesamten Server. Es ist nicht möglich, einzelne Freigaben einer Serverkonfiguration mit Share Level Security und andere mit User Level Security zu exportieren. Sie können jedoch auf einem System für jede konfigurierte IP-Adresse einen eigenen Samba-Server ausführen.
    </para>
    <para>
     Weitere Informationen zu diesem Thema finden Sie im Samba 3-HOWTO. Wenn sich mehrere Server auf einem System befinden, beachten Sie die Optionen <option>interfaces</option> und <option>bind interfaces only</option>.
    </para><indexterm class="endofrange" startref="idx.Samba_security"/>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.samba.client.inst">
  <title>Konfigurieren der Clients</title><indexterm> <primary>Samba</primary> <secondary>Clients</secondary> </indexterm>

  <para>
   Clients können auf den Samba-Server nur über TCP/IP zugreifen. NetBEUI oder NetBIOS über IPX können mit Samba nicht verwendet werden.
  </para>

  <sect2 xml:id="sec.samba.client.inst.yast">
   <title>Konfigurieren eines Samba-Clients mit YaST</title><indexterm> <primary>YaST</primary> <secondary>Samba</secondary> <tertiary>Clients</tertiary> </indexterm> <indexterm> <primary>Samba</primary> <secondary>Clients</secondary> </indexterm> <indexterm> <primary>Konfigurieren</primary> <secondary>Samba</secondary> <tertiary>Clients</tertiary> </indexterm>
   <para>
    Konfigurieren Sie einen Samba-Client, um auf Ressourcen (Dateien oder Drucker) auf dem Samba- oder Windows-Server zuzugreifen. Geben Sie im Dialogfeld <menuchoice> <guimenu>Netzwerkdienste</guimenu> <guimenu>Windows-Domänenmitgliedschaft</guimenu></menuchoice> die NT- oder Active Directory-Domäne oder -Arbeitsgruppe an. Wenn Sie <guimenu>Zusätzlich SMB-Informationen für Linux-Authentifizierung verwenden </guimenu> aktivieren, erfolgt die Benutzerauthentifizierung über den Samba&amp;#x2011;, NT- oder Kerberos-Server.
   </para>
   <para>
    Klicken Sie für erweiterte Konfigurationsoptionen auf <guimenu>Einstellungen für Experten</guimenu>. Sie können z. B. über die Tabelle <guimenu>Serververzeichnisse einhängen</guimenu> das automatische Einhängen des Server-Basisverzeichnisses bei der Authentifizierung aktivieren. Auf diese Weise können Benutzer auf ihre Home-Verzeichnisse zugreifen, wenn diese in CIFS gehostet sind. Einzelheiten finden Sie auf der man-Seite zu <systemitem>pam_mount</systemitem>.
   </para>
   <para>
    Bestätigen Sie zum Abschluss alle Einstellungen, um die Konfiguration zu beenden.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.samba.anmeld.serv">
  <title>Samba als Anmeldeserver</title><indexterm> <primary>Samba</primary> <secondary>Anmelden</secondary> </indexterm>

  <para>
   In Netzwerken, in denen sich überwiegend Windows-Clients befinden, ist es oft wünschenswert, dass sich Benutzer nur mit einem gültigen Konto und zugehörigem Passwort anmelden dürfen. In einem Windows-basierten Netzwerk wird diese Aufgabe von einem Primary Domain Controller (PDC) übernommen. Sie können einen Windows NT-Server verwenden, der als PDC konfiguriert ist; diese Aufgabe kann aber auch mithilfe eines Samba-Servers ausgeführt werden. Es müssen Einträge im Abschnitt <literal>[global]</literal> von <filename>smb.conf</filename> vorgenommen werden. Diese werden in <xref linkend="dat.samba.smb.conf.dom"/> beschrieben.
  </para>

  <example xml:id="dat.samba.smb.conf.dom">
   <title>Abschnitt „global" in smb.conf</title>
<screen>[global]
    workgroup = WORKGROUP
    domain logons = Yes
    domain master = Yes</screen>
  </example>

  <para>
   Die Benutzerkonten und Passwörter müssen in ein Windows-konformes Verschlüsselungsformat umgewandelt werden. Verwenden Sie hierfür den Befehl <command>smbpasswd</command> <option>-a name</option>. Da nach dem Windows-Domänenkonzept auch die Computer selbst ein Domänenkonto benötigen, wird dieses mit den folgenden Kommandos angelegt:
  </para>

<screen>useradd hostname\$
smbpasswd -a -m hostname</screen><indexterm> <primary>commands</primary> <secondary>smbpasswd</secondary> </indexterm>

  <para>
   Mit dem Befehl <command>useradd</command> wird ein Dollarzeichen hinzugefügt. Der Befehl <command>smbpasswd</command> fügt dieses bei der Verwendung des Parameters <option>-m</option> automatisch hinzu. In der kommentierten Beispielkonfiguration (<filename>/usr/share/doc/packages/Samba/examples/smb.conf.SuSE</filename>) sind Einstellungen enthalten, die diese Aufgabe automatisieren.
  </para>

<screen>add machine script = /usr/sbin/useradd -g nogroup -c "NT Machine Account" \
-s /bin/false %m\$
     </screen>

  <para>
   Um sicherzustellen, dass Samba dieses Skript korrekt ausführen kann, wählen Sie einen Samba-Benutzer mit den erforderlichen Administratorberechtigungen und fügen Sie ihn zur Gruppe <systemitem class="groupname">ntadmin</systemitem> hinzu. Anschließend können Sie allen Mitgliedern der Linux-Gruppe den Status <literal>Domain Admin</literal> zuweisen, indem Sie folgendes Kommando eingeben:
  </para>

<screen>net groupmap add ntgroup="Domain Admins" unixgroup=ntadmin</screen>
 </sect1>
 <sect1 xml:id="sec.samba.adnet" os="sles">
  <title>Samba-Server im Netzwerk mit Active Directory</title>

  <para>
   Wenn Sie Linux- und Windows-Server gemeinsam ausführen, können Sie zwei unabhängige Authentifizierungssysteme und -netzwerke aufbauen oder die Server mit einem Netzwerk verbinden, das über ein zentrales Authentifizierungssystem verfügt. Da Samba mit einer Active Directory-Domäne zusammenarbeitet, können Sie SUSE Linux Enterprise Server zu Active Directory (AD) beitreten lassen.
  </para>

  <para>
   So erfolgt der Beitritt zu einer AD-Domäne:
  </para>

  <procedure>
   <step>
    <para>
     Melden Sie sich als <systemitem class="username">root</systemitem> an und starten Sie YaST.
    </para>
   </step>
   <step>
    <para>
     Starten Sie <menuchoice> <guimenu>Netzwerkdienste</guimenu> <guimenu>Windows-Domänenmitgliedschaft</guimenu> </menuchoice>.
    </para>
   </step>
   <step>
    <para>
     Geben Sie die zu verbindende Domäne unter <guimenu>Domäne oder Arbeitsgruppe</guimenu> im Dialogfeld <guimenu>Windows-Domänenmitgliedschaft</guimenu> an.
    </para>
    <figure>
     <title>Festlegen der Windows-Domänenmitgliedschaft</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="ad_sambaclient.png" width="75%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="ad_sambaclient.png" width="75%" format="PNG"/>
      </imageobject>
     </mediaobject>
    </figure>
   </step>
   <step>
    <para>
     Aktivieren Sie <guimenu>Zusätzlich SMB-Informationen für Linux-Authentifikation verwenden</guimenu>, um die SMB-Quelle für die Linux-Authentifizierung unter SUSE Linux Enterprise Server zu nutzen.
    </para>
   </step>
   <step>
    <para>
     Klicken Sie auf <guimenu>OK</guimenu> und bestätigen Sie nach Aufforderung die Domänenverbindung.
    </para>
   </step>
   <step>
    <para>
     Geben Sie das Passwort für den Windows-Administrator auf dem AD-Server an und klicken Sie auf <guimenu>OK</guimenu>.
    </para>
    <para>
     Ihr Server ist jetzt so eingerichtet, dass alle Authentifizierungsdaten vom Active Directory-Domänencontroller abgerufen werden.
    </para>
   </step>
  </procedure>

  <tip>
   <para>
    In einer Umgebung mit mehreren Samba-Servern werden die UIDs und GIDs nicht einheitlich erstellt. Die UIDs, die den Benutzern zugewiesen werden, sind abhängig von der Reihenfolge, in der sich diese Benutzer erstmalig anmelden. Dies führt zu UID-Konflikten über die Server hinweg. Zur Behebung dieses Problems ist die Identitätszuordnung erforderlich. Weitere Einzelheiten finden Sie unter <link xlink:href="https://www.samba.org/samba/docs/man/Samba-HOWTO-Collection/idmapper.html"/>.
   </para>
  </tip>
 </sect1>
 <sect1 xml:id="samba.advanced">
  <title>Weitere Themen</title>

  <para>
   In diesem Abschnitt lernen Sie fortgeschrittene Vefahren zur Verwaltung des Client- und des Serverteils der Samba-Suite kennen.
  </para>

  <sect2 xml:id="samba.advanced.compress">
   <title>Transparente Dateikomprimierung mit Btrfs</title>
   <para>
    Mit Samba können die Clients die Flags für die Datei- und Verzeichniskomprimierung für Freigaben, die sich im Btrfs-Dateisystem befinden, im Fernverfahren bearbeiten. Windows Explorer bietet im Dialogfeld <menuchoice><guimenu>Datei</guimenu><guimenu>Eigenschaften</guimenu><guimenu>Erweitert</guimenu></menuchoice> die Möglichkeit, die Dateien/Verzeichnisse zur transparenten Komprimierung zu kennzeichnen:
   </para>
   <figure>
    <title>Dialogfeld <guimenu>Erweiterte Attribute</guimenu> in Windows Explorer</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="samba_win_expl_advattr.png" width="30%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="samba_win_expl_advattr.png" width="30%" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    Die zur Komprimierung gekennzeichneten Dateien werden beim Zugreifen oder Ändern transparent durch das zugrunde liegende Dateisystem komprimiert bzw. dekomprimiert. Damit sparen Sie Speicherplatz, doch beim Zugreifen auf die Datei wird die CPU stärker beansprucht. Neue Dateien und Verzeichnisse übernehmen das Komprimierungs-Flag vom übergeordneten Verzeichnis, sofern sie nicht mit der Option FILE_NO_COMPRESSION erstellt werden.
   </para>
   <para>
    Komprimierte Dateien und Verzeichnisse werden in Windows Explorer anders dargestellt als nicht komprimierte Dateien und Verzeichnisse:
   </para>
   <figure>
    <title>Windows Explorer-Anzeige mit komprimierten Dateien</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="samba_win_expl_view_compressed.png" width="30%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="samba_win_expl_view_compressed.png" width="30%" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    Sie können die Komprimierung der Samba-Freigabe wahlweise manuell aktivieren (fügen Sie hierzu
   </para>
<screen>vfs objects = btrfs</screen>
   <para>
    in die Freigabekonfiguration in <filename>/etc/samba/smb.conf</filename> ein) oder mit YaST. Wählen Sie hierzu <menuchoice><guimenu>Netzwerkdienste</guimenu><guimenu>Samba-Server</guimenu><guimenu>Hinzufügen</guimenu></menuchoice>, und aktivieren Sie die Option <guimenu>Btrfs-Funktionen verwenden</guimenu>.
   </para>
    <para os="sles">Eine allgemeine Übersicht über die Komprimierung in Btrfs finden Sie in <xref linkend="sec.filesystems.major.btrfs.compress"/>.</para>
  </sect2>

  <sect2 xml:id="samba.advanced.snapshots">
   <title>Aufnahmen</title>
   <para>
    Snapshots (auch als Schattenkopien bezeichnet) sind Kopien des Zustands eines Subvolumens in einem Dateisystem zu einem bestimmten Zeitpunkt. Die Verwaltung dieser Snapshots in Linux erfolgt mit Snapper. Die Snapshots werden auf dem Btrfs-Dateisystem sowie auf LVM-Volumes mit Thin-Provisioning unterstützt. Die Samba-Suite unterstützt die Verwaltung von Remote-Snapshots über das FSRVP-Protokoll sowohl auf Server- als auch auf Clientseite.
   </para>
   <sect3 xml:id="samba.advanced.snapshots.client">
    <title>Frühere Versionen</title>
    <para>
     Die Snapshots auf einem Samba-Server können für entfernte Windows-Clients als Datei- oder Verzeichnis-Vorgängerversionen gezeigt werden.
    </para>
    <para>
     Zum Aktivieren von Snapshots auf einem Samba-Server müssen die folgenden Voraussetzungen erfüllt sein:
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       Die SMB-Netzwerkfreigabe befindet sich auf einem Btrfs-Subvolume.
      </para>
     </listitem>
     <listitem>
      <para>
       Für den Pfad der SMB-Netzwerkfreigabe ist eine zugehörige Snapper-Konfigurationsdatei vorhanden. Sie können die Snapper-Datei wie folgt erstellen:
      </para>
<screen>snapper -c &lt;cfg_name&gt; create-config <option>/path/to/share</option></screen>
      <para>
       Weitere Informationen zu Snapper finden Sie in <xref linkend="cha.snapper"/>.
      </para>
     </listitem>
     <listitem>
      <para>
       Der Snapshot-Verzeichnisbaum muss den Zugriff für relevante Benutzer ermöglichen. Weitere Informationen finden Sie auf der man-Seite zu vfs_snapper (<command>man 8 vfs_snapper</command>) im Abschnitt zu den Berechtigungen.
      </para>
     </listitem>
    </itemizedlist>
    <para>
     Sollen Remote-Snapshots unterstützt werden,
müssen Sie die Datei <filename>/etc/samba/smb.conf</filename> bearbeiten. Verwenden Sie hierzu wahlweise <menuchoice><guimenu>YaST</guimenu><guimenu>Netzwerkdienste</guimenu><guimenu>Samba-Server</guimenu></menuchoice>, oder bearbeiten Sie den relevanten Freigabeabschnitt manuell mit
    </para>
<screen>vfs objects = snapper</screen>
    <para>
     Damit die manuellen Änderungen an <filename>smb.conf</filename> in Kraft treten, müssen Sie den Samba-Service wie folgt neu starten:
    </para>
<screen>systemctl restart nmb smb</screen>
    <figure xml:id="fig.yast2.samba.snapshot">
     <title>Hinzufügen einer neuen Samba-Freigabe mit aktivierter Snapshot-Aufnahme</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="yast2_samba_snapshot.png" width="70%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="yast2_samba_snapshot.png" width="75%" format="PNG"/>
      </imageobject>
     </mediaobject>
    </figure>
    <para>
     Nach der Konfiguration können Sie auf die Snapshots, die Snapper für den Samba-Freigabepfad erstellt hat, in Windows Explorer über die Registerkarte <guimenu>Vorgängerversionen</guimenu> für eine Datei oder ein Verzeichnis zugreifen.
    </para>
    <figure xml:id="fig.samba.win_explorer">
     <title>Die Registerkarte <guimenu>Vorgängerversionen</guimenu> in Windows Explorer</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="samba_winexpl_previous_versions.png" width="70%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="samba_winexpl_previous_versions.png" width="75%" format="PNG"/>
      </imageobject>
     </mediaobject>
    </figure>
   </sect3>
   <sect3 xml:id="samba.advanced.snapshots.server">
    <title>Remote-Snapshots für Freigaben</title>
    <para>
     Standardmäßig können Snapshots lediglich lokal auf dem Samba-Server erstellt und gelöscht werden (mit dem Kommandozeilenprogramm Snapper oder mit der Zeitleistenfunktion in Snapper).
    </para>
    <para>
     Sie können Samba so konfigurieren, dass Anfragen zum Erstellen und Löschen von Snapshots für Freigaben verarbeitet werden, die von entfernten Hosts über das FSRVP (File Server Remote VSS-Protokoll) gesendet werden.
    </para>
    <para>
     Neben den Konfigurationsschritten und Voraussetzungen in <xref linkend="samba.advanced.snapshots.client"/> ist die folgende globale Konfiguration in <filename>/etc/samba/smb.conf</filename> erforderlich:
    </para>
<screen>[global]
rpc_daemon:fssd = fork
registry shares = yes
include = registry</screen>
    <para>
     FSRVP-Clients (auch <command>rpcclient</command> in Samba und <command>DiskShadow.exe</command> in Windows Server 2012) können dann Samba anweisen, einen Snapshot für eine bestimmte Freigabe zu erstellen und den Snapshot als neue Freigabe zu zeigen.
    </para>
   </sect3>
   <sect3 xml:id="samba.advanced.snapshots.client.linux">
    <title>Fernverwaltung von Snapshots in Linux mit <command>rpcclient</command></title>
    <para>
     Das Paket <systemitem>samba-client</systemitem> umfasst einen FSRVP-Client, der im Fernverfahren eine Anfrage an einen Windows-/Samba-Server stellen kann, einen Snapshot für eine bestimmte Freigabe zu erstellen und zu zeigen. Anschließend können Sie die gezeigte Freigabe mit den vorhandenen Werkzeugen in SUSE Linux Enterprise Server einhängen und die Dateien in dieser Freigabe sichern. Die Anfragen werden über die Binärdatei <command>rpcclient</command> an den Server gesendet.
    </para>
    <example>
     <title>Anfordern eines Snapshots für eine Windows Server 2012-Freigabe mit <command>rpcclient</command></title>
     <para>
      Stellen Sie eine Verbindung zum Server <literal>win-server.example.com</literal> als Administrator in der Domäne <literal>EXAMPLE</literal> her:
     </para>
<screen># rpcclient -U '<replaceable>EXAMPLE</replaceable>\Administrator' ncacn_np:<replaceable>win-server.example.com</replaceable>[ndr64,sign]
Enter EXAMPLE/Administrator's password:</screen>
     <para>
      Überprüfen Sie, ob die SMB-Freigabe für <command>rpcclient</command> sichtbar ist:
     </para>
<screen>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)</screen>
     <para>
      Überprüfen Sie, ob die SMB-Freigabe das Erstellen von Snapshots unterstützt:
     </para>
<screen>rpcclient $&gt; fss_is_path_sup windows_server_2012_share \
UNC \\WIN-SERVER\windows_server_2012_share\ supports shadow copy requests</screen>
     <para>
      Fordern Sie die Erstellung eines Snapshots für eine Freigabe an:
     </para>
<screen>rpcclient $&gt; fss_create_expose backup ro windows_server_2012_share
13fe880e-e232-493d-87e9-402f21019fb6: shadow-copy set created
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
\\WIN-SERVER\windows_server_2012_share\ shadow-copy added to set
13fe880e-e232-493d-87e9-402f21019fb6: prepare completed in 0 secs
13fe880e-e232-493d-87e9-402f21019fb6: commit completed in 1 secs
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
share windows_server_2012_share@{1C26544E-8251-445F-BE89-D1E0A3938777} \
exposed as a snapshot of \\WIN-SERVER\windows_server_2012_share\</screen>
     <para>
      Überprüfen Sie, ob der Snapshot der Freigabe durch den Server gezeigt wird:
     </para>
<screen>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)

netname: windows_server_2012_share@{1C26544E-8251-445F-BE89-D1E0A3938777}
remark: (null)
path:   \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy{F6E6507E-F537-11E3-9404-B8AC6F927453}\Shares\windows_server_2012_share\
password:       (null)</screen>
     <para>
      Versuchen Sie, den Snapshot der Freigabe zu löschen:
     </para>
<screen>rpcclient $&gt; fss_delete windows_server_2012_share \
13fe880e-e232-493d-87e9-402f21019fb6 1c26544e-8251-445f-be89-d1e0a3938777
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
\\WIN-SERVER\windows_server_2012_share\ shadow-copy deleted</screen>
     <para>
      Überprüfen Sie, ob der Snapshot der Freigabe durch den Server entfernt wurde:
     </para>
<screen>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)</screen>
    </example>
   </sect3>
   <sect3 xml:id="samba.advanced.snapshots.client.winserver">
    <title>Fernverwaltung von Snapshots in Windows mit <command>DiskShadow.exe</command></title>
    <para>
     Sie können Snapshots von SMB-Freigaben auf dem Linux Samba-Server auch über die Windows-Umgebung, die als Client auftritt, verwalten. Mit dem Dienstprogramm <command>DiskShadow.exe</command> in Windows Server 2012 verwalten Sie Remote-Freigaben ähnlich wie mit <command>rpcclient</command> (siehe <xref linkend="samba.advanced.snapshots.client.linux"/>). Zunächst muss jedoch der Samba-Server ordnungsgemäß eingerichtet werden.
    </para>
    <para>
     Im Folgenden wird erläutert, wie Sie einen Samba-Server so konfigurieren, dass der Windows Server-Client die Snapshots der Freigaben auf dem Samba-Server verwalten kann. EXAMPLE bezeichnet hierbei die Active Directory-Domäne in der Testumgebung, fsrvp-server.example.com ist der Hostname des Samba-Servers, und <filename>/srv/smb</filename> ist der Pfad zur SMB-Freigabe.
    </para>
    <procedure>
     <title>Ausführliche Konfiguration des Samba-Servers</title>
     <step>
      <para>
       Treten Sie der Active Directory-Domäne mithilfe von YaST bei.<phrase os="sles"> Weitere Informationen, <xref linkend="sec.samba.adnet"/>.</phrase>
      </para>
     </step>
     <step>
      <para>
       Prüfen Sie, ob der DNS-Eintrag der Active Directory-Domäne korrekt ist:
      </para>
<screen>fsrvp-server:~ # net -U 'Administrator' ads dns register \
fsrvp-server.example.com &lt;IP address&gt;
Successfully registered hostname with DNS</screen>
     </step>
     <step>
      <para>
       Erstellen Sie ein Btrfs-Subvolume unter <filename>/srv/smb</filename>:
      </para>
<screen>fsrvp-server:~ # btrfs subvolume create /srv/smb</screen>
     </step>
     <step>
      <para>
       Erstellen Sie eine Snapper-Konfigurationsdatei für den Pfad <filename>/srv/smb</filename>:
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; create-config /srv/smb</screen>
     </step>
     <step>
      <para>
       Erstellen Sie eine neue Freigabe mit dem Pfad <filename>/srv/smb</filename> und aktivieren Sie in YaST das Kontrollkästchen <guimenu>Snapshots zeigen</guimenu>. Fügen Sie in jedem Fall die folgenden Snippets in den globalen Abschnitt der Datei <filename>/etc/samba/smb.conf</filename> ein (siehe <xref linkend="samba.advanced.snapshots.server"/>):
      </para>
<screen>[global]
 rpc_daemon:fssd = fork
 registry shares = yes
 include = registry</screen>
     </step>
     <step>
      <para>
       Starten Sie Samba mit <command>systemctl restart nmb smb</command> neu.
      </para>
     </step>
     <step>
      <para>
       Konfigurieren Sie die Snapper-Berechtigungen:
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; set-config \
ALLOW_USERS="EXAMPLE\\\\Administrator EXAMPLE\\\\win-client$"</screen>
      <para>
       Überprüfen Sie, ob alle unter ALLOW_USERS aufgeführten Benutzer auch die Berechtigung für das Traversal des Unterverzeichnisses <filename>.snapshots</filename> besitzen.
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; set-config SYNC_ACL=yes</screen>
      <important>
       <title>Escape-Zeichen bei Pfaden</title>
       <para>
        Gehen Sie mit dem Escape-Zeichen „\" vorsichtig vor! Setzen Sie das Escape-Zeichen zweimal, damit der Wert in <filename>/etc/snapper/configs/&lt;snapper_config&gt;</filename> ordnungsgemäß auskommentiert wird.
       </para>
      </important>
      <para>
       „EXAMPLE\win-client$" bezeichnet das Windows-Clientkonto. Die anfänglichen FSRVP-Anfragen von Windows werden mit diesem Konto ausgegeben.
      </para>
     </step>
     <step>
      <para>
       Erteilen Sie dem Windows-Clientkonto die erforderlichen Berechtigungen:
      </para>
<screen>fsrvp-server:~ # net -U 'Administrator' rpc rights grant \
"EXAMPLE\\win-client$" SeBackupPrivilege
Successfully granted rights.</screen>
      <para>
       Für den Benutzer „EXAMPLE\Administrator" muss das obige Kommando nicht ausgeführt werden, da diese Konto bereits die Berechtigungen besitzt.
      </para>
     </step>
    </procedure>
    <procedure>
     <title>Einrichten des Windows-Clients und Ausführen von <command>DiskShadow.exe</command></title>
     <step>
      <para>
       Booten Sie Windows Server 2012 (Beispiel-Hostname: WIN-CLIENT).
      </para>
     </step>
     <step>
      <para>
       Treten Sie derselben Active Directory-Domäne EXAMPLE bei wie mit dem SUSE Linux Enterprise-Server.
      </para>
     </step>
     <step>
      <para>
       Booten Sie den Computer neu.
      </para>
     </step>
     <step>
      <para>
       Öffnen Sie die Powershell.
      </para>
     </step>
     <step>
      <para>
       Starten Sie <command>DiskShadow.exe</command>, und beginnen Sie den Sicherungsvorgang:
      </para>
<screen>PS C:\Users\Administrator.EXAMPLE&gt; diskshadow.exe
Microsoft DiskShadow version 1.0
Copyright (C) 2012 Microsoft Corporation
On computer:  WIN-CLIENT,  6/17/2014 3:53:54 PM

DISKSHADOW&gt; begin backup</screen>
     </step>
     <step>
      <para>
       Geben Sie an, dass die Schattenkopie auch beim Beenden des Programms, beim Zurücksetzen und beim Neubooten erhalten bleiben soll:
      </para>
<screen>DISKSHADOW&gt; set context PERSISTENT</screen>
     </step>
     <step>
      <para>
       Überprüfen Sie, ob die angegebene Freigabe Snapshots unterstützt, und erstellen Sie einen Snapshot:
      </para>
<screen>DISKSHADOW&gt; add volume \\fsrvp-server\sles_snapper

DISKSHADOW&gt; create
Alias VSS_SHADOW_1 for shadow ID {de4ddca4-4978-4805-8776-cdf82d190a4a} set as \
 environment variable.
Alias VSS_SHADOW_SET for shadow set ID {c58e1452-c554-400e-a266-d11d5c837cb1} \
 set as environment variable.

Querying all shadow copies with the shadow copy set ID \
 {c58e1452-c554-400e-a266-d11d5c837cb1}

 * Shadow copy ID = {de4ddca4-4978-4805-8776-cdf82d190a4a}     %VSS_SHADOW_1%
    - Shadow copy set: {c58e1452-c554-400e-a266-d11d5c837cb1}  %VSS_SHADOW_SET%
    - Original count of shadow copies = 1
    - Original volume name: \\FSRVP-SERVER\SLES_SNAPPER\ \
      [volume not on this machine]
    - Creation time: 6/17/2014 3:54:43 PM
    - Shadow copy device name:
      \\FSRVP-SERVER\SLES_SNAPPER@{31afd84a-44a7-41be-b9b0-751898756faa}
    - Originating machine: FSRVP-SERVER
    - Service machine: win-client.example.com
    - Not exposed
    - Provider ID: {89300202-3cec-4981-9171-19f59559e0f2}
    - Attributes:  No_Auto_Release Persistent FileShare

Number of shadow copies listed: 1</screen>
     </step>
     <step>
      <para>
       Beenden Sie den Sicherungsvorgang:
      </para>
<screen>DISKSHADOW&gt; end backup</screen>
     </step>
     <step>
      <para>
       Versuchen Sie, den erstellten Snapshot zu löschen, und überprüfen Sie, ob er tatsächlich gelöscht wurde:
      </para>
<screen>DISKSHADOW&gt; delete shadows volume \\FSRVP-SERVER\SLES_SNAPPER\
Deleting shadow copy {de4ddca4-4978-4805-8776-cdf82d190a4a} on volume \
 \\FSRVP-SERVER\SLES_SNAPPER\ from provider \
{89300202-3cec-4981-9171-19f59559e0f2} [Attributes: 0x04000009]...

Number of shadow copies deleted: 1

DISKSHADOW&gt; list shadows all

Querying all shadow copies on the computer ...
No shadow copies found in system.</screen>
     </step>
    </procedure>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.samba.info">
  <title>Weiterführende Informationen</title>

  <para>
   Die Dokumentation zu Samba ist im Paket <systemitem>samba-doc</systemitem> enthalten, das standardmäßig nicht installiert wird. Installieren Sie das Paket mit <command>zypper install samba-doc</command>. Wenn Samba installiert ist, können Sie in die Kommandozeile <command>apropos</command> <option>samba</option> eingeben und einige man-Seiten aufrufen. Alternativ dazu finden Sie im Verzeichnis <filename>/usr/share/doc/packages/samba </filename> weitere Online-Dokumentationen und Beispiele. Eine kommentierte Beispielkonfiguration (<filename>smb.conf.SuSE</filename>) finden Sie im Unterverzeichnis <filename>examples</filename>. Auch in der Datei <filename>/usr/share/doc/packages/samba/README.SUSE</filename> finden Sie zusätzliche Informationen zu Samba. <indexterm> <primary>Konfigurationsdateien</primary> <secondary>smb.conf</secondary> </indexterm>
  </para>

  <para>
   Das Samba-Team stellt in Samba HOWTO (siehe <link xlink:href="https://wiki.samba.org"/>) einen Abschnitt zur Fehlerbehebung zur Verfügung. In Teil V ist außerdem eine ausführliche Anleitung zum Überprüfen der Konfiguration enthalten.
  </para><indexterm class="endofrange" startref="idx.Samba"/>
 </sect1>
</chapter>
