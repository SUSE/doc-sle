<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="storage_nfs.xml" version="5.0" xml:id="cha-nfs"> <title>使用 NFS 共用檔案系統</title>
 <info>
      <abstract>
        <para>
    <emphasis>網路檔案系統</emphasis> (<emphasis>NFS</emphasis>) 是允許存取伺服器上檔案的通訊協定，存取方式與存取本地檔案相似。
   </para>
        <para>
    <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server 會安裝 NFS v4.2，後者引入了對疏鬆檔案、檔案預先配置、伺服器端複製、應用程式資料區塊 (ADB) 和適用於強制性存取控制 (MAC) 的帶標籤 NFS (用戶端和伺服器上均需要 MAC) 的支援。</phrase></phrase>
   </para>
      </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:bugtracker/>
        <dm:translation>yes</dm:translation>
      </dm:docmanager>
    </info>
    <sect1 xml:id="sec-nfs-overview">
  <title>綜覽</title>
  <para>
   <emphasis>網路檔案系統</emphasis> (NFS) 是經過充分證明且受到廣泛支援的標準化網路通訊協定，它允許在單獨的主機之間共用檔案。
  </para>
  <para>
   <emphasis>網路資訊服務</emphasis> (NIS) 可用於在網路中進行集中式使用者管理。將 NFS 和 NIS 結合使用，可透過檔案和目錄權限在網路中進行存取控制。NFS 與 NIS 攜手能讓使用者對網路有清楚的瞭解。
  </para>
  <para>
   在預設組態中，NFS 完全信任網路，因此會信任連接到可信網路的任何機器。在可透過實體方式存取 NFS 伺服器所信任的任何網路的任何電腦上，任何具有管理員特權的使用者都可以存取該伺服器提供的所有檔案。
  </para>
  <para>
   一般而言，此安全性層級非常適合以下情形：所信任的網路是真正的私人網路，通常局限於單個機櫃或機房，並且無法進行未經授權的存取。將整個子網路做為一個整體信任的其他情形限制較多，需要更精密的信任機制。為了符合這些情形的需要，NFS 使用 <emphasis>Kerberos</emphasis> 基礎架構來支援各種安全性層級。Kerberos 需要 NFSv4 (預設使用該通訊協定)。如需詳細資料，請參閱<xref linkend="cha-security-kerberos"/>。
  </para>

  <para>
   YaST 模組中使用了下列詞彙。
  </para>

  <variablelist>
   <varlistentry>
    <term>輸出</term>
    <listitem>
     <para>
      由 NFS 伺服器<emphasis>輸出</emphasis>的目錄，用戶端可將該目錄整合到其系統中。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFS 用戶端</term>
    <listitem>
     <para>
      NFS 用戶端是指透過「網路檔案系統」通訊協定使用 NFS 伺服器提供之 NFS 服務的系統。TCP/IP 通訊協定已整合到 Linux 核心中；不需要安裝任何其他軟體。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFS 伺服器</term>
    <listitem>
     <para>
      NFS 伺服器向用戶端提供 NFS 服務。執行中的伺服器依賴於以下精靈運作：<systemitem class="daemon">nfsd</systemitem> (worker)、<systemitem class="daemon">idmapd</systemitem> (用於 NFSv4 的 ID 到名稱映射，僅在某些情境下需要)、<systemitem class="daemon">statd</systemitem> (檔案鎖定) 和 <systemitem class="daemon">mountd</systemitem> (掛接要求)。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFSv3</term>
    <listitem>
     <para>
      NFSv3 是第 3 版實作，即支援用戶端驗證的<quote>「舊」</quote>無狀態 NFS。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFSv4</term>
    <listitem>
     <para>
      NFSv4 是新版 (第 4 版) 實作，支援透過 Kerberos 的安全使用者驗證。NFSv4 只需要一個連接埠，因此比 NFSv3 更適合在防火牆後的環境中使用。
     </para>
     <para>
      協定的定義如 <link xlink:href="http://tools.ietf.org/html/rfc3530"/> 所示。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>pNFS</term>
    <listitem>
     <para>
      平行 NFS，NFSv4 的通訊協定延伸。所有 pNFS 用戶端都可以直接存取 NFS 伺服器上的資料。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <important os="sles;osuse">
   <title>DNS 所需</title>
   <para>
    原則上，可以只使用 IP 位址來進行所有的輸出。為了避免逾時，您需要有正常運作的 DNS 系統。即使為了記錄目的，DNS 也必不可少，因為<systemitem class="daemon">掛接的</systemitem>精靈執行的是反向查詢。
   </para>
  </important>
 </sect1>

 

 <sect1 os="sles;osuse" xml:id="sec-nfs-installation">
  <title>安裝 NFS 伺服器</title>

   <para>
   預設不會安裝 NFS 伺服器。若要使用 YaST 安裝 NFS 伺服器，請依次選擇<menuchoice> <guimenu>軟體</guimenu>
   <guimenu>軟體管理</guimenu></menuchoice>、<guimenu>模式</guimenu>，然後啟用<guimenu>伺服器功能</guimenu>區段的<guimenu>檔案伺服器</guimenu>選項。按一下<guimenu>接受</guimenu>安裝所需套件。
  </para>
  <para>
   NFS 與 NIS 一樣，都是主從式系統。但一台機器可同時扮演這兩種角色 — 它可透過網路提供檔案系統 (輸出)，也可以從其他主機掛接檔案系統 (輸入)。
  </para>

  <note>

   <title>在輸出伺服器上本地掛接 NFS 磁碟區</title>
   <para>
    <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 上不支援在輸出伺服器本地掛接 NFS 磁碟區。
   </para>
  </note>
 </sect1>
 <sect1 xml:id="sec-nfs-configuring-nfs-server" os="sles;osuse">
  <title>設定 NFS 伺服器</title>

  <para>
   NFS 伺服器可透過 YaST 來設定，也可以手動設定。若要進行驗證，還可以將 NFS 與 Kerberos 結合使用。
  </para>

  <sect2 xml:id="sec-nfs-export-yast2">
   <title>使用 YaST 輸出檔案系統</title>
   <para>
    使用 YaST，將您網路中的主機轉變為 NFS 伺服器，此類伺服器可將目錄和檔案輸出到擁有其存取權的所有主機或一個群組下的全體成員。因此，無需在每個主機上本地安裝應用程式，伺服器也可以提供應用程式。
   </para>
   <para>
    若要設定這樣的伺服器，請執行下列步驟：
   </para>
   <procedure xml:id="pro-nfs-export-yast2-nfs">
    <title>設定 NFS 伺服器</title>
    <step>
     <para>
      啟動 YaST 並選取「<menuchoice> <guimenu>網路服務</guimenu>
      <guimenu> NFS 伺服器</guimenu> </menuchoice>」；請參閱<xref linkend="fig-inst-nfsserver1"/>。系統可能會提示您安裝其他軟體。
     </para>

     <figure xml:id="fig-inst-nfsserver1">
      <title>NFS 伺服器組態工具</title>
      <mediaobject>
       <imageobject role="fo">
        <imagedata fileref="yast2_inst_nfsserver1.png" width="75%" format="PNG" os="sles;sled"/>
        
       </imageobject>
       <imageobject role="html">
        <imagedata fileref="yast2_inst_nfsserver1.png" width="75%" format="PNG" os="sles;sled"/>
        
       </imageobject>
      </mediaobject>
     </figure>

    </step>
    <step>
     <para>
      按一下<guimenu>開始</guimenu>選項圓鈕。
     </para>
    </step>
    <step>
     <para>
      如果 <systemitem class="daemon">firewalld</systemitem> 在系統上處於使用中狀態，請單獨為 NFS 設定 firewalld (請參閱<xref linkend="sec-security-firewall-firewalld"/>)。YaST 尚不完全支援 <systemitem class="daemon">firewalld</systemitem>，因此請忽略「防火牆不可設定」訊息並繼續。
     </para>
    </step>
    <step>
     <para>
      檢查是否要<guimenu>「啟用 NFSv4」</guimenu>。如果停用 NFSv4，YaST 將只支援 NFSv3。如需啟用 NFSv2 的相關資訊，請參閱<xref linkend="sec-nfs-export-manual-nsfv2"/>。
     </para>
     <substeps performance="required">
      <step>
       <para>
        如果選取 NFSv4，請另行輸入適當的 NFSv4 網域名稱。<systemitem class="daemon">idmapd</systemitem> 精靈會使用此參數。Kerberos 設定需要該精靈，當用戶端無法處理數字使用者名稱時，也需要使用該精靈。如果您不執行 <systemitem class="daemon">idmapd</systemitem> 或無任何特殊要求，請將它保留為 <literal>localdomain</literal> (預設值)。如需 <systemitem class="daemon">idmapd</systemitem> 精靈的詳細資訊，請參閱 <xref linkend="var-nfs-export-manual-idmapd"/>。
       </para>
      </step>
     </substeps>
    </step>
    <step>
     <para>
      若您需要安全存取伺服器，請按一下「<guimenu>啟用 GSS 安全性</guimenu>」。先決條件是您的網域中安裝有 Kerberos，且伺服器和用戶端都可進行 Kerberos 驗證。<remark>emap 2011-0824: A reference to a Kerberos chapter
      would be good.</remark>按<guimenu>「下一步」</guimenu>繼續執行下一個組態對話方塊。
     </para>
    </step>
    <step>
     <para>
      按一下對話方塊上半部分中的「<guimenu>新增目錄</guimenu>」以輸出目錄。
     </para>
    </step>
    <step>
     <para>
      如果您尚未設定允許的主機，系統會自動彈出另一個對話方塊，可讓您輸入用戶端資訊及選項。輸入主機萬用字元 (通常您可以保留預設設定不變)。
     </para>

     <para>
      有四種主機萬用字元類型可讓您針對各主機進行設定：單一主機 (名稱或 IP 位址)、網路群組、萬用字元 (例如 <literal>*</literal> 摽是所有機器都可存取伺服器) 以及 IP 網路。
     </para>
     <para>
      如需這些選項的詳細資訊，請參閱 <literal>exports</literal> 手冊頁。
     </para>
    </step>
    <step>
     <para>
      按一下<guimenu>完成</guimenu>以完成組態。
     </para>
    </step>
   </procedure>
  </sect2>



  <sect2 xml:id="sec-nfs-export-manual" os="sles;osuse">
   <title>手動輸出檔案系統</title>
   <para>
    NFS 輸出服務的組態檔案為 <filename>/etc/exports</filename> 和 <filename>/etc/sysconfig/nfs</filename>。如果 NFSv4 伺服器組態包含經過 Kerberos 驗證的 NFS，或者用戶端不能使用數字使用者名稱，則除了這些檔案外，還需要 <filename>/etc/idmapd.conf</filename>。
   </para>
   <para>
    若要啟動或重新啟動服務，請執行 <command>systemctl restart nfsserver</command> 指令。此指令還會將 NFS 伺服器必需的 RPC portmapper 重新啟動。
   </para>
   <para>
    為確保 NFS 伺服器永遠都會在開機時啟動，請執行 <command>sudo systemctl enable nfsserver</command>。
   </para>
   <note>
    <title>NFSv4</title>
    <para>
     NFSv4 是 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 上可用的最新版 NFS 通訊協定。現在，針對 NFSv4 輸出的目錄設定方法與 NFSv3 相同。
    </para>
    <para>
     在 <phrase os="sles;sled">SUSE Linux Enterprise Server 11</phrase> 上，必須在 <filename>/etc/exports</filename> 中指定結合掛接。現在仍支援此方式，但已有了取代方案。
    </para>
   </note>
   <variablelist>
    <varlistentry>
     <term><filename>/etc/exports</filename></term>
     <listitem>
      <para>
       <filename>/etc/exports</filename> 檔案包含一份項目清單。每一個項目都指出一個共用的目錄，並記錄它的共用方式。<filename>/etc/exports</filename> 中的典型項目會包含：
      </para>
<screen>/<replaceable>SHARED</replaceable>/<replaceable>DIRECTORY</replaceable>   <replaceable>HOST</replaceable>(<replaceable>OPTION_LIST</replaceable>)</screen>
      <para>
       例如：
      </para>
<screen>/export/data   192.168.1.2(rw,sync)</screen>
      <para>
       這裡使用了 IP 位址 <literal>192.168.1.2</literal>，以識別允許的用戶端。您也可以使用主機的名稱以及指向一組主機 (<literal>*.abc.com</literal>、<literal>*</literal> 等) 或網路群組 (<literal>@my-hosts</literal>) 的萬用字元。
      </para>
      <para>
       如需所有選項及其意義的詳細說明，請參閱 <filename>/etc/exports</filename> 的 <literal>man</literal> 頁面 (<command>man exports</command>)。
      </para>
      <para>
       如果您在 NFS 伺服器執行時修改了 <filename>/etc/exports</filename>，則需使用 <command>sudo systemctl restart nfsserver</command> 指令重新啟動 NFS 伺服器，以使變更生效。
      </para>

     </listitem>
    </varlistentry>
    <varlistentry>
     <term><filename>/etc/sysconfig/nfs</filename></term>
     <listitem>
      <para>
       <filename>/etc/sysconfig/nfs</filename> 檔案包含一些決定 NFSv4 伺服器精靈行為的參數。參數 <systemitem>NFS4_SUPPORT</systemitem> 必須設定為 <literal>yes</literal> (預設值)。<systemitem>NFS4_SUPPORT</systemitem> 決定 NFS 伺服器是否支援 NFSv4 輸出和用戶端。
      </para>
      <para>
       如果您在 NFS 伺服器執行時修改了 <filename>/etc/sysconfig/nfs</filename>，則需使用 <command>sudo systemctl restart nfsserver</command> 指令重新啟動 NFS 伺服器，以使變更生效。
      </para>
      <tip>
       <title>裝載選項</title>
       <para>
        在 <phrase os="sles;sled">SUSE Linux Enterprise Server 11</phrase> 上，必須在 <filename>/etc/exports</filename> 中指定 <option>--bind</option> 掛接。現在仍支援此方式，但已有了取代方案。現在，針對 NFSv4 輸出的目錄設定方法與 NFSv3 相同。
       </para>
      </tip>
      <note xml:id="sec-nfs-export-manual-nsfv2">

       <title>NFSv2</title>
       <para>
        如果 NFS 用戶端仍相依於 NFSv2，可透過以下設定在伺服器的 <filename>/etc/sysconfig/nfs</filename> 中將其啟用：
       </para>
<screen>NFSD_OPTIONS="-V2"
MOUNTD_OPTIONS="-V2"</screen>
       <para>
        重新啟動服務後，執行以下指令檢查版本 2 是否可使用：
       </para>
<screen><prompt>tux &gt; </prompt>cat /proc/fs/nfsd/versions
+2 +3 +4 +4.1 +4.2</screen>
      </note>
     </listitem>
    </varlistentry>
    <varlistentry xml:id="var-nfs-export-manual-idmapd">
     <term><filename>/etc/idmapd.conf</filename></term>
     <listitem>
      <para>
       僅當使用 Kerberos 驗證或用戶端不能使用數字使用者名稱時，才需要 <systemitem class="daemon">idmapd</systemitem> 精靈。自 Linux 核心 2.6.39 起，Linux 用戶端可以使用數字使用者名稱。<systemitem class="daemon">idmapd</systemitem> 精靈會將傳送到伺服器的 NFSv4 要求進行名稱到 ID 的映射，並回覆用戶端。
      </para>
      <para>
       如果需要，<systemitem class="daemon">idmapd</systemitem> 需在 NFSv4 伺服器上執行。用戶端上的名稱到 ID 映射將由以下套件提供的 <command>nfsidmap</command> 來執行：
       <package>nfs-client</package>。
      </para>
      <para>
       對於可能使用 NFS 來共用檔案系統的機器，請確定以統一的方式在這些機器間為使用者指定使用者名稱和 ID (UID)。您可以透過 NIS、LDAP 或您網域中的任何統一網域驗證機制來達成這個目的。
      </para>
      <para>
       在 <filename>/etc/idmapd.conf</filename> 檔案中，必須為用戶端和伺服器設定相同的 <literal>Domain</literal> 參數。如果您不確定，請讓伺服器和用戶端檔案中的網域保持為 <literal>localdomain</literal>。我們在此提出一個組態檔案的例子，如下所示：
      </para>
<screen>[General]
Verbosity = 0
Pipefs-Directory = /var/lib/nfs/rpc_pipefs
Domain = localdomain

[Mapping]
Nobody-User = nobody
Nobody-Group = nobody</screen>
      <para>
       若要啟動 <systemitem class="daemon">idmapd</systemitem> 精靈，請執行 <command>systemctl start nfs-idmapd</command>。如果您在精靈執行時修改了 <filename>/etc/idmapd.conf</filename>，則需使用 <command>systemctl start nfs-idmapd</command> 指令重新啟動精靈，以使變更生效。
      </para>
      <para>
       如需更多資訊，請參閱 <literal>idmapd</literal> 與 <literal>idmapd.conf</literal> 的手冊頁 (<literal>man idmapd</literal> 與 <literal>man idmapd.conf</literal>)。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>



  <sect2 xml:id="sec-nfs-kerberos">
   <title>NFS 配合使用 Kerberos</title>
   <para>
    若要讓 NFS 使用 Kerberos 驗證，必須啟用一般安全性服務 (GSS)。在初始 YaST NFS 伺服器對話方塊中選取「<guimenu>啟用 GSS 安全性</guimenu>」。您必須有一個工作中的 Kerberos 伺服器才能使用此功能。YaST 不會設定伺服器，而只是使用所提供的功能。若要使用 Kerberos 進行驗證，除了 YaST 組態外，至少還須完成以下步驟才能執行 NFS 組態：
   </para>
   <procedure>
    <step>
     <para>
      請確定伺服器和用戶端位於相同的 Kerberos 領域中。它們必須存取相同的 KDC (金鑰配送中心) 伺服器，並共用它們的 <filename>krb5.keytab</filename> 檔案 (所有機器上的預設位置都是 <filename>/etc/krb5.keytab</filename>)。如需有關 Kerberos 的詳細資訊，請參閱<xref linkend="cha-security-kerberos"/>
     </para>
    </step>
    <step>
     <para>
      在用戶端上執行 <command>systemctl start rpc-gssd.service</command> 以啟動 gssd 服務。
     </para>
    </step>
    <step os="sles;osuse">
     <para>
      在伺服器上執行 <command>systemctl start rpc-svcgssd.service</command> 以啟動 svcgssd 服務。
     </para>
    </step>
   </procedure>
   <para>
    若要進行 Kerberos 驗證，也需要在伺服器上執行 <systemitem class="daemon">idmapd</systemitem> 精靈。若需更多資訊，請參閱<xref linkend="var-nfs-export-manual-idmapd"/>。
   </para>
   <para>
    如需有關設定啟用 Kerberos 之 NFS 的詳細資訊，請參閱<xref linkend="sec-nfs-info" xrefstyle="SectTitleOnPage"/> 中的連結所提供的內容。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-nfs-configuring-nfs-clients">
  <title>設定用戶端</title>

  <para>
   您不需安裝其他軟體就能將您的主機設定為 NFS 用戶端。所有需要的套件預設都會安裝。
  </para>

  <sect2 xml:id="sec-nfs-import-yast2">
   <title>使用 YaST 輸入檔案系統</title>
   <para>
    授權使用者可以使用 YaST NFS 用戶端模組將NFS 目錄從 NFS 伺服器掛接到本地檔案樹。請執行下列步驟：
   </para>
   <procedure xml:id="pro-nfs-import-yast2">
    <title>輸入 NFS 目錄</title>
    <step>
     <para>
      啟動 YaST NFS 用戶端模組。
     </para>
    </step>

    <step>
     <para>
      在「<guimenu>NFS 共用</guimenu>」索引標籤中按一下「<guimenu>新增</guimenu>」。輸入 NFS 伺服器的主機名稱、要輸入的目錄和在本地掛接此目錄的掛接點。
     </para>
    </step>


    <step>
     <para>
      使用 NFSv4 時，在 <guimenu>NFS 設定</guimenu>索引標籤中選取<guimenu>啟用 NFSv4</guimenu>。另外，<guimenu>「NFSv4 網域名稱」</guimenu>必須包含 NFSv4 伺服器所用的相同值。預設網域為 <literal>localdomain</literal>。
     </para>
    </step>
    <step>
     <para>
      若要為 NFS 使用 Kerberos 驗證，則 GSS 安全性必須啟用。選取<guimenu>「啟用 GSS 安全性」</guimenu>。
     </para>
    </step>
    <step>
     <para>
      如果您使用防火牆並希望允許從遠端電腦存取服務，請啟用 <guimenu>NFS 設定</guimenu>索引標籤中的<guimenu>在防火牆中開啟埠</guimenu>。防火牆的狀態顯示於核取方塊旁。
     </para>
    </step>

    <step>
     <para>
      按一下<guimenu>「確定」</guimenu>，儲存變更。
     </para>
    </step>
   </procedure>
   <para>
    組態將會寫入 <filename>/etc/fstab</filename> 中，並會掛接指定的檔案系統。當您稍後啟動 YaST 組態用戶端時，它也會從這個檔案讀取現有組態。
   </para>
   <tip>
    <title>用做根檔案系統的 NFS</title>
    <para>
     在透過網路將根分割區掛接為 NFS 共用的 (無磁碟) 系統中，設定 NFS 共用可供存取的網路裝置時請保持謹慎。
    </para>
    <para>
     將系統關閉或重新開機時，預設的處理順序是先關閉網路連接，然後卸載根分割區。對於 NFS 根檔案系統，這種順序會造成問題，因為在已停用與 NFS 共用的網路連接的情況下，根分割區無法完全卸載。為防止系統停用相關的網路裝置，請依<xref linkend="sec-network-yast-change-start"/>中所述開啟網路裝置組態索引標籤，然後在<guimenu>裝置啟動</guimenu>窗格中選取<guimenu>在 NFSroot 時</guimenu>。
    </para>
   </tip>

  </sect2>

  <sect2 xml:id="sec-nfs-import">
   <title>手動輸入檔案系統</title>


   <para>
    從 NFS 伺服器手動輸入檔案系統的先決條件是有 RPC 埠對應程式正在執行。<option>nfs</option> 服務負責正確啟動該程式；因此，請以 <systemitem class="username">root</systemitem> 身分輸入 <command>systemctl start nfs</command>，以啟動該服務。然後就可以像處理本地分割區一樣，使用 <command>mount</command> 指令在檔案系統中掛接遠端檔案系統：
   </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> mount <replaceable>HOST</replaceable>:<replaceable>REMOTE-PATH</replaceable><replaceable>LOCAL-PATH</replaceable></screen>
   <para>
    例如，若要從 <systemitem>nfs.example.com</systemitem> 機器輸入使用者目錄，可以使用：
   </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> mount nfs.example.com:/home /home</screen>
   <para>
    若要定義用戶端到 NFS 伺服器的 TCP 連接計數，可以使用 <command>mount</command> 指令的 <literal>nconnect</literal> 選項。您可以指定介於 1 到 16 之間的任何數字，其中 1 是預設值 (如果未指定掛接選項)。
   </para>
   <para>
    僅會在第一次掛接程序中針對特定 NFS 伺服器套用 <literal>nconnect</literal> 設定。如果同一用戶端針對同一 NFS 伺服器執行掛接指令，則將共用所有已建立的連接，而不會建立新的連接。若要變更 <literal>nconnect</literal> 設定，必須卸載與特定 NFS 伺服器的<emphasis role="bold">所有</emphasis>用戶端連接。然後，您可以為 <literal>nconnect</literal> 選項定義一個新值。
   </para>
   <para>
    您可以在 <command>mount</command> 的輸出或檔案 <filename>/proc/mounts</filename> 中找到目前有效的 <literal>nconnect</literal> 值。如果掛接選項沒有值，則在掛接期間不會使用該選項，而是使用預設值 <emphasis>1</emphasis>。
   </para>
   <note>
    <title>連接數與 <literal>nconnect</literal> 定義的不同</title>
    <para>
     由於您可以在第一次掛接後關閉和開啟連接，因此實際連接計數不必與 <literal>nconnect</literal> 的值相同。
    </para>
   </note>
   
   <sect3 xml:id="sec-nfs-automount">
    <title>使用自動掛接服務</title>
    <para>
     autofs 精靈可用於自動掛接遠端檔案系統。請將下列項目加入 <filename>/etc/auto.master</filename> 檔案：
    </para>
<screen>/nfsmounts /etc/auto.nfs</screen>
    <para>
     如果能正確填入 <filename>auto.nfs</filename> 檔案，<filename>/nfsmounts</filename> 目錄此後便會成為用戶端上所有 NFS 掛接作業的根部。選擇 <filename>auto.nfs</filename> 這個名稱是從方便角度考量，您可以自行選擇任何名稱。使用以下指令在 <filename>auto.nfs</filename> 中為所有 NFS 掛接作業新增項目：
    </para>
<screen>localdata -fstype=nfs server1:/data
nfs4mount -fstype=nfs4 server2:/</screen>
    <para>
     以 <systemitem class="username">root</systemitem> 身分執行 <command>systemctl start autofs</command> 以啟動設定。在此範例中，<systemitem>server1</systemitem> 的 <filename>/data</filename> 目錄 <filename>/nfsmounts/localdata</filename> 會掛接 NFS，而 <systemitem>server2</systemitem> 的 <filename>/nfsmounts/nfs4mount</filename> 會掛接 NFSv4。
    </para>
    <para>
     如果在 autofs 服務執行期間有程式編輯了 <filename>/etc/auto.master</filename> 檔案，則必須使用 <command>systemctl restart autofs</command> 重新啟動自動掛載器，才能使變更生效。
    </para>
   </sect3>
   <sect3 xml:id="sec-nfs-fstab">
    <title>手動編輯 <filename>/etc/fstab</filename></title>
    <para>
     <filename>/etc/fstab</filename> 中典型的 NFSv3 掛接項目如下：
    </para>
<screen>nfs.example.com:/data /local/path nfs rw,noauto 0 0</screen>
    <para>
     對於 NFSv4 掛接，請在第三欄中使用 <literal>nfs4</literal> 而不是 <literal>nfs</literal>：
    </para>
<screen>nfs.example.com:/data /local/pathv4 nfs4 rw,noauto 0 0</screen>
    <para>
     <literal>noauto</literal> 選項可防止在啟動時自動掛接檔案系統。如果要手動掛接各檔案系統，可以縮短掛接指令的長度，僅指定掛接點：
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> mount /local/path</screen>
    <note>
     <title>啟動時掛接</title>
     <para>
      請注意，如果未輸入 <literal>noauto</literal> 選項，系統的 init 程序檔會在啟動時處理這些檔案系統的掛接。
     </para>
    </note>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-nfs-pnfs">
   <title>平行 NFS (pNFS)</title>
   <para>
    NFS 是最舊的通訊協定之一，開發於八十年代。雖然如此，NFS 對於共用小型檔案還是綽綽有餘的。但是，當您要傳輸大型檔案或有大量的用戶端要存取資料時，NFS 伺服器會成為瓶頸，嚴重影響系統效能。出現這種情況的原因是檔案快速增大，而乙太網路的相對速度無法完全跟上這一變化。
   </para>
   <para>
    當您向一般 NFS 伺服器要求檔案時，伺服器會尋找檔案中繼資料、收集所有資料，並透過網路將資料傳輸到您的用戶端。但是，不論檔案的大小，效能瓶頸都會變得很明顯：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      對於小型檔案，大部分時間都用在收集中繼資料上。
     </para>
    </listitem>
    <listitem>
     <para>
      對於大型檔案，大部分時間則用在將資料從伺服器傳輸至用戶端上。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    pNFS (或平行 NFS) 克服了這個局限性，因為它將檔案系統中繼資料與資料位置分隔開來。因此，pNFS 需要兩種類型的伺服器：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      <emphasis>中繼資料</emphasis>或<emphasis>控制伺服器</emphasis>，用於處理所有非資料流量
     </para>
    </listitem>
    <listitem>
     <para>
      一或多個<emphasis>儲存伺服器</emphasis>，用於存放資料
     </para>
    </listitem>
   </itemizedlist>
   <para>
    中繼資料與儲存伺服器構成了一個邏輯 NFS 伺服器。當用戶端想要讀取或寫入時，中繼資料伺服器會告知 NFSv4 用戶端使用哪個儲存伺服器來存取檔案區塊。用戶端可以直接存取伺服器上的資料。
   </para>
   <para>
    <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 僅在用戶端上支援 pNFS。
   </para>
   <sect3 xml:id="sec-nfs-pnfs-yast">
    <title>使用 YaST 設定 pNFS 用戶端</title>
    <para>
     依<xref linkend="pro-nfs-import-yast2"/> 中所示繼續操作，但要按一下「<guimenu>pNFS (v4.2)</guimenu>」核取方塊並選擇性地按一下「<guimenu>NFSv4 共用</guimenu>」。YaST 會執行所有必要的步驟，並將所有需要的選項寫入檔案 <filename>/etc/exports</filename>。
    </para>
   </sect3>
   <sect3 xml:id="sec-nfs-pnfs-manual">
    <title>手動設定 pNFS 用戶端</title>
    <para>
     請參閱<xref linkend="sec-nfs-import"/> 開始設定。大部分組態均由 NFSv4 伺服器執行。對於 pNFS，唯一的差異是將 <option>minorversion</option> 選項和中繼資料伺服器 <replaceable>MDS 伺服器</replaceable>新增至 <command>mount</command> 指令：
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> mount -t nfs4 -o minorversion=1 <replaceable>MDS_SERVER</replaceable> <replaceable>MOUNTPOINT</replaceable></screen>
    <para>
     為了協助進行除錯，請在 <filename>/proc</filename> 檔案系統中變更該值：
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> echo 32767 &gt; /proc/sys/sunrpc/nfsd_debug
<prompt>tux &gt; </prompt><command>sudo</command> echo 32767 &gt; /proc/sys/sunrpc/nfs_debug</screen>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="nfs4-acls" os="sles;osuse">
  <title>透過 NFSv4 管理存取控制清單</title>
  <para>
   除了針對使用者、群組和其他人 (<literal>ugo</literal>) 的簡單讀取、寫入、執行 (<literal>rwx</literal>) 旗標之外，Linux 中的各存取控制清單 (ACL) 之間沒有統一的標準。控制能力相對較好的一個選擇是 POSIX 從未正式標準化的《<citetitle>Draft POSIX ACLs</citetitle>》(POSIX ACL 草稿)。另一個選擇是 NFSv4 ACL，它們設計為 NFSv4 網路檔案系統的一部分，目的是為 Linux 上的 POSIX 系統與 Microsoft Windows 上的 WIN32 系統之間提供合理的相容性。
  </para>
  <para>
   NFSv4 ACL 不能完全正確實作 Draft POSIX ACL，因此未在 NFSv4 用戶端上對應 ACL 存取權 (例如使用 <command>setfacl</command>)。
  </para>
  <para>
   使用 NFSv4 時，無法使用 Draft POSIX ACL (即使是在模擬環境中)，必須直接使用 NFSv4 ACL；換言之，雖然 <command>setfacl</command> 可以在 NFSv3 上運作，但不能在 NFSv4 上運作。為了能夠在 NFSv4 檔案系統上使用 NFSv4 ACL，SUSE Linux Enterprise Server 提供了 <filename>nfs4-acl-tools</filename> 套件，套件中包含下列各項：
  </para>
  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     <command>nfs4-getfacl</command>
    </para>
   </listitem>
   <listitem>
    <para>
     <command>nfs4-setfacl</command>
    </para>
   </listitem>
   <listitem>
    <para>
     <command>nfs4-editacl</command>
    </para>
   </listitem>
  </itemizedlist>
  <para>
   它們的運作方式與用於檢查和修改 NFSv4 ACL 的 <command>getfacl</command> 和 <command>setfacl</command> 類似。僅當 NFS 伺服器上的檔案系統提供對 NFSv4 ACL 的全面支援時，這些指令才起作用。雖然某些存取控制項目 (ACE) 的特定組合可能在用戶端中不可用，但用戶端上執行的程式都將受到伺服器所實作之任何限制的影響。
  </para>
  <para>
   不支援在輸出 NFS 伺服器本地掛接 NFS 磁碟區。
  </para>
  <bridgehead>其他資訊</bridgehead>
  <para>
   如需相關資訊，請參閱「<citetitle>Introduction to NFSv4 ACLs</citetitle>」(NFSv4 ACL 簡介，網址為 <link xlink:href="http://wiki.linux-nfs.org/wiki/index.php/ACLs#Introduction_to_NFSv4_ACLs"/>)。
  </para>
 </sect1>
 <sect1 xml:id="sec-nfs-info">
  <title>更多資訊</title>
  <para>
   除了 <command>exports</command>、<command>nfs</command> 和 <command>mount</command> 的 man 頁面以外，<filename>/usr/share/doc/packages/nfsidmap/README</filename> 中也提供了有關設定 NFS 伺服器和用戶端的資訊。如需更多線上文件，請參閱下列網站：
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     如需網路安全的一般資訊，請參閱<xref linkend="cha-security-firewall"/>。
    </para>
   </listitem>
   <listitem>
    <para>
     如果您需要自動掛接 NFS 輸出，請參閱<xref linkend="sec-autofs-nfs"/>。
    </para>
   </listitem>
   <listitem>
    <para>
     如需使用 AutoYaST 設定 NFS 的更多詳細資料，請參閱<xref linkend="ay-nfs"/>。
    </para>
   </listitem>
   <listitem>
    <para>
     如需使用 Kerberos 保護 NFS 輸出安全的說明，請參閱<xref linkend="sec-security-kerberos-nfs"/>。
    </para>
   </listitem>
   <listitem>
    <para>
     如需詳細的線上技術文件，請造訪 <link xlink:href="http://nfs.sourceforge.net/">SourceForge</link>。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 
 <sect1 xml:id="sec-nfs-troubleshooting">
  <title>收集資訊以供 NFS 疑難排解</title>
   <sect2 xml:id="sec-nfs-common-troubleshooting">
    <title>常見疑難排解</title>
     <para>
      在某些情況下，您可以透過讀取產生的錯誤訊息並查看 <filename>/var/log/messages</filename> 檔案來瞭解 NFS 中的問題。但在許多情況下，錯誤訊息和 <filename>/var/log/messages</filename> 中所提供的資訊都不夠詳細。此時，您可透過在重現問題時擷取網路封包來充分瞭解大部分 NFS 問題。
     </para>
 
     <para>
      明確定義問題。透過以各種方式測試系統並確定問題的發生時間來檢查問題。隔離會導致問題的最簡單步驟。然後嘗試依照下面程序中所述重現問題。
     </para>
 
     <procedure>
      <title>重現問題</title>
       <step>
        <para>
         擷取網路封包。在 Linux 上，您可以使用 <command>tcpdump</command> 指令，該指令由
         <package>tcpdump</package> 套件提供。
        </para>
        <para>
         <command>tcpdump</command> 語法的範例如下：
        </para>
<screen>tcpdump -s0 -i <replaceable>eth0</replaceable> -w <replaceable>/tmp/nfs-demo.cap</replaceable> host <replaceable>x.x.x.x</replaceable></screen>
        <para>
         地點:
        </para>
        <variablelist>
         <varlistentry>
          <term>s0</term>
          <listitem>
           <para>阻止封包截斷
           </para> 
          </listitem>
         </varlistentry>
         <varlistentry>
          <term>eth0</term>
          <listitem>
           <para>
            應以將傳遞封包的本地介面的名稱取代 。您可以使用 <literal>any</literal> 值同時擷取所有介面，但使用此屬性通常會導致資料品質下降並造成分析混亂。
           </para>
          </listitem>
         </varlistentry>
         <varlistentry>
          <term>w</term>
         <listitem>
          <para>
           指定要寫入的擷取檔案的名稱。
          </para>
         </listitem>
         </varlistentry>
         <varlistentry>
          <term>x.x.x.x</term>
          <listitem>
           <para>
            應以 NFS 連接另一端的 IP 位址取代。例如，在 NFS 用戶端取得 <command>tcpdump</command> 時，請指定 NFS 伺服器的 IP 位址，反之亦然。
           </para>
          </listitem>
         </varlistentry>
        </variablelist>
       <note>
        <para>
         在某些情況下，只需在 NFS 用戶端或 NFS 伺服器任一端擷取資料就足夠了。但如果不確定端到端網路的完整性，則通常需要在兩端擷取資料。
        </para>
       </note>
       <para>
        請不要關閉 <command>tcpdump</command> 程序並繼續下一步。
       </para>
      </step>
      <step>
       <para>
        (選擇性) 如果問題發生在 <command>nfs mount</command> 指令自身執行期間，您可以嘗試使用 <command>nfs mount</command> 指令的高詳細程度選項 (<literal>-vvv</literal>) 來取得更多輸出。
       </para>
  </step>
  <step>
   <para>
    (選擇性) 取得重現方法的 <command>strace</command>。重現步驟的 <command>strace</command> 精確記錄了發生系統呼叫的確切時間。此資訊可用於進一步確定您應在 <literal>tcpdump</literal> 中關注哪些事件。
   </para>
   <para>
    例如，如果您發現在 NFS 掛接上執行 <emphasis>mycommand --param</emphasis> 指令失敗，則可以使用以下指令來 <command>strace</command> 指令：
   </para>
<screen>strace -ttf -s128 -o/tmp/nfs-strace.out mycommand --param</screen>
   <para>
    如果您未取得任何重現步驟的 <command>strace</command>，請注意問題的重現時間。檢查 <filename>/var/log/messages</filename> 記錄檔案以隔離問題。
   </para>
  </step>
  <step>
   <para>
    一旦問題重現，按 <keycombo><keycap>CTRL</keycap><keycap>c</keycap></keycombo> 來停止在終端機中執行的 <command>tcpdump</command>。如果 <command>strace</command> 指令導致掛斷，還需要終止 <command>strace</command> 指令。
   </para>
  </step>
  <step>
   <para>
    現在，擁有分析封包追蹤和 <command>strace</command> 資料經驗的管理員便可以檢查 <filename>/tmp/nfs-demo.cap</filename> 和 <filename>/tmp/nfs-strace.out</filename> 中的資料。
   </para>
  </step>  
  </procedure>
 </sect2>
 
 <sect2 xml:id="sec-advance-debugging">
  <title>進階 NFS 除錯</title>
   <important>
    <title>進階除錯適用於進階使用者</title>
    <para>
     請注意，以下小節僅適用於瞭解 NFS 代碼的專業 NFS 管理員。因此，請執行<xref linkend="sec-nfs-common-troubleshooting"/>中所述的第一步，以縮小問題範圍，並告知專家可能需要哪些方面的除錯代碼 (如果有) 才能瞭解更深入的詳細資料。</para>
   </important>
   <para>
    可啟用各種除錯代碼來收集額外的 NFS 相關資訊。不過，除錯訊息非常晦澀難懂，並且數量巨大，因此使用除錯代碼可能會影響系統效能。它甚至有可能對系統產生的影響大到足以阻止問題的發生。大多數情況下都不需要除錯代碼輸出，對於不太熟悉 NFS 代碼的人來說，通常也沒什麼用。  
   </para>
 
   <sect3 xml:id="sec-rpcdebug">
    <title>使用 <command>rpcdebug</command> 啟用除錯</title>
    <para>
     <command>rpcdebug</command> 工具可讓您設定和清除 NFS 用戶端和伺服器除錯旗標。如果在您的 SLE 中無法存取 <command>rpcdebug</command> 工具，則可以從 NFS 伺服器的套件
     <package>nfs-client</package> 或 <package>nfs-kernel-server</package> 安裝該工具。
    </para>
    <para>
     若要設定除錯旗標，請執行：
    </para>
<screen>rpcdebug -m <replaceable>module</replaceable> -s flags</screen>
    <para>
     若要清除除錯旗標，請執行：
    </para>
<screen>rpcdebug -m <replaceable>module</replaceable> -c flags</screen>
    <para>
     其中，<replaceable>module</replaceable> 可以是：
    </para>
    <variablelist>
     <varlistentry>
      <term>nfsd</term>
      <listitem>
      <para>
       NFS 伺服器代碼的除錯
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>nfs</term>
      <listitem>
      <para>
       NFS 用戶端代碼的除錯
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>nlm</term>
      <listitem>
       <para>
        NFS 鎖定管理員除錯 (在 NFS 用戶端或 NFS 伺服器端)。僅適用於 NFS v2/v3。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>rpc</term>
      <listitem>
      <para>
       遠端程序呼叫模組除錯 (在 NFS 用戶端或 NFS 伺服器端)。
      </para>
     </listitem>
    </varlistentry> 
   </variablelist>
   <para>
    如需 <command>rpcdebug</command> 指令詳細用法的資訊，請參閱手冊頁：
   </para>
<screen>man 8 rpcdebug</screen>
  </sect3>
 
 <sect3 xml:id="sec-other-nfs-debug">
  <title>針對 NFS 相依的其他代碼啟用除錯</title>
  <para>
   NFS 活動可能依賴於其他相關服務，例如 NFS 掛接精靈—<command>rpc.mountd</command>。您可以在 <filename>/etc/sysconfig/nfs</filename> 中為相關服務設定選項。
  </para>
  <para>
   例如，<filename>/etc/sysconfig/nfs</filename> 包含以下參數：
  </para>
<screen>MOUNTD_OPTIONS=""</screen>
  <para>
   若要啟用除錯模式，必須使用 <literal>-d</literal> 選項，後跟以下任何值：<literal>all</literal>、<literal>auth</literal>、<literal>call</literal>、<literal>general</literal> 或 <literal>parse</literal>。
  </para>
  <para>
   例如，以下代碼可啟用所有形式的 <command>rpc.mountd</command> 記錄：
  </para>
<screen>MOUNTD_OPTIONS="-d all"</screen>
  <para>
   如需所有可用選項，請參閱手冊頁：
  </para>
<screen>man 8 rpc.mountd</screen>
  <para>
   變更 <filename>/etc/sysconfig/nfs</filename> 後，需要重新啟動服務：
  </para>
<screen>systemctl restart nfsserver  # for nfs server related changes
systemctl restart nfs  # for nfs client related changes</screen>
   </sect3>
  </sect2>
 </sect1>
</chapter>
