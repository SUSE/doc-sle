<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="vt_installation.xml" version="5.0" xml:id="cha-vt-installation">
  <title>安装虚拟化组件</title>
  <info>
    <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
      <dm:bugtracker/>
      <dm:translation>yes</dm:translation>
    </dm:docmanager>
  </info>
  <sect1 xml:id="introduction-install-virtualization-components">
    <title>简介</title>

    <para>
      要运行可托管一个或多个 Guest 系统 (VM Guest) 的虚拟化服务器（VM 主机服务器），需要在该服务器上安装所需的虚拟化组件。这些组件根据您要使用的虚拟化技术而异。
    </para>
  </sect1>
  <sect1 xml:id="install-virtualization-components">
    <title>安装虚拟化组件</title>

    <para>
      可通过以下方式之一安装运行 VM 主机服务器所需的虚拟化工具：
    </para>

    <itemizedlist>
      <listitem>
        <para>
          在 VM 主机服务器上安装 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 期间选择特定的系统角色
        </para>
      </listitem>
      <listitem>
        <para>
          在已安装并正在运行的 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 上运行 <emphasis>YaST 虚拟化</emphasis>模块。
        </para>
      </listitem>
      <listitem>
        <para>
          在已安装并正在运行的 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 上安装特定的安装软件集。
        </para>
      </listitem>
    </itemizedlist>

    <sect2 xml:id="install-virtualization-components-system-role">
      <title>指定系统角色</title>
      <para>
        可以在 VM 主机服务器上安装 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 期间安装虚拟化所需的所有工具。在安装期间，您会看到<guimenu>系统角色</guimenu>屏幕。
      </para>
      <figure>
        <title>“系统角色”屏幕</title>
        <mediaobject>
          <imageobject role="fo">
            <imagedata fileref="virt-system-roles.png" width="75%"/>
          </imageobject>
          <imageobject role="html">
            <imagedata fileref="virt-system-roles.png" width="75%"/>
          </imageobject>
        </mediaobject>
      </figure>
      <para>
        在此屏幕中，可以选择 <guimenu>KVM 虚拟化主机</guimenu>或 <guimenu>Xen 虚拟化主机</guimenu>角色。在安装 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 期间，系统会自动执行相应软件的选择和设置。
      </para>
      <tip>
        <para>
          这两个虚拟化系统角色都会创建专用的 <filename>/var/lib/libvirt</filename> 分区，并启用 <systemitem class="daemon">firewalld</systemitem> 和 Kdump 服务。
        </para>
      </tip>
    </sect2>

    <sect2 xml:id="install-virtualization-components-yast">
      <title>运行 <emphasis>YaST 虚拟化</emphasis>模块</title>
      <para>
        您的系统上可能未安装任何虚拟化工具，具体取决于 VM 主机服务器上的 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 安装范围。使用 <emphasis>YaST 虚拟化</emphasis>模块配置超级管理程序时，系统会自动安装虚拟化工具。
      </para>
      <tip>
        <para>
          <emphasis>YaST 虚拟化</emphasis>模块包含在 <package>yast2-vm</package> 软件包中。在安装虚拟化组件之前，请校验是否在 VM 主机服务器上安装了该模块。
        </para>
      </tip>
      <procedure>
        <title>安装 KVM 环境</title>
        <para>
          要安装 KVM 虚拟化环境和相关工具，请执行以下操作：
        </para>
        <step>
          <para>
            启动 YaST 并选择<menuchoice><guimenu>虚拟化</guimenu> <guimenu>安装超级管理程序和工具</guimenu></menuchoice>。
          </para>
        </step>
        <step>
          <para>
            选择 <guimenu>KVM 服务器</guimenu>以安装极简的 QEMU 和 KVM 环境。如果您还想要使用基于 <systemitem class="library">libvirt</systemitem> 的管理堆栈，请选择 <guimenu>KVM 工具</guimenu>。单击<guimenu>接受</guimenu>确认。
          </para>
        </step>
        <step>
          <para>
            YaST 会建议自动在 VM 主机服务器上配置网桥。这可以确保 VM Guest 获得正常的网络功能。如果您同意执行此操作，请选择<guimenu>是</guimenu>，否则请选择<guimenu>否</guimenu>。
          </para>
        </step>
        <step>
          <para>
            安装完成后，您可以开始创建并配置 VM Guest。不需要重引导 VM 主机服务器。
          </para>
        </step>
      </procedure>
      <procedure>
        <title>安装 Xen 环境</title>
        <para>
          要安装 Xen 虚拟化环境，请执行以下操作：
        </para>
        <step>
          <para>
            启动 YaST 并选择<menuchoice>
            <guimenu>虚拟化</guimenu> <guimenu>安装超级管理程序和工具</guimenu></menuchoice>。
          </para>
        </step>
        <step>
          <para>
            选择 <guimenu>Xen 服务器</guimenu>以安装极简的 Xen 环境。同时请选择 <guimenu>Xen 工具</guimenu>以使用基于 <systemitem class="library">libvirt</systemitem> 的管理堆栈。单击<guimenu>接受</guimenu>确认。
          </para>
        </step>
        <step>
          <para>
            YaST 会建议自动在 VM 主机服务器上配置网桥。这可以确保 VM Guest 获得正常的网络功能。如果您同意执行此操作，请选择<guimenu>是</guimenu>，否则请选择<guimenu>否</guimenu>。
          </para>
        </step>
        <step>
          <para>
            安装完成后，您需使用 <emphasis>Xen 内核</emphasis>重引导计算机。
          </para>
          <tip>
            <title>默认引导内核</title>
            <para>
              如果一切按预期进行，请使用 YaST 更改默认引导内核，并将支持 Xen 的内核设置为默认内核。有关更改默认内核的详细信息，请参见<link xlink:href="https://documentation.suse.com/sles/15-SP4/html/SLES-all/cha-grub2.html#sec-grub2-yast2-config"/>。
            </para>
          </tip>
        </step>
      </procedure>
    </sect2>

    <sect2 xml:id="install-virtualization-components-pattern">
      <title>安装特定的安装软件集</title>
      <para>
        <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 软件储存库中的相关软件包已组织成<emphasis>安装软件集</emphasis>。您可以使用这些软件集在已运行的 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 上安装特定的虚拟化组件。使用 <command>zypper</command> 安装这些组件：
      </para>
<screen>zypper install -t pattern <replaceable>PATTERN_NAME</replaceable></screen>
      <para>
        要安装 KVM 环境，请考虑使用以下软件集：
      </para>
      <variablelist>
        <varlistentry>
          <term><literal>kvm_server</literal></term>
          <listitem>
            <para>
              安装带有 KVM 和 QEMU 环境的基本 VM 主机服务器。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><literal>kvm_tools</literal></term>
          <listitem>
            <para>
              安装用于在 KVM 环境中管理和监视 VM Guest 的 <systemitem class="library">libvirt</systemitem> 工具。
            </para>
          </listitem>
        </varlistentry>
      </variablelist>
      <para>
        要安装 Xen 环境，请考虑使用以下软件集：
      </para>
      <variablelist>
        <varlistentry>
          <term><literal>xen_server</literal></term>
          <listitem>
            <para>
              安装基本的 Xen VM 主机服务器。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><literal>xen_tools</literal></term>
          <listitem>
            <para>
              安装用于在 Xen 环境中管理和监视 VM Guest 的 <systemitem class="library">libvirt</systemitem> 工具。
            </para>
          </listitem>
        </varlistentry>
      </variablelist>
    </sect2>
  </sect1>
  <sect1 xml:id="sec-vt-installation-ovmf">
    <title>安装 UEFI 支持</title>

    <note>
      <para>
        我们仅支持在 AMD64/Intel 64 Guest 上使用 UEFI 安全引导。KVM Guest 使用 OVMF 固件来支持 UEFI 安全引导。Xen HVM Guest 也支持从 OVMF 固件引导，但不支持 UEFI 安全引导。
      </para>
    </note>

    <para>
      UEFI 支持由 <emphasis>OVMF</emphasis>（<emphasis>开放虚拟机固件</emphasis>）提供。要启用 UEFI 引导，请先根据 Guest 的体系结构安装 <package>qemu-ovmf-x86_64</package> 或 <package>qemu-uefi-aarch64</package> 软件包。
    </para>

    <para>
      系统会自动选择虚拟机使用的固件。这种自动选择是根据上述固件软件包中的 JSON 文件做出的。<systemitem class="library">libvirt</systemitem> QEMU 驱动程序会在装载期间分析这些文件，以便知道多种固件的功能。然后，当用户选择固件类型以及任何所需功能（例如，UEFI 安全引导支持）时，<systemitem class="library">libvirt</systemitem> 能够找到符合用户要求的固件。
    </para>

    <para>
      例如，要指定支持 UEFI 安全引导的 EFI，请使用以下配置：
    </para>

<screen>
&lt;os firmware='efi'&gt;
 &lt;loader secure='yes'/&gt;
&lt;/os&gt;
</screen>

    <para>
      <package>qemu-ovmf-x86_64</package> 软件包包含以下重要 UEFI 固件映像。这些映像为 VM Guest 提供 UEFI 安全引导功能：
    </para>

<screen>
<prompt role="root"># </prompt><command>rpm -ql qemu-ovmf-x86_64</command>
[...]
/usr/share/qemu/ovmf-x86_64-smm-ms-code.bin
/usr/share/qemu/ovmf-x86_64-smm-ms-vars.bin
/usr/share/qemu/ovmf-x86_64-smm-opensuse-code.bin
/usr/share/qemu/ovmf-x86_64-smm-opensuse-vars.bin
/usr/share/qemu/ovmf-x86_64-smm-suse-code.bin
/usr/share/qemu/ovmf-x86_64-smm-suse-vars.bin
[...]
</screen>

    <itemizedlist>
      <listitem>
        <para>
          要为 SUSE Linux Enterprise Guest 使用 UEFI 安全引导，请使用 <filename>ovmf-x86_64-smm-suse-code.bin</filename> 固件。
        </para>
      </listitem>
      <listitem>
        <para>
          要为 openSUSE Guest 使用 UEFI 安全引导，请使用 <filename>ovmf-x86_64-smm-opensuse-code.bin</filename> 固件。
        </para>
      </listitem>
      <listitem>
        <para>
          要为 Microsoft Windows Guest 使用 UEFI 安全引导，请使用 <filename>ovmf-x86_64-smm-ms-code.bin</filename> 固件。
        </para>
      </listitem>
    </itemizedlist>

    <para>
      对于 AArch64 体系结构，该软件包名为 <package>qemu-uefi-aarch32</package>：
    </para>

<screen>
<prompt role="root"># </prompt><command>rpm -ql qemu-uefi-aarch32</command>
[...]
/usr/share/qemu/aavmf-aarch32-code.bin
/usr/share/qemu/aavmf-aarch32-vars.bin
/usr/share/qemu/firmware
/usr/share/qemu/firmware/60-aavmf-aarch32.json
/usr/share/qemu/qemu-uefi-aarch32.bin
</screen>

    <para>
      <filename>*-code.bin</filename> 文件是 UEFI 固件文件。<filename>*-vars.bin</filename> 文件是对应的变量存储映像，可用作每个 VM 的非易失性存储模板。首次创建 VM 时，<systemitem class="library">libvirt</systemitem> 会将指定的 <literal>vars</literal> 模板复制到每个 VM 路径的 <filename>/var/lib/libvirt/qemu/nvram/</filename> 下。名称中不包含 <literal>code</literal> 或 <literal>vars</literal> 的文件可用作单个 UEFI 映像。它们没有太大的作用，因为每次经过 VM 关开机周期后，UEFI 变量都不会保存。
    </para>

    <para>
      <filename>*-ms*.bin</filename> 文件包含存放在实际硬件上的 UEFI CA 密钥。因此，在 <systemitem class="library">libvirt</systemitem> 中它们已配置为默认设置。同样，<filename>*-suse*.bin</filename> 文件包含预安装的 SUSE 密钥。还有一组不包含预安装密钥的文件。
    </para>

    <para>
      有关细节，请参见<xref linkend="vle-libvirt-inst-virt-install-ovmf"/>和 <link xlink:href="http://www.linux-kvm.org/downloads/lersek/ovmf-whitepaper-c770f8c.txt"/>。
    </para>
  </sect1>
  <sect1 xml:id="sec-vt-installation-nested-vms">
    <title>在 KVM 中启用嵌套虚拟化</title>

    <important>
      <title>技术预览</title>
      <para>
        KVM 的嵌套式虚拟化仍为技术预览版。此版本是出于测试目的提供的，我们不提供相关支持。
      </para>
    </important>

    <para>
      嵌套式 Guest 是 KVM Guest 中运行的 KVM Guest。在描述嵌套式 Guest 时，我们会用到以下虚拟化层：
    </para>

    <variablelist>
      <varlistentry>
        <term>L0</term>
        <listitem>
          <para>
            运行 KVM 的裸机主机。
          </para>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>L1</term>
        <listitem>
          <para>
            在 L0 上运行的虚拟机。由于它可以在另一个 KVM 上运行，因此称为 <emphasis>Guest 超级管理程序</emphasis>。
          </para>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>L2</term>
        <listitem>
          <para>
            在 L1 上运行的虚拟机。称为<emphasis>嵌套式 Guest</emphasis>。
          </para>
        </listitem>
      </varlistentry>
    </variablelist>

    <para>
      嵌套式虚拟化具有诸多优势。它可在以下场景中为您提供便利：
    </para>

    <itemizedlist>
      <listitem>
        <para>
          在云环境中直接使用所选的超级管理程序管理您自己的虚拟机。
        </para>
      </listitem>
      <listitem>
        <para>
          将超级管理程序及其 Guest 虚拟机作为单个实体进行实时迁移。
        </para>
        <note>
          <para>
            不支持实时迁移嵌套的 VM Guest。
          </para>
        </note>
      </listitem>
      <listitem>
        <para>
          使用嵌套式虚拟化进行软件开发和测试。
        </para>
      </listitem>
    </itemizedlist>

    <para>
      要暂时启用嵌套功能，请去除该模块，然后使用 <option>nested</option> KVM 模块参数重新装载该模块：
    </para>

    <itemizedlist>
      <listitem>
        <para>
          对于 Intel CPU，请运行：
        </para>
<screen>
<prompt>&gt; </prompt><command>sudo</command> modprobe -r kvm_intel &amp;&amp; modprobe kvm_intel nested=1
</screen>
      </listitem>
      <listitem>
        <para>
          对于 AMD CPU，请运行：
        </para>
<screen>
<prompt>&gt; </prompt><command>sudo</command> modprobe -r kvm_amd &amp;&amp; modprobe kvm_amd nested=1
</screen>
      </listitem>
    </itemizedlist>

    <para>
      要永久启用嵌套功能，请根据您的 CPU，在 <filename>/etc/modprobe.d/kvm_*.conf</filename> 文件中启用 <option>nested</option> KVM 模块参数：
    </para>

    <itemizedlist>
      <listitem>
        <para>
          对于 Intel CPU，请编辑 <filename>/etc/modprobe.d/kvm_intel.conf</filename>，在其中添加下面一行：
        </para>
<screen>options kvm_intel nested=1</screen>
      </listitem>
      <listitem>
        <para>
          对于 AMD CPU，请编辑 <filename>/etc/modprobe.d/kvm_amd.conf</filename>，在其中添加下面一行：
        </para>
<screen>options kvm_amd nested=1</screen>
      </listitem>
    </itemizedlist>

    <para>
      如果 L0 主机能够嵌套，则您可以通过以下方式之一启动 L1 Guest：
    </para>

    <itemizedlist>
      <listitem>
        <para>
          使用 <option>-cpu host</option> QEMU 命令行选项。
        </para>
      </listitem>
      <listitem>
        <para>
          将 <literal>vmx</literal>（对于 Intel CPU）或 <literal>svm</literal>（对于 AMD CPU）CPU 功能添加到 <option>-cpu</option> QEMU 命令行选项，用于启用虚拟 CPU 的虚拟化。
        </para>
      </listitem>
    </itemizedlist>

    <sect2 xml:id="sec-vt-installation-nested-vms-esxi">
      <title>VMware ESX 用作 Guest 超级管理程序</title>
      <para>
        如果您在 KVM 裸机超级管理程序之上使用 VMware ESX 作为 Guest 超级管理程序，网络通讯可能会变得不稳定。嵌套的 KVM Guest 与 KVM 裸机超级管理程序或外部网络之间特别容易发生这种问题。嵌套 KVM Guest 的以下默认 CPU 配置会导致该问题：
      </para>
<screen>&lt;cpu mode='host-model' check='partial'/&gt;</screen>
      <para>
        要解决问题，请如下所示修改 CPU 配置：
      </para>
<screen>
[...]
&lt;cpu mode='host-passthrough' check='none'&gt;
 &lt;cache mode='passthrough'/&gt;
&lt;/cpu&gt;
[...]
</screen>
    </sect2>
  </sect1>
</chapter>
