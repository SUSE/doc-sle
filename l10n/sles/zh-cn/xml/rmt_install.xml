<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="rmt_install.xml" version="5.0" xml:id="cha-rmt-installation">
  
  <info>
    <title>RMT 安装和配置</title>
    <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
      <dm:translation>yes</dm:translation>
    </dm:docmanager>
  </info>
  <para>
    SUSE Linux Enterprise Server 15 及以上版本中包含 RMT。可以在安装 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 的过程中直接安装 RMT，或在运行中系统上安装 RMT。安装好软件包后，请使用 YaST 执行初始配置。
  </para>
  <warning>
    <title>RMT 服务器与安装服务器冲突</title>
    <para>
      将一台服务器配置为 RMT 服务器时，会安装并配置侦听端口为 80 的 NGINX Web 服务器。
    </para>
    <para>
      而在将一台计算机配置为安装服务器时，会自动安装 Apache Web 服务器并将其配置为侦听端口 80。
    </para>
    <para>
      请勿尝试在同一台服务器上启用这两项功能。一台服务器无法同时托管 Apache Web 服务器和 NGINX Web 服务器。
    </para>
  </warning>
  <sect1 xml:id="sec-rmt-storage-requirements">
    <title>存储要求</title>

    <para>
      下载的软件包存储在 <filename>/usr/share/rmt/public/repo</filename> 中，该文件是指向 <filename>/var/lib/rmt/public/repo/</filename> 的符号链接。
    </para>

    <para>
      RMT 服务器所需的存储空间取决于以下可变因素：您镜像的储存库和体系结构的数量以及启用的产品数量。一般来说，将存储空间设为所有已启用储存库总大小的 1.5 倍应当就已足够。其中，每个 SUSE Linux Enterprise 版本（包括所有扩展）大约 200 GB。
    </para>
  </sect1>
  <sect1 xml:id="sec-rmt-installation-yast">
    <title>在系统安装期间安装</title>

    <para>
      要在系统安装期间安装 RMT，请选择 <package>rmt-server</package> 软件包。选择<emphasis>软件</emphasis>后，可以在<emphasis>安装设置</emphasis>中看到软件包选项。
    </para>

    <figure>
      <title>RMT 软件集</title>
      <mediaobject>
        <imageobject role="fo">
          <imagedata fileref="rmt_installation.png" width="70%"/>
        </imageobject>
        <imageobject role="html">
          <imagedata fileref="rmt_installation.png" width="70%"/>
        </imageobject>
      </mediaobject>
    </figure>

    <para>
      安装 SUSE Linux Enterprise Server 后，请立即使用 <command>zypper patch</command> 命令检查可用的 RMT 更新，因为 SUSE 会持续发布 RMT 的维护更新。
    </para>
  </sect1>
  <sect1 xml:id="sec-rmt-installation-zypper">
    <title>在现有系统上安装</title>

    <para>
      要在运行中的 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 系统上安装 RMT，请使用 <command>zypper</command>：
    </para>

<screen><prompt>&gt; </prompt><command>sudo</command> <command>zypper in rmt-server</command></screen>

    <sect2 xml:id="sec-rmt-installation-zypper-jeos">
      <title>在 SLES Minimal VM 上安装</title>
      <para>
        SUSE Minimal VM 是一种专为特定使用场景而设计的可自定义极简操作系统，例如，它可充当以下不同形式的对象运行：
      </para>
      <itemizedlist>
        <listitem>
          <para>
            容器主机
          </para>
        </listitem>
        <listitem>
          <para>
            虚拟机 Guest
          </para>
        </listitem>
        <listitem>
          <para>
            设备库系统
          </para>
        </listitem>
        <listitem>
          <para>
            小型服务器映像
          </para>
        </listitem>
      </itemizedlist>
      <para>
        SLES Minimal VM 映像非常适合作为 RMT 服务器。您可以从公共 SUSE Linux Enterprise Server 下载页面（网址为：<link xlink:href="https://www.suse.com/download/sles/"></link>）下载适用于 KVM、Xen、Microsoft Hyper-V、VMware 和 OpenStack 的 SLES Minimal VM 映像。有关 SLES Minimal VM 的详细信息，请访问 <link xlink:href="https://documentation.suse.com/smart/virtualization-cloud/html/minimal-vm/index.html"></link>。
      </para>
      <para>
        在 SLES Minimal VM 上安装 RMT 的过程与在现有系统上的安装过相同（请参见<xref linkend="sec-rmt-installation-zypper"/>）)。要在 SLES Minimal VM 上安装 RMT，请以 <systemitem class="username">root</systemitem> 身份从 SLES Minimal VM 命令行运行以下命令：
      </para>
<screen><prompt role="root"># </prompt>zypper install rmt-server yast2-rmt nginx mariadb</screen>
      <important>
        <title>硬件要求</title>
        <para>
          请注意，在 SLES Minimal VM 上安装 RMT 时至少需要 100 GB 磁盘空间，具体取决于您选择镜像的产品。另外还需要至少有两个内核的 CPU 以及 2 GB RAM。
        </para>
      </important>
    </sect2>
  </sect1>
  <sect1 xml:id="sec-rmt-deploy-kubernetes">
    <title>在 Kubernetes 群集上部署 RMT</title>

    <para>
      本节介绍如何在 Kubernetes 群集上部署 RMT。它使用 <emphasis>Helm</emphasis> 作为软件包管理器与 Kubernetes 群集交互。有关如何使用 Helm 的更多详细信息，请访问 <link xlink:href="https://helm.sh/docs/intro/using_helm/"></link>。
    </para>

    <sect2 xml:id="sec-rmt-deploy-kubernetes-prerequisites">
      <title>先决条件</title>
      <itemizedlist>
        <listitem>
          <para>
            运行 Kubernetes 群集
          </para>
        </listitem>
        <listitem>
          <para>
            配置为与群集交互的 <command>helm</command> 命令
          </para>
        </listitem>
      </itemizedlist>
    </sect2>

    <sect2 xml:id="sec-rmt-deploy-kubernetes-components">
      <title>应用程序组件</title>
      <para>
        RMT 应用程序的每个组件都部署在其各自的容器中。RMT 由下列组件组成：
      </para>
      <variablelist>
        <varlistentry>
          <term>RMT 服务器</term>
          <listitem>
            <para>
              RMT 应用程序服务器的容器化版本，能够通过 Helm 值传递其配置。数据存储在分配到 Kubernetes 群集的卷上。您需要根据所要镜像的储存库数量调整存储空间大小。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term>MariaDB</term>
          <listitem>
            <para>
              RMT 的数据库后端。由于 RMT 会在启动时创建所需的数据库和表，因此无需执行安装后任务。如果未在 <filename>values.yaml</filename> 文件中指定口令，系统会自动生成口令。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term>Nginx</term>
          <listitem>
            <para>
              为 RMT 路由配置的 Web 服务器。正确配置 Web 服务器后，您便可将入站流量（用于 RMT）直接定向到此 Nginx 服务。您不需要配置 RMT 入站流量特定的路径处理方式，因为 Nginx 已配置为自行处理此项事宜。
            </para>
          </listitem>
        </varlistentry>
      </variablelist>
    </sect2>

    <sect2 xml:id="sec-rmt-deploy-kubernetes-values">
      <title><filename>values.yaml</filename> 文件</title>
      <para>
        RMT 图表包含 <filename>values.yaml</filename> 文件，其中记录了所有参数并定义了它们的默认值。您可以通过提供自己的值文件来覆盖这些值，例如：
      </para>
<screen><prompt>&gt; </prompt>cat &lt;&lt; EOF &gt; rmt-config.yaml
---
app:
  storage:
    class: local-path<co xml:id="co-kubernetes-values-appstorage"/>
  scc:
    enabled: false
    username: "UXXXXXXX"
    password: "PASSXXXX"
    products_enable:
      - SLES/15.3/x86_64
      - sle-module-python2/15.3/x86_64
    products_disable:
      - sle-module-legacy/15.3/x86_64
      - sle-module-cap-tools/15.3/x86_64
db:
  storage:
    class: local-path<co xml:id="co-kubernetes-values-dbstorage"/>
ingress:
  enabled: true
  hosts:
    - host: chart-example.local
      paths:
        - path: "/"
          pathType: Prefix
  tls:
    - secretName: rmt-cert
      hosts:
        - chart-example.local
EOF
</screen>
<calloutlist>
  <callout arearefs="co-kubernetes-values-appstorage co-kubernetes-values-dbstorage">
    <para>
      <literal>local-path</literal> 存储类仅适用于 Rancher 工作负载。要使 helm chart 成功，您需要通过运行以下命令来安装 <literal>local-path</literal> 存储配置器：
    </para>
<screen><prompt>&gt; </prompt>kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.26/deploy/local-path-storage.yaml</screen>
  </callout>
</calloutlist>
      <para>
        要安装 RMT，请运行以下命令：
      </para>
<screen><prompt>&gt; </prompt>helm install rmtsle oci://registry.suse.com/suse/rmt-helm -f rmt-config.yaml</screen>
      <sect3 xml:id="sec-rmt-helm-required-values">
        <title>必需的值</title>
        <variablelist>
          <varlistentry>
            <term><emphasis role="strong">键</emphasis>：app.scc.password</term>
            <listitem>
              <para>
                <emphasis role="strong">类型</emphasis>：字符串
              </para>
              <para>
                <emphasis role="strong">默认值</emphasis>：<literal>nil</literal>
              </para>
              <para>
                <emphasis role="strong">说明</emphasis>：<link xlink:href="https://scc.suse.com/">SUSE Customer Center</link> 代理口令。口令字符串需要用引号括住。如果引号字符 <literal>"</literal> 是字符串的一部分，则必须使用 <literal>\</literal> 进行转义。
              </para>
            </listitem>
          </varlistentry>
          <varlistentry>
            <term><emphasis role="strong">键</emphasis>：app.scc.username</term>
            <listitem>
              <para>
                <emphasis role="strong">类型</emphasis>：字符串
              </para>
              <para>
                <emphasis role="strong">默认值</emphasis>：<literal>nil</literal>
              </para>
              <para>
                <emphasis role="strong">说明</emphasis>：<link xlink:href="https://scc.suse.com/">SUSE Customer Center</link> 代理用户名。用户名字符串需要用引号括住。如果引号字符 <literal>"</literal> 是字符串的一部分，则必须使用 <literal>\</literal> 进行转义。
              </para>
            </listitem>
          </varlistentry>
          <varlistentry>
            <term><emphasis role="strong">键</emphasis>：app.scc.products_enable</term>
            <listitem>
              <para>
                <emphasis role="strong">类型</emphasis>：列表
              </para>
              <para>
                <emphasis role="strong">默认值</emphasis>：<literal>[]</literal>
              </para>
              <para>
                <emphasis role="strong">说明</emphasis>：要启用镜像的产品列表
              </para>
            </listitem>
          </varlistentry>
          <varlistentry>
            <term><emphasis role="strong">键</emphasis>：app.scc.products_disable</term>
            <listitem>
              <para>
                <emphasis role="strong">类型</emphasis>：列表
              </para>
              <para>
                <emphasis role="strong">默认值</emphasis>：<literal>[]</literal>
              </para>
              <para>
                <emphasis role="strong">说明</emphasis>：要禁用镜像的产品列表
              </para>
            </listitem>
          </varlistentry>
          <varlistentry>
            <term><emphasis role="strong">键</emphasis>：app.storage.class</term>
            <listitem>
              <para>
                <emphasis role="strong">类型</emphasis>：字符串
              </para>
              <para>
                <emphasis role="strong">默认值</emphasis>：<literal>""</literal>
              </para>
              <para>
                <emphasis role="strong">说明</emphasis>：Kubernetes <literal>storageclass</literal>。
              </para>
            </listitem>
          </varlistentry>
          <varlistentry>
            <term><emphasis role="strong">键</emphasis>：db.storage.class</term>
            <listitem>
              <para>
                <emphasis role="strong">类型</emphasis>：字符串
              </para>
              <para>
                <emphasis role="strong">默认值</emphasis>：<literal>""</literal>
              </para>
              <para>
                <emphasis role="strong">说明</emphasis>：Kubernetes <literal>storageclass</literal>。
              </para>
            </listitem>
          </varlistentry>
          <varlistentry>
            <term><emphasis role="strong">键</emphasis>：ingress.enabled</term>
            <listitem>
              <para>
                <emphasis role="strong">类型</emphasis>：布尔
              </para>
              <para>
                <emphasis role="strong">默认值</emphasis>：<literal>false</literal>
              </para>
              <para>
                <emphasis role="strong">说明</emphasis>：已启用 Ingress
              </para>
            </listitem>
          </varlistentry>
          <varlistentry>
            <term><emphasis role="strong">键</emphasis>：ingress.hosts[0]</term>
            <listitem>
              <para>
                <emphasis role="strong">类型</emphasis>：对象
              </para>
              <para>
                <emphasis role="strong">默认值</emphasis>：<literal>{"host":"chart-example.local","paths":[{"path":"/","pathType":"Prefix"}]}</literal>
              </para>
              <para>
                <emphasis role="strong">说明</emphasis>：可用于从客户端访问 RMT 服务的 DNS 名称
              </para>
            </listitem>
          </varlistentry>
          <varlistentry>
            <term><emphasis role="strong">键</emphasis>：ingress.tls[0].hosts[0]</term>
            <listitem>
              <para>
                <emphasis role="strong">类型</emphasis>：字符串
              </para>
              <para>
                <emphasis role="strong">默认值</emphasis>：<literal>"chart-example.local"</literal>
              </para>
              <para>
                <emphasis role="strong">说明</emphasis>：可用于从客户端访问 RMT 服务的 DNS 名称
              </para>
            </listitem>
          </varlistentry>
          <varlistentry>
            <term><emphasis role="strong">键</emphasis>：ingress.tls[0].secretName</term>
            <listitem>
              <para>
                <emphasis role="strong">类型</emphasis>：字符串
              </para>
              <para>
                <emphasis role="strong">默认值</emphasis>：<literal>"rmt-cert"</literal>
              </para>
              <para>
                <emphasis role="strong">说明</emphasis>：TLS Ingress 证书
              </para>
            </listitem>
          </varlistentry>
        </variablelist>
      </sect3>
    </sect2>
  </sect1>
  <sect1 xml:id="sec-rmt-installation-yast-configuration">
    <title>使用 YaST 配置 RMT</title>

    <para>
      按以下过程所述使用 YaST 配置 RMT。假设在新安装的系统上执行此过程。
    </para>

    <procedure>
      <step>
        <para>
          使用 <literal>rmt</literal> 模块启动 YaST。
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>yast2 rmt</command></screen>
        <para>
          或者，您也可以启动 YaST，然后选择<menuchoice><guimenu>网络服务</guimenu><guimenu>RMT 配置</guimenu></menuchoice>。
        </para>
      </step>
      <step>
        <para>
          输入您的组织身份凭证。要获取您的身份凭证，请参见<xref linkend="sec-rmt-mirroring-credentials"/>。
        </para>
      </step>
      <step>
        <para>
          输入新 MariaDB 用户的身份凭证和数据库名称，然后单击<guimenu>下一步</guimenu>确认。
        </para>
        <para>
          如果已设置 MariaDB <literal>root</literal> 用户的口令，您需要输入该口令。如果未设置 <literal>root</literal> 的口令，系统会要求您输入一个新口令。
        </para>
      </step>
      <step>
        <para>
          输入 SSL 证书的常用名。该常用名应为服务器的<emphasis>完全限定域名</emphasis> (<emphasis>FQDN</emphasis>)。输入您要用来作为其他常用名连接 RMT 服务器的所有域名和 IP 地址。
        </para>
        <para>
          输入所有常用名后，选择<guimenu>下一步</guimenu>。
        </para>
        <tip>
          <title>RMT 的证书位置</title>
          <itemizedlist>
            <listitem>
              <para>
                <filename>/etc/rmt/ssl/rmt-ca.crt</filename>
              </para>
              <para>
                此为 <command>yast2
                rmt</command> 用来验证 RMT 服务器证书的 CA 证书分发包。仅当此文件不存在时，<command>yast2 rmt</command> 才会创建此文件。
              </para>
            </listitem>
            <listitem>
              <para>
                <filename>/etc/rmt/ssl/rmt-server.crt</filename>和<filename>/etc/rmt/ssl/rmt-server.key</filename>
              </para>
              <para>
                仅当服务器证书和私用密钥不存在时，<command>yast2 rmt</command> 才会生成新的服务器证书和私用密钥。要重新生成此证书，请参见<xref linkend="cha-manage-certificates-https"/>。
              </para>
            </listitem>
          </itemizedlist>
        </tip>
      </step>
      <step>
        <para>
          如果此系统上启用了 <systemitem class="daemon">firewalld</systemitem>，请选中相应复选框打开必需的端口。
        </para>
        <figure>
          <title>在 <systemitem class="daemon">firewalld</systemitem> 中启用端口</title>
          <mediaobject>
            <imageobject role="fo">
              <imagedata fileref="rmt_firewalld.png" width="60%"/>
            </imageobject>
            <imageobject role="html">
              <imagedata fileref="rmt_firewalld.png" width="65%"/>
            </imageobject>
          </mediaobject>
        </figure>
        <para>
          如果现在尚未启用 <systemitem class="daemon">firewalld</systemitem>，而您打算日后启用它，可一律通过运行 <command>yast2
          rmt</command> 模块来打开相应端口。
        </para>
        <tip>
          <title>微调 <systemitem class="daemon">firewalld</systemitem> 设置</title>
          <para>
            单击<guimenu>防火墙细节</guimenu>，可仅打开特定网络接口的相应端口。
          </para>
        </tip>
        <para>
          单击<guimenu>下一步</guimenu>继续。
        </para>
      </step>
      <step>
        <para>
          要查看摘要，请单击<guimenu>下一步</guimenu>。单击<guimenu>完成</guimenu>关闭 YaST。YaST 即会启用并启动所有 <systemitem class="daemon">systemd</systemitem> 服务和计时器。
        </para>
      </step>
    </procedure>
  </sect1>
  <sect1>
    <title>启用 SLP 声明</title>

    <para>
      RMT 包含 SLP 服务描述文件 <filename>/etc/slp.reg.d/rmt-server.reg</filename>。要启用 RMT 服务的 SLP 声明，请执行以下步骤：
    </para>

    <procedure>
      <step>
        <para>
          如果 <systemitem class="daemon">firewalld</systemitem> 正在运行，请打开相应端口并重新加载 <systemitem class="daemon">firewalld</systemitem> 配置：
        </para>
<screen>
<prompt>&gt; </prompt><command>sudo</command> firewall-cmd --permanent --add-port=427/tcp
success
<prompt>&gt; </prompt><command>sudo</command> firewall-cmd --permanent --add-port=427/udp
success
<prompt>&gt; </prompt><command>sudo</command> firewall-cmd --reload
</screen>
      </step>
      <step>
        <para>
          校验 SLP 服务器是否已安装，如果未安装，则加以安装：
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> zypper install openslp-server</screen>
      </step>
      <step>
        <para>
          启用并启动 SLP 服务：
        </para>
<screen>
<prompt>&gt; </prompt><command>sudo</command> systemctl enable slpd.service
<prompt>&gt; </prompt><command>sudo</command> systemctl restart slpd.service
</screen>
      </step>
    </procedure>
  </sect1>
  <sect1 xml:id="rmt-self-update-firewall">
    <title>从防火墙后面访问 SUSE Customer Center</title>
    <para>
      如果 RMT 服务器位于防火墙之后，无法直接访问 SUSE Customer Center，则需要允许防火墙上的 80 和 443 端口连接到以下域。
    </para>
    <itemizedlist>
      <listitem>
        <para>
          scc.suse.com
        </para>
      </listitem>
      <listitem>
        <para>
          updates.suse.com
        </para>
      </listitem>
      <listitem>
        <para>
          installer-updates.suse.com
        </para>
      </listitem>
    </itemizedlist>
    <para>
      如果您使用的防火墙不支持主机名允许列表（例如 <systemitem class="daemon">firewalld</systemitem>），您需要执行以下步骤允许连接到相应的 IP 地址。
    </para>
    <procedure>
      <step>
        <para>
          解析域的 IP 地址，例如 <literal>installer-updates.suse.com</literal>。
        </para>
<screen><prompt>&gt; </prompt><command>nslookup installer-updates.suse.com</command>
[...]
Address: 152.199.22.115</screen>
      </step>
      <step>
        <para>
          为每个发现的 IP 地址添加端口 80 和 443 的防火墙规则。
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>firewall-cmd --permanent --zone=public \
  --add-rich-rule='rule family="ipv4" source address="152.199.22.115" \
  port protocol="tcp" port="80" accept'</command></screen> <screen><prompt>&gt; </prompt><command>sudo</command> <command>firewall-cmd --permanent --zone=public \
  --add-rich-rule='rule family="ipv4" source address="152.199.22.115" \
  port protocol="tcp" port="443" accept'</command></screen>
      </step>
      <step>
        <para>
          重新加载防火墙配置。
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> firewall-cmd --reload</screen>
      </step>
    </procedure>
  </sect1>
</chapter>
