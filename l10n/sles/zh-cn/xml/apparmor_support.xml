<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="apparmor_support.xml" version="5.0" xml:id="cha-apparmor-support">
 <title>支持</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:bugtracker>
          </dm:bugtracker>
        <dm:translation>是</dm:translation>
      </dm:docmanager>
    </info>
    <para>
  本章简要介绍维护方面的任务。您将了解到如何更新 <phrase>AppArmor®</phrase>，还会获得一个可用手册页的列表，这些手册页提供有关如何使用 <phrase>AppArmor</phrase> 所提供的命令行工具的基本帮助。查错一节提供了使用 <phrase>AppArmor</phrase> 时会遇到的一些常见问题及其解决方法。请遵循本章中的指导报告 <phrase>AppArmor</phrase> 的缺陷或提出增强请求。
 </para>
 <sect1 xml:id="sec-apparmor-support-updating">
  <title>联机更新 <phrase>AppArmor</phrase></title>

  <para>
   我们采用与 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 的任何其他更新相同的方式提供 <phrase>AppArmor</phrase> 软件包更新。您可以像检索和应用 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 随附的任何其他软件包一样来检索和应用这些更新。
  </para>
 </sect1>
 <sect1 xml:id="sec-apparmor-support-man">
  <title>使用手册页</title>

  <para>
   您可以使用手册页。在终端中输入 <command>man apparmor</command> 打开 <phrase>AppArmor</phrase> 手册页。手册页分布在编号为 1 到 8 的部分中。每个部分针对一种类别的文档：
  </para>

  <table>
   <title>手册页：部分和类别</title>
   <tgroup cols="2">
    <thead>
     <row>
      <entry>
       <para>
        部分
       </para>
      </entry>
      <entry>
       <para>
        类别
       </para>
      </entry>
     </row>
    </thead>
    <tbody>
     <row>
      <entry>
       <para>
        1
       </para>
      </entry>
      <entry>
       <para>
        用户命令
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        2
       </para>
      </entry>
      <entry>
       <para>
        系统调用
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        3
       </para>
      </entry>
      <entry>
       <para>
        库函数
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        4
       </para>
      </entry>
      <entry>
       <para>
        设备驱动程序信息
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        5
       </para>
      </entry>
      <entry>
       <para>
        配置文件格式
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        6
       </para>
      </entry>
      <entry>
       <para>
        游戏
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        7
       </para>
      </entry>
      <entry>
       <para>
        高级概念
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        8
       </para>
      </entry>
      <entry>
       <para>
        管理员命令
       </para>
      </entry>
     </row>
    </tbody>
   </tgroup>
  </table>

  <para>
   区号用于对各个手册页进行区分。例如，<systemitem>exit(2)</systemitem> 描述退出系统调用，而 <systemitem>exit(3)</systemitem> 描述退出 C 库函数。
  </para>

  <para>
   <phrase>AppArmor</phrase> 手册页包括：
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     <systemitem>aa-audit(8)</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem>aa-autodep(8)</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem>aa-complain(8)</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem>aa-decode(8)</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem>aa-disable(8)</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem>aa-easyprof(8)</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem>aa-enforce(8)</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem>aa-enxec(8)</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem>aa-genprof(8)</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem>aa-logprof(8)</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem>aa-notify(8)</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem>aa-status(8)</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem>aa-unconfined(8)</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem>aa_change_hat(8)</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem>logprof.conf(5)</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem>apparmor.d(5)</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem>apparmor.vim(5)</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem>apparmor(7)</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem>apparmor_parser(8)</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem>apparmor_status(8)</systemitem>
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec-apparmor-support-info">
  <title>更多信息</title>

  <para>
   <link xlink:href="http://wiki.apparmor.net"/> 上提供了有关 <phrase>AppArmor</phrase> 产品的详细信息。所安装系统的 <filename>/usr/share/doc/manual</filename> 中提供了 <phrase>AppArmor</phrase> 的产品文档。
  </para>

  <para>
   我们提供了 <phrase>AppArmor</phrase> 邮件列表，用户可向其发送邮件或加入其中，以与开发人员沟通。有关详细信息，请参见<link xlink:href="https://lists.ubuntu.com/mailman/listinfo/apparmor"/>。
  </para>
 </sect1>
 <sect1 xml:id="sec-apparmor-support-trouble">
  <title>查错</title>

  <para>
   本节列出了使用 <phrase>AppArmor</phrase> 时可能出现的最常见问题和错误消息。
  </para>

  <sect2 xml:id="sec-apparmor-support-trouble-odd">
   <title>如何应对应用程序行为异常？</title>
   <para>
    如果您注意到应用程序行为异常或其他类型的应用程序问题，应当先检查日志文件中的拒绝消息，以确定 <phrase>AppArmor</phrase> 对应用程序的限制是否过于严格。如果检测到有拒绝消息指出 <phrase>AppArmor</phrase> 对应用程序或服务的限制过于严格，请更新您的配置文件，以正确处理应用程序的用例。请使用 <command>aa-logprof</command> 执行此操作（<xref linkend="sec-apparmor-commandline-profiling-summary-logprof"/>）。
   </para>
   <para>
    如果您决定在不受 <phrase>AppArmor</phrase> 保护的情况下运行应用程序或服务，请从 <filename>/etc/apparmor.d</filename> 中去除应用程序的配置文件，或将其移到其他位置。
   </para>
  </sect2>

  <sect2 xml:id="sec-apparmor-support-trouble-dirpath">
   <title>我的配置文件似乎不再正常工作...</title>
   <remark>jsegitz 2014-07-16: This should maybe get it's own section "Upgrading from SLE 11" or something like that</remark>
   <para>
    如果您一直在使用旧版的 <phrase>AppArmor</phrase>，后来更新了系统（但保留了旧的配置文件集），您可能会发现，在更新之前运行很正常的某些应用程序现在却出现奇怪的行为，或者无法运行。
   </para>
   <para>
    此版本的 <phrase>AppArmor</phrase> 为配置文件语法和 <phrase>AppArmor</phrase> 工具引入了一组新功能，这可能会给旧版 <phrase>AppArmor</phrase> 配置文件造成问题。这些功能包括：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      文件锁定
     </para>
    </listitem>
    <listitem>
     <para>
      网络访问控制
     </para>
    </listitem>
    <listitem>
     <para>
      <literal>SYS_PTRACE</literal> 功能
     </para>
    </listitem>
    <listitem>
     <para>
      目录路径访问
     </para>
    </listitem>
   </itemizedlist>
   <para>
    当前版本的 <phrase>AppArmor</phrase> 可调解文件锁定，并为此引入了新的权限模式 (<literal>k</literal>)。如果请求文件锁定权限的应用程序受到旧版配置文件的限制，而这些配置文件并未显式包含用于锁定文件的权限，则这些应用程序可能会行为异常或完全失败。如果您怀疑存在这种情况，请在 <filename>/var/log/audit/audit.log</filename> 下的日志文件中检查如下所示的项：
   </para>
<screen>type=AVC msg=audit(1389862802.727:13939): apparmor="DENIED" \
operation="file_lock" parent=2692 profile="/usr/bin/opera" \
name="/home/tux/.qt/.qtrc.lock" pid=28730 comm="httpd2-prefork" \
requested_mask="::k" denied_mask="::k" fsuid=30 ouid=0
</screen>
   <para>
    按如下所述使用 <command>aa-logprof</command> 命令更新配置文件。
   </para>
   <para>
    <xref linkend="sec-apparmor-profiles-nac"/>中所述的基于网络系列和类型规范的新网络访问控制语法可能导致应用程序行为异常甚至无法运行。如果您发现网络相关的应用程序出现奇怪的行为，请在 <filename>/var/log/audit/audit.log</filename> 下的日志文件中检查如下所示的项：
   </para>
<screen>type=AVC msg=audit(1389864332.233:13947): apparmor="DENIED" \
operation="socket_create" family="inet" parent=29985 profile="/bin/ping" \
sock_type="raw" pid=30251 comm="ping"
</screen>
   <para>
    此日志项表示我们的示例应用程序（在本例中为 <command>/bin/ping</command>）无法获取用于打开网络连接的 <phrase>AppArmor</phrase> 权限。为确保应用程序能够进行网络访问，需要显式指明此权限。要将配置文件更新为使用新语法，请按如下所述使用 <command>aa-logprof</command> 命令。
   </para>
   <para>
    如果进程尝试访问 <filename>/proc/<replaceable>PID</replaceable>/fd/*</filename> 中的文件，当前内核需要 <literal>SYS_PTRACE</literal> 功能。新配置文件需要该文件项和该功能项，而旧配置文件只需要该文件项。例如，旧语法中的以下语句
   </para>
<screen>/proc/*/fd/**  rw,</screen>
   <para>
    将转换为新语法中的以下规则：
   </para>
<screen>capability SYS_PTRACE,
/proc/*/fd/**  rw,</screen>
   <para>
    要将配置文件更新为使用新语法，请按如下所述使用 YaST 更新配置文件向导或 <command>aa-logprof</command> 命令。
   </para>
   <para>
    在此版本的 <phrase>AppArmor</phrase> 中，对配置文件规则语法进行了几项更改，以便更好地将目录访问与文件访问区分开来。因此，在旧版本中与文件路径和目录路径匹配的某些规则现在可能只与文件路径匹配。这可能导致 <phrase>AppArmor</phrase> 无法访问某个关键目录，从而触发应用程序的行为异常和各种日志消息。以下示例重点指出了路径语法最重要的更改。
   </para>
   <para>
    使用旧语法时，下面的规则将允许访问 <filename>/proc/net</filename> 中的文件和目录。它只允许目录访问操作读取该目录中的项，而不授予对该目录下的文件或目录的访问权限。例如，星号 (*) 将会匹配 <filename>/proc/net/dir/foo</filename>，但由于 <filename>foo</filename> 是 <filename>dir</filename> 下的一个文件或目录，因此无法访问它。
   </para>
<screen>/proc/net/*  r,
</screen>
   <para>
    要使用新语法获得相同的行为，需要使用两条规则，而不是一条。第一条规则允许访问 <filename>/proc/net</filename> 下的文件，第二条规则允许访问 <filename>/proc/net</filename> 下的目录。目录访问只可用于列出内容，而不能实际访问该目录下的文件或目录。
   </para>
<screen>/proc/net/*  r,
/proc/net/*/  r,
</screen>
   <para>
    下面的规则在新旧语法中的工作方式类似，允许访问 <filename>/proc/net</filename> 下的文件和目录（但不允许访问 <filename>/proc/net/</filename> 的目录列表本身）：
   </para>
<screen>
/proc/net/**  r,
</screen>
   <para>
    要在新语法中使用上述表达式区分文件访问和目录访问，需使用以下两条规则：第一条规则仅允许递归访问 <filename>/proc/net</filename> 下的目录，而第二条规则仅显式允许进行递归文件访问。
   </para>
<screen>/proc/net/**/  r,
/proc/net/**[^/]  r,</screen>
   <para>
    下面的规则在新旧语法中的工作方式类似，允许访问 <filename>/proc/net</filename> 下以 <literal>foo</literal> 开头的文件和目录：
   </para>
<screen>/proc/net/foo**  r,</screen>
   <para>
    要在新语法中区分文件访问和目录访问并使用 <literal>**</literal> 通配模式，需使用以下两条规则：第一条规则在旧语法中会同时匹配文件和目录，而在新语法中只会匹配文件，因为没有尾随斜线。第二条规则在旧语法中既不匹配文件也不匹配目录，而在新语法中只会匹配目录：
   </para>
<screen>/proc/net/**foo  r,
/proc/net/**foo/  r,
</screen>
   <para>
    以下规则说明了 <literal>? </literal> 通配模式的用法变化。在旧语法中，第一条规则会同时匹配文件和目录（四个字符，最后一个字符可以是除斜线以外的任何字符）。在新语法中，它只匹配文件（没有尾随斜线）。第二条规则在旧配置文件语法中不匹配任何内容，而在新语法中只会匹配目录。最后一条规则显式匹配 <filename>/proc/net/foo?</filename> 下名为 <filename>bar</filename> 的文件。使用旧语法时，此规则将应用于文件和目录：
   </para>
<screen>/proc/net/foo?  r,
/proc/net/foo?/  r,
/proc/net/foo?/bar  r,
</screen>
   <para>
    要查找并解决语法更改相关的问题，请在更新后花些时间检查您要保留的配置文件，并按如下所述继续处理您保留了其配置文件的每个应用程序：
   </para>
   <procedure>
    <step>
     <para>
      将应用程序的配置文件置于控诉模式：
     </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> <command>aa-complain</command> <option><replaceable>/path/to/application</replaceable></option></screen>
     <para>
      系统会对违反当前配置文件的所有操作生成日志项，但不会强制执行该配置文件，并且应用程序的行为不受限制。
     </para>
    </step>
    <step>
     <para>
      运行涵盖您需要其能够执行的所有任务的应用程序。
     </para>
    </step>
    <step>
     <para>
      根据运行应用程序时生成的日志项更新配置文件：
     </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> <command>aa-logprof</command> <option><replaceable>/path/to/application</replaceable></option></screen>
    </step>
    <step>
     <para>
      将生成的配置文件重新置于强制模式：
     </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> <command>aa-enforce</command> <option><replaceable>/path/to/application</replaceable></option></screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec-apparmor-support-trouble-apache">
   <title>使用 Apache 解决问题</title>
   <para>
    安装其他 Apache 模块（例如 <literal>apache2-mod_apparmor</literal>）或者对 Apache 做出配置更改后，再次构建 Apache 的配置文件，以确定是否需要向配置文件添加额外的规则。如果您不再次构建 Apache 的配置文件，Apache 可能无法正常启动，或者无法为网页提供服务。
   </para>
  </sect2>



  <sect2 xml:id="sec-apparmor-support-trouble-ex">
   <title>如何从使用的配置文件列表中排除特定的配置文件？</title>
   <para>
    运行 <command>aa-disable</command>
    <option><replaceable>PROGRAMNAME</replaceable></option> 可以禁用 <replaceable>PROGRAMNAME</replaceable> 的配置文件。此命令会创建指向 <filename>/etc/apparmor.d/disable/</filename> 中的配置文件的符号链接。要重新激活配置文件，请删除该链接，并运行 <command>systemctl reload apparmor</command>。
   </para>
  </sect2>

  <sect2 xml:id="sec-apparmor-support-trouble-remote">
   <title>我是否可以管理未安装在我系统上的应用程序的配置文件？</title>
   <para>
    要使用 <phrase>AppArmor</phrase> 管理配置文件，您需要有权访问运行应用程序的系统的日志。因此，只要您有权访问运行应用程序的计算机，就无需在配置文件构建主机上运行该应用程序。您可以在一个系统上运行应用程序，将日志（<filename>/var/log/audit.log</filename>，如果未安装 <filename>audit</filename>，则为 <command>journalctl | grep -i apparmor &gt; path_to_logfile</command>）传输到配置文件构建主机，然后运行 <command>aa-logprof -f</command>
    <replaceable>PATH_TO_LOGFILE</replaceable>。
   </para>
  </sect2>

  <sect2 xml:id="sec-apparmor-support-trouble-syntax">
   <title>如何找出和修复 <phrase>AppArmor</phrase> 语法错误</title>
   <para>
    手动编辑 <phrase>AppArmor</phrase> 配置文件可能会产生语法错误。如果您的配置文件中存在语法错误，尝试启动或重启动 <phrase>AppArmor</phrase> 时，会显示类似下面的错误结果。此示例显示了整个分析程序错误的语法。
   </para>
<screen>
<prompt role="root">root # </prompt> systemctl start apparmor.service
Loading AppArmor profiles AppArmor parser error in /etc/apparmor.d/usr.sbin.squid \
 at line 410: syntax error, unexpected TOK_ID, expecting TOK_MODE
Profile /etc/apparmor.d/usr.sbin.squid failed to load
</screen>
   <para>
    使用 <phrase>AppArmor</phrase> YaST 工具时，会有一条图形错误消息指出哪个配置文件包含错误，并要求您予以修复。
   </para>
   <informalfigure>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="aa_syncheck.png" width="60%"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="aa_syncheck.png" width="60%"/>
     </imageobject>
    </mediaobject>
   </informalfigure>
   <para>
    要修复语法错误，请以 <systemitem class="username">root</systemitem> 身份在终端窗口中登录，打开配置文件，然后更正语法。使用 <command>systemctl reload apparmor</command> 重新装载配置文件集。
   </para>
   <tip>
    <title><literal>vi</literal> 中的 <phrase>AppArmor</phrase> 语法高亮显示</title>
    <para>
     <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 上的编辑器 <literal>vi</literal> 支持 <phrase>AppArmor</phrase> 配置文件的语法高亮显示功能。包含语法错误的行的背景将会显示为红色。
    </para>
   </tip>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-apparmor-support-bugs">
  <title>报告 <phrase>AppArmor</phrase> 的 Bug</title>

  <para>
   <phrase>AppArmor</phrase> 的开发人员热切希望能够提供最高品质的产品。您的反馈和 bug 报告有助于我们保持较高的品质。当您在 <phrase>AppArmor</phrase> 中遇到 bug 时，请提交此产品的 bug 报告：
  </para>

  <procedure>
   <step>
    <para>
     在网页浏览器中转到 <link os="sles;sled" xlink:href="http://bugzilla.suse.com/"/> 并单击<guimenu>登录</guimenu>。
    </para>
   </step>
   <step>
    <para>
     输入您的 SUSE 帐户数据并单击<guimenu>登录</guimenu>。如果您没有 SUSE 帐户，请单击<guimenu>创建帐户</guimenu>并提供所需的数据。
    </para>
   </step>
   <step>
    <para>
     如果您的问题已有报告，请查看此错误报告，必要时在报告中添加其它信息。
    </para>
   </step>
   <step>
    <para>
     如果您的问题尚无报告，请在顶部导航栏中选择<guimenu>新建</guimenu>进入<guimenu>输入错误</guimenu>页面。
    </para>
   </step>
   <step>
    <para>
     选择要提交错误的产品。对于您而言，这应该是您的产品的发行版。单击“提交”<guimenu>。</guimenu>
    </para>
   </step>
   <step>
    <para>
     选择产品版本、组件（在本例中为 <phrase>AppArmor</phrase>）、硬件平台和严重性。
    </para>
   </step>
   <step>
    <para>
     输入一个用于描述问题的简短标题，然后在下面添加更详尽的说明，包括日志文件。您可以在 bug 报告中创建附件，以提供屏幕截图、日志文件或测试案例。
    </para>
   </step>
   <step>
    <para>
     输入所有详细信息后，单击<guimenu>提交</guimenu>以将报告发送到开发人员。
    </para>
   </step>
  </procedure>
 </sect1>
</chapter>
