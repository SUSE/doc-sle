<?xml version="1.0" encoding="UTF-8"?>
<article xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="art_minimal-vm.xml" version="5.0" xml:id="article-minimal-vm" xml:lang="zh-cn">
 <info>
  <title><citetitle>Minimal VM Quick Start</citetitle></title>
  <productname>SUSE Linux Enterprise Server Minimal VM</productname>
  <productnumber><phrase role="productnumber"><phrase os="sles;sled">15 SP5</phrase></phrase></productnumber>
  <date><?dbtimestamp format="Y"?> 年 <?dbtimestamp format="B" padding="0"?> 月 <?dbtimestamp format="d" padding="0"?> 日
</date>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    下面的内容提供了 SUSE Linux Enterprise Server Minimal VM（以前称为 JeOS）的概述并说明了设置过程。
   </para>
  </abstract>
 </info>
 <sect1 xml:id="sec-introduction">
  <title>简介</title>

  <para>
   Minimal VM 是一种专为特定使用场景而设计的可自定义极简操作系统，包含一个容器主机、一个虚拟机 Guest、一个设备库或小型服务器映像。Minimal VM 是构建数据中心内使用的系统、创建所需虚拟应用程序映像或设备的基础。您可以根据特定使用情形选择要安装的软件包和组件。为此，Minimal VM 提供了对所有常规储存库的访问途径。
  </para>

  <para>
   如果您已有 SUSE Linux Enterprise Server 证书，将会自动通过 Minimal VM 认证，因为 Minimal VM 源自同一代码库。SUSE Linux Enterprise Server Minimal VM 允许您缩减操作系统，只提供针对特定使用场景的必要软件包。如此可最大程度减少需要管理和应用的软件包和补丁数量。通过去除不必要的软件包，您还可以减少可能的漏洞数量，从而让精简后的系统更安全。此外，缩小系统占用的空间还可降低资源消耗并提高性能。
  </para>

  <para>
   Minimal VM 以经过预配置且可立即运行的虚拟机映像的形式提供。系统附带 <systemitem>jeos-firstboot</systemitem> 向导，可在首次引导期间指引您配置系统区域设置和 root 口令。Minimal VM 随附已启用且已从防火墙配置中排除的 SSH 服务器。提供的 KIWI 模板可用于创建自定义 Minimal VM 映像。
  </para>

  <para>
   Minimal VM 提供可在 AMD64/Intel 64 体系结构上即时部署的服务器映像，适用于以下使用场景：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     具有 HVM 的 KVM/Xen
    </para>
   </listitem>
   <listitem>
    <para>
     Xen 半虚拟化
    </para>
   </listitem>
   <listitem>
    <para>
     Microsoft Hyper-V
    </para>
   </listitem>
   <listitem>
    <para>
     VMWare
    </para>
   </listitem>
   <listitem>
    <para>
     OpenStack Cloud
    </para>
   </listitem>
  </itemizedlist>

  <sect2 xml:id="sec-system-requirements">
   <title>系统要求</title>
   <para>
    Minimal VM 最低系统要求与 SUSE Linux Enterprise Server 类似。有关更多信息，请参见<xref linkend="sec-x86-requirements"/>。
   </para>
  </sect2>

  <sect2 xml:id="sec-minvm-sles-diff">
   <title>Minimal VM 与 SUSE Linux Enterprise Server 之间的差异</title>
   <para>
    Minimal VM 与 SUSE Linux Enterprise Server 之间存在一些重大差异。
   </para>
   <variablelist xml:id="vl-minvm-sles-diff">
    <title>Minimal VM 与 SUSE Linux Enterprise Server 之间的差异</title>
    <varlistentry>
     <term>jeos-firstboot</term>
     <listitem>
      <para>
       Minimal VM 随附了 <package>jeos-firstboot</package> 工具，可用于在首次引导期间配置基本设置。这些设置包括键盘布局和语言、时区以及 root 口令。
      </para>
      <para>
       默认网络配置设置为使用 DHCP，系统会自动创建初始配置的 Btrfs 快照。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><package>kernel-default-base</package></term>
     <listitem>
      <para>
       由于存在大小限制，Minimal VM 映像使用 <package>kernel-default-base</package> 作为默认内核。因为该内核不包含裸机的驱动程序，所以占用的空间更小。
      </para>
      <para>
       如果特定使用场景需要任何被省略的模块，请安装 <package>kernel-default</package> 软件包，以实现完整的内核模块树。常规 SUSE Linux Enterprise Server 安装使用的就是该内核。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>默认无储存库</term>
     <listitem>
      <para>
       从安装媒体安装 SUSE Linux Enterprise Server 时，系统会自动将安装媒体设置为默认脱机通道。
      </para>
      <para>
       而 Minimal VM 默认无此通道，您需要注册系统才能访问联机通道。有关详细信息，请参见<xref linkend="sec-register-sle-system-suseconnect"/>。
      </para>
      <note>
      <para>
      仅当启用了 Development Tools 模块时，<package>jeos-firstboot</package>、<package>jeos-licenses</package> 和 <package>live-langset-data</package> 才会接收更新。不过，运行 Minimal VM 实例并不需要使用这些软件包，因此可以将它们去除或保持原样。
      </para>
      </note>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Zypper 配置</term>
     <listitem>
      <para>
       Minimal VM 是 SUSE Linux Enterprise Server 的精简版本。有一部分大小的缩减是通过启用 <filename>/etc/zypp/zypp.conf</filename> 中的以下两个选项实现的：<literal>rpm.install.excludedocs = yes</literal>（默认在安装过程中排除所有标记为文档的文件）和 <literal>solver.onlyRequires = true</literal>（默认禁止安装建议的软件包）。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>基本软件包</term>
     <listitem>
      <para>
       Minimal VM 映像通过 KIWI 工具来构建。KIWI 的配置文件（称为模板）明确列出了映像中必须包含的软件包。请注意，在映像构建过程中，这些基本软件包会拉取其依赖项。因此，映像中预安装的软件包列表包含的软件包通常会比基本软件包列表多。
      </para>
      <para>
       用于创建官方 Minimal VM 映像的 KIWI 配置文件可从 <link xlink:href="https://build.opensuse.org/package/view_file/SUSE:SLE-15-SP4:GA/kiwi-templates-Minimal/Minimal.kiwi?expand=1">https://build.opensuse.org/</link> 上的 openSUSE Build Service 中获得。
      </para>
      <note>
       <title>特定主机工具软件包</title>
       <para>
        每个 SUSE Linux Enterprise Server Minimal VM 变体都包含特定的主机工具软件包。有关更多信息，请参见文档中的特定风格章节。
       </para>
      </note>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>磁盘布局</term>
     <listitem>
      <para>
       与 SUSE Linux Enterprise Server 在安装期间计算磁盘布局不同，Minimal VM 使用如下固定的虚拟映像分区方案：
      </para>
      <itemizedlist>
       <listitem>
        <para>
         2 MB BIOS 引导
        </para>
       </listitem>
       <listitem>
        <para>
         33 MB EFI 系统
        </para>
       </listitem>
       <listitem>
        <para>
         24 GB Linux 文件系统
        </para>
       </listitem>
      </itemizedlist>
      <para>
       要获得额外的磁盘空间，您可以扩展虚拟主机中的现有磁盘，也可以向虚拟机添加另一个磁盘。如果您选择后一个选项，则必须手动进行分区和格式化。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>已禁用 systemd-coredump</term>
     <listitem>
      <para>
       由于 Minimal VM 映像上默认可用的内存和磁盘空间大小有限，Minimal VM 映像上默认会禁用 systemd-coredump。要收集查错所需的应用程序内核转储，请执行以下步骤：
      </para>
      <itemizedlist>
       <listitem>
        <para>
         安装 <package>systemd-coredump</package> 软件包，其中包含 <filename>/usr/lib/sysctl.d/50-coredump.conf</filename>
        </para>
       </listitem>
       <listitem>
        <para>
         要对您的系统应用配置更改，请重引导或使用 <command>sysctl --system</command> 命令。
        </para>
       </listitem>
      </itemizedlist>
      <para>
       有关更多信息，请参见 <link xlink:href="https://documentation.suse.com/sles/html/SLES-all/cha-tuning-systemd-coredump.html"/>。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-available-image-flavors">
  <title>可用的映像风格</title>

  <para>
   即时可用的 Minimal VM 映像仅适用于 x86_64 体系结构。您可以下载适用于以下部署目标的 Minimal VM：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     适用于 KVM 和 Xen 的全虚拟 Minimal VM (FV/HVM)
    </para>
   </listitem>
   <listitem>
    <para>
     适用于 VMware 的 Minimal VM
    </para>
   </listitem>
   <listitem>
    <para>
     适用于 Microsoft Hyper-V 的 Minimal VM
    </para>
   </listitem>
   <listitem>
    <para>
     适用于 OpenStack 的 Minimal VM
    </para>
   </listitem>
   <listitem>
    <para>
     适用于 Xen 的半虚拟 Minimal VM (PV)
    </para>
   </listitem>
  </itemizedlist>

  <important>
   <title>支持的虚拟化主机（超级管理程序）</title>
   <para>
    Minimal VM 可在 SUSE Linux Enterprise Server 的虚拟化主机（超级管理程序）上作为虚拟化 Guest 运行。有关受支持超级管理程序的详细信息，请参见<xref linkend="virt-support-hosts"/>。
   </para>
  </important>

  <sect2 xml:id="sec-openstack-cloud">
   <title>适用于 OpenStack Cloud 的 Minimal VM 映像</title>
   <para>
    适用于 OpenStack Cloud 的 Minimal VM 是专为在 OpenStack 环境中使用而设计的映像。
   </para>
   <para>
    适用于 OpenStack Cloud 的 Minimal VM 不会使用 <package>jeos-firstboot</package> 工具配置映像，而是使用 <link xlink:href="https://cloudinit.readthedocs.io/en/latest/#">cloud-init</link> 来配置。映像还使用 XFS 文件系统和以下内核配置：
   </para>
<screen>"plymouth.enable=0 console=ttyS0,115200 console=tty0 net.ifnames=0"</screen>
   <para>
    这表示该映像并未随附 <package>jeos-firstboot</package> 和 Btrfs 所需的软件包。
   </para>
   <para>
    适用于 OpenStack Cloud 的 Minimal VM 包含数个与 OpenStack 相关的软件包，例如 <package>cloud-init</package>、<package>cloud-init-config-suse</package> 和 <package>xfsprogs</package>。
   </para>
   <sect3 xml:id="sec-cloud-init-intro">
    <title><command>cloud-init</command> 基础知识</title>
    <para>
     <command>cloud-init</command> 会自动将自定义配置应用到正在运行的实例。该工具有多种配置模块，在引导阶段，它可以在映像中执行特定的命令。
    </para>
    <para>
     cloud-init 的默认配置包含在<package>cloud-init-config-suse</package> 软件包中，位于 <filename>/etc/cloud/cloud.cfg</filename> 目录中。
    </para>
   </sect3>
   <sect3 xml:id="sec-cloud-init-config-examples">
    <title>cloud-init 配置示例</title>
    <para>
    默认情况下，cloud-init 不会设置 root 口令，而是创建名为 <systemitem class="username">sles</systemitem> 的用户帐户，该帐户充当默认用户并拥有 sudo 权限。下面的示例会为这两个用户创建口令。
    </para>
    <example xml:id="cloud-init-passwd">
     <title>添加口令</title>
<screen>
#cloud-config
chpasswd:
  list: |
    root:$6$SalTsaLt$miA./Q1i1mKR0sYicn/yAzNHP6y32JjOdVIn5agAiaEKaSaZdC3X6CVTW2d/xslQfevCc20teWLurq12x8mbe1
    sles:$6$SalTsaLt$.cuqsgjNGxHJZSLmVqkI/j9.kWIiUQHqjlRswbHjTw9hIXdPomgey2DHzmp6Ho6wgqIKz3ufbOIKdQCnQHPSA1
  expire: False</screen>
    </example>
    <para>
     要创建示例中使用的 SHA-512 哈希，请运行命令：<command>openssl passwd -6 -salt SalTsaLt
     <replaceable>PASSWORD</replaceable></command>。
    </para>
    <warning>
     <title>用户口令</title>
     <para>
      为了避免潜在的安全风险，请不要在生产环境中使用口令。即使是使用经过哈希处理的口令，您也可能会遭到字典攻击。为了提高安全性，请使用 SSH 身份验证，而不要使用口令。
     </para>
    </warning>
    <para>
     创建用户时，请注意系统默认会禁用口令登录，并且新建的用户没有 sudo 权限。
    </para>
    <para>
     以下示例显示了用于创建各种用户的配置。
    </para>
    <example xml:id="cloud-init-user1">
     <title>具有口令和 sudo 权限的新用户</title>
<screen>#cloud-config
users:
  - default
  - name: <replaceable>USER</replaceable>
    shell: /bin/bash
    groups: users
    # lock_passwd: Disable password login. Defaults to true
    lock_passwd: false
    passwd: $6$SalTsaLt$.cuqsgjNGxHJZSLmVqkI/j9.kWIiUQHqjlRswbHjTw9hIXdPomgey2DHzmp6Ho6wgqIKz3ufbOIKdQCnQHPSA1
    sudo: ALL=(ALL) NOPASSWD:ALL</screen>
    </example>
    <example xml:id="cloud-init-user2">
     <title>具有 SSH 密钥和 sudo 权限的新用户</title>
<screen>#cloud-config
users:
  - name: <replaceable>USER</replaceable>
    shell: /bin/bash
    groups: users
    ssh_import_id: None
    lock_passwd: true
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
      - <replaceable>SSH_PUBLIC_KEY_1</replaceable>
      - <replaceable>SSH_PUBLIC_KEY_2</replaceable></screen>
    </example>
    <para>
     要连接 SUMA、RMT 或 SUSEConnect 并在其中注册，请使用 <literal>runcmd</literal> 模块运行所需的命令，例如：
    </para>
<screen>#cloud-config
runcmd:
  - SUSEConnect -r <replaceable>REGISTRATION_CODE</replaceable> -e <replaceable>EMAIL_ADDRESS</replaceable></screen>
    <para>
     有关更多信息，请参见 <link xlink:href="https://documentation.suse.com/sles/html/SLES-all/cha-register-sle.html"/>。
    </para>
    <para>
     对于 RMT，配置如下所示：
    </para>
<screen>#cloud-config
runcmd:
  - curl http://<replaceable>RMT_SERVER</replaceable>/tools/rmt-client-setup \ --output rmt-client-setup
  - sh rmt-client-setup https://<replaceable>RMT_SERVER/</replaceable></screen>
    <para>
     有关更多信息，请参见 <link xlink:href="https://documentation.suse.com/sles/html/SLES-all/cha-rmt-client.html"/>。
    </para>
    <para>
     对于 SUMA，配置如下所示：
    </para>
<screen>#cloud-config
runcmd:
  - curl -O http://suma01/pub/bootstrap/bootstrap.sh
  - /bin/bash bootstrap.sh</screen>
    <para>
     有关更多信息，请参见 <link xlink:href="https://documentation.suse.com/external-tree/en-us/suma/4.0/suse-manager/client-configuration/registration-bootstrap.html"/>。
    </para>
    <para>
     最后，下面的示例显示了用于安装某个软件包并在首次引导期间启动某个服务的配置。
    </para>
<screen>#cloud-config
packages:
  - qemu-guest-agent
runcmd:
  - systemctl enable qemu-guest-agent.service
  - systemctl start --no-block qemu-guest-agent.service</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-kvmxen-xen">
   <title>KVM/Xen 和 Xen 风格</title>
   <para>
    适用于 KVM/Xen 和 Xen 的 Minimal VM 映像随附以下软件包：
   </para>
   <itemizedlist>
    <listitem>
     <para>
      xen-tools-domU
     </para>
    </listitem>
    <listitem>
     <para>
      grub2-x86_64-xen
     </para>
    </listitem>
    <listitem>
     <para>
      xen-libs
     </para>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="sec-ms-hyperv">
   <title>Microsoft Hyper-V 风格</title>
   <para>
    适用于 Microsoft Hyper-V 的 Minimal VM 映像随附 <package>hyper-v</package>。
   </para>
  </sect2>

  <sect2 xml:id="sec-vmware">
   <title>VMware 风格</title>
   <para>
    适用于 VMware 的 Minimal VM 映像随附 <package>open-vm-tools</package>。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-minvm-kvm">
  <title>在 KVM 上安装和运行 Minimal VM</title>

  <para>
   如果您的本地计算机上已安装 KVM，您便可使用现成的 Minimal VM 映像来创建虚拟机。这样可以安全地试验 Minimal VM。
  </para>

  <para>
   从 <link xlink:href="https://www.suse.com/products/server/jeos/"/> 上下载适用于 KVM 的 60 天试用版 Minimal VM 映像。
  </para>

  <para>
   请参考以下过程在 KVM 中创建 Minimal VM 虚拟机。
  </para>

  <procedure>
   <title>创建 Minimal VM 虚拟机</title>
   <step>
    <para>
     启动虚拟机管理器，然后选择<menuchoice><guimenu>文件</guimenu> <guimenu>新建虚拟机</guimenu></menuchoice>。
    </para>
   </step>
   <step>
    <para>
     选择<guimenu>导入现有磁盘映像</guimenu>并单击<guimenu>前进</guimenu>。
    </para>
   </step>
   <step>
    <para>
     单击<guimenu>提供现有存储路径</guimenu>字段旁的<guimenu>浏览</guimenu>按钮。
    </para>
   </step>
   <step>
    <para>
     在<guimenu>选择存储卷</guimenu>对话框中，单击<guimenu>添加池</guimenu>，为新池指定名称，然后从<guimenu>类型</guimenu>下拉框中选择 <guimenu>dir: 文件系统目录</guimenu>。单击<guimenu>前进</guimenu>。
    </para>
    <informalfigure>
     <mediaobject>
      <imageobject>
       <imagedata width="80%" fileref="jeos_add_pool.png"/>
      </imageobject>
      <textobject><phrase>Add a new storage pool</phrase>
      </textobject>
     </mediaobject>
    </informalfigure>
   </step>
   <step>
    <para>
     单击<guimenu>目标路径</guimenu>字段旁的<guimenu>浏览</guimenu>按钮，然后选择包含 Minimal VM qcow2 映像的目录。单击<guimenu>完成</guimenu>。
    </para>
   </step>
   <step>
    <para>
     回到<guimenu>选择存储卷</guimenu>对话框，选择创建的池，然后在<guimenu>卷</guimenu>部分选择 qcow2 映像。然后单击<guimenu>选择卷</guimenu>。
    </para>
    <informalfigure>
     <mediaobject>
      <imageobject>
       <imagedata width="80%" fileref="jeos_choose_qcow2.png"/>
      </imageobject>
      <textobject><phrase>Select the qcow2 image</phrase>
      </textobject>
     </mediaobject>
    </informalfigure>
   </step>
   <step>
    <para>
     回到<guimenu>创建虚拟机</guimenu>对话框，在<guimenu>选择您要安装的操作系统</guimenu>字段中输入 <literal>Generic</literal>。单击<guimenu>前进</guimenu>。
    </para>
   </step>
   <step>
    <para>
     将 RAM 值设为 1024，将 CPU 数量设为 1。单击<guimenu>前进</guimenu>。
    </para>
    <informalfigure>
     <mediaobject>
      <imageobject>
       <imagedata width="80%" fileref="jeos_ram_cpu.png"/>
      </imageobject>
      <textobject><phrase>Specify RAM and CPU settings</phrase>
      </textobject>
     </mediaobject>
    </informalfigure>
   </step>
   <step>
    <para>
     为新虚拟机指定名称（例如 <literal>Minimal VM</literal>），然后单击<guimenu>完成</guimenu>。
    </para>
    <informalfigure>
     <mediaobject>
      <imageobject>
       <imagedata width="80%" fileref="jeos_finish.png"/>
      </imageobject>
      <textobject><phrase>Minimal VM virtual machine configuration</phrase>
      </textobject>
     </mediaobject>
    </informalfigure>
   </step>
   <step>
    <para>
     如果收到启动虚拟网络的提示，请单击<guimenu>是</guimenu>。
    </para>
   </step>
  </procedure>

  <para>
   系统引导后，jeos-firstboot 会指引您完成初始系统设置。
  </para>

  <procedure xml:id="pro-rpi-firstboot-minvm">
   <note>
    <title>更改区域设置</title>
    <para>
     Minimal VM 映像仅随附 <literal>en_US</literal> 区域设置。完成设置后，您可以通过安装 <package>glibc-locale</package> 软件包并运行 <command>localectl set-locale
     LANG=<replaceable>LOCALE</replaceable></command> 命令（将 <replaceable>LOCALE</replaceable> 替换为所需的语言区域设置，例如 <literal>de_DE.UTF-8</literal>），来安装并选择所需的系统区域设置。
    </para>
   </note>
   <step>
    <para>
     第一步，系统会提示您使用键盘选择对话框选择合适的键盘布局。
    </para>
   </step>
   <step>
    <para>
     下一步，阅读并接受许可协议。不接受许可协议将无法继续。
    </para>
   </step>
   <step>
    <para>
     指定所需的时区。
    </para>
   </step>
   <step>
    <para>
     出现提示时，指定并确认所需的 root 口令。
    </para>
   </step>
   <step>
    <para>
     最后一步，系统会引导您注册系统。如果您只想测试 Minimal VM，可以跳过注册步骤。
    </para>
   </step>
   <step>
    <para>
     完成初始配置后，您便可以使用在设置过程中指定的口令以 <literal>root</literal> 身份登录系统。
    </para>
   </step>
  </procedure>

  <tip>
   <title>首次引导后安装产品补丁</title>
   <para>
    我们强烈建议您在成功安装并注册 Minimal VM 后安装可用的最新联机更新。
   </para>
  </tip>
 </sect1>
 <xi:include href="common_copyright_quick.xml"/>
 <xi:include href="common_license_gfdl1.2.xml"/>
</article>
