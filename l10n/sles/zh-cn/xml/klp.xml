<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="klp.xml" version="5.0" xml:id="cha-klp" xml:lang="zh-cn">
 <title>使用 KLP 的在线内核增补</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    本文档介绍内核在线增补 (KLP) 技术的基本原理，并提供 SLE Live Patching 服务的使用准则。
   </para>
  </abstract>
 </info>
 <para>
  KLP 让您无需重引导便可应用 Linux 内核的最新安全性更新。如此可最大限度地提高系统正常运行时间和可用性，这对于任务关键型系统而言尤为重要。
 </para>
 <para>
  本文档中提供的信息与 AMD64/Intel 64、POWER 和 IBM Z 体系结构相关。
 </para>
 <sect1 xml:id="sec-klp-advantages">
  <title>内核在线增补的优势</title>

  <para>
   KLP 提供了多项优势。
  </para>

  <itemizedlist>
   <listitem>
    <para>
     对于需获得或维护特定合规认证的组织而言，确保大量服务器自动保持最新状态至关重要。KLP 可在帮助实现合规的同时，减少对费用高昂的维护期的需求。
    </para>
   </listitem>
   <listitem>
    <para>
     签订了服务级别协议合同的公司必须保证其系统可用性和正常运行时间达到特定的级别。在线增补可在不产生停机时间的情况下增补系统。
    </para>
   </listitem>
   <listitem>
    <para>
     由于 KLP 是标准系统更新机制的一部分，因此无需专门培训或引入复杂的维护例程。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec-klp-overview">
  <title>内核在线增补概述</title>

  <para>
   内核在线补丁通过内含经过修改的代码的软件包提供，此类软件包与主内核软件包不同。在线补丁具有累积性，因此最新的补丁包含内核软件包先前补丁的所有修复。每个内核在线软件包都与为其发布的确切内核修订版关联。每新增一个修复，在线补丁软件包版本号都会相应增加。
  </para>

  <important>
   <title>在线补丁和内核更新的对比</title>
   <para>
    在线补丁仅包含关键修复，不会替代常规的内核更新，后者需要重引导系统。可以将在线补丁视为在执行适当的内核更新和重引导前用于暂时保护内核的措施。
   </para>
  </important>

  <para>
   下图阐述了在线补丁与内核更新之间的总体关系。使用 <command>klp -v patches</command> 命令可以查看当前有效的在线补丁所解决的 CVE 列表和缺陷报告。
  </para>

  <informalfigure>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="klp.png" width="80%"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="klp.png" width="100%"/>
    </imageobject>
   </mediaobject>
  </informalfigure>

  <para>
   您可以安装多个版本的内核软件包及其在线补丁。这些软件包不会冲突。您可以为正在运行的内核安装更新的内核软件包及在线补丁。在此情况下，您可能会收到重引导系统的提示。订阅了 SLE Live Patching 的用户有权获享技术支持，只要正在运行的内核存在在线补丁更新（请参见<xref linkend="sec-klp-lifecycle"/>）。
  </para>

  <para>
   激活 KLP 后，每个内核更新都会附带在线补丁软件包。此在线补丁不包含任何修复，而是充当相应内核未来在线补丁的种子。这些空种子补丁称为<literal>初始补丁</literal>。
  </para>

  <sect2 xml:id="sec-klp-scope">
   <title>内核在线增补范围</title>
   <para>
    SLE Live Patching 的增补范围包括 SUSE 通用漏洞评分系统（CVSS；SUSE CVSS 基于 CVSS v3.0 系统开发）7 级以上系统稳定或数据损害相关漏洞和 bug 修复。但从技术上而言，为属于指定类别的所有修复都创建在线补丁可能并不现实。因此，SUSE 保留在因技术原因而无法创建内核在线补丁的情况下跳过相应修复的权利。目前超过 95% 的合格修复都是以在线补丁的形式发布的。有关 CVSS（SUSE CVSS 评分基础）的详细信息，请参见 <link xlink:href="https://www.first.org/cvss/">Common Vulnerability Scoring System SIG</link>。
   </para>
  </sect2>

  <sect2 xml:id="sec-klp-limitations">
   <title>内核在线增补局限性</title>
   <para>
    KLP 涉及替换功能和妥善处理相互依赖的功能集的替换。这通过将旧代码调用重定向到不同内存位置的更新代码来完成。数据结构的变化使情况变得更加复杂，因为数据会保持原状，无法扩展或重新解译。尽管使用某些技术可以间接更改数据结构，但有些修复无法转换为在线补丁。在此情况下，只能通过系统重启动来应用修复。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-klp-enable-with-yast2">
  <title>使用 YaST 激活内核在线增补</title>

  <para>
   要在您的系统上激活 KLP，您需要拥有有效的 SLES 和 SLE Live Patching 订阅。请访问 <link xlink:href="https://scc.suse.com/">SUSE Customer Center</link> 检查您的订阅的状态，并获取 SLE Live Patching 订阅的注册代码。
  </para>

  <para>
   要在您的系统上激活内核在线增补，请执行以下步骤：
  </para>

  <procedure>
   <step>
    <para>
     运行 <command>yast2 registration</command> 命令并单击<guimenu>选择扩展</guimenu>。
    </para>
   </step>
   <step>
    <para>
     在可用扩展列表中选择 <guimenu>SUSE Linux Enterprise Live Patching 15</guimenu>，然后单击<guimenu>下一步</guimenu>。
    </para>
   </step>
   <step>
    <para>
     确认许可条款并单击<guimenu>下一步</guimenu>。
    </para>
   </step>
   <step>
    <para>
     输入您的 SLE Live Patching 注册代码并单击<guimenu>下一步</guimenu>。
    </para>
   </step>
   <step>
    <para>
     检查<guimenu>安装摘要</guimenu>和选定的<guimenu>软件集</guimenu>。系统应该会自动选择安装 <systemitem>Live
     Patching</systemitem> 和 <systemitem>SLE Live Patching Lifecycle
     Data</systemitem> 软件集以及一些其他软件包，以满足依赖关系。
    </para>
   </step>
   <step>
    <para>
     单击<guimenu>接受</guimenu>完成安装。这样将会在您的系统上安装基础内核在线增补组件、初始在线补丁，以及所需的依赖项。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-klp-enable-cli">
  <title>从命令行激活内核在线增补</title>

  <para>
   要激活内核在线增补，您需要拥有有效的 SLES 和 SLE Live Patching 订阅。请访问 <link xlink:href="https://scc.suse.com/">SUSE Customer Center</link> 查看您的订阅的状态，并获取 SLES Live Patching 订阅的注册代码。
  </para>

  <procedure>
   <step>
    <para>
     运行 <command>sudo SUSEConnect --list-extensions</command>。请记住 SLES Live Patching 的确切激活命令。示例命令输出（缩略版）：
    </para>
<screen>$ SUSEConnect --list-extensions
...
SUSE Linux Enterprise Live Patching <phrase role="productnumber"><phrase os="sles;sled">15 SP4</phrase></phrase> x86_64
Activate with: SUSEConnect -p sle-module-live-patching/15.4/x86_64 \
  -r ADDITIONAL REGCODE</screen>
   </step>
   <step>
    <para>
     使用获得的命令后跟 <option>-r <replaceable>LIVE_PATCHING_REGISTRATION_CODE</replaceable></option> 激活 SLES Live Patching，例如：
    </para>
<screen>SUSEConnect -p sle-module-live-patching/15.4/x86_64 \
  -r <replaceable>LIVE_PATCHING_REGISTRATION_CODE</replaceable></screen>
   </step>
   <step>
    <para>
     使用 <command>zypper install -t pattern lp_sles</command> 命令安装所需的软件包和依赖项。
    </para>
   </step>
  </procedure>

  <para>
   至此，系统已完成在线增补。
  </para>

  <para>
   后台进行的过程如下：当软件包安装系统检测到某个安装的内核可以在线增补，并且软件通道中存在相应的在线补丁时，系统会选择安装该在线补丁。然后内核会在<emphasis>软件包安装过程中</emphasis>接收到在线补丁修复。在产品安装完成前，内核就会进行在线增补。
  </para>
 </sect1>
 <sect1 xml:id="sec-klp-perform">
  <title>执行内核在线增补</title>

  <para>
   内核在线补丁是在常规的系统更新过程中安装的。但您应了解以下几点。
  </para>

  <itemizedlist>
   <listitem>
    <para>
     如果已为正在运行的内核安装 <package>kernel-livepatch-*</package> 软件包，内核会进行在线增补。您可以使用 <command>zypper se --details kernel-livepatch-*</command> 命令来检查您的系统上安装了哪些内核在线补丁软件包。
    </para>
   </listitem>
   <listitem>
    <para>
     如果安装了 <package>kernel-default</package> 软件包，更新管理器会提示您重引导系统。为避免此消息显示，您可以将内核更新从增补操作中筛除。这可以通过使用 Zypper 添加软件包锁来实现。SUSE Manager 还可让您过滤通道内容（请参见<link xlink:href="https://documentation.suse.com/external-tree/en-us/suma/4.1/suse-manager/administration/live-patching.html">使用 SUSE Manager 进行在线增补</link>）。
    </para>
   </listitem>
   <listitem>
    <para>
     您可以使用 <command>klp status</command> 命令检查增补状态。要检查安装的补丁，请运行 <command>klp -v patches</command> 命令。
    </para>
   </listitem>
   <listitem>
    <para>
     请记住，虽然系统上可能会安装多个内核软件包，但任何时间只有一个软件包在运行。同样，虽然系统上可能会安装多个在线补丁软件包，但只有一个在线补丁会装载到内核中。
    </para>
   </listitem>
   <listitem>
    <para>
     有效的在线补丁包含在 <literal>initrd</literal> 中。这表示如果发生了意外重引导，系统启动时会应用在线补丁修复，因此不需要再次执行增补。
    </para>
   </listitem>
  </itemizedlist>

  <sect2 xml:id="sec-klp-lifecycle">
   <title>检查在线补丁的失效日期</title>
   <para>
    确保已安装 <package>lifecycle-data-sle-module-live-patching</package>，然后运行 <command>zypper lifecycle</command> 命令。在输出的 <literal>Package end of support if different from product</literal> 部分应该可以看到在线补丁的失效日期。
   </para>
   <para>
    每个在线补丁自底层内核软件包发布起一年内都会收到更新。您可以使用<link xlink:href="https://www.suse.com/products/live-patching/current-patches/">维护的内核、补丁更新和生命周期</link>页面根据运行的内核版本查看失效日期，无需安装产品扩展。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-klp-troubleshoot">
  <title>内核在线增补问题查错</title>

  <sect2 xml:id="sec-klp-man-patch-downgrade">
   <title>手动降级补丁</title>
   <para>
    如果您发现了最新的在线补丁有问题，可以将当前安装的在线补丁降级回之前的版本。我们建议在系统开始显现出问题前执行补丁降级。请注意，在系统日志中跟踪内核警告或内核错误的系统可能不适合使用补丁降级过程。如果您不确定系统是否满足补丁降级的要求，请联系 SUSE 技术支持部门获得帮助。
   </para>
   <procedure>
    <title>手动降级补丁</title>
    <step>
     <para>
      使用 <command>klp -v patches</command> 命令确定正在运行的在线补丁。以 <literal>RPM:</literal> 开头的行中显示的就是当前正在运行的补丁。例如：
     </para>
<screen>RPM: kernel-livepatch-5_3_18-24_29-default-2-2.1.x86_64</screen>
     <para>
      上例中的 <literal>5_3_18-24_29-default</literal> 指的就是正在运行的内核版本。
     </para>
    </step>
    <step>
     <para>
      使用 <command>zypper search -s kernel-livepatch-<replaceable>RUNNING_KERNEL_VERSION</replaceable>-default</command> 命令搜索补丁的先前版本。该命令会返回可用软件包版本列表。请注意，每个新在线补丁软件包发行版的版本号会加 1。请务必选择版本号低于当前版本号的发行版。
     </para>
    </step>
    <step>
     <para>
      使用 <command>zypper in --oldpackage kernel-livepatch-<replaceable>RUNNING_KERNEL_VERSION</replaceable>-default=<replaceable>DESIRED_VERSION</replaceable></command> 命令安装所需的版本。
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
</chapter>
