<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xml:base="net_xntp.xml" id="cha.netz.xntp">
 <title>NTPによる時刻の同期</title>
 <abstract>
  <para>
   NTP (network time protocol)メカニズムは、システムの時刻をネットワーク上で同期させるためのプロトコルです。最初に、マシンは信頼できる時刻を持つサーバに時刻を照会できます。次に、ネットワーク上の他のコンピュータがこのマシン自体に対し、時刻を照会できます。目的は2つあり、絶対的な時間を維持することと、ネットワーク内のすべてのマシンのシステム時刻を同期させることです。
  </para>
 </abstract>
 <para>
  正確なシステム時刻を維持することはさまざまな場で重要です。ハードウェア組み込み型クロックがデータベースやクラスタなどのアプリケーション要件に合致しないことがよくあります。システムタイムを手動で修正することは時に問題を発生させる可能性があります。たとえば、時間を逆廻りに戻すことで重要なアプリケーションの誤動作を誘発することもあります。ネットワーク内では、すべてのマシンのシステムタイムを同期させることが通常必要とされますが、手動での時刻調整はよい方法ではありません。NTPには、これらの問題を解決するメカニズムがあります。NTPサービスは、ネットワーク内の信頼できるタイムサーバのヘルプによって、システム時間を継続的に調整します。さらに、電波時計のようなローカルリファレンスクロックを管理する機能があります。
 </para>
 
 <sect1 id="sec.netz.xntp.yast">
  <title>YaSTでのNTPクライアントの設定</title>

  <para>
   <systemitem>ntp</systemitem>パッケージ付属のNTPデーモン(<systemitem class="daemon">ntpd</systemitem>)は、ローカルコンピュータを時間の参照に使用するように事前設定されています。ただし、ハードウェアクロックは、より正確な時間ソースが利用できない場合の予備としてのみ使用されます。YaSTを利用すれば、NTPクライアントを簡単に設定することができます。
  </para>

  <sect2 id="sec.net.ntp.yast.basic">
   <title>基本的な設定</title>
   <para>
    YaST NTPクライアントの設定(<menuchoice><guimenu>ネットワークサービス</guimenu><guimenu>NTP環境設定</guimenu></menuchoice>)は、タブで構成されています。<systemitem class="daemon">ntpd</systemitem>の起動モードと照会先のサーバは、<guimenu>一般的な設定</guimenu>タブで設定します。
   </para>
   <variablelist>
    <varlistentry>
     <term><guimenu>手動でのみ</guimenu>
     </term>
     <listitem>
      <para>
       <guimenu>手動でのみ</guimenu>は、<systemitem class="daemon">ntpd</systemitem>デーモンを手動で開始する場合に選択します。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><guimenu>今すぐ開始し、システム起動時に開始するよう設定</guimenu>
     </term>
     <listitem>
      <para>
       システムのブート時に自動的に<systemitem class="daemon">ntpd</systemitem>を起動するには、<guimenu>今すぐ開始し、システム起動時に開始するよう設定</guimenu>を選択します。この設定をお勧めします。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>



  <sect2 id="sec.net.ntp.yast.new_sync">
   <title>基本的な設定の変更</title>
   <para>
    <guimenu>一般の設定</guimenu>タブの下部には、クライアントに対するサーバおよび時刻情報のその他の情報源が表示されます。必要に応じて、<guimenu>追加</guimenu>、<guimenu>削除</guimenu>、および<guimenu>編集</guimenu>を使用してこのリストを変更します。<guimenu/>Display Log］では、クライアントのログファイルを表示できます。
   </para>
   <para>
    時刻情報の情報源を追加するには、<guimenu>追加</guimenu>をクリックします。表示されるダイアログで、時刻同期に使用する情報源のタイプを選択します。次のオプションを指定できます。
   </para>
   <figure id="fig.yast.ntp.selserv">
    <title>YaST: NTPサーバ</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata width="75%" fileref="yast_ntp_selserv.png" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata width="75%" fileref="yast_ntp_selserv.png" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <variablelist>
    <varlistentry>
     <term>サーバ</term>
     <listitem>
      <para>
       <guimenu>選択</guimenu>プルダウンリスト(<xref linkend="fig.yast.ntp.selserv"/>参照)で、ローカルネットワーク上のタイムサーバ(<guimenu>ローカルNTPサーバ</guimenu>)または目的のタイムゾーンを担当するインターネット上のタイムサーバ(<guimenu>公開NTPサーバ</guimenu>)のどちらを使用して時刻の同期を設定するか決定します。ローカルタイムサーバを使用する場合は、<guimenu>検索</guimenu>をクリックして、ネットワーク上の利用可能なタイムサーバを問い合わせるSLPクエリを実行します。検索結果のリストから最適なタイムサーバを選択し、<guimenu>受諾</guimenu>をクリックしてダイアログを閉じます。インターネット上の公開タイムサーバを使用する場合は、国(タイムゾーン)および適切なタイムサーバを<guimenu>公開NTPサーバ</guimenu>のリストから選択し、<guimenu>受諾</guimenu>をクリックしてダイアログを閉じます。メインダイアログの<guimenu>テスト</guimenu>を使用して、選択されているサーバの可用性をテストします。<guimenu>オプション</guimenu>では、<systemitem class="daemon">ntpd</systemitem>の追加オプションを指定できます。
      </para>
      <para>
       <guimenu>Access Control Options</guimenu>を使用すると、コンピュータ上で実行するデーモンによりリモートコンピュータが実行可能なアクションを制限できます。このフィールドは、<guimenu>セキュリティの設定</guimenu>タブで<guimenu>NTP サービスを設定したサーバに制限する</guimenu>にチェックマークを入れた後でのみ有効になります(<xref linkend="fig.yast.ntp.adv.sec"/>参照)。このオプションは、<filename>/etc/ntp.conf</filename>内の<literal>restrict</literal>節に対応します。たとえば<literal>nomodify notrap noquery</literal>は、サーバがコンピュータのNTP設定を変更し、NTPデーモンのトラップ機能(リモートイベントのログ記録機能)を使用することを拒否します。自身の管理下にないサーバについては(たとえばインターネット上のサーバなど)、こうした制限を適用することをお勧めします。
      </para>
      <para>
       詳細については、<filename>/usr/share/doc/packages/ntp-doc</filename>(<systemitem>ntp-doc</systemitem>パッケージの一部)を参照してください。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>ピア</term>
     <listitem>
      <para>
       ピアは、対称的な関係が確立されたコンピュータで、タイムサーバとクライアントの両方の役割を果たします。サーバの代わりに、同じネットワーク内のピアを使用するには、そのピアシステムのアドレスを入力します。ダイアログのそれ以外の内容は<guimenu>サーバ</guimenu>ダイアログと同じです。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>ラジオクロック</term>
     <listitem>
      <para>
       時刻同期にシステムのラジオクロックを使用するには、クロックタイプ、ユニット番号、デバイス名、およびその他のオプションをこのダイアログで指定します。ドライバを微調整するには、<guimenu>ドライバの調整</guimenu>をクリックします。ローカルラジオクロックの動作の詳細については、<filename>/usr/share/doc/packages/ntp-doc/refclock.html</filename>を参照してください。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>ブロードキャストの発信</term>
     <listitem>
      <para>
       時刻情報とクエリは、ネットワーク上にブロードキャストすることができます。このダイアログでは、このブロードキャストの送信先を指定します。電波時計のような信頼できる時刻ソースがない限りブロードキャストをアクティブにしないでください。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>ブロードキャストの着信</term>
     <listitem>
      <para>
       クライアントで情報をブロードキャスト経由で受け取る場合は、どのアドレスからのパケットを受け入れるかをこのフィールドに指定します。

      </para>
     </listitem>
    </varlistentry>
   </variablelist>



   <figure id="fig.yast.ntp.adv.sec">
    <title>高度なNTP設定:セキュリティの設定</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata width="75%" fileref="yast2_xntp_adv_sec.png" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata width="75%" fileref="yast2_xntp_adv_sec.png" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    <guimenu>セキュリティの設定</guimenu>タブで(<xref linkend="fig.yast.ntp.adv.sec"/>参照)、<systemitem class="daemon">ntpd</systemitem>をchroot jailで起動するかどうか指定します。デフォルトでは、<guimenu>Run NTP Daemon in Chroot Jail</guimenu>が選択されています。このオプションは、攻撃によってシステム全体が危険な状態に陥ることを防ぐので、<systemitem class="daemon">ntpd</systemitem>が攻撃された場合のセキュリティを強化します。
   </para>
   <para>
    <guimenu>NTPサービスを設定したサーバに制限する</guimenu>は、リモートコンピュータがユーザのコンピュータのNTP設定を表示および変更すること、およびリモートイベントログのトラップ機能を使用することを拒否し、それによってシステムのセキュリティを向上させます。<guimenu>一般の設定</guimenu>タブの時間ソースのリストで、個別のコンピュータに対するアクセス制御オプションを上書きしない限り、こうした制限は有効になるとすべてのリモートコンピュータに適用されます。他のすべてのリモートコンピュータでは、ローカルタイムのクエリのみが許可されます。
   </para>
   <para>
    SuSEfirewall2がアクティブな場合、<guimenu>ファイアウォールでポートを開く</guimenu>を有効にします(デフォルト)。ポートを閉じたままにすると、タイムサーバと接続を確立することはできません。
   </para>
  </sect2>
 </sect1>



 <sect1 id="sec.netz.xntp.netconf">
  <title>ネットワークでのntpの手動設定</title>

  <para>

   ネットワーク内のタイムサーバを使用するには、serverパラメータを設定するのが最も簡単です。たとえば、タイムサーバ<systemitem>ntp.example.com</systemitem>がネットワークから接続可能な場合、その名前をファイル<filename>/etc/ntp.conf</filename>に行として追加します。
  </para>

<screen>server ntp.example.com</screen>

  <para>
   別のタイムサーバを追加するには、別の行にキーワードの「<literal>server</literal>」を挿入します。<command>systemctl start ntp.service</command>コマンドで<systemitem class="daemon">ntpd</systemitem>を初期化後、時間が安定し、ローカルコンピュータのクロックを修正するドリフトファイルが作成されるまで、約1時間かかります。ドリフトファイルを用いることで、バードウェアクロックの定誤差はコンピュータの電源が入った時点で、すぐに算出されます。修正はすぐに反映されるため、システム時刻がより安定します。
  </para>

  <para>
   NTP機構をクライアントとして使用するには、2種類の方法があります。まず、クライアントは既知のサーバに定期的に時間を照会することができます。クライアント数が多い場合、この方法はサーバの過負荷を引き起こす可能性があります。2つ目は、ネットワークでブロードキャストを行う時刻サーバから送信されるNTPブロードキャストを、クライアントが待機する方法です。この方法には不利な面があります。サーバの精度が不明なこと、そしてサーバから送信される情報が誤っていた場合、深刻な問題が発生する可能性があることです。
  </para>

  <para>
   ブロードキャスト経由で時刻を取得する場合、サーバ名は必要ではありません。この場合は、設定ファイル<literal>/etc/ntp.conf</literal>に行<filename>broadcastclient</filename>を記述します。1つ以上の信頼された時刻サーバのみを使用するには、<literal>servers</literal>で始まる行にサーバの名前を記述します。
  </para>


 </sect1>



 <sect1 id="sec.netz.xntp.dynamic">
  <title>ランタイム時の動的時刻同期</title>



  <para>
   ネットワークに接続せずにシステムが起動すると、<systemitem class="daemon">ntpd</systemitem>は起動しますが、設定ファイルで設定されたタイムサーバのDNS名を解決できません。これは、暗号化されたWi-Fiでネットワークマネージャを使用するときに発生します。
  </para>

  <para>
   ランタイム時に<systemitem class="daemon">ntpd</systemitem>でDNS名を解決するには、<systemitem>dynamic</systemitem>オプションを設定する必要があります。ネットワークが起動後に確立されると、<systemitem class="daemon">ntpd</systemitem>は再度名前を検索し、時刻を取得するタイムサーバに到達します。
  </para>

  <para>
   <filename>/etc/ntp.conf</filename>を手動で編集して、<systemitem>dynamic</systemitem>を1つ以上の<systemitem>server</systemitem>エントリに追加します。
  </para>

<screen>server ntp.example.com dynamic</screen>

  <para>
   または、YaSTを使用して、次の手順に従います。
  </para>

  <procedure>
   <step performance="required">
    <para>
     YaSTで、<menuchoice><guimenu>ネットワークサービス</guimenu><guimenu>NTP環境設定</guimenu></menuchoice>の順にクリックします。
    </para>
   </step>
   <step performance="required">
    <para>
     設定するサーバを選択します。<guimenu>編集</guimenu>をクリックします。
    </para>
   </step>
   <step performance="required">
    <para>
     <guimenu>オプション</guimenu>フィールドを有効にして、［<literal>dynamic</literal>］を追加します。他のオプションが入力されている場合は、スペースで区切ります。
    </para>
   </step>
   <step performance="required">
    <para>
     <guimenu>OK</guimenu>をクリックして、編集ダイアログを閉じます。前の手順を繰り返して、必要に応じてすべてのサーバを変更します。
    </para>
   </step>
   <step performance="required">
    <para>
     最後に、<guimenu>OK</guimenu>をクリックして設定を保存します。
    </para>
   </step>
  </procedure>
 </sect1>



 <sect1 id="sec.netz.xntp.normal">
  <title>ローカルリファレンスクロックの設定</title>

  <para>
   <systemitem class="daemon">ntpd</systemitem>ソフトウェアパッケージには、ローカルリファレンスクロックに接続するためのドライバが含まれています。サポートされているクロックのリストは、<systemitem class="resource">ntp-doc</systemitem>パッケージの<filename>/usr/share/doc/packages/ntp-doc/refclock.htm</filename>ファイルに記載されています。各ドライバには、番号が関連付けられています。NTPでは、実際の設定は疑似IPアドレスを使用して行われます。クロックは、ネットワークに存在しているものとして<filename>/etc/ntp.conf</filename>ファイルに入力されます。このため、これらのクロックには<literal>127.127.<replaceable>t</replaceable>.<replaceable>u</replaceable></literal>という形式の特別なIPアドレスが割り当てられます。ここで、<replaceable>t</replaceable>はクロックのタイプを示し、使用されているドライバを決定します。<replaceable>u</replaceable>はユニットのタイプを示し、使用されているインタフェースを決定します。

  </para>

  <para>
   通常、各ドライバは設定をより詳細に記述する特別なパラメータを持っています。<filename>/usr/share/doc/packages/ntp-doc/driver<replaceable>NN</replaceable>.html</filename>(ここで<replaceable>NN</replaceable>はドライバの番号)ファイルは、特定のクロックタイプの情報を提供します。たとえば、<quote>タイプ 8</quote>クロック(シリアルインタフェース経由のラジオクロック)はクロックをさらに細かく指定する追加モードを必要とします。また、Conrad DCF77レシーバモジュールはモード 5です。このクロックを優先参照として使用するには、キーワード<literal>prefer</literal>を指定します。Conrad DCF77レシーバモジュールの完全な<literal>server</literal>行は次のようになります。
  </para>

<screen>server 127.127.8.0 mode 5 prefer</screen>

  <para>
   他のクロックも同じパターンで記述されます。<systemitem class="resource">ntp-doc</systemitem>パッケージのインストール後は、ntpのマニュアルを<filename>/usr/share/doc/packages/ntp-doc</filename>ディレクトリで参照できます。ドライバパラメータについて説明するドライバページへのリンクは、ファイル<filename>/usr/share/doc/packages/ntp-doc/refclock.htm</filename>に記述されています。
  </para>
 </sect1>
 <sect1 id="sec.netz.xntp.etr" arch="zseries">
  <title>ETR（External Time Reference)とのクロックの同期</title>



  <para>
   ETR（External Time Reference）とのクロック同期のサポートを利用できます。ETRは、2**20(2の20乗)マイクロ秒ごとに、発振器信号と同期信号を送信して、すべての接続先サーバのTODクロックの同期を保ちます。
  </para>

  <para>
   可用性のため、2ユニットのETRをコンピュータに接続できます。クロックが同期チェックの許容値を超えた場合は、すべてのCPUがマシンをチェックし、クロックが同期していないことを示します。この事態が発生した場合は、XRC対応デバイスへのすべてのDASD I/Oがクロックの再同期まで停止します。
  </para>

  <para>
   ETRサポートは2つの<literal>sysfs</literal>属性を介して有効化されます。<systemitem class="username">root</systemitem>として次のコマンドを実行します。
  </para>

<screen>echo 1 &gt; /sys/devices/system/etr/etr0/online
echo 1 &gt; /sys/devices/system/etr/etr1/online
</screen>
 </sect1>
</chapter>
