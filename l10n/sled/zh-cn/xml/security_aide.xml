<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="security_aide.xml" version="5.0" xml:id="cha-aide">
 <title>使用 AIDE 进行入侵检测</title>
 <info>
      <abstract>
        <para>
    保护您的系统是任何一位任务关键型系统管理员必须完成的任务。由于无法始终保证系统的安全性不会受到损害，定期执行额外的检查（例如，使用 <systemitem class="daemon">cron</systemitem> 进行检查）以确保系统仍受您的控制，就显得非常重要。这正是 AIDE（<emphasis>高级入侵检测环境</emphasis>）的用武之地。
   </para>
      </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:bugtracker>
        </dm:bugtracker>
	<dm:translation>yes</dm:translation>
      </dm:docmanager>
    </info>
    <sect1 xml:id="sec-aide-why">
  <title>为何要使用 AIDE？</title>

  <para>
   可以通过 RPM 执行简单的检查，这往往可以发现一些不必要的更改。软件包管理器具有一项内置的校验功能，可以检查系统中所有受管文件发生的更改。要校验所有文件，请运行命令 <command>rpm -Va</command>。不过，此命令还会显示配置文件中的更改，您需要进行过滤才能检测出重要的更改。
  </para>

  <para>
   使用 RPM 进行检查的另一个问题在于，聪明的攻击者可能修改 <command>rpm</command> 本身，以隐藏通过某种 root-kit 进行的任何更改，这样攻击者便可掩盖其入侵行为并获得 root 特权。要解决此问题，您应该实施另一项检查，这项检查也可以独立于安装的系统运行。
  </para>
 </sect1>
 <sect1 xml:id="sec-aide-setup">
  <title>设置 AIDE 数据库</title>

  <important>
   <title>安装后初始化 AIDE 数据库</title>
   <para>
    在安装系统之前，请校验媒体的校验和（参见<xref linkend="sec-installation-troubleshooting-checking-media"/>），以确保您使用的不是受损安装源。安装系统后，初始化 AIDE 数据库。为确保在安装期间和之后一切正常，请在计算机未连到任何网络的情况下，直接在控制台上进行安装。在 AIDE 创建其数据库之前，请不要使计算机处于无人照管的状态或将其连接到任何网络。
   </para>
  </important>

  <para>
   <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 上默认不会安装 AIDE。要安装 AIDE，请使用<menuchoice><guimenu>计算机</guimenu> <guimenu>安装软件</guimenu></menuchoice>，或者以 <systemitem class="username">root</systemitem> 身份在命令行中输入 <literal>zypper install
   aide</literal>。
  </para>

  <para>
   要告知 AIDE 应检查哪些文件的哪些属性，请使用 <filename>/etc/aide.conf</filename> 配置文件。此文件必须经过修改才能成为实际的配置。第一部分处理一般参数，例如 AIDE 数据库文件的位置。<systemitem>Custom
   Rules</systemitem> 和 <systemitem>Directories and Files</systemitem> 部分与本地配置更相关。典型规则如下所示：
  </para>

<screen>Binlib     = p+i+n+u+g+s+b+m+c+md5+sha1</screen>

  <para>
   定义 <literal>Binlib</literal> 变量后，将在文件部分使用相应的检查框。重要选项包括：
  </para>

  <table xml:id="tab-aide-options">
   <title>重要的 AIDE 检查框</title>
   <tgroup cols="2">
    <thead>
     <row>
      <entry>
       <para>
        选项
       </para>
      </entry>
      <entry>
       <para>
        说明
       </para>
      </entry>
     </row>
    </thead>
    <tbody>
     <row>
      <entry>
       <para>
        p
       </para>
      </entry>
      <entry>
       <para>
        检查选定文件或目录的文件权限。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        i
       </para>
      </entry>
      <entry>
       <para>
        检查 inode 编号。每个文件名都有一个不得更改的唯一 inode 编号。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        n
       </para>
      </entry>
      <entry>
       <para>
        检查指向相关文件的链接数。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        u
       </para>
      </entry>
      <entry>
       <para>
        检查文件拥有者是否已更改。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        g
       </para>
      </entry>
      <entry>
       <para>
        检查文件组是否已更改。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        s
       </para>
      </entry>
      <entry>
       <para>
        检查文件大小是否已更改。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        b
       </para>
      </entry>
      <entry>
       <para>
        检查文件使用的块计数是否已更改。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        m
       </para>
      </entry>
      <entry>
       <para>
        检查文件的修改时间是否已更改。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        c
       </para>
      </entry>
      <entry>
       <para>
        检查文件访问时间是否已更改。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        S
       </para>
      </entry>
      <entry>
       <para>
        检查更改的文件大小。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        I
       </para>
      </entry>
      <entry>
       <para>
        忽略文件名的更改。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        md5
       </para>
      </entry>
      <entry>
       <para>
        检查文件的 md5 校验和是否已更改。我们建议使用 sha256 或 sha512。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        sha1
       </para>
      </entry>
      <entry>
       <para>
        检查文件的 sha1（160 位）校验和是否已更改。我们建议使用 sha256 或 sha512。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        sha256
       </para>
      </entry>
      <entry>
       <para>
        检查文件的 sha256 校验和是否已更改。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        sha512
       </para>
      </entry>
      <entry>
       <para>
        检查文件的 sha512 校验和是否已更改。
       </para>
      </entry>
     </row>
    </tbody>
   </tgroup>
  </table>

  <para>
   此配置使用 <literal>Binlib</literal> 中定义的选项检查 <filename>/sbin</filename> 中的所有文件，但会忽略 <filename>/sbin/conf.d/</filename> 目录：
  </para>

<screen>/sbin  Binlib
!/sbin/conf.d</screen>

  <para>
   要创建 AIDE 数据库，请执行以下操作：
  </para>

  <procedure xml:id="pro-aide-setup-db">
   <step>
    <para>
     打开 <filename>/etc/aide.conf</filename>。
    </para>
   </step>
   <step>
    <para>
     定义应使用哪些检查框检查哪些文件。有关可用检查框的完整列表，请参见 <filename>/usr/share/doc/packages/aide/manual.html</filename>。定义文件的选择需要掌握正则表达式方面的一些知识。保存修改内容。
    </para>
   </step>
   <step>
    <para>
     要检查配置文件是否有效，请运行：
    </para>
<screen><prompt role="root"># </prompt>aide --config-check</screen>
    <para>
     此命令的任何输出都是一条指出配置无效的提示。例如，如果您收到以下输出：
    </para>
<screen><prompt role="root"># </prompt>aide --config-check
35:syntax error:!
35:Error while reading configuration:!
Configuration error</screen>
    <para>
     该错误预期会在 <filename>/etc/aide.conf</filename> 的第 36 行中出现。错误消息包含上次成功读取的配置文件行。
    </para>
   </step>
   <step>
    <para>
     初始化 AIDE 数据库。运行以下命令：
    </para>
<screen><prompt role="root"># </prompt>aide -i</screen>
   </step>
   <step>
    <para>
     将生成的数据库复制到某个保存位置（例如 CD-R、DVD-R、远程服务器或闪存盘），供以后使用。
    </para>
    <important>
     <title/>
     <para>
      此步骤至关重要，因为它可以避免数据库的安全受到损害。建议使用只能写入一次的媒体，以防止数据库遭到修改。<emphasis>切勿</emphasis>将数据库保留在您要监视的计算机上。
     </para>
    </important>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-aide-check">
  <title>本地 AIDE 检查</title>

  <para>
   要进行文件系统检查，请执行以下操作：
  </para>

  <procedure>
   <step>
    <para>
     重命名数据库：
    </para>
<screen><prompt role="root"># </prompt>mv /var/lib/aide/aide.db.new /var/lib/aide/aide.db</screen>
   </step>
   <step>
    <para>
     发生任何配置更改后，始终需要重新初始化 AIDE 数据库，随后移动新生成的数据库。备份此数据库也是个不错的选择。有关更多信息，请参见<xref linkend="sec-aide-setup"/>。
    </para>
   </step>
   <step>
    <para>
     使用以下命令执行检查：
    </para>
<screen><prompt role="root"># </prompt>aide --check</screen>
   </step>
  </procedure>

  <para>
   如果输出为空，则表示一切正常。如果 AIDE 发现了更改，会显示更改摘要，例如：
  </para>

<screen><prompt role="root"># </prompt>aide --check
AIDE found differences between database and filesystem!!

Summary:
  Total number of files:        1992
  Added files:                  0
  Removed files:                0
  Changed files:                1 </screen>

  <para>
   要了解实际的更改，请使用参数 <literal>-V</literal> 提高检查的详细级别。对于前面的示例，此参数的用法如下所示：
  </para>

<screen><prompt role="root"># </prompt>aide --check -V
AIDE found differences between database and filesystem!!
Start timestamp: 2009-02-18 15:14:10

Summary:
  Total number of files:        1992
  Added files:                  0
  Removed files:                0
  Changed files:                1


---------------------------------------------------
Changed files:
---------------------------------------------------

changed: /etc/passwd

--------------------------------------------------
Detailed information about changes:
---------------------------------------------------


File: /etc/passwd
  Mtime    : 2009-02-18 15:11:02              , 2009-02-18 15:11:47
  Ctime    : 2009-02-18 15:11:02              , 2009-02-18 15:11:47</screen>

  <para>
   为了演示该结果，本示例中改动了文件 <filename>/etc/passwd</filename>。
  </para>
 </sect1>
 <sect1 xml:id="sec-aide-independent">
  <title>独立于系统的检查</title>

  <para>
   为了避免风险，建议同时从可信的来源运行 AIDE 二进制文件。这可以排除攻击者另外修改 AIDE 二进制文件以隐藏其行踪的风险。
  </para>

  <para>
   要完成此任务，必须从独立于所安装系统的救援系统运行 AIDE。使用 <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 可轻松通过任意程序扩展救援系统，如此便可添加所需的功能。
  </para>

  <para>
   在开始使用救援系统之前，需要将两个软件包提供给系统。包含这些软件包时所用的语法与将驱动程序更新磁盘添加到系统的语法相同。有关用于此目的的 linuxrc 可用功能的详细说明，请参见 <link xlink:href="https://en.opensuse.org/SDB:Linuxrc"/>。下面介绍了一种完成此任务的可行方式。
  </para>

  <procedure>
   <title>使用 AIDE 启动救援系统</title>
   <step>
    <para>
     提供一台 FTP 服务器作为另一台计算机。
    </para>
   </step>
   <step>
    <para>
     将 <systemitem>aide</systemitem> 和 <systemitem>mhash</systemitem> 软件包复制到 FTP 服务器目录，在本例中为 <filename>/srv/ftp/</filename>。请将 <replaceable>ARCH</replaceable> 和 <replaceable>VERSION</replaceable> 占位符替换为相应的值：
    </para>
<screen><prompt role="root"># </prompt>cp DVD1/suse/<replaceable>ARCH</replaceable>/aide<replaceable>VERSION</replaceable>.<replaceable>ARCH</replaceable>.rpm /srv/ftp
<prompt role="root"># </prompt>cp DVD1/suse/<replaceable>ARCH</replaceable>/mhash<replaceable>VERSION</replaceable>.<replaceable>ARCH</replaceable>.rpm /srv/ftp</screen>
   </step>
   <step>
    <para>
     创建信息文件 <filename>/srv/ftp/info.txt</filename>，用于提供救援系统所需的引导参数：
    </para>
<screen>dud:ftp://ftp.example.com/aide<replaceable>VERSION</replaceable>.<replaceable>ARCH</replaceable>.rpm
dud:ftp://ftp.example.com/mhash<replaceable>VERSION</replaceable>.<replaceable>ARCH</replaceable>.rpm</screen>
    <para>
     请将您的 FTP 域名、<replaceable>VERSION</replaceable> 和 <replaceable>ARCH</replaceable> 替换为系统上使用的值。
    </para>
   </step>
   <step>
    <para>
     重启动需要使用 DVD 中的救援系统完成整个 AIDE 检查的服务器。向引导参数添加以下字符串：
    </para>
<screen>info=ftp://ftp.example.com/info.txt</screen>
    <para>
     此参数告知 <command>linuxrc</command> 还要读入 <filename>info.txt</filename> 文件中的所有信息。
    </para>
   </step>
  </procedure>

  <para>
   救援系统引导后，AIDE 程序即可供使用。
  </para>
 </sect1>
 <sect1 xml:id="sec-aide-more">
  <title>更多信息</title>

  <para>
   以下位置提供了有关 AIDE 的信息：
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     AIDE 主页：<link xlink:href="http://aide.sourceforge.net"/>
    </para>
   </listitem>
   <listitem>
    <para>
     在所述的模板配置 <filename>/etc/aide.conf</filename> 中。
    </para>
   </listitem>
   <listitem>
    <para>
     安装 <systemitem>aide</systemitem> 软件包后在 <filename>/usr/share/doc/packages/aide</filename> 下的多个文件中。
    </para>
   </listitem>
   <listitem>
    <para>
     <link xlink:href="https://www.ipi.fi/mailman/listinfo/aide"/> 上的 AIDE 用户邮件列表中。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
