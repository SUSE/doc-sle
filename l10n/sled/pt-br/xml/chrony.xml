<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="chrony.xml" version="5.0" xml:id="cha-ntp">


 <title>Sincronização de horário com NTP</title>
 <info>
      <abstract>
        <para>
    O mecanismo NTP (network time protocol) é um protocolo para sincronizar o horário do sistema na rede. Primeiro, uma máquina pode obter o horário de um servidor, que é uma fonte de horário confiável. Segundo, a máquina pode agir como uma fonte de horário para outros computadores na rede. O objetivo é duplo: manter o tempo absoluto e a sincronização do horário do sistema de todas as máquinas na rede.
   </para>
      </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:bugtracker/>
        <dm:translation>yes</dm:translation>
      </dm:docmanager>
    </info>
    <para>
  Manter um horário exato do sistema é importante em várias situações. Geralmente, o relógio do hardware incorporado não atende aos requisitos dos aplicativos, como bancos de dados ou clusters. A correção manual do horário do sistema levaria a problemas severos pois, por exemplo, um pulo inverso pode causar o mau funcionamento de aplicativos críticos. Em uma rede, geralmente é necessário sincronizar o horário do sistema de todas as máquinas, porém, o ajuste manual do horário não é um bom método. O NTP dispõe de um mecanismo para resolver esses problemas. O serviço NTP ajusta continuamente o horário do sistema com servidores de horário confiáveis na rede. Ele habilita também o gerenciamento de relógios de referência local como relógios controlados pelo rádio.
 </para>
 <para>
  A partir do <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 15, o <systemitem class="resource">chrony</systemitem> é a implementação padrão do NTP. O <systemitem class="resource">chrony</systemitem> inclui duas partes: <systemitem class="daemon">chronyd</systemitem> é um daemon que pode ser iniciado no momento da inicialização, e <command>chronyc</command> é um programa de interface de linha de comando que monitora o desempenho do <systemitem class="daemon">chronyd</systemitem> e muda vários parâmetros operacionais em tempo de execução.
 </para>
 <para>
  A partir do <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 15.2, o módulo do YaST para configuração do cliente NTP define o systemd-timer, em vez do daemon cron, para executar o <systemitem class="resource">chrony</systemitem>, quando ele não está configurado para ser executado como um daemon.
 </para>
 <note os="sled;osuse">
  <para>
   Para habilitar a sincronização de horário por meio do diretório ativo, siga as instruções no <xref linkend="proc-ad-join"/>.
  </para>
 </note>
 <sect1 xml:id="sec-ntp-yast">
  <title>Configurando um cliente NTP com YaST</title>

  <para>
   O daemon do NTP (<systemitem class="daemon">chronyd</systemitem>) que acompanha o pacote <systemitem>chrony</systemitem> vem predefinido para usar o relógio do hardware do computador local como referência de horário. A precisão de um relógio de hardware depende muito da sua fonte de horário. Por exemplo, um relógio atômico ou um receptor GPS é uma fonte de horário muito precisa, enquanto um chip RTC comum não é uma fonte de horário confiável. O YaST simplifica a configuração de um cliente NTP.
  </para>

  <para>
   Na janela de configuração do cliente NTP do YaST (<menuchoice><guimenu>Serviços de Rede</guimenu> <guimenu> Configuração do NTP</guimenu></menuchoice>), você pode especificar quando iniciar o daemon do NTP, o tipo de fonte de configuração e adicionar servidores de horário personalizados.
  </para>

  <figure>
   <title>Janela de configuração do NTP</title>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="ntp_client.png" width="70%" format="PNG"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="ntp_client.png" width="70%" format="PNG"/>
    </imageobject>
   </mediaobject>
  </figure>

  <sect2>
   <title>Início do daemon do NTP</title>
   <para>
    Há três opções que você pode escolher para iniciar o daemon do NTP:
   </para>
   <variablelist>
    <varlistentry>
     <term><guimenu>Apenas manualmente</guimenu>
     </term>
     <listitem>
      <para>
       Selecione <guimenu>Apenas manualmente</guimenu> para iniciar manualmente o daemon <systemitem class="resource">chrony</systemitem>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><guimenu>Sincronizar sem Daemon</guimenu>
     </term>
     <listitem>
      <para>
       Selecione <guimenu>Sincronizar sem Daemon</guimenu> para definir o horário do sistema periodicamente sem a execução permanente do <systemitem class="resource">chrony</systemitem>. Você pode definir o <guimenu>Intervalo da Sincronização em Minutos</guimenu>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><guimenu>Agora e ao Inicializar</guimenu>
     </term>
     <listitem>
      <para>
       Selecione <guimenu>Agora e ao inicializar</guimenu> para iniciar o <systemitem class="daemon">chronyd</systemitem> automaticamente quando o sistema for inicializado. Essa configuração é recomendada.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2>
   <title>Tipo de fonte de configuração</title>
   <para>
    Na caixa suspensa <guimenu>Fonte de Configuração</guimenu>, selecione <guimenu>Dinâmico</guimenu> ou <guimenu>Estático</guimenu>. Defina como <guimenu>Estático</guimenu> se o seu servidor usa apenas um conjunto fixo de servidores NTP (públicos). A opção <guimenu>Dinâmico</guimenu> é melhor quando sua rede interna oferece servidores NTP via DHCP.
   </para>
  </sect2>

  <sect2 xml:id="sec-net-ntp-yast-new-sync">
   <title>Configurar servidores de horário</title>
   <para>
    Os servidores de horário para consulta do cliente estão listados na parte inferior da janela <guimenu>Configuração do NTP</guimenu>. Modifique esta lista conforme necessário com <guimenu>Adicionar</guimenu>, <guimenu>Editar</guimenu> e <guimenu>Apagar</guimenu>.
   </para>
   <para>
    Clique em <guimenu>Adicionar</guimenu> para adicionar um novo servidor de horário:
   </para>
   <figure>
    <title>Adicionando um servidor de horário</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="ntp_client_serveradd.png" width="70%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="ntp_client_serveradd.png" width="70%" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <procedure>
    <step>
     <para>
      No campo <guimenu>Endereço</guimenu>, digite o URL do servidor de horário ou do pool de servidores de horário com os quais você deseja sincronizar o horário da máquina. Depois que o URL estiver completo, clique em <guimenu>Testar</guimenu> para verificar se ele aponta para uma fonte de horário válida.
     </para>
    </step>
    <step>
     <para>
      Ative <guimenu>Sincronização Inicial Rápida</guimenu> para acelerar a sincronização de horário por meio do envio de mais solicitações quando o daemon <systemitem class="daemon">chronyd</systemitem> é iniciado.
     </para>
    </step>
    <step>
     <para>
      Ative <guimenu>Iniciar Offline</guimenu> para acelerar o tempo de inicialização nos sistemas que iniciam o daemon <systemitem class="daemon">chronyd</systemitem> automaticamente e podem não ter uma conexão de Internet no momento da inicialização. Essa opção é útil, por exemplo, para laptops com conexões de rede gerenciadas pelo NetworkManager.
     </para>
    </step>
    <step>
     <para>
      Confirme com <guimenu>OK</guimenu>.
     </para>
    </step>
   </procedure>
  </sect2>


 </sect1>



 <sect1 xml:id="sec-netz-xntp-netconf">
  <title>Configurando manualmente o NTP na rede</title>

  <para>
   O <systemitem class="resource">chrony</systemitem> lê sua configuração do arquivo <filename>/etc/chrony.conf</filename>. Para manter o relógio do computador sincronizado, você precisa informar ao <systemitem class="resource">chrony</systemitem> quais servidores de horário devem ser usados. Você pode usar nomes de servidores ou endereços IP específicos. Por exemplo:
  </para>

<screen>server 0.europe.pool.ntp.org
server 1.europe.pool.ntp.org
server 2.europe.pool.ntp.org</screen>

  <para>
   Você também pode especificar o nome de um <emphasis>pool</emphasis>. O nome do pool é resolvido para vários endereços IP:
  </para>

<screen>pool pool.ntp.org</screen>

  <tip>
   <title>Computadores na mesma rede</title>
   <para>
    Para sincronizar o horário em vários computadores na mesma rede, não é recomendável sincronizar todos eles com um servidor externo. Convém especificar um computador como servidor de horário, que é sincronizado com um servidor de horário externo, e o outro computador atua como cliente dele. Adicione uma diretiva <literal>local</literal> ao <filename>/etc/chrony.conf</filename> do servidor para diferenciá-lo de um servidor de horário autorizado:
   </para>
<screen>local stratum 10</screen>
  </tip>

  <para>
   Para iniciar o <systemitem class="resource">chrony</systemitem>, execute:
  </para>

<screen>systemctl start chronyd.service</screen>

  <para>
   Após a inicialização do <systemitem class="daemon">chronyd</systemitem>, levará algum tempo para estabilizar o horário, e o arquivo drift que corrige o relógio do computador local será criado. Com o arquivo DRIFT, o erro sistemático do relógio do hardware pode ser registrado quando o computador é ligado. A correção é usada imediatamente, resultando em uma estabilidade maior do horário do sistema.
  </para>

  <para>
   Para habilitar o serviço que permite iniciar o <systemitem class="resource">chrony</systemitem> automaticamente no momento da inicialização, execute:
  </para>

<screen>systemctl enable chronyd.service</screen>
 </sect1>
 <sect1 xml:id="ntp-chronyc">
  <title>Configurar o <systemitem class="daemon">chronyd</systemitem> em tempo de execução usando o <command>chronyc</command></title>

  <para>
   Você pode usar o <command>chronyc</command> para mudar o comportamento do <systemitem class="daemon">chronyd</systemitem> em tempo de execução. Ele também gera relatórios de status sobre a operação do <systemitem class="daemon">chronyd</systemitem>.
  </para>

  <para>
   Você pode executar o <command>chronyc</command> no modo interativo ou não interativo. Para executar o <command>chronyc</command> interativamente, digite <command>chronyc</command> na linha de comando. Esse procedimento exibe um prompt e aguarda a entrada do seu comando. Por exemplo, para verificar quantas fontes NTP estão online ou offline, execute:
  </para>

<screen><prompt role="root">root # </prompt><command>chronyc</command>
chronyc&gt; activity
200 OK
4 sources online
2 sources offline
1 sources doing burst (return to online)
1 sources doing burst (return to offline)
0 sources with unknown address</screen>

  <para>
   Para sair do prompt do <command>chronyc</command>, digite <command>quit</command> ou <command>exit</command>.
  </para>

  <para>
   Se você não precisa usar o prompt interativo, digite o comando diretamente:
  </para>

<screen><prompt role="root">root # </prompt><command>chronyc</command> activity</screen>

  <note>
   <title>Mudanças temporárias</title>
   <para>
    As mudanças feitas com o <command>chronyc</command> não são permanentes. Elas serão perdidas após a próxima reinicialização do <systemitem class="daemon">chronyd</systemitem>. Para mudanças permanentes, modifique o <filename>/etc/chrony.conf</filename>.
   </para>
  </note>

  <para>
   Para obter uma lista completa dos comandos do <command>chronyc</command>, consulte a página de manual dele (<command>man 1 chronyc</command>).
  </para>
 </sect1>
 <sect1 xml:id="sec-netz-xntp-dynamic">
  <title>Sincronização de horário dinâmica em tempo de execução</title>



  <para>
  Embora o <systemitem class="daemon">chronyd</systemitem> seja inicializado normalmente em um sistema que inicializa sem uma conexão de rede, a ferramenta não pode resolver os nomes DNS dos servidores de horário especificados no arquivo de configuração.
  </para>

  <para>
   O <systemitem class="daemon">chronyd</systemitem> continua tentando resolver os nomes de servidor de horário especificados pelas diretivas do <option>servidor</option>, do <option>pool</option> e do <option>peer</option> em um intervalo de tempo crescente até obter êxito.
  </para>

  <para>
   Se o servidor de horário não puder ser acessado quando o <systemitem class="daemon">chronyd</systemitem> for iniciado, você poderá especificar a opção <option>offline</option>:
  </para>

<screen>server <replaceable>server_address</replaceable> offline</screen>

  <para>
   O <systemitem class="daemon">chronyd</systemitem> não tentará fazer poll no servidor até ser habilitado usando o seguinte comando:
  </para>

<screen><prompt role="root">root # </prompt>chronyc online <replaceable>server_address</replaceable></screen>

  <para>
   Quando a opção <option>auto_offline</option> está definida, o <systemitem class="daemon">chronyd</systemitem> pressupõe que o servidor de horário estava offline quando duas solicitações foram enviadas a ele sem receber uma resposta. Essa opção evita a necessidade de executar o comando “offline” do <command>chronyc</command> ao desconectar o link de rede.
  </para>
 </sect1>



 <sect1 xml:id="sec-netz-xntp-normal">
  <title>Configurando um relógio de referência local</title>

  <para>
   O pacote de software <systemitem class="resource">chrony</systemitem> depende de outros programas (como <systemitem>gpsd</systemitem>) para acessar os dados de horário por meio do driver SHM ou SOCK. Use a diretiva <option>refclock</option> em <filename>/etc/chrony.conf</filename> para especificar um relógio de referência de hardware a ser usado como fonte de horário. Ela tem dois parâmetros obrigatórios: um nome de driver e um parâmetro específico do driver. Os dois parâmetros são seguidos de zero ou de mais opções do <option>refclock</option>. O <systemitem class="daemon">chronyd</systemitem> inclui os seguintes drivers:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     PPS: driver para a API “Pulse-Per-Second” do kernel. Por exemplo:
    </para>
<screen>refclock PPS /dev/pps0 lock NMEA refid GPS</screen>
   </listitem>
   <listitem>
    <para>
     SHM: driver de memória compartilhada do NTP. Por exemplo:
    </para>
<screen>refclock SHM 0 poll 3 refid GPS1
refclock SHM 1:perm=0644 refid GPS2</screen>
   </listitem>
   <listitem>
    <para>
     SOCK: driver de soquete de domínio do Unix. Por exemplo:
    </para>
<screen>refclock SOCK /var/run/chrony.ttyS0.sock</screen>
   </listitem>
   <listitem>
    <para>
     PHC: driver de relógio do hardware PTP. Por exemplo:
    </para>
<screen>refclock PHC /dev/ptp0 poll 0 dpoll -2 offset -37
refclock PHC /dev/ptp1:nocrossts poll 3 pps</screen>
   </listitem>
  </itemizedlist>

  <para>
   Para obter mais informações sobre as opções de drivers individuais, consulte <command>man 8 chrony.conf</command>.
  </para>
 </sect1>
 <sect1 xml:id="sec-netz-xntp-etr" arch="zseries">
  <title>Sincronização do relógio com uma Referência de Horário Externa (ETR, External Time Reference)</title>



  <para>
   O suporte para sincronização do relógio com uma referência de horário externa (ETR) está disponível. A referência de horário externa envia um sinal do oscilador e um sinal de sincronização a cada 2**20 (2 elevado à potência de 20) microssegundos para manter sincronizados os relógios TOD de todos os servidores conectados.
  </para>

  <para>
   Para disponibilidade, é possível conectar duas unidades ETR a uma máquina. Se a diferença do relógio for maior do que a tolerância da verificação de sincronização, todas as CPUs terão suas máquinas marcadas indicando que o relógio não está sincronizado. Se isso acontecer, todos os dispositivos DASD de E/S habilitados para XRC serão parados até o relógio ser novamente sincronizado.
  </para>

  <para>
   O suporte a ETR é ativado por meio de dois atributos <literal>sysfs</literal>. Execute os seguintes comandos como <systemitem class="username">root</systemitem>:
  </para>

<screen>echo 1 &gt; /sys/devices/system/etr/etr0/online
echo 1 &gt; /sys/devices/system/etr/etr1/online
</screen>
 </sect1>
</chapter>
