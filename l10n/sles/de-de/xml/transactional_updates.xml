<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="transactional_updates.xml" version="5.0" xml:id="cha-transactional-updates" xml:lang="de">
 <title>Transaktionsaktualisierungen</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    Transaktionsaktualisierungen sind in <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> als Technologievorschau für die Aktualisierung von SLES verfügbar, wenn das root-Dateisystem schreibgeschützt ist. Transaktionsaktualisierungen sind atomar (alle Aktualisierungen werden nur angewendet, wenn alle Aktualisierungen erfolgreich sind) und unterstützen Rollbacks. Es ist kein laufendes System betroffen, da Änderungen erst aktiviert werden, nachdem das System neu gebootet wurde. Da Reboots eine Störung darstellen, muss der Administrator entscheiden, ob ein Reboot kostspieliger ist als die Störung laufender Services. Wenn Reboots zu kostspielig sind, sollten Sie keine Transaktionsaktualisierungen verwenden.
   </para>

   <para>
    Transaktionsaktualisierungen werden täglich vom Skript <command>transactional-update</command> ausgeführt. Das Skript prüft auf verfügbare Aktualisierungen. Falls Aktualisierungen vorhanden sind, erstellt es im Hintergrund einen neuen Snapshot des root-Dateisystems. Danach ruft es die Aktualisierungen von den Versionskanälen ab. Sobald der neue Snapshot vollständig aktualisiert ist, wird er als aktiv gekennzeichnet und wird nach dem nächsten Reboot des Systems zum neuen standardmäßigen root-Dateisystem. Wenn <command>transactional-update</command> automatisch ausgeführt wird (das Standardverhalten), wird das System auch neu gebootet. Sowohl die Zeitdauer für den Aktualisierungsvorgang als auch das Wartungsfenster für den Reboot sind konfigurierbar.
   </para>

   <para>
    Es können nur Pakete aktualisiert werden, die Teil des Snapshots des root-Dateisystems sind. Sollten die Pakete Dateien enthalten, die nicht Teil des Snapshots sind, dann könnte die Aktualisierung fehlschlagen oder das System beschädigen.
   </para>

   <para>
    RPMs, die eine Lizenz benötigen, um akzeptiert zu werden, können nicht aktualisiert werden.
   </para>
  </abstract>
 </info>
 
 <sect1 xml:id="sec-tu-limitations">
  <title>Einschränkungen bei Technologievorschauen</title>

  <para>
   Technologievorschauen weisen bestimmte Einschränkungen in der Funktionalität auf.  Die folgenden Pakete funktionieren nicht bei <command>transactional-update</command>:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     <package>nginx</package>-Standardseite index.html ist möglicherweise nicht verfügbar
    </para>
   </listitem>
   <listitem>
    <para>
     <package>tomcat-webapps</package> und <package>tomcat-admin-webapps</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>phpMyAdmin</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>sca-appliance-*</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>mpi-selector</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>emacs</package> funktioniert mit Ausnahme von Emacs-Spielen
    </para>
   </listitem>
   <listitem>
    <para>
     <package>bind</package> und <package>bind-chrootenv</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>docbook*</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>sblim-sfcb*</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>texlive*</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>iso_ent</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>openjade</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>opensp</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>pcp</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>plymouth</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>postgresql-server-10</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>pulseaudio-gdm-hooks</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>smartmontools</package>
    </para>
   </listitem>
  </itemizedlist>

  <para>
   Die Aktualisierungskomponente des Systeminstallationsprogramms funktioniert nicht bei einem schreibgeschützten Dateisystem, weil es Transaktionsaktualisierungen nicht unterstützt.
  </para>

  <para>
   Weitere Überlegungen:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Im Allgemeinen ist es sinnvoll, den Zeitraum zwischen der Aktualisierung des Systems und dem Reboot des Rechners so kurz wie möglich zu halten.
    </para>
   </listitem>
   <listitem>
    <para>
     Es kann immer nur eine Aktualisierung angewendet werden. Nach jeder Aktualisierung und nach dem Anwenden der nächsten Aktualisierung muss ein Reboot erfolgen.
    </para>
   </listitem>
   <listitem>
    <para>
     <command>update-alternatives</command> sollte nach einer Transaktionsaktualisierung erst nach dem Reboot des Rechners ausgeführt werden.
    </para>
   </listitem>
   <listitem>
    <para>
     Erstellen Sie nach einer Transaktionsaktualisierung neue Systembenutzer oder Systemgruppen erst nach einem Reboot. Normale Benutzer und Gruppen (UID &gt; 1000, GID &gt; 1000) können jedoch erstellt werden.
    </para>
   </listitem>
   <listitem>
    <para>
     YaST ist noch nicht mit Transaktionsaktualisierungen vertraut. Es funktioniert nicht, wenn ein YaST-Modul zusätzliche Pakete installieren muss. Normale Systemvorgänge, bei denen nur Konfigurationsdateien in <filename>/etc</filename> bearbeitet werden, funktionieren.
    </para>
   </listitem>
   <listitem>
    <para>
     Für <package>php7-fastcgi</package> müssen Sie manuell einen symbolischen Link erstellen (<filename>/srv/www/cgi-bin/php</filename>), der auf <filename>/usr/bin/php-cgi</filename> zeigt.
    </para>
   </listitem>
   <listitem>
    <para>
     <package>ntp</package> ist Teil des Legacy-Moduls für die Migration von älteren SLES-Versionen. Es wird nicht auf einer neueren Installation von <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> unterstützt und wurde ersetzt durch <package>chrony</package>. Wenn Sie <package>ntp</package> weiterhin verwenden, ist eine Neuinstallation erforderlich, damit die transaktionalen Updates korrekt funktionieren.
    </para>
   </listitem>
   <listitem>
    <para>
     <package>sblim-sfcb</package>: Das gesamte sblim-Ökosystem ist mit Transaktionsaktualisierungen kompatibel.
    </para>
   </listitem>
   <listitem>
    <para>
     <command>btrfs-defrag</command> aus dem Paket <package>btrfsmaintenance</package> funktioniert nicht mit einem schreibgeschützten Root-Dateisystem.
    </para>
   </listitem>
   <listitem>
    <para>
     Für <command>btrfs-balance</command> muss die Variable <literal>BTRFS_BALANCE_MOUNTPOINTS</literal> in <filename>/etc/sysconfig/btrfsmaintenance</filename> von <literal>/</literal> in <literal>/.snapshots</literal> geändert werden.
    </para>
   </listitem>
   <listitem>
    <para>
     Für <command>btrfs-scrub</command> muss die Variable <literal>BTRFS_SCRUB_MOUNTPOINTS</literal> in <filename>/etc/sysconfig/btrfsmaintenance</filename> von <literal>/</literal> in <literal>/.snapshots</literal> geändert werden.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec-install-tu">
  <title>Aktivieren von <package>transactional-update</package></title>
  <para>
   Sie müssen das Transaktionsserver-Modul bei der Systeminstallation aktivieren und dann die Transaktionsserver-Rolle auswählen. Die spätere Installation von Paketen vom Transaktionsserver-Modul in einem laufenden System wird NICHT unterstützt und könnte das System beschädigen.
  </para>
  <para>
      Beachten Sie, dass Änderungen am Subvolume-Layout der root-Partition oder Platzierung von Unterverzeichnissen oder Subvolumes der root-Partition in eigene Partitionen (ausgenommen <filename>/home</filename>, <filename>/var</filename>, <filename>/srv</filename> und <filename>/opt</filename>) nicht unterstützt werden und höchstwahrscheinlich das System beschädigen.
  </para>
 </sect1>
 
  <sect1 xml:id="sec-tu-disable">
  <title>Verwalten von automatischen Aktualisierungen</title>
  <para>
      Automatische Aktualisierungen werden von einem <command>systemd.timer</command> gesteuert, der einmal pro Tag ausgeführt wird. Damit werden alle Aktualisierungen angewendet und <command>rebootmgrd</command> wird informiert, dass der Rechner neu gebootet werden muss. Die Uhrzeit für die Ausführung der Aktualisierung kann angepasst werden. Weitere Informationen hierzu finden Sie unter systemd.timer(5). Informationen zum Anpassen des Wartungsfensters, in dem festgelegt wird, wann <command>rebootmgrd</command> das System neu bootet, finden Sie unter rebootmgrd(8).
  </para>
  <para>
   Automatische Transaktionsaktualisierungen werden deaktiviert mit dem Kommando:
  </para>

<screen><prompt role="root"># </prompt><command>systemctl --now disable transactional-update.timer</command></screen>
</sect1>
 
 <sect1>
  <title>Das Kommando <command>transactional-update</command></title>
  <para>
   Mit dem Kommando <command>transactional-update</command> ist eine atomare Installation oder das Entfernen von Aktualisierungen möglich. Aktualisierungen werden dann nur angewendet, wenn alle erfolgreich installiert werden können. Mit <command>transactional-update</command> wird ein Snapshot von Ihrem System vor Anwenden der Aktualisierung erstellt. Dieser Snapshot kann wiederhergestellt werden. Alle Änderungen werden erst nach dem Reboot aktiv.
  </para>

<variablelist>
  <varlistentry>
   <term><literal>--continue</literal></term>
   <listitem>
     <para>
         Mit der Option <command>--continue</command> werden mehrere Änderungen an einem bestehenden Snapshot vorgenommen, ohne dass neu gebootet werden muss.
     </para>
     <para>
         Das standardmäßige Verhalten von <command>transactional-update</command> besteht darin, einen neuen Snapshot vom aktuellen root-Dateisystem zu erstellen. Wenn Sie etwas vergessen, etwa die Installation eines neuen Pakets, müssen Sie einen Reboot ausführen, um die früheren Änderungen anzuwenden. Danach muss das Kommando<command>transactional-update</command> erneut ausgeführt werden, um das vergessene Paket zu installieren, und es muss erneut ein Reboot erfolgen. Sie können das Kommando <command>transactional-update</command> nicht mehrmals ohne Reboot zum Hinzufügen weiterer Änderungen zum Snapshot ausführen. Dadurch würden separate unabhängige Snapshots erstellt werden, die nicht die Änderungen der früheren Snapshots enthalten.
     </para>
     <para>
         Mit der Option <command>--continue</command> können Sie jedoch so viele Änderungen vornehmen, wie Sie möchten, ohne neu booten zu müssen. Es wird jedes Mal ein neuer Snapshot erstellt, der jeweils alle Änderungen der früheren Snapshots sowie die neuen Änderungen enthält. Wiederholen Sie diesen Vorgang beliebig oft und booten Sie das System neu, sobald der letzte Snapshot alle gewünschten Änderungen enthält. Der letzte Snapshot wird dann das neue root-Dateisystem.
     </para>
     <para>
         Als weitere nützliche Funktion der Option <command>--continue</command> können Sie jeden beliebigen vorhandenen Snapshot als Basis für Ihren neuen Snapshot auswählen. Im folgenden Beispiel wird gezeigt, wie <command>transactional-update</command> ausgeführt wird, um ein neues Paket in einem Snapshot basierend auf Snapshot 13 zu installieren. Danach wird es erneut ausgeführt, um ein weiteres Paket zu installieren:
     </para>
     <screen><prompt role="root"># </prompt><command>transactional-update pkg install <replaceable>package_1</replaceable></command></screen>
    <screen><prompt role="root"># </prompt><command>transactional-update --continue 13 pkg install <replaceable>package_2</replaceable></command></screen>
    <para>
        Die Option <command>--continue [num]</command> ruft <command>snapper create --from</command> auf. Weitere Informationen hierzu finden Sie in <xref linkend="sec-snapper-manage-create"/>.
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><literal>cleanup</literal></term>
   <listitem>
  <para>
    Wenn das aktuelle root-Dateisystem mit dem aktiven root-Dateisystem identisch ist (nach einem Reboot, bevor <command>transactional-update</command> einen neuen Snapshot mit Aktualisierungen erstellt), wird für alle alten Snapshots ohne Bereinigungsalgorithmus ein Bereinigungsalgorithmus festgelegt. Dadurch wird sichergestellt, dass alte Snapshots von Snapper gelöscht werden. (Weitere Informationen finden Sie im Abschnitt zu Bereinigungsalgorithmen in Snapper (8).) Damit werden auch alle <filename>/etc</filename>-Overlay-Verzeichnisse ohne Verweis (und somit nicht verwendet) in <filename>/var/lib/overlay</filename> entfernt:
  </para>
<screen><prompt role="root"># </prompt><command>transactional-update cleanup</command></screen>
    </listitem>
   </varlistentry>  
   <varlistentry>
    <term><literal>pkg in/install</literal></term>
    <listitem>
     <para>
      Installiert einzelne Paket aus den verfügbaren Kanälen mit dem Kommando <command>zypper install</command>. Mit diesem Kommando werden auch PTF(Program Temporary Fix)-RPM-Dateien installiert.
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update pkg install <replaceable>package_name</replaceable></command></screen>
     <para>
      oder
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update pkg install <replaceable>rpm1 rpm2</replaceable></command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>pkg rm/remove</literal></term>
    <listitem>
     <para>
      Entfernt einzelne Pakete vom aktiven Snapshot mit dem Kommando <command>zypper remove</command>. Mit diesem Kommando werden auch PTF-RPM-Dateien entfernt.
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update pkg remove <replaceable>package_name</replaceable></command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>pkg up/update</literal></term>
    <listitem>
     <para>
      Aktualisiert einzelne Pakete vom aktiven Snapshot mit dem Kommando <command>zypper update</command>. Es können nur Pakete aktualisiert werden, die Teil des Snapshots des Basisdateisystems sind.
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update pkg remove <replaceable>package_name</replaceable></command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>up/update</literal></term>
    <listitem>
     <para>
      Wenn neue Aktualisierungen verfügbar sind, wird ein neuer Snapshot erstellt und mit <command>zypper up/update</command> der Snapshot aktualisiert.
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update up</command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>dup</literal></term>
    <listitem>
     <para>
      Wenn neue Aktualisierungen verfügbar sind, wird ein neuer Snapshot erstellt und mit <command>zypper dup –no-allow-vendor-change</command> der Snapshot aktualisiert. Der Snapshot wird anschließend aktiviert und wird nach einem Reboot zum neuen root-Dateisystem.
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update dup</command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>patch</literal></term>
    <listitem>
     <para>
      Wenn neue Aktualisierungen verfügbar sind, wird ein neuer Snapshot erstellt und mit <command>zypper patch</command> der Snapshot aktualisiert.
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update patch</command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>rollback</literal></term>
    <listitem>
     <para>
      Damit wird das Standard-Subvolume festgelegt. In Systemen mit einem Schreiben-Lesen-Dateisystem wird <command>snapper rollback</command> aufgerufen. In einem Nur-Lesen-Dateisystem ohne Argument wird das aktuelle System als neues standardmäßiges root-Dateisystem festgelegt. Wenn Sie eine Zahl angeben, wird dieser Snapshot als das standardmäßige root-Dateisystem verwendet. In einem Nur-Lesen-Dateisystem werden keine zusätzlichen Snapshots erstellt. 
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update rollback <replaceable>snapshot_number</replaceable></command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal> grub.cfg</literal></term>
    <listitem>
     <para>
      Damit wird eine neue GRUB2-Konfiguration erstellt. Manchmal muss die Boot-Konfiguration angepasst werden, beispielsweise durch Hinzufügen zusätzlicher Kernel-Parameter. Bearbeiten Sie <replaceable>/etc/default/grub</replaceable>, führen Sie <command>transactional-update grub.cfg</command> aus und booten Sie dann neu, um die Änderung zu aktivieren. Sie müssen sofort einen Reboot ausführen, da ansonsten die neue GRUB2-Konfiguration bei der nächsten Transaktionsaktualisierung mit dem Standardwert überschrieben wird.
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update grub.cfg</command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>reboot</literal></term>
    <listitem>
     <para>
      Dieser Parameter löst nach dem Abschluss der Aktion einen Reboot aus.
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update <replaceable>dup</replaceable> reboot</command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>--help</literal></term>
    <listitem>
     <para>
      Damit wird ein Hilfe-Bildschirm mit Optionen und Unterkommandos gedruckt.
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update --help</command></screen>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>

 <sect1 xml:id="sec-tu-troubleshooting">
  <title>Fehlersuche</title>

  <para>
   Führen Sie bei einem fehlerhaften Upgrade <command>supportconfig</command> aus, um Protokolldaten zu erfassen. Übermitteln Sie die resultierenden Dateien einschließlich <filename>/var/log/transactional-update.log</filename> an den SUSE Support.
  </para>
 </sect1>
</chapter>
