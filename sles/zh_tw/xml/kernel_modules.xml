<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="kernel_modules.xml" version="5.0" xml:id="cha.mod">
 <title>管理核心模組</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <para>
   雖然 Linux 屬於單核心，但可透過核心模組加以延伸。這些特殊物件可以插入到核心中，並可視需要移除。就實際角度而言，核心模組使新增和移除核心自身未包含的驅動程式和介面成為現實。Linux 提供了數個用於管理核心模組的指令。
 </para>
 <sect1 xml:id="sec.mod.lsmod">
  <title>使用 lsmod 和 modinfo 列出載入的模組</title>
  <para>
    使用 <command>lsmod</command> 指令可檢視目前載入了哪些核心模組。該指令的輸出可能如下所示︰
  </para>
  <screen><prompt>tux &gt; </prompt> lsmod
Module                  Size  Used by
snd_usb_audio         188416  2 
snd_usbmidi_lib        36864  1 snd_usb_audio
hid_plantronics        16384  0 
snd_rawmidi            36864  1 snd_usbmidi_lib
snd_seq_device         16384  1 snd_rawmidi
fuse                  106496  3 
nfsv3                  45056  1 
nfs_acl                16384  1 nfsv3</screen>
  <para>
    輸出內容分為三欄︰<literal>Module</literal> 欄列出所載入模組的名稱，<literal>Size</literal> 欄顯示各模組的大小。<literal>Used by</literal> 欄顯示參考模組的程序數及其名稱。請注意，此清單可能不完整。
  </para>
  <para>
    若要檢視有關特定核心模組的詳細資訊，請使用 <command>modinfo <replaceable>MODULE_NAME</replaceable></command> 指令。其中 <replaceable>MODULE_NAME</replaceable> 為所需核心模組的名稱。請注意，<command>modinfo</command> 二進位檔案位於使用者的 PATH 環境變數中未包含的 <filename>/sbin</filename> 目錄下。這意味著，當您以普通使用者身分執行 <command>modinfo</command> 指令時，必須指定該二進位檔案的完整路徑︰
  </para>
  <screen>$ /sbin/modinfo kvm
filename:       /lib/modules/4.4.57-18.3-default/kernel/arch/x86/kvm/kvm.ko
license:        GPL
author:         Qumranet
srcversion:     BDFD8098BEEA517CB75959B
depends:        irqbypass
intree:         Y
vermagic:       4.4.57-18.3-default SMP mod_unload modversions 
signer:         openSUSE Secure Boot Signkey
sig_key:        03:32:FA:9C:BF:0D:88:BF:21:92:4B:0D:E8:2A:09:A5:4D:5D:EF:C8
sig_hashalgo:   sha256
parm:           ignore_msrs:bool
parm:           min_timer_period_us:uint
parm:           kvmclock_periodic_sync:bool
parm:           tsc_tolerance_ppm:uint
parm:           lapic_timer_advance_ns:uint
parm:           halt_poll_ns:uint
parm:           halt_poll_ns_grow:int
parm:           halt_poll_ns_shrink:int</screen>
  </sect1>
  <sect1 xml:id="sec.mod.modprobe">
    <title>新增和移除核心模組</title>
    <para>
      雖然可以使用 <systemitem>insmod</systemitem> 和 <systemitem>rmmod</systemitem> 來新增和移除核心模組，但仍建議使用 <systemitem>modprobe</systemitem> 工具來執行這些操作。<systemitem>modprobe</systemitem> 具有多項重要優勢，包括自動解析相依項以及將核心模組加入黑名單。
    </para>
    <para>
      如果不指定任何參數，使用 <systemitem>modprobe</systemitem> 指令會安裝指定的核心模組。必須使用 root 特權來執行 <systemitem>modprobe</systemitem>︰
    </para>
    <screen><prompt>tux &gt; </prompt>sudo modprobe acpi</screen>
    <para>
      若要移除核心模組，請使用 <command>-r</command> 參數︰
    </para>
    <screen>sudo modprobe -r acpi</screen>
    <sect2 xml:id="sec.mod.modprobe.d">
    <title>開機時自動載入核心模組</title>
    <para>
      您可以選擇不手動載入核心模組，而是使用 <systemitem>system-modules-load.service</systemitem> 服務在開機期間自動載入這些模組。若要啟用核心模組，請將 <filename>.conf</filename> 檔案新增到 <filename>/etc/modules-load.d/</filename> 目錄下。建議為組態檔案使用與模組相同的名稱，例如︰</para>
    <screen>/etc/modules-load.d/rt2800usb.conf</screen>
    <para>
      組態檔案中必須包含所需核心模組的名稱 (例如 <literal>rt2800usb</literal>)。
    </para>
    <para>
      透過上述的這個技巧，無需指定任何參數即可載入核心模組。如果您需要使用特定選項載入核心模組，請將組態檔案新增到 <filename>/etc/modprobe.d/</filename> 目錄下。該檔案的副檔名必須為 <filename>.conf</filename>。檔案名稱應符合以下命名慣例︰<literal>priority-modulename.conf</literal>，例如︰<filename>50-thinkfan.conf</filename>。組態檔案中必須包含核心模組名稱及所需參數。您可以使用以下範例指令來建立包含核心模組名稱及其參數的組態檔案︰</para>
      <screen>echo "options thinkpad_acpi fan_control=1" | sudo tee /etc/modprobe.d/thinkfan.conf</screen>
      
      <note>
	<title>載入核心模組</title>
	<para>
	  當偵測到裝置或使用者空間要求特定功能時，系統會自動載入大多數核心模組。因此，很少需要手動將模組新增到 <filename>/etc/modules-load.d/</filename>。
	 </para>
	</note>
	
    </sect2>
    <sect2 xml:id="sec.mod.modprobe.blacklist">
    <title>使用 modprobe 將核心模組加入黑名單</title>
    <para>
      將某個核心模組加入黑名單後，開機期間便不再會載入該模組。當您想要停用您懷疑可能導致系統出現問題的某個模組時，此功能十分實用。請注意，您仍可透過使用 <systemitem>insmod</systemitem> 或 <systemitem>modprobe</systemitem> 工具來手動載入加入黑名單的核心模組。
    </para>
    <para>
      若要將模組加入黑名單，請將 <literal>blacklist <replaceable>MODULE_NAME</replaceable></literal> 一行新增到 <filename>/etc/modprobe.d/50-blacklist.conf</filename> 檔案中。例如︰
    </para>
    <screen>blacklist nouveau</screen>
    <para>
      以 root 身分執行 <command>mkinitrd</command> 指令以產生新的 <systemitem>initrd</systemitem> 影像，然後將機器重新開機。可使用以下指令執行上述步驟︰
    </para>
    <screen>su
echo "blacklist nouveau" &gt;&gt; /etc/modprobe.d/50-blacklist.conf &amp;&amp; mkinitrd &amp;&amp; reboot</screen>
    <para>
      如果您不想永久停用某個核心模組，可以在開機期間即時將其加入黑名單。若要實現此目標，請在開機螢幕顯示時按 <keycap>E</keycap> 鍵。這樣，您會進入一個可供您修改開機參數的小編輯器。找到如下所示的行︰
    </para>
    <screen>linux /boot/vmlinuz...splash= silent quiet showopts</screen>
    <para>
      將 <command>modprobe.blacklist=<replaceable>MODULE_NAME</replaceable></command> 指令新增到該行結尾處。例如︰
    </para>
    <screen>linux /boot/vmlinuz...splash= silent quiet showopts modprobe.blacklist=nouveau</screen>
    <para>
      按 <keycap>F10</keycap> 或 <keycombo><keycap function="control"/><keycap>X</keycap></keycombo> 以依照指定的組態開機。
    </para>
    <para>
      若要透過 GRUB 將某個核心模組永久加入黑名單，請開啟要編輯的 <filename>/etc/default/grub</filename> 檔案，將 <command>modprobe.blacklist=<replaceable>MODULE_NAME</replaceable></command> 選項新增到 <command>GRUB_CMD_LINUX</command> 指令中。然後執行 <command>sudo grub2-mkconfig -o /boot/grub2/grub.cfg</command> 指令以使變更生效。
    </para>
    </sect2>
 </sect1>
</chapter>
