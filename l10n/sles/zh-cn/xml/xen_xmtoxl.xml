<?xml version="1.0" encoding="UTF-8"?>
<appendix xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="xen_xmtoxl.xml" version="5.0" xml:id="cha-xmtoxl">
  
  
  
  
  <title>XM、XL 工具栈和 <systemitem class="library">libvirt</systemitem> 框架</title>
  <info>
    <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
      <dm:bugtracker/>
      <dm:translation>yes</dm:translation>
    </dm:docmanager>
  </info>
  <sect1 xml:id="sec-xmtoxl-intro">
    <title>Xen 工具栈</title>

    <para>
      从早期发行版 Xen 2.x 开始，<command>xend</command> 就一直是事实上用于管理 Xen 安装的工具堆栈。Xen 4.1 中引入了一个处于技术预览状态的新工具堆栈 libxenlight（又称为 libxl）。libxl 是以 C 编写的小型低级别库，旨在为所有客户端工具堆栈（<link xlink:href="http://wiki.xen.org/wiki/XAPI">XAPI</link>、<systemitem class="library">libvirt</systemitem>、xl）提供简单的 API。Xen 4.2 将 libxl 提升为受官方支持状态，而将 <command>xend</command> 标记为弃用。Xen 4.3 和 4.4 系列中包含了 <command>xend</command>，使用户有充足的时间将其工具过渡到 libxl。上游 Xen 项目中已去除 xend，从 Xen 4.5 系列和 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> <phrase os="sles;sled">12 SP1</phrase> 开始，将不再提供该工具堆栈。
    </para>

    <para>
      <phrase os="sles;sled">尽管 SLES 11 SP3 包含了 Xen 4.2，但 SUSE 仍保留了 <command>xend</command> 工具堆栈，因为在服务包中进行这种有创性更改会给 SUSE Linux Enterprise 客户造成过大干扰。不过，SLES 12 将提供适当的机会让客户迁移到新的 libxl 工具堆栈，并去除已弃用且不再保留的 <command>xend</command> 堆栈</phrase>。从 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>
      <phrase os="sles;sled">12 SP1</phrase> 开始，<command>xend</command> 不再受支持。
    </para>

    <para>
      <command>xend</command> 与 libxl 之间的主要差别之一是，前者是有状态的，而后者是无状态的。使用 <command>xend</command> 时，所有客户端应用程序（例如 <command>xm</command> 和 <systemitem class="library">libvirt</systemitem>）都会看到相同的系统状态。<command>xend</command> 负责维护整个 Xen 主机的状态。在 libxl 中，<command>xl</command> 或 <systemitem class="library">libvirt</systemitem> 等客户端应用程序必须维护状态。因此，使用 <command>xl</command> 创建的域对于 <systemitem class="library">libvirt</systemitem> 等其他 libxl 应用程序是不可见或不可知的。一般情况下，我们建议不要混用多个 libxl 应用程序，而是使用单个 libxl 应用程序来管理 Xen 主机。在 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 中，我们建议使用 <systemitem class="library">libvirt</systemitem> 来管理 Xen 主机。这样，便可以通过 <command>virt-manager</command>、<command>virt-install</command>、<command>virt-viewer</command>、libguestfs 等 <systemitem class="library">libvirt</systemitem> 应用程序来管理 Xen 系统。如果使用 <command>xl</command> 管理 Xen 主机，<systemitem class="library">libvirt</systemitem> 将无法访问由 xl 管理的任何虚拟机。因此，任何 <systemitem class="library">libvirt</systemitem> 应用程序也无法访问这些虚拟机。
    </para>

    <sect2 xml:id="sec-xmtoxl-upgrade">
      <title>从 xend/xm to xl/libxl 升级</title>
      <para>
        <command>xl</command> 应用程序及其配置格式（请参见 <command>man xl.cfg</command>）可以向后兼容 <command>xm</command> 应用程序及其配置格式（请参见 <command>man xm.cfg</command>）。可以通过 <command>xl</command> 来利用现有的 <command>xm</command> 配置。由于 libxl 是无状态的，并且 <command>xl</command> 不支持受管域的表示法，因此 SUSE 建议使用 <systemitem class="library">libvirt</systemitem> 来管理 Xen 主机。SUSE 提供了一个名为 <command>xen2libvirt</command> 的工具，用于提供简单的机制来将以前由 <command>xend</command> 管理的域导入 <systemitem class="library">libvirt</systemitem>。有关 <command>xen2libvirt</command> 的详细信息，请参见<xref linkend="xen-xen2libvirt"/>。
      </para>
    </sect2>

    <sect2 xml:id="sec-xmltoxl-design">
      <title>XL 设计</title>
      <para>
        每个 <command>xl</command> 命令的基本结构如下：
      </para>
<screen><command>xl subcommand</command> <option>OPTIONS</option> <replaceable>DOMAIN</replaceable></screen>
      <para>
        <replaceable>DOMAIN</replaceable> 是域 ID 编号或者域名（在内部转换为域 ID），<replaceable>OPTIONS</replaceable> 是特定于子命令的选项。
      </para>
      <para>
        尽管 xl/libxl 可以向后兼容 xm/xend，但您应该注意两者之间的几项差别：
      </para>
      <itemizedlist mark="bullet" spacing="normal">
        <listitem>
          <para>
            受管域或持久域。<systemitem class="library">libvirt</systemitem> 现在提供此项功能。
          </para>
        </listitem>
        <listitem>
          <para>
            xl/libxl 不支持在域配置文件中使用 Python 代码。
          </para>
        </listitem>
        <listitem>
          <para>
            xl/libxl 不支持基于 SXP 格式配置文件创建域 (<command>xm</command> <option>create</option> -F)。
          </para>
        </listitem>
        <listitem>
          <para>
            xl/libxl 不支持通过域配置文件中的 <command>w!</command> 在 DomU 之间共享存储。
          </para>
        </listitem>
      </itemizedlist>
      <para>
        xl/libxl 是尚在大力开发之中的新工具堆栈，因此相比 xm/xend 工具堆栈仍然缺少一些功能：
      </para>
      <itemizedlist mark="bullet" spacing="normal">
        <listitem>
          <para>
            SCSI LUN/主机直通 (PVSCSI)
          </para>
        </listitem>
        <listitem>
          <para>
            USB 直通 (PVUSB)
          </para>
        </listitem>
        <listitem>
          <para>
            Xen 全虚拟化 Linux Guest 的直接内核引导
          </para>
        </listitem>
      </itemizedlist>
    </sect2>

    <sect2 xml:id="sec-xmtoxl-checklist">
      <title>升级前的核对清单</title>
      <para>
        <phrase os="sles;sled">在将 SLES 11 SP4 Xen 主机升级到 SLES 15 之前：</phrase> 
      </para>
      <itemizedlist mark="bullet" spacing="normal">
        <listitem>
          <para>
            必须从 xm 域配置文件中去除任何 Python 代码。
          </para>
        </listitem>
        <listitem>
          <para>
            建议使用 <command>virsh</command>
            <option>dumpxml</option> <replaceable>DOMAIN_NAME</replaceable>
            <replaceable>DOMAIN_NAME.xml</replaceable> 捕获所有现有虚拟机中的 libvirt 域 XML。
          </para>
        </listitem>
        <listitem>
          <para>
            建议备份 <filename>/etc/xen/xend-config.sxp</filename> 和 <filename>/boot/grub/menu.lst</filename> 文件，以保留以前用于 Xen 的参数的参考信息。
          </para>
        </listitem>
      </itemizedlist>
      <note>
        <para>
          目前不支持将 <phrase os="sles;sled">SLES 11 SP4 Xen 主机上运行的虚拟机</phrase>实时迁移到 SLES 15 Xen 主机。<command>xend</command> 与 libxl 工具堆栈的运行时环境不兼容。需要关闭虚拟机才能进行迁移。
        </para>
      </note>
    </sect2>
  </sect1>
  
  <xi:include href="xm_vs_xl_xen2libvirt.xml"/>
  
  <xi:include href="xm_vs_xl.xml"/>
  
  <xi:include href="xm_vs_xl_links.xml"/>
  
  <sect1 xml:id="sec-libvirt-managing-export-Xen-xm">
    <title>以与 <command>xm</command> 兼容的格式保存 Xen Guest 配置</title>

    <para>
      尽管 <command>xl</command>是当前用于管理 Xen Guest 的工具集（此外还有首选的 <systemitem class="library">libvirt</systemitem>），但您可能需要将 Guest 配置导出为过去使用的 <command>xm</command> 格式。要实现此目的，请执行以下步骤：
    </para>

    <procedure>
      <step>
        <para>
          首先将 Guest 配置导出到某个文件中：
        </para>
<screen><prompt>&gt; </prompt>virsh dumpxml guest_id &gt; guest_cfg.xml</screen>
      </step>
      <step>
        <para>
          然后将配置转换为 <command>xm</command> 格式：
        </para>
<screen><prompt>&gt; </prompt>virsh domxml-to-native xen-xm guest_cfg.xml &gt; guest_xm_cfg</screen>
      </step>
    </procedure>
  </sect1>
</appendix>
