<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_teaming.xml" version="5.1" xml:id="sec.team">
 <title>Configurando dispositivos de equipe para agrupamento de rede</title>

 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes (sim)</dm:translation>
  </dm:docmanager>
 </info>

 <remark>toms 2016-06-16: FATE#320468</remark>

 <para>
  <quote>Agregação de link</quote> é o termo geral que descreve a combinação (ou agregação) de uma conexão de rede para fornecer uma camada lógica. Às vezes, você encontra os termos <quote>agrupamento de canais</quote>, <quote>ligação Ethernet</quote>, <quote>truncamento de porta</quote>, etc. que são sinônimos e fazem referência ao mesmo conceito.
 </para>

 <para>
  Esse conceito é bastante conhecido como <quote>ligação</quote> e foi originalmente integrado ao kernel do Linux (consulte a <xref linkend="sec.bond"/> para ver a implementação original). O termo <emphasis>Agrupamento de Rede</emphasis> é usado para fazer referência à nova implementação desse conceito.
 </para>

 <para>
  A principal diferença entre a ligação e o Agrupamento de Rede é que o agrupamento dispõe de um conjunto de pequenos módulos do kernel que são responsáveis pelo fornecimento de uma interface para instâncias do teamd. Todo o restante é executado no espaço do usuário. Isso é diferente da implementação de ligação original que inclui todas as suas funcionalidades exclusivamente no kernel. Para ver uma comparação, consulte a <xref linkend="tab.team.comparison"/>.
 </para>

 <table xml:id="tab.team.comparison">
  <title>Comparação de Recursos entre Vínculo e Equipe</title>
  <tgroup cols="3">
   <colspec colname="c1"/>
   <colspec colname="c2"/>
   <colspec colname="c3"/>
   <thead>
    <row>
     <entry>Recurso</entry>
     <entry>Vínculo</entry>
     <entry>Equipe</entry>
    </row>
   </thead>
   <tfoot>
    <row>
     <entry namest="c1" nameend="c3">Fonte: <link xlink:href="http://libteam.org/files/teamdev.pp.pdf"/></entry>
    </row>
   </tfoot>
   <tbody>
    <row>
     <entry>broadcast, política TX round-robin</entry>
     <entry>sim</entry>
     <entry>sim</entry>
    </row>
    <row>
     <entry>política TX active-backup</entry>
     <entry>sim</entry>
     <entry>sim</entry>
    </row>
    <row>
     <entry>Suporte a LACP (802.3ad)</entry>
     <entry>sim</entry>
     <entry>sim</entry>
    </row>
    <row>
     <entry>Política TX baseada em hash</entry>
     <entry>sim</entry>
     <entry>sim</entry>
    </row>
    <row>
     <entry>Usuário pode definir função de hash</entry>
     <entry>não</entry>
     <entry>sim</entry>
    </row>
    <row>
     <entry>Suporte a balanceamento de carga TX (TLB)</entry>
     <entry>sim</entry>
     <entry>sim</entry>
    </row>
    <row>
     <entry>Suporte a balanceamento de carga TX para LACP</entry>
     <entry>não</entry>
     <entry>sim</entry>
    </row>
    <row>
     <entry>Monitoramento de link Ethtool</entry>
     <entry>sim</entry>
     <entry>sim</entry>
    </row>
    <row>
     <entry>Monitoramento de link ARP</entry>
     <entry>sim</entry>
     <entry>sim</entry>
    </row>
    <row>
     <entry>Monitoramento de link NS/NA (IPV6)</entry>
     <entry>não</entry>
     <entry>sim</entry>
    </row>
    <row>
     <entry>Bloqueio de RCU em caminhos TX/RX</entry>
     <entry>não</entry>
     <entry>sim</entry>
    </row>
    <row>
     <entry>porta prio e adesão</entry>
     <entry>não</entry>
     <entry>sim</entry>
    </row>
    <row>
     <entry>configuração de monitoramento de link separado por porta</entry>
     <entry>não</entry>
     <entry>sim</entry>
    </row>
    <row>
     <entry>configuração de monitoramento de links múltiplos</entry>
     <entry>limitado</entry>
     <entry>sim</entry>
    </row>
    <row>
     <entry>Suporte a VLAN</entry>
     <entry>sim</entry>
     <entry>sim</entry>
    </row>
    <row>
     <entry>empilhamento de vários dispositivos</entry>
     <entry>sim</entry>
     <entry>sim</entry>
    </row>
   </tbody>
  </tgroup>
 </table>

 <para>
  Ambas as implementações, ligação e Agrupamento de Rede, podem ser usadas em paralelo. O Agrupamento de Rede é uma alternativa à implementação de ligação existente. Ele não a substitui.
 </para>

 <para>
  É possível usar o Agrupamento de Rede em diversos casos de uso. Os dois casos de uso mais importantes são explicados mais adiante e envolvem:
 </para>

 <itemizedlist>
  <listitem>
   <para>
    Equilíbrio de carga entre dispositivos de rede diferentes.
   </para>
  </listitem>
  <listitem>
   <para>
    Failover de um dispositivo de rede para outro em caso de falha em um dos dispositivos.
   </para>
  </listitem>
 </itemizedlist>

 <para>
  <remark>toms 2016-06-21: FATE#320947 for Teaming in/with YaST</remark> No momento, não há nenhum módulo do YaST que suporte a criação de dispositivo do agrupamento. Você precisa configurar o Agrupamento de Rede manualmente. O procedimento geral é mostrado a seguir e pode ser aplicado a todas as suas configurações de Agrupamento de Rede:
 </para>

 <procedure xml:id="pro.team.general">
  <title>Procedimento geral</title>
  <step>
   <para>
    Verifique se que você possui todos os pacotes necessários instalados. Instale os pacotes
    <package>libteam-tools</package>,
    <package>libteamdctl0</package>, e
    <package>python-libteam</package>.
   </para>
  </step>
  <step>
   <para>
    Crie um arquivo de configuração em <filename>/etc/sysconfig/network/</filename>. Normalmente, esse arquivo é <filename>ifcfg-team0</filename>. Se você precisar de mais de um dispositivo de Agrupamento de Rede, numere-os em ordem crescente.
   </para>
   <para>
    Esse arquivo de configuração contém diversas variáveis que são explicadas nas páginas de manual (consulte <command>man ifcfg</command> e <command>man ifcfg-team</command>). Há um exemplo de configuração em seu sistema no arquivo <filename>/etc/sysconfig/network/ifcfg.template</filename>.
   </para>
  </step>
  <step>
   <para>
    Remova os arquivos de configuração das interfaces que serão usadas com o dispositivo de agrupamento (geralmente, <filename>ifcfg-eth0</filename> e <filename>ifcfg-eth1</filename>).
   </para>
   <para>
    É recomendável fazer um backup e remover os dois arquivos. O Wicked recriará os arquivos de configuração com os parâmetros necessários para o agrupamento.
   </para>
  </step>
  <step>
   <para>
    Opcionalmente, verifique se tudo está incluído no arquivo de configuração do Wicked:
   </para>
<screen>wicked show-config</screen>
  </step>
  <step>
   <para>
    Inicie o dispositivo de Agrupamento de Rede <systemitem class="service">team0</systemitem>:
   </para>
<screen>wicked ifup all team0</screen>
   <para>
    Se você precisar de informações adicionais sobre depuração, use a opção <option>--debug all</option> após o subcomando <command>all</command>.
   </para>
  </step>
  <step>
   <para>
    Verifique o status do dispositivo de Agrupamento de Rede. Para fazer isso, execute os seguintes comandos:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Obtenha o estado da instância do teamd do Wicked:
     </para>
<screen>wicked ifstatus --verbose team0</screen>
    </listitem>
    <listitem>
     <para>
      Obtenha o estado de toda a instância:
     </para>
<screen>teamdctl team0 state</screen>
    </listitem>
    <listitem>
     <para>
      Obtenha o estado do systemd da instância do teamd:
     </para>
<screen>systemctl status teamd@team0</screen>
    </listitem>
   </itemizedlist>
   <para>
    Cada um deles mostra uma tela um pouco diferente, dependendo das suas necessidades.
   </para>
  </step>
  <step>
   <para>
    Se você precisar mudar algo no arquivo <filename>ifcfg-team0</filename> posteriormente, recarregue sua configuração com:
   </para>
<screen>wicked ifreload team0</screen>
  </step>
 </procedure>

 <para>
  <emphasis>Não</emphasis> use <command>systemctl</command> para iniciar ou parar o dispositivo de agrupamento! Em vez disso, use o comando <command>wicked</command> conforme mostrado acima.
 </para>

 <para>
  Para remover completamente o dispositivo de equipe, siga este procedimento:
 </para>
 <procedure>
  <title>Removendo um dispositivo de equipe</title>
  <step>
   <para>
    Pare o dispositivo de Agrupamento de Rede <systemitem class="service">team0</systemitem>:
   </para>
   <screen>wicked ifdown team0</screen>
  </step>
  <step>
   <para>
    Renomeie o arquivo <filename>/etc/sysconfig/network/ifcfg-team0</filename> para <filename>/etc/sysconfig/network/.ifcfg-team0</filename>. Inserir um ponto na frente do nome do arquivo o torna <quote>invisível</quote> para wicked. Se você realmente não precisa mais da configuração, também pode remover o arquivo.
   </para>
  </step>
  <step>
   <para>Recarregue a configuração:</para>
   <screen>wicked ifreload all</screen>
  </step>
 </procedure>

 <sect2 xml:id="sec.team.lb">
  <title>Caso de uso: equilíbrio de carga com Agrupamento de Rede</title>
  <para>
   O equilíbrio de carga é usado para melhorar a largura de banda. Use o seguinte arquivo de configuração para criar um dispositivo de Agrupamento de Rede com recursos de equilíbrio de carga. Prossiga com <xref linkend="pro.team.general"/> para configurar o dispositivo. Verifique a saída com <command>teamdctl</command>.
  </para>
  <example xml:id="ex.team.lb">
   <title>Configuração para equilíbrio de carga com Agrupamento de Rede</title>
<screen>STARTMODE=auto <co xml:id="co.team.lb.startmode"/>
BOOTPROTO=static <co xml:id="co.team.lb.boot-and-ip"/>
IPADDRESS="192.168.1.1/24" <xref linkend="co.team.lb.boot-and-ip"/>
IPADDR6="fd00:deca:fbad:50::1/64" <xref linkend="co.team.lb.boot-and-ip"/>

TEAM_RUNNER="loadbalance" <co xml:id="co.team.lb.loadbalance"/>
TEAM_LB_TX_HASH="ipv4,ipv6,eth,vlan"
TEAM_LB_TX_BALANCER_NAME="basic"
TEAM_LB_TX_BALANCER_INTERVAL="100"

TEAM_PORT_DEVICE_0="eth0" <co xml:id="co.team.lb.dev"/>
TEAM_PORT_DEVICE_1="eth1" <xref linkend="co.team.lb.dev"/>

TEAM_LW_NAME="ethtool" <co xml:id="co.team.lb.name"/>
TEAM_LW_ETHTOOL_DELAY_UP="10" <co xml:id="co.team.lb.ethtool.delay"/>
TEAM_LW_ETHTOOL_DELAY_DOWN="10" <xref linkend="co.team.lb.ethtool.delay"/></screen>

   <calloutlist>
    <callout arearefs="co.team.lb.startmode">
     <para>
      Controla a inicialização do dispositivo de agrupamento. O valor de <literal>auto</literal> significa que a interface será configurada quando o serviço de rede estiver disponível e será iniciada automaticamente a cada reinicialização.
     </para>
     <para>
      Caso você mesmo tenha necessidade de controlar o dispositivo (e impedir que ele seja iniciado automaticamente), defina <varname>STARTMODE</varname> como <literal>manual</literal>.
     </para>
    </callout>
    <callout arearefs="co.team.lb.boot-and-ip">
     <para>
      Define o endereço IP estático (neste caso, <systemitem class="ipaddress">192.168.1.1</systemitem> para IPv4 e <systemitem class="ipaddress">fd00:deca:fbad:50::1</systemitem> para IPv6).
     </para>
     <para>
      Se o dispositivo de Agrupamento de Rede tiver que usar um endereço IP dinâmico, defina <literal>BOOTPROTO="dhcp"</literal> e remova (ou comente) a linha com <varname>IPADDRESS</varname> e <varname>IPADDR6</varname>.
     </para>
    </callout>
    <callout arearefs="co.team.lb.loadbalance">
     <para>
      Define <varname>TEAM_RUNNER</varname> como <literal>loadbalance</literal> para ativar o modo de equilíbrio de carga.
     </para>
    </callout>
    <callout arearefs="co.team.lb.dev">
     <para>
      Especifica um ou mais dispositivos que devem ser agregados para criar o dispositivo de Agrupamento de Rede.
     </para>
    </callout>
    <callout arearefs="co.team.lb.name">
     <para>
      Define um monitor de link para monitorar o estado dos dispositivos subordinados. O valor padrão <literal>ethtool</literal> verifica apenas se o dispositivo está ativo e é acessível. Isso torna essa verificação rápida o suficiente. No entanto, ele não verifica se o dispositivo pode realmente enviar ou receber pacotes.
     </para>
     <para>
      Se você precisar de mais confiança na conexão, use a opção <literal>arp_ping</literal>. Ela envia pings a um host arbitrário (configurado na variável <varname>TEAM_LW_ARP_PING_TARGET_HOST</varname>). Apenas se as respostas forem recebidas, o dispositivo de Agrupamento de Rede será considerado ativo.
     </para>
    </callout>
    <callout arearefs="co.team.lb.ethtool.delay">
     <para>
      Define o atraso em milissegundos entre o link ficar ativo (ou inativo) e o executor ser notificado.
     </para>
    </callout>
   </calloutlist>
  </example>
 </sect2>

 <sect2 xml:id="sec.team.failover">
  <title>Caso de uso: failover com Agrupamento de Rede</title>
  <para>
   O failover é usado para garantir alta disponibilidade de um dispositivo de Agrupamento de Rede crítico envolvendo um dispositivo de rede de backup paralelo. O dispositivo de rede de backup é executado o tempo todo e entra em ação em caso de falha no dispositivo principal.
  </para>
  <para>
   Use o seguinte arquivo de configuração para criar um dispositivo de Agrupamento de Rede com recursos de failover. Prossiga com <xref linkend="pro.team.general"/> para configurar o dispositivo. Verifique a saída com <command>teamdctl</command>.
  </para>
  <example xml:id="ex.team.failover">
   <title>Configuração do dispositivo de Agrupamento de Rede DHCP</title>
<screen>STARTMODE=auto <co xml:id="co.team.failover.startmode"/>
BOOTPROTO=static <co xml:id="co.team.failover.boot-and-ip"/>
IPADDR="192.168.1.2/24" <xref linkend="co.team.failover.boot-and-ip"/>
IPADDR6="fd00:deca:fbad:50::2/64" <xref linkend="co.team.failover.boot-and-ip"/>

TEAM_RUNNER=activebackup <co xml:id="co.team.failover.activebackup"/>
TEAM_PORT_DEVICE_0="eth0" <co xml:id="co.team.failover.dev"/>
TEAM_PORT_DEVICE_1="eth1" <xref linkend="co.team.failover.dev"/>

TEAM_LW_NAME=ethtool <co xml:id="co.team.failover.name"/>
TEAM_LW_ETHTOOL_DELAY_UP="10" <co xml:id="co.team.failover.ethtool.delay"/>
TEAM_LW_ETHTOOL_DELAY_DOWN="10" <xref linkend="co.team.failover.ethtool.delay"/></screen>
   <calloutlist>
    <callout arearefs="co.team.failover.startmode">
     <para>
      Controla a inicialização do dispositivo de agrupamento. O valor de <literal>auto</literal> significa que a interface será configurada quando o serviço de rede estiver disponível e será iniciada automaticamente a cada reinicialização.
     </para>
     <para>
      Caso você mesmo tenha necessidade de controlar o dispositivo (e impedir que ele seja iniciado automaticamente), defina <varname>STARTMODE</varname> como <literal>manual</literal>.
     </para>
    </callout>
    <callout arearefs="co.team.failover.boot-and-ip">
     <para>
      Define o endereço IP estático (neste caso, <systemitem class="ipaddress">192.168.1.2</systemitem> para IPv4 e <systemitem class="ipaddress">fd00:deca:fbad:50::2</systemitem> para IPv6).
     </para>
     <para>
      Se o dispositivo de Agrupamento de Rede tiver que usar um endereço IP dinâmico, defina <literal>BOOTPROTO="dhcp"</literal> e remova (ou comente) a linha com <varname>IPADDRESS</varname> e <varname>IPADDR6</varname>.
     </para>
    </callout>
    <callout arearefs="co.team.failover.activebackup">
     <para>
      Define <varname>TEAM_RUNNER</varname> como <literal>activebackup</literal> para ativar o modo de failover.
     </para>
    </callout>
    <callout arearefs="co.team.failover.dev">
     <para>
      Especifica um ou mais dispositivos que devem ser agregados para criar o dispositivo de Agrupamento de Rede.
     </para>
    </callout>
    <callout arearefs="co.team.failover.name">
     <para>
      Define um monitor de link para monitorar o estado dos dispositivos subordinados. O valor padrão <literal>ethtool</literal> verifica apenas se o dispositivo está ativo e é acessível. Isso torna essa verificação rápida o suficiente. No entanto, ele não verifica se o dispositivo pode realmente enviar ou receber pacotes.
     </para>
     <para>
      Se você precisar de mais confiança na conexão, use a opção <literal>arp_ping</literal>. Ela envia pings a um host arbitrário (configurado na variável <varname>TEAM_LW_ARP_PING_TARGET_HOST</varname>). Apenas se as respostas forem recebidas, o dispositivo de Agrupamento de Rede será considerado ativo.
     </para>
    </callout>
    <callout arearefs="co.team.failover.ethtool.delay">
     <para>
      Define o atraso em milissegundos entre o link ficar ativo (ou inativo) e o executor ser notificado.
     </para>
    </callout>
   </calloutlist>
  </example>
 </sect2>

 <sect2 xml:id="sec.team.vlan">
  <title>Caso de uso: VLAN em dispositivo de equipe</title>
  
  <para>
   VLAN é a abreviação de <emphasis>Virtual Local Area Network</emphasis> (Rede Local Virtual). Ela permite a execução de várias redes Ethernet <emphasis>lógicas</emphasis> (virtuais) em uma única Ethernet física. Ela divide logicamente a rede em diferentes domínios de broadcast para que os pacotes sejam trocados apenas entre portas que são designadas para a mesma VLAN.
  </para>
  <para>
   O seguinte caso de uso cria duas VLANs estáticas na parte superior de um dispositivo de equipe:
  </para>
  <itemizedlist>
   <listitem>
     <para><systemitem class="other" otherclass="device">vlan0</systemitem>, vinculada ao endereço IP <systemitem class="ipaddress">192.168.10.1</systemitem></para>
   </listitem>
   <listitem>
     <para><systemitem class="other" otherclass="device">vlan1</systemitem>, vinculada ao endereço IP <systemitem class="ipaddress">192.168.20.1</systemitem></para>
   </listitem>
  </itemizedlist>

  <para>Proceda da seguinte maneira:</para>
  <procedure>
   <step>
    <para>
     Habilite as tags VLAN no switch. Para usar balanceamento de carga em seu dispositivo de equipe, o switch deve ser habilitado para LACP (<emphasis>Link Aggregation Control Protocol</emphasis> – Protocolo de Controle de Agregação de Links) (802.3ad). Consulte os detalhes no manual do hardware.
    </para>
   </step>
   
   <step>
    <para>
     Decida se você deseja usar balanceamento de carga ou failover em seu dispositivo de equipe. Configure o dispositivo de equipe conforme descrito na <xref linkend="sec.team.lb"/> ou na <xref linkend="sec.team.failover"/>.
    </para>
   </step>
   <step>
    <para>
     Em <filename>/etc/sysconfig/network</filename>, crie um arquivo <filename>ifcfg-vlan0</filename> com o seguinte conteúdo:
    </para>
    <screen>STARTMODE="auto"
BOOTPROTO="static" <co xml:id="co.team.vlan.bootproto"/>
IPADDR='192.168.10.1/24' <co xml:id="co.team.vlan.ipaddr"/>
ETHERDEVICE="team0" <co xml:id="co.team.vlan.etherdevice"/>
VLAN_ID="0" <co xml:id="co.team.vlan.vlan_id"/>
VLAN='yes'</screen>
    <calloutlist>
     <callout arearefs="co.team.vlan.bootproto">
      <para>
       Define um endereço IP fixo, especificado em <varname>IPADDR</varname>.
      </para>
     </callout>
     <callout arearefs="co.team.vlan.ipaddr">
      <para>
       Define o endereço IP, aqui com sua máscara de rede.
      </para>
     </callout>
     <callout arearefs="co.team.vlan.etherdevice">
      <para>
       Contém a interface real para usar para a interface VLAN, aqui nosso dispositivo de equipe (<systemitem>team0</systemitem>).
      </para>
     </callout>
     <callout arearefs="co.team.vlan.vlan_id">
      <para>
       Especifica um ID exclusivo para a VLAN. Preferencialmente, o nome do arquivo e a variável <varname>VLAN_ID</varname> correspondem ao nome <filename>ifcfg-vlan<replaceable>VLAN_ID</replaceable></filename>. No nosso caso, <varname>VLAN_ID</varname> é <literal>0</literal>, que leva ao nome de arquivo <filename>ifcfg-vlan0</filename>.
      </para>
     </callout>
     
    </calloutlist>
   </step>
   <step>
    <para>
     Copie o arquivo <filename>/etc/sysconfig/network/ifcfg-vlan0</filename> para <filename>/etc/sysconfig/network/ifcfg-vlan1</filename> e mude os seguintes valores:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       <varname>IPADDR</varname> de <systemitem class="ipaddress">192.168.10.1/24</systemitem> para <systemitem class="ipaddress">192.168.20.1/24</systemitem>.</para>
     </listitem>
     <listitem>
      <para>
       <varname>VLAN_ID</varname> de <literal>0</literal> para <literal>1</literal>.
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     Inicie as duas VLANs:
    </para>
    <screen><prompt role="root">root # </prompt><command>wicked</command> ifup vlan0 vlan1</screen>
   </step>
   <step>
    <para>
     Verifique a saída de <command>ifconfig</command>:
    </para>
    <screen><prompt role="root">root # </prompt><command>ifconfig</command> -a
[...]
vlan0     Link encap:Ethernet  HWaddr 08:00:27:DC:43:98
          inet addr:192.168.10.1 Bcast:192.168.10.255 Mask:255.255.255.0
          inet6 addr: fe80::a00:27ff:fedc:4398/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:12 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:0 (0.0 b)  TX bytes:816 (816.0 b)

vlan1     Link encap:Ethernet  HWaddr 08:00:27:DC:43:98
          inet addr:192.168.20.1 Bcast:192.168.20.255 Mask:255.255.255.0
          inet6 addr: fe80::a00:27ff:fedc:4398/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:12 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:0 (0.0 b)  TX bytes:816 (816.0 b)</screen>
   </step>
   
  </procedure>
 </sect2>
</sect1>
