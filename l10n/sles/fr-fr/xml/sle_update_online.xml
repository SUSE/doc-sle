<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_online.xml" version="5.0" xml:id="cha-upgrade-online">
 <title os="sles;sled">Mise à niveau en ligne</title>
 
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para os="sles;sled">
    SUSE offre un outil graphique intuitif et un outil de ligne de commande simple pour effectuer la mise à niveau d&apos;un système en cours d&apos;exécution vers un nouveau Service Pack. Ces outils permettent un <quote>retour à l&apos;état initial</quote> des Service Packs et bien plus encore. Ce chapitre fournit des instructions étape par étape sur la mise à niveau d&apos;un Service Pack à l&apos;aide de ces outils.
   </para>

   
  </abstract>
 </info>
 <sect1 xml:id="sec-upgrade-online-conceptual-overview">
  <title>Présentation conceptuelle</title>

  <para os="sles;sled">
   SUSE publie régulièrement de nouveaux Service Packs pour la gamme de produits SUSE Linux Enterprise. Pour faciliter la migration vers un nouveau Service Pack et minimiser les temps hors service, SUSE prend en charge la migration en ligne pendant que le système est en cours d&apos;exécution.
  </para>

  

  <para os="sles;sled">
   À partir de SLE 12, YaST Wagon a été remplacé par la migration YaST (pour l&apos;interface graphique) et la migration Zypper (pour la ligne de commande). Les avantages sont les suivants :
  </para>

  

  

  <itemizedlist>
   <listitem>
    <para>
     Le système est toujours dans un état défini jusqu&apos;à la mise à jour du premier RPM.
    </para>
   </listitem>
   <listitem>
    <para>
     L&apos;annulation est possible jusqu&apos;à la mise à jour du premier RPM.
    </para>
   </listitem>
   <listitem>
    <para>
     La récupération est simple en cas d&apos;erreur.
    </para>
   </listitem>
   <listitem>
    <para>
     Il est possible d&apos;effectuer un <quote>retour à l&apos;état initial</quote> au moyen des outils système, sans nécessiter de sauvegarde ou de restauration.
    </para>
   </listitem>
   <listitem>
    <para>
     Tous les dépôts actifs sont utilisés.
    </para>
   </listitem>
   <listitem os="sles;sled">
    <para>
     Il est possible d&apos;ignorer un Service Pack.
    </para>
   </listitem>
  </itemizedlist>

  <warning os="sles;sled">
   <title>migration en ligne non prise en charge pour les versions majeures</title>
   <para>
    La migration en ligne est prise en charge <emphasis>uniquement</emphasis> pour la migration des Service Packs. La migration en ligne n&apos;est <emphasis>pas prise en charge</emphasis> pour la mise à niveau vers les nouvelles versions majeures. Pour plus de détails, reportez-vous au <xref linkend="cha-upgrade-paths"/>.
   </para>
   <para>
    Utilisez la migration hors ligne pour mettre à niveau vers une nouvelle version majeure. Pour plus de détails, reportez-vous au <xref linkend="cha-upgrade-offline"/>.
   </para>
  </warning>

  <important os="sles;sled">
   <title>mise à niveau des clients SUSE Manager</title>
   <para>
    Si le système à mettre à niveau est un client SUSE Manager, l&apos;opération ne peut pas être effectuée par la migration en ligne YaST ni par la <command>migration Zypper</command>. Utilisez plutôt la procédure de <citetitle>migration de client</citetitle>. Elle est décrite dans le manuel <link xlink:href="https://documentation.suse.com/suma/">
    <citetitle>SUSE Manager Upgrade Guide</citetitle></link> (Guide de mise à niveau de SUSE Manager).
   </para>
  </important>
 </sect1>
 <sect1 os="sles;sled" xml:id="sec-upgrade-online-workflow">
  <title>Workflow de migration des Service Packs</title>

  <para>
   Une migration de Service Pack peut être exécutée à l&apos;aide des outils YaST, <command>zypper</command> ou AutoYaST.
  </para>

  <para>
   Avant de pouvoir démarrer la migration d&apos;un Service Pack, votre système doit être enregistré auprès du SUSE Customer Center ou d&apos;un serveur RMT local. Il est également possible d&apos;utiliser SUSE Manager.
  </para>

  <para>
   Quelle que soit la méthode utilisée, la migration de Service Packs comporte les étapes suivantes :
  </para>

  <orderedlist>
   <listitem>
    <para>
     L&apos;identification de cibles de migration possibles sur vos systèmes enregistrés
    </para>
   </listitem>
   <listitem>
    <para>
     La sélection d&apos;une cible de migration
    </para>
   </listitem>
   <listitem>
    <para>
     La demande et l&apos;activation de nouveaux dépôts
    </para>
   </listitem>
   <listitem>
    <para>
     L&apos;exécution de la migration
    </para>
   </listitem>
  </orderedlist>

  <para>
   La liste des cibles de migration dépend des produits que vous avez installés et enregistrés. Si vous avez une extension installée pour laquelle le nouveau Service Pack n&apos;est pas encore disponible, il se peut qu&apos;aucune cible de migration ne vous soit proposée.
  </para>

  <para>
   La liste des cibles de migration disponibles pour votre hôte sera toujours récupérée à partir du SUSE Customer Center et dépend des produits ou des extensions installées.
  </para>
 </sect1>
 
 <sect1 os="sles;sled" xml:id="sec-upgrade-online-cancel">
  <title>Annulation de la migration d&apos;un Service Pack</title>

  <para>
   La migration d&apos;un Service Pack peut uniquement être annulée à certains stades au cours du processus de migration :
  </para>

  <orderedlist>
   <listitem>
    <para>
     Jusqu&apos;au démarrage de la mise à niveau du paquetage, les modifications sur le système sont minimes et concernent, par exemple, les services et dépôts. Restaurez <filename>/etc/zypp/repos.d/*</filename> pour revenir à l&apos;état précédent.
    </para>
   </listitem>
   <listitem>
    <para>
     Après le démarrage de la mise à niveau du paquetage, vous pouvez revenir à l&apos;état précédent à l&apos;aide d&apos;un instantané Snapper (reportez-vous au <xref linkend="cha-snapper"/>).
    </para>
   </listitem>
   <listitem>
    <para>
     Une fois la cible de migration sélectionnée, SUSE Customer Center modifie les données du dépôt. Pour rétablir cet état manuellement, utilisez <command>SUSEConnect</command>
     <option>--rollback</option>.
    </para>
   </listitem>
  </orderedlist>
 </sect1>
 
 <sect1 os="sles;sled" xml:id="sec-upgrade-online-yast">
  <title>Mise à niveau à l&apos;aide de l&apos;outil de migration en ligne (YaST)</title>

  <para>
   Pour effectuer une migration de Service Packs à l&apos;aide de YaST, utilisez l&apos;outil de <guimenu>migration en ligne</guimenu>. Par défaut, YaST n&apos;installe pas les paquetages à partir d&apos;un dépôt tiers. Si un paquetage a été installé à partir d&apos;un dépôt tiers, YaST empêche le remplacement des paquetages par les mêmes provenant de SUSE.
  </para>

  <note>
   <title>réduction de la taille de l&apos;installation</title>
   <para>
    Lorsque vous effectuez la migration de Service Packs, YaST installe tous les paquetages recommandés. En particulier dans le cas d&apos;installations minimales personnalisées, cela peut augmenter considérablement la taille de l&apos;installation sur le système.
   </para>
   <para>
    Pour modifier ce comportement par défaut et autoriser uniquement les paquetages requis, réglez l&apos;option <option>solver.onlyRequires</option> dans <filename>/etc/zypp/zypp.conf</filename>.
   </para>
<screen>solver.onlyRequires = true</screen>
   <para>
    En outre, modifiez le fichier <filename>/etc/zypp/zypper.conf</filename> et changez l&apos;option <option>installRecommends</option>.
   </para>
   <screen>installRecommends=false</screen>
   <para>
    Cette opération modifie le comportement de toutes les opérations de paquetages, telles que l&apos;installation de correctifs ou de nouveaux paquetages. Afin de modifier le comportement de Zypper pour un seul appel, utilisez le paramètre <option>--no-recommends</option>.
  </para>
</note>

  <para>
   Pour démarrer la migration de Service Packs, procédez comme suit :
  </para>

  <procedure xml:id="pro-upgrade-online-yast">
   <step>
    <para>
     Désactivez toutes les extensions non utilisées sur votre serveur d&apos;enregistrement pour éviter les futurs conflits de dépendance. Si vous oubliez une extension, YaST détectera ultérieurement les dépôts d&apos;extension inutilisés et les désactivera.
    </para>
   </step>
   <step>
    <para>
     Si vous êtes connecté à une session GNOME en cours d&apos;exécution sur la machine que vous allez mettre à jour, basculez vers une console de texte. L&apos;exécution de la mise à jour à partir d&apos;une session GNOME n&apos;est pas recommandée. Notez que cela ne s&apos;applique pas lorsque vous êtes connecté à partir d&apos;une machine distante (sauf si vous exécutez une session VNC avec GNOME).
    </para>
   </step>
   
   <step>
    <para>
     Exécutez la mise à jour en ligne de YaST pour obtenir les dernières mises à jour des paquetages de votre système.
    </para>
   </step>
   <step>
    <para>
     Installez le paquetage <package>yast2-migration</package> et ses dépendances (dans YaST sous <menuchoice> <guimenu>Logiciels</guimenu>
     <guimenu>Gestion des logiciels</guimenu> </menuchoice>).
    </para>
   </step>
   <step>
    <para>
     Redémarrez YaST, car dans le cas contraire, le nouveau module installé ne s&apos;affiche pas dans SUSE Control Center.
    </para>
   </step>
   <step>
    <para>
     Dans YaST, choisissez la <guimenu>migration en ligne</guimenu> (selon la version de <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server (SLES)</phrase></phrase> que vous mettez à niveau, ce module est classé comme <guimenu>système</guimenu> ou <guimenu> logiciel</guimenu>). YaST affiche les cibles de migration possibles ainsi qu&apos;un récapitulatif. Si plusieurs cibles de migration sont disponibles pour votre système, sélectionnez-en une dans la liste.
    </para>
   </step>
   <step>
    <para>
     Sélectionnez une cible de migration à partir de la liste et cliquez sur <guimenu>Suivant</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Si l&apos;outil de migration propose des dépôts de mise à jour, il est recommandé de cliquer sur <guimenu>Oui</guimenu>.
    </para>
   </step>
   <step>
    <para>
     <remark>toms 2015-09-09: FATE#319140</remark>
     Si l&apos;outil de migration en ligne détecte des dépôts obsolètes provenant d&apos;un DVD ou d&apos;un serveur local, il est vivement recommandé de les désactiver. Les dépôts obsolètes proviennent d&apos;un ancien Service Pack. Les anciens dépôts du SUSE Customer Center ou de RMT sont supprimés automatiquement.
    </para>
   </step>
   <step>
    <para>
     Vérifiez le récapitulatif et procédez à la migration en cliquant sur <guimenu>Suivant</guimenu>. Confirmez en cliquant sur <guimenu>Start Update</guimenu> (Démarrer la mise à jour).
    </para>
    <remark>toms 2016-07-13: What to do in case of problems?</remark>
   </step>
   <step>
    <para>
     Une fois la migration réussie, redémarrez votre système.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 os="sles;sled" xml:id="sec-upgrade-online-zypper">
  <title>Mise à niveau avec zypper</title>

  <para>
   Pour effectuer une migration de Service Packs à l&apos;aide de Zypper, utilisez l&apos;outil de ligne de commande <command>zypper</command> <option> migration</option> du paquetage <package>zypper-migration-plugin</package>.
  </para>

  <note>
   <title>réduction de la taille de l&apos;installation</title>
   <para>
    Lorsque vous effectuez la migration de Service Packs, YaST installe tous les paquetages recommandés. En particulier dans le cas d&apos;installations minimales personnalisées, cela peut augmenter considérablement la taille de l&apos;installation sur le système.
   </para>
   <para>
    Pour modifier ce comportement par défaut et autoriser uniquement les paquetages requis, réglez l&apos;option <option>solver.onlyRequires</option> dans <filename>/etc/zypp/zypp.conf</filename>.
   </para>
<screen>solver.onlyRequires = true</screen>
   <para>
    En outre, modifiez le fichier <filename>/etc/zypp/zypper.conf</filename> et changez l&apos;option <option>installRecommends</option>.
   </para>
   <screen>installRecommends=false</screen>
   <para>
    Cette opération modifie le comportement de toutes les opérations de paquetages, telles que l&apos;installation de correctifs ou de nouveaux paquetages. Afin de modifier le comportement de Zypper pour un seul appel, utilisez le paramètre <option>--no-recommends</option>.
  </para>
</note>

  <para>
   Pour démarrer la migration de Service Packs, procédez comme suit :
  </para>

  <procedure xml:id="pro-upgrade-online-zypper">
   <step>
    <para>
     Si vous êtes connecté à une session GNOME en cours d&apos;exécution sur la machine que vous allez mettre à jour, basculez vers une console de texte. L&apos;exécution de la mise à jour à partir d&apos;une session GNOME n&apos;est pas recommandée. Notez que cela ne s&apos;applique pas lorsque vous êtes connecté à partir d&apos;une machine distante (sauf si vous exécutez une session VNC avec GNOME).
    </para>
   </step>
   <step>
    <para>
     Enregistrez votre machine SUSE Linux Enterprise si ce n&apos;est pas déjà fait :
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>SUSEConnect</command> --regcode <replaceable>YOUR_REGISTRATION_CODE</replaceable></screen>
   </step>
   
   <step>
    <para>
     Démarrez la migration :
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>zypper migration</command></screen>
    <para>
     Quelques remarques concernant le processus de migration :
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Si plusieurs cibles de migration sont disponibles pour votre système, Zypper vous autorise à sélectionner un Service Pack dans la liste. Cette opération revient à ignorer un ou plusieurs Service Packs. N&apos;oubliez pas, la migration en ligne pour les produits de base (SLES, SLED) reste uniquement disponible entre les Service Packs d&apos;une version majeure.
      </para>
     </listitem>
     <listitem>
      <para>
       Par défaut, Zypper utilise l&apos;option <option>--no-allow-vendor-change</option> transmise à <command>zypper</command> <option> dup</option> Si un paquetage a été installé à partir d&apos;un dépôt tiers, cette option empêche le remplacement des paquetages par les mêmes provenant de SUSE.
      </para>
     </listitem>
     <listitem>
      <para>
       <remark>toms 2015-09-09: FATE#319140</remark>
       Si Zypper détecte des dépôts obsolètes provenant d&apos;un DVD ou d&apos;un serveur local, il est vivement recommandé de les désactiver. Les anciens dépôts du SUSE Customer Center ou de RMT sont supprimés automatiquement.
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     Passez en revue toutes les modifications, en particulier les paquetages qui vont être supprimés. Poursuivez en saisissant <literal>y</literal> (le nombre exact de paquetages à mettre à niveau peut varier sur votre système) :
    </para>
<screen>266 packages to upgrade, 54 to downgrade, 17 new, 8 to reinstall, 5 to remove, 1 to change arch.
Overall download size: 285.1 MiB. Already cached: 0 B  After the operation, additional 139.8 MiB will be used.
Continue? [y/n/? shows all options] (y):</screen>
    <para>
     Utilisez les touches de défilement <keycombo> <keycap function="shift"/> <keycap function="pageup"/>
     </keycombo>    ou <keycombo> <keycap function="shift"/>
     <keycap function="pagedown"/> </keycombo>    dans votre shell.
    </para>
   </step>
   <step>
    <para>
     Une fois la migration réussie, redémarrez votre système.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 os="sles;sled" xml:id="sec-upgrade-online-zypper-plain">
  <title>Mise à niveau à l&apos;aide de la version ordinaire de Zypper</title>

  <para>
   Si votre système n&apos;est pas enregistré parce que vous n&apos;avez pas accès à Internet ou à un serveur d&apos;enregistrement, la migration vers un nouveau Service Pack n&apos;est pas possible avec la migration YaST ou la <command>migration zypper</command>. Dans ce cas, vous pouvez toujours migrer vers un nouveau Service Pack avec la version ordinaire de Zypper et certaines interactions manuelles.
  </para>

  <important>
   <title>pour les systèmes non enregistrés uniquement</title>
   <para>
    Ce chemin de migration vers un nouveau Service Pack est <emphasis>uniquement</emphasis> pris en charge pour les systèmes non enregistrés qui ne peuvent pas accéder à Internet ou à un serveur d&apos;enregistrement. Ce peut être le cas, par exemple, pour les machines d&apos;un réseau bénéficiant d&apos;une protection spéciale. Si vous disposez d&apos;un système enregistré, utilisez la migration YaST ou Zypper.
   </para>
  </important>

  <important>
   <title>sources d&apos;installation</title>
   <para>
    Ce chemin de migration nécessite que le système que vous allez migrer ait accès aux sources d&apos;installation. Pour ce faire, vous pouvez, par exemple, configurer un serveur RMT ou un serveur SLP.
   </para>
   <para>
    Le système doit également avoir accès à un dépôt de mises à jour actualisé pour la version du produit installé.
   </para>
  </important>

  <procedure>
   <step>
    <para>
     Si vous êtes connecté à une session graphique en cours d&apos;exécution sur la machine que vous allez migrer, déconnectez-vous de cette session et basculez vers une console de texte. L&apos;exécution de la mise à jour à partir d&apos;une session graphique n&apos;est pas recommandée. Notez que cela ne s&apos;applique pas lorsque vous êtes connecté à partir d&apos;une machine distante (sauf si vous exécutez une session VNC avec X).
    </para>
   </step>
   <step>
    <para>
     Mettez à jour les outils de gestion des paquetages avec les anciens dépôts SUSE Linux Enterprise :
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>zypper</command> patch --updatestack-only</screen>
   </step>
   <step>
    <para>
     Procurez-vous la liste des paquetages auxquels aucun dépôt n&apos;est actuellement assigné (paquetages orphelins). Ces paquetages ne seront pas migrés et il n&apos;est pas garanti qu&apos;ils fonctionneront après la migration (en effet, d&apos;autres paquetages dont ils dépendent risquent d&apos;avoir été modifiés et de ne plus être compatibles). Pour obtenir cette liste, exécutez la commande :
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> zypper packages --orphaned</screen>
    <para>
     Parcourez la liste avec attention et supprimez tous les paquetages orphelins qui ne sont plus nécessaires. Prenez note de tous les paquetages orphelins restants, car cela vous sera utile ultérieurement pour effectuer une comparaison.
    </para>
   </step>
   <step>
    <para>
     Pour obtenir la liste de tous les dépôts auxquels le système est actuellement abonné, exécutez la commande suivante :
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> zypper repos -u</screen>
    <para>
     Mettez à jour chaque URL de dépôt afin que son numéro de version du produit soit <literal>15-SP4</literal>. Par exemple, si l&apos;URL d&apos;un dépôt est
    </para>
<screen>http://rmt.example.com/repo/SUSE/Products/SLE-15-SP2-Product-SLES/x86_64/product/</screen>
    <para>
     remplacez-la par
    </para>
<screen>http://rmt.example.com/repo/SUSE/Products/SLE-15-SP3-Product-SLES/x86_64/product/</screen>
    <para>
     Cette opération doit être effectuée pour tous les dépôts activés. Vous pouvez également envisager d&apos;effectuer cette opération pour les dépôts actuellement désactivés, afin d&apos;éviter que le système comporte des sources d&apos;installation incorrectes lorsque vous les activerez ultérieurement.
    </para>
    <para>
     Pour modifier les URL de dépôt, vous disposez des options suivantes :
    </para>
    <substeps>
     <step>
      <para>
       Vous pouvez utiliser <menuchoice> <guimenu>YaST</guimenu> <guimenu>Logiciels</guimenu>
       <guimenu>Dépôts de logiciels</guimenu></menuchoice>. Sélectionnez un espace de stockage, puis cliquez sur <guimenu>Modifier</guimenu> pour effectuer le changement voulu. Répétez cette opération pour tous les dépôts.
      </para>
     </step>
     <step>
      <para>
       Vous pouvez utiliser Zypper. Supprimez l&apos;ancien dépôt en exécutant la commande suivante :
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> zypper removerepo <replaceable>OLD_REPO_ID</replaceable></screen>
      <para>
       Ajoutez ensuite le nouveau dépôt correspondant en exécutant la commande suivante :
      </para>
<screen> <prompt>&gt; </prompt><command>sudo</command> zypper addrepo -f <replaceable>URL</replaceable> <replaceable>NAME</replaceable>-15-SP4</screen>
     </step>
     <step>
      <para>
       Vous pouvez modifier les fichiers de configuration de dépôt dans <filename>/etc/ZYpp/repos.d</filename>. Chaque dépôt est représenté par un fichier de configuration. Vous devez modifier la valeur du paramètre <literal>baseurl</literal> dans chaque fichier.
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     Vérifiez vos modifications en exécutant <command>zypper repos-u</command> et mettez à jour les dépôts en exécutant :
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> zypper refresh -f -s</screen>
    <para>
     Si la mise à jour d&apos;un dépôt échoue, vérifiez que l&apos;URL saisie est correcte. Si vous ne parvenez pas à résoudre le problème, il est recommandé de désactiver le dépôt ayant échoué.
    </para>
    <para>
     Si tous les dépôts sont correctement configurés, exécutez :
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> zypper refresh -f -s</screen>
    <para>
     à nouveau pour vous assurer que <emphasis>tous</emphasis> les dépôts sont à jour.
    </para>
   </step>
   <step>
    <para>
     Avant de commencer la migration, il est recommandé de procéder à un test d&apos;exécution :
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> zypper dup -D --no-allow-vendor-change --no-recommends</screen>
    <para>
     Le paramètre <option>-D</option> permet d&apos;effectuer une exécution directe qui simule la migration sans réellement modifier le système. Si des problèmes surviennent, corrigez-les avant de poursuivre. En cas de réussite du test d&apos;exécution, procédez à la migration réelle en exécutant la commande suivante :
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> zypper dup --no-allow-vendor-change --no-recommends</screen>
    <para>
     L&apos;option <option>-no-allow-vendor-change</option> évite que des RPM tiers écrasent des RPM du système de base. L&apos;option <option>--no-recommends</option> permet de s&apos;assurer que les paquetages désélectionnés au cours de l&apos;installation initiale ne sont pas ajoutés à ce stade.
    </para>
   </step>
   <step>
    <para>
     Une fois que la migration est terminée et que le système a démarré avec la nouvelle version du Service Pack, relancez la recherche des paquetages orphelins :
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> zypper packages --orphaned</screen>
    <para>
     Comparez la nouvelle liste et celle que vous avez générée avant de démarrer la migration. Si de nouveaux paquetages apparaissent dans la liste, il se peut qu&apos;ils aient été déplacés vers un autre module du nouveau Service Pack. Si vous n&apos;aviez pas ce module dans l&apos;installation précédente, le paquetage n&apos;a pas été mis à jour.
    </para>
    <para>
     Vous pouvez vérifier à quel module un paquetage appartient sur le site <link xlink:href="https://scc.suse.com/packages"/>. Ajoutez les modules manquants à l&apos;aide de <command>zypper addrepo</command> ou du module YaST Software Repositories (Dépôts logiciels YaST) et mettez à jour les paquetages orphelins ultérieurement en exécutant :
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> zypper install --no-recommends <replaceable>LIST OF PACKAGES</replaceable></screen>
   </step>
   <step>
    <para>
     Vous avez migré vers un nouveau Service Pack !
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 os="sles;sled" xml:id="sec-upgrade-online-rollback">
  <title>Restauration de l&apos;état initial d&apos;un Service Pack</title>

  <para>
   Si un Service Pack ne fonctionne pas pour vous, SUSE Linux Enterprise prend en charge le rétablissement de l&apos;état qu&apos;il avait avant le démarrage de la migration de ce Service Pack. Vous devez toutefois disposer d&apos;une partition racine Btrfs avec des instantanés activés (il s&apos;agit de la valeur par défaut depuis SLES 12). Reportez-vous au <xref linkend="cha-snapper"/> pour plus d&apos;informations. 
  </para>

  <procedure xml:id="pro-upgrade-online-rollback">
   <step>
    <para>
     Obtenez une liste des instantanés Snapper :
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> snapper list</screen>
    <para>
     Passez en revue la sortie pour localiser l&apos;instantané créé juste avant le début de la migration du Service Pack. La colonne <guimenu>Description</guimenu> contient une instruction correspondante et l&apos;instantané est marqué comme <literal>important</literal> dans la colonne <guimenu>Userdata</guimenu>. Mémorisez le numéro de l&apos;instantané indiqué dans la colonne <guimenu>#</guimenu> ainsi que la date reprise dans la colonne <guimenu>Date</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Redémarrez le système. Dans le menu de démarrage, sélectionnez <guimenu>Start boot loader from a read-only snapshot</guimenu> (Démarrer le chargeur de démarrage à partir d&apos;un instantané en lecture seule), puis choisissez l&apos;instantané avec la date et le numéro mémorisé à l&apos;étape précédente. Un second menu de démarrage (celui de l&apos;instantané) est chargé. Sélectionnez l&apos;entrée commençant par SLES<phrase role="productnumber"><phrase os="sles;sled"> 15 SP4</phrase></phrase> et lancez-la.
    </para>
   </step>
   <step>
    <para>
     Le système démarre en utilisant son état précédent avec la partition système montée en lecture seule. Connectez-vous en tant qu&apos;utilisateur <systemitem class="username">root</systemitem> et vérifiez si vous avez sélectionné l&apos;instantané approprié. Vérifiez également que tout fonctionne comme prévu. Notez que puisque le système de fichiers root est monté en lecture seule, les fonctionnalités peuvent être limitées.
    </para>
    <para>
     En cas de problème ou si vous n&apos;avez pas démarré l&apos;instantané approprié, redémarrez et choisissez un autre instantané à partir duquel démarrer. À ce stade, aucune modification permanente n&apos;a été effectuée. Si l&apos;instantané est correct et fonctionne comme prévu, confirmez la modification pour la rendre définitive en exécutant la commande suivante :
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> snapper rollback</screen>
    <para>
     Redémarrez la machine. Dans l&apos;écran de démarrage, sélectionnez l&apos;entrée de démarrage par défaut pour redémarrer sur le système rétabli.
    </para>
   </step>
   <step>
    <para>
     Vérifiez si la configuration du dépôt a bien été réinitialisée. En outre, vérifiez si tous les produits sont correctement enregistrés. Si l&apos;un d&apos;entre eux ne l&apos;est pas, le système risque de ne plus pouvoir être mis à jour par la suite ou risque d&apos;être mis à jour avec des dépôts de paquetage incorrects.
    </para>
    <para>
     Assurez-vous que le système a accès à Internet avant de démarrer cette procédure.
    </para>
    <substeps>
     <step>
      <para>
       Rafraîchissez les dépôts et les services en exécutant la commande suivante :
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> zypper ref -fs</screen>
     </step>
     <step>
      <para>
       Obtenez une liste des dépôts actifs en exécutant la commande suivante :
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> zypper lr</screen>
      <para>
       Vérifiez attentivement la sortie de cette commande. Aucun service ni dépôt ajoutés pour la mise à jour ne doivent être répertoriés. Par exemple, si vous effectuez un retour à l&apos;état initial depuis SLES <phrase role="productnumber"><phrase os="sles;sled">15 SP4</phrase></phrase> vers SLES 15 GA, la liste doit contenir les dépôts <literal>SLES15-GA</literal> et non les dépôts <literal>SLES15-SP4</literal>.
      </para>
      <para>
       Si les dépôts répertoriés sont incorrects, supprimez-les et, si nécessaire, remplacez-les par les versions correspondant à votre version du produit ou du Service Pack. Pour obtenir la liste des dépôts et les chemins de migration pris en charge, reportez-vous à la <xref linkend="sec-upgrade-background-modules"/>. (Notez qu&apos;une intervention manuelle ne devrait pas être nécessaire, étant donné que les dépôts doivent être mis à jour automatiquement, mais il est recommandé de vérifier et d&apos;apporter les éventuelles corrections nécessaires).
      </para>
     </step>
     <step>
      <para>
       Enfin, vérifiez l&apos;état d&apos;enregistrement de tous les produits installés en exécutant la commande suivante :
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> SUSEConnect --status</screen>
      <para>
       Tous les produits doivent être signalés comme étant <literal>Enregistré</literal>. Si ce n&apos;est pas le cas, réparez l&apos;enregistrement en exécutant la commande
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> SUSEConnect --rollback</screen>
     </step>
    </substeps>
   </step>
  </procedure>

  <para>
   Vous avez à présent réinitialisé le système à l&apos;état capturé immédiatement avant le début de la migration du Service Pack.
  </para>
 </sect1>
 <sect1 os="sles;sled" xml:id="sec-upgrade-online-manager">
  <title>Mise à niveau à l&apos;aide de SUSE Manager</title>

  <para>
   SUSE Manager est une solution serveur pour fournir des mises à jour et des correctifs pour les clients SUSE Linux Enterprise. Il s&apos;accompagne d&apos;un ensemble d&apos;outils et d&apos;une interface utilisateur Web pour les tâches de gestion. Pour plus d&apos;informations sur SUSE Manager, consultez l&apos;adresse <link xlink:href="https://www.suse.com/products/suse-manager/"/>.
  </para>

  <para>
   La migration de Service Pack permet de migrer d&apos;un Service Pack (SP) vers un autre au sein d&apos;une version majeure (par exemple, à partir de SLES 15 GA vers SLES 15 SP4).
  </para>

  
  <para>
  Si votre machine est gérée par SUSE Manager, mettez ce dernier à jour comme indiqué dans la documentation de SUSE Manager. La procédure de <citetitle>migration de client</citetitle> est décrite dans le manuel <citetitle>SUSE Manager Upgrade Guide</citetitle> (Guide de mise à niveau de SUSE Manager), disponible à l&apos;adresse <link xlink:href="https://documentation.suse.com/suma/"/>.
 </para>
 </sect1>
 <sect1 xml:id="sec-upgrade-online-leap-to-sle" os="sles">
  <title>Mise à niveau d&apos;openSUSE Leap vers <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase></title>

  <para>
   Vous pouvez mettre à niveau une installation openSUSE Leap vers <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>. La procédure est similaire à la <xref linkend="sec-upgrade-online-yast"/>, mais nécessite quelques étapes supplémentaires. Avant d&apos;exécuter cette procédure sur un système de production, il est recommandé de l&apos;effectuer sur un système test répliquant votre configuration de production.
  </para>

  <para>
   Pour connaître les versions d&apos;openSUSE Leap prises en charge pour la migration, reportez-vous à la <xref linkend="sec-upgrade-paths-supported"/>.
  </para>

  <remark>cwickert 2012-02-25: For openSUSE Leap 15.3 and SLE 15 SP3, removing
   packages should not be necessary. Everything should be provided through
   Package Hub. For SP2 and earlier however, orphaned packages should be
   removed.</remark>

  <warning>
   <title>certains paquetages OpenSUSE ne peuvent pas être migrés</title>
   <para>
    openSUSE fournit plus de paquetages que <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>. La plupart des paquetages supplémentaires sont disponibles via SUSE Package Hub et seront migrés. Tout paquetage supplémentaire qui n&apos;est pas disponible via SUSE Package Hub ne recevra plus de mises à jour après la migration et doit donc être supprimés par la suite.
   </para>
   <para>
    Veillez à ce que tous les paquetages dont vous avez besoin pour votre système soient disponibles dans les dépôts <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> et SUSE Package Hub. Pour plus d&apos;informations sur SUSE Package Hub, reportez-vous à l&apos;adresse <link xlink:href="https://packagehub.suse.com/"/>.
   </para>
  </warning>

  <procedure xml:id="pro-upgrade-online-leap-to-sle">
   <title>Mise à niveau d&apos;openSUSE Leap vers <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase></title>
   <para>
    Pour migrer d&apos;openSUSE Leap vers <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>, procédez comme suit :
   </para>
   <step>
    <para>
     Basculez vers un TTY, par exemple en appuyant sur <keycombo><keycap function="control"/>
     <keycap function="alt"/><keycap>F1</keycap></keycombo>. Connectez-vous en tant qu&apos;utilisateur <systemitem class="username">root</systemitem>.
    </para>
   </step>
   <step>
    <para>
     Installez les paquetages <package>yast2-registration</package> et <package>rollback-helper</package> :
    </para>
<screen><prompt role="root"># </prompt><command>zypper in yast2-registration rollback-helper</command></screen>
   </step>
   
   <step>
    <para>
     Activez le service <systemitem class="service">rollback-helper</systemitem> :
    </para>
<screen><prompt role="root"># </prompt><command>systemctl enable rollback</command></screen>
   </step>
   <step>
    <para>
     Enregistrez le système auprès du SUSE Customer Center :
    </para>
<screen><prompt role="root"># </prompt><command>yast2 registration</command></screen>
   </step>
   <step>
    <para>
     Effectuez la migration :
    </para>
<screen><prompt role="root"># </prompt><command>yast2 migration</command></screen>
    <para>
     En cas de conflit de paquetages, YaST présente une liste de solutions parmi lesquelles choisir.
    </para>
   </step>
   <step>
    <para>
     Supprimez les paquetages orphelins :
    </para>
<screen><prompt role="root"># </prompt><command>zypper rm $(zypper --no-refresh packages --orphaned | gawk '{print $5}' | tail -n +5)</command></screen>
   </step>
   <step>
    <para>
     Redémarrez le système :
    </para>
<screen><prompt role="root"># </prompt><command>reboot</command></screen>
   </step>
  </procedure>

  <para>
   Vous avez migré votre système vers <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>.
  </para>

  <para>
   Si vous rencontrez un problème après la migration, vous pouvez annuler cette dernière de la même façon que pour une mise à niveau de Service Pack. Pour plus d&apos;instructions, reportez-vous à la <xref linkend="sec-upgrade-online-rollback"/>.
  </para>
 </sect1>
</chapter>
