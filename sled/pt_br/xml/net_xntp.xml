<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_xntp.xml" version="5.0" xml:id="cha.netz.xntp">



 <title>Sincronização de horário com NTP</title>
 <info>
  <abstract>
   <para>
    O mecanismo NTP (network time protocol) é um protocolo para sincronizar o horário do sistema na rede. Primeiro, uma máquina pode obter o horário de um servidor, que é uma fonte de horário confiável. Segundo, a máquina pode agir como uma fonte de horário para outros computadores na rede. O objetivo é duplo: manter o tempo absoluto e a sincronização do horário do sistema de todas as máquinas na rede.
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes (sim)</dm:translation>
  </dm:docmanager>
 </info>
 <para>
  Manter um horário exato do sistema é importante em várias situações. Geralmente, o relógio do hardware incorporado não atende aos requisitos dos aplicativos, como bancos de dados ou clusters. A correção manual do horário do sistema levaria a problemas severos pois, por exemplo, um pulo inverso pode causar o mau funcionamento de aplicativos críticos. Em uma rede, geralmente é necessário sincronizar o horário do sistema de todas as máquinas, porém, o ajuste manual do horário não é um bom método. O NTP dispõe de um mecanismo para resolver esses problemas. O serviço NTP ajusta continuamente o horário do sistema com servidores de horário confiáveis na rede. Ele habilita também o gerenciamento de relógios de referência local como relógios controlados pelo rádio.
 </para>
 <note os="sled;osuse">
  <para>
   Para habilitar a sincronização de horário por meio do diretório ativo, siga as instruções no <xref linkend="proc.ad.join"/>.
  </para>
 </note>
 <sect1 xml:id="sec.netz.xntp.yast">
  <title>Configurando um cliente NTP com YaST</title>

  <para>
   O daemon do NTP (<systemitem class="daemon">ntpd</systemitem>) que acompanha o pacote <systemitem>ntp</systemitem> vem predefinido para usar o relógio do computador como a referência de horário. Entretanto, o uso do relógio do hardware só serve como fallback nos casos em que não há uma fonte de horário mais precisa disponível. O YaST simplifica a configuração de um cliente NTP.
  </para>

  <sect2 xml:id="sec.net.ntp.yast.basic">
   <title>Configuração Básica</title>
   <para>
    A configuração do cliente NTP do YaST (<menuchoice><guimenu>Serviços de Rede</guimenu> <guimenu>Configuração NTP</guimenu></menuchoice>) é composta por guias. Defina o modo de iniciar do <systemitem class="daemon">ntpd</systemitem> e o servidor para consulta na guia <guimenu>Configurações Gerais</guimenu>.
   </para>
   <variablelist>
    <varlistentry>
     <term><guimenu>Apenas Manualmente</guimenu>
     </term>
     <listitem>
      <para>
       Selecione <guimenu>Apenas Manualmente</guimenu> para iniciar manualmente o daemon <systemitem class="daemon">ntpd</systemitem>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><guimenu>Sincronizar sem Daemon</guimenu>
     </term>
     <listitem>
      <para>
       Selecione <guimenu>Sincronizar sem Daemon</guimenu> para definir o horário do sistema periodicamente sem a execução permanente do <systemitem class="daemon">ntpd</systemitem>. Você pode definir o <guimenu>Intervalo da Sincronização em Minutos</guimenu>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><guimenu>Agora e ao Inicializar</guimenu>
     </term>
     <listitem>
      <para>
       Selecione <guimenu>Agora e ao Inicializar</guimenu> para iniciar o <systemitem class="daemon">ntpd</systemitem> automaticamente quando o sistema for inicializado. Essa configuração é recomendada.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>



  <sect2 xml:id="sec.net.ntp.yast.new_sync">
   <title>Mudando a configuração básica</title>
   <para>
    Os servidores e outras fontes de horário para a consulta do cliente estão listados na guia <guimenu>Configurações Gerais</guimenu>. Modifique esta lista conforme necessário com <guimenu>Adicionar</guimenu>, <guimenu>Editar</guimenu> e <guimenu>Apagar</guimenu>. <guimenu>Exibir Registro</guimenu> fornece a possibilidade de exibir os arquivos de registro do seu cliente.
   </para>
   <para>
    Clique em <guimenu>Adicionar</guimenu> para adicionar uma nova fonte de informação de horário. Na caixa de diálogo seguinte, selecione o tipo de fonte com a qual a sincronização de horário deve ser realizada. As seguintes opções estão disponíveis:
   </para>
   <figure xml:id="fig.yast.ntp.selserv">
    <title>YaST: servidor NTP</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata width="75%" fileref="yast_ntp_selserv.png" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata width="75%" fileref="yast_ntp_selserv.png" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <variablelist>
    <varlistentry>
     <term>Servidor</term>
     <listitem>
      <para>
       Na lista suspensa <guimenu>Selecionar</guimenu> (veja a <xref linkend="fig.yast.ntp.selserv"/>), determine se é para configurar a sincronização de horário usando um servidor de horário da rede local (<guimenu>Servidor NTP Local</guimenu>) ou um servidor de horário baseado na Internet que controla o seu fuso horário (<guimenu>Servidor NTP Público</guimenu>). Para um servidor de horário local, clique em <guimenu>Busca</guimenu> para iniciar uma consulta SLP por servidores de horário disponíveis na sua rede. Selecione o servidor de horário mais adequado a partir da lista de resultados de pesquisa e saia da caixa de diálogo com <guimenu>OK</guimenu>. Para um servidor de horário público, selecione o país (fuso horário) e um servidor adequado da lista sob <guimenu>Servidor NTP Público</guimenu>, em seguida, saia da caixa de diálogo com <guimenu>OK</guimenu>. Na caixa de diálogo principal, teste a disponibilidade do servidor selecionado com <guimenu>Testar</guimenu>. <guimenu>Opções</guimenu> permite que você especifique opções adicionais para o <systemitem class="daemon">ntpd</systemitem>.
      </para>
      <para>
       Com o uso de <guimenu>Opções de Controle de Acesso</guimenu>, você pode restringir as ações que o computador remoto pode desempenhar com o daemon em execução no seu computador. Esse campo apenas será habilitado após marcar <guimenu>Restringir Serviço NTP Apenas aos Servidores Configurados</guimenu> na guia <guimenu>Configurações de Segurança</guimenu> (veja a <xref linkend="fig.yast.ntp.adv.sec"/>). As opções correspondem às cláusulas <literal>restrict</literal> em <filename>/etc/ntp.conf</filename>. Por exemplo, <literal>nomodify notrap noquery</literal> não permite que o servidor modifique as configurações de NTP do seu computador e use o recurso de detecção (um recurso de registro de eventos remotos) do seu daemon NTP. O uso dessas restrições é recomendado para os servidores fora de controle (por exemplo, na Internet).
      </para>
      <para>
       Consulte <filename>/usr/share/doc/packages/ntp-doc</filename> (parte do pacote <systemitem>ntp-doc</systemitem>) para obter informações detalhadas.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Peer</term>
     <listitem>
      <para>
       Um peer é uma máquina com a qual é estabelecido um relacionamento simétrico: ele atua como servidor de horário e como cliente. Para usar um peer na mesma rede em vez de um servidor, digite o endereço do sistema. O restante da caixa de diálogo é igual à caixa de diálogo <guimenu>Servidor</guimenu>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Relógio controlado pelo rádio</term>
     <listitem>
      <para>
       Para usar um relógio controlado pelo rádio no seu sistema para a sincronização de horário, insira o tipo de relógio, o número da unidade, o nome do dispositivo e outras opções nesta caixa de diálogo. Clique em <guimenu>Calibração do Driver</guimenu> para ajustar o driver. Informações detalhadas sobre a operação de um rádio relógio local estão disponíveis em <filename>/usr/share/doc/packages/ntp-doc/html/refclock.htm</filename>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Transmissão de saída</term>
     <listitem>
      <para>
       Consultas e informações sobre horário também podem ser transmitidas na rede. Nesta caixa de diálogo, insira o endereço ao qual estas transmissões devem ser enviadas. Não ative a transmissão a menos que você tenha uma fonte de horário confiável como um relógio controlado por rádio.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Transmissão de entrada</term>
     <listitem>
      <para>
       Se você deseja que o seu cliente receba suas informações através de transmissão, insira o endereço do qual os respectivos pacotes devem ser aceitos nestes campos.

      </para>
     </listitem>
    </varlistentry>
   </variablelist>



   <figure xml:id="fig.yast.ntp.adv.sec">
    <title>Configuração NTP Avançada: Configurações de Segurança</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata width="75%" fileref="yast2_xntp_adv_sec.png" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata width="75%" fileref="yast2_xntp_adv_sec.png" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    Na guia <guimenu>Configurações de Segurança</guimenu> (veja a <xref linkend="fig.yast.ntp.adv.sec"/>), determine se o <systemitem class="daemon">ntpd</systemitem> deve ser iniciado em um chroot jail. Por padrão, a opção <guimenu>Executar Daemon NTP em Chroot Jail</guimenu> não está ativada. A opção chroot jail aumenta a segurança em caso de ataque por <systemitem class="daemon">ntpd</systemitem>, já que impede o invasor de comprometer todo o sistema.
   </para>
   <para>
    <guimenu>Restringir Serviço NTP Apenas aos Servidores Configurados</guimenu> aumenta a segurança do seu sistema ao não permitir que os computadores remotos vejam e modifiquem as configurações de NTP do seu computador e que usem o recurso de detecção para o registro de eventos remotos. Depois de habilitadas, as restrições serão aplicadas a todos os computadores remotos, exceto se você anular as opções de controle de acesso para computadores individuais na lista de fontes de horário na guia <guimenu>Configurações Gerais</guimenu>. Para todos os outros computadores remotos, só é permitida a consulta de horário local.
   </para>
   <para>
    Habilite <guimenu>Abrir Porta no Firewall</guimenu> se o SuSEFirewall2 estiver ativo (que é o padrão). Se você manter a porta fechada, não será possível estabelecer uma conexão com o servidor de horário.
   </para>
  </sect2>
 </sect1>



 <sect1 xml:id="sec.netz.xntp.netconf">
  <title>Configurando manualmente o NTP na rede</title>

  <para>

   A forma mais fácil de usar um servidor de horário na rede é definir parâmetros de servidor. Por exemplo, se um servidor de horário denominado <systemitem>ntp.exemplo.com</systemitem> estiver acessível na rede, adicione seu nome ao arquivo <filename>/etc/ntp.conf</filename> incluindo a seguinte linha:
  </para>

<screen>server ntp.example.com</screen>

  <para>
   Para adicionar mais servidores de horário, insira linhas adicionais com a palavra-chave <literal>server</literal>. Após a inicialização do <systemitem class="daemon">ntpd</systemitem> com o comando <command>systemctl start ntp</command>, levará cerca de uma hora para estabilizar o horário e criar o arquivo drift que corrige o relógio do computador local. Com o arquivo DRIFT, o erro sistemático do relógio do hardware pode ser registrado quando o computador é ligado. A correção é usada imediatamente, resultando em uma estabilidade maior do horário do sistema.
  </para>

  <para>
   Há duas maneiras possíveis de usar o mecanismo NTP como cliente: primeiro, o cliente pode consultar o horário a partir de um servidor conhecido em intervalos regulares. Com vários clientes, esta abordagem pode causar uma carga alta no servidor. Segundo, o cliente pode esperar por transmissões de NTP enviadas por servidores de horário de transmissão na rede. Esta abordagem tem a desvantagem de que a qualidade do servidor é desconhecida e um servidor transmitindo a informação errada pode causar problemas graves.
  </para>

  <para>
   Se o horário for obtido através de uma transmissão, você não precisará do nome do servidor. Neste caso, insira a linha <literal>broadcastclient</literal> no arquivo de configuração <filename>/etc/ntp.conf</filename>. Para usar um ou mais servidores de horário conhecidos exclusivamente, insira seus nomes na linha iniciando com <literal>servers</literal>.
  </para>


 </sect1>



 <sect1 xml:id="sec.netz.xntp.dynamic">
  <title>Sincronização de horário dinâmica em tempo de execução</title>



  <para>
   Se o sistema for inicializado sem conexão de rede, o <systemitem class="daemon">ntpd</systemitem> será iniciado, mas não conseguirá resolver os nomes DNS dos servidores de horário definidos no arquivo de configuração. Isso poderá acontecer se você usar o NetworkManager com Wi-Fi criptografado.
  </para>

  <para>
   Para que o <systemitem class="daemon">ntpd</systemitem> resolva os nomes DNS em tempo de execução, defina a opção <systemitem>dynamic</systemitem>. Em seguida, quando a rede é estabelecida algum tempo após a inicialização, o <systemitem class="daemon">ntpd</systemitem> procura os nomes novamente e acessa os servidores de horário para capturar a hora.
  </para>

  <para>
   Edite manualmente o <filename>/etc/ntp.conf</filename> e adicione <systemitem>dynamic</systemitem> a uma ou mais entradas <systemitem>server</systemitem>:
  </para>

<screen>server ntp.example.com dynamic</screen>

  <para>
   Se preferir, use o YaST e faça o seguinte:
  </para>

  <procedure>
   <step>
    <para>
     No YaST, clique em <menuchoice> <guimenu>Serviços de Rede</guimenu> <guimenu>Configuração NTP</guimenu> </menuchoice>.
    </para>
   </step>
   <step>
    <para>
     Selecione o servidor que deseja configurar. Em seguida, clique em <guimenu>Editar</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Ative o campo <guimenu>Opções</guimenu> e adicione <literal>dynamic</literal>. Separe-o por um espaço, se já houver outras opções digitadas.
    </para>
   </step>
   <step>
    <para>
     Clique em <guimenu>OK</guimenu> para fechar a caixa de diálogo de edição. Repita a etapa anterior para mudar todos os servidores conforme desejado.
    </para>
   </step>
   <step>
    <para>
     Por fim, clique em <guimenu>OK</guimenu> para gravar as configurações.
    </para>
   </step>
  </procedure>
 </sect1>



 <sect1 xml:id="sec.netz.xntp.normal">
  <title>Configurando um relógio de referência local</title>

  <para>
   O pacote de software <systemitem class="daemon">ntpd</systemitem> inclui drivers para conexão de relógios locais de referência. Uma lista de relógios suportados está disponível no pacote <systemitem class="resource">ntp-doc</systemitem> no arquivo <filename>/usr/share/doc/packages/ntp-doc/html/refclock.htm</filename>. Cada driver está associado a um número. No NTP, a configuração real é feita por pseudos endereços IP. Os relógios são inseridos no arquivo <filename>/etc/ntp.conf</filename> como se existissem na rede. Para este propósito, endereços IP especiais são atribuídos a eles no formato <literal>127.127.<replaceable>t</replaceable>.<replaceable>u</replaceable></literal>. Aqui, <replaceable>t</replaceable> representa o tipo de relógio e determina o driver a ser usado e <replaceable>u</replaceable> representa a unidade, que determina a interface usada.

  </para>

  <para>
   Normalmente, os drivers individuais têm parâmetros especiais que descrevem detalhes de configuração. O arquivo <filename>/usr/share/doc/packages/ntp-doc/drivers/driver<replaceable>NN</replaceable>.html</filename> (onde <replaceable>NN</replaceable> é o número do driver) fornece informações sobre o tipo específico de relógio. Por exemplo, o relógio <quote>type 8</quote> (relógio controlado por rádio na interface serial) exige um modo adicional que especifica o relógio de forma mais precisa. O módulo de recebimento Conrad DCF77, por exemplo, tem o modo 5. Para usar este relógio como referência preferida, especifique a palavra-chave <literal>prefer</literal>. A linha do <literal>servidor</literal> completa para um módulo de recebimento Conrad DCF77 seria:
  </para>

<screen>server 127.127.8.0 mode 5 prefer</screen>

  <para>
   Outros relógios seguem o mesmo padrão. Após a instalação do pacote <systemitem class="resource">ntp-doc</systemitem>, a documentação do NTP fica disponível no diretório <filename>/usr/share/doc/packages/ntp-doc</filename>. O arquivo <filename>/usr/share/doc/packages/ntp-doc/refclock.html</filename> fornece links para as páginas que descrevem os parâmetros do driver.
  </para>
 </sect1>
 <sect1 xml:id="sec.netz.xntp.etr" arch="zseries">
  <title>Sincronização do relógio com uma ETR (External Time Reference – Referência de Horário Externa)</title>



  <para>
   O suporte para sincronização do relógio com uma referência de horário externa (ETR) está disponível. A referência de horário externa envia um sinal do oscilador e um sinal de sincronização a cada 2**20 (2 elevado à potência de 20) microssegundos para manter sincronizados os relógios TOD de todos os servidores conectados.
  </para>

  <para>
   Para disponibilidade, é possível conectar duas unidades ETR a uma máquina. Se a diferença do relógio for maior do que a tolerância da verificação de sincronização, todas as CPUs terão suas máquinas marcadas indicando que o relógio está fora de sincronia. Se isso acontecer, todos os dispositivos DASD de E/S habilitados para XRC serão parados até o relógio ser novamente sincronizado.
  </para>

  <para>
   O suporte a ETR é ativado por meio de dois atributos <literal>sysfs</literal>. Execute os seguintes comandos como <systemitem class="username">root</systemitem>:
  </para>

<screen>echo 1 &gt; /sys/devices/system/etr/etr0/online
echo 1 &gt; /sys/devices/system/etr/etr1/online
</screen>
 </sect1>
</chapter>
