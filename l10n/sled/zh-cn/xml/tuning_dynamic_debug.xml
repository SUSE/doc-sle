<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="tuning_dynamic_debug.xml" version="5.0" xml:id="cha-tuning-dynamic-debug">
  <title>动态调试 - 内核调试消息</title>
  <info>
    <abstract>
      <para>
        动态调试是 Linux 内核中的一项强大的调试功能，它允许您在运行时启用和禁用调试消息，而无需重新编译内核或重引导系统。
      </para>
    </abstract>
    <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
      <dm:bugtracker/>
      <dm:translation>yes</dm:translation>
    </dm:docmanager>
  </info>
  <para>
    您可以在以下几种情况下使用动态调试，例如：
  </para>
  <itemizedlist>
    <listitem>
      <para>
        内核问题查错
      </para>
    </listitem>
    <listitem>
      <para>
        为新硬件开发驱动程序
      </para>
    </listitem>
    <listitem>
      <para>
        跟踪和审计安全事件
      </para>
    </listitem>
  </itemizedlist>
  <sect1 xml:id="sec-tuning-dynamic-debug-benefits">
    <title>动态调试的优势</title>

    <para>
      下面列出了动态调试的某些优势：
    </para>

    <variablelist>
      <varlistentry>
        <term>实时调试</term>
        <listitem>
          <para>
            动态调试支持在不重引导系统的情况下调试消息。这种实时功能对于诊断生产环境中的问题至关重要。
          </para>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>选择性调试</term>
        <listitem>
          <para>
            您可以为内核的特定部分甚至单个模块启用调试消息，从而将重点放在相关信息上。
          </para>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>性能微调</term>
        <listitem>
          <para>
            使用动态调试来监控和优化内核性能，只需根据当前的分析要求选择性地启用或禁用调试消息。
          </para>
        </listitem>
      </varlistentry>
    </variablelist>
  </sect1>
  <sect1 xml:id="sec-tuning-dynamic-debug-check">
    <title>检查动态调试的状态</title>

    <para>
      默认安装的受支持内核版本已内置动态调试。要检查动态调试的状态，请以 root 用户身份运行以下命令：
    </para>

<screen><prompt role="root"># </prompt><command>zcat /proc/config.gz | grep CONFIG_DYNAMIC_DEBUG</command></screen>

    <para>
      如果动态调试已编译到内核中，您应该看到类似于以下内容的输出：
    </para>

<screen>
CONFIG_DYNAMIC_DEBUG=y
CONFIG_DYNAMIC_DEBUG_CORE=y
</screen>
  </sect1>
  <sect1 xml:id="sec-tuning-dynamic-debug-use">
    <title>使用动态调试</title>

    <para>
      要在正在运行的内核中启用特定的调试消息或日志，您可以使用 <command>echo</command> 命令向 <filename>/sys/kernel/debug/dynamic_debug/control</filename> 文件写入数据。
    </para>

    <para>
      以下示例说明了动态调试的一些简单用法：
    </para>

    <note>
      <para>
        动态调试依赖于内核代码中所嵌入的特定调试宏，例如 <systemitem>pr_debug</systemitem>。内核开发人员使用这些宏将调试消息插入到代码中。
      </para>
      <para>
        本节中的示例假设 <systemitem>pr_debug</systemitem> 宏正常工作，因为允许对正在运行的内核进行动态调试。
      </para>
    </note>

    <variablelist>
      <varlistentry>
        <term>为特定内核源代码文件启用调试消息</term>
        <listitem>
          <para>
            要为特定内核源代码文件启用调试消息，请使用以下示例：
          </para>
<screen><prompt role="root"># </prompt><command>echo "file <replaceable>FILE_NAME.c</replaceable> +p" &gt; /sys/kernel/debug/dynamic_debug/control</command></screen>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>为特定内核模块启用调试消息</term>
        <listitem>
          <para>
            要为特定内核模块启用调试消息，请使用以下示例：
          </para>
<screen><prompt role="root"># </prompt><command>echo "module <replaceable>MODULE_NAME</replaceable> +p" &gt; /sys/kernel/debug/dynamic_debug/control</command></screen>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>禁用调试消息</term>
        <listitem>
          <para>
            要禁用以前为特定内核源代码文件或内核模块启用的调试消息，请运行带有 <command>-p</command> 选项的 <command>echo</command> 命令。例如：
          </para>
<screen><prompt role="root"># </prompt><command>echo "file <replaceable>FILE_NAME.c</replaceable> -p" &gt; /sys/kernel/debug/dynamic_debug/control</command></screen>
<screen><prompt role="root"># </prompt><command>echo "module <replaceable>MODULE_NAME</replaceable> -p" &gt; /sys/kernel/debug/dynamic_debug/control</command></screen>
        </listitem>
      </varlistentry>
    </variablelist>

    <para>
      有关动态调试及其用例的详细信息，请参见其<link xlink:href="https://www.kernel.org/doc/html/latest/admin-guide/dynamic-debug-howto.html">official
      documentation</link>。
    </para>
  </sect1>
  <sect1 xml:id="sec-tuning-dynamic-debug-view">
    <title>查看动态调试消息</title>

    <para>
      您可以运行 <command>dmesg</command> 并通过 <command>grep</command> 过滤输出，来查看根据启用的配置生成的动态调试消息。例如：
    </para>

<screen><prompt role="root"># </prompt><command>dmesg | grep -i "<replaceable>FILE_NAME.c</replaceable>"</command></screen>

    <para>
      或者，要在系统消息生成时持续监控系统消息，可以使用带有 <command>-f</command> 选项的 <command>tail</command> 命令：
    </para>

<screen><prompt role="root"># </prompt><command>tail -f /var/log/messages</command></screen>
  </sect1>
</chapter>
