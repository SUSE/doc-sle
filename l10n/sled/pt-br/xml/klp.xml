<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="klp.xml" version="5.0" xml:id="cha-klp" xml:lang="pt-br">
 <title>Kernel Live Patching com KLP</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    Este documento descreve os princípios básicos da tecnologia Kernel Live Patching (KLP) e apresenta as diretrizes de uso para o serviço SLE Live Patching.
   </para>
  </abstract>
 </info>
 <para>
  O KLP possibilita a aplicação das atualizações de segurança mais recentes aos kernels do Linux sem reinicialização. Esse procedimento maximiza o tempo de atividade e a disponibilidade do sistema, que são essenciais para sistemas de extrema importância.
 </para>
 <para>
  As informações contidas neste documento são relacionadas às arquiteturas AMD64/Intel 64, POWER e IBM Z.
 </para>
 <sect1 xml:id="sec-klp-advantages">
  <title>Vantagens do Kernel Live Patching</title>

  <para>
   O KLP oferece vários benefícios.
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Manter um grande número de servidores automaticamente atualizados é essencial para que as organizações obtenham ou mantenham determinadas certificações de conformidade. O KLP pode ajudar a atingir a conformidade e reduzir a necessidade de janelas de manutenção dispendiosas.
    </para>
   </listitem>
   <listitem>
    <para>
     As empresas que trabalham com contratos de nível de serviço devem garantir um nível específico de acessibilidade e tempo de atividade do sistema. O Live Patching possibilita a aplicação de patches aos sistemas sem causar tempo de espera.
    </para>
   </listitem>
   <listitem>
    <para>
     Como o KLP faz parte do mecanismo de atualização do sistema padrão, não há necessidade de treinamento especializado nem de introdução de rotinas de manutenção complicadas.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec-klp-overview">
  <title>Visão geral do Kernel Live Patching</title>

  <para>
   Os patches ativos do kernel são oferecidos como pacotes com código modificado, separados do pacote do kernel principal. Os patches ativos são cumulativos, portanto, o patch mais recente contém todas as correções dos anteriores no pacote do kernel. Cada pacote ativo do kernel está vinculado à revisão exata do kernel para a qual ele foi gerado. O número da versão do pacote ativo do kernel aumenta a cada adição de correções.
  </para>

  <important>
   <title>Patches ativos comparados com as atualizações do kernel</title>
   <para>
    Os patches ativos contêm apenas as correções críticas e não substituem as atualizações regulares do kernel que exigem reinicialização. Considere os patches ativos como medidas temporárias que protegem o kernel até que uma atualização apropriada e uma reinicialização do kernel sejam executadas.
   </para>
  </important>

  <para>
   O diagrama abaixo ilustra o relacionamento geral entre os patches ativos e as atualizações do kernel. É possível ver a lista de CVEs e os relatórios de defeitos resolvidos pelo patch ativo atual usando o comando <command>klp -v patches</command>.
  </para>

  <informalfigure>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="klp.png" width="80%"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="klp.png" width="100%"/>
    </imageobject>
   </mediaobject>
  </informalfigure>

  <para>
   É possível ter várias versões do pacote do kernel instaladas junto com os patches ativos. Esses pacotes não entram em conflito. Você pode instalar os pacotes do kernel atualizados junto com os patches ativos do kernel em execução. Nesse caso, talvez seja solicitado para você reinicializar o sistema. Os usuários com assinaturas do SLE Live Patching estão qualificados para suporte técnico, desde que haja atualizações de patch ativas para o kernel em execução (consulte a <xref linkend="sec-klp-lifecycle"/>).
  </para>

  <para>
   Com o KLP ativado, todas as atualizações de kernel vêm com um pacote de patch ativo. Esse patch ativo não contém nenhuma correção e funciona como uma propagação para patches ativos futuros do kernel correspondente. Esses patches de propagação vazios são chamados de <literal>patches iniciais</literal>.
  </para>

  <sect2 xml:id="sec-klp-scope">
   <title>Escopo do Kernel Live Patching</title>
   <para>
    O escopo do SLE Live Patching inclui correções de vulnerabilidades de nível 7 ou superior do SUSE Common Vulnerability Scoring System (CVSS: o SUSE CVSS é baseado no sistema CVSS v3.0) e correções de bugs relacionadas à estabilidade do sistema ou corrupção de dados. No entanto, talvez não seja tecnicamente viável criar patches ativos para todas as correções que se enquadram nas categorias especificadas. Portanto, a SUSE reserva o direito de ignorar as correções em situações em que a criação de um patch ativo do kernel não seja possível por motivos técnicos. Atualmente, mais de 95% das correções qualificadas são lançadas como patches ativos. Para obter mais informações sobre o CVSS (a base para a classificação SUSE CVSS), consulte <link xlink:href="https://www.first.org/cvss/">Common Vulnerability Scoring System SIG</link>.
   </para>
  </sect2>

  <sect2 xml:id="sec-klp-limitations">
   <title>Limitações do Kernel Live Patching</title>
   <para>
    O KLP envolve a substituição de funções e o tratamento adequado da substituição de conjuntos de funções interdependentes. Isso é feito redirecionando as chamadas do código antigo para o código atualizado em um local de memória diferente. As mudanças nas estruturas de dados tornam a situação mais complicada, pois os dados permanecem no local e não podem ser estendidos ou reinterpretados. Existem técnicas que permitem a alteração indireta das estruturas de dados, mas algumas correções não podem ser convertidas em patches ativos. Nessa situação, a reinicialização do sistema é a única maneira de aplicar as correções.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-klp-enable-with-yast2">
  <title>Ativando o Kernel Live Patching por meio do YaST</title>

  <para>
   Para ativar o KLP no sistema, você precisa ter assinaturas ativas do SLES e do SLE Live Patching. Visite o <link xlink:href="https://scc.suse.com/">SUSE Customer Center</link> para verificar o status das suas assinaturas e obter um código de registro para a assinatura do SLE Live Patching.
  </para>

  <para>
   Para ativar o Kernel Live Patching no sistema, siga estas etapas:
  </para>

  <procedure>
   <step>
    <para>
     Execute o comando <command>yast2 registration</command> e clique em <guimenu>Selecionar Extensões</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Selecione <guimenu>SUSE Linux Enterprise Live Patching 15</guimenu> na lista de extensões disponíveis e clique em <guimenu>Próximo</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Confirme os termos da licença e clique em <guimenu>Próximo</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Digite o código de registro do SLE Live Patching e clique em <guimenu>Próximo</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Confira o <guimenu>Resumo da Instalação</guimenu> e os <guimenu>Padrões</guimenu> selecionados. Os padrões <systemitem>Live
     Patching</systemitem> e <systemitem>SLE Live Patching Lifecycle
     Data</systemitem> devem estar automaticamente selecionados para instalação junto com outros pacotes para atender às dependências.
    </para>
   </step>
   <step>
    <para>
     Clique em <guimenu>Aceitar</guimenu> para concluir a instalação. Isso instalará os componentes base do Kernel Live Patching no sistema, o patch ativo inicial e as dependências necessárias.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-klp-enable-cli">
  <title>Ativando o Kernel Live Patching pela linha de comando</title>

  <para>
   Para ativar o Kernel Live Patching, você precisa ter assinaturas ativas do SLES e do SLES Live Patching. Visite o <link xlink:href="https://scc.suse.com/">SUSE Customer Center</link> para verificar o status das suas assinaturas e obter um código de registro para a assinatura do SLES Live Patching.
  </para>

  <procedure>
   <step>
    <para>
     Execute <command>sudo SUSEConnect --list-extensions</command>. Observe o comando de ativação exato do SLES Live Patching. Exemplo de saída de comando (abreviado):
    </para>
<screen>$ SUSEConnect --list-extensions
...
SUSE Linux Enterprise Live Patching <phrase role="productnumber"><phrase os="sles;sled">15 SP4</phrase></phrase> x86_64
Activate with: SUSEConnect -p sle-module-live-patching/15.4/x86_64 \
  -r ADDITIONAL REGCODE</screen>
   </step>
   <step>
    <para>
     Ative o SLES Live Patching usando o comando obtido seguido de <option>-r <replaceable>LIVE_PATCHING_REGISTRATION_CODE</replaceable></option>, por exemplo:
    </para>
<screen>SUSEConnect -p sle-module-live-patching/15.4/x86_64 \
  -r <replaceable>LIVE_PATCHING_REGISTRATION_CODE</replaceable></screen>
   </step>
   <step>
    <para>
     Instalar os pacotes e as dependências necessários usando o comando <command>zypper install &#x2011;t pattern lp_sles</command>
    </para>
   </step>
  </procedure>

  <para>
   Neste ponto, o patch ativo já foi aplicado ao sistema.
  </para>

  <para>
   Veja como o processo é realizado: Quando o sistema de instalação de pacotes detecta que há um kernel instalado ao qual pode ser aplicado um patch ativo e que existe um patch ativo para ele no canal de software, o sistema seleciona o patch ativo para instalação. Em seguida, o kernel recebe as correções de patch ativo <emphasis>como parte da instalação do pacote</emphasis>. O kernel recebe o patch ativo mesmo antes da conclusão da instalação do produto.
  </para>
 </sect1>
 <sect1 xml:id="sec-klp-perform">
  <title>Executando o Kernel Live Patching</title>

  <para>
   Os patches ativos do kernel são instalados como parte das atualizações regulares do sistema. No entanto, há várias informações que você deve saber.
  </para>

  <itemizedlist>
   <listitem>
    <para>
     O kernel recebe patches ativos se um pacote <package>kernel-livepatch-*</package> foi instalado para o kernel em execução. Você pode usar o comando <command>zypper se --details kernel-livepatch-*</command> para verificar se os pacotes de patch ativo do kernel estão instalados no seu sistema.
    </para>
   </listitem>
   <listitem>
    <para>
     Quando o pacote <package>kernel-default</package> está instalado, o gerenciador de atualizações solicita para você reinicializar o sistema. Para evitar que essa mensagem apareça, você pode remover essas atualizações do kernel da operação de aplicação de patches. Para fazer isso, você pode adicionar bloqueios de pacote com o Zypper. O SUSE Manager também possibilita filtrar o conteúdo do canal (consulte <link xlink:href="https://documentation.suse.com/external-tree/en-us/suma/4.1/suse-manager/administration/live-patching.html">Live Patching with SUSE Manager</link>).
    </para>
   </listitem>
   <listitem>
    <para>
     Você pode verificar o status da aplicação de patches usando o comando <command>klp status</command>. Para examinar os patches instalados, execute o comando <command>klp -v patches</command>.
    </para>
   </listitem>
   <listitem>
    <para>
     Mesmo que haja vários pacotes de kernel instalados no sistema, lembre-se de que apenas um deles estará em execução em um determinado momento. Da mesma forma, pode haver vários pacotes de patches ativos instalados, mas apenas um patch ativo será carregado no kernel.
    </para>
   </listitem>
   <listitem>
    <para>
     O patch ativo está incluído no <literal>initrd</literal>. Isso significa que, no caso de uma reinicialização inesperada, o sistema já vem com as correções de patch ativo aplicadas, portanto, não há necessidade de executar a aplicação de patches novamente.
    </para>
   </listitem>
  </itemizedlist>

  <sect2 xml:id="sec-klp-lifecycle">
   <title>Verificando a data de vencimento do patch ativo</title>
   <para>
    Verifique se o <package>lifecycle-data-sle-module-live-patching</package> está instalado e execute o comando <command>zypper lifecycle</command>. Você deve ver as datas de vencimento dos patches ativos na seção <literal>Package end of support if different from product</literal> (Fim do suporte do pacote se diferente do produto) da saída.
   </para>
   <para>
    Cada patch ativo recebe atualizações por um ano a partir do lançamento do pacote de kernel subjacente. A página <link xlink:href="https://www.suse.com/products/live-patching/current-patches/">Maintained kernels, patch updates and lifecycle</link> (Kernels mantidos, atualizações de patch e ciclo de vida) permite verificar as datas de vencimento com base na versão do kernel em execução sem instalar a extensão do produto.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-klp-troubleshoot">
  <title>Solucionando problemas do Kernel Live Patching</title>

  <sect2 xml:id="sec-klp-man-patch-downgrade">
   <title>Downgrade manual do patch</title>
   <para>
    Se o patch ativo mais recente for problemático, você poderá fazer downgrade do patch ativo instalado no momento para a versão anterior. Recomendamos fazer o downgrade do patch antes que o sistema comece a apresentar problemas. Lembre-se de que um sistema com avisos de kernel ou rastreamentos de erro de kernel no registro do sistema pode não ser adequado para o procedimento de downgrade de patch. Se você não tiver certeza se o sistema atende aos requisitos para um downgrade de patch, contate o Suporte Técnico da SUSE para obter ajuda.
   </para>
   <procedure>
    <title>Downgrade manual do patch</title>
    <step>
     <para>
      Identifique o patch ativo em execução usando o comando <command>klp -v patches</command>. Você pode ver o patch que está em execução na linha que começa com <literal>RPM:</literal>. Por exemplo:
     </para>
<screen>RPM: kernel-livepatch-5_3_18-24_29-default-2-2.1.x86_64</screen>
     <para>
      O <literal>5_3_18-24_29-default</literal> no exemplo acima indica a versão exata do kernel em execução.
     </para>
    </step>
    <step>
     <para>
      Use o comando <command>zypper search -s kernel-livepatch-<replaceable>VERSÃO_DO_KERNEL_EM_EXECUÇÃO</replaceable>-default</command> para pesquisar versões anteriores do patch. O comando retorna uma lista de versões de pacote disponíveis. Para cada novo lançamento de pacote de patch ativo, lembre-se de que o número da versão aumenta em um. Escolha a versão com um número abaixo da versão atual.
     </para>
    </step>
    <step>
     <para>
      Instale a versão desejada com o comando <command>zypper in --oldpackage kernel-livepatch-<replaceable>VERSÃO_DO_KERNEL_EM_EXECUÇÃO</replaceable>-default=<replaceable>VERSÃO_DESEJADA</replaceable></command>.
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
</chapter>
