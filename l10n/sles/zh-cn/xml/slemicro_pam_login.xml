<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="slemicro_pam_login.xml" version="5.0" xml:id="sec-pam-login">
 <title>配置本地登录所需的 U2F 密钥</title>
 
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>

 <para>
  为了在本地登录期间提供更高的安全性，您可以使用 <literal>pam-u2f</literal> 框架以及 YubiKey 和安全密钥的 U2F 功能配置双重身份验证。
 </para>

 <para>
  要在您的系统上设置 U2F，您需要将密钥与您的帐户相关联。之后，将系统配置为使用该密钥。以下部分说明了此过程。
 </para>

 <sect2 xml:id="sec-attach-account">
  <title>将 U2F 密钥与您的帐户关联</title>
  <para>
   要将 U2F 密钥与您的帐户关联，请按以下步骤操作：
  </para>
  <procedure>
   <step>
    <para>
     登录计算机。
    </para>
   </step>
   <step>
    <para>
     插入 U2F 密钥。
    </para>
   </step>
   <step>
    <para>
     创建用于存储 U2F 密钥配置的目录：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> mkdir -p ~/.config/Yubico</screen>
   </step>
   <step>
    <para>
     运行可输出配置行的 <command>pamu2fcfg</command> 命令：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> pamu2fcfg &gt; ~/.config/Yubico/u2f_keys</screen>
   </step>
   <step>
    <para>
     当设备开始闪烁时，触摸金属触点以确认关联。
    </para>
   </step>
  </procedure>
  <para>
   建议使用备份 U2F 设备，可以通过运行以下命令来设置：
  </para>
  <procedure>
   <step>
    <para>
     运行：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> pamu2fcfg -n &gt;&gt; ~/.config/Yubico/u2f_keys</screen>
   </step>
   <step>
    <para>
     当设备开始闪烁时，触摸金属触点以确认关联。
    </para>
   </step>
  </procedure>
  <para>
   为了提高安全性，可以将输出文件从默认位置移到需要 <literal>sudo</literal> 权限才能修改文件的目录。例如，将其移到 <filename>/etc</filename> 目录中。为此，请执行以下步骤：
  </para>
  <procedure>
   <step>
    <para>
     在 <filename>/etc</filename> 中创建一个目录：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> mkdir /etc/Yubico</screen>
   </step>
   <step>
    <para>
     移动创建的文件：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> mv ~/.config/Yubico/u2f_keys /etc/Yubico/u2f_keys</screen>
   </step>
  </procedure>
  <note>
   <title>将 <filename>u2f_keys</filename> 放到非默认位置</title>
   <para>
    如果将输出文件移到默认目录 (<filename>$HOME/.config/Yubico/u2f_keys</filename>) 以外的目录，则需要在 <filename>/etc/pam.d/login</filename> 文件中添加相应路径（如<xref linkend="sec-reconfiguring-pam"/>所述）。
   </para>
  </note>
 </sect2>

 <sect2 xml:id="sec-reconfiguring-pam">
  <title>更新 PAM 配置</title>
  <para>
   创建 U2F 密钥配置后，需要调整系统上的 PAM 配置。
  </para>
  <procedure>
   <step>
    <para>
     打开 <filename>/etc/pam.d/login</filename> 文件。
    </para>
   </step>
   <step>
    <para>
     将 <literal>auth required pam_u2f.so</literal> 一行添加到文件中，如下所示：
    </para>
<screen>
#%PAM-1.0
auth      include    common-auth
<emphasis role="bold">auth      required   pam_u2f.so</emphasis>
account   include    common-account
password  include    common-password
session   optional   pam_keyinit.so revoke
session   include    common-session
#session  optional   pam_xauth.so
        </screen>
   </step>
   <step>
    <para>
     如果将 <filename>u2f_keys</filename> 文件放到 <filename>$HOME/.config/Yubico/u2f_keys</filename> 以外的其他位置，则需要在 <filename>/etc/pam.d/login</filename> PAM 文件中使用 <literal>authfile</literal> 选项，如下所示：
    </para>
<screen>
#%PAM-1.0
auth     requisite pam_nologin.so
auth     include   common-auth
<emphasis role="bold">auth  required pam_u2f.so authfile=<replaceable>&lt;PATH_TO_u2f_keys&gt;</replaceable></emphasis>
...
        </screen>
    <para>
     其中 <replaceable>&lt;PATH_TO_u2f_keys&gt;</replaceable> 是 <filename>u2f_keys</filename> 文件的绝对路径。
    </para>
   </step>
  </procedure>
 </sect2>
</sect1>
