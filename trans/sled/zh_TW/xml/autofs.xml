<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xml:base="autofs.xml" id="cha.autofs">
 <title>使用 Autofs 按需掛接</title><indexterm> <primary>AutoFS</primary></indexterm>
 <abstract>
  <para>
   <systemitem>autofs</systemitem> 是一個程式，可以根據需要掛接指定的目錄。它以核心模組為基礎，效率很高，並且可以管理本地目錄和網路共用。這些自動掛接點僅在存取時掛接，一段時間不使用後即會卸載。這種按需行為可節省頻寬，在效能上優於 <filename>/etc/fstab</filename> 管理的靜態掛接。雖然 <systemitem>autofs</systemitem> 是一個控制程序檔，但是 <command>automount</command> 才是執行實際自動掛接的指令 (精靈)。
  </para>
 </abstract>
 <sect1 id="sec.autofs.installation">
  <title>安裝</title>

  <para>
   <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 上預設未安裝 <systemitem>autofs</systemitem>。若要使用它的自動掛接功能，請先使用以下指令進行安裝
  </para>

<screen>sudo zypper install autofs</screen>
 </sect1>
 <sect1 id="sec.autofs.configuration">
  <title>組態</title>

  <para>
   您需要使用 <command>vim</command> 之類的文字編輯器編輯 <systemitem>autofs</systemitem> 的組態檔案，來手動設定該工具。設定 <systemitem>autofs</systemitem> 有兩個基本步驟 — <emphasis>master</emphasis> 映射檔案與特定映射檔案。
  </para>

  <sect2 id="sec.autofs.configuration.master_map">
   <title>Master 映射檔案</title>
   <para>
    <systemitem>autofs</systemitem> 的預設 master 映射檔案是 <filename>/etc/auto.master</filename>。若要變更其位置，可以在 <filename>/etc/sysconfig/autofs</filename> 檔案中變更 <option>DEFAULT_MASTER_MAP_NAME</option> 選項的值。以下是 <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 中預設 master 映射檔案的內容：
   </para>
<screen>#
# Sample auto.master file
# This is an automounter map and it has the following format
# key [ -mount-options-separated-by-comma ] location
# For details of the format look at autofs(5).<co id="co.autofs.manpage"/>
#
#/misc  /etc/auto.misc<co id="co.autofs.map"/>
#/net -hosts
#
# Include /etc/auto.master.d/*.autofs<co id="co.autofs.include"/>
#
#+dir:/etc/auto.master.d
#
# Include central master map if it can be found using
# nsswitch sources.
#
# Note that if there are entries for /net or /misc (as
# above) in the included master map any keys that are the
# same will not be seen as the first read key seen takes
# precedence.
#
+auto.master<co id="co.autofs.plus"/></screen>
   <calloutlist>
    <callout arearefs="co.autofs.manpage">
     <para>
      <systemitem>autofs</systemitem> 手冊頁 (<command>man 5 autofs</command>) 提供了許多有關自動掛載器映射的重要資訊。
     </para>
    </callout>
    <callout arearefs="co.autofs.map">
     <para>
      雖然依預設透過 # 列為注釋，但是這是簡單的自動掛載器映射語法的範例。
     </para>
    </callout>
    <callout arearefs="co.autofs.include">
     <para>
      如果您需要將 master 映射拆分為幾個檔案，請將該行取消注釋標記，並將映射 (字尾為 <literal>.autofs</literal>) 置於 <filename>/etc/auto.master.d/</filename> 目錄中。
     </para>
    </callout>
    <callout arearefs="co.autofs.plus">
     <para>
      <literal>+auto.master</literal> 確保那些使用 NIS 的程序仍會找到它們的 master 映射。
     </para>
    </callout>
   </calloutlist>
   <para>
    <filename>auto.master</filename> 中的項目有三個欄位，語法如下：
   </para>
<screen>mount point      map name      options</screen>
   <variablelist>
    <varlistentry>
     <term>掛接點</term>
     <listitem>
      <para>
       用於掛接 <systemitem>autofs</systemitem> 檔案系統的基本位置，例如 <literal>/home</literal>。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>映射名稱</term>
     <listitem>
      <para>
       要用於掛接之映射來源的名稱。如需映射檔案的語法，請參閱<xref linkend="autofs.mapfiles"/>。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>選項</term>
     <listitem>
      <para>
       這些選項 (若指定) 依預設將套用至給定映射中的所有項目。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <tip>
    <para>
     如需選用<literal>映射類型</literal>、<literal>格式</literal>和<literal>選項</literal>之特定值的詳細資訊，請參閱 <guimenu>auto.master</guimenu> 手冊頁 (<command>man 5 auto.master</command>)。
    </para>
   </tip>
   <para>
    <filename>auto.master</filename> 中的下列項目可指示 <systemitem>autofs</systemitem> 在 <filename>/etc/auto.smb</filename> 中搜尋，並在 <filename>/smb</filename> 目錄中建立掛接點。
   </para>
<screen>/smb   /etc/auto.smb</screen>
   <sect3 id="autofs.directmount">
    <title>直接掛接</title>
    <para>
     直接掛接可在相關映射檔案內指定的路徑中建立掛接點。它並不在 <filename>auto.master</filename> 中指定掛接點，而是以 <literal>/-</literal> 取代掛接點欄位。例如，下面一行指示 <systemitem>autofs</systemitem> 在 <filename>auto.smb</filename> 中所指定的位置上建立掛接點：
    </para>
<screen>/-        /etc/auto.smb</screen>
    <tip>
     <title>不含完整路徑的映射</title>
     <para>
      如果未以映射檔案的完整本地或網路路徑指定映射檔案，則會使用名稱服務開關 (NSS) 組態尋找映射檔案。
     </para>
<screen>/-        auto.smb</screen>
    </tip>
   </sect3>
  </sect2>

  <sect2 id="autofs.mapfiles">
   <title>映射檔案</title>
   <important>
    <title>其他映射類型</title>
    <para>
     雖然<emphasis>檔案</emphasis>是使用 <systemitem>autofs</systemitem> 自動掛接之映射的最常見類型，但是還有其他一些類型。映射指定可以是指令的輸出，也可以是 LDAP 或資料庫中查詢的結果。如需映射類型的詳細資訊，請參閱手冊頁 <command>man 5 auto.master</command>。
    </para>
   </important>
   <para>
    映射檔案指定 (本地或網路) 來源位置，掛接點則指出在本地將來源掛接在何處。映射的一般格式與 master 映射相似。區別在於<emphasis>選項</emphasis>出現在掛接點與位置之間，而不是項目的末尾：
   </para>
<screen>mount point      options      location</screen>
   <variablelist>
    <varlistentry>
     <term>掛接點</term>
     <listitem>
      <para>
       指定將來源掛接在何處。這可以是要新增至 <filename>auto.master</filename> 中所指定基本掛接點的單個目錄名稱 (亦稱為<emphasis>間接</emphasis>掛接)，也可以是掛接點的完整路徑 (直接掛接，請參閱<xref linkend="autofs.directmount"/>)。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>選項</term>
     <listitem>
      <para>
       為相關項目指定選用的掛接點清單，內容以逗號分隔。如果 <filename>auto.master</filename> 還包含此映射檔案的選項，則會附加這些選項。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>location</term>
     <listitem>
      <para>
       指定要掛接的檔案系統的來源，通常是 NFS 或 SMB 磁區，一般表示為<literal>主機名稱:路徑名稱</literal>。如果要掛接的檔案系統以「/」開頭 (例如本地 <filename>/dev</filename> 項目或 smbfs 共用)，需要前置冒號符號「:」，例如 <literal>:/dev/sda1</literal>。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>
 </sect1>
 <sect1 id="sec.autofs.debugging">
  <title>操作與除錯</title>

  <para>
   本節介紹如何控制 <systemitem>autofs</systemitem> 服務操作，以及如何在調整自動掛載器操作時檢視更多除錯資訊。
  </para>

  <sect2 id="sec.autofs.debugging.service">
   <title>控制 <systemitem>autofs</systemitem> 服務</title>
   <para>
    <systemitem>autofs</systemitem> 服務的操作由 <systemitem class="daemon">systemd</systemitem> 控制。對 <systemitem>autofs</systemitem> 而言，<command>systemctl</command> 指令的一般語法是
   </para>
<screen>sudo systemctl <replaceable>sub-command</replaceable> autofs.service</screen>
   <para>
    其中<replaceable>子指令</replaceable>是下列其中一項：
   </para>
   <variablelist>
    <varlistentry>
     <term>enable</term>
     <listitem>
      <para>
       在開機時啟動自動掛載器精靈。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>start</term>
     <listitem>
      <para>
       啟動自動掛載器精靈。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>stop</term>
     <listitem>
      <para>
       停止自動掛載器精靈。自動掛接點不可存取。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>status</term>
     <listitem>
      <para>
       列印 <systemitem>autofs</systemitem> 服務的目前狀態以及部分相關記錄檔。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>restart</term>
     <listitem>
      <para>
       停止然後啟動自動掛載器，以便終止所有執行中的精靈，然後再啟動新的精靈。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>reload</term>
     <listitem>
      <para>
       檢查目前的 <filename>auto.master</filename> 映射，重新啟動項目已變更的精靈，然後啟動新項目的新精靈。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 id="sec.autofs.debugging.problems">
   <title>自動掛載器問題除錯</title>
   <para>
    如果您在使用 <systemitem>autofs</systemitem> 掛接目錄時遇到問題，實用的方法是手動執行 <command>automount</command> 精靈並觀看其輸出訊息：
   </para>
   <procedure>
    <step performance="required">
     <para>
      停止 <systemitem>autofs</systemitem>。
     </para>
<screen>sudo systemctl stop autofs.service</screen>
    </step>
    <step performance="required">
     <para>
      從一個終端機在前景手動執行 <command>automount</command>，以產生詳細輸出。
     </para>
<screen>sudo automount -f -v</screen>
    </step>
    <step performance="required">
     <para>
      從另一個終端機嘗試透過存取掛接點 (例如，透過 <command>cd</command> 或 <command>ls</command>) 掛接自動掛接的檔案系統。
     </para>
    </step>
    <step performance="required">
     <para>
      從第一個終端機檢查 <command>automount</command> 的輸出以瞭解更多資訊，例如掛接為何失敗，或者甚至為何未嘗試掛接。
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 id="sec.autofs.nfs">
  <title>自動掛接 NFS 共用</title>

  <para>
   下面的程序說明如何設定 <systemitem>autofs</systemitem> 以自動掛接網路上可用的 NFS 共用。該程序要用到上文中的資訊，並假設您熟悉 NFS 輸出。如需 NFS 詳細資訊，請參閱<xref linkend="cha.nfs"/>。
  </para>

  <procedure>
   <step performance="required">
    <para>
     編輯映射檔案 <filename>/etc/auto.master</filename>：
    </para>
<screen>sudo vim /etc/auto.master</screen>
    <para>
     在 <filename>/etc/auto.master</filename> 末尾為新的 NFS 掛接新增項目：
    </para>
<screen>/nfs      /etc/auto.nfs      --timeout=10</screen>
    <para>
     此指令指示 <systemitem>autofs</systemitem> 基本掛接點是 <filename>/nfs</filename>，NFS 共用在 <filename>/etc/auto.nfs</filename> 映射中指定，並且此映射中的所有共用如果在 10 秒鐘內未曾使用，則自動卸載。
    </para>
   </step>
   <step performance="required">
    <para>
     為 NFS 共用建立新的映射檔案：
    </para>
<screen>sudo vim /etc/auto.nfs</screen>
    <para>
     在 <filename>/etc/auto.nfs</filename> 中，通常每個 NFS 共用對應單獨一行內容，<xref linkend="autofs.mapfiles"/>中包含其格式的詳細描述。新增一行，說明掛接點及 NFS 共用網路位址：
    </para>
<screen>export      jupiter.com:/home/geeko/doc/export</screen>
    <para>
     上面一行表示系統會應要求將 <literal>jupiter.com</literal> 主機上的 <filename>/home/geeko/doc/export</filename> 目錄自動掛接到本地主機上的 <filename>/nfs/export</filename> 目錄 (<filename>/nfs</filename> 取自 <filename>auto.master</filename> 映射)。<filename>/nfs/export</filename> 目錄將由 <systemitem>autofs</systemitem> 自動建立。
    </para>
   </step>
   <step performance="required">
    <para>
     如果您先前靜態掛接了相同的 NFS 共用，則可以選擇性地將 <filename>/etc/fstab</filename> 中相關的行列為注釋。該行應類似於：
    </para>
<screen>#jupiter.com:/home/geeko/doc/export /nfs/export nfs defaults 0 0</screen>
   </step>
   <step performance="required">
    <para>
     重新載入 <systemitem>autofs</systemitem> 並檢查它是否正常運作：
    </para>
<screen>sudo systemctl restart autofs.service</screen>
<screen># ls -l /nfs/export
total 20
drwxr-xr-x  6 1001 users 4096 Oct 25 08:56 ./
drwxr-xr-x  3 root root     0 Apr  1 09:47 ../
drwxr-xr-x  5 1001 users 4096 Jan 14  2013 .images/
drwxr-xr-x 10 1001 users 4096 Aug 16  2013 .profiled/
drwxr-xr-x  3 1001 users 4096 Aug 30  2013 .tmp/
drwxr-xr-x  4 1001 users 4096 Oct 25 08:56 SLE-12-manual/</screen>
    <para>
     如果您能看到遠端共用上的檔案清單，則表示 <systemitem>autofs</systemitem> 正常工作。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 id="sec.autofs.advanced">
  <title>進階主題</title>

  <para>
   本節描述了 <systemitem>autofs</systemitem> 基本介紹以外的主題 — 自動掛接網路上可用的 NFS 共用，在映射檔案中使用萬用字元以及有關 CIFS 檔案系統特定的資訊。
  </para>

  <sect2 id="sec.autofs.advanced.net">
   <title><filename>/net</filename> 掛接點</title>
   <para>
    如果您使用許多 NFS 共用，則這個掛接點非常有用。<filename>/net</filename> 會根據需要自動掛接本地網路上的所有 NFS 共用。該項目已存在於 <filename>auto.master</filename> 檔案中，因此，您只需取消其注釋標記並重新啟動 <systemitem>autofs</systemitem> 即可：
   </para>
<screen>/net      -hosts</screen>
<screen>systemctl restart autofs.service</screen>
   <para>
    例如，如果您有個名為 <literal>jupiter</literal> 的伺服器以及名為 <filename>/export</filename> 的 NFS 共用，您可以在指令行上鍵入下列指令進行掛接：
   </para>
<screen># cd /net/jupiter/export</screen>
   <para>
    
   </para>
  </sect2>

  <sect2 id="sec.autofs.advanced.wildcards">
   <title>使用萬用字元自動掛接子目錄</title>
   <para>
    如果您的目錄含有子目錄，而這些子目錄的自動掛接需要個別處理 (典型的情況是包含各個使用者主目錄的 <filename>/home</filename> 目錄)，<systemitem>autofs</systemitem> 為您準備了便捷的解決方案。
   </para>
   <para>
    對於主目錄，請在 <filename>auto.master</filename> 中新增下面一行：
   </para>
<screen>/home      /etc/auto.home</screen>
   <para>
    現在，您需要將正確的映射新增至 <filename>/etc/auto.home</filename> 檔案，以便自動掛接使用者的主目錄。有個解決方案是為每個目錄建立獨立的項目：
   </para>
<screen>wilber      jupiter.com:/home/wilber
penguin      jupiter.com:/home/penguin
tux      jupiter.com:/home/tux
[...]</screen>
   <para>
    這種方法非常麻煩，因為您需要在 <filename>auto.home</filename> 中管理使用者清單。您可以使用星號「*」而不是掛接點，使用和號「&amp;」而不是要掛接的目錄。
   </para>
<screen>*      jupiter:/home/&amp;</screen>
  </sect2>

  <sect2 id="sec.autofs.advanced.cifs">
   <title>自動掛接 CIFS 檔案系統</title>
   <para>
    如果您要自動掛接 SMB/CIFS 共用 (有關 SMB/CIFS 協定的詳細資訊，請參閱<xref linkend="cha.samba"/>)，則需要修改映射檔案的語法。在選項欄位中新增 <option>-fstype=cifs</option>，並在共用位置前面加上冒號「:」。
   </para>
<screen>mount point      -fstype=cifs      ://jupiter.com/export</screen>
  </sect2>
 </sect1>
</chapter>
