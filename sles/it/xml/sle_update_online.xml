<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_online.xml" version="5.0" xml:id="cha.update.online">
 <title>Upgrade online</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>sì</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    SUSE offre uno strumento grafico intuitivo e uno strumento da riga di comando per eseguire l'upgrade di un sistema in esecuzione al nuovo Service Pack. Tali strumenti forniscono il supporto necessario per il <quote>rollback</quote> dei Service Pack e altro. In questo capitolo è illustrata la procedura dettagliata per eseguire l'upgrade di un Service Pack con tali strumenti.
   </para>
  </abstract>
 </info>
 <sect1 xml:id="sec.update.migr.conceptual-overview">
  <title>Panoramica concettuale</title>

  <para>
   SUSE rilascia Service Pack per la famiglia SUSE Linux Enterprise a intervalli regolari. Per semplificare la migrazione a un nuovo Service Pack da parte dei clienti e ridurre al minimo il tempo di inattività, SUSE supporta l'esecuzione della migrazione online mentre il sistema è in esecuzione.
  </para>

  <para>
   A partire da SLE 12, YaST Wagon è stato sostituito da YaST migration (tramite GUI) e Zypper migration (dalla riga di comando). Sono supportate le funzioni seguenti:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Il sistema è in uno stato definito fino all'aggiornamento del primo RPM
    </para>
   </listitem>
   <listitem>
    <para>
     L'annullamento è possibile fino all'aggiornamento del primo RPM
    </para>
   </listitem>
   <listitem>
    <para>
     In caso di errore il recupero è semplice
    </para>
   </listitem>
   <listitem>
    <para>
     Il <quote>rollback</quote> può essere eseguito tramite strumenti di sistema, senza richiedere attività di backup o ripristino
    </para>
   </listitem>
   <listitem>
    <para>
     Vengono utilizzati tutti gli archivi attivi
    </para>
   </listitem>
   <listitem>
    <para>
     È possibile ignorare un Service Pack
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.workflow">
  <title>Workflow di migrazione del Service Pack</title>

  <para>
   Per eseguire la migrazione di un Service Pack è possibile utilizzare YaST, <command>zypper</command> o AutoYaST.
  </para>

  <para>
   Prima di iniziare la migrazione di un Service Pack è necessario registrare il sistema in SUSE Customer Center o in un server SMT locale. È possibile utilizzare anche SUSE Manager.
  </para>

  <para>
   Indipendentemente dal metodo, una migrazione del Service Pack consiste nei seguenti passaggi:
  </para>

  <orderedlist>
   <listitem>
    <para>
     Trovare le possibili destinazioni di migrazione nei sistemi registrati.
    </para>
   </listitem>
   <listitem>
    <para>
     Selezionare una destinazione di migrazione.
    </para>
   </listitem>
   <listitem>
    <para>
     Richiedere e abilitare nuovi archivi.
    </para>
   </listitem>
   <listitem>
    <para>
     Eseguire la migrazione.
    </para>
   </listitem>
  </orderedlist>



  <para>
   L'elenco delle destinazioni di migrazione dipende dai prodotti installati e registrati. Se è installata un'estensione per cui non è ancora disponibile il nuovo Service Pack, è possibile che non venga resa disponibile alcuna destinazione.
  </para>

  <para>
   L'elenco delle destinazioni di migrazione disponibili per l'host in uso viene sempre recuperato da SUSE Customer Center e dipende dalle estensioni o dai prodotti installati.
  </para>
 </sect1>
 <sect1 xml:id="sec.update.migr.cancel.spm">
  <title>Annullamento della migrazione di un Service Pack</title>

  <para>
   La migrazione di un Service Pack può essere annullata solo in alcune fasi specifiche del processo di migrazione:
  </para>

  <orderedlist>
   <listitem>
    <para>
     Finché non ha inizio l'upgrade del pacchetto, al sistema vengono apportate solo alcune modifiche minime, ad esempio per servizi e archivi. Ripristinare <filename>/etc/zypp/repos.d/*</filename> per tornare allo stato precedente.
    </para>
   </listitem>
   <listitem>
    <para>
     Per tornare allo stato precedente dopo l'avvio dell'upgrade del pacchetto, è possibile utilizzare un'istantanea di Snapper (vedere <xref linkend="cha.snapper"/>).
    </para>
   </listitem>
   <listitem>
    <para>
     Dopo la selezione della destinazione di migrazione, SUSE Customer Center modifica i dati dell'archivio. Per tornare manualmente allo stato precedente, utilizzare <command>SUSEConnect</command>
     <option> --rollback</option>.
    </para>
   </listitem>
  </orderedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.yast.onlinemigr">
  <title>Upgrade con lo strumento di migrazione online (YaST)</title>

  <para>
   Per eseguire la migrazione di un Service Pack con YaST, utilizzare lo strumento <guimenu>Migrazione online</guimenu>. Per default, YaST non installa i pacchetti da un archivio di terze parti. Se un pacchetto è stato installato da un archivio di terze parti, YaST impedisce che il pacchetto venga sostituito con lo stesso pacchetto proveniente da SUSE.
  </para>

  <note>
   <title>Ridurre la dimensione dell'installazione</title>
   <para>
    Quando si esegue la migrazione di un Service Pack, YaST installa tutti i pacchetti consigliati. Soprattutto nel caso di un'installazione minima personalizzata, questo può aumentare notevolmente la dimensione dell'installazione del sistema.
   </para>
   <para>
    Per modificare questo comportamento di default e consentire l'installazione dei soli pacchetti necessari, modificare <filename>/etc/zypp/zypp.conf</filename> e impostare la variabile seguente:
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   Questo modifica il comportamento di tutte le operazioni sui pacchetti, come l'installazione di patch o nuovi pacchetti.
  </para>

  <para>
   Per avviare la migrazione di un Service Pack, procedere come segue:
  </para>

  <procedure xml:id="pro.update.migr.yast">
   <step>
    <para>
     Disattivare tutte le estensioni inutilizzate sul server di registrazione per evitare futuri conflitti di dipendenza futuri. Nel caso in cui ci si dimenticasse un'estensione, in un momento successivo YaST rileverà gli archivi delle estensioni inutilizzate e le disattiverà.
    </para>
   </step>
   <step>
    <para>
     Se si è eseguito il login a una sessione GNOME in esecuzione su un computer che verrà sottoposto ad aggiornamento, passare a una console di testo. L'esecuzione dell'aggiornamento da una sessione GNOME non è consigliata. Tenere presente che ciò non si applica quando si esegue il login da un computer remoto (a meno che non sia in esecuzione una sessione VNC con GNOME).
    </para>
   </step>
   <step>
    <para>
     I sottoscrittori LTSS devono assicurarsi che l'archivio delle estensioni LTSS sia attivo.
    </para>
   </step>
   <step>
    <para>
     Eseguire l'aggiornamento online tramite YaST per recuperare gli ultimi aggiornamenti dei pacchetti per il sistema in uso.
    </para>
   </step>
   <step>
    <para>
     Installare il pacchetto
     <package>yast2-migration</package>
     e le relative dipendenze (in YaST, nella sezione <menuchoice>
     <guimenu> Software</guimenu> <guimenu> Gestione software</guimenu>
     </menuchoice>).
    </para>
   </step>
   <step>
    <para>
     Riavviare YaST. In caso contrario il modulo appena installato non verrà mostrato nel centro di controllo.
    </para>
   </step>
   <step>
    <para>
     Iniziare in YaST <menuchoice> <guimenu> Sistema</guimenu> <guimenu> Migrazione online</guimenu> </menuchoice>. YaST mostrerà le destinazioni di migrazione possibili e un riepilogo. Se per il sistema in uso sono disponibili più destinazioni di migrazione, selezionarne una dall'elenco.
    </para>
   </step>
   <step>
    <para>
     Selezionare una destinazione di migrazione dall'elenco e fare clic su <guimenu>Avanti</guimenu> per continuare.
    </para>
   </step>
   <step>
    <para>
     Se lo strumento di migrazione offre archivi di aggiornamenti, è consigliabile selezionare <guimenu>Sì</guimenu> per procedere.
    </para>
   </step>
   <step>
    <para>
     <remark>toms 2015-09-09: FATE#319140</remark> Se lo strumento di migrazione online rileva archivi obsoleti provenienti da DVD o da un server locale, è consigliabile disabilitarli. Gli archivi obsoleti provengono da un Service Pack precedente. Gli eventuali archivi obsoleti di SCC o SMT vengono rimossi automaticamente.
    </para>
   </step>
   <step>
    <para>
     Controllare il riepilogo e continuare con la migrazione facendo clic su <guimenu>Avanti</guimenu>. Confermare con <guimenu>Avvia aggiornamento</guimenu>.
    </para>
    <remark>toms 2016-07-13: What to do in case of problems?</remark>
   </step>
   <step>
    <para>
     Al termine della migrazione, riavviare il sistema.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.zypper.onlinemigr">
  <title>Upgrade con Zypper</title>

  <para>
   Per eseguire la migrazione di un Service Pack con Zypper, utilizzare lo strumento da riga di comando <command>zypper</command> <option> migration</option>.
  </para>

  <note>
   <title>Ridurre la dimensione dell'installazione</title>
   <para>
    Quando si esegue la migrazione di un Service Pack, YaST installa tutti i pacchetti consigliati. Soprattutto nel caso di un'installazione minima personalizzata, questo può aumentare notevolmente la dimensione dell'installazione del sistema.
   </para>
   <para>
    Per modificare questo comportamento di default e consentire l'installazione dei soli pacchetti necessari, modificare <filename>/etc/zypp/zypp.conf</filename> e impostare la variabile seguente:
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   Questo modifica il comportamento di tutte le operazioni sui pacchetti, come l'installazione di patch o nuovi pacchetti. Per modificare il comportamento di Zypper per una singola chiamata, aggiungere il parametro <option>--no-recommends</option> alla riga di comando.
  </para>

  <para>
   Per avviare la migrazione di un Service Pack, procedere come segue:
  </para>

  <procedure xml:id="pro.update.migr.zypper">
   <step>
    <para>
     Se si è eseguito il login a una sessione GNOME in esecuzione su un computer che verrà sottoposto ad aggiornamento, passare a una console di testo. L'esecuzione dell'aggiornamento da una sessione GNOME non è consigliata. Tenere presente che ciò non si applica quando si esegue il login da un computer remoto (a meno che non sia in esecuzione una sessione VNC con GNOME).
    </para>
   </step>
   <step>
    <para>
     Se non è ancora stato fatto, registrare il computer SUSE Linux Enterprise in uso:
    </para>
<screen>sudo <command>SUSEConnect</command> --regcode <replaceable>YOUR_REGISTRATION_CODE</replaceable></screen>
   </step>
   <step>
    <para>
     I sottoscrittori LTSS devono assicurarsi che l'archivio delle estensioni LTSS sia attivo.
    </para>
   </step>
   <step>
    <para>
     Installare gli ultimi aggiornamenti:
    </para>
<screen>sudo <command>zypper</command> patch</screen>
   </step>
   <step>
    <para>
     Installare il pacchetto <package>zypper-migration-plugin</package> e le rispettive dipendenze:
    </para>
<screen>sudo <command>zypper</command> in zypper-migration-plugin</screen>
   </step>
   <step>
    <para>
     Eseguire <command>zypper</command> <option> migration</option>:
    </para>
<screen><prompt>tux &gt; </prompt>sudo <command>zypper</command> migration
Executing 'zypper  patch-check'

Refreshing service 'SUSE_Linux_Enterprise_Server_12_x86_64'.
Loading repository data...
Reading installed packages...
0 patches needed (0 security patches)

Available migrations:

    1 | SUSE Linux Enterprise Server 12 SP1 x86_64
    2 | SUSE Linux Enterprise Server 12 SP2 x86_64</screen>
    <para>
     Note sul processo di migrazione:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Se per il sistema in uso sono disponibili più destinazioni di migrazione, Zypper consente di selezionarne una dall'elenco. È come ignorare uno o più Service Pack. Ricordare che la migrazione online per i prodotti base (SLES, SLED) rimane disponibile solo tra i Service Pack di una versione principale.
      </para>
     </listitem>
     <listitem>
      <para>
       Per default, Zypper usa l'opzione <option>--no-allow-vendor-change</option>, che viene passata a <command>zypper</command> <option> dup</option>. Se un pacchetto è stato installato da un archivio di terze parti, questa opzione impedisce che il pacchetto venga sostituito con lo stesso pacchetto proveniente da SUSE.
      </para>
     </listitem>
     <listitem>
      <para>
       <remark>toms 2015-09-09: FATE#319140</remark> Se Zypper rileva archivi obsoleti provenienti da DVD o da un server locale, è consigliabile disabilitarli. Gli archivi SCC o SMT precedenti vengono rimossi automaticamente.
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     Rivedere tutte le modifiche, soprattutto i pacchetti che verranno rimossi. Procedere digitando <literal>y</literal> (il numero esatto di pacchetti di cui eseguire l'upgrade può variare in base al sistema):
    </para>
<screen>266 packages to upgrade, 54 to downgrade, 17 new, 8 to reinstall, 5 to remove, 1 to change arch.
Overall download size: 285.1 MiB. Already cached: 0 B  After the operation, additional 139.8 MiB will be used.
Continue? [y/n/? shows all options] (y):</screen>
    <para>
     Utilizzare i tasti <keycombo> <keycap function="shift"/> <keycap function="pageup"/>
     </keycombo>    o <keycombo> <keycap function="shift"/>
     <keycap function="pagedown"/> </keycombo>    per scorrere nella shell.
    </para>
   </step>
   <step>
    <para>
     Al termine della migrazione, riavviare il sistema.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.plainzypper.onlinemigr">
  <title>Upgrade con Zypper semplice</title>

  <para>
   Se non è possibile utilizzare YaST o Zypper migration, è comunque possibile eseguire la migrazione con Zypper semplice e alcune interazioni manuali. Per avviare la migrazione di un Service Pack, procedere come segue:
  </para>

  <procedure>
   <step>
    <para>
     Se si è eseguito il login a una sessione GNOME in esecuzione su un computer che verrà sottoposto ad aggiornamento, passare a una console di testo. L'esecuzione dell'aggiornamento da una sessione GNOME non è consigliata. Tenere presente che ciò non si applica quando si esegue il login da un computer remoto (a meno che non sia in esecuzione una sessione VNC con GNOME).
    </para>
   </step>
   <step>
    <para>
     Aggiornare gli strumenti di gestione dei pacchetti con gli archivi precedenti di SUSE Linux Enterprise:
    </para>
<screen>sudo <command>zypper</command> patch --updatestack-only</screen>
   </step>
   <step>
    <para>
     Se il sistema è registrato, è necessario annullarne la registrazione:
    </para>
<screen>sudo <command>SUSEConnect</command> --de-register</screen>
   </step>
   <step>
    <para>
     Rimuovere le origini di installazione e gli archivi precedenti, quindi modificare gli archivi di terze parti.
    </para>
   </step>
   <step>
    <para>
     Aggiungere le nuove origini di installazione, locali o remote (per il segnaposto <replaceable>ARCHIVIO</replaceable>, consultare <xref linkend="sec.update.nmm.repositories"/>):
    </para>
<screen>sudo <command>zypper</command> addrepo <replaceable>REPOSITORY</replaceable></screen>
    <para>
     È inoltre possibile utilizzare SUSE Customer Center o Subscription Management Tool. Il comando per SUSE Linux Enterprise 12 SP1 su x86-64 è:
    </para>
<screen>sudo <command>SUSEConnect</command> -p SLES/12.2/x86_64 <replaceable>OPTIONS</replaceable></screen>
    <para>
     Tenere presente che gli upgrade tra architetture non sono supportati.
    </para>
    <para>
     In Zypper verrà visualizzato un conflitto tra il nuovo kernel e quello precedente. Scegliere la soluzione 1 per continuare.
    </para>
<screen>Problem: product:SLES-12.2-0.x86_64 conflicts with kernel &lt; 4.4 provided by kernel-default-<replaceable>version</replaceable>
 Solution 1: Following actions will be done:
  replacement of kernel-default-<replaceable>version</replaceable> with kernel-default-<replaceable>version</replaceable>
  deinstallation of kernel-default-<replaceable>version</replaceable>
 Solution 2: do not install product:SLES-12.2-0.x86_64
</screen>
   </step>
   <step>
    <para>
     Finalizzare la migrazione:
    </para>
<screen>sudo <command>zypper</command> ref -f -s
sudo <command>zypper</command> dup --no-allow-vendor-change --no-recommends</screen>
    <para>
     Il primo comando aggiorna tutti i servizi e gli archivi. Il secondo comando esegue un upgrade della distribuzione. In questo caso, le ultime due opzioni sono importanti: <option>-no-allow-vendor-change</option> assicura che gli RPM di terze parti non sovrascriveranno quelli del sistema di base. L'opzione <option>--no-recommends</option> assicura che i pacchetti deselezionati durante l'installazione iniziale non verranno aggiunti di nuovo.
    </para>
   </step>
  </procedure>
 </sect1>



 <sect1 xml:id="sec.update.migr.rollback">
  <title>Rollback di un Service Pack</title>

  <para>
   Se un Service Pack non è adatto alle proprie esigenze, SUSE Linux Enterprise supporta il ripristino del sistema allo stato precedente l'avvio della migrazione del Service Pack. Il prerequisito è una partizione radice Btrfs con snapshot abilitati (impostazione di default durante l'installazione di SLES 12). Per ulteriori informazioni, vedere <xref linkend="cha.snapper"/>.
  </para>

  <procedure xml:id="pro.update.migr.rollback">
   <step>
    <para>
     Recuperare un elenco di tutte le istantanee di Snapper:
    </para>
    <screen>sudo snapper list</screen>
    <para>
     Rivedere l'output per individuare lo snapshot creato subito prima dell'avvio della migrazione del Service Pack. Nella colonna <guimenu>Descrizione</guimenu> è contenuta l'istruzione corrispondente e lo snapshot è contrassegnato come <literal>importante</literal> nella colonna <guimenu>Dati utente</guimenu>. Memorizzare il numero dello snapshot nella colonna <guimenu>N.</guimenu> e la rispettiva data nella colonna <guimenu>Data</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Riavviare il computer. Dal menu di avvio, selezionare <guimenu>Avvia boot loader da uno snapshot di sola lettura</guimenu> e scegliere lo snapshot con la data e il numero memorizzato al passaggio precedente. Viene caricato un secondo menu di avvio (quello dello snapshot). Selezionare la voce che inizia con <literal>SLES 12</literal> ed eseguire l'avvio.
    </para>
   </step>
   <step>
    <para>
     Il sistema viene avviato nello stato precedente con la partizione del sistema montata in sola lettura. Eseguire il login come <systemitem class="username">root</systemitem> e verificare che lo snapshot selezionato sia corretto. Verificare inoltre che tutto funzioni come previsto. Tenere presente che poiché il file system radice è montato in sola lettura, è possibile che vengano applicate restrizioni alla funzionalità.
    </para>
    <para>
     In caso di problemi o se è stato avviato lo snapshot errato, riavviare e scegliere uno snapshot diverso dal quale eseguire l'avvio. Le modifiche apportate finora non sono permanenti. Se lo snapshot è corretto e funziona come previsto, apportare la modifica permanente eseguendo il seguente comando:
    </para>
    <screen>snapper rollback</screen>
    <para>
     Dopodiché riavviare. Nella schermata di avvio, scegliere la voce di avvio di default per riavviare nel sistema ripristinato.
    </para>
   </step>
   <step>
    <para>
     Verificare che la configurazione dell'archivio sia stata reimpostata correttamente. Verificare inoltre che tutte le procedure siano registrate adeguatamente. Se una delle suddette condizioni non è soddisfatta, l'aggiornamento del sistema in un momento successivo potrebbe risultare impossibile o il sistema potrebbe essere aggiornato con archivi di pacchetti errati.
    </para>
    <para>
     Assicurarsi che il sistema sia in grado di accedere a Internet prima di iniziare questa procedura.
    </para>
    <substeps>
     <step>
      <para>
       Aggiornare servizi e archivi eseguendo
      </para>
      <screen>sudo zypper ref -fs</screen>
     </step>
     <step>
      <para>
       Ottenere un elenco di archivi attivi eseguendo
      </para>
      <screen>sudo zypper lr</screen>
      <para>
       Verificare attentamente l'output di questo comando. Nell'elenco non dovrebbero comparire servizi e archivi aggiunti per l'aggiornamento. Se ad esempio si esegue il rollback da una migrazione di un Service Pack da SLES 12 SP1 a SLES 12 SP2, l'elenco <emphasis>non</emphasis> deve contenere gli archivi <literal>SLES12-SP2-Pool</literal> e <literal>SLES12-SP2-Updates</literal>, bensì le versioni <literal>SP1</literal>.
      </para>
      <para>
       Nel caso in cui siano elencati archivi errati, assicurarsi di eliminarli e, se necessario, sostituirli con le versioni che corrispondono al prodotto o alla versione del Service Pack in uso. Per un elenco di archivi per i percorsi delle migrazioni supportate, fare riferimento alla <xref linkend="sec.update.nmm.repositories"/>.
      </para>
     </step>
     <step>
      <para>
       Infine, verificare che nello stato di registrazione siano presenti tutti i prodotti installati eseguendo
      </para>
      <screen>SUSEConnect --status</screen>
      <para>
       Lo stato di tutti i prodotti deve essere <literal>Registrato</literal>. In caso contrario, correggere la registrazione eseguendo
      </para>
      <screen>SUSEConnect --rollback</screen>
     </step>
    </substeps>
   </step>
  </procedure>
  <para>
   Il sistema viene ripristinato allo stato acquisito immediatamente prima dell'avvio della migrazione del Service Pack.
  </para>
 </sect1>
</chapter>
