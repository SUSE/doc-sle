<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="storage_fcoe.xml" version="5.0" xml:id="cha.fcoe" xml:lang="ja">
 <title>Fibre Channel Storage over Ethernet Networks: FCoE</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:bugtracker>
          </dm:bugtracker>
        <dm:translation>yes</dm:translation>
      </dm:docmanager>
    </info>
    <para>
  多くの企業のデータセンターが、そのLANおよびデータトラフィックをEthernetに依存し、またそのストレージインフラストラクチャをファイバチャネルに依存しています。Open Fibre Channel over Ethernet (FCoE)イニシエータソフトウェアは、Ethernetアダプタが付いたサーバが、Ethernetネットワーク上でファイバチャネルストレージに接続できるようにします。このコネクティビティはこれまで、ファイバチャネルファブリック上にファイバチャネルアダプタを有するシステム用に、独占的に確保されていました。FCoEテクノロジは、ネットワークコンバージェンスを支援することで、データセンター内の複雑性を減らします。これにより、ファイバチャネルストレージへの既存の投資を無駄にすることなく、ネットワーク管理を簡素化することができます。
 </para>
 <figure>
  <title>Open Fibre Channel over Ethernet SAN</title>
  <mediaobject>
   <imageobject role="fo">
    <imagedata fileref="fcoe_san_a.svg" width="80%" format="SVG"/>
   </imageobject>
   <imageobject role="html">
    <imagedata fileref="fcoe_san_a.png" width="100%" format="PNG"/>
   </imageobject>
  </mediaobject>
 </figure>
 <para>
  Open-FCoEでは、ホストバスアダプタ上の専有のハードウェアではなく、ホストでファイバチャネルのプロトコルを実行することができます。対象としているのは10 Gbps (ギガバイト/秒)のEthernetアダプタですが、PAUSEフレームに対応したすべてのEthernetアダプタで使用可能です。イニシエータソフトウェアにより、ファイバチャネルプロトコルの処理モジュールと、Ethernetベースのトランスポートモジュールが提供されます。Open-FCoEモジュールは、SCSI用の低レベルドライバの役割を果たします。Open-FCoEトランスポートは、<command>net_device</command>を使用してパケットの送受信を行います。DCB(データセンターブリッジング)ドライバにより、FCoE向けのサービスの質が提供されます。
 </para>
 <para>
  FCoEは、ファイバチャネルフレームを変えずに、ファイバチャネルのプロトコルトラフィックをEthernet接続上で動かす、カプセル化プロトコルです。これにより、ネットワークセキュリティとトラフィック管理インフラストラクチャが、ファイバチャネルにおけるのと同じようにFCoEでも機能することができます。
 </para>
 <para>
  以下の条件が当てはまる企業では、FCoEの導入を選択してもよいでしょう。
 </para>
 <itemizedlist mark="bullet" spacing="normal">
  <listitem>
   <para>
    すでにファイバチャネルストレージシステムがあり、ファイバチャネルのスキルと知識を持つ管理者がいる。
   </para>
  </listitem>
  <listitem>
   <para>
    ネットワーク内に、10 GbpsのEthernetを展開している。
   </para>
  </listitem>
 </itemizedlist>
 <para>
  本項では、ネットワークにFCoEを設定する方法を説明します。
 </para>
 <sect1 xml:id="sec.fcoe.installation">
  <title>インストール時におけるFCoEインタフェースの設定</title>

  <para>
   <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>向けのYaSTのインストールでは、サーバとファイバチャネルストレージインフラストラクチャ間の接続用のスイッチでFCoEが有効になっていれば、オペレーティングシステムのインストール時にFCoEディスクの設定を行うことができます。一部のシステムBIOSタイプでは、FCoEディスクを自動的に検出することができ、そのディスクをYaSTのインストールソフトウェアに報告します。ただし、FCoEディスクの自動検出は、すべてのBIOSのタイプでサポートされているわけではありません。その場合、インストールの開始時に次の<command>withfcoe</command>オプションをカーネルのコマンドラインに追加することで、自動検出を有効にすることができます。
  </para>

<screen>withfcoe=1</screen>

  <para>
   FCoEディスクが検出されると、YaSTのインストールでは、同時にFCoEを設定するオプションがあります。"ディスクアクティベーション"ページで、<guimenu>FCoEインタフェースの設定</guimenu>を選択して、FCoEの設定にアクセスします。FCoEインタフェースの設定については、<xref linkend="sec.fcoe.yast" xrefstyle="SectTitleOnPage"/>を参照してください。
  </para>

  <informalfigure>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="fcoe_inst_disk_activation_a.png" width="80%" format="PNG"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="fcoe_inst_disk_activation_a.png" width="10%" format="PNG"/>
    </imageobject>
   </mediaobject>
  </informalfigure>
 </sect1>
 <sect1 xml:id="sec.fcoe.install">
  <title>FCoEおよびYaSTのFCoEクライアントのインストール</title>

  <para>
   サーバへの接続用のスイッチでFCoEを有効にすることで、ストレージインフラストラクチャ内にFCoEディスクを設定することができます。<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>オペレーティングシステムのインストール時にFCoEディスクが利用可能であれば、FCoEイニシエータソフトウェアが、その時点で自動的にインストールされます。
  </para>

  <para>
   FCoEイニシエータソフトウェアとYaST FCoEクライアントソフトウェアがインストールされていない場合は、次の手順で次のコマンドを使用して手動でインストールします。
  </para>

<screen>sudo zypper in yast2-fcoe-client fcoe-utils</screen>

  <para>
   または、YaSTソフトウェアマネージャを使用して、これらのパッケージをインストールします。
  </para>
 </sect1>
 <sect1 xml:id="sec.fcoe.yast">
  <title>YaSTを使用したFCoEサービスの管理</title>

  <para>
   YaST FCoEクライアント設定オプションを使用して、お使いのファイバチャネルストレージインフラストラクチャ内のFCoEディスク用のFCoEインタフェースの作成、設定、および削除ができます。このオプションを使用するには、FCoEイニシエータサービス(<systemitem class="daemon">fcoemon</systemitem>デーモン)およびLink Layer Discovery Protocolエージェントデーモン(<systemitem class="daemon">llpad</systemitem>)がインストールされて実行中であり、FCoE接続が、FCoE対応のスイッチで有効になっている必要があります。
  </para>

  <procedure>
   <step>
    <para>
     YaSTを起動し、<menuchoice><guimenu>ネットワークサービス</guimenu><guimenu>FCoEクライアントの設定</guimenu></menuchoice>の順に選択します。
    </para>
    <informalfigure>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="fcoe_services_a.png" width="201pt" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="fcoe_services_a.png" width="201pt" format="PNG"/>
      </imageobject>
     </mediaobject>
    </informalfigure>
   </step>
   <step>
    <para>
     <guimenu>サービス</guimenu>タブで、FCoEサービスとLldpad (Link Layer Discovery Protocolエージェントデーモン)サービスの開始時刻を確認し、必要に応じて変更します。
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <formalpara>
       <title>FCoEサービスの開始:</title>
       <para>
        Fibre Channel over Ethernetサービスの<command>fcoemon</command>デーモンを、サーバの起動時に開始するか、マニュアルで開始するかを指定します。このデーモンは、FCoEインタフェースを制御して、<systemitem class="daemon">llpad</systemitem>デーモンとの接続を確立します。値は、<guimenu>起動時</guimenu>(デフォルト)または<guimenu>マニュアル</guimenu>です。
       </para>
      </formalpara>
     </listitem>
     <listitem>
      <formalpara>
       <title>Lldpadサービスの開始:</title>
       <para>
        Link Layer Discovery Protocolエージェント<systemitem class="daemon">llpad</systemitem>デーモンを、サーバの起動時に開始するか、マニュアルで開始するかを指定します。<systemitem class="daemon">llpad</systemitem>デーモンは、データセンターブリッジング機能およびFCoEインタフェースの設定について、<command>fcoemon</command>デーモンに情報を送ります。値は、<guimenu>起動時</guimenu>(デフォルト)または<guimenu>マニュアル</guimenu>です。
       </para>
      </formalpara>
     </listitem>
    </itemizedlist>
    <para>
     設定を変更した場合は、<guimenu>OK</guimenu>をクリックして変更内容を保存して適用します。
    </para>
   </step>
   <step>
    <para>
     <guimenu>インタフェース</guimenu>タブで、サーバ上で検出されたすべてのネットワークアダプタに関する情報(VLANおよびFCoEの設定に関する情報を含む)を確認します。また、FCoE VLANインタフェースの作成や既存のFCoEインタフェース設定の変更、FCoEインタフェースの削除もできます。
    </para>
    <informalfigure>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="fcoe_notconfig_interface_a.png" width="201pt" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="fcoe_notconfig_interface_a.png" width="201pt" format="PNG"/>
      </imageobject>
     </mediaobject>
    </informalfigure>
    <para>
     <guimenu>FCoE VLANインタフェース</guimenu>列を使用して、FCoEが使用可能かどうかを判断します。
    </para>
    <variablelist>
     <varlistentry>
      <term><replaceable>インタフェース名</replaceable>
      </term>
      <listitem>
       <para>
        インタフェースに名前が割り当てられている(<filename>eth4.200</filename>など)場合は、スイッチでFCoEが利用可能であり、FCoEインタフェースがアダプタに対してアクティブになっています。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>未設定:</term>
      <listitem>
       <para>
        状態が<guimenu>未設定</guimenu>である場合は、スイッチでFCoEが有効になっていますが、FCoEインタフェースはアダプタに対してアクティブになっていません。アダプタでインタフェースを有効にするには、アダプタを選択して、<guimenu>FCoE VLANインタフェースを作成</guimenu>をクリックします。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>使用不可:</term>
      <listitem>
       <para>
        状態が<guimenu>使用不可</guimenu>である場合は、FCoEがスイッチ上のその接続に対して有効になっていないため、そのアダプタではFCoEは使えません。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </step>
   <step>
    <para>
     未設定のFCoE対応アダプタを設定するには、そのアダプタを選択し、<guimenu>FCoE VLANインタフェースを作成</guimenu>をクリックします。問い合わせに対して、<guimenu>はい</guimenu>を選択して確認します。
    </para>
    <para>
     アダプタがインタフェース名と共に<guimenu>FCoE VLANインタフェース</guimenu>列に表示されます。
    </para>
   </step>
   <step>
    <para>
     設定済みのアダプタの設定を変更するには、リストでそのアダプタを選択し、<guimenu>Change Settings (設定の変更)</guimenu>をクリックします。
    </para>
    <para>
     次のオプションを設定できます。
    </para>
    <variablelist>
     <varlistentry>
      <term><guimenu>FCoEの有効化</guimenu>
      </term>
      <listitem>
       <para>
        アダプタに対してFCoEインスタンスの作成を有効または無効にします。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><guimenu>DCBが必要</guimenu>
      </term>
      <listitem>
       <para>
        データセンターブリッジングがアダプタに必要かどうかを指定します(通常は必要です)。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><guimenu>Auto VLAN</guimenu>
      </term>
      <listitem>
       <para>
        <systemitem class="daemon">fcoemon</systemitem>デーモンでVLANインタフェースを作成するかどうかを指定します。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     設定を変更した場合は、<guimenu>次へ</guimenu>をクリックして変更内容を保存して適用します。設定は、<filename>/etc/fcoe/eth<replaceable>X</replaceable></filename>ファイルに書き込まれます。<systemitem class="daemon">fcoemon</systemitem>デーモンは、初期化時に各FCoEインタフェースの環境設定ファイルを読み込みます。
    </para>
   </step>
   <step>
    <para>
     設定済みのインタフェースを削除するには、それをリストで選択します。<guimenu>インタフェースの削除</guimenu>をクリックし、<guimenu>続行</guimenu>をクリックして確認します。FCoEインタフェースの値が、<guimenu>未構成</guimenu>に変わります。
    </para>
   </step>
   <step>
    <para>
     <guimenu>設定</guimenu>タブで、FCoEシステムサービスの全般設定を確認または変更します。FCoEサービススクリプトと<systemitem class="daemon">fcoemon</systemitem>デーモンからのデバッグメッセージを有効/無効にしたり、メッセージをシステムログに送信するかどうかを指定したりできます。
    </para>
    <informalfigure>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="fcoe_configtab_a.png" width="201pt" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="fcoe_configtab_a.png" width="201pt" format="PNG"/>
      </imageobject>
     </mediaobject>
    </informalfigure>
   </step>
   <step>
    <para>
     <guimenu>OK</guimenu>をクリックして、変更内容を保存して適用します。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.fcoe.cli">
  <title>コマンドを使用したFCoEの設定</title>

  <procedure>
   <step>
    <para>
     端末コンソールを開きます。
    </para>
   </step>
   <step>
    <para>
     YaSTを使用して、Ethernetネットワークインタフェースカード(<filename>eth2</filename>など)を設定します。
    </para>
   </step>
   <step>
    <para>
     Link Layer Discovery Protocolエージェントデーモン(<systemitem class="daemon">llpad</systemitem>)を起動します。
    </para>
<screen>sudo systemctl start lldpad</screen>
   </step>
   <step>
    <para role="intro">
     お使いのEthernetアダプタ上で、データセンターブリッジングを有効にします。
    </para>
<screen><prompt>tux &gt; </prompt>dcbtool sc eth2 dcb on
  Version:       2
  Command:       Set Config
  Feature:       DCB State
  Port:          eth2
  Status:        Successful</screen>
   </step>
   <step>
    <para>
     Priority Flow Control (PFC)設定を、データセンターブリッジングに対して有効にします。
    </para>
<screen>sudo dcbtool sc eth&lt;x&gt; pfc e:1 a:1 w:1</screen>
    <para>
     引数の設定値は次のとおりです。
    </para>
    <variablelist>
     <varlistentry xml:id="bynkj1s">
      <term>e:&lt;0|1&gt;</term>
      <listitem>
       <para>
        機能の有効化を制御します。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="bynkjej">
      <term>a:&lt;0|1&gt;</term>
      <listitem>
       <para>
        機能を、データセンターブリッジング交換プロトコルを介してピアにアドバタイズするかどうかを制御します。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="bynkjy8">
      <term>w:&lt;0|1&gt;</term>
      <listitem>
       <para>
        機能が、ピアから受け取った内容に基づいてその運用設定を積極的に変更するかどうかを制御します。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </step>
   <step>
    <para>
     データセンターブリッジングを有効にして、FCoEに対するスイッチの優先度設定を受け入れます。
    </para>
<screen><prompt>tux &gt; </prompt>sudo dcbtool sc eth2 app:fcoe e:1
  Version:       2
  Command:       Set Config
  Feature:       Application FCoE
  Port:          eth2
  Status:        Successful</screen>
   </step>
   <step>
    <para>
     デフォルトのFCoE環境設定ファイルを、<filename>/etc/fcoe/cfg-eth2</filename>にコピーします。
    </para>
<screen>sudo cp /etc/fcoe/cfg-ethx /etc/fcoe/cfg-eth2</screen>
   </step>
   <step>
    <para>
     FCoEイニシエータサービスを開始します。
    </para>
<screen>systemctl start fcoe.status</screen>
   </step>
   <step>
    <para>
     Link Layer Discovery Protocolエージェントデーモン(<systemitem class="daemon">llpad</systemitem>)およびFCoEイニシエータサービスを、起動時に開始するよう設定します。
    </para>
<screen>systemctl enable llpad fcoe</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.fcoe.admin">
  <title>FCoE管理ツールを使用したFCoEインスタンスの管理</title>

  <para>
   <command>fcoeadm</command>ユーティリティは、FCoE (Fibre Channel over Ethernet)管理ツールです。これを使用して、所定のネットワークインタフェースのFCoEインスタンスの作成、破棄、およびリセットを行うことができます。<command>fcoeadm</command>ユーティリティは、ソケットインタフェースを通じて、実行中の<systemitem class="daemon">fcoemon</systemitem>プロセスにコマンドを送ります。<command>fcoemon</command>の詳細については、<command>man 8 fcoemon</command>を参照してください。
  </para>

  <para>
   <command>fcoeadm</command>ユーティリティを使用して、以下に関してFCoEインスタンスにクエリを行うことができます。
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     インタフェース
    </para>
   </listitem>
   <listitem>
    <para>
     ターゲットLUN
    </para>
   </listitem>
   <listitem>
    <para>
     ポートの統計データ
    </para>
   </listitem>
  </itemizedlist>

  <para>
   <command>fcoeadm</command>ユーティリティは、<filename>fcoe-utils</filename>パッケージの一部です。このコマンドの一般的な構文は、次のようになります。
  </para>

<screen>fcoeadm
  [-c|--create] [&lt;ethX&gt;]
  [-d|--destroy] [&lt;ethX&gt;]
  [-r|--reset] [&lt;ethX&gt;]
  [-S|--Scan] [&lt;ethX&gt;]
  [-i|--interface] [&lt;ethX&gt;]
  [-t|--target] [&lt;ethX&gt;]
  [-l|--lun] [&lt;ethX&gt;]
  [-s|--stats &lt;ethX&gt;] [&lt;interval&gt;]
  [-v|--version]
  [-h|--help]
</screen>

  <para>
   詳細については、<command>man 8 fcoeadm</command>を参照してください。
  </para>

  <bridgehead>例</bridgehead>

  <variablelist>
   <varlistentry>
    <term><command>fcoeadm -c eth2.101</command>
    </term>
    <listitem>
     <para>
      FCoEインスタンスをeth2.101上に作成します。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>fcoeadm -d eth2.101</command>
    </term>
    <listitem>
     <para>
      FCoEインスタンス上のeth2.101を破棄します。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>fcoeadm -i eth3</command>
    </term>
    <listitem>
     <para>
      インタフェース<literal>eth3</literal>上のFCoEインスタンスすべてに関する情報を表示します。インタフェースが指定されていない場合、FCoEインスタンスが作成されているすべてのインタフェースの情報を表示します。次に、接続eth0.201の情報の例を示します。
     </para>
<screen><prompt>tux &gt; </prompt>sudo fcoeadm -i eth0.201
  Description:      82599EB 10-Gigabit SFI/SFP+ Network Connection 
  Revision:         01
  Manufacturer:     Intel Corporation 
  Serial Number:    001B219B258C 
  Driver:           ixgbe 3.3.8-k2 
  Number of Ports:  1      

      Symbolic Name:     fcoe v0.1 over eth0.201     
      OS Device Name:    host8     
      Node Name:         0x1000001B219B258E     
      Port Name:         0x2000001B219B258E     
      FabricName:        0x2001000573D38141     
      Speed:             10 Gbit     
      Supported Speed:   10 Gbit     
      MaxFrameSize:      2112     
      FC-ID (Port ID):   0x790003     
      State:             Online
</screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>fcoeadm -l eth3.101</command>
    </term>
    <listitem>
     <para>
      接続eth3.101で検出されたすべてのLUNの詳細情報を表示します。接続が指定されていない場合、すべてのFCoE接続で検出されたすべてのLUNの情報を表示します。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>fcoeadm -r eth2.101</command>
    </term>
    <listitem>
     <para>
      eth2.101上のFCoEインスタンスをリセットします。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>fcoeadm -s eth3 3</command>
    </term>
    <listitem>
     <para>
      FCoEインスタンスが存在する特定のeth3ポートに関する統計情報を3秒間隔で表示します。統計情報は、時間間隔ごとに1行ずつ表示されます。間隔を指定していない場合、デフォルトの1秒が間隔として使用されます。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>fcoeadm -t eth3</command>
    </term>
    <listitem>
     <para>
      FCoEインスタンスが存在する特定のeth3ポートから検出されたすべてのターゲットに関する情報を表示します。検出された各ターゲットの後ろに、関連付けられたLUNが列記されます。インスタンスが指定されていない場合、FCoEインスタンスが存在するすべてのポートからのターゲットを表示します。次に、接続eth0.201からのターゲットの情報の例を示します。
     </para>
<screen><prompt>tux &gt; </prompt>sudo fcoeadm -t eth0.201  
  Interface:        eth0.201 
  Roles:            FCP Target 
  Node Name:        0x200000D0231B5C72 
  Port Name:        0x210000D0231B5C72 
  Target ID:        0 
  MaxFrameSize:     2048 
  OS Device Name:   rport-8:0-7 
  FC-ID (Port ID):  0x79000C 
  State:            Online  

LUN ID  Device Name   Capacity   Block Size  Description 
------  -----------  ----------  ----------  ----------------------------     
    40  /dev/sdqi     792.84 GB      512     IFT DS S24F-R2840-4 (rev 386C)
    72  /dev/sdpk     650.00 GB      512     IFT DS S24F-R2840-4 (rev 386C)
   168  /dev/sdgy       1.30 TB      512     IFT DS S24F-R2840-4 (rev 386C)
</screen>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec.fcoe.info">
  <title>追加情報</title>

  <para>
   詳細については、以下のマニュアルを参照してください。
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     Open-FCoEのサービスデーモンについては、<command>fcoemon(8)</command>マニュアルページを参照してください。
    </para>
   </listitem>
   <listitem>
    <para>
     Open-FCoEの管理ツールについては、<command>fcoeadm(8)</command>マニュアルページを参照してください。
    </para>
   </listitem>
   <listitem>
    <para>
     データセンターブリッジング設定ツールについては、<command>dcbtool(8)</command>マニュアルページを参照してください。
    </para>
   </listitem>
   <listitem>
    <para>
     Link Layer Discovery Protocolエージェントデーモンについては、<filename>lldpad(8)</filename>マニュアルページを参照してください。
    </para>
   </listitem>
   <listitem>
    <para>
      一般的な情報は、Open-FCoEホームページ(<link xlink:href="http://www.open-fcoe.org/dokuwiki/start"/>)を参照してください。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
