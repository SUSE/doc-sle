<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="kernel_modules.xml" version="5.0" xml:id="cha-mod">
 <title>Gerenciando módulos do kernel</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <para>
   Embora o Linux seja um kernel monolítico, ele pode ser ampliado usando módulos do kernel. Esses são objetos especiais que podem ser inseridos no kernel e removidos sob demanda. Em termos práticos, os módulos do kernel tornam possível adicionar e remover drivers e interfaces que não estão incluídos no próprio kernel. O Linux dispõe de vários comandos para gerenciar módulos do kernel.
 </para>
 <sect1 xml:id="sec-mod-lsmod">
  <title>Listando módulos carregados com lsmod e modinfo</title>
  <para>
    Use o comando <command>lsmod</command> para ver os módulos do kernel que estão carregados no momento. A saída do comando pode ter a seguinte aparência:
  </para>
  <screen><prompt>&gt; </prompt>lsmod
Module                  Size  Used by
snd_usb_audio         188416  2
snd_usbmidi_lib        36864  1 snd_usb_audio
hid_plantronics        16384  0
snd_rawmidi            36864  1 snd_usbmidi_lib
snd_seq_device         16384  1 snd_rawmidi
fuse                  106496  3
nfsv3                  45056  1
nfs_acl                16384  1 nfsv3</screen>
  <para>
    A saída é dividida em três colunas. A coluna <literal>Module</literal> (Módulo) lista os nomes dos módulos carregados, enquanto a coluna <literal>Size</literal> (Tamanho) exibe o tamanho de cada módulo. A coluna <literal>Used by</literal> (Usado por) mostra o número de módulos de referência e seus nomes. Observe que essa lista pode estar incompleta.
  </para>
  <para>
    Para ver informações detalhadas sobre um módulo do kernel específico, use o comando <command>modinfo <replaceable>NOME_DO_MÓDULO</replaceable></command>, em que <replaceable>NOME_DO_MÓDULO</replaceable> é o nome do módulo do kernel desejado. Observe que o binário <command>modinfo</command> reside no diretório <filename>/sbin</filename>, que não está na variável de ambiente PATH do usuário. Isso significa que você deve especificar o caminho completo para o binário ao executar o comando <command>modinfo</command> como um usuário comum:
  </para>
  <screen><prompt>&gt; </prompt>/sbin/modinfo kvm
filename:       /lib/modules/5.3.18-57-default/kernel/arch/x86/kvm/kvm.ko.xz
license:        GPL
author:         Qumranet
suserelease:    SLE15-SP3
srcversion:     3D8FBA9060D4537359A06FC
depends:        irqbypass
supported:      yes
retpoline:      Y
intree:         Y
name:           kvm
vermagic:       5.3.18-57-default SMP mod_unload modversions 
      </screen>
  </sect1>
  <sect1 xml:id="sec-mod-modprobe">
    <title>Adicionando e removendo módulos do kernel</title>
    <para>
      Embora seja possível usar <systemitem>insmod</systemitem> e <systemitem>rmmod</systemitem> para adicionar e remover módulos do kernel, em vez disso, é recomendável usar a ferramenta <systemitem>modprobe</systemitem>. <systemitem>modprobe</systemitem> oferece diversas vantagens importantes, incluindo a resolução automática de dependências e a criação de lista negra.
    </para>
    <para>
      Quando usado sem parâmetros, o comando <systemitem>modprobe</systemitem> instala um módulo do kernel especificado. O <systemitem>modprobe</systemitem> deve ser executado com privilégios de root:
    </para>
    <screen><prompt>&gt; </prompt><command>sudo</command> modprobe acpi</screen>
    <para>
      Para remover um módulo do kernel, use o parâmetro <command>-r</command>:
    </para>
    <screen><prompt>&gt; </prompt><command>sudo</command> modprobe -r acpi</screen>
    <sect2 xml:id="sec-mod-modprobe-d">
    <title>Carregando módulos do kernel automaticamente na inicialização</title>
    <para>
      Em vez de carregar os módulos do kernel manualmente, você pode carregá-los automaticamente durante o processo de boot usando o serviço <systemitem>system-modules-load.service</systemitem>. Para habilitar um módulo do kernel, adicione um arquivo <filename>.conf</filename> ao diretório <filename>/etc/modules-load.d/</filename>. Convém dar ao arquivo de configuração o mesmo nome do módulo. Por exemplo:</para>
    <screen>/etc/modules-load.d/rt2800usb.conf</screen>
    <para>
      O arquivo de configuração deve conter o nome do módulo do kernel desejado (por exemplo, <literal>rt2800usb</literal>).
    </para>
    <para>
      A técnica descrita permite que você carregue os módulos do kernel sem parâmetros. Se você precisar carregar um módulo do kernel com opções específicas, em vez disso, adicione um arquivo de configuração ao diretório <filename>/etc/modprobe.d/</filename>. O arquivo deve ter a extensão <filename>.conf</filename>. O nome do arquivo deve cumprir a seguinte convenção de nomeação: <literal>prioridade-nomedomódulo.conf</literal>. Por exemplo: <filename>50-thinkfan.conf</filename>. O arquivo de configuração deve conter o nome do módulo do kernel e os parâmetros desejados. Você pode usar o comando de exemplo a seguir para criar um arquivo de configuração com o nome do módulo do kernel e seus parâmetros:</para>
      <screen><prompt>&gt; </prompt>echo "options thinkpad_acpi fan_control=1" | sudo tee /etc/modprobe.d/thinkfan.conf</screen>

      <note>
        <title>Carregando módulos do kernel</title>
        <para>
          A maioria dos módulos do kernel é carregada pelo sistema automaticamente quando um dispositivo é detectado ou o espaço do usuário requer funcionalidades específicas. Portanto, a adição manual de módulos a <filename>/etc/modules-load.d/</filename> raramente é necessária.
         </para>
        </note>

    </sect2>
    <sect2 xml:id="sec-mod-modprobe-blacklist">
    <title>Adicionando módulos do kernel à lista negra com modprobe</title>
    <para>
      A adição de um módulo do kernel à lista negra o impede de ser carregado durante o processo de boot. Isso pode ser útil quando você deseja desabilitar um módulo que você suspeita ser a causa de problemas no sistema. Você ainda pode carregar manualmente os módulos do kernel que constam na lista negra usando as ferramentas <systemitem>insmod</systemitem> ou <systemitem>modprobe</systemitem>.
    </para>
    <para>
      Para adicionar um módulo à lista negra, crie um arquivo <filename>/etc/modprobe.d/60-blacklist-<replaceable>MODULE_NAME</replaceable>.conf</filename> com o seguinte conteúdo:
    </para>
    <screen>blacklist <replaceable>MODULE_NAME</replaceable></screen>
    <para>
      Execute o comando <command>dracut</command> como root para gerar uma nova imagem do <systemitem>initrd</systemitem> e reinicialize sua máquina (substitua <replaceable>NAME</replaceable> pelo nome do initrd atual e <replaceable>KERNELVERSION</replaceable> pelo kernel que está em execução):
    </para>
    <screen><prompt>&gt; </prompt>su
echo "blacklist nouveau" &gt;&gt; /etc/modprobe.d/60-blacklist-nouveau.conf
/usr/bin/dracut --logfile /var/log/YaST2/mkinitrd.log --force /boot/$initrd-<replaceable>NAME</replaceable> $<replaceable>KERNELVERSION</replaceable>
reboot</screen>
    <para>
      Para desabilitar um módulo do kernel apenas temporariamente, inclua-o na lista negra diretamente durante a inicialização. Para fazer isso, pressione a tecla <keycap>E</keycap> quando aparecer a tela de boot. Essa ação direciona você para um editor mínimo que permite modificar os parâmetros de boot. Localize a linha que tem a seguinte aparência:
    </para>
    <screen>linux /boot/vmlinuz...splash= silent quiet showopts</screen>
    <para>
      Adicione o comando <command>modprobe.blacklist=<replaceable>NOME_DO_MÓDULO</replaceable></command> ao fim da linha. Por exemplo:
    </para>
    <screen>linux /boot/vmlinuz...splash= silent quiet showopts modprobe.blacklist=nouveau</screen>
    <para>
      Pressione <keycap>F10</keycap> ou <keycombo><keycap function="control"/><keycap>X</keycap></keycombo> para inicializar com a configuração especificada.
    </para>
    <para>
      Para adicionar um módulo do kernel à lista negra permanentemente pelo GRUB, abra o arquivo <filename>/etc/default/grub</filename> para edição e adicione a opção <command>modprobe.blacklist=<replaceable>NOME_DO_MÓDULO</replaceable></command> ao comando <command>GRUB_CMD_LINUX</command>. Em seguida, execute o comando <command>sudo grub2-mkconfig -o /boot/grub2/grub.cfg</command> para habilitar as mudanças.
    </para>
    </sect2>
 </sect1>
</chapter>
