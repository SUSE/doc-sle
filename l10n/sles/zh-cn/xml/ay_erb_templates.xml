<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ay_erb_templates.xml" version="5.0" xml:id="erb-templates">

 <title>ERB 模板</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>是</dm:translation>
  </dm:docmanager>
 </info>

  <para>
   ERB 模板允许在配置文件中嵌入一些 Ruby 代码，以在安装期间修改配置文件。利用此方法，您可以通过设置值、添加或跳过某些部分等方式，来检查系统并调整配置文件。
  </para>

  <para>
   要激活 ERB 处理，配置文件的扩展名必须为 <filename>.erb</filename>（例如，<filename>autoyast.xml.erb</filename>）。之后，它将无法合并规则/类和 ERB 模板。
  </para>

  <sect1 xml:id="erb">
   <title>什么是 <literal>ERB</literal>？</title>

   <para>
    <literal>ERB</literal> 即 <emphasis>Embedded Ruby</emphasis>，可让您使用 Ruby 编程语言的强大功能来生成不同类型的内容。利用 <literal>ERB</literal>，您可以在配置文件中包含一些 Ruby 代码，以在运行时根据安装系统调整配置文件。
   </para>

   <para>
    使用 ERB 时，Ruby 代码包含在 <literal>&lt;%</literal> 和 <literal>&gt;</literal> 符号之间。如果您希望将命令输出包含在最终的配置文件中，只需添加一个等号 (<literal>=</literal>) 即可。
   </para>

   <example xml:id="simple-erb">
    <title>使用 ERB 包含文件</title>
    <screen>&lt;bootloader&gt;
  &lt;% require "open-uri" %&gt;
  &lt;%= URI.open("http://192.168.1.1/profiles/bootloader-common.xml").read %&gt;
&lt;/bootloader&gt;</screen>
   </example>

   <para>
     AutoYaST 提供了一小组<emphasis>帮助程序函数</emphasis>，以从底层系统中检索信息（例如 <literal>disks</literal> 或 <literal>network_cards</literal>）。您可以在<xref linkend="erb-helpers"/>中查看帮助程序及值列表。
   </para>
  </sect1>

  <sect1 xml:id="erb-helpers">
   <title>模板帮助程序</title>

   <para>
    模板帮助程序是 Ruby 方法的集合，可用于配置文件中以检索安装系统的相关信息。
   </para>

   <sect2 xml:id="erb-disks-helper">
    <title><literal>disks</literal></title>

    <para>
     <literal>disks</literal> 帮助程序可返回检测到的磁盘列表。列表的每个元素包含一些基本信息，例如设备名称或大小。
    </para>

    <informaltable>
     <tgroup cols="3">
      <thead>
       <row>
        <entry>
         <para>
          键
         </para>
        </entry>
        <entry>
         <para>
          类型
         </para>
        </entry>
        <entry>
         <para>
          值
         </para>
        </entry>
       </row>
      </thead>
      <tbody>
       <row>
        <entry>
         <para>
          <literal>:device</literal>
         </para>
        </entry>
        <entry>
         <para>
          字符串
         </para>
        </entry>
        <entry>
         <para>
          设备内核名称（例如 <literal>sda</literal>）。
         </para>
        </entry>
       </row>
       <row>
        <entry>
         <para>
          <literal>:model</literal>
         </para>
        </entry>
        <entry>
         <para>
          字符串
         </para>
        </entry>
        <entry>
         <para>
          磁盘型号
         </para>
        </entry>
       </row>
       <row>
        <entry>
         <para>
          <literal>:serial</literal>
         </para>
        </entry>
        <entry>
         <para>
          字符串
         </para>
        </entry>
        <entry>
         <para>
          序列号
         </para>
        </entry>
       </row>
       <row>
        <entry>
         <para>
          <literal>:size</literal>
         </para>
        </entry>
        <entry>
         <para>
          整数
         </para>
        </entry>
        <entry>
         <para>
          磁盘大小（以字节为单位）
         </para>
        </entry>
       </row>
       <row>
        <entry>
         <para>
          <literal>:udev_names</literal>
         </para>
        </entry>
        <entry>
         <para>
          字符串数组
         </para>
        </entry>
        <entry>
         <para>
          磁盘 udev 名称列表。您可以使用其中的任何名称来表示设备。
         </para>
        </entry>
       </row>
       <row>
        <entry>
         <para>
          <literal>:vendor</literal>
         </para>
        </entry>
        <entry>
         <para>
          字符串
         </para>
        </entry>
        <entry>
         <para>
          磁盘供应商名称
         </para>
        </entry>
       </row>
      </tbody>
     </tgroup>
    </informaltable>

    <para>
     以下示例中的配置文件会在最大的磁盘上安装系统。它会按大小对现有磁盘列表排序，然后使用最后一个磁盘。之后，它会使用 <literal>:device</literal> 键作为 <literal>device</literal> 元素的值。
    </para>

    <example>
     <title>使用最大的磁盘</title>
      <screen>&lt;partitioning t="list"&gt;
  &lt;drive&gt;
    &lt;% disk = disks.sort_by { |d| d[:size] }.last %&gt; &lt;!-- find the largest disk --&gt;
    &lt;device&gt;&lt;%= disk[:device] %&gt;&lt;/device&gt; &lt;!-- print the disk device name --&gt;
    &lt;initialize t="boolean"&gt;true&lt;/initialize&gt;
    &lt;use&gt;all&lt;/use&gt;
  &lt;/drive&gt;
&lt;/partitioning&gt;
     </screen>
    </example>

   </sect2>

   <sect2 xml:id="erb-network-cards-helper">
    <title><literal>network_cards</literal></title>

    <para>
     <literal>network_cards</literal> 帮助程序可返回网卡列表，包括网卡名称，状态信息（例如，它们是否已连接）。
    </para>

    <informaltable>
     <tgroup cols="3">
      <thead>
       <row>
        <entry>
         <para>
          键
         </para>
        </entry>
        <entry>
         <para>
          类型
         </para>
        </entry>
        <entry>
         <para>
          值
         </para>
        </entry>
       </row>
      </thead>
      <tbody>
       <row>
        <entry>
         <para>
          <literal>:device</literal>
         </para>
        </entry>
        <entry>
         <para>
          字符串
         </para>
        </entry>
        <entry>
         <para>
          设备名称（例如 <literal>eth0</literal> 或 <literal>enp3s0</literal>）
         </para>
        </entry>
       </row>
       <row>
        <entry>
         <para>
          <literal>:mac</literal>
         </para>
        </entry>
        <entry>
         <para>
          字符串
         </para>
        </entry>
        <entry>
         <para>
          MAC 地址
         </para>
        </entry>
       </row>
       <row>
        <entry>
         <para>
          <literal>:active</literal>
         </para>
        </entry>
        <entry>
         <para>
          布尔
         </para>
        </entry>
        <entry>
         <para>
          设备是否处于活动状态
         </para>
        </entry>
       </row>
       <row>
        <entry>
         <para>
          <literal>:link</literal>
         </para>
        </entry>
        <entry>
         <para>
          布尔
         </para>
        </entry>
        <entry>
         <para>
          设备是否已连接
         </para>
        </entry>
       </row>
       <row>
        <entry>
         <para>
          <literal>:vendor</literal>
         </para>
        </entry>
        <entry>
         <para>
          字符串
         </para>
        </entry>
        <entry>
         <para>
          磁盘供应商名称
         </para>
        </entry>
       </row>
      </tbody>
     </tgroup>
    </informaltable>

    <para>
     下面的示例会找到最先连接网络的网卡，并将其配置为使用 DHCP。
    </para>

   <example>
    <title>配置连接的网卡</title>
     <screen>&lt;interfaces t="list"&gt;
  &lt;% with_link = netword_cards.sort_by { |n| n[:name] }.find { |n| n[:link] } %&gt;
  &lt;% if with_link %&gt;
    &lt;interface&gt;
      &lt;device&gt;&lt;%= with_link[:device] %&gt;&lt;/device&gt;
      &lt;startmode&gt;auto&lt;/startmode&gt;
      &lt;bootproto&gt;dhcp&lt;/bootproto&gt;
      &lt;/interface&gt;
  &lt;% end &gt;
&lt;/interfaces&gt;
    </screen>
   </example>
   </sect2>

   <sect2 xml:id="erb-os-release-helper">
    <title><literal>os_release</literal></title>

    <para>
     <literal>os_release</literal> 帮助程序可返回操作系统信息，这些信息包含在 <filename>/etc/os-release</filename> 文件中。
    </para>

    <informaltable>
     <tgroup cols="3">
      <thead>
       <row>
        <entry>
         <para>
          键
         </para>
        </entry>
        <entry>
         <para>
          类型
         </para>
        </entry>
        <entry>
         <para>
          值
         </para>
        </entry>
       </row>
      </thead>
      <tbody>
       <row>
        <entry>
         <para>
          <literal>:id</literal>
         </para>
        </entry>
        <entry>
         <para>
          字符串
         </para>
        </entry>
        <entry>
         <para>
          发行套件 ID（例如 <literal>sles</literal>、<literal>opensuse-tumbleweed</literal>）
         </para>
        </entry>
       </row>
       <row>
        <entry>
         <para>
          <literal>:name</literal>
         </para>
        </entry>
        <entry>
         <para>
          字符串
         </para>
        </entry>
        <entry>
         <para>
          发行套件名称（例如 <literal>SLES</literal> 或 <literal>openSUSE Tumbleweed</literal>）
         </para>
        </entry>
       </row>
       <row>
        <entry>
         <para>
          <literal>:version</literal>
         </para>
        </entry>
        <entry>
         <para>
          字符串
         </para>
        </entry>
        <entry>
         <para>
          发行套件版本（例如 <literal>15.2</literal>）
         </para>
        </entry>
       </row>
      </tbody>
     </tgroup>
    </informaltable>

    <para>
     您可以使用这些信息决定要安装的产品，对所有发行套件（SLE 或 openSUSE 发行套件）使用几乎相同的配置文件。
    </para>

    <example>
     <title>对不同的发行套件重复使用相同的配置文件</title>
     <screen>&lt;products t="list"&gt;
  &lt;% if os_release[:id] == 'sle' %&gt;
  &lt;product&gt;SLES&lt;/product&gt;
  &lt;% else %&lt;
  &lt;product&gt;openSUSE&lt;/product&gt;
  &lt;% end %&lt;
&lt;/products&gt;</screen>
        </example>
    </sect2>
   </sect1>
 </chapter>
