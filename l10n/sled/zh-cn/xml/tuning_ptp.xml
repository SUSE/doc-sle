<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="tuning_ptp.xml" version="5.0" xml:id="cha-tuning-ptp">
 <title>精确时间协议</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <para>
  对于网络环境而言，让计算机和其他设备的时钟保持同步和准确至关重要。有多种解决方案可实现此目的，例如，使用<xref linkend="cha-ntp"/>中所述的广泛使用的网络时间协议 (NTP)。
 </para>
 <para>
  精确时间协议 (PTP) 支持亚微秒级准确性，较 NTP 更优。PTP 支持分为内核和用户空间。<phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 中的内核包含对网络驱动程序提供的 PTP 时钟的支持。
 </para>
 <sect1 xml:id="tuning-ptp-intro">
  <title>PTP 简介</title>

  <para>
   PTP 管理的时钟遵循主从层次结构。从属时钟将同步到其主时钟。层次结构由每个时钟上运行的<emphasis>最佳主时钟</emphasis> (BMC) 算法更新。只有一个端口的时钟可以是主时钟也可以是从属时钟。此类时钟称为<emphasis>普通时钟</emphasis> (OC)。具有多个端口的时钟可以是一个端口上的主时钟以及另一个端口上的从属时钟。此类时钟称为<emphasis>边界时钟</emphasis> (BC)。顶层主时钟称为<emphasis>超级主时钟</emphasis>。超级主时钟可与全球定位系统 (GPS) 同步。这样，不同的网络便能够以高准确度实现同步。
  </para>

  <para>
   硬件支持是 PTP 的主要优势。各种网络交换机和网络接口控制器 (NIC) 都支持 PTP。虽然可以在网络内部使用启用非 PTP 的硬件，但为所有 PTP 时钟之间的网络组件启用 PTP 硬件可实现最大的准确性。
  </para>

  <sect2 xml:id="tuning-ptp-linuxptp">
   <title>PTP Linux 实施</title>
   <para>
    在 <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 上，由 <systemitem>linuxptp</systemitem> 软件包提供 PTP 实施。使用 <command>zypper
    install linuxptp</command> 安装该软件包：其中包含用于时钟同步的 <command>ptp4l</command> 和 <command>phc2sys</command> 程序。<command>ptp4l</command> 实施 PTP 边界时钟和普通时钟。如果启用硬件时戳，<command>ptp4l</command> 会将 PTP 硬件时钟同步到主时钟。如果使用软件时戳，它会将系统时钟同步到主时钟。仅当使用硬件时戳将系统时钟同步到网络接口卡 (NIC) 上的 PTP 硬件时钟时，才需要 <command>phc2sys</command>。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="tuning-ptp-using">
  <title>使用 PTP</title>

  <para/>

  <sect2 xml:id="tuning-ptp-driver-support">
   <title>网络驱动程序和硬件支持</title>
   <para>
    PTP 要求使用的内核网络驱动程序支持软件时戳或硬件时戳。此外，NIC 还必须支持物理硬件中的时戳。您可以使用 <command>ethtool</command> 校验驱动程序和 NIC 时戳功能：
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> ethtool -T eth0
Time stamping parameters for eth0:
Capabilities:
hardware-transmit     (SOF_TIMESTAMPING_TX_HARDWARE)
        software-transmit     (SOF_TIMESTAMPING_TX_SOFTWARE)
        hardware-receive      (SOF_TIMESTAMPING_RX_HARDWARE)
        software-receive      (SOF_TIMESTAMPING_RX_SOFTWARE)
        software-system-clock (SOF_TIMESTAMPING_SOFTWARE)
        hardware-raw-clock    (SOF_TIMESTAMPING_RAW_HARDWARE)
PTP Hardware Clock: 0
Hardware Transmit Timestamp Modes:
        off                   (HWTSTAMP_TX_OFF)
        on                    (HWTSTAMP_TX_ON)
Hardware Receive Filter Modes:
        none                  (HWTSTAMP_FILTER_NONE)
        all                   (HWTSTAMP_FILTER_ALL)</screen>
   <para>
    软件时戳需要以下参数：
   </para>
<screen>SOF_TIMESTAMPING_SOFTWARE
SOF_TIMESTAMPING_TX_SOFTWARE
SOF_TIMESTAMPING_RX_SOFTWARE</screen>
   <para>
    硬件时戳需要以下参数：
   </para>
<screen>SOF_TIMESTAMPING_RAW_HARDWARE
SOF_TIMESTAMPING_TX_HARDWARE
SOF_TIMESTAMPING_RX_HARDWARE</screen>
  </sect2>

  <sect2 xml:id="tuning-ptp-ptp41">
   <title>使用 <command>ptp4l</command></title>
   <para>
    <command>ptp4l</command> 默认使用硬件时戳。您需要以 <systemitem class="username">root</systemitem> 身份使用 <option>-i</option> 选项指定支持硬件时戳的网络接口。<option>-m</option> 指示 <command>ptp4l</command> 将其输出列显到标准输出，而不是列显到系统的日志记录工具：
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> ptp4l -m -i eth0
selected eth0 as PTP clock
port 1: INITIALIZING to LISTENING on INITIALIZE
port 0: INITIALIZING to LISTENING on INITIALIZE
port 1: new foreign master 00a152.fffe.0b334d-1
selected best master clock 00a152.fffe.0b334d
port 1: LISTENING to UNCALIBRATED on RS_SLAVE
master offset -25937 s0 freq +0 path delay       12340
master offset -27887 s0 freq +0 path delay       14232
master offset -38802 s0 freq +0 path delay       13847
master offset -36205 s1 freq +0 path delay       10623
master offset  -6975 s2 freq -30575 path delay   10286
port 1: UNCALIBRATED to SLAVE on MASTER_CLOCK_SELECTED
master offset  -4284 s2 freq -30135 path delay    9892</screen>
   <para>
    <literal>master offset</literal> 值表示测得的与主时钟之间的偏差（以纳秒为单位）。
   </para>
   <para>
    <literal>s0</literal>、<literal>s1</literal>、<literal>s2</literal> 指示器显示时钟伺服的不同状态：<literal>s0</literal> 表示已解锁，<literal>s1</literal> 表示时钟步进，<literal>s2</literal> 表示已锁定。如果伺服处于已锁定状态 (<literal>s2</literal>)，并且 <option>pi_offset_const</option> 选项在配置文件中设置为负值，则时钟不会步进，而只会缓慢调整（有关详细信息，请参见 <command>man 8
    ptp4l</command>）。
   </para>
   <para>
    <literal>freq</literal> 值表示时钟的频率调整（以十亿分率 (ppb) 为单位）。
   </para>
   <para>
    <literal>path delay</literal> 值表示从主时钟发送的同步消息的预计延迟（以纳秒为单位）。
   </para>
   <para>
    端口 0 是用于本地 PTP 管理的 Unix 域套接字。端口 1 是 <systemitem>eth0</systemitem> 接口。
   </para>
   <para>
    <literal>INITIALIZING</literal>、<literal>LISTENING</literal>、<literal>UNCALIBRATED</literal> 和 <literal>SLAVE</literal> 是根据 <literal>INITIALIZE</literal>、<literal>RS_SLAVE</literal> 和 <literal>MASTER_CLOCK_SELECTED</literal> 事件更改的端口状态的示例。当端口状态从 <literal>UNCALIBRATED</literal> 更改为 <literal>SLAVE</literal> 时，表示计算机已与 PTP 主时钟成功同步。
   </para>
   <para>
    您可以使用 <option>-S</option> 选项启用软件时戳。
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> ptp4l -m -S -i eth3</screen>
   <para>
    您还可以将 <command>ptp4l</command> 作为服务运行：
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl start ptp4l</screen>
   <para>
    在本例中，<command>ptp4l</command> 从 <filename>/etc/sysconfig/ptp4l</filename> 文件读取其选项。默认情况下，此文件指示 <command>ptp4l</command> 从 <filename>/etc/ptp4l.conf</filename> 读取配置选项。有关 <command>ptp4l</command> 选项和配置文件设置的详细信息，请参见 <command>man 8 ptp4l</command>。
   </para>
   <para>
    要永久启用 <command>ptp4l</command> 服务，请运行以下命令：
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl enable ptp4l</screen>
   <para>
    要禁用该服务，请运行
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl disable ptp4l</screen>
  </sect2>

  <sect2 xml:id="tuning-ptp-confile">
   <title><command>ptp4l</command> 配置文件</title>
   <para>
    <command>ptp4l</command> 可以从可选的配置文件读取其配置。由于默认未使用任何配置文件，您需要通过 <option>-f</option> 指定配置文件。
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> ptp4l -f /etc/ptp4l.conf</screen>
   <para>
    配置文件分为若干部分。全局部分（以 <literal>[global]</literal> 指示）用于设置程序选项、时钟选项和默认端口选项。其他部分与特定的端口相关，会覆盖默认端口选项。部分的名称是配置的端口的名称 — 例如 <literal>[eth0]</literal>。空白端口部分可用于替换命令行选项。
   </para>
<screen>[global]
verbose               1
time_stamping         software
[eth0]</screen>
   <para>
    示例配置文件等效于以下命令选项：
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> ptp4l -i eth0 -m -S</screen>
   <para>
    有关完整的 <command>ptp4l</command> 配置选项列表，请参见 <command>man 8 ptp4l</command>。
   </para>
  </sect2>

  <sect2 xml:id="tuning-ptp-delay-measurement">
   <title>延迟测量</title>
   <para>
    <command>ptp4l</command> 通过两种方法测量时间延迟：<emphasis>对等式</emphasis> (P2P) 或<emphasis>端到端</emphasis> (E2E)。
   </para>
   <variablelist>
    <varlistentry>
     <term>P2P</term>
     <listitem>
      <para>
       此方法使用 <option>-P</option> 指定。
      </para>
      <para>
       它可以更快地对网络环境中的更改做出反应，并更准确地测量延迟。仅在每个端口都会与另一个端口交换 PTP 消息的网络中才会使用此方法。P2P 需受到通讯路径中所有硬件的支持。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>E2E</term>
     <listitem>
      <para>
       此方法使用 <option>-E</option> 指定。此为默认设置。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>自动选择方法</term>
     <listitem>
      <para>
       此方法使用 <option>-A</option> 指定。自动选项以 E2E 模式启动 <command>ptp4l</command>，如果收到了对等延迟请求，则更改为 P2P 模式。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <important>
    <title>常用测量方法</title>
    <para>
     单个 PTP 通讯路径上的所有时钟必须使用相同的方法来测量时间延迟。如果在使用 E2E 机制的端口上收到了对等延迟请求，或者在使用 P2P 机制的端口上收到了 E2E 延迟请求，将会列显警告。
    </para>
   </important>
  </sect2>

  <sect2 xml:id="tuning-ptp-pmc">
   <title>PTP 管理客户端：<command>pmc</command></title>
   <para>
    可以使用 <command>pmc</command> 客户端获取有关 <command>ptp41</command> 的更详细信息。pmc 从标准输入或命令行读取按名称和管理 ID 指定的操作。然后通过选定的传输发送操作，并列显收到的任何答复。支持三种操作：<command>GET</command> 检索指定的信息，<command>SET</command> 更新指定的信息，<command>CMD</command>（或 <command>COMMAND</command>）发起指定的事件。
   </para>
   <para>
    默认情况下，管理命令会在所有端口上寻址。可以使用 <command>TARGET</command> 命令为后续消息选择特定的时钟和端口。如需完整的管理 ID 列表，请运行 <command>pmc help</command>。
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> pmc -u -b 0 'GET TIME_STATUS_NP'
sending: GET TIME_STATUS_NP
        90f2ca.fffe.20d7e9-0 seq 0 RESPONSE MANAGEMENT TIME_STATUS_NP
                master_offset              283
                ingress_time               1361569379345936841
                cumulativeScaledRateOffset   +1.000000000
                scaledLastGmPhaseChange    0
                gmTimeBaseIndicator        0
                lastGmPhaseChange          0x0000'0000000000000000.0000
                gmPresent                  true
                gmIdentity                 00b058.feef.0b448a</screen>
   <para>
    <option>-b</option> 选项指定所发送消息中的边界跃点值。将此选项设置为 0 会将边界限制为本地 <command>ptp4l</command> 实例。增加该值还将检索距离本地实例更远的 PTP 节点发出的消息。返回的信息可能包括：
   </para>
   <variablelist>
    <varlistentry>
     <term>stepsRemoved</term>
     <listitem>
      <para>
       超级主时钟的通讯节点数。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>offsetFromMaster、master_offset</term>
     <listitem>
      <para>
       该时钟与主时钟之间上次测得的偏差（纳秒）。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>meanPathDelay</term>
     <listitem>
      <para>
       从主时钟发送的同步消息的预计延迟（纳秒）。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>gmPresent</term>
     <listitem>
      <para>
       如果为 <literal>true</literal>，则表示 PTP 时钟已同步到主时钟；本地时钟不是超级主时钟。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>gmIdentity</term>
     <listitem>
      <para>
       此为超级主时钟身份。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <para>
    有关完整的 <command>pmc</command> 命令行选项列表，请参见 <command>man 8 pmc</command>。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="tuning-ptp-phc2sys">
  <title>使用 <command>phc2sys</command> 同步时钟</title>

  <para>
   使用 <command>phc2sys</command> 可将系统时钟同步到网卡上的 PTP 硬件时钟 (PHC)。系统时钟被视为<emphasis>从属时钟</emphasis>，而网卡上的时钟则为<emphasis>主时钟</emphasis>。PHC 本身将与 <command>ptp4l</command> 同步（请参见<xref linkend="tuning-ptp-using"/>）。使用 <option>-s</option> 可按设备或网络接口指定主时钟。使用 <option>-w</option> 等待 <command>ptp4l</command> 进入同步状态。
  </para>

<screen><prompt>&gt; </prompt><command>sudo</command> phc2sys -s eth0 -w</screen>

  <para>
   PTP 按<emphasis>国际原子时</emphasis> (TAI) 运行，而系统时钟使用的是<emphasis>协调世界时</emphasis> (UTC)。如果您不指定 <option>-w</option> 来等待 <command>ptp4l</command> 同步，可以使用 <option>-O</option> 来指定 TAI 与 UTC 之间的偏差（以秒为单位）：
  </para>

<screen><prompt>&gt; </prompt><command>sudo</command> phc2sys -s eth0 -O -35</screen>

  <para>
   也可以将 <command>phc2sys</command> 作为服务运行：
  </para>

<screen><prompt>&gt; </prompt><command>sudo</command> systemctl start phc2sys</screen>

  <para>
   在本例中，<command>phc2sys</command> 从 <filename>/etc/sysconfig/phc2sys</filename> 文件读取其选项。有关 <command>phc2sys</command> 选项的详细信息，请参见 <command>man 8 phc2sys</command>。
  </para>

  <para>
   要永久启用 <command>phc2sys</command> 服务，请运行以下命令：
  </para>

<screen><prompt>&gt; </prompt><command>sudo</command> systemctl enable phc2sys</screen>

  <para>
   要禁用该服务，请运行
  </para>

<screen><prompt>&gt; </prompt><command>sudo</command> systemctl disable phc2sys</screen>

  <sect2 xml:id="tuning-ptp-phc2sys-verify">
   <title>校验时间同步</title>
   <para>
    当 PTP 时间同步正常工作并且使用了硬件时戳时，<command>ptp4l</command> 和 <command>phc2sys</command> 会定期向系统日志输出包含时间偏差和频率调节的消息。
   </para>
   <para>
    <command>ptp4l</command> 输出示例：
   </para>
<screen>ptp4l[351.358]: selected /dev/ptp0 as PTP clock
ptp4l[352.361]: port 1: INITIALIZING to LISTENING on INITIALIZE
ptp4l[352.361]: port 0: INITIALIZING to LISTENING on INITIALIZE
ptp4l[353.210]: port 1: new foreign master 00a069.eefe.0b442d-1
ptp4l[357.214]: selected best master clock 00a069.eefe.0b662d
ptp4l[357.214]: port 1: LISTENING to UNCALIBRATED on RS_SLAVE
ptp4l[359.224]: master offset       3304 s0 freq      +0 path delay      9202
ptp4l[360.224]: master offset       3708 s1 freq  -28492 path delay      9202
ptp4l[361.224]: master offset      -3145 s2 freq  -32637 path delay      9202
ptp4l[361.224]: port 1: UNCALIBRATED to SLAVE on MASTER_CLOCK_SELECTED
ptp4l[362.223]: master offset       -145 s2 freq  -30580 path delay      9202
ptp4l[363.223]: master offset       1043 s2 freq  -28436 path delay      8972
[...]
ptp4l[371.235]: master offset        285 s2 freq  -28511 path delay      9199
ptp4l[372.235]: master offset        -78 s2 freq  -28788 path delay      9204</screen>
   <para>
    <command>phc2sys</command> 输出示例：
   </para>
<screen>phc2sys[616.617]: Waiting for ptp4l...
phc2sys[628.628]: phc offset     66341 s0 freq      +0 delay   2729
phc2sys[629.628]: phc offset     64668 s1 freq  -37690 delay   2726
[...]
phc2sys[646.630]: phc offset      -333 s2 freq  -37426 delay   2747
phc2sys[646.630]: phc offset       194 s2 freq  -36999 delay   2749</screen>
   <para>
    <command>ptp4l</command> 通常会频繁写入消息。可以使用 <literal>summary_interval</literal> 指令降低该频率。其值的表达式为 2 的 N 次幂。例如，要将输出频率降低为每隔 1024（等于 2^10）秒，请将下面一行添加到 <filename>/etc/ptp4l.conf</filename> 文件。
   </para>
<screen>summary_interval 10</screen>
   <para>
    也可以使用 <option>-u
    <replaceable>SUMMARY-UPDATES</replaceable></option> 选项降低 <command>phc2sys</command> 命令的更新频率。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="tuning-ptp-examples">
  <title>配置示例</title>

  <para>
   本节提供了几个 <command>ptp4l</command> 配置示例。这些示例不是完整的配置文件，而是要对特定文件所做更改的精简列表。字符串 <replaceable>ethX</replaceable> 表示设置中的实际网络接口名称。
  </para>

  <example>
   <title>使用软件时戳的从属时钟</title>
   <para>
    <filename>/etc/sysconfig/ptp4l</filename>：
   </para>
<screen>OPTIONS=”-f /etc/ptp4l.conf -i ethX”</screen>
   <para>
    未对分发包 <filename>/etc/ptp4l.conf</filename> 进行任何更改。
   </para>
  </example>

  <example>
   <title>使用硬件时戳的从属时钟</title>
   <para>
    <filename>/etc/sysconfig/ptp4l</filename>：
   </para>
<screen>OPTIONS=”-f /etc/ptp4l.conf -i ethX”</screen>
   <para>
    <filename>/etc/sysconfig/phc2sys</filename>：
   </para>
<screen>OPTIONS=”-s ethX -w”</screen>
   <para>
    未对分发包 <filename>/etc/ptp4l.conf</filename> 进行任何更改。
   </para>
  </example>

  <example>
   <title>使用硬件时戳的主时钟</title>
   <para>
    <filename>/etc/sysconfig/ptp4l</filename>：
   </para>
<screen>OPTIONS=”-f /etc/ptp4l.conf -i ethX”</screen>
   <para>
    <filename>/etc/sysconfig/phc2sys</filename>：
   </para>
<screen>OPTIONS=”-s CLOCK_REALTIME -c ethX -w”</screen>
   <para>
    <filename>/etc/ptp4l.conf</filename>：
   </para>
<screen>priority1 127</screen>
  </example>

  <example>
   <title>使用软件时戳的主时钟（一般不建议使用）</title>
   <para>
    <filename>/etc/sysconfig/ptp4l</filename>：
   </para>
<screen>OPTIONS=”-f /etc/ptp4l.conf -i ethX”</screen>
   <para>
    <filename>/etc/ptp4l.conf</filename>：
   </para>
<screen>priority1 127</screen>
  </example>
 </sect1>
 <sect1 xml:id="tuning-ptp-ntp">
  <title>PTP 和 NTP</title>

  <para>
   NTP 和 PTP 时间同步工具可以共存，可实现双向时间同步。
  </para>

  <sect2 xml:id="tuning-ptp-ntp2ptp">
   <title>NTP 到 PTP 的同步</title>
   <para>
    使用 <systemitem class="daemon">chronyd</systemitem> 同步本地系统时钟时，可将 <command>ptp4l</command> 配置为超级主时钟，以便通过 PTP 从本地系统时钟分发时间。在 <filename>/etc/ptp4l.conf</filename> 中包含 <option>priority1</option> 选项：
   </para>
<screen>[global]
priority1 127
[eth0]</screen>
   <para>
    然后运行 <command>ptp4l</command>：
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> ptp4l -f /etc/ptp4l.conf</screen>
   <para>
    使用硬件时戳时，需要通过 <command>phc2sys</command> 将 PTP 硬件时钟同步到系统时钟：
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> phc2sys -c eth0 -s CLOCK_REALTIME -w</screen>
  </sect2>

  <sect2 xml:id="tuning-ptp-ptp2ntp">
   <title>配置 PTP-NTP 网桥</title>
   <para>
    在未配备支持 PTP 的交换机或路由器的网络中，如果可以使用高度精确的 PTP 超级主时钟，则计算机可以作为 PTP 从属和第 1 层 NTP 服务器运行。此类计算机需有两个或更多网络接口，并且靠近或者能够直接连接到超级主时钟。这可以确保在网络中实现高度精确的同步。
   </para>
   <para>
    将 <command>ptp4l</command> 和 <command>phc2sys</command> 程序配置为使用一个网络接口来通过 PTP 同步系统时钟。然后将 <systemitem class="daemon">chronyd</systemitem> 配置为使用另一接口提供系统时间：
   </para>
<screen>bindaddress 192.0.131.47
hwtimestamp eth1
local stratum 1</screen>
   <note>
    <title>NTP 和 DHCP</title>
    <para>
     默认情况下，当 DHCP 客户端命令 <command>dhclient</command> 收到 NTP 服务器列表时，会将这些服务器添加到 NTP 配置。为防止出现此行为，请设置
    </para>
<screen>NETCONFIG_NTP_POLICY=""</screen>
    <para>
     （在 <filename>/etc/sysconfig/network/config</filename> 文件中）。
    </para>
   </note>
  </sect2>
 </sect1>
</chapter>
