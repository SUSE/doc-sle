<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_bonding.xml" version="5.0" xml:id="sec-bond">
 <title>Configurando dispositivos de ligação</title>

 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes (sim)</dm:translation>
  </dm:docmanager>
 </info>

 <para>
  Em alguns sistemas, existe a necessidade de implementar conexões de rede compatíveis com outros requisitos além dos padrões de disponibilidade ou segurança de dados de um dispositivo Ethernet comum. Nesses casos, vários dispositivos Ethernet podem ser agregados a um único dispositivo de ligação.
 </para>

 <para>
  A configuração do dispositivo de ligação é feita através das opções dos módulos de ligação. O comportamento é afetado principalmente pelo modo do dispositivo de ligação. Por padrão, o modo é <systemitem>active-backup</systemitem>, o que significa que um dispositivo escravo diferente se tornará ativo se houver falha no escravo ativo. Os seguintes modos de ligação estão disponíveis:
 </para>

 <variablelist>
  <varlistentry>
   <term><guimenu>0</guimenu> (balance-rr)</term>
   <listitem>
    <para>
     Os pacotes são transmitidos em round-robin da primeira para a última interface disponível. Fornece tolerância a falhas e equilíbrio de carga.
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>1</guimenu> (active-backup)</term>
   <listitem>
    <para>
     Apenas uma interface de rede está ativa. Se ela falhar, uma interface diferente se tornará ativa. Essa é a configuração padrão para o <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase>. Fornece tolerância a falhas.
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>2</guimenu> (balance-xor)</term>
   <listitem>
    <para>
     O tráfego é dividido entre todas as interfaces disponíveis com base na seguinte política: <literal>[(source MAC address XOR'd with destination MAC address XOR packet type ID) modulo slave count]</literal>. Requer suporte do switch. Fornece tolerância a falhas e equilíbrio de carga.
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>3</guimenu> (broadcast)</term>
   <listitem>
    <para>
     Todo o tráfego é transmitido em todas as interfaces. Requer suporte do switch. Fornece tolerância a falhas.
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>4</guimenu> (802.3ad)</term>
   <listitem>
    <para>
     Agrega as interfaces em grupos que compartilham as mesmas configurações de velocidade e duplex. Requer suporte a <command>ethtool</command> nos drivers de interface e um switch com suporte e configuração para Agregação de link dinâmico IEEE 802.3ad. Fornece tolerância a falhas e equilíbrio de carga.
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>5</guimenu> (balance-tlb)</term>
   <listitem>
    <para>
     Equilíbrio de carga de transmissão adaptativa. Requer suporte a <command>ethtool</command> nos drivers de interface, mas não suporte do switch. Fornece tolerância a falhas e equilíbrio de carga.
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>6</guimenu> (balance-alb)</term>
   <listitem>
    <para>
     Equilíbrio de carga adaptativo. Requer suporte a <command>ethtool</command> nos drivers de interface, mas não suporte do switch. Fornece tolerância a falhas e equilíbrio de carga.
    </para>
   </listitem>
  </varlistentry>
 </variablelist>

 <para>
  Para obter uma descrição mais detalhada dos modos, consulte <link xlink:href="https://www.kernel.org/doc/Documentation/networking/bonding.txt"/>.
 </para>

 <tip>
  <title>Ligação e Xen</title>
  <para>
   O uso de dispositivos de ligação só é interessante para máquinas que tenham várias placas de rede reais disponíveis. Na maioria das configurações, isso significa que você deve usar a configuração de ligação apenas no Dom0. Somente se você tiver várias placas de rede atribuídas a um sistema Convidado VM é que também poderá ser útil configurar a ligação em um Convidado VM.
  </para>
 </tip>

 <para>
  Para configurar um dispositivo de ligação, siga este procedimento:
 </para>

 <procedure>
  <step>
   <para>
    Execute <menuchoice><guimenu>YaST</guimenu> <guimenu>Sistema</guimenu> <guimenu>Configurações de Rede</guimenu></menuchoice>.
   </para>
  </step>
  <step>
   <para>
    Use <guimenu>Adicionar</guimenu> e mude o <guimenu>Tipo de Dispositivo</guimenu> para <guimenu>Ligação</guimenu>. Continue com <guimenu>Avançar</guimenu>.
   </para>
   <informalfigure>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="bond_configuration.png" width="70%"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="bond_configuration.png" width="65%"/>
     </imageobject>
    </mediaobject>
   </informalfigure>
  </step>
  <step>
   <para>
    Escolha como vai atribuir o endereço IP ao dispositivo de ligação. Há três métodos à sua disposição:
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      Nenhum Endereço IP
     </para>
    </listitem>
    <listitem>
     <para>
      Endereço Dinâmico (com DHCP ou Zeroconf)
     </para>
    </listitem>
    <listitem>
     <para>
      Endereço IP atribuído estaticamente
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Use o método mais apropriado ao seu ambiente.
   </para>
  </step>
  <step>
   <para>
    Na guia <guimenu>Escravos Vinculados</guimenu>, selecione os dispositivos Ethernet que devem ser incluídos na ligação ativando as caixas de seleção relacionadas.
   </para>
  </step>
  <step>
   <para>
    Edite as <guimenu>Opções do Driver de Vinculação</guimenu> e escolha um modo de ligação.
   </para>
  </step>
  <step>
   <para>
    Verifique se o parâmetro <literal>miimon=100</literal> foi adicionado às <guimenu>Opções do Driver de Vinculação</guimenu>. Sem esse parâmetro, a integridade dos dados não é verificada regularmente.
   </para>
  </step>
  <step>
   <para>
    Clique em <guimenu>Avançar</guimenu> e saia do YaST clicando em <guimenu>OK</guimenu> para criar o dispositivo.
   </para>
  </step>
 </procedure>

 <sect2 xml:id="sec-bond-hotplug">
  <title>Hotplug de escravos associados</title>
  <para>
   Em ambientes de rede específicos (como os de Alta Disponibilidade), há casos em que você precisa substituir uma interface de escravo associado por outra. O motivo pode ser uma falha constante no dispositivo de rede. A solução é configurar o hotplug dos escravos associados.
  </para>
  <para>
   A ligação é configurada como de costume (de acordo com <command>man 5 ifcfg-bonding</command>), por exemplo:
  </para>
<screen>ifcfg-bond0
          STARTMODE='auto' # or 'onboot'
          BOOTPROTO='static'
          IPADDR='192.168.0.1/24'
          BONDING_MASTER='yes'
          BONDING_SLAVE_0='eth0'
          BONDING_SLAVE_1='eth1'
          BONDING_MODULE_OPTS='mode=active-backup miimon=100'</screen>
  <para>
   Os escravos são especificados com <literal>STARTMODE=hotplug</literal> e <literal>BOOTPROTO=none</literal>:
  </para>
<screen>ifcfg-eth0
          STARTMODE='hotplug'
          BOOTPROTO='none'

ifcfg-eth1
          STARTMODE='hotplug'
          BOOTPROTO='none'</screen>

  <para>
   <literal>BOOTPROTO=none</literal><command/> usa as opções de ethtool (quando fornecidas), mas não define o link ativo no <command>ifup eth0</command>. O motivo é que a interface do escravo é controlada pelo master de ligação.
  </para>
  <para>
   <literal>STARTMODE=hotplug</literal> faz com que a interface do escravo se una à ligação automaticamente quando ela estiver disponível.
  </para>
  <para>
   As regras do <systemitem>udev</systemitem> em <filename>/etc/udev/rules.d/70-persistent-net.rules</filename> precisam ser modificadas para corresponder ao dispositivo por ID de barramento (palavra-chave <systemitem>KERNELS</systemitem> do udev igual a "SysFS BusID" conforme visível em <command>hwinfo --netcard</command>), em vez do endereço MAC. Isso permite a substituição de hardware com defeito (uma placa de rede no mesmo slot, mas com MAC diferente) e evita confusão quando a ligação muda o endereço MAC de todos os seus escravos.
  </para>
  <para>
   Por exemplo:
  </para>
<screen>SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*",
KERNELS=="0000:00:19.0", ATTR{dev_id}=="0x0", ATTR{type}=="1",
KERNEL=="eth*", NAME="eth0"</screen>
  <para>
   No momento da inicialização, o <systemitem>network.service</systemitem> do systemd não espera o hotplug dos escravos, mas sim a ligação ficar pronta, o que requer no mínimo um escravo disponível. Quando uma das interfaces dos escravos é removida (desvincular do driver NIC, <command>rmmod</command> do driver NIC ou remoção do hotplug do PCI verdadeira) do sistema, o kernel a remove automaticamente da ligação. Quando uma nova placa é adicionada ao sistema (substituição do hardware no slot), o <systemitem>udev</systemitem> a renomeia usando a regra de nome persistente baseada em barramento com o nome do escravo e chama o <command>ifup</command> para ela. A chamada do <command>ifup</command> une-a automaticamente à ligação. <remark>
    ke: I think this can stay that way for now.
   </remark>
  </para>
 </sect2>


</sect1>
