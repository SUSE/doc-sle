<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_upgrading.xml" version="5.0" xml:id="cha-update-sle">
 <title>升级 SUSE Linux Enterprise</title>
 <info>
  <abstract>
   <para>
    SUSE® Linux Enterprise (SLE) 允许将现有系统升级到新版本。不需新安装。主目录和数据目录以及系统配置等现有数据将保持不变。您可以从本地 CD 或 DVD 驱动器或从中央网络安装源进行更新。
   </para>

   <para>
    本章介绍如何通过 DVD、网络、自动化过程或 SUSE Manager 手动升级 SUSE Linux Enterprise 系统。
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <sect1 xml:id="sec-update-sle-paths">
  <title>支持的 SLE 12 SP5 升级路径</title>

<figure xml:id="fig-update-sle-paths-overview">
   <title>支持的升级路径概述</title>
   <mediaobject>
    <imageobject role="fo">
     <imagedata os="sles" fileref="upgrade-paths.svg" width="100%" format="SVG"/>
     
    </imageobject>
    <imageobject role="html">
     <imagedata os="sles" fileref="upgrade-paths.png" width="80%" format="PNG"/>
     
    </imageobject>
   </mediaobject>
  </figure>

  <important>
   <title>不支持跨体系结构升级</title>
   <para>
    <phrase role="productname"><phrase os="sles">不</phrase></phrase>支持跨体系结构升级！例如从 32 位版本的 <emphasis>SUSE Linux Enterprise Server</emphasis> 升级到 64 位版本，或者从大字节序升级到小字节序。
   </para>
   <para>
    具体地说，<emphasis>不</emphasis>支持从 SLE 11 on POWER（大字节序）升级到 SLE 12 SP2 on POWER（新增：小字节序）。
   </para>
   <para>
    另外，由于 SUSE Linux Enterprise 12 只有 64 位版本，因此<emphasis>不</emphasis>支持从任何 32 位 SUSE Linux Enterprise 11 系统升级到 SUSE Linux Enterprise 12 和更高版本。
   </para>
   <para>
    要跨体系结构升级，需执行全新安装。
   </para>
  </important>

  <note>
   <title>跳过服务包</title>
   <para os="sles">
    最安全的升级路径是逐步连续地安装所有服务包。在某些情况下，支持在升级时跳过一到两个服务包，有关细节，请参见<xref linkend="vl-update-paths-sle-supported"/>和<xref linkend="fig-update-sle-paths-overview"/>。但建议<emphasis>不要</emphasis>跳过任何服务包。
   </para>
   
  </note>

  <note>
   <title>升级到主要版本</title>
   <para>
    建议您通过执行全新安装来升级到新的主要版本。
   </para>
  </note>

  <variablelist xml:id="vl-update-paths-sle-supported">
   <title>每个版本支持的升级路径</title>
   <varlistentry>
    <term>从 SUSE Linux Enterprise 10（任何服务包）升级</term>
    <listitem>
     <para>
      不支持直接迁移到 SUSE Linux Enterprise 12。在此情况下，建议执行全新安装。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>从 SUSE Linux Enterprise 11 GA/SP1/SP2/SP3 升级</term>
    <listitem>
     <para>
      不支持直接迁移到 SUSE Linux Enterprise 12。您的版本至少需为 SLE 11 SP4，才能升级到 SLE 12 SP5。
     </para>
     <para>
      如果您不能执行全新安装，请先将已安装的 SLE 11 服务包升级到 SLE 11 SP4。《SUSE Linux Enterprise 11 <citetitle><citetitle>部署指南</citetitle></citetitle>》中说明了这些步骤：<link os="sles" xlink:href="https://documentation.suse.com/sles-11/"/>。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>从 SUSE Linux Enterprise 11 SP4 升级</term>
    <listitem>
     <para>
      只有通过脱机升级才能从 SLE 11 SP5 升级到 SLE 12 SP4。有关详细信息，请参见<xref linkend="cha-update-offline"/>。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>从 SUSE Linux Enterprise 12 GA/SP1/SP2 升级到 SP5</term>
    <listitem>
     <para>
      不支持从 SLE 12 GA、SP1 或 SP2 直接升级到 SP5。请先升级到 SLE 12 <phrase os="sles">SP3 或</phrase> SP4。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>从 SUSE Linux Enterprise 12 SP3/SP4 升级到 SP5</term>
    <listitem>
     <para>
      支持从 SUSE Linux Enterprise 12 SP3 或 SP4 升级到 SP5。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry os="sles">
    <term>从 SUSE Linux Enterprise 12 LTSS GA/SP1 升级到 SP5</term>
    <listitem>
     <para>
      不支持从 SUSE Linux Enterprise 12 LTSS GA 或 SP1 直接升级到 SP5。请先升级到 SLE 12 LTSS SP2。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry os="sles">
    <term>从 SUSE Linux Enterprise 12 LTSS SP2/SP3/SP4 升级到 SP5</term>
    <listitem>
     <para>
      支持从 SUSE Linux Enterprise 12 LTSS SP2、SP3 或 SP4 升级到 SP5。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec-update-sle-methods">
  <title>联机和脱机升级</title>
  <para>
   SUSE 支持两种不同的升级和迁移方法。有关术语的详细信息，请参见<xref linkend="sec-update-sle-terminology"/>。这些方法是：
  </para>

  <variablelist>
   <varlistentry>
    <term>联机</term>
    <listitem>
     <para>
      从正在运行的系统中执行的所有升级均视为联机升级。示例：使用 Zypper 或 YaST 通过 SUSE Customer Center、Subscription Management Tool (SMT) 或 SUSE Manager 连接。
     </para>
     <para>
      在同一主要版本的服务包之间迁移时，建议使用下面两种方法：<xref linkend="sec-update-migr-yast-onlinemigr"/>或<xref linkend="sec-update-migr-zypper-onlinemigr"/>。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>脱机</term>
    <listitem>
     <para>
      脱机方法通常会引导另一个操作系统，从中升级已安装的 SLE 版本。示例有：DVD、闪存盘、ISO 映像、AutoYaST、<quote>纯 RPM</quote>或 PXE 引导。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <important>
   <title>SUSE Manager 客户端</title>
   <para>
    如果您的计算机由 SUSE Manager 管理，则应在管理界面中启动升级过程。有关详细信息，请参见 <xref linkend="sec-update-sle-manager"/>。
   </para>
  </important>
 </sect1>

 <sect1 xml:id="sec-update-prep">
  <title>准备系统</title>
  <para>
   在开始升级过程之前，请确保您的系统已准备妥当。这些准备工作包括备份数据，查看发行说明，以及其他工作。
  </para>

  <sect2 xml:id="sec-update-prep-update">
   <title>确保当前系统是最新的</title>
   <para>
    仅支持从最新的增补级别升级系统。运行 <command>zypper patch</command> 或启动 YaST 模块 <guimenu>Online-Update</guimenu>，以确保已安装最新的系统更新。
   </para>
  </sect2>

  <sect2 xml:id="sec-update-prep-relnotes">
   <title>阅读发行说明</title>
   <para>
    在发行说明中，您可以找到有关自 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 的上一个版本发行后所进行的更改的其他信息。检查发行说明以了解：
   </para>
   <itemizedlist>
    <listitem>
     <para>
      您的硬件是否有特殊的注意事项；
     </para>
    </listitem>
    <listitem>
     <para>
      所用的任何软件包是否已发生重大更改；
     </para>
    </listitem>
    <listitem>
     <para>
      是否需要对您的安装实施特殊预防措施。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    发行说明还提供未能及时编入手册中的信息。它们还包含有关已知问题的说明。
   </para>
   <para os="sles">
    如果您跳过了一个或多个服务包，另请检查所跳过服务包的发行说明。发行说明通常只包含两个连续的版本之间的更改。如果您只阅读最新的发行说明，可能会了解不到某些重大更改。
   </para>
   <para>
    本地的 <filename>/usr/share/doc/release-notes</filename> 目录中或 <link xlink:href="https://www.suse.com/releasenotes/"/> 网页上会提供发行说明。
   </para>
  </sect2>
  <sect2 xml:id="sec-update-prep-backup">
   <title>创建备份</title>
   <para>
    在更新之前，请将现有配置文件复制到单独一个媒体（如磁带设备、可卸硬盘等）上，用以备份数据。这主要适用于储存在 <filename>/etc</filename> 中的文件以及 <filename>/var</filename> 和 <filename>/opt</filename> 中的一些目录和文件。最好将 <filename>/home</filename>（<envar>HOME</envar> 目录）中的用户数据也写入备份媒体。以 <systemitem class="username">root</systemitem> 用户的身份备份此数据。仅 <systemitem class="username">root</systemitem> 用户对所有本地文件具有读许可权限。
   </para>
   <para>
    如果您已在 YaST 中选择<guimenu>更新现有系统</guimenu>作为安装模式，则可以选择在以后的某个时间执行（系统）备份。您可以选择包含所有已修改的文件以及 <filename>/etc/sysconfig</filename> 目录中的文件。但是，此备份尚不完整，因为缺少了上述所有其他重要目录。在 <filename>/var/adm/backup</filename> 目录中查找备份。
   </para>
   <sect3 xml:id="sec-update-prep-backup-packagelist">
    <title>列出已安装的包和储存库</title>
    <para>
     已安装包列表通常很有用，例如，在全新安装某个新的主要 SLE 版本或恢复到旧版本时就是如此。
    </para>
    <para>
     请注意，并非所有已安装的包或使用的储存库在 SUSE Linux Enterprise 的较新版本中都可用。有些包或储存库可能已被重命名，有些可能已被取代。还有可能提供的一些包只是用于旧版，而默认会使用另一个替代它的包。因此，可能需要手动编辑一些文件。您可使用任何文本编辑器进行编辑。
    </para>
    <para>
     创建包含所有使用的储存库列表的文件 <filename>repositories.bak</filename>：
    </para>
    <screen><prompt role="root">root # </prompt><command>zypper</command> lr -e repositories.bak</screen>
    <para>
     另外，创建包含所有已安装包的列表的文件 <filename>installed-software.bak</filename>：
    </para>
    <screen><prompt role="root">root # </prompt><command>rpm</command> -qa --queryformat '%{NAME}\n' &gt; installed-software.bak</screen>
    <para>
     备份这两个文件。使用以下命令可恢复储存库和已安装的包：
    </para>
    <screen><prompt role="root">root # </prompt><command>zypper</command> ar repositories.bak
<prompt role="root">root # </prompt><command>zypper</command> install $(cat installed-software.bak)</screen>

    <note xml:id="note-update-prep-backup-package-amount">
     <title>
      更新到新主要版本后，包数量也随之增加
     </title>
     <para>
      升级到新主要版本的系统 (SLE <replaceable>X+1</replaceable>) 包含的包可能会比初始系统 (SLE <replaceable>X</replaceable>) 的多，也会比选择相同模式执行的 SLE <replaceable>X+1</replaceable> 全新安装所包含的包多。原因如下：
     </para>
     <itemizedlist>
      <listitem>
       <para>
        包经过拆分，以便用户能以更高的粒度选择包。例如，SLE 11 上的 37 个 <package>texlive</package> 包已拆分成 SLE 12 上的 422 个包。
       </para>
      </listitem>
      <listitem>
       <para>
        将某个包拆分成其他包后，在升级过程中会安装所有新包，以与旧版本保持相同的功能。但是，SLE <replaceable>X+1</replaceable> 全新安装的新默认设置可能不会安装所有包。
       </para>
      </listitem>
      <listitem>
       <para>
        出于兼容原因，可能会保留 SLE <replaceable>X</replaceable> 中的旧包。
       </para>
      </listitem>
      <listitem>
       <para>
        包依赖项和模式范围可能已发生变化。
       </para>
      </listitem>
     </itemizedlist>
    </note>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-update-prep-mariadb">
   <title>迁移 MySQL 数据库</title>
   <remark>toms 2015-09-03: already reviewed by Ondrej and Kristýna.</remark>
   <para>
    从 SUSE Linux Enterprise 12 开始，SUSE 已从 MySQL 转移到 MariaDB。在开始任何升级操作之前，强烈建议您备份数据库。
   </para>

   <para>
    要进行数据库迁移，请执行以下操作：
   </para>
   <procedure>
    <step>
     <para>
      登录到 SUSE Linux Enterprise 11 计算机。
     </para>
    </step>
    <step>
     <para>
      创建转储文件:
     </para>
<screen><prompt role="root">root # </prompt><command>mysqldump</command> -u root -p --all-databases &gt; mysql_backup.sql</screen>
     <para>
      默认情况下，<command>mysqldump</command> 不会转储 <literal>INFORMATION_SCHEMA</literal> 或 <literal>performance_schema</literal> 数据库。有关详细信息，请参见 <link xlink:href="https://dev.mysql.com/doc/refman/5.5/en/mysqldump.html"/>。
     </para>
    </step>
    <step>
     <para>
      将您的转储文件、配置文件 <filename>/etc/my.cnf</filename> 以及 <filename>/etc/mysql/</filename> 目录储存在安全位置，以供日后调查（<emphasis>不要</emphasis>用于安装！）。
     </para>
    </step>
    <step>
     <para>
      执行升级。升级后，以前的配置文件 <filename>/etc/my.cnf</filename> 仍将保持不变。新配置保存在 <filename>/etc/my.cnf.rpmnew</filename> 文件中。
     </para>
    </step>
    <step>
     <para>
      根据需要配置 MariaDB 数据库。<emphasis>不要</emphasis>使用以前的配置文件和目录，只是将其用作提醒，并对其进行改编。
     </para>
    </step>
    <step>
     <para>
      确保启动 MariaDB 服务器：
     </para>
<screen><prompt role="root">root # </prompt><command>systemctl</command> start mysql</screen>
     <para>
      如果您希望每次引导时都启动 MariaDB 服务器，请启用以下服务：
     </para>
<screen><prompt role="root">root # </prompt><command>systemctl</command> enable mysql</screen>

    </step>
    <step>
     <para>
      通过连接数据库来校验 MariaDB 是否正常运行：
     </para>
<screen><prompt role="root">root # </prompt><command>mysql</command> -u root -p</screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec-update-prep-postgresql">
   <title>迁移 PostgreSQL 数据库</title>
   <para>
    较新版本的 PostgreSQL 数据库以维护更新的形式随附。由于需要完成数据库的迁移工作，因此无法使用自动升级过程。您需要手动完成从一个版本到另一个版本的转移。
   </para>
   <para>
    迁移过程通过使用 <command>pg_upgrade</command> 命令执行，这种方法可替代传统的转储和重新装载。与<quote>转储并重新装载</quote>方法相比，<command>pg_upgrade</command> 可以减少迁移耗费的时间。
   </para>
   <para>
    每个 PostgreSQL 版本的程序文件储存在不同版本的相关目录中。例如，<filename>/usr/lib/postgresql96/</filename> 对应于版本 9.6，<filename>/usr/lib/postgresql10/</filename> 对应于版本 10。请注意，PostgreSQL 主要版本 9.6 与 10 的版本控制策略有所不同。有关详细信息，请参见 <link xlink:href="https://www.postgresql.org/support/versioning/"/>。
   </para>
   <important>
    <title>从 SLE 11 升级</title>
     <para>
      从 SLE 11 升级时，<systemitem>postgresql94</systemitem> 将被卸装，不可用于将数据库迁移到更高的 PostgreSQL 版本。因此，在这种情况下，请确保先迁移 PostgreSQL 数据库，<emphasis>然后</emphasis>再升级系统。
    </para>
   </important>
   <para>
    以下过程描述如何将数据库从版本 9.6 迁移到版本 10。使用不同的版本作为起始或目标时，请相应地替换版本号。
   </para>
   <para>
    要进行数据库迁移，请执行以下操作：
   </para>
   <procedure>
    <step>
     <para>
      确保满足以下先决条件：
     </para>
     <itemizedlist>
      <listitem>
       <para>
        如果尚未通过维护更新将旧 PostgreSQL 版本的任何包升级到最新版本，请执行该操作。
       </para>
      </listitem>
      <listitem>
       <para>
        创建现有数据库的备份。
       </para>
      </listitem>
      <listitem>
       <para>
        安装新 PostgreSQL 主要版本的包。对于 SLE12 SP5，这意味着要安装
        <package>postgresql10-server</package>
        及其依赖的所有包。
       </para>
      </listitem>
      <listitem>
       <para>
        安装包
        <package>postgresql10-contrib，</package>
        其中包含命令 <command>pg_upgrade</command>。
       </para>
      </listitem>
      <listitem>
       <para>
        确保 PostgreSQL 数据区域（默认为 <filename>/var/lib/pgsql/data</filename>）中有足够的可用空间。如果空间不足，请对每个数据库使用以下 SQL 命令，以尝试减少大小（这可能需要花费很长时间！）：
       </para>
<screen>VACUUM FULL</screen>
      </listitem>
     </itemizedlist>
    </step>
    <step>
     <para>
      使用以下任一命令停止 PostgreSQL 服务器：
     </para>
<screen><prompt role="root">root # </prompt><command>/usr/sbin/rcpostgresql</command> stop</screen>
    <para>或者</para>
<screen><prompt role="root">root # </prompt>systemctl stop postgresql.service</screen>
    <para>（取决于要用作升级起始版本的 SLE 版本）。</para>
    </step>
    <step>
     <para>
      重命名旧数据目录：
     </para>
<screen><prompt role="root">root # </prompt><command>mv</command> /var/lib/pgsql/data /var/lib/pgsql/data.old</screen>
    </step>
    
    <step>
     <para>
      使用 <command>initdb</command> 手动初始化新的数据库实例，或者启动再停止 PostgreSQL 让数据库实例自动初始化：
     </para>
<screen><prompt role="root">root # </prompt><command>/usr/sbin/rcpostgresql</command> start
<prompt role="root">root # </prompt><command>/usr/sbin/rcpostgresql</command> stop</screen>
     <para>或者</para>
<screen><prompt role="root">root # </prompt>systemctl start postgresql.service
<prompt role="root">root # </prompt>systemctl stop postgresql.service</screen>
     <para>（取决于要用作升级起始版本的 SLE 版本）。</para>
    </step>
    <step>
     <para>
      如果您在旧版本中更改了配置文件，请考虑将这些更改转移到新配置文件。可能受影响的文件包括 <filename>postgresql.auto.conf</filename>、<filename>postgresql.conf</filename>、<filename>pg_hba.conf</filename> 和 <filename>pg_ident.conf</filename>。这些文件的旧版本位于 <filename>/var/lib/pgsql/data.old/</filename> 中，新版本可在 <filename>/var/lib/pgsql/data</filename> 中找到。
     </para>
     <para>
      请注意，不建议只是复制旧配置文件，因为这可能会重写新选项、新默认值和更改后的注释。
     </para>
    </step>
    <step>
     <para>
      以 <systemitem class="username">postgres</systemitem> 用户身份启动迁移过程：
     </para>
<screen><prompt role="root">root # </prompt>su - postgres
postgres &gt; <command>pg_upgrade</command> \
   --old-datadir "/var/lib/pgsql/data.old" \
   --new-datadir "/var/lib/pgsql/data" \
   --old-bindir "/usr/lib/postgresql96/bin/" \
   --new-bindir "/usr/lib/postgresql10/bin/"</screen>
    </step>
    <step>
     <para>
      使用以下任一命令启动新数据库实例：
     </para>
<screen><prompt role="root">root # </prompt><command>/usr/sbin/rcpostgresql</command> start</screen>
     <para>或者</para>
<screen><prompt role="root">root # </prompt>systemctl start postgresql.service</screen>
     <para>（取决于要用作升级起始版本的 SLE 版本）。</para>
    </step>
    <step>
     <para>
      检查迁移是否成功。测试范围取决于用例。没有通用的工具可用来自动执行此步骤。
     </para>
    </step>
    <step>
     <para>
      去除所有旧 PostgreSQL 包和旧数据目录：
     </para>
<screen><prompt role="root">root # </prompt><command>zypper</command> search -s postgresql96 | xargs zypper rm -u
<prompt role="root">root # </prompt><command>rm</command> -rf /var/lib/pgsql/data.old</screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec-update-prep-ssl">
   <title>创建用于 Java 应用程序的非 MD5 服务器证书</title>
   <remark>toms 2016-07-27: from bsc#970153, c#24</remark>
   <para>
    从 SP1 更新到 SP2 期间，在安全性修复时禁用了基于 MD5 的证书。如果您之前创建的证书是 MD5 证书，请执行以下步骤重新创建证书：
   </para>

   <procedure>
    <step>
     <para>
      打开终端窗口并以 <systemitem class="username">root</systemitem> 身份登录。
     </para>
    </step>
    <step>
     <para>
      创建一个私用密钥：
     </para>
     <screen><prompt role="root">root # </prompt><command>openssl</command> genrsa -out server.key 1024</screen>
     <para>
      如果需要强度更高的密钥，请将 <literal>1024</literal> 替换为更大的数字，例如 <literal>4096</literal>。
     </para>
    </step>
    <step>
     <para>
      创建证书签名请求 (CSR)：
     </para>
     <screen><prompt role="root">root # </prompt><command>openssl</command> req -new -key server.key -out server.csr</screen>
    </step>
    <step>
     <para>
      对证书自我签名：
     </para>
     <screen><prompt role="root">root # </prompt><command>openssl</command> x509 -req -days 365 -in server.csr -signkey server.key -out server.crt</screen>
    </step>
    <step>
     <para>
      创建 PEM 文件：
     </para>
     <screen><prompt role="root">root # </prompt><command>cat</command> server.key server.crt &gt; server.pem</screen>
    </step>
    <step>
     <para>将 <filename>server.crt</filename>、<filename>server.csr</filename>、<filename>server.key</filename> 和 <filename>server.pem</filename> 文件放在可在其中找到密钥的相应目录中。例如，对于 Tomcat，此目录为 <filename>/etc/tomcat/ssl/</filename>。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec-update-prep-vms">
   <title>关闭虚拟机 Guest</title>
   <para>
    如果您的计算机充当 KVM 或 Xen 的 VM 主机服务器，请确保在更新之前关闭所有正在运行的 VM Guest。否则，更新后您可能无法访问 guest。
   </para>
  </sect2>

  <sect2 xml:id="sec-update-prep-smt">
   <title>调整 SMT 客户端设置</title>
   <para>
    如果您要升级的计算机已注册为 SMT 服务器的客户端，请注意以下事项：
   </para>
   <para>
    检查主机上的 <command>clientSetup4SMT.sh</command> 脚本版本是否是最新的。较旧版 SMT 的 <command>clientSetup4SMT.sh</command> 无法管理 SMT 12 客户端。如果您在 SMT 服务器上定期应用软件增补程序，那么位于 <filename>&lt;SMT 主机名&gt;/repo/tools/clientSetup4SMT.sh</filename> 处的 <command>clientSetup4SMT.sh</command> 始终都是最新版本。
   </para>

   <para>
    如果将计算机升级到更高版本的 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 失败，请根据<xref linkend="pro-sec-update-prep-smt-de-register" xrefstyle="select:label"/>中所述，从 SMT 服务器中取消注册该计算机。然后重启动升级过程。</para>
   <procedure xml:id="pro-sec-update-prep-smt-de-register">
    <title>从 SMT 服务器中取消注册 SUSE Linux Enterprise 客户端</title>
     <step>
      <para>
       登录客户端计算机。
      </para>
     </step>
     <step>
     <para>以下步骤根据客户端的当前操作系统而异：</para>
     <itemizedlist>
      <listitem>
       <para>
        对于 SUSE Linux Enterprise 11，请执行以下命令：
       </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> suse_register -E
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /etc/SUSEConnect
<prompt>tux &gt; </prompt><command>sudo</command> rm -rf /etc/zypp/credentials.d/*
<prompt>tux &gt; </prompt><command>sudo</command> rm -rf /etc/zypp/repos.d/*
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /etc/zypp/services.d/*
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /var/cache/SuseRegister/*
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /etc/suseRegister*
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /var/cache/SuseRegister/lastzmdconfig.cache
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /etc/zmd/deviceid
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /etc/zmd/secret</screen>
      </listitem>
      <listitem>
       <para>
        对于 SUSE Linux Enterprise 12，请执行以下命令：
       </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> SUSEConnect --de-register
<prompt>tux &gt; </prompt><command>sudo</command> SUSEConnect --cleanup
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /etc/SUSEConnect
<prompt>tux &gt; </prompt><command>sudo</command> rm -rf /etc/zypp/credentials.d/*
<prompt>tux &gt; </prompt><command>sudo</command> rm -rf /etc/zypp/repos.d/*
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /etc/zypp/services.d/*</screen>
      </listitem>
     </itemizedlist>
    </step>
    <step>
     <para>
      登录 SMT 服务器。
     </para>
    </step>
    <step>
     <para>
      通过列出所有客户端注册，检查是否已成功取消注册该客户端：
     </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> smt-list-registrations</screen>
    </step>
    <step>
     <para>
      如果该客户端的主机名仍旧列在此命令的输出中，请从第一列获取该客户端的<literal>唯一 ID</literal>。（可能列出了该客户端的多个 ID。）
     </para>
    </step>
    <step>
     <para>
      删除此客户端的注册：
     </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> smt-delete-registration -g <replaceable>UNIQUE_ID</replaceable></screen>
    </step>
     <step>
     <para>
      如果列出了该客户端的多个 ID，请针对每个唯一 ID 重复上述步骤。
     </para>
    </step>
    <step>
     <para>
      重新运行以下命令，检查现在是否已成功取消注册该客户端：
     </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> smt-list-registrations</screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec-update-disk">
   <title>磁盘空间</title>

   <para>
    从旧版本到新版本，软件的大小有增长的趋势。因此，在进行更新之前，请查看可用分区空间。如果您怀疑磁盘空间不足，请先备份数据，再通过调整分区大小等方法来增大可用空间。对于每个分区应该具有多少空间，没有一般的经验可以借鉴。空间要求取决于特定的分区配置文件和选定的软件。
   </para>

   <note>
    <title>在 YaST 中自动检查是否有足够空间</title>
    <para>
     在更新过程中，YaST 会检查可用磁盘空间的容量，并在安装大小可能超出可用空间时向用户显示警告。在该情况下，执行更新会导致<emphasis>系统不可用</emphasis>！只有在您完全了解自己要进行的操作的情况下（通过事先测试），才能跳过警告继续更新。
    </para>
   </note>

   <sect3 xml:id="sec-update-disk-space">
    <title>检查非 Btrfs 文件系统上的磁盘空间</title>
    <para>
     使用 <command>df</command> 命令可列出可用磁盘空间。例如，在<xref linkend="aus-update-df"/>中，根分区为 <filename>/dev/sda3</filename>（作为 <filename>/</filename> 装入）。
    </para>
    <example xml:id="aus-update-df">
     <title>使用 <command>df -h</command> 列示信息</title>

<screen os="sles">Filesystem     Size  Used Avail Use% Mounted on
/dev/sda3       74G   22G   53G  29% /
tmpfs          506M     0  506M   0% /dev/shm
/dev/sda5      116G  5.8G  111G   5% /home
/dev/sda1       44G    4G   40G   9% /data</screen>
    </example>
   </sect3>

   <sect3 xml:id="sec-update-disk-btrfs-on-root">
    <title>检查 Btrfs 根文件系统上的磁盘空间</title>
    <para>
     如果您在计算机上使用 Btrfs 作为根文件系统，请确保有足够的可用空间。在最坏的情况下，升级进程需要将当前根文件系统的所有磁盘空间（不含 <filename>/.snapshot</filename>）用于存放新快照。要显示可用的磁盘空间，请使用以下命令：
    </para>
<screen><prompt role="root">root # </prompt><command>df</command> -h /</screen>
    <para>
     另外请检查所有其他装入分区上的可用空间。下列建议已证实值得采纳：
    </para>
    <itemizedlist>
     <listitem>
      <para>
       包含 Btrfs 在内的所有文件系统需有足够的可用磁盘空间用于下载和安装大型 RPM。旧 RPM 的空间只会在新 RPM 安装之后释放。
      </para>
     </listitem>
     <listitem>
      <para>
       对于包含快照的 Btrfs，至少需要有当前安装任务所需的可用空间。建议提供两倍于当前安装大小的可用空间。
      </para>
      <para>
       如果没有足够的可用空间，您可以尝试使用 <command>snapper</command> 删除旧快照：
      </para>
<screen><prompt role="root">root # </prompt><command>snapper</command> list
<prompt role="root">root # </prompt><command>snapper</command> delete NUMBER</screen>
      <para>
       但这种做法并不总是有用。在迁移之前，大多数快照只会占用极少的空间。
      </para>
     </listitem>
    </itemizedlist>
   </sect3>
  </sect2>
  <sect2 xml:id="sec-update-prep-multiversion">
   <title>暂时禁用内核多版本支持</title>
   <para>
    <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 允许您在 <filename>/etc/zypp/zypp.conf</filename> 中启用相应设置来安装多个内核版本。为了升级到某个服务包，需要暂时禁用对此功能的支持。当更新成功完成后，可以重新启用多版本支持。要禁用多版本支持，请对 <filename>/etc/zypp/zypp.conf</filename> 中的相应行加上注释。结果应类似如下内容：
   </para>
<screen>#multiversion = provides:multiversion(kernel)
#multiversion.kernels = latest,running</screen>
   <para>
    要在成功更新后重新激活此功能，请去除注释符号。有关多版本支持的详细信息，请参见<xref linkend="cha-tuning-multikernel-enable"/>。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-update-sle-sle12zseries" os="sles">
  <title>在 IBM Z 上升级</title>
  <para>在 IBM Z 上升级 SUSE Linux Enterprise 安装需要设置 <command>Upgrade=1</command> 内核参数（例如，通过 parmfile 设置）。请参见<xref linkend="sec-appdendix-parm" xrefstyle="HeadingOnPage"/>。
  </para>
 </sect1>
 <sect1 xml:id="sec-update-prep-ppc-x" os="sles" arch="power">
  <title>IBM POWER：启动 X 服务器</title>
  <para>
   在 SLES 12 for IBM POWER 上，显示管理器配置为默认不启动本地 X 服务器。该设置在 SLES 12 SP1 则相反，即显示管理器现在会启动 X 服务器。
  </para>
  <para>
   为了避免升级期间出现问题，<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 设置不会自动更改。如果要让显示管理器在升级后启动 X 服务器，请按如下所示在 <filename>/etc/sysconfig/displaymanager</filename> 中更改 <envar>DISPLAYMANAGER_STARTS_XSERVER</envar> 设置：
  </para>
  <screen>DISPLAYMANAGER_STARTS_XSERVER="yes"</screen>
 </sect1>
</chapter>
