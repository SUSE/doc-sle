<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="security_polkit.xml" version="5.0" xml:id="cha-security-polkit">

 <title>Polkit 身份验证框架</title>
 <info>
      <abstract>
        <para>
         Polkit 是 Linux 图形桌面环境中使用的身份验证框架，用于对系统中的访问权限进行精细管理。在传统上，Linux 上的 <systemitem class="username">root</systemitem> 用户（获得完全授权的管理员帐户）与系统中所有其他帐户和组之间存在严格的特权分离。这些非管理员帐户可能拥有特定的附加特权，例如通过 <literal>audio</literal> 组访问声音硬件。不过，这种特权是固定的，在特定的情况下或特定的时间内无法授予。
        </para>
        <para>
         Polkit 不是完全切换到 <systemitem class="username">root</systemitem> 用户（使用 <command>sudo</command> 之类的程序）来获取较高的特权，而是根据需要向用户或组授予特定的特权。此过程由配置文件控制，这些配置文件描述了需要在动态环境中授权的各个操作。
        </para>
      </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:bugtracker>
        </dm:bugtracker>
        <dm:translation>yes</dm:translation>
      </dm:docmanager>
 </info>

 <sect1 xml:id="sec-security-polkit-oview">
  <title>概念概述</title>

  <para>
   Polkit 由多个组件构成。<command>polkitd</command> 是一个特权中心后台服务，根据现有的 Polkit 配置执行身份验证检查。支持 Polkit 的应用程序将特定身份验证请求转发到 <command>polkitd</command> 守护程序。在非特权用户环境中运行的 Polkit 身份验证代理负责代表 <command>polkitd</command> 守护程序显示身份验证请求，并提供用户以交互方式输入的身份凭证。
  </para>

  <para>
   Polkit <emphasis>操作</emphasis>表示受 Polkit 授权规则约束的单个活动。例如，重引导计算机的意图可以在 Polkit 中建模为单个操作。每个操作有一个唯一的标识符，对于重引导示例，该操作名为 <literal>org.freedesktop.login1.reboot</literal>。
  </para>

  <sect2 xml:id="sec-security-polkit-agents">
   <title>身份验证代理</title>
   <para>
    当用户在功能齐全的桌面环境中启动图形会话时，身份验证代理通常会自动启动并在后台运行。当显示身份验证提示以响应请求授权执行特定操作的应用程序时，您会注意到这一点。无法轻松以文本模式或通过 SSH 使用 Polkit，因此本文档将重点介绍如何在图形会话环境中使用 Polkit。
   </para>
  </sect2>

  <sect2 xml:id="sec-security-polkit-structure">
   <title>Polkit 的配置</title>
   <para>
    Polkit 的配置由<emphasis>操作</emphasis>和<emphasis>授权规则</emphasis>组成：
   </para>
   <variablelist>
    <varlistentry>
     <term>操作（文件扩展名为 <filename>*.policy</filename>）</term>
     <listitem>
      <para>
       操作在 <filename>/usr/share/polkit-1/actions</filename> 下的 XML 文件中定义。每个文件为特定的应用程序域定义一个或多个操作，而每个操作包含直观易懂的说明及其默认授权设置。尽管系统管理员可以编写自己的规则，但不能直接编辑这些默认策略文件。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>授权规则（文件扩展名为 <filename>*.rules</filename>）</term>
     <listitem>
      <para>
       规则是用 JavaScript 编程语言编写的，位于两个位置：<filename>/usr/share/polkit-1/rules.d </filename> 由系统软件包使用，<filename>/etc/polkit-1/rules.d</filename> 用于本地管理的配置。规则文件在默认操作授权设置的顶部包含较复杂的逻辑。例如，规则文件可以否决某个限制性操作，并允许特定的用户在未经授权的情况下使用该操作。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec-security-polkit-oview-commands">
   <title>Polkit 实用程序</title>
   <para>
    Polkit 提供了用于完成特定任务的实用程序（有关更多细节，另请参见这些实用程序的相应手册页）：
   </para>
   <variablelist>
    <varlistentry>
     <term><command>pkaction</command>
     </term>
     <listitem>
      <para>
       获取有关所定义操作的细节。有关更多信息，请参见<xref linkend="sec-security-polkit-query"/>。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>pkcheck</command>
     </term>
     <listitem>
      <para>
       检查某个进程是否有权执行特定的 Polkit 操作。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>pkexec</command>
     </term>
     <listitem>
      <para>
       允许程序根据 Polkit 授权设置以不同用户的身份执行。这与 <command>su</command> 或 <command>sudo</command> 类似。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>pkttyagent</command>
     </term>
     <listitem>
      <para>
       启动文本身份验证代理。如果桌面环境没有自己的身份验证代理，将使用此代理。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>
 </sect1>

 <sect1 xml:id="sec-security-polkit-types">
  <title>授权类型</title>

  <para>
   每当支持 PolKit 的应用程序执行特权操作时，系统都会询问 PolKit 相应用户是否有权这样做。回答可以是 <literal>yes</literal>、<literal>no</literal> 或 <literal>authentication needed</literal>。对于后一种回答，系统会显示一个身份验证对话框，供用户输入所需的身份凭证。
  </para>

  <sect2 xml:id="sec-security-polkit-policies-implicit">
   <title>隐式授权</title>
   <para>
    如果给定的操作不存在专用的 Polkit JavaScript 规则，结果将取决于 Polkit 策略文件中为每个操作定义的隐式授权设置。有三种授权类别：<literal>allow_active</literal>、<literal>allow_inactive</literal> 和 <literal>allow_any</literal>。<literal>allow_active</literal> 应用于活动会话中的用户。活动会话是文本模式控制台或图形用户环境中的本地登录。例如，当您切换到另一个控制台时（在这种情况下，相关的类别为 <literal>allow_inactive</literal>），会话将变为非活动状态。<literal>allow_any</literal> 用于所有其他环境，例如，用于通过 SSH 或 VNC 登录的远程用户。为其中的每个类别指派了以下授权设置之一：
   </para>
   <variablelist>
    <varlistentry>
     <term>no</term>
     <listitem>
      <para>
       永远不会为用户授予所需操作的授权。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>yes</term>
     <listitem>
      <para>
       始终为用户授予授权，且无需用户输入任何身份凭证。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>auth_self</term>
     <listitem>
      <para>
       用户需要输入自己的口令才能获得操作授权。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>auth_self_keep</term>
     <listitem>
      <para>
       与 <literal>auth_self</literal> 类似，但授权会缓存一定的时间，例如，如果同一个应用程序再次执行同一操作，则无需重新输入口令。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>auth_admin</term>
     <listitem>
      <para>
       用户需要输入管理员 (<systemitem class="username">root</systemitem>) 口令才能获得操作授权。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>auth_admin_keep</term>
     <listitem>
      <para>
       与 <literal>auth_self_keep</literal> 类似，只需输入管理员 (<systemitem class="username">root</systemitem>) 口令。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec-security-polkit-policies-default">
   <title>SUSE 默认特权</title>
   <para>
    到目前为止，所述 Polkit 策略文件中的隐式授权设置由相应应用程序的上游开发人员提供。我们将这些设置称为<emphasis>上游默认设置</emphasis>。这些上游默认设置不一定与 SUSE 系统上使用的默认值相同。<phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 随附了一组可以覆盖上游默认设置的预定义特权。这些设置采用以下三种不同的模式（配置文件），每次只能有一种模式处于活动状态：
   </para>
   <variablelist>
    <varlistentry>
     <term><filename>/etc/polkit-default-privs.easy</filename>
     </term>
     <listitem>
      <para>
       针对单用户桌面系统定制的授权设置，在此模式下，管理员也是唯一处于活动状态的交互用户。此模式降低了安全性，但有利于改进用户体验。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><filename>/etc/polkit-default-privs.standard</filename>
     </term>
     <listitem>
      <para>
       适合大多数系统的平衡设置。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><filename>/etc/polkit-default-privs.restrictive</filename>
     </term>
     <listitem>
      <para>
       更保守的授权设置，可以减小可能的攻击面，但在某些方面会影响用户体验。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <para>
    要切换处于活动状态的 Polkit 配置文件，请编辑 <filename>/etc/sysconfig/security</filename>，并将 <varname>POLKIT_DEFAULT_PRIVS</varname> 的值调整为 <literal>easy</literal>、<literal>standard</literal> 或 <literal>restrictive</literal>。然后以 <systemitem class="username">root</systemitem> 身份运行 <command>set_polkit_default_privs</command> 命令。
   </para>
   <para>
    请不要修改上面列出的文件中的配置文件设置。要定义您自己的自定义 Polkit 设置，请使用 <filename>/etc/polkit-default-privs.local</filename>。有关详细信息，请参考 <xref linkend="sec-security-polkit-change-modify-config-implicit"/>。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-security-polkit-query">
  <title>查询特权</title>

  <para>
   要查询特权，请使用 Polkit 中包含的 <command>pkaction</command> 命令。
  </para>

  <para>
   Polkit 随附了用于更改特权以及以另一用户身份执行命令的命令行工具（有关简要概览，请参见<xref linkend="sec-security-polkit-oview-commands"/>）。每个现有策略都有一个唯一名称用于标识自身。使用 <command>pkaction</command> 命令可列出所有可用策略。有关更多信息，请参见<command>man pkaction</command>。
  </para>

  <para>
   要显示给定策略（例如 <literal>org.freedesktop.login1.reboot</literal>）的所需授权，请如下所示使用 <command>pkaction</command>：
  </para>

  <screen><prompt>&gt; </prompt><command>pkaction -v --action-id=org.freedesktop.login1.reboot</command>
org.freedesktop.login1.reboot:
  description:       Reboot the system
  message:           Authentication is required to allow rebooting the system
  vendor:            The systemd Project
  vendor_url:        http://www.freedesktop.org/wiki/Software/systemd
  icon:
  implicit any:      auth_admin_keep
  implicit inactive: auth_admin_keep
  implicit active:   yes</screen>

  <note>
   <title><phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 上的 <command>pkaction</command> 限制</title>
   <para>
    <command>pkaction</command> 仅考虑上游默认设置。它并不知道哪些 SUSE 默认特权会覆盖上游默认设置。因此，请谨慎解释此类输出。
   </para>
  </note>
 </sect1>
 <sect1 xml:id="sec-security-polkit-change-modify-config">
  <title>修改 Polkit 配置</title>

  <para>
   当您想要在不同的计算机上部署相同的策略集（例如，部署到特定团队的计算机）时，调整 Polkit 设置会很有用。自定义 Polkit 授权设置还可以强化特定操作的安全性，或通过减少在常用操作中提示输入口令的次数来改进用户体验。但请注意，授权在无需身份验证的情况下执行某些 Polkit 操作可能会为普通用户授予完全的 <systemitem class="username">root</systemitem> 特权，从而造成安全风险。仅当您确认降低 Polkit 身份验证要求不会违反特定环境中的系统安全性时，才降低这种要求。
  </para>

  <sect2 xml:id="sec-security-polkit-change-modify-config-actions">
   <title>覆盖 Polkit 策略文件</title>
   <para>
    可用的 Polkit 操作列表取决于您系统上安装的软件包。如需快速概览，请使用 <command>pkaction</command> 列出 Polkit 知道的所有操作。
   </para>
   <para>
    对于本示例，我们将演示命令 <command>gparted</command>（<quote>GNOME 分区编辑器</quote>）如何集成到 Polkit 中。
   </para>
   <para>
    文件 <filename>/usr/share/polkit-1/actions/org.opensuse.policykit.gparted.policy</filename> 包含以下内容：
   </para>
<screen>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE policyconfig PUBLIC
 "-//freedesktop//DTD PolicyKit Policy Configuration 1.0//EN"
 "http://www.freedesktop.org/standards/PolicyKit/1.0/policyconfig.dtd"&gt;
&lt;policyconfig&gt; <co xml:id="co-polkit-actions-policyconfig"/>

  &lt;action id="org-opensuse-polkit-gparted"&gt; <co xml:id="co-polkit-actions-action"/>
    &lt;message&gt;Authentication is required to run the GParted Partition Editor&lt;/message&gt;
    &lt;icon_name&gt;gparted&lt;/icon_name&gt;
    &lt;defaults&gt; <co xml:id="co-polkit-actions-defaults"/>
      &lt;allow_any&gt;auth_admin&lt;/allow_any&gt;
      &lt;allow_inactive&gt;auth_admin&lt;/allow_inactive&gt;
     &lt; allow_active&gt;auth_admin&lt;/allow_active&gt;
    &lt;/defaults&gt;
    &lt;annotate <co xml:id="co-polkit-actions-annotate"/>
      key="org.freedesktop.policykit.exec.path"&gt;/usr/sbin/gparted&lt;/annotate&gt;
    &lt;annotate <xref linkend="co-polkit-actions-annotate"/>
      key="org.freedesktop.policykit.exec.allow_gui"&gt;true&lt;/annotate&gt;
  &lt;/action&gt;

&lt;/policyconfig&gt;</screen>
   <calloutlist>
    <callout arearefs="co-polkit-actions-policyconfig">
     <para>
      策略文件的根 XML 元素。
     </para>
    </callout>
    <callout arearefs="co-polkit-actions-action">
     <para>
      此策略中唯一操作的定义的开头部分。
     </para>
    </callout>
    <callout arearefs="co-polkit-actions-defaults">
     <para>
      在此处可以找到上述隐式授权设置。
     </para>
    </callout>
    <callout arearefs="co-polkit-actions-annotate">
     <para>
      <literal>annotate</literal> 元素包含有关 Polkit 如何执行操作的附加信息。在本例中，此元素包含 gparted 可执行文件的路径，以及用于允许此程序访问图形显示器的设置。必须提供这些批注才能将某个操作与 Polkit 工具 <command>pkexec</command> 结合使用。
     </para>
    </callout>
   </calloutlist>
   <para>
    要添加您自己的策略，请创建采用上述结构的 <filename>.policy</filename> 文件，将相应的操作名称添加到 <literal>id</literal> 属性，并定义所需的覆盖隐式授权设置。
   </para>
   <note>
    <title>已弃用的名称 PolicyKit</title>
    <para>
     Polkit 授权框架以前称为 PolicyKit。在某些位置（例如上面的 XML 文档序言中），仍然使用了这个旧名称。
    </para>
   </note>
  </sect2>

  <sect2 xml:id="sec-security-polkit-change-modify-config-authrules">
   <title>添加 JavaScript 授权规则</title>
   <para>
    授权规则优先于隐式授权设置。要添加您自己的规则，请将您的文件存储在 <filename>/etc/polkit-1/rules.d/</filename> 下。
   </para>
   <para>
    此目录中的文件名以两位数开头，后接短划线和描述性名称，以 <filename>.rules</filename> 结尾。这些文件中的函数按照目录中文件名的字典顺序执行。例如，<filename>00-foo.rules</filename> 排序在 <filename>60-bar.rules</filename> 甚至 <filename>90-default-privs.rules</filename> 之前（因此会先执行）。
   </para>
   <para>
    在规则文件中，脚本通常会检查要授权的操作 ID。例如，要允许 <systemitem class="groupname">admin</systemitem> 组的任何成员执行 <command>gparted</command> 命令，请检查操作 ID <literal>org.opensuse.policykit.gparted</literal>：
   </para>
<screen>/* Allow users in admin group to run GParted without authentication */
polkit.addRule(function(action, subject) {
    if (action.id == "org.opensuse.policykit.gparted" &amp;&amp;
        subject.isInGroup("admin")) {
        return polkit.Result.YES;
    }
});</screen>
   <para>
    <link xlink:href="http://www.freedesktop.org/software/polkit/docs/latest/ref-api.html"/> 上提供了 Polkit API 中各函数的所有类和方法的说明。
   </para>
  </sect2>

  <sect2 xml:id="sec-security-polkit-change-modify-config-implicit">
   <title>修改 SUSE 默认特权</title>
   <para>
    如<xref linkend="sec-security-polkit-policies-default"/>中所述，SUSE 为上游开发人员定义的 Polkit 隐式授权设置随附了不同的覆盖配置文件。可以在 <filename>/etc/polkit-default-privs.local</filename> 中定义自定义特权。此处定义的特权始终优先于预定义的配置文件设置。要添加自定义特权设置，请执行以下操作：
   </para>
   <procedure xml:id="pro-custom-privileges">
    <title>修改默认特权</title>
    <step>
     <para>
      编辑 <filename>/etc/polkit-default-privs.local</filename>。要定义特权，请使用以下格式为每个操作添加一行：
     </para>
<screen><replaceable>&lt;action-id&gt;</replaceable>     <replaceable>&lt;auth_any&gt;</replaceable>:<replaceable>&lt;auth_inactive&gt;</replaceable>:<replaceable>&lt;auth_active&gt;</replaceable></screen>
     <para>
      或者，如果所有三个类别接收相同的值，您也可以仅指定一个值：
     </para>
<screen><replaceable>&lt;action-id&gt;</replaceable>     <replaceable>&lt;auth_all&gt;</replaceable></screen>
     <para>
      例如：
     </para>
<screen>org.freedesktop.color-manager.modify-profile     auth_admin_keep</screen>
    </step>
    <step>
     <para>
      以 <systemitem class="username">root</systemitem> 身份运行此工具，使更改生效：
     </para>
     <screen><prompt role="root"># </prompt><command>/sbin/set_polkit_default_privs</command></screen>
    </step>
   </procedure>
   <para>
   有关 SUSE Polkit 默认特权的完整文档，请参见 <command>man polkit-default-privs</command>。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-security-polkit-change-defaults">
  <title>恢复 SUSE 默认特权</title>

  <para>
   要恢复 SUSE 默认授权设置，请执行以下步骤：
  </para>

  <procedure xml:id="pro-restore-polkit-defaults">
   <title>恢复 <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 默认设置</title>
   <step>
    <para>
     按照<xref linkend="sec-security-polkit-policies-default"/>中所述选择所需的配置文件
    </para>
   </step>
   <step>
    <para>
     从 <filename>/etc/polkit-default-privs.local</filename> 中去除所有覆盖项。
    </para>
   </step>
   <step>
    <para>
     运行 <command>set_polkit_default_privs</command> 以重新生成默认规则。
    </para>
   </step>
  </procedure>
 </sect1>
</chapter>
