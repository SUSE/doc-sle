<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="security_cron_at.xml" version="5.0" role="General" xml:id="cha-sec-cron-at">
 <info>
  <title>限制 <systemitem class="daemon">cron</systemitem> 和 <systemitem class="daemon">at</systemitem></title>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    本章介绍如何限制 <systemitem class="daemon">cron</systemitem> 和 <systemitem class="daemon">at</systemitem> 守护程序的访问权限以提高系统的安全性。
   </para>
  </abstract>
 </info>
 <sect1>
  <title>限制 <systemitem class="daemon">cron</systemitem> 守护程序</title>
  <para>
   <systemitem class="daemon">cron</systemitem> 系统用于在预定义的时间自动在后台运行命令。有关 <systemitem class="daemon">cron</systemitem> 的详细信息，请参见<xref linkend="sec-suse-packages-cron"/>。
  </para>
  <para>
   <filename>cron.allow</filename> 文件指定有权通过 <systemitem class="daemon">cron</systemitem> 执行作业的用户列表。默认情况下该文件不存在，因此所有用户（<filename>cron.deny</filename> 中列出的用户除外）都可以创建 <systemitem class="daemon">cron</systemitem> 作业。
  </para>
  <procedure>
   <para>
    要防止除 <systemitem class="username">root</systemitem> 以外的用户创建 <systemitem class="daemon">cron</systemitem> 作业，请执行以下步骤。
   </para>
   <step>
    <para>
     创建空文件 <filename>/etc/cron.allow</filename>：
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> <command>touch</command> /etc/cron.allow</screen>
   </step>
   <step>
    <para>
     通过将用户名添加到该文件来允许这些用户创建 <systemitem class="daemon">cron</systemitem> 作业：
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> <command>echo</command> "tux" &gt;&gt; /etc/cron.allow</screen>
   </step>
   <step>
    <para>
     要进行校验，请尝试以 <filename>cron.allow</filename> 中列出的非 root 用户身份创建 <systemitem class="daemon">cron</systemitem> 作业。此时应会看到以下消息：
    </para>
<screen><prompt>tux &gt; </prompt><command>crontab -e</command>
no crontab for tux - using an empty one</screen>
    <para>
     退出 crontab 编辑器，并尝试以该文件中<emphasis>未</emphasis>列出的某个用户身份执行相同的操作（或者在此过程的步骤 2 中添加该用户之前执行该操作）：
    </para>
<screen><prompt>wilber &gt; </prompt><command>crontab -e</command>
You (wilber) are not allowed to use this program (crontab)
See crontab(1) for more information</screen>
   </step>
  </procedure>
  <important>
   <title>现有 <systemitem class="daemon">cron</systemitem> 作业</title>
   <para>
    实现 <function>cron.allow</function> 只能防止用户创建新的 <systemitem class="daemon">cron</systemitem> 作业。即使对于 <filename>cron.deny</filename> 中列出的用户而言，现有作业仍将运行。为防止出现这种情况，请如上所述创建该文件，并从目录 <filename>/var/spool/cron/tabs</filename> 中去除现有用户 crontabs，以确保不再运行现有作业。
   </para>
  </important>
  <note>
   <title>切换到 <systemitem class="daemon">systemd</systemitem> 计时器单元</title>
   <para>
    还应考虑切换到 <systemitem class="daemon">systemd</systemitem> 计时器单元，因为它们能够以更有效且可靠的方式执行任务。默认情况下，用户在未登录时无法使用这些单元来运行代码。这会限制用户在未连接到系统的情况下与系统交互的方式。
   </para>
   <para>
    有关 <systemitem class="daemon">systemd</systemitem> 计时器单位的详细信息，请参见<xref linkend="sec-boot-systemd-timer-units"/>。
   </para>
  </note>
 </sect1>

 <sect1>
  <title>限制 <systemitem class="daemon">at</systemitem> 调度器</title>
  <para>
   <systemitem class="daemon">at</systemitem> 作业执行系统允许用户调度一次性运行的作业。<filename>at.allow</filename> 文件指定有权通过 <systemitem class="daemon">at</systemitem> 调度作业的用户列表。默认情况下该文件不存在，因此所有用户（<filename>at.deny</filename> 中列出的用户除外）都可以调度 <systemitem class="daemon">at</systemitem> 作业
  </para>
  <procedure>
   <para>
    要防止除 <systemitem class="username">root</systemitem> 以外的用户使用 <systemitem class="daemon">at</systemitem> 调度作业，请执行以下步骤。
   </para>
   <step>
    <para>
     创建空文件 <filename>/etc/at.allow</filename>：
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> <command>touch</command> /etc/at.allow</screen>
   </step>
   <step>
    <para>
     通过将用户名添加到该文件来允许这些用户使用 <systemitem class="daemon">at</systemitem> 调度作业：
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> <command>echo</command> "tux" &gt;&gt; /etc/at.allow</screen>
   </step>
   <step>
    <para>
     要进行校验，请尝试以 <filename>at.allow</filename> 中列出的非 root 用户身份调度某个作业：
    </para>
<screen><prompt>tux &gt; </prompt><command>at 00:00</command>
at&gt;</screen>
    <para>
     使用 <keycombo><keycap function="control"/><keycap>C</keycap></keycombo> 退出 <systemitem class="daemon">at</systemitem>提示，并尝试以该文件中<emphasis>未</emphasis>列出的某个用户身份执行相同的操作（或者在此过程的步骤 2 中添加该用户之前执行该操作）：
    </para>
<screen><prompt>wilber &gt; </prompt><command>at 00:00</command>
You do not have permission to use at.</screen>
   </step>
  </procedure>
   <note>
   <title>卸装 <systemitem class="daemon">at</systemitem></title>
   <para>
    <systemitem class="daemon">at</systemitem> 不再广泛使用。如果您没有有效的用例，请考虑卸装该守护程序，而不仅仅是限制其访问权限。
   </para>
  </note>
 </sect1>

</chapter>
