<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="chrony.xml" version="5.0" xml:id="cha-ntp">



  <title>Sincronização de horário com NTP</title>
  <info>
    <abstract>
      <para>
        O mecanismo NTP (network time protocol) é um protocolo para sincronizar o horário do sistema na rede. Primeiro, uma máquina pode obter o horário de um servidor, que é uma fonte de horário confiável. Segundo, a máquina pode agir como uma fonte de horário para outros computadores na rede. O objetivo é duplo: manter o tempo absoluto e a sincronização do horário do sistema de todas as máquinas na rede.
      </para>
    </abstract>
    <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
      <dm:bugtracker/>
      <dm:translation>yes</dm:translation>
    </dm:docmanager>
  </info>
  <para>
    Manter um horário exato do sistema é importante em várias situações. Geralmente, o relógio do hardware incorporado não atende aos requisitos dos aplicativos, como bancos de dados ou clusters. A correção manual do horário do sistema levaria a problemas severos pois, por exemplo, um pulo inverso pode causar o mau funcionamento de aplicativos críticos. Em uma rede, geralmente é necessário sincronizar o horário do sistema de todas as máquinas, porém, o ajuste manual do horário não é um bom método. O NTP dispõe de um mecanismo para resolver esses problemas. O serviço NTP ajusta continuamente o horário do sistema com servidores de horário confiáveis na rede. Ele habilita também o gerenciamento de relógios de referência local como relógios controlados pelo rádio.
  </para>
  <para>
    A partir do <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 15, o <systemitem class="resource">chrony</systemitem> é a implementação padrão do NTP. O <systemitem class="resource">chrony</systemitem> inclui duas partes: <systemitem class="daemon">chronyd</systemitem> é um daemon que pode ser iniciado no momento da inicialização e <command>chronyc</command> é um programa de interface de linha de comando que monitora o desempenho do <systemitem class="daemon">chronyd</systemitem> e altera parâmetros operacionais em runtime.
  </para>
  <para>
    A partir do <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 15.2, o módulo do YaST para configuração do cliente NTP define o systemd-timer, em vez do daemon cron, para executar o <systemitem class="resource">chrony</systemitem>, quando ele não está configurado para ser executado como daemon.
  </para>
  <note os="sled;osuse">
    <para>
      Para habilitar a sincronização de horário por meio do diretório ativo, siga as instruções em <xref linkend="proc-ad-join"/>.
    </para>
  </note>
  <sect1 xml:id="sec-ntp-yast">
    <title>Configurando um cliente NTP com YaST</title>

    <para>
      O daemon do NTP (<systemitem class="daemon">chronyd</systemitem>) que acompanha o pacote <systemitem>chrony</systemitem> vem predefinido para usar o relógio do hardware do computador local como referência de horário. A precisão de um relógio de hardware depende substancialmente da sua fonte de horário. Por exemplo, um relógio atômico ou um receptor GPS é uma fonte de horário precisa, enquanto um chip RTC comum não é uma fonte de horário confiável. O YaST simplifica a configuração de um cliente NTP.
    </para>

    <para>
      Na janela de configuração do cliente NTP do YaST (<menuchoice><guimenu>Serviços de rede</guimenu> <guimenu>Configuração do NTP</guimenu></menuchoice>), você pode especificar quando iniciar o daemon do NTP, o tipo de fonte de configuração e adicionar servidores de horário personalizados.
    </para>

    <figure>
      <title>Janela de configuração do NTP</title>
      <mediaobject>
        <imageobject role="fo">
          <imagedata fileref="ntp_client.png" width="70%"/>
        </imageobject>
        <imageobject role="html">
          <imagedata fileref="ntp_client.png" width="70%"/>
        </imageobject>
      </mediaobject>
    </figure>

    <sect2>
      <title>Início do daemon do NTP</title>
      <para>
        Há três opções que você pode escolher para iniciar o daemon do NTP:
      </para>
      <variablelist>
        <varlistentry>
          <term><guimenu>Apenas manualmente</guimenu></term>
          <listitem>
            <para>
              Selecione <guimenu>Apenas Manualmente</guimenu> para iniciar manualmente o daemon <systemitem class="resource">chrony</systemitem>.
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><guimenu>Sincronizar sem daemon</guimenu></term>
          <listitem>
            <para>
              Selecione <guimenu>Sincronizar sem daemon</guimenu> para definir o horário do sistema periodicamente sem a execução permanente do <systemitem class="resource">chrony</systemitem>. Você pode definir o <guimenu>Intervalo da sincronização em minutos</guimenu>.
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><guimenu>Agora e ao inicializar</guimenu></term>
          <listitem>
            <para>
              Selecione <guimenu>Agora e ao inicializar</guimenu> para iniciar o <systemitem class="daemon">chronyd</systemitem> automaticamente quando o sistema for inicializado. Essa configuração é recomendada.
            </para>
          </listitem>
        </varlistentry>
      </variablelist>
    </sect2>

    <sect2>
      <title>Tipo de fonte de configuração</title>
      <para>
        Na caixa suspensa <guimenu>Fonte de configuração</guimenu>, selecione <guimenu>Dinâmico</guimenu> ou <guimenu>Estático</guimenu>. Defina como <guimenu>Estático</guimenu> se o seu servidor usa apenas um conjunto fixo de servidores NTP (públicos). A opção <guimenu>Dinâmico</guimenu> é melhor quando sua rede interna oferece servidores NTP via DHCP.
      </para>
    </sect2>

    <sect2 xml:id="sec-net-ntp-yast-new-sync">
      <title>Configurar servidores de horário</title>
      <para>
        Os servidores de horário para consulta do cliente estão listados na parte inferior da janela <guimenu>Configuração do NTP</guimenu>. Modifique esta lista conforme necessário com <guimenu>Adicionar</guimenu>, <guimenu>Editar</guimenu> e <guimenu>Apagar</guimenu>.
      </para>
      <para>
        Clique em <guimenu>Adicionar</guimenu> para adicionar um novo servidor de horário:
      </para>
      <figure>
        <title>Adicionando um servidor de horário</title>
        <mediaobject>
          <imageobject role="fo">
            <imagedata fileref="ntp_client_serveradd.png" width="70%"/>
          </imageobject>
          <imageobject role="html">
            <imagedata fileref="ntp_client_serveradd.png" width="70%"/>
          </imageobject>
        </mediaobject>
      </figure>
      <procedure>
        <step>
          <para>
            No campo <guimenu>Endereço</guimenu>, digite o URL do servidor de horário ou do pool de servidores de horário com o qual você deseja sincronizar o horário da máquina. Depois que o URL estiver completo, clique em <guimenu>Testar</guimenu> para verificar se ele aponta para uma fonte de horário válida.
          </para>
        </step>
        <step>
          <para>
            Ative <guimenu>Sincronização inicial rápida</guimenu> para acelerar a sincronização de horário por meio do envio de mais solicitações quando o daemon <systemitem class="daemon">chronyd</systemitem> é iniciado.
          </para>
        </step>
        <step>
          <para>
            Ative <guimenu>Iniciar offline</guimenu> para acelerar o tempo de inicialização nos sistemas que iniciam o daemon <systemitem class="daemon">chronyd</systemitem> automaticamente e podem não ter uma conexão de Internet no momento da inicialização. Essa opção é útil, por exemplo, para laptops com conexões de rede gerenciadas pelo NetworkManager.
          </para>
        </step>
        <step>
          <para>
            Clique em <guimenu>OK</guimenu> para confirmar.
          </para>
        </step>
      </procedure>
    </sect2>


  </sect1>



  <sect1 xml:id="sec-net-xntp-netconf">
    <title>Configurando manualmente o NTP na rede</title>

    <para>
      O <systemitem class="resource">chrony</systemitem> lê sua configuração do arquivo <filename>/etc/chrony.conf</filename>. Para manter o relógio do computador sincronizado, você precisa informar ao <systemitem class="resource">chrony</systemitem> quais servidores de horário devem ser usados. Você pode usar nomes de servidores ou endereços IP específicos. Por exemplo:
    </para>

<screen>0.suse.pool.ntp.org
1.suse.pool.ntp.org
2.suse.pool.ntp.org
3.suse.pool.ntp.org</screen>

    <para>
      Você também pode especificar o nome de um <emphasis>pool</emphasis>. O nome do pool é resolvido para vários endereços IP:
    </para>

<screen>pool pool.ntp.org</screen>

    <tip>
      <title>Computadores na mesma rede</title>
      <para>
        Para sincronizar o horário em vários computadores na mesma rede, não é recomendável sincronizar todos eles com um servidor externo. Convém especificar um computador como servidor de horário, que é sincronizado com um servidor de horário externo, e o outro computador atua como cliente dele. Adicione uma diretiva <literal>local</literal> ao <filename>/etc/chrony.conf</filename> do servidor para diferenciá-lo de um servidor de horário autorizado:
      </para>
<screen>local stratum 10</screen>
    </tip>

    <para>
      Para iniciar o <systemitem class="resource">chrony</systemitem>, execute:
    </para>

<screen>systemctl start chronyd.service</screen>

    <para>
      Após a inicialização do <systemitem class="daemon">chronyd</systemitem>, levará um tempo para estabilizar o horário, e o arquivo drift que corrige o relógio do computador local será criado. Com o arquivo DRIFT, o erro sistemático do relógio do hardware pode ser registrado quando o computador é ligado. A correção é usada imediatamente, resultando em uma estabilidade maior do horário do sistema.
    </para>

    <para>
      Para habilitar o serviço que permite iniciar o <systemitem class="resource">chrony</systemitem> automaticamente no momento da inicialização, execute:
    </para>

<screen>systemctl enable chronyd.service</screen>

    <warning>
      <title>Serviço <systemitem class="daemon">yast-timesync.service</systemitem> conflitante</title>
      <para>
        Além do serviço <systemitem class="daemon">chronyd.service</systemitem>, o <phrase role="productname"><phrase os="sled">SLED</phrase></phrase> inclui o <systemitem class="daemon">yast-timesync.service</systemitem>. O <systemitem class="daemon">yast-timesync.service</systemitem> é acionado por um temporizador a cada 5 minutos e executa o <systemitem class="daemon">chronyd</systemitem> com a opção <option>-q</option> para definir o horário do sistema e sair. Como apenas uma instância do <systemitem class="daemon">chronyd</systemitem> pode estar em execução a qualquer momento, não habilite nem inicie os dois serviços relacionados ao <systemitem class="daemon">chronyd</systemitem> simultaneamente.
      </para>
    </warning>
  </sect1>
  <sect1 xml:id="ntp-configure-nts">
    <title>Configurando o NTS</title>

    <para>
      O Network Time Protocol (NTP) é um protocolo usado para sincronizar e manter a precisão do horário do sistema de um ou mais hosts na rede. Este artigo descreve como proteger o NTP usando o Network Time Security (NTS).
    </para>

    <para>
      O protocolo NTP não apresenta nenhum mecanismo de segurança para tornar a comunicação entre o servidor de horário e o cliente autenticada e criptografada. O Network Time Security (NTS) é uma extensão que reforça a segurança do NTP. O <systemitem class="resource">chrony</systemitem> suporta o NTS e pode autenticar fontes de horário e proteger contra determinados ataques à rede.
    </para>

    <para>
      Os procedimentos a seguir descrevem como configurar o servidor de horário e a máquina do cliente para sincronização segura de horário.
    </para>

    <procedure xml:id="configure-nts-procedure">
      <title>Configurando o servidor de horário NTS</title>
      <step performance="optional">
        <para>
          É uma boa ideia configurar o servidor de horário para atualizar o horário pelo NTS. Isso garante uma sincronização de horário segura desde o início da cadeia de sincronização. Comente todas as fontes de horário existentes no arquivo <filename>/etc/chrony.conf</filename> que não suportam NTS e adicione pelo menos uma que suporte NTS, por exemplo:
        </para>
<screen>server time.cloudflare.com iburst nts</screen>
        <tip>
          <para>
            A opção <option>nts</option> solicita a conexão por NTS se ela estiver disponível; do contrário, ela voltará para o NTP se o NTS não estiver disponível.
          </para>
        </tip>
      </step>
      <step>
        <para>
          Reinicie o serviço <systemitem class="daemon">chronyd</systemitem>.
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>systemctl restart chronyd.srvice</command></screen>
      </step>
      <step>
        <para>
          Verifique as fontes de horário configuradas.
        </para>
<screen><prompt>&gt; </prompt><command>chronyc sources -v</command>
MS Name/IP address         Stratum Poll Reach LastRx Last sample               
===============================================================================
^? time.cloudflare.com           3   6     1     2   -947ms[ -947ms] +/-   12ms
^? pyrrha.fi.muni.cz             2   6     1     1   -948ms[ -948ms] +/-   39ms
^* whitesoft-intex16.c.cbsn&gt;     1   6     1     2   -948ms[ -948ms] +/- 5444us
^? mail.combatostrich.dev        2   6     1     1   -948ms[ -948ms] +/-   28ms</screen>
        <note>
          <para>
            A linha que começa com <literal>^*</literal> inclui a fonte de horário que foi selecionada como a melhor.
          </para>
        </note>
        <para>
          Verifique se a fonte de horário configurada usa o modo NTS.
        </para>
<screen><prompt>&gt; </prompt><command>chronyc -N authdata</command>
Name/IP address             Mode KeyID Type KLen Last Atmp  NAK Cook CLen
=========================================================================
[...]
time.cloudflare.com          NTS     1   15  256    3    0    0    8   96</screen>
      </step>
      <step>
        <para>
          Verifique se a configuração do servidor inclui a opção <option>allow</option>, que especifica quais clientes podem sincronizar o horário com o servidor de horário, por exemplo:
        </para>
<screen>allow 192.168.1.0/24</screen>
      </step>
      <step performance="optional">
        <para>
          Se o servidor de horário estiver protegido por um firewall, permita a comunicação nas portas tanto para NTP quanto para NTS. Por padrão, as portas são 123 e 4460.
        </para>
      </step>
      <step>
        <para>
          Obtenha um certificado TLS e uma chave privada correspondente e copie-os para <filename>/var/lib/chrony/</filename>. Verifique se eles são legíveis para o <systemitem class="resource">chrony</systemitem>, por exemplo:
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> install -m 0440 -o chrony -g chrony <replaceable>nts.key</replaceable> /var/lib/chrony/
<prompt>&gt; </prompt><command>sudo</command> install -m 0440 -o chrony -g chrony <replaceable>nts.crt</replaceable> /var/lib/chrony/</screen>
        <tip>
          <para>
            Encontre informações detalhadas sobre certificados TLS em um <link xlink:href="https://documentation.suse.com/smart/security/html/tls-certificates/index.html">artigo específico</link>.
          </para>
        </tip>
      </step>
      <step>
        <para>
          Edite o <filename>/etc/chrony.conf</filename> e verifique se a opção <option>ntsdumpdir /var/lib/chrony</option> está ativa. Em seguida, anexe os caminhos à chave e ao certificado TLS.
        </para>
<screen>ntsdumpdir /var/lib/chrony
ntsserverkey /var/lib/chrony/nts.key
ntsservercert /var/lib/chrony/nts.crt</screen>
      </step>
      <step>
        <para>
          Reinicie o serviço <systemitem class="daemon">chronyd</systemitem>.
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl restart chronyd.service </screen>
      </step>
    </procedure>

    <procedure>
      <title>Configurando os clientes NTS</title>
      <step>
        <para>
          Desabilite as fontes de NTP existentes, por exemplo:
        </para>
<screen>#server 192.168.1.1 iburst</screen>
        <para>
          As configurações dos códigos-fonte estão incluídas no <filename>/etc/chrony.conf</filename> ou nos arquivos em <filename>/etc/chrony.d/</filename>.
        </para>
      </step>
      <step>
        <para>
          O host do cliente precisa confiar na CA raiz que assinou o certificado TLS. Encontre detalhes sobre como gerenciar o armazenamento de certificados de CA em um <link xlink:href="https://documentation.suse.com/smart/security/html/tls-certificates/index.html#tls-certificates-store">artigo específico</link>.
        </para>
      </step>
      <step>
        <para>
          Adicione a fonte do servidor de horário NTS que você configurou no <xref linkend="configure-nts-procedure"/> à configuração do cliente <systemitem class="resource">chrony</systemitem> em <filename>/etc/chrony.conf</filename>, por exemplo:
        </para>
<screen>server <replaceable>nts1.example.com</replaceable> iburst nts</screen>
      </step>
      <step>
        <para>
          Reinicie o serviço <systemitem class="daemon">chronyd</systemitem>.
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl restart chronyd.service</screen>
      </step>
      <step>
        <para>
          Verifique as fontes de horário configuradas no cliente e confirme se a conexão foi autenticada.
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> chronyc sources -v
<prompt>&gt; </prompt><command>sudo</command> chronyc -N authdata</screen>
      </step>
      <step>
        <para>
          No servidor de horário NTS, verifique as estatísticas por cliente sobre as conexões NTS.
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> chronyc -N clients -k</screen>
      </step>
    </procedure>
  </sect1>
  <sect1 xml:id="ntp-chronyc">
    <title>Configurar o <systemitem class="daemon">chronyd</systemitem> em tempo de execução usando o <command>chronyc</command></title>

    <para>
      Você pode usar o <command>chronyc</command> para mudar o comportamento do <systemitem class="daemon">chronyd</systemitem> em tempo de execução. Ele também gera relatórios de status sobre a operação do <systemitem class="daemon">chronyd</systemitem>.
    </para>

    <para>
      Você pode executar o <command>chronyc</command> no modo interativo ou não interativo. Para executar o <command>chronyc</command> interativamente, digite <command>chronyc</command> na linha de comando. Esse procedimento exibe um prompt e aguarda a entrada do seu comando. Por exemplo, para verificar quantas fontes NTP estão online ou offline, execute:
    </para>

<screen><prompt role="root"># </prompt><command>chronyc</command>
chronyc&gt; activity
200 OK
4 sources online
2 sources offline
1 sources doing burst (return to online)
1 sources doing burst (return to offline)
0 sources with unknown address</screen>

    <para>
      Para sair do prompt do <command>chronyc</command>, digite <command>quit</command> ou <command>exit</command>.
    </para>

    <para>
      Se você não precisa usar o prompt interativo, digite o comando diretamente:
    </para>

<screen><prompt role="root"># </prompt><command>chronyc</command> activity</screen>

    <note>
      <title>Mudanças temporárias</title>
      <para>
        As mudanças feitas com o <command>chronyc</command> não são permanentes. Elas serão perdidas após a próxima reinicialização do <systemitem class="daemon">chronyd</systemitem>. Para mudanças permanentes, modifique o <filename>/etc/chrony.conf</filename>.
      </para>
    </note>

    <para>
      Para obter uma lista completa dos comandos do <command>chronyc</command>, consulte a página de manual dele (<command>man
      1 chronyc</command>).
    </para>
  </sect1>
  <sect1 xml:id="sec-net-xntp-dynamic">
    <title>Sincronização de horário dinâmica em tempo de execução</title>



    <para>
      Embora o <systemitem class="daemon">chronyd</systemitem> seja inicializado normalmente em um sistema que inicializa sem uma conexão de rede, a ferramenta não pode resolver os nomes DNS dos servidores de horário especificados no arquivo de configuração.
    </para>

    <para>
      O <systemitem class="daemon">chronyd</systemitem> continua tentando resolver os nomes de servidor de horário especificados pelas diretivas <option>server</option>, <option>pool</option> e <option>peer</option> em um intervalo de tempo crescente até obter êxito.
    </para>

    <para>
      Se o servidor de horário não puder ser acessado quando o <systemitem class="daemon">chronyd</systemitem> for iniciado, você poderá especificar a opção <option>offline</option>:
    </para>

<screen>server <replaceable>server_address</replaceable> offline</screen>

    <para>
      O <systemitem class="daemon">chronyd</systemitem> não tentará fazer poll no servidor até ser habilitado usando o seguinte comando:
    </para>

<screen><prompt role="root"># </prompt>chronyc online <replaceable>server_address</replaceable></screen>

    <para>
      Quando a opção <option>auto_offline</option> está definida, o <systemitem class="daemon">chronyd</systemitem> pressupõe que o servidor de horário estava offline quando duas solicitações foram enviadas a ele sem receber uma resposta. Essa opção evita a necessidade de executar o comando <literal>offline</literal> do <command>chronyc</command> ao desconectar o link de rede.
    </para>
  </sect1>



  <sect1 xml:id="sec-net-xntp-normal">
    <title>Configurando um relógio de referência local</title>

    <para>
      O pacote de software <systemitem class="resource">chrony</systemitem> depende de outros programas (como <systemitem>gpsd</systemitem>) para acessar os dados de horário por meio do driver SHM ou SOCK. Use a diretiva <option>refclock</option> em <filename>/etc/chrony.conf</filename> para especificar um relógio de referência de hardware a ser usado como fonte de horário. Ela tem dois parâmetros obrigatórios: um nome de driver e um parâmetro específico do driver. Os dois parâmetros são seguidos de zero ou mais opções <option>refclock</option>. O <systemitem class="daemon">chronyd</systemitem> inclui os seguintes drivers:
    </para>

    <itemizedlist>
      <listitem>
        <para>
          PPS: driver para a API do kernel <literal>pulse per second</literal>. Por exemplo:
        </para>
<screen>refclock PPS /dev/pps0 lock NMEA refid GPS</screen>
      </listitem>
      <listitem>
        <para>
          SHM: driver de memória compartilhada do NTP. Por exemplo:
        </para>
<screen>refclock SHM 0 poll 3 refid GPS1
refclock SHM 1:perm=0644 refid GPS2</screen>
      </listitem>
      <listitem>
        <para>
          SOCK: driver de soquete de domínio do Unix. Por exemplo:
        </para>
<screen>refclock SOCK /var/run/chrony.ttyS0.sock</screen>
      </listitem>
      <listitem>
        <para>
          PHC: driver de relógio do hardware PTP. Por exemplo:
        </para>
<screen>refclock PHC /dev/ptp0 poll 0 dpoll -2 offset -37
refclock PHC /dev/ptp1:nocrossts poll 3 pps</screen>
      </listitem>
    </itemizedlist>

    <para>
      Para obter mais informações sobre as opções de drivers individuais, consulte <command>man 8
      chrony.conf</command>.
    </para>
  </sect1>
  <sect1 xml:id="sec-net-xntp-etr" arch="zseries">
    <title>Sincronização do relógio com uma Referência de Horário Externa (ETR, External Time Reference)</title>



    <para>
      O suporte para sincronização do relógio com uma referência de horário externa (ETR) está disponível. A referência de horário externa envia um sinal do oscilador e um sinal de sincronização a cada 2**20 (2 elevado à potência de 20) microssegundos para manter sincronizados os relógios TOD de todos os servidores conectados.
    </para>

    <para>
      Para disponibilidade, é possível conectar duas unidades ETR a uma máquina. Se a diferença do relógio for maior do que a tolerância da verificação de sincronização, todas as CPUs terão suas máquinas marcadas indicando que o relógio não está sincronizado. Se isso acontecer, todos os dispositivos DASD de E/S habilitados para XRC serão parados até o relógio ser novamente sincronizado.
    </para>

    <para>
      O suporte a ETR é ativado por meio de dois atributos <literal>sysfs</literal>. Execute os seguintes comandos como <systemitem class="username">root</systemitem>:
    </para>

<screen>echo 1 &gt; /sys/devices/system/etr/etr0/online
echo 1 &gt; /sys/devices/system/etr/etr1/online
</screen>
  </sect1>
</chapter>
