<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="libvirt_managing.xml" version="5.0" xml:id="cha-libvirt-managing">
 <title>基本 VM Guest 管理</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <para>
  使用虚拟机管理器图形应用程序或者在命令行上使用 <command>virsh</command> 可以完成大部分管理任务，例如启动或停止 VM Guest。而要通过 VNC 连接到图形控制台，就只能从图形用户界面进行。
 </para>
 <note>
  <title>管理远程 VM 主机服务器上的 VM Guest</title>
  <para>
   如果 VM 主机服务器上启动了虚拟机管理器、<command>virsh</command> 和 <command>virt-viewer</command> 这些 <systemitem class="library">libvirt</systemitem> 工具，则可以使用它们来管理主机上的 VM Guest。不过，您也可以管理远程 VM 主机服务器上的 VM Guest。这需要在主机上为 <systemitem class="library">libvirt</systemitem> 配置远程访问权限。有关说明，请参见<xref linkend="cha-libvirt-connect"/>。
  </para>
  <para>
   要使用虚拟机管理器连接到此类远程主机，需要按照<xref linkend="sec-libvirt-connect-connecting-vmm"/>中所述设置连接。如果通过 <command>virsh</command> 或 <command>virt-viewer</command> 连接到远程主机，需要使用参数 <option>-c</option> 指定连接 URI（例如，<command>virsh -c qemu+tls://saturn.example.com/system</command> 或 <command>virsh -c xen+ssh://</command>）。连接 URI 的格式取决于连接类型和超级管理程序 — 有关细节，请参见<xref linkend="sec-libvirt-connect-connecting"/>。
  </para>
  <para>
   本章列出的所有示例都不包含连接 URI。
  </para>
 </note>
 <sect1 xml:id="sec-libvirt-managing-list">
  <title>列出 VM Guest</title>

  <para>
   VM Guest 列表显示 VM 主机服务器上由 <systemitem class="library">libvirt</systemitem> 管理的所有 VM Guest。
  </para>

  <sect2 xml:id="sec-libvirt-managing-list-vmm">
   <title>使用虚拟机管理器列出 VM Guest</title>
   <para>
    虚拟机管理器的主窗口会列出它所连接的每台 VM 主机服务器的所有 VM Guest。每个 VM Guest 项包含该计算机的名称及状态（<guimenu>正在运行</guimenu>、<guimenu>已暂停</guimenu>或<guimenu>已关闭</guimenu>），这些信息以图标、文本和 CPU 使用率条的形式显示。
   </para>
  </sect2>

  <sect2 xml:id="sec-libvirt-managing-list-virsh">
   <title>使用 <command>virsh</command> 列出 VM Guest</title>
   <para>
    使用 <command>virsh</command> <option>list</option> 命令可获取 VM Guest 的列表：
   </para>
   <variablelist>
    <varlistentry>
     <term>列出所有正在运行的 Guest</term>
     <listitem>
<screen><prompt>&gt; </prompt>virsh list</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>列出所有正在运行的 Guest 以及非活动的 Guest</term>
     <listitem>
<screen><prompt>&gt; </prompt>virsh list --all</screen>
     </listitem>
    </varlistentry>
   </variablelist>
   <para>
    有关详细信息和其他选项，请参见 <command>virsh help list</command> 或 <command>man 1 virsh</command>。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-libvirt-managing-console">
  <title>通过控制台访问 VM Guest</title>

  <para>
   可以通过 VNC 连接（图形控制台）或串行控制台（如果受 Guest 操作系统的支持）访问 VM Guest。
  </para>

  <sect2 xml:id="sec-libvirt-managing-console-vnc">
   <title>打开图形控制台</title>
   <para>
    打开与 VM Guest 连接的图形控制台可与该计算机交互，就如同通过 VNC 连接与物理主机交互一样。如果访问 VNC 服务器需要身份验证，系统会提示您输入用户名（如果适用）和口令。
   </para>
   <para>
    当您单击进入 VNC 控制台时，光标将被<quote>夺取</quote>，不能再在控制台外部使用。要释放光标，请按 <keycombo> <keycap function="alt"/> <keycap function="control"/>
    </keycombo>。
   </para>
   <tip>
    <title>无缝（绝对）光标移动</title>
    <para>
     为防止控制台夺取光标，同时为了启用无缝光标移动，请向 VM Guest 添加绘图板输入设备。有关更多信息，请参见<xref linkend="sec-libvirt-config-input"/>。
    </para>
   </tip>
   <para>
    某些组合键（例如 <keycombo> <keycap function="control"/>
    <keycap function="alt"/> <keycap function="delete"/> </keycombo>）由主机解释，不会传递给 VM Guest。要将此类组合键传递给 VM Guest，请在 VNC 窗口中打开<guimenu>发送键</guimenu>菜单，然后选择所需的组合键项。仅当使用虚拟机管理器和 <command>virt-viewer</command> 时，<guimenu>发送键</guimenu>菜单才可用。借助虚拟机管理器，可以按照<xref linkend="tip-libvirt-inst-vmm-sticky"/>中所述改用<quote>粘滞键</quote>功能。
   </para>
   <note>
    <title>支持的 VNC 查看器</title>
    <para>
     理论上而言，所有 VNC 查看器都可连接到 VM Guest 的控制台。但如果您是使用 SASL 身份验证和/或 TLS/SSL 连接来访问 Guest 的，那么您的选择就比较有限。<command>tightvnc</command> 或 <command>tigervnc</command> 等常见 VNC 查看器既不支持 SASL 身份验证，也不支持 TLS/SSL。唯一可替代虚拟机管理器和 <command>virt-viewer</command> 的工具是 Remmina（请参见<xref linkend="vnc-remmina"/>）。
    </para>
   </note>
   <sect3 xml:id="sec-libvirt-managing-console-vnc-vmm">
    <title>使用虚拟机管理器打开图形控制台</title>
    <procedure>
     <step>
      <para>
       在虚拟机管理器中，右键单击某个 VM Guest 项。
      </para>
     </step>
     <step>
      <para>
       从弹出菜单中选择<guimenu>打开</guimenu>。
      </para>
     </step>
    </procedure>
   </sect3>
   <sect3 xml:id="sec-libvirt-managing-vnc-viewer">
    <title>使用 <command>virt-viewer</command> 打开图形控制台</title>
    <para>
     <command>virt-viewer</command> 是一个简单的 VNC 查看器，其中添加了用于显示 VM Guest 控制台的功能。例如，可以 <quote>wait</quote> 模式启动该查看器，在此情况下，它会先等待 VM Guest 启动，然后再建立连接。它还支持自动重新连接到重引导的 VM Guest。
    </para>
    <para>
     <command>virt-viewer</command> 按名称、ID 或 UUID 对 VM Guest 进行寻址。使用 <command>virsh</command> <option>list --all</option> 可获取这些数据。
    </para>
    <para>
     要连接到正在运行或已暂停的 Guest，请使用 ID、UUID 或名称。已关闭的 VM Guest 没有 ID — 您只能按 UUID 或名称与其建立连接。
    </para>
    <variablelist>
     <varlistentry>
      <term>连接到 ID 为 <literal>8</literal> 的 Guest</term>
      <listitem>
<screen><prompt>&gt; </prompt>virt-viewer 8</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>连接到名为 <literal>sles12</literal> 的非活动 Guest；Guest 启动后，连接窗口就会打开</term>
      <listitem>
<screen><prompt>&gt; </prompt>virt-viewer --wait sles12</screen>
       <para>
        如果使用 <option>--wait</option> 选项，即使 VM Guest 此刻未运行，也会保持连接。当 Guest 启动时，查看器即会启动。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     有关详细信息，请参见 <command>virt-viewer</command>
     <option>--help</option> 或 <command>man 1 virt-viewer</command>。
    </para>
    <note>
     <title>通过 SSH 建立远程连接时输入的口令</title>
     <para>
      使用 <command>virt-viewer</command> 通过 SSH 来与远程主机建立连接时，需要输入 SSH 口令两次。第一次用于向 <systemitem class="library">libvirt</systemitem> 进行身份验证，第二次用于向 VNC 服务器进行身份验证。第二个口令需要在启动 virt-viewer 的命令行上提供。
     </para>
    </note>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-libvirt-managing-console-serial">
   <title>打开串行控制台</title>
   <para>
    要访问虚拟机的图形控制台，需要在访问 VM Guest 的客户端上提供一个图形环境。或者，也可通过串行控制台和 <command>virsh</command> 在外壳中访问使用 libvirt 管理的虚拟机。要打开与名为 <quote>sles12</quote> 的 VM Guest 连接的串行控制台，请运行以下命令：
   </para>
<screen><prompt>&gt; </prompt>virsh console sles12</screen>
   <para>
    <command>virsh console</command> 接受两个可选标志：<option>--safe</option> 确保以独占方式访问控制台，<option>--force</option> 在连接之前断开与所有现有会话的连接。这两个功能需受 Guest 操作系统的支持。
   </para>
   <para>
    Guest 操作系统必须支持串行控制台访问，并且该操作系统也受到适当的支持，才能通过串行控制台连接到 VM Guest。有关详细信息，请参见 Guest 操作系统手册。
   </para>
   <tip>
    <title>为 SUSE Linux Enterprise Guest 和 openSUSE Guest 启用串行控制台访问</title>
    <para>
     SUSE Linux Enterprise 和 openSUSE 中默认会禁用串行控制台访问。要启用它，请执行下列步骤：
    </para>
    <variablelist>
     <varlistentry>
      <term>SLES 12 和 up/openSUSE</term>
      <listitem>
       <para>
        启动 YaST 引导加载器模块并切换到<guimenu>内核参数</guimenu>选项卡。将 <literal>console=ttyS0</literal> 添加到字段<guimenu>可选内核命令行参数</guimenu>。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>SLES 11</term>
      <listitem>
       <para>
        启动 YaST 引导加载器模块，并选择要为其激活串行控制台访问的引导项。选择<guimenu>编辑</guimenu>，并将 <literal>console=ttyS0</literal> 添加到字段<guimenu>可选内核命令行参数</guimenu>。此外，请编辑 <filename>/etc/inittab</filename> 并取消注释包含以下内容的行：
       </para>
<screen>#S0:12345:respawn:/sbin/agetty -L 9600 ttyS0 vt102</screen>
      </listitem>
     </varlistentry>
    </variablelist>
   </tip>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-libvirt-managing-status">
  <title>更改 VM Guest 的状态：启动、停止、暂停</title>

  <para>
   可以使用虚拟机管理器或 <command>virsh</command> 来启动、停止或暂停 VM Guest。您还可以将 VM Guest 配置为在引导 VM 主机服务器时自动启动。
  </para>

  <para>
   关闭 VM Guest 时，可将其正常关机或强制关机。后一种操作的效果等同于拔下物理主机上的电源插头，建议仅在没有其他办法时才这样做。强制关机可能导致 VM Guest 上的文件系统损坏或数据丢失。
  </para>

  <tip>
   <title>正常关机</title>
   <para>
    要能够执行正常关机，必须将 VM Guest 配置为支持 <xref linkend="gloss-vt-acpi"/>。如果 Guest 是使用虚拟机管理器创建的，则可在 VM Guest 中使用 ACPI。
   </para>
   <para>
    根据 Guest 操作系统，能够使用 ACPI 可能还不足以执行正常关机。在生产环境中使用 Guest 之前，强烈建议先对其进行关机和重引导测试。例如，openSUSE 或 SUSE Linux Enterprise Desktop 可能需要获得 PolKit 授权才能关机和重引导。确保已在所有 VM Guest 上关闭此策略。
   </para>
   <para>
    如果在安装 Windows XP/Windows Server 2003 Guest 期间启用了 ACPI，只在 VM Guest 配置中开启 ACPI 并不足够。有关更多信息，请参见:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      <link xlink:href="https://support.microsoft.com/en-us/kb/314088"/>
     </para>
    </listitem>
    <listitem>
     <para>
      <link xlink:href="https://support.microsoft.com/en-us/kb/309283"/>
     </para>
    </listitem>
   </itemizedlist>
   <para>
    无论 VM Guest 的配置如何，始终都可以从 Guest 操作系统内部实现正常关机。
   </para>
  </tip>

  <sect2 xml:id="sec-libvirt-managing-status-vmm">
   <title>使用虚拟机管理器更改 VM Guest 的状态</title>
   <para>
    可以通过虚拟机管理器的主窗口或 VNC 窗口更改 VM Guest 的状态。
   </para>
   <procedure>
    <title>通过虚拟机管理器窗口更改状态</title>
    <step>
     <para>
      右键单击某个 VM Guest 项。
     </para>
    </step>
    <step>
     <para>
      在弹出菜单中选择<guimenu>运行</guimenu>、<guimenu>暂停</guimenu>或其中一个<guimenu>关机选项</guimenu>。
     </para>
    </step>
   </procedure>
   <procedure>
    <title>通过 VNC 窗口更改状态</title>
    <step>
     <para>
      按照<xref linkend="sec-libvirt-managing-console-vnc-vmm"/>中所述打开 VNC 窗口。
     </para>
    </step>
    <step>
     <para>
      在工具栏或<guimenu>虚拟机</guimenu>菜单中，选择<guimenu>运行</guimenu>、<guimenu>暂停</guimenu>或其中一个<guimenu>关机</guimenu>选项。
     </para>
    </step>
   </procedure>
   <sect3 xml:id="sec-libvirt-managing-status-vmm-autostart">
    <title>自动启动 VM Guest</title>
    <para>
     您可以在引导 VM 主机服务器时自动启动 Guest。此功能默认未启用，需要为每个 VM Guest 单独启用。无法全局激活此功能。
    </para>
    <procedure>
     <step>
      <para>
       在虚拟机管理器中双击 VM Guest 项以打开其控制台。
      </para>
     </step>
     <step>
      <para>
       选择<menuchoice> <guimenu>视图</guimenu>
       <guimenu>细节</guimenu></menuchoice>打开 VM Guest 配置窗口。
      </para>
     </step>
     <step>
      <para>
       选择<guimenu>引导选项</guimenu>，然后选中<guimenu>在主机引导时启动虚拟机</guimenu>。
      </para>
     </step>
     <step>
      <para>
       单击<guimenu>应用</guimenu>保存新配置。
      </para>
     </step>
    </procedure>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-libvirt-managing-status-virsh">
   <title>使用 <command>virsh</command> 更改 VM Guest 的状态</title>
   <para>
    以下示例会更改名为 <quote>sles12</quote> 的 VM Guest 的状态。
   </para>
   <variablelist>
    <varlistentry>
     <term>开始</term>
     <listitem>
<screen><prompt>&gt; </prompt>virsh start sles12</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>暂停</term>
     <listitem>
<screen><prompt>&gt; </prompt>virsh suspend sles12</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>恢复（已暂停的 VM Guest）</term>
     <listitem>
<screen><prompt>&gt; </prompt>virsh resume sles12</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>重引导</term>
     <listitem>
<screen><prompt>&gt; </prompt>virsh reboot sles12</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>正常关机</term>
     <listitem>
<screen><prompt>&gt; </prompt>virsh shutdown sles12</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>强制关机</term>
     <listitem>
<screen><prompt>&gt; </prompt>virsh destroy sles12</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>开启自动启动</term>
     <listitem>
<screen><prompt>&gt; </prompt>virsh autostart sles12</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>关闭自动启动</term>
     <listitem>
<screen><prompt>&gt; </prompt>virsh autostart --disable sles12</screen>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-libvirt-manage-save">
  <title>保存和恢复 VM Guest 的状态</title>

  <para>
   保存 VM Guest 会保留其内存的确切状态。该操作类似于将计算机<emphasis>休眠</emphasis>。保存的 VM Guest 可以快速恢复到以前保存的运行中状况。
  </para>

  <para>
   保存时，VM Guest 将会暂停，其当前内存状态将保存到磁盘，然后该 Guest 停止。该操作不会复制 VM Guest 虚拟磁盘的任何一部分。保存虚拟机所需的时长取决于分配的内存量。保存时，VM Guest 的内存将返回到 VM 主机服务器上的可用内存池。
  </para>

  <para>
   恢复操作将装载先前保存的 VM Guest 内存状态文件并启动该 Guest。该 Guest 不会引导，而是在以前保存它的位置继续运行。该操作类似于退出休眠状态。
  </para>

  <para>
   VM Guest 将保存到某个状态文件。请确保要保存到的分区有足够的空间。要估计预期的文件大小（以 MB 为单位），请在 Guest 上发出以下命令：
  </para>

<screen><prompt>&gt; </prompt>free -mh | awk '/^Mem:/ {print $3}'</screen>

  <warning xml:id="adm-vm-restore">
   <title>始终恢复保存的 Guest</title>
   <para>
    使用保存操作后，请不要引导或启动保存的 VM Guest。这样做会使计算机的虚拟磁盘和保存的内存状态不同步，有可能导致在恢复 Guest 时发生严重错误。
   </para>
   <para>
    要能够再次使用保存的 VM Guest，请使用恢复操作。如果您是使用 <command>virsh</command> 保存 VM Guest 的，将无法使用虚拟机管理器将其恢复。在这种情况下，请务必使用 <command>virsh</command> 进行恢复。
   </para>
  </warning>

  <important>
   <title>恢复 VM Guest 后同步其时间</title>
   <para>
    如果您在保存 VM Guest 后，经过长时间（数小时）的暂停再恢复该 Guest，其时间同步服务（例如 <systemitem class="daemon">chronyd</systemitem>）可能会拒绝同步其时间。在这种情况下，请手动同步 VM Guest 的时间。例如，对于 KVM 主机，可以使用 QEMU Guest 代理，并使用 <command>guest-set-time</command> 来指示 Guest 设置时间。有关更多详细信息，请参见<xref linkend="cha-qemu-ga"/>。
   </para>
  </important>

  <important>
   <title>仅适用于磁盘类型为 <literal>raw</literal>、<literal>qcow2</literal> 的 VM Guest</title>
   <para>
    仅当 VM Guest 使用的虚拟磁盘为 <literal>raw</literal> (<filename>.img</filename>) 或 <emphasis>qcow2</emphasis> 类型时，才可以保存和恢复该 VM Guest。
   </para>
  </important>

  <sect2 xml:id="sec-libvirt-manage-save-vmm">
   <title>使用虚拟机管理器保存/恢复</title>
   <procedure>
    <title>保存 VM Guest</title>
    <step>
     <para>
      打开 VM Guest 的 VNC 连接窗口。确保该 Guest 正在运行。
     </para>
    </step>
    <step>
     <para>
      选择<menuchoice> <guimenu>虚拟机</guimenu>
      <guimenu>关机</guimenu> <guimenu>保存</guimenu> </menuchoice>。
     </para>
    </step>
   </procedure>
   <procedure>
    <title>恢复 VM Guest</title>
    <step>
     <para>
      打开 VM Guest 的 VNC 连接窗口。确保该 Guest 未运行。
     </para>
    </step>
    <step>
     <para>
      选择<menuchoice> <guimenu>虚拟机</guimenu>
      <guimenu>恢复</guimenu> </menuchoice>。
     </para>
     <para>
      如果 VM Guest 以前是使用虚拟机管理器保存的，则系统不会为您提供用于<guimenu>运行</guimenu>该 Guest 的选项。但请注意<xref linkend="adm-vm-restore"/>中所述的有关使用 <command>virsh</command> 保存的计算机的注意事项。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec-libvirt-manage-save-virsh">
   <title>使用 <command>virsh</command> 保存和恢复</title>
   <para>
    使用 <command>virsh</command>
    <option>save</option> 命令保存运行中的 VM Guest，并指定要将其保存到的文件。
   </para>
   <variablelist>
    <varlistentry>
     <term>保存名为 <literal>opensuse13</literal> 的 Guest</term>
     <listitem>
<screen><prompt>&gt; </prompt>virsh save opensuse13 /virtual/saves/opensuse13.vmsav</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>保存 ID 为 <literal>37</literal> 的 Guest</term>
     <listitem>
<screen><prompt>&gt; </prompt>virsh save 37 /virtual/saves/opensuse13.vmsave</screen>
     </listitem>
    </varlistentry>
   </variablelist>
   <para>
    要恢复 VM Guest，请使用 <command>virsh</command>
    <option>restore</option>：
   </para>
<screen><prompt>&gt; </prompt>virsh restore /virtual/saves/opensuse13.vmsave</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-libvirt-managing-snapshots">
  <title>创建和管理快照</title>

  <para>
   VM Guest 快照是整个虚拟机的快照，包括 CPU、RAM、设备的状态，以及所有可写磁盘的内容。要使用虚拟机快照，所有挂接的硬盘均需使用 qcow2 磁盘映像格式，并且其中至少有一个硬盘需是可写的。
  </para>

  <para>
   快照可让您将计算机恢复到特定时间点的状态。在撤消有错误的配置或者安装大量软件包时，此功能十分有用。启动一个在 VM Guest 处于关闭状态下创建的快照后，需要引导该 Guest。在该时间点之后写入磁盘的所有更改都将在启动快照时丢失。
  </para>

  <note>
   <para>
    快照仅在 KVM VM 主机服务器上受支持。
   </para>
  </note>

  <sect2 xml:id="libvirt-snapshots-terminology">
   <title>术语</title>
   <para>
    有多个特定术语用于描述快照的类型：
   </para>
   <variablelist>
    <varlistentry>
     <term>内部快照</term>
     <listitem>
      <para>
       保存到原始 VM Guest 的 qcow2 文件中的快照。该文件包含保存的快照状态，以及自截取快照以来发生的更改。内部快照的主要优势是它们全都储存在一个文件中，因此方便在多个计算机之间复制或移动。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>外部快照</term>
     <listitem>
      <para>
       创建外部快照时，会保存原始 qcow2 文件并将其设为只读，同时会创建一个新的 qcow2 文件用于存放更改。原始文件有时称为“后备”文件或“基础”文件，包含所有更改的新文件称为“覆盖”文件或“派生”文件。备份 VM Guest 时，外部快照很有用。但外部快照不受虚拟机管理器的支持，且无法直接通过 <command>virsh</command> 删除。有关 QEMU 中外部快照的详细信息，请参见<xref linkend="cha-qemu-guest-inst-qemu-img-effect"/>。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>实时快照</term>
     <listitem>
      <para>
       当原始 VM Guest 正在运行时创建的快照。内部实时快照支持保存设备以及内存和磁盘状态，而使用 <command>virsh</command> 的外部实时快照则支持保存内存状态和/或磁盘状态。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>脱机快照</term>
     <listitem>
      <para>
       基于已关闭的 VM Guest 创建的快照。由于 Guest 的所有进程已停止且未使用任何内存，因此此类快照可确保数据完整性。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec-libvirt-managing-snapshots-vmm">
   <title>使用虚拟机管理器创建和管理快照</title>
   <important>
    <title>仅限内部快照</title>
    <para>
     虚拟机管理器仅支持实时或脱机的内部快照。
    </para>
   </important>
   <para>
    要在虚拟机管理器中打开快照管理视图，请按照<xref linkend="sec-libvirt-managing-console-vnc-vmm"/>中所述打开 VNC 窗口。现在请选择<menuchoice> <guimenu>视图</guimenu>
    <guimenu>快照</guimenu> </menuchoice>，或单击工具栏中的<guimenu>管理 VM 快照</guimenu>。
   </para>
   <informalfigure>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="virt_vmm_snapshots_list.png" width="75%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="virt_vmm_snapshots_list.png" width="75%" format="PNG"/>
     </imageobject>
    </mediaobject>
   </informalfigure>
   <para>
    所选 VM Guest 的现有快照列表显示在窗口的左侧。上次启动的快照带有绿色对勾标记。窗口的右侧显示列表中当前标记的快照的细节。这些细节包括快照的标题和时戳、截取快照时 VM Guest 的状态以及说明。运行中 Guest 的快照还包括一个屏幕截图。可以直接在此视图中更改<guimenu>说明</guimenu>。其他快照数据不可更改。
   </para>
   <sect3 xml:id="sec-libvirt-managing-snapshots-vmm-add">
    <title>创建快照</title>
    <para>
     要截取 VM Guest 的新快照，请执行以下操作：
    </para>
    <procedure>
     <step>
      <para>
       （可选）如果您要创建脱机快照，请关闭 VM Guest。
      </para>
     </step>
     <step>
      <para>
       单击 VNC 窗口左下角的<guimenu>添加</guimenu>。
      </para>
      <para>
       <guimenu>创建快照</guimenu>窗口即会打开。
      </para>
     </step>
     <step>
      <para>
       提供<guimenu>名称</guimenu>和说明（可选）。截取快照后将无法更改该名称。为方便以后识别该快照，请使用<quote>自述性名称</quote>。
      </para>
     </step>
     <step>
      <para>
       单击<guimenu>完成</guimenu>确认。
      </para>
     </step>
    </procedure>
   </sect3>
   <sect3 xml:id="sec-libvirt-managing-snapshots-vmm-delete">
    <title>删除快照</title>
    <para>
     要删除 VM Guest 的快照，请执行以下操作：
    </para>
    <procedure>
     <step>
      <para>
       单击 VNC 窗口左下角的<guimenu>删除</guimenu>。
      </para>
     </step>
     <step>
      <para>
       单击<guimenu>是</guimenu>确认删除。
      </para>
     </step>
    </procedure>
   </sect3>
   <sect3 xml:id="sec-libvirt-managing-snapshots-vmm-start">
    <title>启动快照</title>
    <para>
     要启动快照，请执行以下操作：
    </para>
    <procedure>
     <step>
      <para>
       单击 VNC 窗口左下角的<guimenu>运行</guimenu>。
      </para>
     </step>
     <step>
      <para>
       单击<guimenu>是</guimenu>确认启动。
      </para>
     </step>
    </procedure>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-libvirt-managing-snapshots-virsh">
   <title>使用 <command>virsh</command> 创建和管理快照</title>
   <para>
    要列出某个域（以下示例中为 <replaceable>admin_server</replaceable>）的所有现有快照，请运行 <literal>snapshot-list</literal> 命令：
   </para>
<screen><prompt>&gt; </prompt>virsh snapshot-list --domain sle-ha-node1
 Name                 Creation Time             State
------------------------------------------------------------
 sleha_12_sp2_b2_two_node_cluster 2016-06-06 15:04:31 +0200 shutoff
 sleha_12_sp2_b3_two_node_cluster 2016-07-04 14:01:41 +0200 shutoff
 sleha_12_sp2_b4_two_node_cluster 2016-07-14 10:44:51 +0200 shutoff
 sleha_12_sp2_rc3_two_node_cluster 2016-10-10 09:40:12 +0200 shutoff
 sleha_12_sp2_gmc_two_node_cluster 2016-10-24 17:00:14 +0200 shutoff
 sleha_12_sp3_gm_two_node_cluster 2017-08-02 12:19:37 +0200 shutoff
 sleha_12_sp3_rc1_two_node_cluster 2017-06-13 13:34:19 +0200 shutoff
 sleha_12_sp3_rc2_two_node_cluster 2017-06-30 11:51:24 +0200 shutoff
 sleha_15_b6_two_node_cluster 2018-02-07 15:08:09 +0100 shutoff
 sleha_15_rc1_one-node 2018-03-09 16:32:38 +0100 shutoff</screen>
   <para>
    使用 <literal>snapshot-current</literal> 命令显示上次启动的快照：
   </para>
<screen><prompt>&gt; </prompt>virsh snapshot-current --domain admin_server
Basic installation incl. SMT for CLOUD4
</screen>
   <para>
    运行 <literal>snapshot-info</literal> 命令可以获取有关特定快照的细节：
   </para>
<screen><prompt>&gt; </prompt>virsh snapshot-info --domain admin_server \
   -name  "Basic installation incl. SMT for CLOUD4"
Name:           Basic installation incl. SMT for CLOUD4
Domain:         admin_server
Current:        yes
State:          shutoff
Location:       internal
Parent:         Basic installation incl. SMT for CLOUD3-HA
Children:       0
Descendants:    0
Metadata:       yes
</screen>
   <sect3 xml:id="sec-libvirt-managing-snapshots-virsh-add">
    <title>创建内部快照</title>
    <para>
     要截取 VM Guest 的内部快照（实时或脱机快照），请按如下所示使用 <literal>snapshot-create-as</literal> 命令：
    </para>
<screen><prompt>&gt; </prompt>virsh snapshot-create-as --domain admin_server<co xml:id="virsh-snapshot-add-domain"/> --name "Snapshot 1"<co xml:id="virsh-snapshot-add-name"/> \
--description "First snapshot"<co xml:id="virsh-snapshot-add-description"/></screen>
    <calloutlist>
     <callout arearefs="virsh-snapshot-add-domain">
      <para>
       域名。必需。
      </para>
     </callout>
     <callout arearefs="virsh-snapshot-add-name">
      <para>
       快照的名称。建议使用<quote>自述性名称</quote>，这样可以更轻松地识别该快照。必需。
      </para>
     </callout>
     <callout arearefs="virsh-snapshot-add-description">
      <para>
       快照的说明。可选。
      </para>
     </callout>
    </calloutlist>
   </sect3>
   <sect3 xml:id="sec-libvirt-managing-snapshots-virsh-add-ext">
    <title>创建外部快照</title>
    <para>
     使用 <command>virsh</command> 可以截取 Guest 内存状态和/或磁盘状态的外部快照。
    </para>
    <para>
     要同时截取 Guest 磁盘的实时和脱机外部快照，请指定 <option>--disk-only</option> 选项：
    </para>
<screen><prompt>&gt; </prompt>virsh snapshot-create-as --domain admin_server --name \
 "Offline external snapshot" --disk-only</screen>
    <para>
     可以指定 <option>--diskspec</option> 选项来控制外部文件的创建方式：
    </para>
<screen><prompt>&gt; </prompt>virsh snapshot-create-as --domain admin_server --name \
 "Offline external snapshot" \
 --disk-only --diskspec vda,snapshot=external,file=/path/to/snapshot_file</screen>
    <para>
     要截取 Guest 内存的实时外部快照，请指定 <option>--live</option> 和 <option>--memspec</option> 选项：
    </para>
<screen><prompt>&gt; </prompt>virsh snapshot-create-as --domain admin_server --name \
 "Offline external snapshot" --live \
 --memspec snapshot=external,file=/path/to/snapshot_file</screen>
    <para>
     要截取 Guest 磁盘和内存状态的实时外部快照，请将 <option>--live</option>、<option>--diskspec</option> 和 <option>--memspec</option> 选项结合使用：
    </para>
<screen><prompt>&gt; </prompt>virsh snapshot-create-as --domain admin_server --name \
 "Offline external snapshot" --live \
 --memspec snapshot=external,file=/path/to/snapshot_file
 --diskspec vda,snapshot=external,file=/path/to/snapshot_file</screen>
    <para>
     有关更多细节，请参见 <command>man 1 virsh</command> 中的“<citetitle>快照命令</citetitle>”部分。
    </para>
   </sect3>
   <sect3 xml:id="sec-libvirt-managing-snapshots-virsh-delete">
    <title>删除快照</title>
    <para>
     无法使用 <command>virsh</command> 删除外部快照。要删除 VM Guest 的内部快照并恢复其占用的磁盘空间，请使用 <literal>snapshot-delete</literal> 命令：
    </para>
<screen><prompt>&gt; </prompt>virsh snapshot-delete --domain admin_server --snapshotname "Snapshot 2"</screen>
   </sect3>
   <sect3 xml:id="sec-libvirt-managing-snapshots-virsh-start">
    <title>启动快照</title>
    <para>
     要启动快照，请使用 <literal>snapshot-revert</literal> 命令：
    </para>
<screen><prompt>&gt; </prompt>virsh snapshot-revert --domain admin_server --snapshotname "Snapshot 1"</screen>
    <para>
     要启动当前快照（用于启动 VM Guest 的快照），使用 <option>--current</option> 便已足够，不需要指定快照名称：
    </para>
<screen><prompt>&gt; </prompt>virsh snapshot-revert --domain admin_server --current</screen>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-libvirt-managing-delete">
  <title>删除 VM Guest</title>

  <para>
   默认情况下，使用 <command>virsh</command> 删除 VM Guest 只会去除其 XML 配置。由于默认不会删除挂接的储存设备，因此您可以在另一个 VM Guest 上重复使用该储存设备。使用虚拟机管理器还可以删除 Guest 的储存文件 — 这会彻底擦除该 Guest。
  </para>

  <sect2 xml:id="sec-libvirt-managing-delete-vmm">
   <title>使用虚拟机管理器删除 VM Guest</title>
   <procedure>
    <step>
     <para>
      在虚拟机管理器中，右键单击某个 VM Guest 项。
     </para>
    </step>
    <step>
     <para>
      从上下文菜单中选择<guimenu>删除</guimenu>。
     </para>
    </step>
    <step>
     <para>
      一个确认窗口即会打开。单击<guimenu>删除</guimenu>会永久擦除该 VM Guest。该删除操作不可恢复。
     </para>
     <para>
      您还可以通过激活<guimenu>删除关联的储存文件</guimenu>来永久删除 Guest 的虚拟磁盘。该删除操作也不可恢复。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec-libvirt-managing-delete-virsh">
   <title>使用 <command>virsh</command> 删除 VM Guest</title>
   <para>
    要删除 VM Guest，需先将其关闭。无法删除运行中的 Guest。有关关机的信息，请参见<xref linkend="sec-libvirt-managing-status"/>。
   </para>
   <para>
    要使用 <command>virsh</command> 删除 VM Guest，请运行 <command>virsh</command> <option>undefine</option>
    <replaceable>VM_NAME</replaceable>。
   </para>
<screen><prompt>&gt; </prompt>virsh undefine sles12</screen>
   <para>
    没有可自动删除挂接的储存文件的选项。如果这些文件由 libvirt 管理，请按照<xref linkend="sec-libvirt-storage-virsh-del-volumes"/>中所述将其删除。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-libvirt-admin-migrate">
  <title>迁移 VM Guest</title>

  <para>
   虚拟化的主要优势之一是 VM Guest 可移植。当某台 VM 主机服务器出于维护目的而需要关闭时，或者当该主机过载时，可以轻松将 Guest 迁移到另一台 VM 主机服务器。KVM 和 Xen 甚至支持<quote>实时</quote>迁移，在此期间，VM Guest 仍然可用。
  </para>

  <sect2 xml:id="libvirt-admin-live-migration-requirements">
   <title>迁移要求</title>
   <para>
    要成功将 VM Guest 迁移到另一台 VM 主机服务器，需符合以下要求：
   </para>
   <important>
    <para>
     要使用复制后实时迁移选项，采用内核版本 5.11 或更高版本的 KVM 主机需要将 <varname>unprivileged_userfaultfd</varname> 系统值设置为 <literal>1</literal>：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> sysctl -w vm.unprivileged_userfaultfd=1</screen>
    <para>
     由于 5.11 之前的内核版本无需设置 unprivileged_userfaultfd 即可使用复制后实时迁移选项，因此 <systemitem class="library">libvirt</systemitem> 在 <filename>/usr/lib/sysctl.d/60-qemu-postcopy-migration.conf</filename> 文件中提供了用于保留旧行为的设置。
    </para>
   </important>
   <itemizedlist>
    <listitem>
     <para>
      源和目标系统必须采用相同的体系结构。
     </para>
    </listitem>
    <listitem>
     <para>
      这两台计算机必须均可访问储存设备（例如，通过 NFS 或 iSCSI），并且必须将储存设备配置为这两台计算机上的储存池。有关更多信息，请参见<xref linkend="cha-libvirt-storage"/>。
     </para>
     <para>
      在迁移期间连接的 CD-ROM 或软盘映像也需要符合此要求。不过，您可以按照<xref linkend="sec-libvirt-config-cdrom-media-change"/>中所述在迁移之前断开其连接。
     </para>
    </listitem>
    <listitem>
     <para>
      这两台 VM 主机服务器上都需要运行 <systemitem class="daemon">libvirtd</systemitem>，并且您必须能够打开从目标主机到源主机（或反向）的远程 <systemitem class="library">libvirt</systemitem> 连接。有关详细信息，请参考 <xref linkend="sec-libvirt-connect-remote"/>。
     </para>
    </listitem>
    <listitem>
     <para>
      如果目标主机上在运行防火墙，则需要打开端口以允许迁移。如果您在迁移期间不指定端口，<systemitem class="library">libvirt</systemitem> 将从 49152:49215 范围内选择一个端口。确保在<emphasis>目标主机</emphasis>上的防火墙中打开此端口范围（建议）或所选的专用端口。
     </para>
    </listitem>
    <listitem>
     <para>
      主机和目标计算机应位于网络上的同一子网中，否则迁移后网络功能无法正常工作。
     </para>
    </listitem>
    <listitem>
     <para>
      参与迁移的所有 VM 主机服务器必须具有 qemu 用户的相同 UID，并具有 kvm、qemu 和 libvirt 组的相同 GID。
     </para>
    </listitem>
    <listitem>
     <para>
      目标主机上不能存在正在运行或已暂停的同名 VM Guest。如果存在已关闭的同名计算机，其配置将被重写。
     </para>
    </listitem>
    <listitem>
     <para>
      迁移 VM Guest 时支持除<emphasis>主机 CPU</emphasis> 型号以外的所有 CPU 型号。
     </para>
    </listitem>
    <listitem>
     <para>
      <xref linkend="gloss-vt-acronym-sata"/> 磁盘设备类型不可迁移。
     </para>
    </listitem>
    <listitem>
     <para>
      文件系统直通功能不可迁移。
     </para>
    </listitem>
    <listitem>
     <para>
      需在 VM 主机服务器和 VM Guest 上安装适当的计时功能。请参见<xref linkend="sec-kvm-managing-clock"/>。
     </para>
    </listitem>
    <listitem>
     <para>
      无法将物理设备从主机迁移到 Guest。目前，在使用具有 PCI 直通或 <xref linkend="vt-io-sriov"/> 功能的设备时，不支持实时迁移。如果需要支持实时迁移，则需使用软件虚拟化（半虚拟化或全虚拟化）。
     </para>
    </listitem>
    <listitem>
     <para>
      缓存模式设置是重要的迁移设置。请参见 <xref linkend="sec-cache-mode-live-migration"/>。
     </para>
    </listitem>
    <listitem os="sles;sled">
     <para os="sles;sled">
      不支持向后迁移（例如，从 SLES 15 SP2 迁移到 15 SP1）。
     </para>
    </listitem>
    <listitem os="sles;sled">
     <para>
      SUSE 正致力于支持将 VM Guest 从运行 LTSS 所涵盖的服务包的 VM 主机服务器，迁移到运行同一 SLES 主要版本中更新的服务包的 VM 主机服务器。例如，将 VM Guest 从 SLES 12 SP2 主机迁移到 SLES 12 SP5 主机。对于从 LTSS 迁移到更新的服务包的方案，SUSE 只会执行极简单的测试，建议在尝试迁移关键的 VM Guest 之前执行全面的现场测试。
     </para>
    </listitem>
    <listitem>
     <para>
      在两台主机上，映像目录应位于同一路径中。
     </para>
    </listitem>
    <listitem>
     <para>
      所有主机的微代码级别（尤其是 spectre 微代码更新）应该相同。在所有主机上安装 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 的最新更新即可实现此目的。
     </para>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="sec-libvirt-admin-migrate-virtmanager">
   <title>使用虚拟机管理器进行迁移</title>
   <para>
    使用虚拟机管理器迁移 VM Guest 时，在哪台计算机上启动虚拟机管理器并不重要。您可以在源主机或目标主机上启动虚拟机管理器，甚至可以在这两台之外的主机上启动。对于后一种情况，您需要能够同时与目标主机和源主机建立远程连接。
   </para>
   <procedure>
    <step>
     <para>
      启动虚拟机管理器，并与目标主机或源主机建立连接。如果虚拟机管理器不是在目标主机或源主机上启动的，则需要与这两台主机都建立连接。
     </para>
    </step>
    <step>
     <para>
      右键单击要迁移的 VM Guest，然后选择<guimenu>迁移</guimenu>。确保该 Guest 正在运行或已暂停 — 关闭的 Guest 无法迁移。
     </para>
     <tip>
      <title>提高迁移速度</title>
      <para>
       要将迁移速度提高到一定程度，请暂停 VM Guest。这相当于使用前面所述的虚拟机管理器中的<quote>脱机迁移</quote>选项。
      </para>
     </tip>
    </step>
    <step>
     <para>
      为 VM Guest 选择一个<guimenu>新主机</guimenu>。如果所需的目标主机未显示，请确保您已连接到该主机。
     </para>
     <para>
      要更改用于连接到远程主机的默认选项，请在<guimenu>连接</guimenu>下设置<guimenu>模式</guimenu>，以及目标主机的<guimenu>地址</guimenu>（IP 地址或主机名）和<guimenu>端口</guimenu>。如果指定了<guimenu>端口</guimenu>，还必须指定<guimenu>地址</guimenu>。
     </para>
     <para>
      在<guimenu>高级选项</guimenu>下，选择迁移是永久性的（默认设置）还是暂时性的（使用<guimenu>暂时移动</guimenu>）。
     </para>
     <para>
      此外我们还提供了一个选项<guimenu>允许不安全的迁移</guimenu>，它允许在不禁用 VM 主机服务器缓存的情况下进行迁移。这样可以加速迁移，但仅当当前配置能够在不使用 <literal>cache=&quot;none&quot;</literal>/<literal>0_DIRECT</literal> 的情况下提供一致的 VM Guest 储存信息时，此选项才起作用。
     </para>
     <note>
      <title>带宽选项</title>
      <para>
       在最近的虚拟机管理器版本中，去除了用于设置迁移带宽的选项。要设置特定的带宽，请改用 <command>virsh</command>。
      </para>
     </note>
    </step>
    <step>
     <para>
      要执行迁移，请单击<guimenu>迁移</guimenu>。
     </para>
     <para>
      迁移完成后，<guimenu>迁移</guimenu>窗口将会关闭，该 VM Guest 随即列在虚拟机管理器窗口中的新主机上。原始 VM Guest 仍可在目标主机上使用（处于关机状态）。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec-libvirt-admin-migrate-virsh">
   <title>使用 <command>virsh</command> 进行迁移</title>
   <para>
    要使用 <command>virsh</command>
    <option>migrate</option> 迁移 VM Guest，您需要能够直接访问或者通过外壳远程访问 VM 主机服务器，因为命令需在主机上运行。迁移命令如下所示：
   </para>
<screen><prompt>&gt; </prompt>virsh migrate [OPTIONS] <replaceable>VM_ID_or_NAME</replaceable> <replaceable>CONNECTION_URI</replaceable> [--migrateuri tcp://<replaceable>REMOTE_HOST:PORT</replaceable>]</screen>
   <para>
    下面列出了最重要的选项。有关完整列表，请参见 <command>virsh help migrate</command>。
   </para>
   <variablelist>
    <varlistentry>
     <term><option>--live</option></term>
     <listitem>
      <para>
       执行实时迁移。如果未指定此选项，Guest 将会在迁移期间暂停（<quote>脱机迁移</quote>）。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>--suspend</option></term>
     <listitem>
      <para>
       执行脱机迁移，且不重启动目标主机上的 VM Guest。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>--persistent</option></term>
     <listitem>
      <para>
       默认情况下，迁移的 VM Guest 只是暂时性迁移，因此 Guest 关闭后，系统会自动在目标主机上删除其配置。使用此开关可使迁移变为永久性迁移。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>--undefinesource</option></term>
     <listitem>
      <para>
       如果指定此选项，成功迁移后，将删除源主机上的 VM Guest 定义（但<emphasis>不会</emphasis>删除挂接到此 Guest 的虚拟磁盘）。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>--parallel --parallel-connections <replaceable>NUM_OF_CONNECTIONS</replaceable></option></term>
     <listitem>
      <para>
       当单个迁移线程无法使源主机与目标主机之间的网络链接饱和时，可以使用并行迁移来提高迁移数据吞吐量。在具备 40 GB 网络接口的主机上，可能需要四个迁移线程才能使链接饱和。使用并行迁移可以大幅缩短迁移大内存 VM 所需的时间。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <para>
    以下示例使用 mercury.example.com 作为源系统，使用 jupiter.example.com 作为目标系统；VM Guest 的名称为 <literal>opensuse131</literal>，ID 为 <literal>37</literal>。
   </para>
   <variablelist>
    <varlistentry>
     <term>使用默认参数进行脱机迁移</term>
     <listitem>
<screen><prompt>&gt; </prompt>virsh migrate 37 qemu+ssh://tux@jupiter.example.com/system</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>使用默认参数进行瞬态实时迁移</term>
     <listitem>
<screen><prompt>&gt; </prompt>virsh migrate --live opensuse131 qemu+ssh://tux@jupiter.example.com/system</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>永久性实时迁移；删除源上的 VM 定义</term>
     <listitem>
<screen><prompt>&gt; </prompt>virsh migrate --live --persistent --undefinesource 37 \
qemu+tls://tux@jupiter.example.com/system</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>使用端口 49152 进行脱机迁移</term>
     <listitem>
<screen><prompt>&gt; </prompt>virsh migrate opensuse131 qemu+ssh://tux@jupiter.example.com/system \
--migrateuri tcp://@jupiter.example.com:49152</screen>
     </listitem>
    </varlistentry>
   </variablelist>
   <note>
    <title>瞬态迁移与永久性迁移的比较</title>
    <para>
     默认情况下，<command>virsh migrate</command> 为目标主机上的 VM Guest 创建暂时性（瞬态）副本。已关机版本的原始 Guest 说明将保留在源主机上。瞬态副本将会在 Guest 关机后从服务器中删除。
    </para>
    <para>
     要为目标主机上的 Guest 创建永久副本，请使用开关 <option>--persistent</option>。已关机版本的原始 Guest 说明也会保留在源主机上。将选项 <option>--undefinesource</option> 与 <option>--persistent</option> 搭配使用可以实现<quote>真正的</quote>迁移，在此情况下，将在目标主机上创建永久副本，并删除源主机上的版本。
    </para>
    <para>
     不建议只使用 <option>--undefinesource</option> 而不使用 <option>--persistent</option> 选项，因为这会导致两个 VM Guest 定义均会在目标主机上的 Guest 关闭后丢失。
    </para>
   </note>
  </sect2>



  <sect2 xml:id="sec-libvirt-migrate-stepbstep">
   <title>分步操作示例</title>
   <para/>
   <sect3 xml:id="sec-migrate-stepbstep-export">
    <title>导出储存设备</title>
    <para>
     首先需要导出储存区，以便在主机之间共享 Guest 映像。可以通过一台 NFS 服务器完成此操作。在下面的示例中，我们想要共享网络 10.0.1.0/24 中所有计算机的 <filename>/volume1/VM</filename> 目录。我们将使用一台 SUSE Linux Enterprise NFS 服务器。以 root 用户身份编辑 <filename>/etc/exports</filename> 文件并添加以下内容：
    </para>
<screen>/volume1/VM 10.0.1.0/24  (rw,sync,no_root_squash)</screen>
    <para>
     您需要重启动该 NFS 服务器：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl restart nfsserver
<prompt>&gt; </prompt><command>sudo</command> exportfs
/volume1/VM      10.0.1.0/24</screen>
   </sect3>
   <sect3 xml:id="sec-migrate-stepbstep-pool">
    <title>在目标主机上定义池</title>
    <para>
     在您要迁移 VM Guest 的每台主机上，必须定义池才能访问卷（其中包含 Guest 映像）。我们的 NFS 服务器 IP 地址为 10.0.1.99，它的共享是 <filename>/volume1/VM</filename> 目录，而我们想要将此共享挂载 <filename>/var/lib/libvirt/images/VM</filename> 目录中。池名称为 <emphasis>VM</emphasis>。要定义此池，请创建包含以下内容的 <filename>VM.xml</filename> 文件：
    </para>
<screen>&lt;pool type='netfs'&gt;
  &lt;name&gt;VM&lt;/name&gt;
  &lt;source&gt;
    &lt;host name='10.0.1.99'/&gt;
    &lt;dir path='/volume1/VM'/&gt;
    &lt;format type='auto'/&gt;
  &lt;/source&gt;
  &lt;target&gt;
    &lt;path&gt;/var/lib/libvirt/images/VM&lt;/path&gt;
    &lt;permissions&gt;
      &lt;mode&gt;0755&lt;/mode&gt;
      &lt;owner&gt;-1&lt;/owner&gt;
      &lt;group&gt;-1&lt;/group&gt;
    &lt;/permissions&gt;
  &lt;/target&gt;
  &lt;/pool&gt;</screen>
    <para>
     然后使用 <command>pool-define</command> 命令将其装载到 <systemitem class="library">libvirt</systemitem>：
    </para>
<screen><prompt role="root"># </prompt>virsh pool-define VM.xml</screen>
    <para>
     另一种定义此池的方法是使用 <command>virsh</command> 命令：
    </para>
<screen><prompt role="root"># </prompt>virsh pool-define-as VM --type netfs --source-host 10.0.1.99 \
     --source-path /volume1/VM --target /var/lib/libvirt/images/VM
Pool VM created</screen>
    <para>
     以下命令假设您在 <command>virsh</command> 的交互式外壳中操作，使用不带任何参数的 <command>virsh</command> 命令也可以访问该外壳。然后，可将池设置为在主机引导时自动启动（autostart 选项）：
    </para>
<screen><prompt>virsh # </prompt>pool-autostart VM
Pool VM marked as autostarted</screen>
    <para>
     如果您要禁用自动启动，请执行以下命令：
    </para>
<screen><prompt>virsh # </prompt>pool-autostart VM --disable
Pool VM unmarked as autostarted</screen>
    <para>
     检查该池是否存在：
    </para>
<screen><prompt>virsh # </prompt>pool-list --all
 Name                 State      Autostart
-------------------------------------------
 default              active     yes
 VM                   active     yes

<prompt>virsh # </prompt>pool-info VM
Name:           VM
UUID:           42efe1b3-7eaa-4e24-a06a-ba7c9ee29741
State:          running
Persistent:     yes
Autostart:      yes
Capacity:       2,68 TiB
Allocation:     2,38 TiB
Available:      306,05 GiB</screen>
    <warning>
     <title>池需要在所有目标主机上存在</title>
     <para>
      请记住：必须在您要迁移其中的 VM Guest 的每台主机上定义此池。
     </para>
    </warning>
   </sect3>
   <sect3 xml:id="sec-migrate-stepbstep-volume">
    <title>创建卷</title>
    <para>
     池已定义好，现在我们需要一个包含磁盘映像的卷。
    </para>
<screen><prompt>virsh # </prompt>vol-create-as VM sled12.qcow2 8G --format qcow2
Vol sled12.qcow2 created</screen>
    <para>
     稍后将会通过 virt-install 使用所示的卷名称安装 Guest。
    </para>
   </sect3>
   <sect3 xml:id="sec-migrate-stepbstep-guest">
    <title>创建 VM Guest</title>
    <para>
     我们来使用 <command>virt-install</command> 命令创建一个 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> VM Guest。将使用 <command>--disk</command> 选项指定 <emphasis>VM</emphasis> 池；如果您不希望在执行迁移时使用 <command>--unsafe</command> 选项，建议您设置 <emphasis>cache=none</emphasis>。
    </para>
<screen><prompt role="root"># </prompt>virt-install --connect qemu:///system --virt-type kvm --name \
   sled12 --memory 1024 --disk vol=VM/sled12.qcow2,cache=none --cdrom \
   /mnt/install/ISO/SLE-12-Desktop-DVD-x86_64-Build0327-Media1.iso --graphics \
   vnc --os-variant sled12
Starting install...
Creating domain...</screen>
   </sect3>
   <sect3 xml:id="sec-migrate-stepbstep-migrate">
    <title>迁移 VM Guest</title>
    <para>
     一切准备就绪，现在可以执行迁移。在当前托管 VM Guest 的 VM 主机服务器上运行 <command>migrate</command> 命令，并选择目标。
    </para>
<screen>virsh # migrate --live sled12 --verbose qemu+ssh://<replaceable>IP/Hostname</replaceable>/system
Password:
Migration: [ 12 %]</screen>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="cha-libvirt-admin-monitor">
  <title>监视</title>

  <para/>

  <sect2 xml:id="cha-libvirt-admin-monitor-virt-manager">
   <title>使用虚拟机管理器进行监视</title>
   <para>
    启动虚拟机管理器并连接到 VM 主机服务器后，所有运行中 Guest 的 CPU 使用率图表将会显示。
   </para>
   <para>
    您也可以通过此工具获取有关磁盘和网络使用情况的信息，不过必须先在<guimenu>首选项</guimenu>中激活此功能：
   </para>
   <procedure>
    <step>
     <para>
      运行 <command>virt-manager</command>。
     </para>
    </step>
    <step>
     <para>
      选择<menuchoice><guimenu>编辑</guimenu>
      <guimenu>首选项</guimenu></menuchoice>。
     </para>
    </step>
    <step>
     <para>
      从<guimenu>常规</guimenu>选项卡切换到<guimenu>轮询</guimenu>。
     </para>
    </step>
    <step>
     <para>
      激活您要查看的活动类型对应的复选框：<guimenu>轮询磁盘 I/O</guimenu>、<guimenu>轮询网络 I/O</guimenu> 和<guimenu>轮询内存统计信息</guimenu>。
     </para>
    </step>
    <step>
     <para>
      如果需要，还可以使用<guimenu>每隔 n 秒更新状态</guimenu>来更改更新间隔。
     </para>
    </step>
    <step>
     <para>
      关闭<guimenu>首选项</guimenu>对话框。
     </para>
    </step>
    <step>
     <para>
      在<menuchoice>
      <guimenu>视图</guimenu> <guimenu>图表</guimenu> </menuchoice>下激活应显示的图表。
     </para>
    </step>
   </procedure>
   <para>
    此后，磁盘和网络统计信息也会显示在虚拟机管理器的主窗口中。
   </para>
   <para>
    可以从 VNC 窗口获取更精确的数据。按照<xref linkend="sec-libvirt-managing-console-vnc"/>中所述打开 VNC 窗口。在工具栏或<guimenu>视图</guimenu>菜单中选择<guimenu>细节</guimenu>。可以通过左侧树菜单中的<guimenu>性能</guimenu>项显示统计信息。
   </para>
  </sect2>

  <sect2 xml:id="cha-libvirt-admin-monitor-virt-top">
   <title>使用 <command>virt-top</command> 进行监视</title>
   <para>
    <command>virt-top</command> 是一个命令行工具，与众所周知的进程监视工具 <command>top</command> 类似。<command>virt-top</command> 使用 libvirt，因此能够显示不同超级管理程序上运行的 VM Guest 的统计信息。建议使用 <command>virt-top</command>，而不要使用 <command>xentop</command> 等特定于超级管理程序的工具。
   </para>
   <para>
    <command>virt-top</command> 默认会显示所有运行中 VM Guest 的统计信息。显示的数据包括已用内存百分比 (<literal>%MEM</literal>)、已用 CPU 百分比 (<literal>%CPU</literal>)，以及 Guest 的运行时长 (<literal>TIME</literal>)。数据会定期更新（默认为每三秒更新一次）。下面显示了某台 VM 主机服务器上的输出，该服务器包含七个 VM Guest，其中有四个处于非活动状态：
   </para>
<screen>virt-top 13:40:19 - x86_64 8/8CPU 1283MHz 16067MB 7.6% 0.5%
7 domains, 3 active, 3 running, 0 sleeping, 0 paused, 4 inactive D:0 O:0 X:0
CPU: 6.1%  Mem: 3072 MB (3072 MB by guests)

   ID S RDRQ WRRQ RXBY TXBY %CPU %MEM    TIME   NAME
    7 R  123    1  18K  196  5.8  6.0   0:24.35 sled12_sp1
    6 R    1    0  18K    0  0.2  6.0   0:42.51 sles12_sp1
    5 R    0    0  18K    0  0.1  6.0  85:45.67 opensuse_leap
    -                                           (Ubuntu_1410)
    -                                           (debian_780)
    -                                           (fedora_21)
    -                                           (sles11sp3)</screen>
   <para>
    输出默认按 ID 排序。使用以下组合键可以更改排序字段：
   </para>
   <simplelist><member><keycombo><keycap function="shift"/><keycap>P</keycap></keycombo>：CPU 使用率
    </member><member><keycombo><keycap function="shift"/><keycap>M</keycap></keycombo>：Guest 分配的内存总量
    </member><member><keycombo><keycap function="shift"/><keycap>T</keycap></keycombo>: 时间
    </member><member><keycombo><keycap function="shift"/><keycap>I</keycap></keycombo>: ID
    </member>
   </simplelist>
   <para>
    要使用任何其他字段进行排序，请按 <keycombo>
    <keycap function="shift"/> <keycap>F</keycap> </keycombo> 并从列表中选择一个字段。要切换排序顺序，请使用 <keycombo>
    <keycap function="shift"/> <keycap>R</keycap> </keycombo>。
   </para>
   <para>
    <command>virt-top</command> 还支持基于 VM Guest 数据生成不同的视图，按以下键可以即时更改视图：
   </para>
   <simplelist><member><keycap>0</keycap>：默认视图</member><member><keycap>1</keycap>：显示物理 CPU</member><member><keycap>2</keycap>：显示网络接口</member><member><keycap>3</keycap>：显示虚拟磁盘</member>
   </simplelist>
   <para>
    <command>virt-top</command> 支持使用更多热键来更改数据视图，并支持许多可以影响程序行为的命令行开关。有关详细信息，请参见 <command>man 1 virt-top</command>。
   </para>
  </sect2>

  <sect2 xml:id="cha-libvirt-admin-monitor-kvm-stat">
   <title>使用 <command>kvm_stat</command> 进行监视</title>
   <para>
    <command>kvm_stat</command> 可用于跟踪 KVM 性能事件。它会监视 <filename>/sys/kernel/debug/kvm</filename>，因此需要挂载 debugfs。<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 上默认应该已挂载 debugfs。如果未挂载，请使用以下命令：
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> mount -t debugfs none /sys/kernel/debug</screen>
   <para>
    可采用三种不同的模式使用 <command>kvm_stat</command>：
   </para>
<screen>kvm_stat                    # update in 1 second intervals
kvm_stat -1                 # 1 second snapshot
kvm_stat -l &gt; kvmstats.log  # update in 1 second intervals in log format
                            # can be imported to a spreadsheet</screen>
   <example>
    <title><command>kvm_stat</command> 的典型输出</title>
<screen>kvm statistics

 efer_reload                  0       0
 exits                 11378946  218130
 fpu_reload               62144     152
 halt_exits              414866     100
 halt_wakeup             260358      50
 host_state_reload       539650     249
 hypercalls                   0       0
 insn_emulation         6227331  173067
 insn_emulation_fail          0       0
 invlpg                  227281      47
 io_exits                113148      18
 irq_exits               168474     127
 irq_injections          482804     123
 irq_window               51270      18
 largepages                   0       0
 mmio_exits                6925       0
 mmu_cache_miss           71820      19
 mmu_flooded              35420       9
 mmu_pde_zapped           64763      20
 mmu_pte_updated              0       0
 mmu_pte_write           213782      29
 mmu_recycled                 0       0
 mmu_shadow_zapped       128690      17
 mmu_unsync                  46      -1
 nmi_injections               0       0
 nmi_window                   0       0
 pf_fixed               1553821     857
 pf_guest               1018832     562
 remote_tlb_flush        174007      37
 request_irq                  0       0
 signal_exits                 0       0
 tlb_flush               394182     148</screen>
   </example>
   <para>
    有关如何解释这些值的更多信息，请参见 <link xlink:href="http://clalance.blogspot.com/2009/01/kvm-performance-tools.html"/>。
   </para>
  </sect2>
 </sect1>
</chapter>
