<?xml version="1.0" encoding="UTF-8"?>
<sect2 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="system_repair.xml" version="5.0" xml:id="sec.trouble.data.recover.rescue">
 <title>Usando o sistema de recuperação</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes (sim)</dm:translation>
  </dm:docmanager>
 </info><indexterm> <primary>sistema de recuperação</primary></indexterm><indexterm> <primary>sistema</primary> <secondary>recuperando</secondary></indexterm>
 <para>
  Há vários motivos para um sistema não ser inicializado ou executado apropriadamente. Um sistema de arquivos corrompido após uma falha do sistema, arquivos de configuração corrompidos ou uma configuração de carregador de boot corrompida são os mais comuns.
 </para>
 <para>
  Para ajudá-lo a resolver esse tipo de situação, o <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> oferece um sistema de recuperação que você pode inicializar. que consiste em um pequeno sistema Linux que pode ser carregado em um disco de RAM e montado como um sistema de arquivos raiz, permitindo acesso externo às partições Linux. Com o sistema de recuperação, você pode recuperar ou modificar qualquer aspecto importante do sistema.
 </para>
 <itemizedlist mark="bullet" spacing="normal">
  <listitem>
   <para>
    Manipule qualquer tipo de arquivo de configuração.
   </para>
  </listitem>
  <listitem>
   <para>
    Verifique se há defeitos no sistema de arquivos e inicie processos de reparo automáticos.
   </para>
  </listitem>
  <listitem>
   <para>
    Acesse o sistema instalado em um ambiente de <quote>mudança de raiz</quote>.
   </para>
  </listitem>
  <listitem>
   <para>
    Verifique, modifique e reinstale a configuração do carregador de boot.
   </para>
  </listitem>
  <listitem>
   <para>
    Recuperar-se de um driver de dispositivo instalado incorretamente ou um kernel inutilizável.
   </para>
  </listitem>
  <listitem>
   <para>
    Redimensione as partições usando o comando parted. Encontre mais informações sobre esta ferramenta no site GNU Parted na Web <link xlink:href="http://www.gnu.org/software/parted/parted.html"/>.
   </para>
  </listitem>
 </itemizedlist>
 <para>
  É possível carregar o sistema de recuperação a partir de várias origens e locais. A opção mais simples é inicializar o sistema de recuperação a partir do meio original de instalação.
 </para>
 
 <procedure><indexterm> <primary>sistema de recuperação</primary> <secondary>iniciando pelo meio</secondary></indexterm>
  <step>
   <para>
    Insira o meio de instalação na unidade de DVD.
   </para>
  </step>
  <step>
   <para>
    Reinicialize o sistema.
   </para>
  </step>
  <step>
   <para>
    Na tela de boot, pressione <keycap>F4</keycap> e escolha <guimenu>DVD-ROM</guimenu>. Em seguida, escolha <guimenu>Sistema de Recuperação</guimenu> no menu principal.
   </para>
  </step>
  <step>
   <para>
    Digite <literal>root</literal> no prompt <literal>Rescue:</literal>. Não é necessário inserir uma senha.
   </para>
  </step>
 </procedure>
 <procedure xml:id="proc.trouble.data.recover.rescue.network"><indexterm> <primary>sistema de recuperação</primary> <secondary>iniciando pela fonte na rede</secondary></indexterm>
  <para>
   Se a sua configuração de hardware não inclui uma unidade de DVD, você poderá inicializar o sistema de recuperação a partir de uma fonte na rede. O seguinte exemplo aplica-se a um cenário de boot remoto. Se você estiver usando outro meio de boot, como um DVD, modifique o arquivo <filename>info</filename> adequadamente e inicialize como em uma instalação normal.
  </para>
  <step>
   <para>
    Digite a configuração do seu boot PXE e adicione as linhas <literal>install=<replaceable>protocolo</replaceable>://<replaceable>fonte_de_instalação</replaceable></literal> e <literal>rescue=1</literal>. Se precisar iniciar o sistema de recuperação, prefira <literal>repair=1</literal>. Como em uma instalação normal, <replaceable>protocolo</replaceable> significa qualquer um dos protocolos de rede suportados (NFS, HTTP, FTP, etc.) e <replaceable>origem_inst</replaceable> é o caminho da origem de instalação da rede.
   </para>
  </step>
  <step>
   <para>
    Inicialize o sistema usando <quote>Wake on LAN</quote><phrase os="sles;sled">, conforme descrito na <xref linkend="sec.deployment.prep_boot.wol"/></phrase>.
   </para>
  </step>
  <step>
   <para>
    Digite <literal>root</literal> no prompt <literal>Rescue:</literal>. Não é necessário inserir uma senha.
   </para>
  </step>
 </procedure>
 <para>
  Depois de acessar o sistema de recuperação, você poderá utilizar os consoles virtuais por meio das teclas <keycombo><keycap function="alt"/><keycap>F1</keycap></keycombo> a <keycombo><keycap function="alt"/><keycap>F6</keycap></keycombo>.
 </para>
 <para>
  Um shell e muitos outros eficientes utilitários, como o programa de montagem, estão disponíveis no diretório <filename>/bin</filename>. O diretório <filename>/sbin</filename> contém utilitários de arquivo e rede importantes para análise e conserto do sistema de arquivos. Esse diretório também inclui os binários mais importantes para a manutenção do sistema, por exemplo, <command>fdisk</command>, <command>mkfs</command>, <command>mkswap</command>, <command>mount</command>, <command>shutdown</command>; e <command>ip</command> e <command>ss</command> para a manutenção da rede. O diretório <filename>/usr/bin</filename> contém o vi editor, find, less e SSH.
 </para>
 <para>
  Para ver as mensagens do sistema, use o comando <command>dmesg</command> ou exiba o registro do sistema com <command>journalctl</command>.
 </para>
 <sect3 xml:id="sec.trouble.data.recover.rescue.file">
  <title>Verificando e manipulando arquivos de configuração</title>
  <para>
   Como exemplo de uma configuração que possa ser corrigida por meio do sistema de recuperação, suponha que você tenha um arquivo de configuração defeituoso que impeça a inicialização adequada do sistema. Você pode corrigir isso usando o sistema de recuperação.
  </para>
  <procedure>
   <para>
    Para manipular um arquivo de configuração, faça o seguinte:
   </para>
   <step>
    <para>
     Inicie o sistema de recuperação usando um dos métodos descritos acima.
    </para>
   </step>
   <step>
    <para>
     Para montar uma sistema de arquivos raiz localizado em <filename>/dev/sda6</filename> para o sistema de recuperação, use o seguinte comando:
    </para>
<screen>mount /dev/sda6 /mnt</screen>
    <para>
     Agora, todos os diretórios do sistema estão localizados em <filename>/mnt</filename>
    </para>
   </step>
   <step>
    <para>
     Mude o diretório para o sistema de arquivos raiz montado:
    </para>
<screen>cd /mnt</screen>
   </step>
   <step>
    <para>
     Abra o arquivo de configuração problemático no editor vi. Ajuste e grave a configuração.
    </para>
   </step>
   <step>
    <para>
     Desmonte o sistema de arquivos raiz no sistema de recuperação:
    </para>
<screen>umount /mnt</screen>
   </step>
   <step>
    <para>
     Reinicialize a máquina.
    </para>
   </step>
  </procedure>
 </sect3>
 <sect3 xml:id="sec.trouble.data.recover.rescue.filesystem">
  <title>Reparando e verificando os sistemas de arquivos</title><indexterm> <primary>sistemas de arquivos</primary><secondary>reparando</secondary></indexterm>
  <para>
   Geralmente, não é possível reparar sistemas de arquivos em um sistema em execução. Se você tiver sérios problemas, talvez não consiga montar seu sistema de arquivos raiz e a inicialização do sistema poderá ser encerrada com <quote>kernel panic</quote>. Nesse caso, a única maneira será reparar o sistema externamente. O sistema inclui os utilitários de verificação e conserto dos sistemas de arquivos <literal>btrfs</literal>, <literal>ext2</literal>, <literal>ext3</literal>, <literal>ext4</literal>, <literal>reiserfs</literal>, <literal>xfs</literal>, <literal>dosfs</literal> e <literal>vfat</literal>. Procure pelo comando <command>fsck.</command> <replaceable>SISTEMADEARQUIVOS</replaceable>. Por exemplo, se você precisar verificar o sistema de arquivos <literal>btrfs</literal>, use <command>fsck.btrfs</command>.
  </para>

 </sect3>
 <sect3 xml:id="sec.trouble.data.recover.rescue.access">
  <title>Acessando o sistema instalado</title>
  <para>
   Se você precisa acessar o sistema instalado do sistema de recuperação, faça isso em um ambiente <emphasis>raiz de mudança</emphasis>. Por exemplo, para modificar a configuração do carregador de boot ou executar um utilitário de configuração de hardware.
  </para>
  <para>
   Para configurar um ambiente de mudança de raiz com base no sistema instalado, faça o seguinte:
  </para>
  <procedure>
   <step>
    <para>
     Execute <command>lsblk</command> para verificar qual nó corresponde à partição raiz. No exemplo, o nó é <filename>/dev/sda2</filename>:
    </para>
<screen>lsblk
NAME        MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT
sda           8:0    0 149,1G  0 disk
├─sda1        8:1    0     2G  0 part  [SWAP]
├─sda2        8:2    0    20G  0 part  /
└─sda3        8:3    0   127G  0 part
  └─cr_home 254:0    0   127G  0 crypt /home</screen>
   </step>
   <step>
    <para>
     Monte a partição raiz pelo sistema instalado:
    </para>
<screen>mount /dev/sda2 /mnt</screen>
   </step>
   <step>
    <para>
     Monte as partições <filename>/proc</filename>, <filename>/dev</filename> e <filename>/sys</filename>:
    </para>
<screen>mount -t proc none /mnt/proc
mount --rbind /dev /mnt/dev
mount --rbind /sys /mnt/sys</screen>
   </step>
   <step>
    <para>
     Agora, você pode <quote>mudar a raiz</quote> para o novo ambiente, mantendo o shell <systemitem>bash</systemitem>:
    </para>
<screen>chroot /mnt /bin/bash</screen>
   </step>
   <step>
    <para>
     Por fim, monte as partições restantes no sistema instalado:
    </para>
<screen>mount -a</screen>
   </step>
   <step>
    <para>
     Agora, você tem acesso ao sistema instalado. Antes de reinicializar o sistema, desmonte as partições com <command>umount </command><option>-a</option> e saia do ambiente de <quote>mudança de raiz</quote> com <command>exit</command>.
    </para>
   </step>
  </procedure>
  <warning>
   <title>Limitações</title>
   <para>
    Embora você tenha acesso total aos arquivos e aplicativos do sistema instalado, há algumas limitações. O kernel em execução é o que foi inicializado com o sistema de recuperação, e não com o ambiente de mudança de raiz. Ele suporta apenas o hardware essencial, e não é possível adicionar módulos do kernel do sistema instalado, a menos que as versões do kernel sejam idênticas. Verifique sempre a versão do kernel em execução (recuperação) com <command>uname -r</command> e, em seguida, descubra se existe um subdiretório correspondente no diretório <filename>/lib/modules</filename> no ambiente raiz de mudança. Em caso positivo, você poderá usar os módulos instalados, do contrário, precisará fornecer as versões corretas em outra mídia, como um disco flash. Na maioria das vezes, a versão do kernel de recuperação é diferente da que está instalada, portanto, não é possível simplesmente acessar a placa de som, por exemplo. Também não será possível iniciar uma interface gráfica de usuário.
   </para>
   <para>
    Observe também que você sai do ambiente de <quote>mudança de raiz</quote> ao percorrer o console com as teclas <keycombo><keycap function="alt"/><keycap>F1</keycap></keycombo> a <keycombo><keycap function="alt"/><keycap>F6</keycap></keycombo>.
   </para>
  </warning>
 </sect3>
 <sect3 xml:id="sec.trouble.data.recover.rescue.grub">
  <title>Modificando e reinstalando o carregador de boot</title>
  <para>
   Às vezes, não é possível reinicializar um sistema porque a configuração do carregador de boot está corrompida. As rotinas de inicialização não podem, por exemplo, converter unidades físicas em locais reais no sistema de arquivos Linux sem um carregador de boot ativo.
  </para>
  <para>
   Para verificar a configuração do carregador de boot e reinstalá-lo, faça o seguinte:
  </para>
  <procedure>
   <step>
    <para>
     Execute as etapas necessárias para acessar o sistema instalado como descrito em <xref linkend="sec.trouble.data.recover.rescue.access"/>.
    </para>
   </step>
   <step>
    <para>
     Verifique se o carregador de boot GRUB 2 está instalado no sistema. Se não estiver, instale o pacote <systemitem>grub2</systemitem> e execute
    </para>
<screen>grub2-install /dev/sda</screen>
   </step>
   <step>
    <para>
     Verifique se os arquivos a seguir estão configurados corretamente de acordo com os princípios de configuração do GRUB 2, descritos no <xref linkend="cha.grub2"/>, e aplique as correções, se necessário.
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       <filename>/etc/default/grub</filename>
      </para>
     </listitem>
     <listitem>
      <para>
       <filename>/boot/grub2/device.map</filename> (arquivo opcional, presente apenas se criado manualmente)
      </para>
     </listitem>
     <listitem>
      <para>
       <filename>/boot/grub2/grub.cfg</filename> (arquivo gerado, não o edite)
      </para>
     </listitem>
     <listitem>
      <para>
       <filename>/etc/sysconfig/bootloader</filename>
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     Reinstale o carregador de boot usando a seguinte sequência de comandos:
    </para>
<screen>grub2-mkconfig -o /boot/grub2/grub.cfg</screen>
   </step>
   <step>
    <para>
     Desmonte as partições, efetue logout do ambiente de <quote>mudança de raiz</quote> e reinicialize o sistema:
    </para>
<screen>umount -a
exit
reboot</screen>
   </step>
  </procedure>
 </sect3>
 <sect3 xml:id="sec.trouble.data.recover.rescue.dud">
  <title>Corrigindo a instalação do Kernel</title>
  <para>
   Uma atualização do kernel pode introduzir um novo bug capaz de afetar a operação do sistema. Por exemplo, um driver de parte do hardware no sistema pode estar com falha, o que o impede de acessá-lo e usá-lo. Nesse caso, reverta para o último kernel em funcionamento (se disponível no sistema) ou instale o kernel original pela mídia de instalação.
  </para>
  <tip>
   <title>Como manter os últimos kernels após a atualização</title>
   <para>
    Para evitar falhas na inicialização após uma atualização do kernel com defeito, use o recurso multiversão do kernel e indique ao <systemitem>libzypp</systemitem> quais kernels deseja manter após a atualização.
   </para>
   <para>
    Por exemplo, para sempre manter os dois últimos kernels e o kernel atual em execução, adicione
   </para>
<screen>multiversion.kernels = latest,latest-1,running</screen>
   <para>
    ao arquivo <filename>/etc/zypp/zypp.conf</filename>. Consulte <xref linkend="cha.tuning.multikernel"/> para obter mais informações.
   </para>
  </tip>
  <para>
   Um caso semelhante é quando você precisa reinstalar ou atualizar um driver com defeito em um dispositivo não suportado pelo <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase>. Por exemplo, quando o fornecedor do hardware utiliza determinando dispositivo, como um controlador RAID de hardware, que precisa de um driver binário para ser reconhecido pelo sistema operacional. Normalmente, o fornecedor lança um DUD (Driver Update Disk — Disco de Atualização do Driver) com a versão corrigida ou atualizada do driver necessário.
  </para>
  <para>
   Nos dois casos, você precisa acessar o sistema instalado no modo de recuperação e corrigir o problema relacionado ao kernel; do contrário, o sistema poderá não ser inicializado corretamente:
  </para>
  <procedure>
   <step>
    <para>
     Inicialize da mídia de instalação do <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase>.
    </para>
   </step>
   <step>
    <para>
     Se você estiver recuperando após uma atualização do kernel com defeito, ignore esta etapa. Se precisar usar um disco de atualização de driver (DUD), pressione <keycap>F6</keycap> para carregar a atualização de driver depois que o menu de boot aparecer e, em seguida, escolha o caminho ou URL para a atualização de driver e confirme clicando em <guimenu>Sim</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Escolha <guimenu>Sistema de Recuperação</guimenu> no menu de boot e pressione <keycap function="enter"/>. Se você usar o DUD, será solicitado a especificar o local em que a atualização de driver está armazenada.
    </para>
   </step>
   <step>
    <para>
     Digite <literal>root</literal> no prompt <literal>Rescue:</literal>. Não é necessário inserir uma senha.
    </para>
   </step>
   <step>
    <para>
     Monte manualmente o sistema de destino e <quote>mude a raiz</quote> para o novo ambiente. Para obter mais informações, consulte <xref linkend="sec.trouble.data.recover.rescue.access"/>. 
    </para>
   </step>
   <step>
    <para>
     Se você usar o DUD, instale/reinstale/atualize o pacote de driver do dispositivo com defeito. Sempre verifique se a versão do kernel instalada corresponde exatamente à versão do driver que está instalando.
    </para>
    <para>
     Se você estiver corrigindo uma instalação de atualização do kernel com defeito, poderá instalar o kernel original da mídia de instalação com o procedimento a seguir.
    </para>
    <substeps performance="required">
     <step>
      <para>
       Identifique o seu dispositivo de DVD com <command>hwinfo --cdrom</command> e monte-o com <command>mount /dev/sr0 /mnt</command>.
      </para>
     </step>
     <step>
      <para>
       Navegue até o diretório em que os arquivos do kernel estão armazenados no DVD, por exemplo, <command>cd /mnt/suse/x86_64/</command>.
      </para>
     </step>
     <step>
      <para>
       Instale os pacotes necessários <systemitem>kernel-*</systemitem>, <systemitem>kernel-*-base</systemitem> e <systemitem>kernel-*-extra</systemitem> de acordo com o seu tipo, usando o comando <command>rpm -i</command>.
      </para>
     </step>

    </substeps>
   </step>
   <step>
    <para>
     Atualize os arquivos de configuração e reinicialize o carregador de boot, se necessário. Para obter mais informações, consulte o <xref linkend="sec.trouble.data.recover.rescue.grub"/>.
    </para>
   </step>
   <step>
    <para>
     Remova a mídia inicializável da unidade do sistema e reinicialize-o.
    </para>
   </step>
  </procedure>
 </sect3>
</sect2>
