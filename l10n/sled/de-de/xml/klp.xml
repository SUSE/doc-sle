<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="klp.xml" version="5.0" xml:id="cha-klp" xml:lang="de">
 <title>Live-Kernel-Patching mit KLP</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    In diesem Dokument werden die Grundlagen der Kernel Live Patching-Technologie (KLP) erläutert und Sie finden hier Richtlinien für den SLE Live Patching-Dienst.
   </para>
  </abstract>
 </info>
 <para>
  Mit KLP können die neuesten Sicherheitsaktualisierungen ohne Neustart auf Linux-Kernel angewendet werden. So erzielen Sie die maximale Betriebszeit und Verfügbarkeit des Systems, was insbesondere bei unternehmenswichtigen Systemen von Bedeutung ist.
 </para>
 <para>
  Die Angaben in diesem Dokument gelten für die AMD64/Intel 64-, POWER- und IBM Z-Architekturen.
 </para>
 <sect1 xml:id="sec-klp-advantages">
  <title>Vorteile des Kernel Live Patching</title>

  <para>
   KLP bietet mehrere Vorteile.
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Wenn Unternehmen bestimmte Compliance-Zertifizierungen beantragen oder beibehalten möchten, sind sie darauf angewiesen, eine große Anzahl an Servern automatisch auf dem neuesten Stand zu halten. KLP kann dazu beitragen, die Compliance zu erzielen und gleichzeitig den Bedarf an kostspieligen Wartungsfenstern zu senken.
    </para>
   </listitem>
   <listitem>
    <para>
     Unternehmen, die mit Verträgen zur Vereinbarung zum Servicelevel arbeiten, müssen für Ihr System ein bestimmtes Maß an Verfügbarkeit und Betriebszeit garantieren. Mit Live Patching ist es möglich, Systeme ohne Ausfallzeiten zu patchen.
    </para>
   </listitem>
   <listitem>
    <para>
     KLP ist Teil des standardmäßigen Systemaktualisierungsmechanismus, sodass keine besondere Schulung oder Einführung komplizierter Wartungsroutinen anfällt.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec-klp-overview">
  <title>Überblick über Kernel Live Patching</title>

  <para>
   Kernel-Live-Patches werden in Form von Paketen mit modifiziertem Code bereitgestellt, die vom Kernel-Hauptpaket getrennt sind. Die Live-Patches sind kumulativ; der jeweils neueste Patch enthält also alle Fehlerbehebungen aus den vorhergehenden Patches für das Kernel-Paket. Jedes Kernel-Live-Paket ist an die genaue Kernel-Version gebunden, für die es ausgegeben wird. Die Versionsnummer des Live-Patch-Pakets erhöht sich bei jedem Hinzufügen von Fehlerbehebungen.
  </para>

  <note>
    <title>Live-Patches und der ausgeführte Kernel</title>
     <para>
      Um den Kernel-Patching-Status zu bestimmen, verwenden Sie den Befehl <command>klp -v
      patches</command>. Die Ausgabe des Befehls <command>uname</command> ändert sich für gepatchte Kernel nicht.
    </para>
  </note>

  <important>
   <title>Live-Patches im Vergleich zu Kernel-Aktualisierungen</title>
   <para>
    Live-Patches enthalten nur wichtige Korrekturen und ersetzen keine regulären Kernel-Updates, die einen Neustart erfordern. Betrachten Sie Live-Patches als vorübergehende Maßnahmen, die den Kernel schützen, bis ein ordnungsgemäßes Kernel-Update und ein Neustart vorgenommen werden.
   </para>
  </important>

  <para>
   Das folgende Diagramm veranschaulicht die allgemeine Beziehung zwischen Live-Patches und Kernel-Updates. Die Liste der CVEs (Common Vulnerabilities and Exposures) und Fehlerberichte, die vom derzeit aktiven Live-Patch behoben wurden, kann mit dem Befehl <command>klp -v
   patches</command> angezeigt werden.
  </para>

  <informalfigure>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="klp.png" width="80%"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="klp.png" width="100%"/>
    </imageobject>
   </mediaobject>
  </informalfigure>

  <para>
   Es ist möglich, mehrere Versionen des Kernel-Pakets zusammen mit den jeweiligen Live-Patches zu installieren. Diese Pakete lösen keine Konflikte aus. Sie können aktualisierte Kernel-Paket zusammen mit Live-Patches für den ausgeführten Kernel installieren. In diesem Fall werden Sie möglicherweise aufgefordert, das System neu zu starten. Benutzer mit SLE Live Patching-Abonnements haben Anspruch auf technischen Support, solange Live-Patch-Aktualisierungen für den ausgeführten Kernel vorliegen (siehe <xref linkend="sec-klp-lifecycle"/>).
  </para>

  <para>
   Wenn KLP aktiviert ist, umfasst jede Kernel-Aktualisierung auch ein Live-Patch-Paket. Dieser Live-Patch enthält keine Korrekturen und dient als Seed für zukünftige Live-Patches für den entsprechenden Kernel. Diese leeren, grundlegenden Patches werden als <literal>initial patches</literal> bezeichnet.
  </para>

  <sect2 xml:id="sec-klp-scope">
   <title>Umfang des Kernel Live Patching</title>
   <para>
    Das Live-Patching von SLE umfasst Korrekturen für Schwachstellen und Fehlerbehebungen des SUSE Common Vulnerability Scoring System (CVSS; SUSE CVSS basiert auf dem CVSS v3.1-System) Level 7+ in Verbindung mit Systemstabilität oder Datenbeschädigungen. Es ist jedoch nicht in jedem Fall technisch praktikabel, Live-Patches für alle Fehlerbehebungen in den angegebenen Kategorien zu erstellen. SUSE behält sich daher das Recht vor, Fehlerbehebungen in Situationen zu überspringen, in denen ein Kernel-Live-Patch aus technischen Gründen nicht möglich ist. Derzeit werden mehr als 95 % der geeigneten Fehlerbehebungen als Live-Patches bereitgestellt. Weitere Informationen zum CVSS (der Grundlage für die SUSE-CVSS-Einstufung) finden Sie unter <link xlink:href="https://www.first.org/cvss/">Common Vulnerability Scoring System SIG</link>.
   </para>
  </sect2>

  <sect2 xml:id="sec-klp-limitations">
   <title>Einschränkungen des Kernel Live Patching</title>
   <para>
    Kernel Live Patching (KLP) umfasst das Ersetzen von Funktionen und das ordnungsgemäße Verarbeiten des Austauschs von voneinander abhängigen Funktionssätzen. Hierbei werden Aufrufe von älterem Code an aktualisierten Code weitergeleitet, der sich an einem anderen Speicherort befindet. Änderungen in den Datenstrukturen erschweren die Situation, da die Daten beibehalten werden und nicht erweitert oder neu interpretiert werden können. Es gibt zwar einige Methoden für die indirekte Veränderung von Datenstrukturen, doch bestimmte Fehlerbehebungen können nicht in Live-Patches konvertiert werden. In dieser Situation ist ein Neustart des Systems die einzige Möglichkeit, die Fehlerbehebungen anzuwenden.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-klp-enable-with-yast2">
  <title>Aktivieren von Kernel Live Patching mit YaST</title>

  <para>
   Um KLP auf Ihrem System zu aktivieren, benötigen Sie aktive Live-Patching-Abonnements für SLES und SLE. Besuchen Sie das <link xlink:href="https://scc.suse.com/">SUSE Customer Center</link>, um den Status Ihrer Abonnements zu überprüfen und einen Registrierungscode für das SLE-Live-Patching-Abonnement zu erhalten.
  </para>

  <para>
   So aktivieren Sie Kernel Live Patching auf dem System:
  </para>

  <procedure>
   <step>
    <para>
     Führen Sie den Befehl <command>yast2 registration</command> aus und klicken Sie auf <guimenu>Erweiterungen auswählen</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Wählen Sie in der Liste der verfügbaren Erweiterungen den Eintrag <guimenu>SUSE Linux Enterprise Live Patching 15</guimenu> und klicken Sie auf <guimenu>Weiter</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Bestätigen Sie die Lizenzvereinbarung und klicken Sie auf <guimenu>Weiter</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Geben Sie Ihren Registrierungscode für SLE Live Patching ein und klicken Sie auf <guimenu>Weiter</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Prüfen Sie den <guimenu>Installationsüberblick</guimenu> und die ausgewählten <guimenu>Schemata</guimenu>. Die Schemata <systemitem>Live
     Patching</systemitem> und <systemitem>SLE Live Patching Lifecycle
     Data</systemitem> sollten automatisch für die Installation zusammen mit zusätzlichen Paketen ausgewählt werden, um Abhängigkeiten gerecht zu werden.
    </para>
   </step>
   <step>
    <para>
     Schließen Sie die Installation mit <guimenu>Akzeptieren</guimenu> ab. Dadurch werden die Basiskomponenten von Kernel Live Patching auf Ihrem System installiert sowie der ursprüngliche Live-Patch und die erforderlichen Abhängigkeiten.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-klp-enable-cli">
  <title>Aktivieren von Kernel Live Patching über die Befehlszeile</title>

  <para>
   Um Kernel Live Patching zu aktivieren, benötigen Sie aktive Live-Patching-Abonnements für SLES und SLES. Besuchen Sie das <link xlink:href="https://scc.suse.com/">SUSE Customer Center</link>, um den Status Ihrer Abonnements zu überprüfen und einen Registrierungscode für das SLES-Live-Patching-Abonnement zu erhalten.
  </para>

  <procedure>
   <step>
    <para>
     Führen Sie <command>sudo SUSEConnect --list-extensions</command>. Beachten Sie den genauen Aktivierungsbefehl für SLES Live Patching. Beispielausgabe des Befehls (gekürzt):
    </para>
<screen>$ SUSEConnect --list-extensions
...
SUSE Linux Enterprise Live Patching <phrase role="productnumber"><phrase os="sles;sled">15 SP7</phrase></phrase> x86_64
Activate with: SUSEConnect -p sle-module-live-patching/15.7/x86_64 \
  -r ADDITIONAL REGCODE</screen>
   </step>
   <step>
    <para>
     Aktivieren Sie SLES Live Patching mit dem erhaltenen Befehl, gefolgt von <option>-r
     <replaceable>LIVE_PATCHING_REGISTRATION_CODE</replaceable></option>, beispielsweise:
    </para>
<screen>SUSEConnect -p sle-module-live-patching/15.7/x86_64 \
  -r <replaceable>LIVE_PATCHING_REGISTRATION_CODE</replaceable></screen>
   </step>
   <step>
    <para>
     Installieren Sie die erforderlichen Pakete und Abhängigkeiten mit dem Befehl <command>zypper install -t pattern lp_sles</command>.
    </para>
   </step>
  </procedure>

  <para>
   Zu diesem Zeitpunkt sind die Live-Patches für das System bereits angewendet.
  </para>

  <para>
   So funktioniert der Prozess hinter den Kulissen: Wenn das Paketinstallationssystem erkennt, dass ein installierter Kernel vorhanden ist, der live gepatcht werden kann, und dass ein Live-Patch dafür im Software-Kanal vorhanden ist, wählt das System den Live-Patch für die Installation aus. Der Kernel erhält dann die Live-Patch-Fehlerbehebungen <emphasis>als Teil der Paketinstallation</emphasis>. Der Live-Patch für den Kernel wird noch vor Abschluss der Produktinstallation durchgeführt.
  </para>
 </sect1>
 <sect1 xml:id="sec-klp-perform">
  <title>Durchführen von Kernel Live Patching</title>

  <para>
   Kernel-Live-Patches werden im Rahmen von regulären Systemaktualisierungen installiert. Es sind jedoch einige Dinge zu beachten.
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Der Kernel ist live-gepatcht, wenn ein <package>kernel-livepatch-*</package>-Paket für den aktuellen Kernel installiert wurde. Mit dem Befehl <command>zypper se --details kernel-livepatch-*</command> können Sie prüfen, welche Kernel-Live-Patch-Pakete auf Ihrem System installiert sind.
    </para>
   </listitem>
   <listitem>
    <para>
     Wenn das Paket <package>kernel-default</package> installiert ist, fordert der Update-Manager Sie auf, das System neu zu starten. Damit diese Meldung nicht angezeigt wird, können Sie Kernel-Aktualisierungen aus dem Patching-Vorgang herausfiltern. Hierzu können Sie Paketsperren mit Zypper hinzufügen. Mit SUSE Multi-Linux Manager ist es auch möglich, Kanalinhalte zu filtern (siehe <link xlink:href="https://documentation.suse.com/suma/5.0/en/suse-manager/administration/live-patching.html">Live-Patching mit SUSE Multi-Linux Manager</link>).
    </para>
   </listitem>
   <listitem>
    <para>
     Sie können den Patching-Status mit dem Befehl <command>klp status</command> prüfen. Zur Untersuchung installierter Patches führen Sie den Befehl <command>klp -v
     patches</command> aus.
    </para>
   </listitem>
   <listitem>
    <para>
     Denken Sie daran: Es können zwar mehrere Kernel-Pakete auf dem System installiert sein, doch es kann immer nur eines dieser Pakete ausgeführt werden, nicht mehrere Pakete gleichzeitig. Ebenso können mehrere Live-Patch-Pakete installiert sein, doch es wird immer nur ein Live-Patch in den Kernel geladen.
    </para>
   </listitem>
   <listitem>
    <para>
     Der aktive Live-Patch ist in der <literal>initrd</literal> enthalten. Bei einem unvorhergesehenen Neustart fährt das System also mit den angewendeten Live-Patches hoch, sodass Sie das Patching nicht wiederholen müssen.
    </para>
   </listitem>
  </itemizedlist>

  <sect2 xml:id="sec-klp-lifecycle">
   <title>Prüfen des Ablaufdatums des Live-Patches</title>
   <para>
    Stellen Sie sicher, dass das <package>lifecycle-data-sle-module-live-patching</package> installiert ist, und führen Sie dann den Befehl <command>zypper lifecycle</command> aus. In Abschnitt <literal>Package end of support if
    different from product</literal> der Ausgabe sehen Sie das Ablaufdatum für den jeweiligen Live-Patch.
   </para>
   <para>
    Jeder Live-Patch wird ein Jahr ab Veröffentlichung des zugrunde liegenden Kernel-Pakets aktualisiert. Auf der Seite <link xlink:href="https://www.suse.com/products/live-patching/current-patches/">Maintained kernels, patch updates and lifecycle</link> können Sie das Ablaufdatum anhand der ausgeführten Kernel-Version prüfen, ohne die Produkterweiterung zu installieren.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-klp-troubleshoot">
  <title>Fehlerbehebung bei Kernel Live Patching-Problemen</title>

  <sect2 xml:id="sec-klp-man-patch-downgrade">
   <title>Manuelles Patch-Downgrade</title>
   <para>
    Wenn der neueste Live-Patch Probleme verursacht, können Sie ein Downgrade des aktuell installierten Live-Patches auf die vorhergehende Version durchführen. Es wird empfohlen, das Patch-Downgrade vorzunehmen, bevor das System erste Probleme zeigt. Denken Sie daran, dass ein System mit Kernel-Warnungen oder Kernel-Fehlerspuren im Systemprotokoll unter Umständen nicht für das Patch-Downgrade-Verfahren geeignet ist. Wenn Sie nicht sicher sind, ob das System die Anforderungen für ein Patch-Downgrade erfüllt, fragen Sie den technischen Support von SUSE.
   </para>
   <procedure>
    <title>Manuelles Patch-Downgrade</title>
    <step>
     <para>
      Ermitteln Sie den automatischen Live-Patch mit dem Befehl <command>klp -v
      patches</command>. Der aktuell ausgeführte Patch befindet sich in der Zeile, die mit <literal>RPM:</literal> beginnt. Beispiel:
     </para>
<screen>RPM: kernel-livepatch-6_4_0-150700_38-default-1-150700.1.23.x86_64</screen>
     <para>
      <literal>6_4_0-150600_9-default</literal> im Beispiel oben bezeichnet die genaue ausgeführte Kernel-Version.
     </para>
    </step>
    <step>
     <para>
      Verwenden Sie den Befehl <command>zypper search -s
      kernel-livepatch-<replaceable>RUNNING_KERNEL_VERSION</replaceable>-default</command>, um nach früheren Patch-Versionen zu suchen. Der Befehl gibt eine Liste der verfügbaren Paketversionen zurück. Denken Sie daran, dass die Versionsnummer bei jeder Veröffentlichung eines neuen Live-Patch-Pakets um eins erhöht wird. Wählen Sie die Versionsnummer aus, die um eine Veröffentlichung niedriger ist als die aktuelle Version.
     </para>
    </step>
    <step>
     <para>
      Installieren Sie die gewünschte Version mit dem Befehl <command>zypper in
      --oldpackage
      kernel-livepatch-<replaceable>RUNNING_KERNEL_VERSION</replaceable>-default=<replaceable>DESIRED_VERSION</replaceable></command>.
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
</chapter>
