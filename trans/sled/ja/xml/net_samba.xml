<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xml:base="net_samba.xml" id="cha.samba">
 <title>Samba</title><indexterm id="idx.Samba" class="startofrange"> <primary>Samba</primary> </indexterm> <indexterm> <primary>SMB</primary> <see>Samba</see> </indexterm> <indexterm> <primary>Mac OS X</primary> <secondary>ファイル共有</secondary> </indexterm> <indexterm> <primary>Windows</primary> <secondary>ファイル共有</secondary> </indexterm> <indexterm> <primary>OS/2</primary> <secondary>ファイル共有</secondary> </indexterm> <indexterm> <primary>Linux</primary> <secondary>別のOSとのファイル共有</secondary> </indexterm>
 <abstract>
  <para>
   Sambaを使用すると、Mac OS X、Windows、OS/2マシンに対するファイルサーバおよびプリントサーバをUnixマシン上に構築できます。Sambaは、今や成熟の域に達したかなり複雑な製品です。YaSTで、または環境設定ファイルを手動で編集することで、Sambaを設定します。
  </para>
 </abstract>
 <sect1 id="sec.samba.term">
  <title>用語集</title>

  <para>
   ここでは、SambaのマニュアルやYaSTモジュールで使用される用語について説明します。
  </para>

  <variablelist>
   <varlistentry>
    <term>SMBプロトコル</term>
    <listitem>
     <para>
      <indexterm><primary>Samba</primary><secondary>SMB</secondary></indexterm><indexterm><primary>プロトコル</primary><secondary>SMB</secondary></indexterm><indexterm><primary>smbd</primary></indexterm>SambaはSMB(サーバメッセージブロック)プロトコルを使用します。SMBは<phrase role="productname">NetBIOS</phrase>サービスを基にしています。Microsoftがこのプロトコルをリリースしたので、他のソフトウェアメーカはMicrosoftドメインネットワークに接続できるようになりました。Sambaでは、SMBプロトコルがTCP/IPプロトコルの上で動作するので、すべてのクライアントにTCP/IPプロトコルをインストールする必要があります。<indexterm> <primary>Samba</primary> <secondary>TCP/IP</secondary> </indexterm>
     </para>
     
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>CIFSプロトコル</term>
    <listitem>
     <para>
      <indexterm><primary>Samba</primary><secondary>CIFS</secondary></indexterm><indexterm><primary>プロトコル</primary><secondary>CIFS </secondary></indexterm>CIFS (common Internet file system)プロトコルは、Sambaがサポートしているプロトコルです。CIFSは、ネットワーク上で使用する標準のリモートファイルシステムで、ユーザグループによる共同作業およびネットワーク間でのドキュメントの共有ができるようにします。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NetBIOS<indexterm> <primary>Samba</primary> <secondary>名前</secondary> </indexterm></term>
    <listitem>
     <para>
      <indexterm><primary>NetBIOS</primary></indexterm>NetBIOSは、マシン間通信用に設計された、ネームサービスを提供するソフトウェアインタフェース(API)です。これにより、ネットワークに接続されたマシンが、それ自体の名前を維持できます。予約を行えば、これらのマシンを名前によって指定できます。名前を確認する一元的なプロセスはありません。ネットワーク上のマシンでは、すでに使用済みの名前でない限り、名前をいくつでも予約できます。NetBIOSインタフェースは、異なるネットワークアーキテクチャに実装できるようになっています。ネットワークハードウェアと比較的密接に機能する実装は<phrase role="productname">NetBEUI</phrase>と呼ばれますが、これはよく<phrase role="productname">NetBIOS</phrase>とも呼ばれます。NetBIOSとともに実装されるネットワークプロトコルは、Novell IPX (TCP/IP経由の NetBIOS)とTCP/IPです。
     </para>
     <para>
      TCP/IP経由で送信されたNetBIOS名は、<filename>/etc/hosts</filename>で使用されている名前、またはDNSで定義された名前とまったく共通点がありません。NetBIOSは独自の、完全に独立した名前付け規則を使用しています。しかし、管理を容易にするために、DNSホスト名に対応する名前を使用するか、DNSをネイティブで使用することをお勧めします。これはSambaが使用するデフォルトでもあります。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Sambaサーバ<indexterm> <primary>Samba</primary> <secondary>サーバ</secondary> </indexterm></term>
    <listitem>
     <para>
      Sambaサーバは、SMB/CIFSサービスおよびNetBIOS over IPネーミングサービスをクライアントに提供します。Linuxの場合、3種類のSambaサーバデーモン(SMB/CIFSサービス用smnd、ネーミングサービス用nmbd、認証用winbind)が用意されています。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Sambaクライアント<indexterm id="idx.Samba_clients" class="startofrange"> <primary>Samba</primary> <secondary>クライアント</secondary> </indexterm></term>
    <listitem>
     <para>
      Sambaクライアントは、SMBプロトコルを介してSambaサーバからSambaサービスを使用するシステムです。Mac OS X、Windows、OS/2などの一般的なオペレーティングシステムは、すべてSMBプロトコルをサポートしています。TCP/IPプロトコルは、すべてのコンピュータにインストールする必要があります。Sambaは、異なるUNIXフレーバーに対してクライアントを提供します。Linuxでは、SMB用のカーネルモジュールがあり、LinuxシステムレベルでのSMBリソースの統合が可能です。Sambaクライアントに対していずれのデーモンも実行する必要はありません。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>共有</term>
    <listitem>
     <para>
      <indexterm><primary>Samba</primary><secondary>共有</secondary></indexterm>SMBサーバは、そのクライアントに対し、共有によってリソースを提供します。共有は、サーバ上のサブディレクトリのあるディレクトリおよびプリンタです。これは名前によってエクスポートされ、名前によってアクセスされます。共有名にはどのような名前も設定できます。エクスポートディレクトリの名前である必要はありません。プリンタにも名前が割り当てられます。クライアントはプリンタに名前でアクセスできます。<indexterm><primary>印刷</primary><secondary>Samba</secondary></indexterm><indexterm><primary>Samba</primary><secondary>プリンタ</secondary></indexterm><indexterm class="endofrange" startref="idx.Samba_clients"/>
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>DC</term>
    <listitem>
     <para>
      <indexterm><primary>Samba</primary> <secondary>DC</secondary></indexterm>ドメインコントローラ(DC)は、ドメインのアカウントを処理するサーバです。データレプリケーションには、1つのドメインの中で追加のドメインコントローラが使用できます。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 id="sec.samba.install">
  <title>Sambaサーバのインストール</title>

  <para>
   Sambaサーバをインストールするには、YaSTを起動して、<menuchoice><guimenu>ソフトウェア</guimenu><guimenu>ソフトウェア管理</guimenu></menuchoice>の順に選択します。<menuchoice><guimenu>表示［</guimenu><guimenu>パターン</guimenu></menuchoice>の順に選択し、<guimenu>ファイルサーバ</guimenu>を選択します。必要なパッケージのインストールを確認して、インストールプロセスを完了します。
  </para>
 </sect1>
 
 <sect1 id="sec.samba.serv.inst">
  <title>Sambaサーバの設定</title><indexterm> <primary>Samba</primary> <secondary>インストール</secondary> </indexterm> <indexterm> <primary>Samba</primary> <secondary>サーバ</secondary> </indexterm> <indexterm> <primary>Samba</primary> <secondary>設定</secondary> </indexterm> <indexterm> <primary>設定</primary> <secondary>Samba</secondary> </indexterm>

  

  <para os="sled">
   Sambaサーバの設定については、SUSE Linux Enterprise Serverのドキュメントを参照してください。
  </para>

  



  
 </sect1>
 <sect1 id="sec.samba.client.inst">
  <title>クライアントの設定</title><indexterm> <primary>Samba</primary> <secondary>クライアント</secondary> </indexterm>

  <para>
   クライアントは、TCP/IP経由でのみSambaサーバにアクセスできます。IPX経由のNetBEUIおよびNetBIOSは、Sambaで使用できません。
  </para>

  <sect2 id="sec.samba.client.inst.yast">
   <title>YaSTによるSambaクライアントの設定</title><indexterm> <primary>YaST</primary> <secondary>Samba</secondary> <tertiary>クライアント</tertiary> </indexterm> <indexterm> <primary>Samba</primary> <secondary>クライアント</secondary> </indexterm> <indexterm> <primary>設定</primary> <secondary>Samba</secondary> <tertiary>クライアント</tertiary> </indexterm>
   <para>
    SambaクライアントをSambaサーバまたはWindowsサーバ上のリソース(ファイルまたはプリンタ)にアクセスするように設定します。NTまたはActive Directoryのドメインまたはワークグループを、<menuchoice> <guimenu>ネットワークサービス</guimenu><guimenu>Windowsドメインメンバーシップ</guimenu></menuchoice>の順に選択して表示したダイアログに入力します。<guimenu>Linuxの認証にもSMBの情報を使用する</guimenu>を有効にした場合、ユーザ認証は、Samba、NT、またはKerberosのサーバ上で実行されます。
   </para>
   <para>
    <guimenu>エキスパート設定</guimenu>をクリックして、高度な設定オプションを設定します。たとえば、認証による自動的なサーバホームディレクトリのマウントを有効化するには、<guimenu>サーバディレクトリのマウント</guimenu>のテーブルを使用します。これにより、CIFS上でホストされると、ホームディレクトリにアクセスできるようになります。詳細については、<systemitem>pam_mount</systemitem>のマニュアルページを参照してください。
   </para>
   <para>
    すべての設定を完了したら、ダイアログを確認して設定を終了します。
   </para>
  </sect2>
 </sect1>
 <sect1 id="sec.samba.anmeld.serv">
  <title>ログインサーバとしてのSamba</title><indexterm> <primary>Samba</primary> <secondary>ログイン</secondary> </indexterm>

  <para>
   Windowsクライアントが大部分を占めるネットワークでは、ユーザが有効なアカウントとパスワードを持つ場合のみ登録できることが求められるのが普通です。Windowsベースのネットワークでは、このタスクはPDC (プライマリドメインコントローラ)によって処理されます。Windows NTサーバをPDCとして使用することもできますが、Sambaサーバを使用しても処理できます。<xref linkend="dat.samba.smb.conf.dom"/>に示すように、<filename>smb.conf</filename>の<literal>[global]</literal>セクションにエントリを追加する必要があります。
  </para>

  <example id="dat.samba.smb.conf.dom">
   <title>smb.confファイルのグローバルセクション</title>
<screen>[global]
    workgroup = WORKGROUP
    domain logons = Yes
    domain master = Yes</screen>
  </example>

  <para>
   ユーザアカウントとパスワードをWindowsに準拠した暗号化形式で作成する必要があります。そのためにはコマンド<command>smbpasswd <option>-a name</option></command>を実行します。さらに次のコマンドを使用して、Windows ドメイン概念で必要になるコンピュータのドメインアカウントを作成します。
  </para>

<screen>useradd hostname\$
smbpasswd -a -m hostname</screen><indexterm> <primary>コマンド</primary><secondary>smbpasswd</secondary> </indexterm>

  <para>
   <command>useradd</command>コマンドを使用すると、ドル記号が追加されます。コマンド<command>smbpasswd</command>を指定すると、パラメータ<option>-m</option>を使用したときにドル記号が自動的に挿入されます。コメント付きの設定例(<filename>/usr/share/doc/packages/Samba/examples/smb.conf.SuSE</filename>)には、この作業を自動化するための設定が含まれています。
  </para>

<screen>add machine script = /usr/sbin/useradd -g nogroup -c "NT Machine Account" \
-s /bin/false %m\$
     </screen>

  <para>
   Sambaがこのスクリプトを正常に実行できるようにするため、必要な管理者権限を持つSambaユーザを選択して、<systemitem class="groupname">ntadmin</systemitem>グループに追加します。これにより、このLinuxグループに属するすべてのユーザに対し、次のコマンドによって<literal>Domain Admin</literal>ステータスを割り当てることができます。
  </para>

<screen>net groupmap add ntgroup="Domain Admins" unixgroup=ntadmin</screen>
 </sect1>
 
 <sect1 id="samba.advanced">
  <title>詳細トピック</title>

  <para>
   このセクションでは、Sambaスイートのクライアントとサーバの両方の部分を管理するためのより高度なテクニックを紹介します。
  </para>

  <sect2 id="samba.advanced.compress">
   <title>Btrfsでの透過的なファイル圧縮</title>
   <para>
    Sambaでは、クライアントは、Btrfsファイルシステムに配置されている共有のファイルおよびディレクトリの圧縮フラグをリモートで操作できます。Windowsエクスプローラでは、<menuchoice><guimenu>ファイル</guimenu><guimenu>プロパティ</guimenu><guimenu>詳細</guimenu></menuchoice>ダイアログを使用することで、ファイル/ディレクトリに透過的な圧縮対象のフラグを付けることができます。
   </para>
   <figure>
    <title>Windowsエクスプローラの<guimenu>属性の詳細</guimenu>ダイアログ</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="samba_win_expl_advattr.png" width="30%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="samba_win_expl_advattr.png" width="30%" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    圧縮対象フラグが付いたファイルは、アクセスまたは変更があると、基礎となるファイルシステムによって透過的に圧縮および圧縮解除されます。通常、これによってファイルアクセス時に余分なCPUオーバーヘッドが生じますが、ストレージ容量の節約になります。新しいファイルとディレクトリは、FILE_NO_COMPRESSIONオプションを指定して作成しない限り、親ディレクトリの圧縮フラグを継承します。
   </para>
   <para>
    Windowsエクスプローラでは、圧縮ファイルとディレクトリは、未圧縮のファイル/ディレクトリとは視覚的に見分けが付くように表示されます。
   </para>
   <figure>
    <title>Windowsエクスプローラでの圧縮ファイルのディレクトリリスト</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="samba_win_expl_view_compressed.png" width="30%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="samba_win_expl_view_compressed.png" width="30%" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    Samba共有の圧縮を有効にするには、手動で、
   </para>
<screen>vfs objects = btrfs</screen>
   <para>
    <filename>/etc/samba/smb.conf</filename>に共有設定を追加して実行するか、YaSTを使用して<menuchoice><guimenu>ネットワークサービス</guimenu><guimenu>Sambaサーバ</guimenu><guimenu>追加</guimenu></menuchoice>の順に選択して<guimenu>btrfs機能を利用する</guimenu>をオンにします。
   </para>
  </sect2>

  <sect2 id="samba.advanced.snapshots">
   <title>スナップショット</title>
   <para>
    スナップショット(シャドウコピーとも呼ばれる)は、特定の時点におけるファイルシステムサブボリュームの状態のコピーです。Snapperは、Linuxでこれらのスナップショットを管理するためのツールです。スナップショットは、BtrfsファイルシステムまたはシンプロビジョニングされたLVMボリュームでサポートされています。Sambaスイートは、サーバ側とクライアント側の両方で、FSRVPプロトコルを介したリモートスナップショットの管理をサポートしています。
   </para>
   <sect3 id="samba.advanced.snapshots.client">
    <title>以前のバージョン</title>
    <para>
     Sambaサーバのスナップショットは、ファイルまたはディレクトリの以前のバージョンとしてリモートWindowsクライアントにエクスポートできます。
    </para>
    <para>
     Sambaサーバでスナップショットを有効にするには、次の条件を満たしている必要があります。
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       SMBネットワーク共有がBtrfsサブボリューム上に存在している。
      </para>
     </listitem>
     <listitem>
      <para>
       SMBネットワーク共有のパスに、関連するSnapper環境設定ファイルが含まれている。次のコマンドを使用して、Snapperファイルを作成できます。
      </para>
<screen>snapper -c &lt;cfg_name&gt; create-config <option>/path/to/share</option></screen>
      <para>
       Snapperの詳細については、<xref linkend="cha.snapper"/>を参照してください。
      </para>
     </listitem>
     <listitem>
      <para>
       スナップショットディレクトリツリーでは、関連するユーザにアクセスを許可する必要があります。詳細については、vfs_snapperマニュアルページの「PERMISSIONS」のセクション(<command>man 8 vfs_snapper</command>)を参照してください。
      </para>
     </listitem>
    </itemizedlist>
    <para>
     リモートスナップショットをサポートするには、<filename>/etc/samba/smb.conf</filename>ファイルを変更する必要があります。変更するには、<menuchoice><guimenu>YaST</guimenu><guimenu>ネットワークサービス</guimenu><guimenu>Sambaサーバ</guimenu></menuchoice>の順に選択するか、または次のコマンドを使用して関連する共有セクションを手動で拡張します。
    </para>
<screen>vfs objects = snapper</screen>
    <para>
     手動での<filename>smb.conf</filename>への変更を有効にするために、Sambaサービスを再起動する必要がある点に注意してください。
    </para>
<screen>systemctl restart nmb.service smb.service</screen>
    <figure id="fig.yast2.samba.snapshot">
     <title>スナップショットが有効な新しいSamba共有の追加</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="yast2_samba_snapshot.png" width="70%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="yast2_samba_snapshot.png" width="75%" format="PNG"/>
      </imageobject>
     </mediaobject>
    </figure>
    <para>
     設定後、Samba共有パスでSnapperによって作成されたスナップショットには、Windowsエクスプローラのファイルまたはディレクトリの<guimenu>以前のバージョン</guimenu>タブからアクセスできます。
    </para>
    <figure id="fig.samba.win_explorer">
     <title>Windowsエクスプローラの<guimenu>以前のバージョン</guimenu>タブ</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="samba_winexpl_previous_versions.png" width="70%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="samba_winexpl_previous_versions.png" width="75%" format="PNG"/>
      </imageobject>
     </mediaobject>
    </figure>
   </sect3>
   <sect3 id="samba.advanced.snapshots.server">
    <title>リモート共有スナップショット</title>
    <para>
     デフォルトでは、スナップショットは、SnapperコマンドラインユーティリティまたはSnapperのタイムライン機能を使用して、Sambaサーバ上でローカルでのみ作成および削除できます。
    </para>
    <para>
     Sambaは、リモートホストからの共有スナップショット作成および削除要求をFSRVP (File Server Remote VSS Protocol)を使用して処理するように設定できます。
    </para>
    <para>
     <xref linkend="samba.advanced.snapshots.client"/>で説明されている環境設定と前提条件に加え、<filename>/etc/samba/smb.conf</filename>に次のグローバル設定が必要です。
    </para>
<screen>[global]
rpc_daemon:fssd = fork
registry shares = yes
include = registry</screen>
    <para>
     その後、FSRVPクライアント(Sambaの<command>rpcclient</command>およびWindows Server 2012 <command>DiskShadow.exe</command>を含む)は、特定の共有のスナップショットを作成または削除したり、スナップショットを新しい共有として公開したりするようSambaに命令できます。
    </para>
   </sect3>
   <sect3 id="samba.advanced.snapshots.client.linux">
    <title><command>rpcclient</command>によるLinuxからのスナップショットのリモート管理</title>
    <para>
     <systemitem>samba-client</systemitem>パッケージには、特定の共有の作成と公開をWindows/Sambaサーバにリモートで要求できるFSRVPクライアントが含まれています。SUSE Linux Enterprise Serverの既存のツールを使用して、公開された共有をマウントし、そのファイルをバックアップできます。サーバへの要求は、<command>rpcclient</command>バイナリを使用して送信されます。
    </para>
    <example>
     <title><command>rpcclient</command>を使用したWindows Server 2012共有スナップショットの要求</title>
     <para>
      <literal>win-server.example.com</literal>サーバに<literal>EXAMPLE</literal>ドメインの管理者として接続します。
     </para>
<screen># rpcclient -U '<replaceable>EXAMPLE</replaceable>\Administrator' ncacn_np:<replaceable>win-server.example.com</replaceable>[ndr64,sign]
Enter EXAMPLE/Administrator's password:</screen>
     <para>
      <command>rpcclient</command>にSMB共有が表示されることを確認します。
     </para>
<screen>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark: 
path:   C:\Shares\windows_server_2012_share
password:       (null)</screen>
     <para>
      SMB共有がスナップショットの作成をサポートしていることを確認します。
     </para>
<screen>rpcclient $&gt; fss_is_path_sup windows_server_2012_share \
UNC \\WIN-SERVER\windows_server_2012_share\ supports shadow copy requests</screen>
     <para>
      共有スナップショットの作成を要求します。
     </para>
<screen>rpcclient $&gt; fss_create_expose backup ro windows_server_2012_share
13fe880e-e232-493d-87e9-402f21019fb6: shadow-copy set created
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
\\WIN-SERVER\windows_server_2012_share\ shadow-copy added to set
13fe880e-e232-493d-87e9-402f21019fb6: prepare completed in 0 secs
13fe880e-e232-493d-87e9-402f21019fb6: commit completed in 1 secs
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
share windows_server_2012_share@{1C26544E-8251-445F-BE89-D1E0A3938777} \
exposed as a snapshot of \\WIN-SERVER\windows_server_2012_share\</screen>
     <para>
      スナップショット共有がサーバによって公開されたことを確認します。
     </para>
<screen>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark: 
path:   C:\Shares\windows_server_2012_share
password:       (null)

netname: windows_server_2012_share@{1C26544E-8251-445F-BE89-D1E0A3938777}
remark: (null)
path:   \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy{F6E6507E-F537-11E3-9404-B8AC6F927453}\Shares\windows_server_2012_share\
password:       (null)</screen>
     <para>
      スナップショット共有の削除を試みます。
     </para>
<screen>rpcclient $&gt; fss_delete windows_server_2012_share \
13fe880e-e232-493d-87e9-402f21019fb6 1c26544e-8251-445f-be89-d1e0a3938777
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
\\WIN-SERVER\windows_server_2012_share\ shadow-copy deleted</screen>
     <para>
      スナップショット共有がサーバによって削除されたことを確認します。
     </para>
<screen>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark: 
path:   C:\Shares\windows_server_2012_share
password:       (null)</screen>
    </example>
   </sect3>
   <sect3 id="samba.advanced.snapshots.client.winserver">
    <title><command>DiskShadow.exe</command>によるWindowsからのスナップショットのリモート管理</title>
    <para>
     同様に、Linux Sambaサーバ上のSMB共有のスナップショットを、クライアントとして動作するWindows環境から管理できます。Windows Server 2012には、<xref linkend="samba.advanced.snapshots.client.linux"/>で説明した<command>rpcclient</command>と同様にリモート共有を管理できる<command>DiskShadow.exe</command>ユーティリティが含まれています。最初にSambaサーバを慎重に設定する必要がある点に注意してください。
    </para>
    <para>
     以下は、Windows Serverクライアントが共有のスナップショットを管理できるようにSambaサーバを設定する手順の例です。EXAMPLEはテスト環境で使用されるActive Directoryドメイン、fsrvp-server.example.comはSambaサーバのホスト名、<filename>/srv/smb</filename>はSMB共有のパスである点に注意してください。
    </para>
    <procedure>
     <title>Sambaサーバの詳細な設定</title>
     <step performance="required">
      <para>
       YaSTを介してActive Directoryドメインに参加します。
      </para>
     </step>
     <step performance="required">
      <para>
       Active DirectoryのDNSエントリが正しいことを確認します。
      </para>
<screen>fsrvp-server:~ # net -U 'Administrator' ads dns register \
fsrvp-server.example.com &lt;IP address&gt;
Successfully registered hostname with DNS</screen>
     </step>
     <step performance="required">
      <para>
       Btrfsサブボリュームを<filename>/srv/smb</filename>に作成します。
      </para>
<screen>fsrvp-server:~ # btrfs subvolume create /srv/smb</screen>
     </step>
     <step performance="required">
      <para>
       パス<filename>/srv/smb</filename>にSnapper環境設定ファイルを作成します。
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; create-config /srv/smb</screen>
     </step>
     <step performance="required">
      <para>
       パス<filename>/srv/smb</filename>に新しい共有を作成し、YaSTの<guimenu>スナップショットを公開する</guimenu>チェックボックスをオンにします。<xref linkend="samba.advanced.snapshots.server"/>に説明されているように、次のスニペットを<filename>/etc/samba/smb.conf</filename>のグローバルセクションに追加します。
      </para>
<screen>[global]
 rpc_daemon:fssd = fork
 registry shares = yes
 include = registry</screen>
     </step>
     <step performance="required">
      <para>
       <command>systemctl restart nmb.service smb.service</command>を実行して、Sambaを再起動します。
      </para>
     </step>
     <step performance="required">
      <para>
       Snapperのパーミッションを設定します。
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; set-config \
ALLOW_USERS="EXAMPLE\\\\Administrator EXAMPLE\\\\win-client$"</screen>
      <para>
       ALLOW_USERSに<filename>.snapshots</filename>サブディレクトリのトラバースも許可されていることを確認します。
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; set-config SYNC_ACL=yes</screen>
      <important>
       <title>パスのエスケープ</title>
       <para>
        「\」エスケープには注意してください。<filename>/etc/snapper/configs/&lt;snapper_config&gt;</filename>に保存された値を確実に1回エスケープするには、2回エスケープします。
       </para>
      </important>
      <para>
       「EXAMPLE\win-client$」はWindowsクライアントのコンピュータアカウントに対応します。Windowsは、このアカウントが認証されている間に初期FSRVP要求を発行します。
      </para>
     </step>
     <step performance="required">
      <para>
       Windowsクライアントアカウントに必要な特権を付与します。
      </para>
<screen>fsrvp-server:~ # net -U 'Administrator' rpc rights grant \
"EXAMPLE\\win-client$" SeBackupPrivilege
Successfully granted rights.</screen>
      <para>
       「EXAMPLE\Administrator」ユーザの場合、すでに特権が付与されているため、上のコマンドは必要ありません。
      </para>
     </step>
    </procedure>
    <procedure>
     <title>Windowsクライアントのセットアップと<command>DiskShadow.exe</command>の実行</title>
     <step performance="required">
      <para>
       Windows Server 2012 (ホスト名の例:WIN-CLIENT)をブートします。
      </para>
     </step>
     <step performance="required">
      <para>
       Active DirectoryドメインEXAMPLEに、SUSE Linux Enterprise Serverで参加します。
      </para>
     </step>
     <step performance="required">
      <para>
       再起動します。
      </para>
     </step>
     <step performance="required">
      <para>
       Powershellを開きます。
      </para>
     </step>
     <step performance="required">
      <para>
       <command>DiskShadow.exe</command>を起動し、バックアップ手順を開始します。
      </para>
<screen>PS C:\Users\Administrator.EXAMPLE&gt; diskshadow.exe
Microsoft DiskShadow version 1.0
Copyright (C) 2012 Microsoft Corporation
On computer:  WIN-CLIENT,  6/17/2014 3:53:54 PM

DISKSHADOW&gt; begin backup</screen>
     </step>
     <step performance="required">
      <para>
       プログラムを終了、リセット、または再起動しても、シャドウコピーが継続動作するように指定します。
      </para>
<screen>DISKSHADOW&gt; set context PERSISTENT</screen>
     </step>
     <step performance="required">
      <para>
       指定した共有がスナップショットをサポートしているかどうかを確認し、スナップショットを作成します。
      </para>
<screen>DISKSHADOW&gt; add volume \\fsrvp-server\sles_snapper

DISKSHADOW&gt; create
Alias VSS_SHADOW_1 for shadow ID {de4ddca4-4978-4805-8776-cdf82d190a4a} set as \
 environment variable.
Alias VSS_SHADOW_SET for shadow set ID {c58e1452-c554-400e-a266-d11d5c837cb1} \
 set as environment variable.

Querying all shadow copies with the shadow copy set ID \
 {c58e1452-c554-400e-a266-d11d5c837cb1}

 * Shadow copy ID = {de4ddca4-4978-4805-8776-cdf82d190a4a}     %VSS_SHADOW_1%
    - Shadow copy set: {c58e1452-c554-400e-a266-d11d5c837cb1}  %VSS_SHADOW_SET%
    - Original count of shadow copies = 1
    - Original volume name: \\FSRVP-SERVER\SLES_SNAPPER\ \
      [volume not on this machine]
    - Creation time: 6/17/2014 3:54:43 PM
    - Shadow copy device name: 
      \\FSRVP-SERVER\SLES_SNAPPER@{31afd84a-44a7-41be-b9b0-751898756faa}
    - Originating machine: FSRVP-SERVER
    - Service machine: win-client.example.com
    - Not exposed
    - Provider ID: {89300202-3cec-4981-9171-19f59559e0f2}
    - Attributes:  No_Auto_Release Persistent FileShare

Number of shadow copies listed: 1</screen>
     </step>
     <step performance="required">
      <para>
       バックアップ手順を終了します。
      </para>
<screen>DISKSHADOW&gt; end backup</screen>
     </step>
     <step performance="required">
      <para>
       スナップショットが作成された後、その削除を試み、削除されたことを確認します。
      </para>
<screen>DISKSHADOW&gt; delete shadows volume \\FSRVP-SERVER\SLES_SNAPPER\
Deleting shadow copy {de4ddca4-4978-4805-8776-cdf82d190a4a} on volume \
 \\FSRVP-SERVER\SLES_SNAPPER\ from provider \
{89300202-3cec-4981-9171-19f59559e0f2} [Attributes: 0x04000009]...

Number of shadow copies deleted: 1

DISKSHADOW&gt; list shadows all

Querying all shadow copies on the computer ...
No shadow copies found in system.</screen>
     </step>
    </procedure>
   </sect3>
  </sect2>
 </sect1>
 <sect1 id="sec.samba.info">
  <title>その他の情報</title>

  <para>
   Sambaのマニュアルは<systemitem>samba-doc</systemitem>パッケージに付属していますが、デフォルトではインストールされません。インストールするには、<command>zypper install samba-doc</command> を実行します。コマンドラインから「<command>apropos</command> <option>samba</option>」と入力するとマニュアルページを参照できます。または、<filename>/usr/share/doc/packages/samba</filename>ディレクトリに格納されているその他のオンラインマニュアルと例を参照できます。また、コメント付きの設定例(<filename>smb.conf.SUSE</filename>)が<filename>examples</filename>サブディレクトリに用意されています。Samba関連の情報を参照できるもう1つのファイルは、<filename>/usr/share/doc/packages/samba/README.SUSE</filename>です。<indexterm> <primary>環境設定ファイル</primary> <secondary>smb.conf</secondary> </indexterm>
  </para>

  <para>
   Sambaチームが作成した『Samba- HOWTO』(<ulink url="https://wiki.samba.org"/>を参照)では、トラブルシューティングについても説明されています。またマニュアルのPart Vでは、手順を追って設定を確認するためのガイドが用意されています。
  </para><indexterm class="endofrange" startref="idx.Samba"/>
 </sect1>
</chapter>
