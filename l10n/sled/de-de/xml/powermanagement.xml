<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="powermanagement.xml" version="5.0" xml:id="cha-power-mgmt">
 <title>Energieverwaltung</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 
 <para>
  Die Energieverwaltung ist insbesondere bei Notebook-Computern von großer Wichtigkeit, sie ist jedoch auch für andere Systeme sinnvoll. ACPI (Advanced Configuration &amp; Power Interface) ist auf allen modernen Computern (Laptops, Desktops, Server) verfügbar. Für Energieverwaltungstechnologien sind geeignete Hardware- und BIOS-Routinen erforderlich. Die meisten Notebooks und modernen Desktops und Server erfüllen diese Anforderungen. Es ist außerdem möglich, die CPU-Frequenzskalierung zu steuern, um Energie zu sparen oder den Geräuschpegel zu senken.
 </para>
 <sect1 xml:id="sec-power-mgmt-save">
  <title>Energiesparfunktionen</title>

  <para>
   Energiesparfunktionen sind nicht nur für die mobile Verwendung von Notebooks von Bedeutung, sondern auch für Desktop-Systeme. Die Hauptfunktionen und ihre Verwendung im ACPI sind:
  </para>

  <variablelist>
   <varlistentry>
    <term>Standby</term>
    <listitem>
     <para>
      Nicht unterstützt.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Suspend (in Arbeitsspeicher)</term>
    <listitem>
     <para>
      In diesem Modus wird der gesamte Systemstatus in den RAM geschrieben. Anschließend wird das gesamte System mit Ausnahme des RAM in den Ruhezustand versetzt. In diesem Zustand verbraucht der Computer sehr wenig Energie. Der Vorteil dieses Zustands besteht darin, dass innerhalb weniger Sekunden die Arbeit nahtlos wieder aufgenommen werden kann, ohne dass ein Booten des Systems oder ein Neustart der Anwendungen erforderlich ist. Diese Funktion entspricht ACPI-Zustand <literal>S3</literal>. 

     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Tiefschlaf (Suspend to Disk)
    </term>
    <listitem>
     <para>
      In diesem Betriebsmodus wird der gesamte Systemstatus auf die Festplatte geschrieben und das System wird von der Energieversorgung getrennt. Es muss eine Swap-Partition vorhanden sein, die mindestens die Größe des RAM hat, damit alle aktiven Daten geschrieben werden können. Die Reaktivierung von diesem Zustand dauert ungefähr 30 bis 90 Sekunden. Der Zustand vor dem Suspend-Vorgang wird wiederhergestellt. Einige Hersteller bieten Hybridvarianten dieses Modus an, beispielsweise RediSafe bei IBM Thinkpads. Der entsprechende ACPI-Zustand ist <literal>S4</literal>. In Linux wird „suspend to disk“ über Kernel-Routinen durchgeführt, die von ACPI unabhängig sind.
     </para>
      <note>
  <title>Geänderte UUID für Swap-Partitionen bei Formatierung über <command>mkswap</command></title>
  <para>Falls möglich, sollten bestehende Swap-Partitionen nicht mit <command>mkswap</command> neu formatiert werden. Durch die Neuformatierung mit <command>mkswap</command> ändert sich der UUID-Wert der Swap-Partition. Führen Sie die Neuformatierung entweder über YaST aus (<filename>/etc/fstab</filename> wird dabei aktualisiert) oder passen Sie <filename>/etc/fstab</filename> manuell an.
  </para>
</note>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Akkuüberwachung
    </term>
    <listitem>
     <para>
      ACPI überprüft den Akkuladestatus und stellt entsprechende Informationen bereit. Außerdem koordiniert es die Aktionen, die beim Erreichen eines kritischen Ladestatus durchzuführen sind.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Automatisches Ausschalten</term>
    <listitem>
     <para>
      Nach dem Herunterfahren wird der Computer ausgeschaltet. Dies ist besonders wichtig, wenn der Computer automatisch heruntergefahren wird, kurz bevor der Akku leer ist.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Steuerung der Prozessorgeschwindigkeit</term>
    <listitem>
     <para>
      In Verbindung mit der CPU gibt es drei Möglichkeiten, Energie zu sparen: Frequenz- und Spannungsskalierung (auch <phrase role="productname">PowerNow!</phrase> oder <phrase role="productname">Speedstep</phrase>), Drosselung und Versetzen des Prozessors in den Ruhezustand (C-Status). Je nach Betriebsmodus des Computers können diese Methoden auch kombiniert werden.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec-power-mgmt-acpi">
  <title>Advanced Configuration &amp; Power Interface (ACPI)</title>

  <para>
   Die ACPI (erweiterte Konfigurations- und Energieschnittstelle) wurde entwickelt, um dem Betriebssystem die Einrichtung und Steuerung der einzelnen Hardware-Komponenten zu ermöglichen. ACPI löst sowohl Power-Management Plug and Play (PnP) als auch Advanced Power Management (APM) ab. Diese Schnittstelle bietet Informationen zu Akku, Netzteil, Temperatur, Ventilator und Systemereignissen wie <quote>Deckel schließen</quote> oder <quote>Akku-Ladezustand niedrig</quote>.
  </para>

  <para>
   Das BIOS bietet Tabellen mit Informationen zu den einzelnen Komponenten und Hardware-Zugriffsmethoden. Das Betriebssystem verwendet diese Informationen für Aufgaben wie das Zuweisen von Interrupts oder das Aktivieren bzw. Deaktivieren von Komponenten. Da das Betriebssystem die in BIOS gespeicherten Befehle ausführt, hängt die Funktionalität von der BIOS-Implementierung ab. Die Tabellen, die ACPI erkennen und laden kann, werden in journald gemeldet. Weitere Informationen zum Abrufen der Protokollmeldungen im Journal finden Sie unter <xref linkend="cha-journalctl"/>. Weitere Informationen zur Fehlersuche bei ACPI-Problemen finden Sie in <xref linkend="sec-power-mgmt-acpi-trouble"/>.
  </para>

  <sect2 xml:id="sec-power-mgmt-acpi-powernow">
   <title>Steuern der CPU-Leistung</title>
   <para>
    Mit der CPU sind Energieeinsparungen auf drei verschiedene Weisen möglich:
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      Frequenz- und Spannungsskalierung
     </para>
    </listitem>
    <listitem>
     <para>
      Drosseln der Taktfrequenz (T-Status)
     </para>
    </listitem>
    <listitem>
     <para>
      Versetzen des Prozessors in den Ruhezustand (C-Status)
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Je nach Betriebsmodus des Computers können diese Methoden auch kombiniert werden. Energiesparen bedeutet auch, dass sich das System weniger erhitzt und die Ventilatoren seltener in Betrieb sind.
   </para>
   <para>
    Frequenzskalierung und Drosselung sind nur relevant, wenn der Prozessor belegt ist, da der sparsamste C-Zustand ohnehin gilt, wenn sich der Prozessor im Wartezustand befindet. Wenn die CPU belegt ist, ist die Frequenzskalierung die empfohlene Energiesparmethode. Häufig arbeitet der Prozessor nur im Teillast-Betrieb. In diesem Fall kann er mit einer niedrigeren Frequenz betrieben werden. Im Allgemeinen empfiehlt sich die dynamische Frequenzskalierung mit Steuerung durch den On-Demand-Governor im Kernel.
   </para>
   <para>
    Drosselung sollte nur als letzter Ausweg verwendet werden, um die Betriebsdauer des Akkus trotz hoher Systemlast zu verlängern. Einige Systeme arbeiten bei zu hoher Drosselung jedoch nicht reibungslos. Außerdem hat die CPU-Drosselung keinen Sinn, wenn die CPU kaum ausgelastet ist.
   </para>
   <para>
    Detaillierte Informationen hierzu finden Sie im <xref linkend="cha-tuning-power"/>.
   </para>
  </sect2>

  <sect2 xml:id="sec-power-mgmt-acpi-trouble">
   <title>Fehlersuche</title>
   <para>
    Es gibt zwei verschiedene Arten von Problemen. Einerseits kann der ACPI-Code des Kernel Fehler enthalten, die nicht rechtzeitig erkannt wurden. In diesem Fall wird eine Lösung zum Herunterladen bereitgestellt. Häufiger werden die Probleme vom BIOS verursacht. Manchmal werden Abweichungen von der ACPI-Spezifikation absichtlich in das BIOS integriert, um Fehler in der ACPI-Implementierung in anderen weit verbreiteten Betriebssystemen zu umgehen. Hardware-Komponenten, die ernsthafte Fehler in der ACPI-Implementierung aufweisen, sind in einer Blacklist festgehalten, die verhindert, dass der Linux-Kernel ACPI für die betreffenden Komponenten verwendet.
   </para>
   <para>
    Der erste Schritt, der bei Problemen unternommen werden sollte, ist die Aktualisierung des BIOS. Wenn der Computer sich nicht booten lässt, kann eventuell einer der folgenden Bootparameter Abhilfe schaffen:
   </para>
   <variablelist>
    <varlistentry>
     <term>pci=noacpi</term>
     <listitem>
      <para>
       ACPI nicht zum Konfigurieren der PCI-Geräte verwenden.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>acpi=ht</term>
     <listitem>
      <para>
       Nur eine einfache Ressourcenkonfiguration durchführen. ACPI nicht für andere Zwecke verwenden.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>acpi=off</term>
     <listitem>
      <para>
       ACPI deaktivieren.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <warning>
    <title>Probleme beim Booten ohne ACPI</title>
    <para>
     Einige neuere Computer (insbesondere SMP- und AMD64-Systeme) benötigen ACPI zur korrekten Konfiguration der Hardware. Bei diesen Computern kann die Deaktivierung von ACPI zu Problemen führen.
    </para>
   </warning>
   <para>
    Manchmal ist der Computer durch Hardware gestört, die über USB oder FireWire angeschlossen ist. Wenn ein Computer nicht hochfährt, stecken Sie nicht benötigte Hardware aus und versuchen Sie es erneut.
   </para>
   <para>
    Überwachen Sie nach dem Booten die Bootmeldungen des Systems mit dem Befehl <command>dmesg -T </command> <option>| grep -2i acpi</option> (oder überwachen Sie alle Meldungen, da das Problem möglicherweise nicht durch ACPI verursacht wurde). Wenn bei der Analyse einer ACPI-Tabelle ein Fehler auftritt, kann die wichtigste Tabelle – die DSDT (<emphasis>Differentiated System Description Table</emphasis>) – durch eine verbesserte Version ersetzt werden. In diesem Fall wird die fehlerhafte DSDT des BIOS ignoriert. Das Verfahren wird in <xref linkend="sec-power-mgmt-faq"/> erläutert.
   </para>
   <para>
    In der Kernel-Konfiguration gibt es einen Schalter zur Aktivierung der ACPI-Fehlersuchmeldungen. Wenn ein Kernel mit ACPI-Fehlersuche kompiliert und installiert ist, werden detaillierte Informationen angezeigt.
   </para>
   <para>
    Wenn Sie Probleme mit dem BIOS oder der Hardware feststellen, sollten Sie stets Kontakt mit den betreffenden Herstellern aufweisen. Insbesondere Hersteller, die nicht immer Hilfe für Linux anbieten, sollten mit den Problemen konfrontiert werden. Die Hersteller nehmen das Problem nur dann ernst, wenn sie feststellen, dass eine nennenswerte Zahl ihrer Kunden Linux verwendet.
   </para>
   <sect3 xml:id="sec-power-mgmt-acpi-trouble-info">
    <title>Weitere Informationen</title>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       <link xlink:href="https://tldp.org/HOWTO/ACPI-HOWTO/"/> (detailliertes ACPI HOWTO, enthält DSDT-Patches)
      </para>
     </listitem>
     <listitem>
      <para>
       <link xlink:href="https://uefi.org/specifications"/> (technische Daten zur Advanced Configuration &amp; Power Interface)
      </para>
     </listitem>
    </itemizedlist>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-power-mgmt-silenthd">
  <title>Ruhezustand für Festplatte</title>

  <para>
   In Linux kann die Festplatte vollständig ausgeschaltet werden, wenn sie nicht benötigt wird, oder sie kann in einem energiesparenderen oder ruhigeren Modus betrieben werden. Bei modernen Notebooks müssen die Festplatten nicht manuell ausgeschaltet werden, da sie automatisch in einen Sparbetriebsmodus geschaltet werden, wenn sie nicht benötigt werden. Um die Energieeinsparungen zu maximieren, sollten Sie jedoch einige der folgenden Verfahren mit dem Kommando <command>hdparm</command> ausprobieren.
  </para>

  <para>
   Hiermit können verschiedene Festplatteneinstellungen bearbeitet werden. Die Option <option>-y</option> schaltet die Festplatte sofort in den Stand-by-Modus. <option>-Y</option> versetzt sie in den Ruhezustand. <command>hdparm</command>
   <option>-S</option> <replaceable>X</replaceable> führt dazu, dass die Festplatte nach einem bestimmten Inaktivitätszeitraum abgeschaltet wird. Ersetzen Sie <replaceable>X</replaceable> wie folgt: <literal>0</literal> deaktiviert diesen Mechanismus, sodass die Festplatte kontinuierlich ausgeführt wird. Werte von <literal>1</literal> bis <literal>240</literal> werden mit 5 Sekunden multipliziert. Werte von <literal>241</literal> bis <literal>251</literal> entsprechen 1- bis 11-mal 30 Minuten.
  </para>

  <para>
   Die internen Energiesparoptionen der Festplatte lassen sich über die Option <literal>-B</literal> steuern. Wählen Sie einen Wert <literal>0</literal> (maximale Energieeinsparung) bis <literal>255</literal> (maximaler Durchsatz). Das Ergebnis hängt von der verwendeten Festplatte ab und ist schwer einzuschätzen. Die Geräuschentwicklung einer Festplatte können Sie mit der Option <literal>-M</literal> reduzieren. Wählen Sie einen Wert von <literal>128</literal> (ruhig) bis <literal>254</literal> (schnell).
  </para>

  <para>
   Häufig ist es nicht so einfach, die Festplatte in den Ruhezustand zu versetzen. Bei Linux führen zahlreiche Prozesse Schreibvorgänge auf der Festplatte durch, wodurch diese wiederholt aus dem Ruhezustand reaktiviert wird. Daher sollten Sie unbedingt verstehen, wie Linux mit Daten umgeht, die auf die Festplatte geschrieben werden müssen. Zunächst werden alle Daten im RAM-Puffer gespeichert. Dieser Puffer wird vom <systemitem class="daemon">pdflush</systemitem>-Daemon überwacht. Wenn die Daten ein bestimmtes Alter erreichen oder wenn der Puffer bis zu einem bestimmten Grad gefüllt ist, wird der Pufferinhalt auf die Festplatte übertragen. Die Puffergröße ist dynamisch und hängt von der Größe des Arbeitsspeichers und von der Systemlast ab. Standardmäßig werden für pdflush kurze Intervalle festgelegt, um maximale Datenintegrität zu erreichen. Das Programm überprüft den Puffer alle fünf Sekunden und schreibt die Daten auf die Festplatte. Die folgenden Variablen sind interessant:
  </para>

  <variablelist>
   <varlistentry>
    <term><filename>/proc/sys/vm/dirty_writeback_centisecs</filename>
    </term>
    <listitem>
     <para>
      Enthält die Verzögerung bis zur Reaktivierung eines pdflush-Threads (in Hundertstelsekunden).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>/proc/sys/vm/dirty_expire_centisecs</filename>
    </term>
    <listitem>
     <para>
      Definiert, nach welchem Zeitabschnitt eine schlechte Seite spätestens geschrieben werden sollte. Der Standardwert ist <literal>3000</literal>, was 30 Sekunden bedeutet.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>/proc/sys/vm/dirty_background_ratio</filename>
    </term>
    <listitem>
     <para>
      Maximaler Prozentsatz an schlechten Seiten, bis pdflush damit beginnt, sie zu schreiben. Die Standardeinstellung ist <literal>5</literal> %. 
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>/proc/sys/vm/dirty_ratio</filename>
    </term>
    <listitem>
     <para>
      Wenn die schlechten Seiten diesen Prozentsatz des gesamten Arbeitsspeichers überschreiten, werden Prozesse gezwungen, während ihres Zeitabschnitts Puffer mit schlechten Seiten anstelle von weiteren Daten zu schreiben.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <warning>
   <title>Datenintegritätsrisiko</title>
   <para>
    Änderungen an den Einstellungen für den <systemitem class="daemon">pdflush</systemitem>-Aktualisierungs-Daemon können die Datenintegrität beeinträchtigen.
   </para>
  </warning>

  <para>
   Abgesehen von diesen Prozessen schreiben protokollierende Journaling-Dateisysteme wie <systemitem class="filesystem">Btrfs</systemitem>, <systemitem class="filesystem">Ext3</systemitem>, <systemitem class="filesystem">Ext4</systemitem> und andere ihre Metadaten unabhängig von <systemitem class="daemon">pdflush</systemitem>, was ebenfalls das Abschalten der Festplatte verhindert. <phrase os="sled;osuse">Um dies zu vermeiden, wurde eine spezielle Kernel-Erweiterung für mobile Geräte entwickelt. Installieren Sie das <systemitem class="resource">laptop-mode-tools</systemitem>-Paket und beachten Sie die Angaben in der Datei <filename>/usr/src/linux/Documentation/laptops/laptop-mode.txt</filename>.</phrase>
  </para>

  <para>
   Ein weiterer wichtiger Faktor ist die Art und Weise, wie sich die Programme verhalten. Gute Editoren beispielsweise schreiben regelmäßig verborgene Sicherungskopien der aktuell bearbeiteten Datei auf die Festplatte, wodurch die Festplatte wieder aktiviert wird. Derartige Funktionen können auf Kosten der Datenintegrität deaktiviert werden.
  </para>

  <para>
   In dieser Verbindung verwendet der Mail-Daemon postfix die Variable <systemitem>POSTFIX_LAPTOP</systemitem>. Wenn diese Variable auf <literal>ja</literal> gesetzt wird, greift postfix wesentlich seltener auf die Festplatte zu.
  </para>

  <para os="sled;osuse">

   In <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> werden diese Technologien von <systemitem>laptop-mode-tools</systemitem> gesteuert.
  </para>
 </sect1>
 <sect1 xml:id="sec-power-mgmt-faq">
  <title>Fehlersuche</title>

  <para>
   Alle Fehler- und Alarmmeldungen werden im Systemjournal gespeichert, das Sie mit dem Kommando <command>journalctl</command> abrufen können (weitere Informationen siehe <xref linkend="cha-journalctl"/>). In den folgenden Abschnitten werden die häufigsten Probleme behandelt.
  </para>

  <sect2 xml:id="sec-power-mgmt-faq-cpufreq">
   <title>CPU-Frequenzsteuerung funktioniert nicht</title>
   <para>
    Rufen Sie die Kernel-Quellen auf, um festzustellen, ob der verwendete Prozessor unterstützt wird. Möglicherweise ist ein spezielles Kernel-Modul bzw. eine Moduloption erforderlich, um die CPU-Frequenzsteuerung zu aktivieren. Wenn das <systemitem class="resource">kernel-source</systemitem>-Paket installiert ist, finden Sie diese Informationen unter <filename>/usr/src/linux/Documentation/cpu-freq/*</filename>.
   </para>
  </sect2>
 </sect1>
</chapter>
