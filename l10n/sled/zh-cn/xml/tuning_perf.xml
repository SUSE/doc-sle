<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="tuning_perf.xml" version="5.0" xml:id="cha-perf">
 <title>使用 Perf 进行基于硬件的性能监视</title>
 <info>
  <abstract>
   <para>
    Perf 是一个用于访问处理器性能监视单元 (PMU) 以及记录和显示软件事件（例如页错误）的界面。它支持系统范围的监视、按线程的监视和 KVM 虚拟化 Guest 监视。
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <para>
  可以在报告中存储生成的信息。例如，此报告包含有关指令指针的信息，或线程执行的代码的信息。
 </para>
 <para>
  Perf 由两部分组成：
 </para>
 <itemizedlist>
  <listitem>
   <para>
    集成到 Linux 内核的代码，负责向硬件发出指令。
   </para>
  </listitem>
  <listitem>
   <para>
    <command>perf</command> 用户空间实用程序，可让您使用内核代码并帮助您分析收集的数据。
   </para>
  </listitem>
 </itemizedlist>
 <remark>
  TODO: An infographic would be a nice touch. We have event sources for perf here:
  http://www.brendangregg.com/perf_events/perf_events_map.png
  Not exactly sure that that is what we want. - sknorr, 2015-10-16
 </remark>

 <sect1 xml:id="sec-perf-concept">
  <title>基于硬件的监视</title>

  <para>
   进行性能监视意味着需要收集有关应用程序或系统执行情况的信息。可以通过基于软件的方式或者从 CPU 或芯片组获取这些信息。Perf 集成了这两种方式。
  </para>
  <para>
   许多新式处理器都包含性能监视单元 (PMU)。PMU 的设计和功能与特定的 CPU 相关。例如，寄存器数量、支持的计数器和功能根据 CPU 实施方式而异。
  </para>
  <para>
   每个 PMU 模型包含一组寄存器：性能监视配置 (PMC) 和性能监视数据 (PMD)。这两个寄存器都是可读的，但只有 PMC 是可写的。这些寄存器用于存储配置信息和数据。
  </para>
 </sect1>

 <sect1 xml:id="sec-perf-sample-count">
  <title>采样和计数</title>
  <para>
   Perf 支持多种分析模式：
  </para>
  <itemizedlist>
   <listitem>
    <formalpara>
     <title>计数</title>
     <para>
      统计某个事件的发生次数。
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>基于事件的采样</title>
     <para>
      一种不太确切的计数方式：每当发生的事件数达到特定的阈值时，就会记录一个样本。
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>基于时间的采样</title>
     <para>
      一种不太确切的计数方式：按定义的频率记录样本。
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     
     <title>基于指令的采样（仅限 AMD64）</title>
     <para>
      处理器跟踪按给定时间间隔出现的指令，并对这些指令生成的事件采样。这样便可以跟踪各个指令，并查看哪些是对性能至关重要的指令。
     </para>
    </formalpara>
   </listitem>
  </itemizedlist>
 </sect1>

 <sect1 xml:id="sec-perf-install">
  <title>安装 Perf</title>

  <para>
   Perf 内核代码已包含在默认内核中。要使用用户空间实用程序，请安装软件包 <package>perf</package>.
  </para>
  
 </sect1>

 <sect1 xml:id="sec-perf-subcommand">
  <title>Perf 子命令</title>

  <para>
   为了收集必要信息，<command>perf</command> 工具中包含多个子命令。本节概述了最常用的命令。
  </para>
  <para>
   要以手册页的形式查看任一子命令的帮助，请使用 <command>perf help</command><replaceable>SUBCOMMAND</replaceable> 或 <command>man perf-</command><replaceable>SUBCOMMAND</replaceable>。
  </para>

  <variablelist>
   <varlistentry>
    <term><command>perf stat</command></term>
    <listitem>
     <para>
      启动一个程序，并创建该程序退出后显示的统计概述。<command>perf stat</command> 用于事件计数。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>perf record</command></term>
    <listitem>
     <para>
      启动一个程序，并创建包含性能计数器信息的报告。该报告作为 <filename>perf.data</filename> 存储在当前目录中。<command>perf record</command> 用于事件采样。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>perf report</command></term>
    <listitem>
     <para>
      显示先前使用 <command>perf record</command> 创建的报告。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>perf annotate</command></term>
    <listitem>
     <para>
      显示报告文件以及已执行代码的批注版本。如果安装了调试符号，则还会显示源代码。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>perf list</command></term>
    <listitem>
     <para>
      列出 Perf 可以使用当前内核和您的 CPU 报告的事件类型。可按类别过滤事件类型 — 例如，要仅查看硬件事件，请使用 <command>perf list hw</command>。
     </para>
     <para>
      <command>perf_event_open</command> 的手册页提供了最重要事件的简短说明。例如，要查找 <systemitem>branch-misses</systemitem> 事件的说明，请搜索 <literal>BRANCH_MISSES</literal>（请注意拼写差异）：
     </para>
<screen><prompt>&gt; </prompt><command>man</command> perf_event_open | <command>grep</command> -A5 <replaceable>BRANCH_MISSES</replaceable></screen>
     <para>
      事件有时可能模糊不清。请注意，小写的硬件事件名称并非原始硬件事件的名称，而是 Perf 创建的别名的名称。这些别名对应于每个受支持处理器上名称不同但定义类似的硬件事件。
     </para>
     <para>
      例如，在 Intel 处理器上，<systemitem>cpu-cycles</systemitem> 事件对应于硬件事件 <systemitem>UNHALTED_CORE_CYCLES</systemitem>。而在 AMD 处理器上，则对应于硬件事件 <systemitem>CPU_CLK_UNHALTED</systemitem>。
     </para>
     <para>
      Perf 还允许测量特定于硬件的原始事件。要查找这些事件的说明，请查看 CPU 供应商的《Architecture Software Developer&apos;s Manual》（体系结构软件开发人员手册）。<xref linkend="sec-perf-more"/>中提供了 AMD64/Intel 64 处理器的相关文档链接。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>perf top</command></term>
    <listitem>
     <para>
      显示发生的系统活动。
     </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>perf trace</command></term>
     <listitem>
      <para>
      此命令的行为与 <command>strace</command> 类似。使用此子命令可以查看特定的线程或进程执行了哪些系统调用，以及该线程或进程收到了哪些信号。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>

 <sect1 xml:id="sec-perf-event">
  <title>统计特定类型的事件</title>
  <para>
   要统计某个事件（例如 <command>perf list</command> 显示的事件）的发生次数，请使用：
  </para>
<screen><prompt role="root"># </prompt><command>perf</command> stat -e <replaceable>EVENT</replaceable> -a</screen>
  <para>
   要一次性统计多种类型的事件，请列出这些事件并以逗号分隔。例如，要统计 <systemitem>cpu-cycles</systemitem> 和 <systemitem>instructions</systemitem>，请使用：
  </para>
<screen><prompt role="root"># </prompt><command>perf</command> stat -e cpu-cycles,instructions -a</screen>
  <para>
   要停止会话，请按 <keycombo><keycap function="control"/><keycap>C</keycap></keycombo>。
  </para>
  <remark>
    Input from Tony Jones: "perhaps cover case where #events &gt; #pmus so kernel
    time slices (i.e [xx.yy%] in output)" - sknorr, 2015-10-30
  </remark>
  <para>
   还可以统计某个事件在特定时间范围内发生的次数：
  </para>
<screen><prompt role="root"># </prompt><command>perf</command> stat -e <replaceable>EVENT</replaceable> -a -- sleep <replaceable>TIME</replaceable></screen>
  <para>
   请将 <replaceable>TIME</replaceable> 替换为以秒为单位的值。
  </para>
 </sect1>

 <sect1 xml:id="sec-perf-command">
  <title>记录特定于特定命令的事件</title>
  <para>
   可通过各种方式来对特定于特定命令的事件采样：
  </para>
  <itemizedlist>
   <listitem>
     <para>
      要创建新调用的命令的报告，请使用：
     </para>
<screen><prompt role="root"># </prompt><command>perf</command> record <replaceable>COMMAND</replaceable></screen>
     <para>
      然后正常使用启动的进程。退出该进程时，Perf 会话也会停止。
     </para>
   </listitem>
   <listitem>
     <para>
      要在运行新调用的命令时创建整个系统的报告，请使用：
     </para>
<screen><prompt role="root"># </prompt><command>perf</command> record -a <replaceable>COMMAND</replaceable></screen>
     <para>
      然后正常使用启动的进程。退出该进程时，Perf 会话也会停止。
     </para>
   </listitem>
   <listitem>
     <para>
      要创建已运行的进程的报告，请使用：
     </para>
<screen><prompt role="root"># </prompt><command>perf</command> record -p <replaceable>PID</replaceable></screen>
     <para>
      请将 <replaceable>PID</replaceable> 替换为进程 ID。要停止会话，请按 <keycombo><keycap function="control"/><keycap>C</keycap></keycombo>。
     </para>
   </listitem>
  </itemizedlist>
  <para>
   现在，可使用以下命令查看收集到的数据 (<filename>perf.data</filename>)：
  </para>
<screen><prompt>&gt; </prompt><command>perf</command> report</screen>
  <para>
   这会打开一个伪图形界面。要获得帮助，请按 <keycap>H</keycap>。要退出，请按 <keycap>Q</keycap>。
  </para>
  <remark>Some more information about interpreting data from this utility might
  be helpful... - sknorr, 2015-10-14</remark>
  <remark>Feedback on this from Mel Gorman: "[D]o not get into this. You could
    write a small book on the subject and still not cover all the details."
    - sknorr, 2015-10-16
  </remark>
  <para>
   如果您偏向于使用图形界面，请尝试 Perf 的 GTK+ 界面：
  </para>
<screen><prompt>&gt; </prompt><command>perf</command> report --gtk</screen>
  <para>
    但请注意，GTK+ 界面的功能很有限。
    <remark>
      It provides a scrollable list and tabs and not much else.
      - sknorr, 2015-10-30
    </remark>
  </para>
 </sect1>

 <sect1 xml:id="sec-perf-more">
  <title>更多信息</title>

  <para>
   本章仅提供了简短概述。有关详细信息，请参考以下链接：
  </para>

  <variablelist>
   <varlistentry>
    <term><link xlink:href="https://perf.wiki.kernel.org/index.php/Main_Page"/>
    </term>
    <listitem>
     <para>
      项目主页。还提供了有关使用 <command>perf</command> 的教程。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><link xlink:href="http://www.brendangregg.com/perf.html"/>
    </term>
    <listitem>
     <para>
      包含许多单行 <command>perf</command> 用法示例的非官方页。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><link xlink:href="http://web.eece.maine.edu/~vweaver/projects/perf_events/"/>
    </term>
    <listitem>
     <para>
      包含多个资源的非官方页，主要与 Perf 的 Linux 内核代码及其 API 相关。例如，此页包含 CPU 兼容性表和编程指南。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><link xlink:href="https://www-ssl.intel.com/content/dam/www/public/us/en/documents/manuals/64-ia-32-architectures-software-developer-vol-3b-part-2-manual.pdf"/>
    </term>
    <listitem>
     <para>
      此 <citetitle>Intel Architectures Software Developer's Manual,
      Volume 3B</citetitle>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><link xlink:href="https://support.amd.com/TechDocs/24593.pdf"/>
    </term>
    <listitem>
     <para>
      此 <citetitle>AMD Architecture Programmer's Manual, Volume 2</citetitle>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><xref linkend="cha-tuning-oprofile"/>
    </term>
    <listitem>
     <para>
      请参阅此章了解其他性能优化。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
</chapter>
