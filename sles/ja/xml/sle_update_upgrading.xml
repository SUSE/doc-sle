<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_upgrading.xml" version="5.0" xml:id="cha.update.sle">
 <title>SUSE Linux Enterpriseのアップグレード</title>
 <info>
  <abstract>
   <para>
    SUSE® Linux Enterprise (SLE)では、既存のシステムを新しいバージョンにアップデートできます。たとえば、SLE 11 SP4をSLE 12にアップデートできます。新たにインストールする必要はありません。ホームディレクトリ、データディレクトリ、システム設定などの既存のデータは、そのまま保持されます。CD/DVDドライブから、またはネットワーク上にある中央のインストールソースからアップデートできます。
   </para>

   <para>
    この章では、DVD、ネットワーク、自動化プロセス、SUSE Managerなどを使用して、SUSE Linux Enterprise システムを手動でアップグレードする方法について説明します。
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <sect1 xml:id="sec.update.sle.paths">
  <title>SLE SP3へのサポートされているアップグレードパス</title>

  <important>
   <title>クロスアーキテクチャアップグレードはサポートされない</title>
   <para>
    クロスアーキテクチャアップグレードは「サポートされません」。<phrase role="productname"><phrase os="sles"/></phrase>たとえば、32ビットバージョンの<emphasis>SUSE Linux Enterprise Server</emphasis>から64ビットバージョンへのアップグレードや、ビッグエンディアンからリトルエンディアンへのアップグレードなどがこれに該当します。
   </para>
   <para>
    具体的には、POWER版のSLE 11(ビッグエンディアン)からPOWER版のSLE 12 SP2(新規: リトルエンディアン)は<emphasis>サポートされません</emphasis>。
   </para>
   <para>
    同様に、SUSE Linux Enterprise 12は、64ビット専用であるため、32ビットのSUSE Linux Enterprise 11システムからSUSE Linux Enterprise 12以降へのアップグレードも<emphasis>サポートされません</emphasis>。
   </para>
   <para>
    クロスアーキテクチャアップグレードを行いたい場合は、新規インストールを実行する必要があります。
   </para>
  </important>

  <para>
   マイグレーションを実行する前に、<xref linkend="sec.update.prep"/>をご覧ください。
  </para>

  <note>
   <title>サービスパックのスキップ</title>
   <para>
    すべてのサービスパックを連続してインストールするのが最も安全なアップグレードパスです。場合によっては、アップグレード時に1～2個のサービスパックをスキップできます。ただし、どのサービスパックも「スキップしない」<emphasis/>ことをお勧めします。 
   </para>
  </note>

  <note>
   <title>メジャーリリースのアップグレード</title>
   <para>
    SUSE Linux Enterprise 11からSUSE Linux Enterprise 12へアップグレードする場合など、新しいメジャーリリースにアップグレードする際は、新規インストールを行うことをお勧めします。
   </para>
  </note>

  <variablelist>
   <varlistentry>
    <term>SUSE Linux Enterprise 10 (任意のサービスパック)からのアップグレード</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 12への直接的なマイグレーションパスはサポートされていません。この場合、新規インストールをお勧めします。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>SUSE Linux Enterprise 11 GA、SP1またはSP2からのアップグレード</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 12への直接的なマイグレーションパスはサポートされていません。SLE 12 SP3に進むには、まずSLE 11 SP4が必要です。
     </para>
     <para>
      新規インストールを行うことができない場合は、まず、インストールされているSLE 11のサービスパックをSLE 11 SP4にアップグレードします。最初のステップについては、『<link xlink:href="https://www.suse.com/documentation/sles11/">SUSE Linux Enterprise 11導入ガイド</link>』で説明されています。
     </para>
     <para>
      次に、<xref linkend="sec.update.sle.methods"/>に進みます。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>SUSE Linux Enterprise 11 SP4からのアップグレード</term>
    <listitem>
     <para>
      SLE 11からSLE 12 SP3へのアップグレードは、オフラインアップグレードでのみサポートされます。詳細については、<xref linkend="sec.update.sle.methods"/>を参照してください。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>SUSE Linux Enterprise 12 GAからSP3へのアップグレード</term>
    <listitem>
     <para>
      SLE 12 GAからSP3へ直接アップグレードすることはできません。まずSLE 12 SP2にアップグレードしてください。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>SUSE Linux Enterprise 12 SP1またはSP2からSP3へのアップグレード</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 12 SP1またはSP2からSP3へのアップグレードはサポートされます。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>SUSE Linux Enterprise 12 LTSS GA SP1またはSP2からSP3へのアップグレード</term>
    <listitem>
     <para>
      古いSLE 12 LTSSバージョンからSP3へのアップデートはサポートされます。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <figure xml:id="fig.update.sle.paths-overview">
   <title>最短のアップグレードパスの概要</title>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="upgrade-paths.svg" width="100%" format="SVG"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="upgrade-paths.png" width="80%" format="PNG"/>
    </imageobject>
   </mediaobject>
  </figure>
 </sect1>
 <sect1 xml:id="sec.update.sle.methods">
  <title>オンラインおよびオフラインでのアップグレード</title>
  <para>
   SUSEは、アップグレードおよびマイグレーションの方法として2つの異なる方法サポートしています。用語の詳細については、<xref linkend="sec.update.sle.terminology"/>を参照してください。次の2つの方法があります。
  </para>

  <variablelist>
   <varlistentry>
    <term>オンライン</term>
    <listitem>
     <para>
      稼働中のシステムから実行するすべてのアップグレードをオンラインとみなします。たとえば、SUSEカスタマーセンター経由で接続したアップグレード、Subscription Management Tool (SMT)でのアップグレード、zypperまたはYaSTを使用したSUSE Managerでのアップグレードなどです。
     </para>
     <para>
      同じメジャーリリースのサービスパック間でマイグレートする場合は、<xref linkend="sec.update.migr.yast.onlinemigr"/>または<xref linkend="sec.update.migr.zypper.onlinemigr"/>に従うことをお勧めします。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>オフライン</term>
    <listitem>
     <para>
      オフラインでの方法では、通常、別のオペレーティングシステムをブートし、そこからインストールされているSLEバージョンをアップグレードします。たとえば、DVD、フラッシュディスク、ISOイメージ、AutoYaST、<quote>プレーンRPM</quote>、PXEブートなどを使用したアップグレードです。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <para>
   SUSE Linux Enterprise 11 SP4からSUSE Linux Enterprise 12 SP3へのアップグレードは、オフラインアップグレードでのみサポートされます。詳細については、<xref linkend="cha.update.offline"/>を参照してください
  </para>

  <para>
   SUSE Linux Enterprise 12の任意のLTSSバージョン、SUSE Linux Enterprise 12 SP1またはSP2からSP3へのアップグレードはすべて、オフラインの方法とオンラインの方法でサポートされます。<xref linkend="cha.update.offline"/>および<xref linkend="cha.update.online"/>を参照してください。
  </para>
 </sect1>
 <sect1 xml:id="sec.update.prep">
  <title>システムの準備</title>
  <para>
   アップグレード手順を開始する前に、システムが正しく準備されていることを確認します。準備内容には、データのバックアップとリリースノートの確認などがあります。
  </para>

  <sect2 xml:id="sec.update.prep.relnotes">
   <title>リリースノートの確認</title>
   <para>
    リリースノートには、旧リリースの<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>からの変更点に関する追加情報が記載されています。リリースノートを参照して以下を確認します。
   </para>
   <itemizedlist>
    <listitem>
     <para>
      使用しているハードウェアに特別な配慮が必要かどうか
     </para>
    </listitem>
    <listitem>
     <para>
      使用しているソフトウェアパッケージに大幅な変更があるかどうか
     </para>
    </listitem>
    <listitem>
     <para>
      インストールのために特別な予防措置が必要かどうか
     </para>
    </listitem>
   </itemizedlist>
   <para>
    リリースノートには、マニュアルに記載できなかった情報が記載されています。また、既知の問題に関する注意も記載されています。
   </para>
   <para>
    サービスパックを1つ以上スキップする場合は、スキップするサービスパックのリリースノートも確認します。通常、リリースノートにはそれに続く2つのリリースの変更しか記載されていません。最新のリリースノートしか読まないと、重要な変更を見落とす可能性があります。
   </para>
   <para>
    リリースノートは、ローカルではディレクトリ<filename>/usr/share/doc/release-notes</filename>に、オンラインでは<link xlink:href="https://www.suse.com/releasenotes/"/>にあります。
   </para>
  </sect2>
  <sect2 xml:id="sec.update.prep.backup">
   <title>バックアップの作成</title>
   <para>
    更新の前に、既存の設定ファイルを別個のメディア(テープデバイス、リムーバブルハードディスクなど)にコピーして、データをバックアップします。主に、<filename>/etc</filename>に保存されているファイル、および<filename>/var</filename>と<filename>/opt</filename>のディレクトリとファイルの一部に当てはまります。さらに、<filename>/home</filename> (<envar>HOME</envar>ディレクトリ)下のユーザデータをバックアップメディアに書き込むようにします。このデータは、<systemitem class="username">root</systemitem>ユーザでバックアップします。<systemitem class="username">root</systemitem>のみに、すべてのローカルファイルに関する読み込みパーミッションがあります。
   </para>
   <para>
    YaSTのインストールモードとして<guimenu>既存システムの更新</guimenu>を選択している場合は、もっと後の時点で(システム)バックアップを実行することができます。変更されたすべてのファイルと<filename>/etc/sysconfig</filename>ディレクトリにあるファイルを含めることができます。ただし、これは完全なバックアップではありません。前述したその他の重要なディレクトリがすべて含まれていないからです。<filename>/var/adm/backup</filename>ディレクトリでバックアップを見つけます。
   </para>
   <sect3 xml:id="sec.update.prep.backup.packagelist">
    <title>インストール済みパッケージとリポジトリの一覧</title>
    <para>
     インストール済みパッケージのリストを用意しておくと、いろいろな場面で役立ちます。たとえば、新しいメジャーSLEリリースを新規インストールする場合や、旧バージョンに戻す場合などです。
    </para>
    <para>
     インストール済みパッケージまたは使用中のリポジトリの中にはSUSE Linux Enterpriseの最新リリースで利用できないものもあることに注意してください。名前が変更されていたり、ほかのパッケージやリリースに置き換えられていたりすることもあります。また、レガシ目的で引き続き提供されていても、デフォルトでは別のパッケージが使用されるパッケージもあります。したがって、ファイルを多少手動で編集しなければならない場合があります。これはテキストエディタで実行できます。
    </para>
    <para>
     使用中のすべてのリポジトリのリストを記述した<filename>repositories.bak</filename>という名前のファイルを作成します。
    </para>
    <screen><prompt role="root">root # </prompt><command>zypper</command> lr -e repositories.bak</screen>
    <para>
     さらに、すべてのインストール済みパッケージのリストを記述した<filename>installed-software.bak</filename>という名前のファイルも作成します。
    </para>
    <screen><prompt role="root">root # </prompt><command>rpm</command> -qa --queryformat '%{NAME}\n' &gt; installed-software.bak</screen>
    <para>
     両方のファイルをバックアップします。これらのリポジトリとインストール済みパッケージは、次のコマンドで復元できます。
    </para>
    <screen><prompt role="root">root # </prompt><command>zypper</command> ar repositories.bak
<prompt role="root">root # </prompt><command>zypper</command> install $(cat installed-software.bak)</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="sec.update.prep.mariadb">
   <title>MySQLデータベースの移行</title>
   <remark>toms 2015-09-03: already reviewed by Ondrej and Kristýna.</remark>
   <para>
    SUSE Linux Enterprise 12では、SUSEは、MySQLからMariaDBに切り替えました。アップグレードを開始する前に、データベースのバックアップを取得することを強くお勧めします。
   </para>

   <para>
    データベースマイグレーションを実行するには、次の手順を実行します。
   </para>
   <procedure>
    <step>
     <para>
      ご使用のSUSE Linux Enterprise 11マシンにログインします。
     </para>
    </step>
    <step>
     <para>
      ダンプファイルを作成します。
     </para>
<screen><prompt role="root">root # </prompt><command>mysqldump</command> -u root -p --all-databases &gt; mysql_backup.sql</screen>
     <para>
      デフォルトでは、<command>mysqldump</command>は、<literal>INFORMATION_SCHEMA</literal>、または<literal>performance_schema</literal>データベースをダンプしません。詳細については、<link xlink:href="https://dev.mysql.com/doc/refman/5.5/en/mysqldump.html"/>を参照してください。
     </para>
    </step>
    <step>
     <para>
      ダンプファイル、環境設定ファイル、<filename>/etc/my.cnf</filename>、およびディレクトリ、<filename>/etc/mysql/</filename>を後で調べることができるように<emphasis>(インストールのためではありません)</emphasis>安全な場所に保存します。
     </para>
    </step>
    <step>
     <para>
      アップグレードを実施します。アップグレードが終わっても、前の環境設定ファイル、<filename>/etc/my.cnf</filename>は前のままです。新しい設定は、<filename>/etc/my.cnf.rpmnew</filename>ファイルで確認できます。
     </para>
    </step>
    <step>
     <para>
      必要に応じて、MariaDBデータベースを設定します。以前の設定ファイルとディレクトリを<emphasis>使わないでください</emphasis>。これらは、リマインダとして使用し、活用するだけです。
     </para>
    </step>
    <step>
     <para>
      MariaDBサーバを起動して確認してください。
     </para>
<screen><prompt role="root">root # </prompt><command>systemctl</command> start mysql</screen>
     <para>
      ブートのたびにMariaDBサーバを起動する場合は、そのサービスを有効にします。
     </para>
<screen><prompt role="root">root # </prompt><command>systemctl</command> enable mysql</screen>

    </step>
    <step>
     <para>
      MariaDBが適切に稼働していることを、データベースに接続して確認します。
     </para>
<screen><prompt role="root">root # </prompt><command>mysql</command> -u root -p</screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.update.prep.postgresql">
   <title>PostgreSQLデータベースの移行</title>
   <remark>toms 2015-09-09: FATE#319049</remark>
   <remark>Already reviewd by Reinhard</remark>
   <para>
    SLE11 SP3およびSLE12 GAでは、保守アップデートで、PostgreSQLデータベースのバージョンが新しくなっています。データベースのマイグレーション作業が必要であることから、自動アップグレードプロセスはありません。そのため、あるバージョンから別のバージョンへの切り替えは、手動で行わなければなりません。
   </para>
   <para>
    マイグレーションプロセスは、<command>pg_upgrade</command>コマンドで行います。このコマンドは、従来のdumpとreloadコマンドに代わる方式です。<quote>dump とreload</quote>方式と比べると、<command>pg_upgrade</command>の場合、マイグレーションの時間が短縮されます。
   </para>
   <para>
    PostgreSQLのバージョンによって、それぞれ異なるディレクトリにファイルが保存されています。アップデート後、ディレクトリは次のように変わります。
   </para>
   <variablelist>
    <varlistentry>
     <term>SLE11 SP3/SP4</term>
     <listitem>
      <para>
       <filename>/usr/lib/postgresql91/</filename>から<filename>/usr/lib/postgresql94/</filename>
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>SLE12 GA</term>
     <listitem>
      <para>
       <filename>/usr/lib/postgresql93/</filename>から<filename>/usr/lib/postgresql94/</filename>
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <para>
    データベースマイグレーションを実行するには、次の手順を実行します。
   </para>
   <procedure>
    <step>
     <para>
      以下の前提条件が満たされていることを確認します。
     </para>
     <itemizedlist>
      <listitem>
       <para>
        満たされていない場合、保守アップデートで、古いPostgreSQLバージョンを最新リリースにアップグレードします。
       </para>
      </listitem>
      <listitem>
       <para>
        既存のデータベースのバックアップを作成します。
       </para>
      </listitem>
      <listitem>
       <para>
        新規のPostgreSQLのメジャーバージョンのパッケージをインストールします。SLE12の場合、
        <package>postgresql94-server</package>
        およびそれが依存するすべてのパッケージのインストールを意味します。
       </para>
      </listitem>
      <listitem>
       <para>
        パッケージ
        <package>postgresql94-contrib</package>
        をインストールします。これには、<command>pg_upgrade</command>コマンドが含まれています。
       </para>
      </listitem>
      <listitem>
       <para>
        ご使用のPostgreSQLデータ領域(デフォルトでは<filename>/var/lib/pgsql/data</filename>)に十分な空き容量があることを確認します。容量が厳しい場合、次のSQLコマンドをデータベースごとに実行して、サイズを縮小します(長時間要する場合があります)。
       </para>
<screen>VACUUM FULL</screen>
      </listitem>
     </itemizedlist>
    </step>
    <step>
     <para>
      PostgreSQLサーバを停止します。
     </para>
<screen><prompt role="root">root # </prompt><command>/usr/sbin/rcpostgresql</command> stop</screen>
    </step>
    <step>
     <para>
      古いデータディレクトリの名前を変更します。
     </para>
<screen><prompt role="root">root # </prompt><command>mv</command> /var/lib/pgsql/data /var/lib/pgsql/data.old</screen>
    </step>
    <step>
     <para>
      新規のデータディレクトリを作成します。
     </para>
<screen><prompt role="root">root # </prompt><command>mkdir</command> -p /var/lib/pgsql/data</screen>
    </step>
    <step>
     <para>
      旧バージョンで設定ファイルを変更していた場合、<filename>postgresql.conf</filename>
      <filename>ファイルとpg_hba.conf</filename>ファイルを新規の<filename>データ</filename>ディレクトリにコピーします。
     </para>
<screen><prompt role="root">root # </prompt><command>cp</command> /var/lib/pgsql/data.old/*.conf \
     /var/lib/pgsql/data</screen>
    </step>
    <step>
     <para>
      新規のデータベースインスタンスを初期化します。<command>initdb</command>を使用して手動で実行するか、PostgreSQLを起動、停止することで自動的に実行します。
     </para>
<screen><prompt role="root">root # </prompt><command>/usr/sbin/rcpostgresql</command> start
<prompt role="root">root # </prompt><command>/usr/sbin/rcpostgresql</command> stop</screen>
    </step>
    <step>
     <para>
      マイグレーションプロセスを開始し、<replaceable>OLD</replaceable>プレースホルダを古いバージョンに置き換えます。
     </para>
<screen><prompt role="root">root # </prompt><command>pg_upgrade</command> \
   --old-datadir "/var/lib/pgsql/data.old" \
   --new-datadir "/var/lib/pgsql/data" \
   --old-bindir "/usr/lib/postgresql<replaceable>OLD</replaceable>/bin/" \
   --new-bindir "/usr/lib/postgresql94/bin/"</screen>
    </step>
    <step>
     <para>
      新規の データベースインスタンスを起動します。
     </para>
<screen><prompt role="root">root # </prompt><command>/usr/sbin/rcpostgresql</command> start</screen>
    </step>
    <step>
     <para>
      マイグレーションが成功したかどうか確認します。この手順を自動化する一般的なツールはありません。テストする量と内容は、ユーザの使用状況によって異なります。
     </para>
    </step>
    <step>
     <para>
      すべての古いPostgreSQLパッケージと古いデータディレクトリを削除します。
     </para>
<screen><prompt role="root">root # </prompt><command>zypper</command> search -s postgresql<replaceable>OLD</replaceable> | xargs zypper rm -u
<prompt role="root">root # </prompt><command>rm</command> -rf /var/lib/pgsql/data.old</screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.update.prep.ssl">
   <title>JavaアプリケーションのMD5以外のサーバ証明書を作成します。</title>
   <remark>toms 2016-07-27: from bsc#970153, c#24</remark>
   <para>
    SP1からSP2に更新するときに、MD5ベースの証明書はセキュリティ修正の一環として無効にされました。MD5として作成された証明書を持っている場合、次の手順で証明書を再作成してください。
   </para>

   <procedure>
    <step>
     <para>
      端末を開いて、<systemitem class="username">root</systemitem>としてログインします。
     </para>
    </step>
    <step>
     <para>
      秘密鍵を作成します。
     </para>
     <screen><prompt role="root">root # </prompt><command>openssl</command> genrsa -out server.key 1024</screen>
     <para>
      より強力な鍵が必要な場合、<literal>1024</literal>を<literal>4096</literal>などの大きい数に置き換えます。
     </para>
    </step>
    <step>
     <para>
      証明書署名要求(CSR)を作成します。
     </para>
     <screen><prompt role="root">root # </prompt><command>openssl</command> req -new -key server.key -out server.csr</screen>
    </step>
    <step>
     <para>
      証明書を自己署名します。
     </para>
     <screen><prompt role="root">root # </prompt><command>openssl</command> x509 -req -days 365 -in server.csr -signkey server.key -out server.crt</screen>
    </step>
    <step>
     <para>
      PEMファイルを作成します。
     </para>
     <screen><prompt role="root">root # </prompt><command>cat</command> server.key server.crt &gt; server.pem</screen>
    </step>
    <step>
     <para>ファイル<filename>server.crt</filename>、<filename>server.csr</filename>、<filename>server.key</filename>、および<filename>server.pem</filename>を鍵が見つかったそれぞれのディレクトリに配置します。たとえばTomcatの場合、このディレクトリは<filename>/etc/tomcat/ssl/</filename>です。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.update.prep.vms">
   <title>仮想マシンゲストのシャットダウン</title>
   <para>
    お使いのマシンがKVMまたはXenのVMホストサーバとして機能している場合、アップデートの前には、実行中のすべてのVMゲストを正しくシャットダウンするようにします。そうでないと、更新後にゲストにアクセスできなくなる可能性があります。
   </para>
  </sect2>

  <sect2 xml:id="sec.update.prep.smt">
   <title>SMTクライアントで<command>clientSetup4SMT.sh</command>スクリプトを確認します。</title>
   <para>
    SMTサーバに対して登録されているクライアントOSをマイグレーションしている場合、ホストにある<command>clientSetup4SMT.sh</command>スクリプトのバージョンが最新かどうかを確認する必要があります。古いバージョンのSMTの<command>clientSetup4SMT.sh</command>はSMT 12クライアントを管理できません。SMTサーバにソフトウェアパッチを定期的に適用している場合、常に最新バージョンの<command>clientSetup4SMT.sh</command>を<filename>&lt;SMT_HOSTNAME&gt;/repo/tools/clientSetup4SMT.sh</filename>で見つけることができます。
   </para>
  </sect2>

  <sect2 xml:id="sec.update.disk">
   <title>ディスク容量</title>

   <para>
    ソフトウェアは、バージョンが上がるたびに増加する傾向があります。そのため、更新する前に、使用可能名パーティションの容量を調べてください。ディスク容量が不足する可能性がある場合は、データをバックアップしてから、パーティションのサイズを変更するなどして、使用可能な容量を増やしてください。各パーティションに必要な容量を決定する一般的なルールはありません。必要な容量は、特定のパーティションプロファイルおよび選択したソフトウェアによって異なります。
   </para>

   <note>
    <title>YaSTでの十分な容量の自動確認</title>
    <para>
     更新手順の実行中に、YaSTは空きディスク容量を確認し、インストールで使用可能な容量を超える可能性がある場合は、ユーザに警告を表示します。その場合、更新を実行すると、「システムが使用できなくなる」<emphasis/>ことがあります。操作の内容を(事前のテストによって)確実に把握している場合にのみ、この警告をスキップして更新を続行できます。
    </para>
   </note>

   <sect3 xml:id="sec.update.disk.space">
    <title>Btrfs以外のファイルシステムにおける空きディスク容量の確認</title>
    <para>
     <command>df</command>コマンドを使用して、使用可能なディスク容量を表示できます。たとえば、<xref linkend="aus.update.df"/>では、ルートパーティションは<filename>/dev/hda3</filename>です(<filename>/</filename>としてマウントされています)。
    </para>
    <example xml:id="aus.update.df">
     <title><command>df -h</command>の出力例</title>

<screen os="sles">Filesystem     Size  Used Avail Use% Mounted on
/dev/sda3       74G   22G   53G  29% /
tmpfs          506M     0  506M   0% /dev/shm
/dev/sda5      116G  5.8G  111G   5% /home
/dev/sda1       44G    4G   40G   9% /data</screen>
    </example>
   </sect3>

   <sect3 xml:id="sec.update.disk.btrfs-on-root">
    <title>Btrfsファイルシステムの空きディスク容量の確認</title>
    <para>
     マシンでBtrfsをルートファイルシステムとして使用している場合、十分な空き容量があることを確認します。多くの場合、アップグレードには、新しいスナップショット用に、現在のルートファイルシステムと同じディスク容量が必要になります(<filename>/.snapshot</filename>がない場合)。使用可能なディスク容量を表示するには、次のコマンドを使用します。
    </para>
<screen><prompt role="root">root # </prompt><command>df</command> -h /</screen>
    <para>
     ほかのすべてのマウント済みパーティションでも、使用可能な容量を確認します。効果が実証されている推奨事項は次のとおりです。
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Btrfsを含めてすべてのファイルシステムで、大きなRPMをダウンロードし、インストールできるだけの空きディスク容量が必要です。古いRPMが使用している容量は、新しいRPMのインストール後にのみ解放されます。
      </para>
     </listitem>
     <listitem>
      <para>
       スナップショットがあるBtrfsの場合、現在のインストールで使用している容量と同じだけの空き容量が最低でも必要です。現在のインストール環境の2倍の空き容量を確保することを推奨します。
      </para>
      <para>
       十分な空き容量がない場合、<command>snapper</command>を使用して古いスナップショットを削除することができます。
      </para>
<screen><prompt role="root">root # </prompt><command>snapper</command> list
<prompt role="root">root # </prompt><command>snapper</command> delete NUMBER</screen>
      <para>
       しかし、すべてのケースでこの方法が役立つとは限りません。マイグレーションの前には、大半のスナップショットが占めている容量はごくわずかです。
      </para>
     </listitem>
    </itemizedlist>
   </sect3>
  </sect2>
  <sect2 xml:id="sec.update.prep.multiversion">
   <title>カーネルのマルチバージョンサポートの一時的な無効化</title>
   <para>
    <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>では、<filename>/etc/zypp/zypp.conf</filename>の各設定を有効にすることで、複数のカーネルバージョンをインストールできます。特定のサービスパックにアップグレードする場合、この機能のサポートを一時的に無効化する必要があります。更新が正常に完了したら、マルチバージョンサポートを再び有効にできます。マルチバージョンサポートを無効にするには、<filename>/etc/zypp/zypp.conf</filename>の各行をコメント化します。結果は次のようになります。
   </para>
<screen>#multiversion = provides:multiversion(kernel)
#multiversion.kernels = latest,running</screen>
   <para>
    更新が正常に完了した後にこの機能を再アクティブ化するには、コメント記号を削除します。マルチバージョンサポートの詳細については、<xref linkend="cha.tuning.multikernel.enable"/>を参照してください。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.update.sle.sle12zseries" os="sles">
  <title>IBM z Systemsでのアップグレード</title>
  <para>z SystemsにインストールされたSUSE Linux Enterpriseをアップグレードするには、parmfileなどでカーネルパラメータ<command>Upgrade=1</command>を使用する必要があります。詳細については、<xref linkend="sec.appdendix.parm" xrefstyle="HeadingOnPage"/>を参照してください。
  </para>
 </sect1>
 <sect1 xml:id="sec.update.prep.ppc_x" os="sles" arch="power">
  <title>IBM POWER: Xサーバの起動</title>
  <para>
   SLES 12 for IBM POWERでは、ディスプレイマネージャがローカルのXサーバを起動しないように、デフォルトで設定されています。SLES 12 SP1ではこの設定は逆になっています。今は、ディスプレイマネージャはXサーバを起動します。
  </para>
  <para>
   アップグレード時に問題が発生するのを避けるため、<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>の設定は自動的には変更されません。アップグレード後にディスプレイマネージャにXサーバを起動させたい場合は、<filename>/etc/sysconfig/displaymanager</filename>で<envar>DISPLAYMANAGER_STARTS_XSERVER</envar>の設定を次のように変更します。
  </para>
  <screen>DISPLAYMANAGER_STARTS_XSERVER="yes"</screen>
 </sect1>
</chapter>
