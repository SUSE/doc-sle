<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_sync.xml" version="5.0" xml:id="cha.net.sync">
 <title>Cópia de arquivo com RSync</title>
 <info>
  <abstract>
   <para>
    Atualmente, muitas pessoas usam vários computadores: um em casa, um ou mais computadores no local de trabalho e possivelmente um laptop, tablet ou smartphone em trânsito. Vários arquivos são necessários em todos esses computadores. Você deve conseguir trabalhar com todos os computadores e modificar os arquivos, de modo que a versão mais recente dos dados fique disponível em todos os computadores.
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes (sim)</dm:translation>
  </dm:docmanager>
 </info>

 
 <warning>
  <title>risco de perda de dados</title>
  <para>
   Antes de começar a usar uma ferramenta de sincronização, você deve se familiarizar com seus recursos e funcionalidades. Faça backup de seus arquivos importantes.
  </para>
 </warning>

 <sect1 xml:id="sec.net.sync.rsync">
  <title>Visão geral conceitual</title>
  <para>
    Para sincronizar uma grande quantidade de dados em uma conexão de rede lenta, o Rsync oferece um método confiável para transmitir apenas as mudanças nos arquivos. Isso não se aplica apenas a arquivos de texto, mas também a arquivos binários. Para detectar as diferenças entre os arquivos, o Rsync os subdivide em blocos e calcula seus checksums.
   </para>
   <para>
    A detecção de mudanças requer alguma capacidade de computação. Portanto, verifique se as máquinas em ambas as extremidades possuem recursos suficientes, incluindo memória RAM.
   </para>
  <para>
   O Rsync pode ser útil principalmente quando grandes quantidades de dados que contêm apenas pequenas mudanças precisam ser transmitidas regularmente. Geralmente, esse é o caso quando se trabalha com backups. O Rsync também pode ser útil para espelhamento de servidores para testes que armazenam árvores completas do diretório de servidores Web em um servidor Web no DMZ.
  </para>
  <para>
   Apesar do nome, o Rsync não é uma ferramenta de sincronização. Rsync é uma ferramenta que copia dados apenas em uma direção de cada vez. Ele não faz e não pode fazer o contrário. Se você precisa de uma ferramenta bidirecional que é capaz de sincronizar a origem e o destino, use o Csync.
  </para>
  
 </sect1>

  <sect1 xml:id="sec.net.sync.rsync.syntax">
   <title>Sintaxe básica</title>
   <para>
    O Rsync é uma ferramenta de linha de comando que tem a seguinte sintaxe básica:
   </para>
   <screen>rsync [OPTION] SOURCE [SOURCE]... DEST</screen>
   <para>
    Você pode usar o Rsync em qualquer máquina local ou remota, desde que tenha acesso e permissões de gravação. É possível ter várias entradas <replaceable>SOURCE</replaceable>. Os marcadores <replaceable>SOURCE</replaceable> e <replaceable>DEST</replaceable> podem ser caminhos, URLs ou ambos.
   </para>
   <para>
    Veja a seguir as opções mais comuns do Rsync:
   </para>
   <variablelist>
    <varlistentry>
     <term><option>-v</option></term>
     <listitem>
      <para> Gera um texto mais verboso</para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>-a</option></term>
     <listitem>
      <para> Modo de arquivamento; copie arquivos recursivamente e preserve marcações de horário, propriedade de usuário/grupo, permissões de arquivos e links simbólicos. </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>-z</option></term>
     <listitem>
      <para>Comprimir os dados transmitidos</para>
     </listitem>
    </varlistentry>
   </variablelist>
   <note>
    <title>Total de Barras à Direita</title>
    <para>
     Ao trabalhar com o Rsync, você deve prestar atenção especial às barras à direita. Uma barra à direita após o diretório indica o <emphasis>conteúdo</emphasis> do diretório. Nenhuma barra à direita indica o <emphasis>próprio diretório</emphasis>.
   </para>
   </note>
  </sect1>

  <sect1 xml:id="sec.net.sync.rsync.copy.local.files-and-dirs">
   <title>Copiando arquivos e diretórios localmente</title>
   <para>
    A seguinte descrição pressupõe que o usuário atual tem permissões de gravação para o diretório <filename>/var/backup</filename>. Para copiar um único arquivo de um diretório em sua máquina para outro caminho, use o seguinte comando: </para>
   <screen><prompt>tux &gt; </prompt><command>rsync</command> -avz backup.tar.xz /var/backup/</screen>
   <para>O arquivo <filename>backup.tar.xz</filename> é copiado para <filename>/var/backup/</filename>, o caminho absoluto será <filename>/var/backup/backup.tar.xz</filename>.</para>
   <para>
    Lembre-se de adicionar a <emphasis>barra à direita</emphasis> após o diretório <filename>/var/backup/</filename>! Se você não inserir a barra, o arquivo <filename>backup.tar.xz</filename> será copiado para <filename>/var/backup</filename> (arquivo), e <emphasis>não</emphasis> dentro do diretório <filename>/var/backup/</filename>!
   </para>
   <para>
    Copiar um diretório é semelhante a copiar um arquivo único. O exemplo a seguir copia o diretório <filename>tux/</filename> e seu conteúdo para o diretório <filename>/var/backup/</filename>: </para>
    <screen><prompt>tux &gt; </prompt><command>rsync</command> -avz tux /var/backup/</screen>
    <para> Localize a cópia no caminho absoluto <filename>/var/backup/tux/</filename>. </para>
  </sect1>

  <sect1 xml:id="sec.net.sync.rsync.copy.remote.files-and-dirs">
   <title>Copiando arquivos e diretórios remotamente</title>
   <para>
    A ferramenta Rsync é necessária em ambas as máquinas. Para copiar arquivos de ou para diretórios remotos, é necessário um endereço IP ou um nome de domínio. Um nome de usuário poderá ser opcional caso os nomes de usuários atuais na máquina local e remota sejam os mesmos.
   </para>
   <para> Para copiar o arquivo <filename>file.tar.xz</filename> de seu host local para o host remoto <systemitem class="ipaddress">192.168.1.1</systemitem> com os mesmos usuários (sendo local e remoto), use o seguinte comando:
   </para>
   <screen><prompt>tux &gt; </prompt><command>rsync</command> -avz file.tar.xz  tux@192.168.1.1:</screen>
    <para> Dependendo do que você preferir, estes comandos também serão possíveis e equivalentes: </para>
   <screen><prompt>tux &gt; </prompt><command>rsync</command> -avz file.tar.xz 192.168.1.1:~
<prompt>tux &gt; </prompt><command>rsync</command> -avz file.tar.xz 192.168.1.1:/home/tux</screen>
    <para> Em todos os casos com configuração padrão, você será solicitado a inserir a frase secreta do usuário remoto. Esse comando copiará o <filename>file.tar.xz</filename> para o diretório pessoal do usuário <systemitem class="username">tux</systemitem> (normalmente, <filename>/home/tux</filename>).
    </para>
   <para>
    Copiar um diretório remotamente é semelhante a copiar um diretório localmente. O exemplo a seguir copia o diretório <filename>tux/</filename> e seu conteúdo para o diretório remoto <filename>/var/backup/</filename> no host <systemitem class="ipaddress">192.168.1.1</systemitem>:
   </para>
   <screen><prompt>tux &gt; </prompt><command>rsync</command> -avz tux 192.168.1.1:/var/backup/</screen>
   <para>
    Supondo que você tenha permissões de gravação no host <systemitem class="ipaddress">192.168.1.1</systemitem>, encontrará a cópia no caminho absoluto <filename>/var/backup/tux</filename>.
   </para>
  </sect1>

  <sect1 xml:id="sec.net.sync.rsync.server">
   <title>Configurando e usando um servidor Rsync</title>
   <para>
    O Rsync pode ser executado como um daemon (<systemitem class="daemon">rsyncd</systemitem>) listando na porta padrão 873 para conexões de entrada. Esse daemon pode receber <quote>destinos de cópia</quote>.
   </para>
   <para>
    A descrição a seguir explica como criar um servidor Rsync em <systemitem>jupiter</systemitem> com um destino de <emphasis>backup</emphasis>. Esse destino pode ser usado para armazenar os backups. Para criar um servidor Rsync, faça o seguinte:
   </para>
   <procedure>
    <title>Configurando um servidor Rsync</title>
    <step xml:id="st.rsync.server.mkdir">
     <para>
      No jupiter, crie um diretório para armazenar todos os seus arquivos de backup. Neste exemplo, usamos <filename>/var/backup</filename>:
     </para>
     <screen><prompt role="root">root # </prompt><command>mkdir</command> /var/backup</screen>
    </step>
    <step>
     <para>Especifique a propriedade. Neste caso, o diretório pertence ao usuário <systemitem class="username">tux</systemitem> no grupo <systemitem class="groupname">users</systemitem>:</para>
     <screen><prompt role="root">root # </prompt><command>chown</command> tux.users /var/backup</screen>
    </step>
    <step>
     <para>Configure o daemon rsyncd.</para>
     <para>Separaremos o arquivo de configuração em um arquivo principal e alguns <quote>módulos</quote> que contêm o destino de backup. Isso facilita adicionar outros destinos futuramente. É possível armazenas valores globais nos arquivos <filename>/etc/rsyncd.d/*.inc</filename>, enquanto os módulos são armazenados nos arquivos <filename>/etc/rsyncd.d/*.conf</filename>: </para>
     <substeps>
      <step>
       <para>Crie um diretório <filename>/etc/rsyncd.d/</filename>:</para>
       <screen><prompt role="root">root # </prompt><command>mkdir</command> /etc/rsyncd.d/</screen>
      </step>
      <step>
       <para>
        No arquivo de configuração principal <filename>/etc/rsyncd.conf</filename>, adicione as seguintes linhas:
       </para>
       <screen># rsyncd.conf main configuration file
log file = /var/log/rsync.log
pid file = /var/lock/rsync.lock

&amp;merge /etc/rsyncd.d <co xml:id="co.rsync.conf.merge"/>
&amp;include /etc/rsyncd.d <co xml:id="co.rsync.conf.include"/></screen>
       <calloutlist>
        <callout arearefs="co.rsync.conf.merge">
         <para> Faz a fusão dos valores globais dos arquivos <filename>/etc/rsyncd.d/*.inc</filename> no arquivo de configuração principal. </para>
        </callout>
        <callout arearefs="co.rsync.conf.include">
         <para> Carrega quaisquer módulos (ou destinos) dos arquivos <filename>/etc/rsyncd.d/*.conf</filename>. Esses arquivos não devem conter nenhuma referência a valores globais. </para>
        </callout>
       </calloutlist>
      </step>
      <step>
       <para> Crie o módulo (destino de backup) no arquivo <filename>/etc/rsyncd.d/backup.conf</filename> com as seguintes linhas: </para>
       <screen># backup.conf: backup module
[backup] <co xml:id="co.rsync.conf.target"/>
   uid = tux <co xml:id="co.rsync.conf.uid-gid"/>
   gid = users <xref linkend="co.rsync.conf.uid-gid"/>
   path = /var/backup <co xml:id="co.rsync.conf.path"/>
   auth users = tux  <co xml:id="co.rsync.conf.authusers"/>
   secrets file = /etc/rsyncd.secrets <co xml:id="co.rsync.conf.secretfiles"/>
   comment = Our backup target</screen>
       <calloutlist>
        
        
        <callout arearefs="co.rsync.conf.target">
         <para>
          O destino de <emphasis>backup</emphasis>. Você pode usar qualquer nome que desejar. No entanto, convém nomear um destino de acordo com sua finalidade e usar o mesmo nome em seu arquivo <filename>*.conf</filename>.
         </para>
        </callout>
        <callout arearefs="co.rsync.conf.uid-gid">
         <para>
          Especifica o nome de usuário ou nome do grupo que é usado quando a transferência de arquivos é feita.
         </para>
        </callout>
        <callout arearefs="co.rsync.conf.path">
         <para>
          Define o caminho para armazenar os backups (da <xref linkend="st.rsync.server.mkdir"/>).
         </para>
        </callout>
        <callout arearefs="co.rsync.conf.authusers">
         <para>
          Especifica uma lista separada por vírgulas de usuários permitidos. Em sua forma mais simples, ela contém os nomes de usuário que têm permissão para conectar-se a este módulo. Em nosso caso, apenas o usuário <systemitem class="username">tux</systemitem> é permitido.
         </para>
        </callout>
        <callout arearefs="co.rsync.conf.secretfiles">
         <para>
          Especifica o caminho de um arquivo que contém as linhas com os nomes de usuário e as senhas simples.
         </para>
        </callout>
       </calloutlist>
      </step>
      <step>
       <para>
        Crie o arquivo <filename>/etc/rsyncd.secrets</filename> com o seguinte conteúdo e substitua <replaceable>FRASE SECRETA</replaceable>:
       </para>
       <screen># user:passwd
tux:<replaceable>PASSPHRASE</replaceable></screen>
      </step>
      <step>
       <para>
        Verifique se o arquivo pode ser lido apenas por <systemitem class="username">root</systemitem>:
       </para>
       <screen><prompt role="root">root # </prompt><command>chmod</command> 0600 /etc/rsyncd.secrets</screen>
      </step>
     </substeps>

     
    </step>
    <step>
     <para>
      Inicie e habilite o daemon rsyncd com:
     </para>
     <screen><prompt role="root">root # </prompt><command>systemctl</command> enable rsyncd
<prompt role="root">root # </prompt><command>systemctl</command> start rsyncd</screen>
     
    </step>
    <step>
     <para>
      Teste o acesso ao servidor Rsync:
     </para>
     <screen><prompt>tux &gt; </prompt><command>rsync</command> jupiter::</screen>
     <para>
      Você deve ver uma resposta parecida com a seguinte:
     </para>
     <screen>backup          Our backup target</screen>
     <para>Do contrário, verifique o arquivo de configuração, as configurações de rede e de firewall.</para>
    </step>
   </procedure>
   <para>
    As etapas acima criam um servidor Rsync que agora pode ser usado para armazenar backups. O exemplo também cria um arquivo de registro listando todas as conexões. Esse arquivo é armazenado em <filename>/var/log/rsyncd.log</filename>. Isso é útil para depurar suas transferências.
   </para>
   <para>
    Para listar o conteúdo do destino de backup, use o seguinte comando:
   </para>
<screen>rsync -avz jupiter::backup</screen>
   <para>
    Esse comando lista todos os arquivos presentes no diretório <filename>/var/backup</filename> no servidor. Essa solicitação também é registrada no arquivo de registro <filename>/var/log/rsyncd.log</filename>. Para iniciar uma transferência real, especifique um diretório de origem. Use <literal>.</literal> para o diretório atual. Por exemplo, o comando a seguir copia o diretório atual para o servidor de backup Rsync:
   </para>
   <screen>rsync -avz . jupiter::backup</screen>
   <para>
    Por padrão, o Rsync não apaga arquivos e diretórios quando ele é executado. Para habilitar a exclusão, a opção adicional <option>--delete</option> deve ser especificada. Para garantir que nenhum arquivo novo seja apagado, use a opção <option>--update</option> como alternativa. Qualquer conflito ocorrido deve ser resolvido manualmente.
   </para>
  </sect1>

 <sect1 xml:id="sec.net.sync.summary">
  <title>Para obter mais informações</title>
  <variablelist>
   <varlistentry>
    <term>CSync</term>
    <listitem>
     <para>Sincronizador de arquivos bidirecional. Consulte <link xlink:href="https://www.csync.org/"/>.</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>RSnapshot</term>
    <listitem>
     <para>Cria backups incrementais. Consulte <link xlink:href="http://rsnapshot.org"/>.</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Unison</term>
    <listitem>
     <para>É um sincronizador de arquivos semelhante ao CSync, mas com uma interface gráfica. Consulte <link xlink:href="http://www.seas.upenn.edu/~bcpierce/unison/"/>.</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Rear</term>
    <listitem>
     <para>Uma estrutura de recuperação de desastre. Consulte o <citetitle>Administration Guide</citetitle> (Guia de Administração) da SUSE Linux Enterprise High Availability Extension <link xlink:href="https://www.suse.com/documentation/sle-ha-12/"/>.</para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
</chapter>
