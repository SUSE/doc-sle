<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="security_ldap_install.xml" version="5.0" xml:id="sec-security-ldap-server-install">
 <info>
  <title>安装 389 Directory Server</title>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <para>
  使用以下命令安装 389 Directory Server：
 </para>

<screen><prompt>&gt; </prompt><command>sudo</command> <command>zypper install 389-ds</command></screen>

 <para>
  安装后，<phrase os="sles;osuse">按照<xref linkend="sec-security-ldap-server"/>中所述设置服务器</phrase>。
 </para>

 <sect2 xml:id="sec-security-ldap-server">
  <title>设置新的 389 Directory Server 实例</title>
  <para>
   您需使用 <command>dscreate</command> 命令来创建新的 389 Directory Server 实例，并使用 <command>dsctl</command> 命令彻底去除这些实例。
  </para>
  <para>
   可以基于自定义配置文件以及基于自动生成的模板文件这两种方式来配置和创建新实例。对于测试实例，您可以使用自动生成的模板，而无需进行任何更改，不过，对于生产系统，则必须仔细检查该模板并进行任何必要的更改。
  </para>
  <para>
   然后，您需要设置管理身份凭证，管理用户和组，并配置身份服务。
  </para>

  <para>
   389 Directory Server 由三个主要命令控制：
  </para>
  <variablelist>
   <varlistentry>
    <term><command>dsctl</command></term>
    <listitem>
     <para>
      管理本地实例，需要 <systemitem class="username">root</systemitem> 权限。要求您连接到运行目录服务器实例的终端。用于启动、停止和备份数据库以及进行其他操作。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>dsconf</command></term>
    <listitem>
     <para>
      用于管理和配置服务器的主要工具。可通过实例的外部接口管理其配置。这样，您便可以在该实例上远程更改配置。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>dsidm</command></term>
    <listitem>
     <para>
      用于身份管理（管理用户、组、口令等）。权限由访问控制授予，因此，举例而言，用户可以重设置自己的口令或更改自己帐户的细节。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <para>
   执行以下步骤可设置一个用于测试和开发的简单实例，并在其中填充少量的示例项。
  </para>
  <procedure>
   <step>
    <para>

     <xref linkend="sec-security-ldap-server-instance" xrefstyle="select:title"/>
    </para>
   </step>
   <step>
    <para>

     <xref linkend="sec-security-ldap-server-template" xrefstyle="select:title"/>
    </para>
   </step>
   <step>
    <para>

     <xref linkend="sec-security-ldap-server-credentials" xrefstyle="select:title"/>
    </para>
   </step>
   <step>
    <para>

     <xref linkend="sec-security-ldap-server-users" xrefstyle="select:title"/>
    </para>
   </step>
   <step>
    <para>

     <xref linkend="sec-security-ldap-server-sssd" xrefstyle="select:title"/>
    </para>
   </step>
   <step>
    <para>

     <xref linkend="sec-security-ldap-modules" xrefstyle="select:title"/>
    </para>
   </step>
   <step>
    <para>

     <xref linkend="sec-security-ldap-server-ca" xrefstyle="select:title"/>
    </para>
   </step>
  </procedure>
 </sect2>

 <sect2 xml:id="sec-security-ldap-server-instance">
  <title>使用自定义配置文件创建 389 Directory Server 实例</title>
  <para>
   您可以基于一个简单的自定义配置文件创建新的 389 Directory Server 实例。此文件必须采用 INF 格式，您可以对其随意命名。
  </para>
  <para>
   默认实例名称为 <literal>localhost</literal>。创建实例后，便无法更改实例名称。您最好创建自己的实例名称，而不要使用默认名称，这样可避免混淆并更容易理解实例的工作方式。以下示例使用实例名称 <replaceable>LDAP1</replaceable> 和后缀 dc=<replaceable>LDAP1</replaceable>,dc=<replaceable>COM</replaceable>。
  </para>
  <para>
   <xref linkend="ex-ldap-389-ds-inf" xrefstyle="select:label"/> 显示了一个可用于创建新 389 Directory Server 实例的示例配置文件。您可以复制并按原样使用此文件。
  </para>
  <procedure>
   <step>
    <para>
     将下面的示例文件 <filename>LDAP1.inf</filename> 复制到您的主目录：
    </para>
    <example xml:id="ex-ldap-389-ds-inf">
     <title>最小 389 Directory Server 实例的配置文件</title>
<screen># <replaceable>LDAP1.inf</replaceable>

[general]
config_version = 2 <co xml:id="co-ldap-389-ds-config-version"/>

[slapd]
root_password = <replaceable>PASSWORD</replaceable><co xml:id="co-ldap-389-ds-rootpasswd"/>
self_sign_cert = True <co xml:id="co-ldap-389-ds-cert"/>
instance_name = <replaceable>LDAP1</replaceable>

[backend-userroot]
sample_entries = yes <co xml:id="co-ldap-389-ds-sample-entries"/>
suffix = dc=<replaceable>LDAP1</replaceable>,dc=<replaceable>COM</replaceable></screen>
     <calloutlist>
      <callout arearefs="co-ldap-389-ds-config-version">
       <para>
        此行为必需的指令，指示这是版本 2 的 INF 设置文件。
       </para>
      </callout>
      <callout arearefs="co-ldap-389-ds-rootpasswd">
       <para>
        为 LDAP 用户 <literal>cn=Directory Manager</literal> 创建强 <varname>root_password</varname>。此用户用于连接（绑定）到目录。
       </para>
      </callout>
      <callout arearefs="co-ldap-389-ds-cert">
       <para>
        在 <filename>/etc/dirsrv/slapd-<replaceable>LDAP1</replaceable></filename> 中创建自我签名的服务器证书。
       </para>
      </callout>
      <callout arearefs="co-ldap-389-ds-sample-entries">
       <para>
        在新实例中填充示例用户和组项。
       </para>
      </callout>
     </calloutlist>
    </example>
   </step>
   <step>
    <para>
     要根据<xref linkend="ex-ldap-389-ds-inf" xrefstyle="select:label"/> 创建 389 Directory Server 实例，请运行以下命令：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>dscreate -v from-file <replaceable>LDAP1.inf</replaceable> |</command> \
<command>tee <replaceable>LDAP1-OUTPUT.txt</replaceable></command></screen>
    <para>
     这会显示创建实例期间发生的所有活动，将所有消息储存在 <filename><replaceable>LDAP1-OUTPUT.txt</replaceable></filename> 中，并在大约一分钟内创建一个正常工作的 LDAP 服务器。详细输出包含大量有用的信息。如果您不想保存这些信息，请删除该命令的 <literal>| tee <replaceable>LDAP1-OUTPUT.txt</replaceable></literal> 部分。
    </para>
   </step>
   <step>
    <para>
     如果 <command>dscreate</command> 命令失败，会显示消息告诉您原因。更正所有问题后，去除该实例（参见<xref linkend="sec-security-ldap-server-remove"/>）并创建新实例。
    </para>
   </step>
   <step>
    <para>
     成功安装后，系统会报告“<literal>已完成 <replaceable>LDAP1</replaceable></literal> 的安装”。检查新服务器的状态：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>dsctl <replaceable>LDAP1</replaceable> status</command>
Instance "LDAP1" is running</screen>
   </step>
   <step xml:id="sec-security-ldap-server-remove">
    <para>
     以下命令可用于彻底去除实例。第一条命令执行试运行，而不会去除实例。当您确定要去除时，请结合 <command>--do-it</command> 选项使用第二条命令：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>dsctl <replaceable>LDAP1</replaceable> remove</command>
Not removing: if you are sure, add --do-it

<prompt>&gt; </prompt><command>sudo</command> dsctl <command><replaceable>LDAP1</replaceable> remove --do-it</command></screen>
    <para>
     此命令还会去除未完整安装的或已损坏的实例。您可以放心地按所需的频率创建和去除实例。
    </para>
   </step>
  </procedure>
  <para>
   如果您忘记了实例的名称，可使用 <command>dsctl</command> 列出所有实例：
  </para>
<screen><prompt>&gt; </prompt><command>dsctl -l</command>
slapd-<replaceable>LDAP1</replaceable></screen>
 </sect2>

 <sect2 xml:id="sec-security-ldap-server-template">
  <title>基于模板创建 389 Directory Server 实例</title>
  <para>
   您可以使用 <command>dscreate</command> 命令为新 389 Directory Server 实例自动创建模板。这会创建一个模板，您可以按原样使用该模板进行测试。对于生产系统，请检查该模板并根据您自己的要求进行更改。所有默认值在模板文件中都有说明，并已注释掉。要进行更改，请取消注释默认值并输入您自己的值。所有选项都有详细的说明。
  </para>
  <para>
   下面的示例会将模板输出到 stdout：
  </para>
<screen><prompt>&gt; </prompt><command>dscreate create-template</command></screen>
  <para>
   这有助于快速检查模板，但是，您必须创建一个文件用于创建新 389 Directory Server 实例。您可以对此文件随意命名：
  </para>
<screen><prompt>&gt; </prompt><command>dscreate create-template <replaceable>TEMPLATE.txt</replaceable></command></screen>
  <para>
   下面是新文件中的代码段：
  </para>
<screen># full_machine_name (str)
# Description: Sets the fully qualified hostname (FQDN) of this system. When
# installing this instance with GSSAPI authentication behind a load balancer, set
# this parameter to the FQDN of the load balancer and, additionally, set
# "strict_host_checking" to "false".
# Default value: ldapserver1.test.net
;full_machine_name = ldapserver1.test.net

# selinux (bool)
# Description: Enables SELinux detection and integration during the installation
# of this instance. If set to "True", dscreate auto-detects whether SELinux is
# enabled. Set this parameter only to "False" in a development environment.
# Default value: True
;selinux = True</screen>
  <para>
   它会自动从您的现有环境配置一些选项，例如系统的完全限定域名（在模板中名为 <literal>full_machine_name</literal>）。按原样使用此文件来创建一个新实例：
  </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>dscreate from-file <replaceable>TEMPLATE.txt</replaceable></command></screen>
  <para>
   这会创建一个名为 <literal>localhost</literal> 的新实例，并在创建后自动启动该实例：
  </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>dsctl localhost status</command>
Instance "localhost" is running</screen>
  <para>
   使用默认值会创建一个完全可正常运行的实例，不过您也可以更改某些值。
  </para>
  <para>
   创建实例后，便无法更改实例名称。您最好创建自己的实例名称，而不要使用默认名称，这样可避免混淆并更容易理解实例的工作方式。为此，请取消注释 <literal>;instance_name = localhost</literal> 行，并将 <literal>localhost</literal> 更改为所需的名称。在以下示例中，实例名称为 <replaceable>LDAP1</replaceable>。
  </para>
  <para>
   另一项有用的更改是在新实例中填充示例用户和组。取消注释 <literal>;sample_entries = no</literal>，并将 <literal>no</literal> 更改为 <literal>yes</literal>。这会创建 <literal>demo_user</literal> 和 <literal>demo_group</literal>。
  </para>
  <para>
   通过取消注释 <literal>;root_password</literal> 并将默认口令替换为您自己的口令来设置口令。
  </para>
  <para>
   模板不会创建默认后缀，因此您应在 <literal>suffix</literal> 行中配置自己的后缀，如下例所示：
  </para>
<screen>suffix = dc=<replaceable>LDAP1</replaceable>,dc=<replaceable>COM</replaceable></screen>
  <para>
   可以使用 <command>dsctl</command> 彻底去除任何实例，然后重新开始创建：
  </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>dsctl <replaceable>LDAP1</replaceable> remove --do-it</command></screen>
 </sect2>

 <sect2 xml:id="sec-security-ldap-server-stop-start">
  <title>停止和启动 389 Directory Server</title>
  <para>
   以下示例使用 <literal>LDAP1</literal> 作为实例名称。使用 <systemitem class="daemon">systemd</systemitem> 管理 389 Directory Server 实例。获取实例的状态：
  </para>
<screen><prompt>&gt; </prompt><command>systemctl status --no-pager --full dirsrv@LDAP1.service</command>
   ● dirsrv@LDAP1.service - 389 Directory Server LDAP1.
     Loaded: loaded (/usr/lib/systemd/system/dirsrv@.service; enabled; vendor preset: disabled)
     Active: active (running) since Thu 2021-03-11 08:55:28 PST; 2h 7min ago
    Process: 4451 ExecStartPre=/usr/lib/dirsrv/ds_systemd_ask_password_acl
       /etc/dirsrv/slapd-LDAP1/dse.ldif (code=exited, status=0/SUCCESS)
   Main PID: 4456 (ns-slapd)
     Status: "slapd started: Ready to process requests"
      Tasks: 26
     CGroup: /system.slice/system-dirsrv.slice/dirsrv@LDAP1.service
             └─4456 /usr/sbin/ns-slapd -D /etc/dirsrv/slapd-LDAP1 -i /run/dirsrv/slapd-LDAP1.pid
</screen>
  <para>
   启动、停止和重启动 LDAP 服务器：
  </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>systemctl start <replaceable>dirsrv@LDAP1.service</replaceable></command>
<prompt>&gt; </prompt><command>sudo</command> <command>systemctl stop <replaceable>dirsrv@LDAP1.service</replaceable></command>
<prompt>&gt; </prompt><command>sudo</command> <command>systemctl restart <replaceable>dirsrv@LDAP1.service</replaceable></command></screen>
  <para>
   有关使用 <command>systemctl</command> 的详细信息，请参见<xref linkend="cha-systemd"/>。
  </para>
  <para>
   <command>dsctl</command> 命令还可启动和停止服务器：
  </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>dsctl <replaceable>LDAP1</replaceable> status</command>
<prompt>&gt; </prompt><command>sudo</command> <command>dsctl <replaceable>LDAP1</replaceable> stop</command>
<prompt>&gt; </prompt><command>sudo</command> <command>dsctl <replaceable>LDAP1</replaceable> restart</command>
<prompt>&gt; </prompt><command>sudo</command> <command>dsctl <replaceable>LDAP1</replaceable> start</command>
</screen>
 </sect2>

 <sect2 xml:id="sec-security-ldap-server-credentials">
  <title>配置用于本地管理的管理员身份凭证</title>
  <para>
   要对 389 Directory Server 进行本地管理，您可以在 <filename>/root</filename> 目录中创建一个 <filename>.dsrc</filename> 配置文件，这样 root 和 sudo 用户管理服务器时就不必每运行一条命令都要键入连接细节。<xref linkend="ex-security-ldap-server-credentials-local" xrefstyle="select:label"/> 显示了在服务器上进行本地管理的示例，其中使用了 <replaceable>LDAP1</replaceable> 和 <replaceable>com</replaceable> 作为后缀。
  </para>
  <para>
   创建 <filename>/root/.dsrc</filename> 文件后，请尝试运行几条管理命令，例如创建新用户（参见<xref linkend="sec-security-ldap-server-users"/>）。
  </para>
  <example xml:id="ex-security-ldap-server-credentials-local">
   <title>用于本地管理的 <filename>.dsrc</filename> 文件</title>
<screen># /root/.dsrc file for administering the LDAP1 instance

[<replaceable>LDAP1</replaceable>] <co xml:id="co-ldap-server-dsrc-instance-name"/>

uri = ldapi://<replaceable>%%2fvar%%2frun%%2fslapd-LDAP1.socket</replaceable> <co xml:id="co-ldap-server-dsrc-remote-ldapi"/>
basedn = dc=<replaceable>LDAP1</replaceable>,dc=<replaceable>COM</replaceable>
binddn = cn=Directory Manager
</screen>
   <calloutlist>
    <callout arearefs="co-ldap-server-dsrc-instance-name">
     <para>
      此处必须指定确切的实例名称。
     </para>
    </callout>
    <callout arearefs="co-ldap-server-dsrc-remote-ldapi">
     <para>
      <literal>ldapi</literal> 将检测尝试登录到服务器的用户的 UID 和 GID。如果 UID/GID 为 <literal>0/0</literal> 或 <literal>dirsrv:dirsrv</literal>，则 <literal>ldapi</literal> 会将该用户绑定为目录服务器根 DN，即 <literal>cn=Directory Manager</literal>。
     </para>
     <para>
      在 URI 中，斜杠将替换为 <literal>%%2f</literal>，因此在本示例中，路径为 <filename>/var/run/slapd-<replaceable>LDAP1</replaceable>.socket</filename>。
     </para>
    </callout>
   </calloutlist>
  </example>
       <important>
       <title>sudoers.ldap 中的新求反功能</title>
       <para>
         在低于 1.9.9 的 <package>sudo</package> 版本中，sudoers.ldap 中的求反对于 <literal>sudoUser</literal>、<literal>sudoRunAsUser</literal> 或 <literal>sudoRunAsGroup</literal> 属性不起作用。例如：
       </para>
       <screen> # does not match all but joe
# instead, it does not match anyone
sudoUser: !joe

# does not match all but joe
# instead, it matches everyone including Joe
sudoUser: ALL
sudoUser: !joe</screen>
     </important>
  <para>
    在 <command>sudo</command> 1.9.9 和更高版本中，为 <literal>sudoUser</literal> 属性启用了求反。有关详细信息，请参见 <command>man 5 sudoers.ldap</command>。
  </para>
 </sect2>
</sect1>
