<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="xen2kvm.xml" version="5.0" xml:id="xen2kvm-migration">
  <info>
    <title>Xen 到 KVM 的迁移指南</title>
    <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
      <dm:translation>yes</dm:translation>
    </dm:docmanager>
  </info>
  <para>
    随着服务器管理员越来越广泛地使用 KVM 虚拟化解决方案，他们中的许多人都需要有一个途径将其基于 Xen 的现有环境迁移到 KVM。目前还没有成熟的工具可自动将 Xen VM 转换为 KVM。不过，有一个技术解决方案有助于将 Xen 虚拟机转换为 KVM。下面的信息和过程可帮助您执行这样的迁移。
  </para>
  <important>
    <title>不支持迁移过程</title>
    <para>
      SUSE 不完全支持本文档中所述的迁移过程。我们提供的说明仅作为指导。
    </para>
  </important>
  <sect1 xml:id="x2k-v2v">
    <title>使用 <command>virt-v2v</command> 迁移到 KVM</title>

    <para>
      本章包含可帮助您将虚拟机从外部超级管理程序（例如 Xen）导入到 <systemitem class="library">libvirt</systemitem> 所管理的 KVM 的信息。
    </para>

    <tip>
      <title>Microsoft Windows Guest</title>
      <para>
        本章重点介绍如何转换 Linux Guest。使用 <command>virt-v2v</command> 转换 Microsoft Windows Guest 与转换 Linux Guest 的过程相同，只不过对虚拟机驱动程序包 (VMDP) 的处理方式有所不同。<link xlink:href="https://documentation.suse.com/sle-vmdp/">Virtual
        Machine Driver Pack documentation</link>中单独提供了有关转换使用 VMDP 的 Windows Guest 的更多细节。
      </para>
    </tip>

    <sect2 xml:id="x2k-v2v-intro">
      <title><command>virt-v2v</command> 简介</title>
      <para>
        <command>virt-v2v</command> 是一个命令行工具，可将外部超级管理程序中的 VM Guest 转换为在 <systemitem class="library">libvirt</systemitem> 管理的 KVM 上运行。如果可能，它会在转换的虚拟机中启用半虚拟化 virtio 驱动程序。下面是支持的操作系统和超级管理程序列表：
      </para>
      <itemizedlist mark="bullet" spacing="normal">
        <title>支持的 Guest 操作系统</title>
        <listitem>
          <para>
            SUSE Linux Enterprise Server
          </para>
        </listitem>
        <listitem>
          <para>
            openSUSE
          </para>
        </listitem>
        <listitem>
          <para>
            Red Hat Enterprise Linux
          </para>
        </listitem>
        <listitem>
          <para>
            Fedora
          </para>
        </listitem>
        <listitem>
          
          
          <para>
            Microsoft Windows Server 2003 和 2008
          </para>
        </listitem>
      </itemizedlist>
      <itemizedlist mark="bullet" spacing="normal">
        <title>支持的源超级管理程序</title>
        <listitem>
          <para>
            Xen
          </para>
        </listitem>
      </itemizedlist>
      <itemizedlist mark="bullet" spacing="normal">
        <title>支持的目标超级管理程序</title>
        <listitem>
          <para>
            KVM（由 <systemitem class="library">libvirt</systemitem> 管理）
          </para>
        </listitem>
      </itemizedlist>
    </sect2>

    <sect2 xml:id="x2k-v2v-install">
      <title>安装 <command>virt-v2v</command></title>
      <para>
        安装 <command>virt-v2v</command> 的过程很简单：
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> zypper install virt-v2v</screen>
      <para>
        请记住，<command>virt-v2v</command> 需要 <systemitem class="username">root</systemitem> 特权，因此您需要以 <systemitem class="username">root</systemitem> 身份或通过 <command>sudo</command> 运行该工具。
      </para>
    </sect2>

    <sect2 xml:id="x2k-v2v-prepare">
      <title>准备虚拟机</title>
      <note>
        <title>跳过此步骤的条件</title>
        <para>
          如果在 SLES 12 SP1 或更低版本上运行 <command>virt-v2v</command>，可以放心跳过此步骤。如果虚拟机已完全虚拟化或者在 SLES 12 SP2 或更高版本上运行，也可以忽略此步骤。
        </para>
      </note>
      <para>
        必须在 Xen 虚拟机中安装默认内核。为确保执行此操作，请在虚拟机上运行 <command>zypper in kernel-default</command>。
      </para>
    </sect2>

    <sect2 xml:id="x2k-v2v-convert">
      <title>将虚拟机转换为在 <systemitem class="library">libvirt</systemitem> 管理的 KVM 下运行</title>
      <para>
        <command>virt-v2v</command> 可将 Xen 超级管理程序中的虚拟机转换为在 <systemitem class="library">libvirt</systemitem> 管理的 KVM 上运行。要了解有关 <systemitem class="library">libvirt</systemitem> 和 <command>virsh</command> 的详细信息，请参见<xref linkend="part-virt-libvirt"/>。此外，<command>virt-v2v</command> 手册页 (<command>man 1
        virt-v2v</command>) 中也对所有 <command>virt-v2v</command> 命令行选项进行了说明。
      </para>
      <para>
        转换虚拟机之前，请务必完成以下步骤：
      </para>
      <procedure>
        <title>准备转换环境</title>
        <step>
          <para>
            创建新的本地存储池。
          </para>
          <para>
            <command>virt-v2v</command> 会将源虚拟机的存储复制到由 <systemitem class="library">libvirt</systemitem> 管理的本地存储池（原始磁盘映像保持不变）。可以使用虚拟机管理器或 <command>virsh</command> 创建该池。有关详细信息，请参见<xref linkend="sec-libvirt-storage-vmm"/>和<xref linkend="sec-libvirt-storage-virsh"/>。
          </para>
        </step>
        <step>
          <para>
            准备本地网络接口。
          </para>
          <para>
            检查转换的虚拟机能否使用 VM 主机服务器上的本地网络接口。该接口通常是一个网桥，如果尚未定义它，请选择 <menuchoice><guimenu>YaST</guimenu><guimenu>系统</guimenu><guimenu>网络设置</guimenu><guimenu>添加</guimenu><guimenu>网桥</guimenu></menuchoice>创建该接口。
          </para>
          <note>
            <title>网络设备的映射</title>
            <para>
              在转换过程中，可能会将源 Xen 主机上的网络设备映射到 KVM 目标主机上的相应网络设备。例如，可能会将 Xen 网桥 <literal>br0</literal> 映射到默认的 KVM 网络设备。<filename>/etc/virt-v2v.conf</filename> 中提供了一些示例映射。要启用这些映射，请根据需要修改 XML 规则，并确保未以 <literal>&lt;!--</literal> 和 <literal>--&gt;</literal> 标记注释掉相应部分。例如：
            </para>
<screen>
 &lt;network type='bridge' name='br0'&gt;
   &lt;network type='network' name='default'/&gt;
 &lt;/network&gt;
</screen>
          </note>
          <tip>
            <title>无网桥</title>
            <para>
              如果没有可用的网桥，虚拟机管理器可以选择性创建一个。
            </para>
          </tip>
        </step>
      </procedure>
      <para>
        <command>virt-v2v</command> 的基本命令语法如下：
      </para>
<screen>virt-v2v -i <replaceable>INPUT_METHOD</replaceable> -os <replaceable>STORAGE_POOL</replaceable> <replaceable>SOURCE_VM</replaceable></screen>
      <variablelist>
        <varlistentry>
          <term>input_method</term>
          <listitem>
            <para>
              有两种输入方法：<literal>libvirt</literal> 或 <literal>libvirtxml</literal>。有关详细信息，请参见 <replaceable>SOURCE_VM</replaceable> 参数。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term>storage_pool</term>
          <listitem>
            <para>
              您已为目标虚拟机准备好的存储池。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term>source_vm</term>
          <listitem>
            <para>
              要转换的源虚拟机。其值取决于 <replaceable>INPUT_METHOD</replaceable> 参数：如果输入方法为 <literal>libvirt</literal>，需指定 libvirt 域的名称。如果输入方法为 <literal>libvirtxml</literal>，需指定包含 libvirt 域规范的 XML 文件的路径。
            </para>
          </listitem>
        </varlistentry>
      </variablelist>
      <note>
        <title>转换时间</title>
        <para>
          转换虚拟机时会占用大量系统资源，主要用于复制虚拟机的整个磁盘映像。转换单个虚拟机一般最长需要 10 分钟时间。对于使用大型磁盘映像的虚拟机，转换时间可能要长很多。
        </para>
      </note>
      <sect3 xml:id="x2k-v2v-convert-xml">
        <title>基于 <systemitem class="library">libvirt</systemitem> XML 描述文件的转换</title>
        <para>
          本节说明如何使用 <systemitem class="library">libvirt</systemitem> XML 配置文件转换本地 Xen 虚拟机。如果主机已在运行 KVM 超级管理程序，则适合使用此方法。确保在本地主机上可以使用源虚拟机的 <systemitem class="library">libvirt</systemitem> XML 文件以及其中引用的 <systemitem class="library">libvirt</systemitem> 存储池。
        </para>
        <procedure>
          <step>
            <para>
              获取源虚拟机的 <systemitem class="library">libvirt</systemitem> XML 描述。
            </para>
            <tip>
              <title>获取 XML 文件</title>
              <para>
                要获取源虚拟机的 <systemitem class="library">libvirt</systemitem> XML 文件，您必须在 Xen 内核下运行主机操作系统。如果您已将主机重引导至启用了 KVM 的环境，请将其重引导回 Xen 内核，转储 <systemitem class="library">libvirt</systemitem> XML 文件，然后再重引导回 KVM 环境。
              </para>
            </tip>
            <para>
              首先，识别 virsh 下的源虚拟机：
            </para>
<screen><prompt role="root"># </prompt>virsh list
 Id    Name                           State
----------------------------------------------------
[...]
  2     sles12_xen                     running
[...]</screen>
            <para>
              <literal>sles12_xen</literal> 是要转换的源虚拟机。现在，导出其 XML 并保存到 <filename>sles12_xen.xml</filename>：
            </para>
<screen><prompt role="root"># </prompt>virsh dumpxml sles12_xen &gt; sles12_xen.xml</screen>
          </step>
          <step>
            <para>
              从 KVM 主机的角度校验所有磁盘映像路径是否正确。在一台计算机上转换时，路径正确与否不会产生问题，但使用 XML 转储从其他主机进行转换时，可能需要手动更改路径。
            </para>
<screen>&lt;source file='/var/lib/libvirt/images/XenPool/SLES.qcow2'/&gt;</screen>
            <tip>
              <title>复制映像</title>
              <para>
                为避免将映像复制两次，请直接手动将一个或多个磁盘映像复制到 <systemitem class="library">libvirt</systemitem> 存储池。更新 XML 描述文件中的源文件项。<command>virt-v2v</command> 进程将检测现有磁盘，并就地转换这些磁盘。
              </para>
            </tip>
          </step>
          <step>
            <para>
              运行 <command>virt-v2v</command> 以转换为 KVM 虚拟机：
            </para>
<screen><prompt role="root"># </prompt>virt-v2v sles12_xen.xml<co xml:id="v2v-xml"/> \
-i <replaceable>LIBVIRTXML</replaceable><co xml:id="v2v-method"/> \
-os <replaceable>remote_host.example.com:/exported_dir</replaceable><co xml:id="v2v-pool"/> \
--bridge <replaceable>br0</replaceable><co xml:id="v2v-bridge"/> \
-on <replaceable>sles12_kvm</replaceable><co xml:id="v2v-name"/></screen>
            <calloutlist>
              <callout arearefs="v2v-xml">
                <para>
                  基于 Xen 的源虚拟机的 XML 描述。
                </para>
              </callout>
              <callout arearefs="v2v-method">
                <para>
                  <command>virt-v2v</command> 从 <systemitem class="library">libvirt</systemitem> XML 文件中读取有关源虚拟机的信息。
                </para>
              </callout>
              <callout arearefs="v2v-pool">
                <para>
                  用于存放目标虚拟机磁盘映像的存储池。在此示例中，映像将放置在 <literal>remote_host.example.com</literal> 服务器的 NFS 共享 <filename>/exported_dir</filename> 上。
                </para>
              </callout>
              <callout arearefs="v2v-bridge">
                <para>
                  基于 KVM 的目标虚拟机使用主机上的网桥 <literal>br0</literal>。
                </para>
              </callout>
              <callout arearefs="v2v-name">
                <para>
                  目标虚拟机将重命名为 <literal>sles12_kvm</literal>，以防与同名的现有虚拟机发生名称冲突。
                </para>
              </callout>
            </calloutlist>
          </step>
        </procedure>
      </sect3>
      <sect3 xml:id="x2k-v2v-convert-domain">
        <title>基于 <systemitem class="library">libvirt</systemitem> 域名的转换</title>
        <para>
          如果您仍在 Xen 下运行 <systemitem class="library">libvirt</systemitem>，打算稍后重引导到 KVM 超级管理程序，则此方法很有用。
        </para>
        <procedure>
          <step>
            <para>
              确定您要转换的虚拟机的 <systemitem class="library">libvirt</systemitem> 域名。
            </para>
<screen><prompt role="root"># </prompt>virsh list
 Id    Name                           State
----------------------------------------------------
[...]
  2     sles12_xen                     running
[...]</screen>
            <para>
              <literal>sles12_xen</literal> 是要转换的源虚拟机。
            </para>
          </step>
          <step>
            <para>
              运行 <command>virt-v2v</command> 以转换为 KVM 虚拟机：
            </para>
<screen><prompt role="root"># </prompt>virt-v2v sles12_xen<co xml:id="v2v-domain"/> \
-i <replaceable>libvirt</replaceable><co xml:id="v2v-method1"/> \
-os <replaceable>storage_pool</replaceable><co xml:id="v2v-pool1"/> \
--network <replaceable>eth0</replaceable><co xml:id="v2v-net"/> \
-of qcow2<co xml:id="v2v-qcow"/> \
-oa sparse<co xml:id="v2v-sparse"/> \
-on <replaceable>sles12_kvm</replaceable></screen>
            <calloutlist>
              <callout arearefs="v2v-domain">
                <para>
                  基于 Xen 的虚拟机的域名。
                </para>
              </callout>
              <callout arearefs="v2v-method1">
                <para>
                  <command>virt-v2v</command> 直接通过 <systemitem class="library">libvirt</systemitem> 活动连接读取有关源虚拟机的信息。
                </para>
              </callout>
              <callout arearefs="v2v-pool1">
                <para>
                  目标磁盘映像将放置在本地 <systemitem class="library">libvirt</systemitem> 存储池中。
                </para>
              </callout>
              <callout arearefs="v2v-net">
                <para>
                  所有 Guest 网桥（或网络）将连接到本地管理的网络。
                </para>
              </callout>
              <callout arearefs="v2v-qcow">
                <para>
                  目标虚拟机的磁盘映像的格式。支持的选项为 <option>raw</option> 或 <option>qcow2</option>。
                </para>
              </callout>
              <callout arearefs="v2v-sparse">
                <para>
                  转换的 Guest 磁盘空间是采用 <option>sparse</option> 模式还是 <option>preallocated</option> 模式。
                </para>
              </callout>
            </calloutlist>
          </step>
        </procedure>
      </sect3>
      <sect3 xml:id="x2k-v2v-convert-remote">
        <title>转换远程 Xen 虚拟机</title>
        <para>
          如果您需要转换在远程主机上运行的 Xen 虚拟机，此方法非常有用。由于 <command>virt-v2v</command> 通过 <command>ssh</command> 连接到远程主机，因此请确保主机上正在运行 SSH 服务。
        </para>
        <note>
          <title>无口令 SSH 访问</title>
          <para>
            从 SLES 12 SP2 开始，<command>virt-v2v</command> 要求通过无口令 SSH 方式连接到远程主机。这意味着需向 ssh-agent 添加一个使用 SSH 密钥的连接。有关更多细节，请参见 <command>man ssh-keygen</command> 和 <command>man
            ssh-add</command>。<xref linkend="cha-ssh"/> 上也提供了详细信息。
          </para>
        </note>
        <para>
          要连接到远程 <systemitem class="library">libvirt</systemitem> 连接，请构建远程主机的相关有效连接 URI。在以下示例中，远程主机名为 <literal>remote_host.example.com</literal>，连接用户名为 <systemitem class="username">root</systemitem>。连接 URI 的格式如下所示：
        </para>
<screen>xen+ssh://root@remote_host.example.com/</screen>
        <para>
          有关 <systemitem class="library">libvirt</systemitem> 连接 URI 的详细信息，请参见 <link xlink:href="https://libvirt.org/uri.html"/>。
        </para>
        <procedure>
          <step>
            <para>
              确定您要转换的远程虚拟机的 <systemitem class="library">libvirt</systemitem> 域名。
            </para>
<screen><prompt role="root"># </prompt>virsh -c xen+ssh://root@remote_host.example.com/ list
 Id    Name                           State
----------------------------------------------------
  1     sles12_xen                     running
[...]</screen>
            <para>
              <literal>sles12_xen</literal> 是要转换的源虚拟机。
            </para>
          </step>
          <step>
            <para>
              远程连接的 <command>virt-v2v</command> 命令如下所示：
            </para>
<screen><prompt role="root"># </prompt>virt-v2v sles12_xen \
-i <replaceable>libvirt</replaceable> \
-ic <replaceable>xen+ssh://root@remote_host.example.com/</replaceable> \
-os <replaceable>local_storage_pool</replaceable> \
--bridge <replaceable>br0</replaceable></screen>
          </step>
        </procedure>
      </sect3>
    </sect2>

    <sect2 xml:id="x2k-v2v-run">
      <title>运行转换的虚拟机</title>
      <para>
        <command>virt-v2v</command> 成功完成后，将以 <option>-on</option> 选项所指定的名称创建一个新的 <systemitem class="library">libvirt</systemitem> 域。如果您未指定 <option>-on</option>，将使用与源虚拟机相同的名称。可以使用 <command>virsh</command> 或虚拟机管理器等标准 <systemitem class="library">libvirt</systemitem> 工具管理新 Guest。
      </para>
      <tip>
        <title>重引导计算机</title>
        <para>
          如果您已按<xref linkend="x2k-v2v-convert-domain"/>中所述在 Xen 下完成转换，可能需要重引导主机，并使用非 Xen 内核进行引导。
        </para>
      </tip>
    </sect2>
  </sect1>
  <sect1>
    <title>Xen 到 KVM 的手动迁移</title>

    <para/>

    <sect2>
      <title>一般概述</title>
      <para>
        首选的虚拟机管理解决方案是在 <systemitem class="library">libvirt</systemitem> 上进行管理；有关详细信息，请参见 <link xlink:href="https://libvirt.org/"/>。与手动定义和运行虚拟机的方式相比，它具有多项优势 — <systemitem class="library">libvirt</systemitem> 可以跨平台，支持许多超级管理程序，具有安全的远程管理功能以及虚拟网络功能，最重要的是，它可提供统一的抽象层来管理虚拟机。因此，本文着重于介绍 <systemitem class="library">libvirt</systemitem> 解决方案。
      </para>
      <para>
        一般情况下，从 Xen 迁移到 KVM 需执行以下基本步骤：
      </para>
      <procedure>
        <step>
          <para>
            创建原始 Xen VM Guest 的备份副本。
          </para>
        </step>
        <step>
          <para>
            （可选）应用特定于半虚拟化 Guest 的更改。
          </para>
        </step>
        <step>
          <para>
            获取有关 Xen VM Guest 的信息，并将其更新为 KVM 对等项。
          </para>
        </step>
        <step>
          <para>
            关闭 Xen 主机上的 Guest，然后在 KVM 超级管理程序下运行新 Guest。
          </para>
        </step>
      </procedure>
      <warning>
        <title>无法实时迁移</title>
        <para>
          当源 VM Guest 正在运行时，无法将 Xen 实时迁移到 KVM。运行新的 KVM 就绪 VM Guest 之前，建议您关闭原始 Xen VM Guest。
        </para>
      </warning>
    </sect2>

    <sect2>
      <title>备份 Xen VM Guest</title>
      <para>
        要备份 Xen VM Guest，请执行以下步骤：
      </para>
      <procedure>
        <step>
          <para>
            识别您要迁移的相关 Xen Guest 并记住其 ID/名称。
          </para>
<screen><prompt>&gt; </prompt><command>sudo</command> virsh list --all
Id Name                 State
----------------------------------
 0 Domain-0             running
 1 SLES11SP3            running
[...]</screen>
        </step>
        <step>
          <para>
            关闭 Guest。可以通过关闭 Guest 操作系统或使用 <command>virsh</command> 执行此操作：
          </para>
<screen><prompt>&gt; </prompt><command>sudo</command> virsh shutdown SLES11SP3</screen>
        </step>
        <step>
          <para>
            将其配置备份到 XML 文件。
          </para>
<screen><prompt>&gt; </prompt><command>sudo</command> virsh dumpxml SLES11SP3 &gt; sles11sp3.xml</screen>
        </step>
        <step>
          <para>
            备份其磁盘映像文件。使用 <command>cp</command> 或 <command>rsync</command> 命令创建备份副本。请记住，比较好的做法始终是使用 <command>md5sum</command> 命令检查副本。
          </para>
        </step>
        <step>
          <para>
            备份映像文件之后，您可以使用以下命令再次启动 Guest
          </para>
<screen><prompt>&gt; </prompt><command>sudo</command> virsh start SLES11SP3</screen>
        </step>
      </procedure>
    </sect2>

    <sect2>
      <title>特定于半虚拟化 Guest 的更改</title>
      <para>
        如果您从半虚拟化 Xen Guest 进行迁移，请实施以下更改。可以使用 <literal>guestfs-tools</literal> 在运行中的 Guest 或已停止的 Guest 上执行此操作。
        
      </para>
      <important>
        <para>
          应用本节中所述的更改后，与迁移的 VM Guest 有关的映像文件将无法继续在 Xen 下使用。
        </para>
      </important>
      <sect3>
        <title>安装默认内核</title>
        <warning>
          <title>不会引导</title>
          <para>
            安装默认内核后，系统无法引导 Xen Guest。
          </para>
        </warning>
        <para>
          克隆 Xen Guest 磁盘映像以在 KVM 超级管理程序下使用之前，请确保该映像可在<emphasis>没有</emphasis> Xen 超级管理程序的情况下引导。这一点对于半虚拟化 Xen Guest 至关重要，因为它们通常包含一个特殊的 Xen 内核，并且通常未安装完整的 GRUB 2 引导加载程序。
        </para>
        <orderedlist spacing="normal">
          <listitem>
            <para>
              对于 SLES 11，请更新 <filename>/etc/sysconfig/kernel</filename> 文件。更改 <literal>INITRD_MODULES</literal> 参数，具体做法是去除所有 Xen 驱动程序，并将它们替换为 virtio 驱动程序。将
            </para>
<screen>INITRD_MODULES="xenblk xennet"</screen>
            <para>
              替换为
            </para>
<screen>INITRD_MODULES="virtio_blk virtio_pci virtio_net virtio_balloon"</screen>
            <para>
              对于 SLES 12，请在 <filename>/etc/dracut.conf.d/*.conf</filename> 中搜索 <literal>xenblk xennet</literal>，并将其替换为 <literal>virtio_blk virtio_pci virtio_net
              virtio_balloon</literal>
            </para>
          </listitem>
          <listitem>
            <para>
              半虚拟化 Xen Guest 运行特定的 Xen 内核。要在 KVM 下运行 Guest，您需要安装默认内核。
            </para>
            <note>
              <title>默认内核已安装</title>
              <para>
                对于全虚拟化 Guest，您无需安装默认内核，因为它已安装。
              </para>
            </note>
            <para>
              在 Xen Guest 上输入 <command>rpm -q kernel-default</command>，以确认默认内核是否已安装。如果未安装，请使用 <command>zypper in kernel-default</command> 安装。
            </para>
            <para>
              我们将用于在 KVM 下引导 Guest 的内核必须有可用的 <emphasis>virtio</emphasis>（半虚拟化）驱动程序。请运行以下命令确认是否如此。不要忘记将 <literal>5.3.18-8</literal> 替换为您的内核版本：
            </para>
<screen><prompt>&gt; </prompt><command>sudo</command> sudo find /lib/modules/5.3.18-8-default/kernel/drivers/ -name virtio*
/lib/modules/5.3.18-8-default/kernel/drivers/block/virtio_blk.ko
/lib/modules/5.3.18-8-default/kernel/drivers/char/hw_random/virtio-rng.ko
/lib/modules/5.3.18-8-default/kernel/drivers/char/virtio_console.ko
/lib/modules/5.3.18-8-default/kernel/drivers/crypto/virtio
...</screen>
          </listitem>
          <listitem>
            <para>
              更新 <filename>/etc/fstab</filename>。将所有存储设备从 <literal>xvda</literal> 更改为 <literal>vda</literal>。
            </para>
          </listitem>
          <listitem>
            <para>
              更新引导加载程序配置。在 Xen Guest 上输入 <command>rpm -q
              grub2</command>，以确认 GRUB 2 是否已安装。如果未安装，请使用 <command>zypper in
              grub2</command> 安装。
            </para>
            <para>
              现在，将新安装的默认内核设为默认的操作系统引导项。此外，去除/更新可能会引用特定于 Xen 的设备的内核命令行选项。您可以使用 YaST（<menuchoice><guimenu>系统</guimenu><guimenu>引导加载程序</guimenu></menuchoice>）或手动执行此操作。
            </para>
            <itemizedlist mark="bullet" spacing="normal">
              <listitem>
                <para>
                  列出所有 Linux 引导菜单项，以确定首选引导菜单项：
                </para>
<screen><prompt>&gt; </prompt>cat /boot/grub2/grub.cfg | grep 'menuentry '</screen>
                <para>
                  请记住您新安装的项目的序号（从零开始计数）。
                </para>
              </listitem>
              <listitem>
                <para>
                  将其设为默认引导菜单项：
                </para>
<screen><prompt>&gt; </prompt><command>sudo</command> grub2-set-default <replaceable>N</replaceable></screen>
                <para>
                  将 <replaceable>N</replaceable> 替换为之前查明的引导菜单项编号。
                </para>
              </listitem>
              <listitem>
                <para>
                  打开 <filename>/etc/default/grub</filename> 进行编辑，并查找 <option>GRUB_CMDLINE_LINUX_DEFAULT</option> 和 <option>GRUB_CMDLINE_LINUX_RECOVERY</option> 选项。去除或更新对特定于 Xen 的设备的所有引用。在下面的示例中，您可以将
                </para>
<screen>root=/dev/xvda1 disk=/dev/xvda console=xvc</screen>
                <para>
                  替换为
                </para>
<screen>root=/dev/vda1 disk=/dev/vda</screen>
                <para>
                  不要忘记去除对 <literal>xvc</literal> 型控制台（例如 <literal>xvc0</literal>）的所有引用。
                </para>
              </listitem>
            </itemizedlist>
          </listitem>
          <listitem>
            <para>
              更新 <filename>/boot/grub2</filename> 或 <filename>/boot/grub2-efi</filename> 目录（以 VM 使用的目录为准）中的 <filename>device.map</filename>。将所有存储设备从 <literal>xvda</literal> 更改为 <literal>vda</literal>。
            </para>
          </listitem>
          <listitem>
            <para>
              要导入新的默认设置，请运行
            </para>
<screen>grub2-mkconfig -o /boot/grub2/grub.cfg</screen>
          </listitem>
        </orderedlist>
      </sect3>
      <sect3>
        <title>更新 Guest 以在 KVM 下引导</title>
        <orderedlist spacing="normal">
          <listitem>
            <para>
              更新系统以使用默认串行控制台。列出配置的控制台，并去除 <literal>xvc?</literal> 控制台的符号链接。
            </para>
<screen><prompt>&gt; </prompt><command>sudo</command> ls -l /etc/systemd/system/getty.target.wants/
getty@tty1.service -&gt; /usr/lib/systemd/system/getty@.service
getty@xvc0.service -&gt; /usr/lib/systemd/system/getty@xvc0.service
getty@xvc1.service -&gt; /usr/lib/systemd/system/getty@xvc1.service

# rm /etc/systemd/system/getty.target.wants/getty@xvc?.service</screen>
          </listitem>
          <listitem>
            <para>
              更新 <filename>/etc/securetty</filename> 文件。将 <literal>xvc0</literal> 替换为 <literal>ttyS0</literal>。
            </para>
          </listitem>
        </orderedlist>
      </sect3>
    </sect2>

    <sect2>
      <title>更新 Xen VM Guest 配置</title>
      <para>
        本节介绍如何导出原始 Xen VM Guest 的配置，以及为了能够将该 Guest 作为 KVM Guest 导入到 <systemitem class="library">libvirt</systemitem> 中需对其实施的特定更改。
      </para>
      <sect3>
        <title>导出 Xen VM Guest 配置</title>
        <para>
          首先导出 Guest 的配置并保存到某个文件中。例如：
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> virsh dumpxml SLES11SP3
&lt;domain type='xen'&gt;
  &lt;name&gt;SLES11SP3&lt;/name&gt;
  &lt;uuid&gt;fa9ea4d7-8f95-30c0-bce9-9e58ffcabeb2&lt;/uuid&gt;
  &lt;memory&gt;524288&lt;/memory&gt;
  &lt;currentMemory&gt;524288&lt;/currentMemory&gt;
  &lt;vcpu&gt;1&lt;/vcpu&gt;
  &lt;bootloader&gt;/usr/bin/pygrub&lt;/bootloader&gt;
  &lt;os&gt;
    &lt;type&gt;linux&lt;/type&gt;
  &lt;/os&gt;
  &lt;clock offset='utc'/&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;restart&lt;/on_crash&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/lib/xen/bin/qemu-dm&lt;/emulator&gt;
    &lt;disk type='file' device='disk'&gt;
      &lt;driver name='file'/&gt;
      &lt;source file='/var/lib/libvirt/images/SLES_11_SP2_JeOS.x86_64-0.0.2_para.raw'/&gt;
      &lt;target dev='xvda' bus='xen'/&gt;
    &lt;/disk&gt;
    &lt;interface type='bridge'&gt;
      &lt;mac address='00:16:3e:2d:91:c3'/&gt;
      &lt;source bridge='br0'/&gt;
      &lt;script path='vif-bridge'/&gt;
    &lt;/interface&gt;
    &lt;console type='pty'&gt;
      &lt;target type='xen' port='0'/&gt;
    &lt;/console&gt;
    &lt;input type='mouse' bus='xen'/&gt;
    &lt;graphics type='vnc' port='-1' autoport='yes' keymap='en-us'/&gt;
  &lt;/devices&gt;
&lt;/domain&gt;
</screen>
        <para>
          <link xlink:href="https://libvirt.org/formatdomain.html"/> 上提供了有关 VM Guest 描述的 libvirt XML 格式的详细信息。
        </para>
      </sect3>
      <sect3>
        <title>对 Guest 配置的一般更改</title>
        <para>
          您需要对导出的 Xen Guest XML 配置进行一些一般性更改，方可使其在 KVM 超级管理程序下运行。以下规则对全虚拟化和半虚拟化 Guest 均适用。以下 XML 元素仅为示例，不需要将其包含在您的具体配置中。
        </para>
        <tip>
          <title>使用的约定</title>
          <para>
            为了表示 XML 配置文件中的节点，整个文档使用了 XPath 语法。例如，为了表示 <literal>&lt;domain&gt;</literal> 标记中的 <literal>&lt;name&gt;</literal>，
          </para>
<screen>&lt;domain&gt;
  &lt;name&gt;sles11sp3&lt;/name&gt;
&lt;/domain&gt;</screen>
          <para>
            本文档使用了 XPath 对等项 <literal>/domain/name</literal>。
          </para>
        </tip>
        <orderedlist spacing="normal">
          <listitem>
            <para>
              将 <literal>/domain</literal> 元素的 <literal>type</literal> 属性从 <literal>xen</literal> 更改为 <literal>kvm</literal>。
            </para>
          </listitem>
          <listitem>
            <para>
              去除 <literal>/domain/bootloader</literal> 元素部分。
            </para>
          </listitem>
          <listitem>
            <para>
              去除 <literal>/domain/bootloader_args</literal> 元素部分。
            </para>
          </listitem>
          <listitem>
            <para>
              将 <literal>/domain/os/type</literal> 元素值从 <literal>linux</literal> 更改为 <literal>hvm</literal>。
            </para>
          </listitem>
          <listitem>
            <para>
              在 <literal>/domain/os</literal> 元素下添加 <literal>&lt;boot dev="hd"/&gt;</literal>。
            </para>
          </listitem>
          <listitem>
            <para>
              在 <literal>/domain/os/type</literal> 元素中添加 <literal>arch</literal> 属性。可接受的值为 <literal>arch=”x86_64”</literal> 或 <literal>arch=”i686”</literal>
            </para>
          </listitem>
          <listitem>
            <para>
              将 <literal>/domain/devices/emulator</literal> 元素从 <literal>/usr/lib/xen/bin/qemu-dm'</literal> 更改为 <literal>/usr/bin/qemu-kvm</literal>。
            </para>
          </listitem>
          <listitem>
            <para>
              对与半虚拟化 (PV) Guest 关联的每个磁盘进行以下更改：
            </para>
            <itemizedlist mark="bullet" spacing="normal">
              <listitem>
                <para>
                  将 <literal>/domain/devices/disk/driver</literal> 元素的 <literal>name</literal> 属性从 <literal>file</literal> 更改为 <literal>qemu</literal>，并添加 <literal>type</literal> 属性以指定磁盘类型。例如，有效选项包括 <literal>raw</literal> 和 <literal>qcow2</literal>。
                </para>
              </listitem>
              <listitem>
                <para>
                  将 <literal>/domain/devices/disk/target</literal> 元素的 <literal>dev</literal> 属性从 <literal>xvda</literal> 更改为 <literal>vda</literal>。
                </para>
              </listitem>
              <listitem>
                <para>
                  将 <literal>/domain/devices/disk/target</literal> 元素的 <literal>bus</literal> 属性从 <literal>xen</literal> 更改为 <literal>virtio</literal>。
                </para>
              </listitem>
            </itemizedlist>
          </listitem>
          <listitem>
            <para>
              对每个网络接口卡进行以下更改：
            </para>
            <itemizedlist mark="bullet" spacing="normal">
              <listitem>
                <para>
                  如果 <literal>/domain/devices/interface</literal> 中定义了 <literal>model</literal>，请将其 <literal>type</literal> 属性值更改为 <literal>virtio</literal>
                </para>
<screen>&lt;model type=”virtio”&gt;</screen>
              </listitem>
              <listitem>
                <para>
                  删除所有 <literal>/domain/devices/interface/script</literal> 部分。
                </para>
              </listitem>
              <listitem>
                <para>
                  删除其 <literal>dev</literal> 属性以 <literal>vif</literal>、<literal>vnet</literal> 或 <literal>veth</literal> 开头的所有 <literal>/domain/devices/interface/target</literal> 元素。如果使用的是自定义网络，请将 <literal>dev</literal> 值更改为该目标。
                </para>
              </listitem>
            </itemizedlist>
          </listitem>
          <listitem>
            <para>
              去除 <literal>/domain/devices/console</literal> 元素部分（如果存在）。
            </para>
          </listitem>
          <listitem>
            <para>
              去除 <literal>/domain/devices/serial</literal> 元素部分（如果存在）。
            </para>
          </listitem>
          <listitem>
            <para>
              将 <literal>/domain/devices/input</literal> 元素中的 <literal>bus</literal> 属性从 <literal>xen</literal> 更改为 <literal>ps2</literal>。
            </para>
          </listitem>
          <listitem>
            <para>
              在 <literal>/domain/devices</literal> 元素下添加以下有关内存气球功能的元素。
            </para>
<screen>&lt;memballoon model="virtio"/&gt;</screen>
          </listitem>
        </orderedlist>
        <tip>
          <title>设备名</title>
          <para>
            <literal>&lt;target dev='hda' bus='ide'/&gt;</literal> 控制在哪个设备下向 Guest 操作系统公开磁盘。<literal>dev</literal> 属性指示<quote>逻辑</quote>设备名称。我们无法保证实际指定的设备名称与 Guest 操作系统中的设备名称对应。因此，您可能需要更改引导加载程序命令行上的磁盘映射。例如，如果引导加载程序预期根磁盘为 <literal>hda2</literal>，但 KVM 仍将其视为 <literal>sda2</literal>，请将引导加载程序命令行从
          </para>
<screen>[...] root=/dev/hda2 resume=/dev/hda1 [...]</screen>
          <para>
            更改为
          </para>
<screen>[...] root=/dev/sda2 resume=/dev/sda1 [...]</screen>
          <para>
            对于半虚拟化 <literal>xvda</literal> 设备，请将其更改为：
          </para>
<screen>[...] root=/dev/vda2 resume=/dev/vda1 [...]</screen>
          <para>
            否则，VM Guest 将拒绝在 KVM 环境中引导。
          </para>
        </tip>
      </sect3>
      <sect3>
        <title>目标 KVM Guest 配置</title>
        <para>
          实施上述所有修改后，您的 KVM Guest 的最终配置如下所示：
        </para>
<screen>
&lt;domain type='kvm'&gt;
  &lt;name&gt;SLES11SP3&lt;/name&gt;
  &lt;uuid&gt;fa9ea4d7-8f95-30c0-bce9-9e58ffcabeb2&lt;/uuid&gt;
  &lt;memory&gt;524288&lt;/memory&gt;
  &lt;currentMemory&gt;524288&lt;/currentMemory&gt;
  &lt;vcpu cpuset='0-3'&gt;1&lt;/vcpu&gt;
  &lt;os&gt;
    &lt;type arch=”x86_64”&gt;hvm&lt;/type&gt;
    &lt;boot dev="hd"/&gt;
  &lt;/os&gt;
  &lt;clock offset='utc'/&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;restart&lt;/on_crash&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/bin/qemu-kvm&lt;/emulator&gt;
    &lt;disk type='file' device='disk'&gt;
      &lt;driver name='qemu' type="raw"/&gt;
      &lt;source file='/var/lib/libvirt/images/SLES_11_SP2_JeOS.x86_64-0.0.2_para.raw'/&gt;
      &lt;target dev='vda' bus='virtio'/&gt;
    &lt;/disk&gt;
    &lt;interface type='bridge'&gt;
      &lt;mac address='00:16:3e:2d:91:c3'/&gt;
      &lt;source bridge='br0'/&gt;
    &lt;/interface&gt;
    &lt;input type='mouse' bus='usb'/&gt;
    &lt;graphics type='vnc' port='5900' autoport='yes' keymap='en-us'/&gt;
    &lt;memballoon model="virtio"/&gt;
  &lt;/devices&gt;
&lt;/domain&gt;

</screen>
        <para>
          将配置保存到主目录下的某个文件中，例如，保存为 <filename>SLES11SP3.xml</filename>。将其导入之后，它会复制到默认的 <filename>/etc/libvirt/qemu</filename> 目录中。
        </para>
      </sect3>
    </sect2>

    <sect2>
      <title>迁移 VM Guest</title>
      <para>
        更新 VM Guest 配置并对 Guest 操作系统实施必要的更改之后，请关闭原始 Xen Guest 并在 KVM 超级管理程序下运行其克隆版本。
      </para>
      <procedure>
        <step>
          <para>
            在控制台中以 <systemitem class="username">root</systemitem> 身份运行 <command>shutdown
            -h now</command>，以关闭 Xen 主机上的 Guest。
          </para>
        </step>
        <step>
          <para>
            根据需要复制与 VM Guest 关联的磁盘映像。默认配置要求将 Xen 磁盘文件从 <filename>/var/lib/xen/images</filename> 复制到 <filename>/var/lib/kvm/images</filename>。如果您之前未创建 VM Guest，则可能需要以 <systemitem class="username">root</systemitem> 身份创建 <filename>/var/lib/kvm/images</filename> 目录。
          </para>
        </step>
        <step>
          <para>
            创建新域，然后将其注册到 <systemitem class="library">libvirt</systemitem> 中：
          </para>
<screen><prompt>&gt; </prompt><command>sudo</command> virsh define SLES11SP3.xml
 Domain SLES11SP3 defined from SLES11SP3.xml</screen>
        </step>
        <step>
          <para>
            校验新 Guest 是否包含在 KVM 配置中。
          </para>
<screen><prompt>&gt; </prompt>virsh list –all</screen>
        </step>
        <step>
          <para>
            创建域之后，您可以将其启动：
          </para>
<screen><prompt>&gt; </prompt><command>sudo</command> virsh start SLES11SP3
 Domain SLES11SP3 started</screen>
        </step>
      </procedure>
    </sect2>
  </sect1>
  <sect1>
    <title>更多信息</title>

    <para>
      有关 libvirt 的详细信息，请参见 <link xlink:href="https://libvirt.org"/>。
    </para>

    <para>
      <link xlink:href="https://libvirt.org/formatdomain.html"/> 上提供了有关 <systemitem class="library">libvirt</systemitem> XML 格式的更多细节。
    </para>

    <para>
      <link xlink:href="https://documentation.suse.com/"/> 上的 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 文档中提供了有关 Xen 和 KVM 虚拟化的详细信息。
    </para>
  </sect1>
</chapter>
