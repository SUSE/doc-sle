<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_nfs.xml" version="5.0" xml:id="cha.nfs">



 <title>Compartilhando sistemas de arquivos com o NFS</title>
 <info>
  <abstract>
   <para>
    Distribuir e compartilhar sistemas de arquivos em uma rede é uma tarefa comum em ambientes corporativos. O reconhecido sistema de arquivos de rede (<emphasis>NFS</emphasis>) funciona com o <emphasis>NIS</emphasis>, o protocolo de yellow pages. Para um protocolo mais seguro que funcione com <emphasis>LDAP</emphasis> e Kerberos, marque <emphasis>NFSv4</emphasis> (padrão). Juntamente com o pNFS, é possível eliminar gargalos no desempenho.
   </para>

   <para>
    O NFS com o NIS torna uma rede transparente para o usuário. Com o NFS, é possível distribuir sistemas de arquivos arbitrários pela rede. Com a configuração adequada, os usuários sempre ficam no mesmo ambiente, independentemente do terminal que estejam usando.
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes (sim)</dm:translation>
  </dm:docmanager>
 </info>
<indexterm> <primary>NFS</primary> </indexterm> <indexterm> <primary>Network File System</primary> <see>NFS</see> </indexterm>
 
 <sect1 xml:id="sec.nfs.term">
  <title>Terminologia</title>

  <para>
   Veja a seguir os termos usados no módulo do YaST.
  </para>



  <variablelist>
   <varlistentry>
    <term>Exportações</term>
    <listitem>
     <para>
      Um diretório <emphasis>exportado</emphasis> por um servidor NFS, que os clientes podem integrar a seus sistemas.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Cliente NFS</term>
    <listitem>
     <para>
      O cliente NFS é um sistema que usa serviços NFS de um servidor NFS pelo protocolo NFS (Network File System – Sistema de Rede de Arquivos). O protocolo TCP/IP já está integrado ao kernel do Linux; não há necessidade de instalar software adicional.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Servidor NFS</term>
    <listitem>
     <para>
      O servidor NFS fornece serviços NFS aos clientes. Um servidor em execução depende dos seguintes daemons: <systemitem class="daemon">nfsd</systemitem> (worker), <systemitem class="daemon">idmapd</systemitem> (mapeamentos de nome de grupo e usuário para IDs e vice versa), <systemitem class="daemon">statd</systemitem> (bloqueio de arquivos) e <systemitem class="daemon">mountd</systemitem> (solicitações de montagem).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFSv3</term>
    <listitem>
     <para>
      NFSv3 é a implementação da versão 3, o <quote>antigo</quote> NFS sem informações de estado que suporta autenticação do cliente.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFSv4</term>
    <listitem>
     <para>
      NFSv4 é a nova implementação da versão 4 que suporta autenticação do usuário segura pelo kerberos. O NFSv4 requer uma única porta e, portanto, é mais adequado para ambientes protegidos por firewall do que o NFSv3.
     </para>
     <para>
      O protocolo é especificado como <link xlink:href="http://tools.ietf.org/html/rfc3530"/>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>pNFS</term>
    <listitem>
     <para>
      NFS Paralelo, o protocolo de extensão do NFSv4. Qualquer cliente do pNFS pode acessar diretamente os dados em um servidor NFS.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>

 <sect1 os="sled" xml:id="sec.nfs.installation-sled">


  <title>Instalando o servidor NFS</title>

  <para>
   Para instalar e configurar um servidor NFS, consulte a documentação do SUSE Linux Enterprise Server.
  </para>
 </sect1>

 
 
 <sect1 xml:id="sec.nfs.configuring-nfs-clients">
  <title>Configurando clientes</title>

  <para>
   Para configurar seu host como cliente NFS, você não precisa instalar software adicional. Todos os pacotes necessários são instalados por padrão.
  </para>

  <sect2 xml:id="sec.nfs.import-yast2">
   <title>Importando sistemas de arquivos com o YaST</title><indexterm> <primary>NFS</primary> <secondary>clientes</secondary> </indexterm>
   <para>
    Usuários autorizados podem montar diretórios NFS de um servidor NFS na árvore de arquivos local usando o módulo de cliente NFS do YaST. Proceda da seguinte maneira:
   </para>
   <procedure xml:id="pro.nfs.import-yast2">
    <title>Importando diretórios NFS</title>
    <step>
     <para>
      Inicie o módulo de cliente NFS do YaST.
     </para>
    </step>

    <step>
     <para>
      Clique em <guimenu>Adicionar</guimenu> na guia <guimenu>Compartilhamentos NFS</guimenu>. Digite o nome de host do servidor NFS, o diretório a ser importado e o ponto de montagem desse diretório localmente.
     </para>
    </step>


    <step>
     <para>
      Ao usar o NFSv4, selecione <guimenu>Habilitar NFSv4</guimenu> na guia <guimenu>Configurações do NFS</guimenu>. O <guimenu>Nome de Domínio NFSv4</guimenu> também deve incluir o mesmo valor usado pelo servidor NFSv4. O domínio padrão é <literal>localdomain</literal>.
     </para>
    </step>
    <step>
     <para>
      Para usar a autenticação Kerberos para o NFS, é preciso que a segurança GSS esteja habilitada. Selecione <guimenu>Habilitar Segurança GSS</guimenu>.
     </para>
    </step>
    <step>
     <para>
      Habilite <guimenu>Abrir Porta no Firewall</guimenu> na guia <guimenu>Configurações do NFS</guimenu>, se você usa um Firewall e deseja permitir o acesso de computadores remotos ao serviço. O status do firewall é mostrado próximo à caixa de seleção. 
     </para>
    </step>

    <step>
     <para>
      Clique em <guimenu>OK</guimenu> para gravar as mudanças.
     </para>
    </step>
   </procedure>
   <para>
    A configuração é gravada em <filename>/etc/fstab</filename> e os sistemas de arquivos especificados são montados. Quando você iniciar o cliente de configuração do YaST posteriormente, ele também lerá a configuração existente desse arquivo.
   </para>
   <tip>
    <title>NFS como sistema de arquivos raiz</title>
    <para>
     Em sistemas (sem disco) nos quais a partição raiz é montada por rede como compartilhamento NFS, você precisa ter cuidado ao configurar o dispositivo de rede pelo qual o compartilhamento NFS pode ser acessado.
    </para>
    <para>
     Ao encerrar ou reinicializar o sistema, a ordem de processamento padrão é desativar as conexões de rede e, na sequência, desmontar a partição raiz. Com a raiz NFS, essa ordem causa problemas, já que a partição raiz não pode ser completamente desmontada porque a conexão de rede com o compartilhamento NFS já não está ativada. Para impedir que o sistema desative o dispositivo de rede relevante, abra a guia de configuração do dispositivo de rede, conforme descrito na <xref linkend="sec.basicnet.yast.change.start"/>, e escolha <guimenu>Em NFSroot</guimenu> no painel <guimenu>Ativação do Dispositivo</guimenu>.
    </para>
   </tip>

  </sect2>

  <sect2 xml:id="sec.nfs.import">
   <title>Importando sistemas de arquivos manualmente</title>
<indexterm> <primary>NFS</primary> <secondary>importando</secondary> </indexterm> <indexterm> <primary>NFS</primary> <secondary>montando</secondary> </indexterm>

   <para>
    O pré-requisito para importar os sistemas de arquivos manualmente de um servidor NFS é um mapeador de portas RPC em execução. O serviço <option>nfs</option> se encarrega de iniciá-lo apropriadamente; portanto, inicie-o digitando <command>systemctl start nfs</command> como <systemitem class="username">root</systemitem>. Em seguida, os sistemas de arquivos remotos podem ser montados no sistema de arquivos como partições locais usando <command>mount</command>:
   </para>
<screen>mount <replaceable>host</replaceable>:<replaceable>remote-path</replaceable><replaceable>local-path</replaceable></screen>
   <para>
    Para importar os diretórios de usuário da máquina do <systemitem>nfs.example.com</systemitem>, por exemplo, use:
   </para>
<screen>mount nfs.example.com:/home /home</screen>
   <sect3 xml:id="sec.nfs.automount">
    <title>Usando o serviço de montagem automática</title>
    <para>
     O daemon autofs pode ser usado para montar sistemas de arquivos remotos automaticamente. Adicione a seguinte entrada ao arquivo <filename>/etc/auto.master</filename>:
    </para>
<screen>/nfsmounts /etc/auto.nfs</screen>
    <para>
     Agora, o diretório <filename>/nfsmounts</filename> atuará como raiz para todas as montagens NFS no cliente se o arquivo <filename>auto.nfs</filename> for preenchido adequadamente. O nome <filename>auto.nfs</filename> foi escolhido por mera conveniência, você pode escolher qualquer nome. Adicione entradas ao <filename>auto.nfs</filename> para todas as montagens NFS da seguinte maneira:
    </para>
<screen>localdata -fstype=nfs server1:/data
nfs4mount -fstype=nfs4 server2:/</screen>
    <para>
     Ative as configurações com <command>systemctl start autofs</command> como <systemitem class="username">root</systemitem>. Neste exemplo, <filename>/nfsmounts/localdata</filename>, o diretório <filename>/data</filename> do <systemitem>server1</systemitem>, é montado com NFS e <filename>/nfsmounts/nfs4mount</filename>, do <systemitem>server2</systemitem>, é montado com NFSv4.
    </para>
    <para>
     Se o arquivo <filename>/etc/auto.master</filename> for editado enquanto o serviço autofs estiver em execução, o automounter deverá ser reiniciado com <command>systemctl restart autofs</command> para as mudanças entrarem em vigor.
    </para>
   </sect3>
   <sect3 xml:id="sec.nfs.fstab">
    <title>Editando <filename>/etc/fstab</filename> manualmente</title>
    <para>
     Uma entrada de montagem típica do NFSv3 em <filename>/etc/fstab</filename> tem aparência semelhante a esta:
    </para>
<screen>nfs.example.com:/data /local/path nfs rw,noauto 0 0</screen>
    <para>
     Para montagens do NFSv4, use <literal>nfs4</literal> em vez de <literal>nfs</literal> na terceira coluna:
    </para>
<screen>nfs.example.com:/data /local/pathv4 nfs4 rw,noauto 0 0</screen>
    <para>
     A opção <literal>noauto</literal> impede que o sistema de arquivos seja montado automaticamente na inicialização. Se desejar montar o respectivo sistema de arquivos manualmente, é possível abreviar o comando de montagem especificando apenas o ponto de montagem:
    </para>
<screen>mount /local/path</screen>
    <note>
     <title>Montando na inicialização</title>
     <para>
      Se você não digitar a opção <literal>noauto</literal>, os scripts init do sistema gerenciarão a montagem dos sistemas de arquivos na inicialização.
     </para>
    </note>
   </sect3>
  </sect2>

  <sect2 xml:id="sec.nfs.pnfs">
   <title>NFS paralelo (pNFS)</title>
   <para>
    NFS é um dos protocolos mais antigos, desenvolvido nos anos 80. Em geral, o NFS é suficiente para compartilhar arquivos pequenos. Entretanto, para transferir arquivos grandes ou quando um número elevado de clientes precisa acessar os dados, o servidor NFS torna-se um gargalo e afeta significativamente o desempenho do sistema. Isso ocorre porque os arquivos aumentam de tamanho rapidamente, mas a velocidade relativa da Ethernet não consegue acompanhar esse aumento.
   </para>
   <para>
    Quando você solicita um arquivo de um servidor NFS <quote>normal</quote>, o servidor procura os metadados do arquivo, coleta todos os dados e os transfere pela rede até o cliente. No entanto, o gargalo no desempenho torna-se aparente independentemente do tamanho dos arquivos:
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      Com os arquivos pequenos, a maior parte do tempo é gasta para coletar os metadados.
     </para>
    </listitem>
    <listitem>
     <para>
      Com os arquivos grandes, a maior parte do tempo é gasta para transferir os dados do servidor para o cliente.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    O pNFS, ou NFS paralelo, supera essa limitação, pois ele separa os metadados do sistema de arquivos do local dos dados. Para isso, o pNFS requer dois tipos de servidores:
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      Um <emphasis>servidor de controle</emphasis> ou de <emphasis>metadados</emphasis> que controla todo o tráfego que não seja de dados
     </para>
    </listitem>
    <listitem>
     <para>
      Um ou mais <emphasis>servidores de armazenamento</emphasis> para armazenar os dados
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Os servidores de metadados e de armazenamento formam um único servidor NFS lógico. Para o cliente ler ou gravar, o servidor de metadados informa ao cliente NFSv4 qual servidor de armazenamento deve ser usado para acessar os pacotes de arquivos. O cliente pode acessar os dados diretamente no servidor.
   </para>
   <para>
    O SUSE Linux Enterprise suporta pNFS apenas no cliente.
   </para>
   <sect3 xml:id="sec.nfs.pnfs.yast">
    <title>Configurando o cliente pNFS com o YaST</title>
    <para>
     Siga a descrição no <xref linkend="pro.nfs.import-yast2"/>, mas clique na caixa de seleção <guimenu>pNFS (v4.1)</guimenu> e, opcionalmente, em <guimenu>Compartilhamento NFSv4</guimenu>. O YaST executa todas as etapas necessárias e grava todas as opções exigidas no arquivo <filename>/etc/exports</filename>. <remark>toms 2013-02-15:
           Is that enough? Any other files for pNFS?</remark>
    </para>
   </sect3>
   <sect3 xml:id="sec.nfs.pnfs.manual">
    <title>Configurando o cliente pNFS manualmente</title>
    <para>
     Para começar, consulte a <xref linkend="sec.nfs.import"/>. A maior parte da configuração é feita pelo servidor NFSv4. Para o pNFS, a única diferença é adicionar a opção <option>minorversion</option> e o servidor de metadados <replaceable>MDS_SERVER</replaceable> ao comando <command>mount</command>:
    </para>
<screen>mount -t nfs4 -o minorversion=1 <replaceable>MDS_SERVER</replaceable> <replaceable>MOUNTPOINT</replaceable></screen>
    <para>
     Para ajudar na depuração, mude o valor no sistema de arquivos <filename>/proc</filename>:
    </para>
<screen>echo 32767 &gt; /proc/sys/sunrpc/nfsd_debug
echo 32767 &gt; /proc/sys/sunrpc/nfs_debug</screen>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.nfs.info">
  <title>Para obter mais informações</title>

  <para>
   Além das páginas de manual de <command>exports</command>, <command>nfs</command> e <command>mount</command>, há informações disponíveis sobre como configurar servidores e clientes NFS em <filename>/usr/share/doc/packages/nfsidmap/README</filename>. Para mais documentações online, consulte os seguintes sites na Web:
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     A documentação técnica online encontra-se no <link xlink:href="http://nfs.sourceforge.net/">SourceForge</link>.
    </para>
   </listitem>
   <listitem>
    <para>
     Para obter instruções sobre como configurar o NFS que usa Kerberos, consulte o documento <link xlink:href="http://www.citi.umich.edu/projects/nfsv4/linux/krb5-setup.html">NFS Version 4 Open Source Reference Implementation</link> (Implementação da referência de código-fonte aberto do NFSv4).
    </para>
   </listitem>
   <listitem>
    <para>
     Se você tiver dúvidas sobre o NFSv4, consulte as <link xlink:href="http://www.citi.umich.edu/projects/nfsv4/linux/faq/">Perguntas frequentes do Linux NFSv4</link>.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
