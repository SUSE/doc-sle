<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="vnc.xml" version="5.0" xml:id="cha.vnc">
 <title>Acesso remoto com VNC</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes (sim)</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    O VNC (Virtual Network Computing) permite controlar um computador remoto por uma área de trabalho gráfica (ao contrário do acesso remoto a shell). O VNC é independente de plataforma e permite acessar a máquina remota de qualquer sistema operacional.
   </para>

   <para>
    O <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> suporta dois tipos diferentes de sessões VNC: sessões únicas, que permanecem <quote>ativas</quote> enquanto a conexão VNC do cliente está ativada, e sessões persistentes, que permanecem <quote>ativas</quote> até serem explicitamente terminadas.
   </para>
  </abstract>
 </info>
 <note>
  <title>Tipos de sessão</title>
  <para>
   Uma máquina é capaz de oferecer ambos os tipos de sessões simultaneamente em portas diferentes, mas uma sessão aberta não pode ser convertida de um tipo em outro.
  </para>
 </note>
 
 <sect1 xml:id="sec.vnc.viewer">
  <title>Cliente <command>vncviewer</command></title>

  <para>
   Para se conectar a um serviço VNC fornecido por um servidor, é necessário um cliente. O padrão no <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> é o <command>vncviewer</command>, incluído no pacote <systemitem class="resource">tigervnc</systemitem>.
  </para>

  <sect2 xml:id="sec.vnc.viewer.connectcli">
   <title>Conectando-se por meio da CLI do vncviewer</title>
   <para>
    Para iniciar o viewer do VNC e começar uma sessão com o servidor, use o comando:
   </para>
<screen>vncviewer jupiter.example.com:1</screen>
   <para>
    Em vez do número de exibição do VNC, você também pode especificar o número da porta com dois-pontos duplos:
   </para>
<screen>vncviewer jupiter.example.com::5901</screen>
   <note>
    <title>Número de Exibição ou de Porta</title>
    <para>
     O número real de exibição ou de porta especificado no cliente VNC deve ser igual ao número selecionado pelo comando <command>vncserver</command> na máquina de destino. Consulte a <xref linkend="sec.vnc.persistent"/> para obter mais informações.
    </para>
   </note>
  </sect2>

  <sect2 xml:id="sec.vnc.viewer.connectgui">
   <title>Conectando-se por meio da GUI do vncviewer</title>
   <para>
    Ao executar o <command>vncviewer</command> sem especificar <command>--listen</command> nem um host ao qual se conectar, será exibida uma janela solicitando detalhes da conexão. Informe o host no campo <guimenu>Servidor VNC</guimenu>, conforme mostrado na <xref linkend="sec.vnc.viewer.connectcli"/>, e clique em <guimenu>Conectar</guimenu>.
   </para>
   <figure xml:id="fig.vnc.viewer.connectgui">
    <title>vncviewer</title>
    <mediaobject>
     <textobject role="description"><phrase>vncviewer solicitando detalhes da conexão</phrase> </textobject> <imageobject role="html"> <imagedata fileref="vnc_connect.png" format="PNG"/> </imageobject> <imageobject role="fo"> <imagedata fileref="vnc_connect.png" format="PNG"/> </imageobject>
    </mediaobject>
   </figure>
  </sect2>

  <sect2 xml:id="sec.vnc.viewer.encrypt">
   <title>Notificação de conexões não criptografadas</title>
   <para>
    O protocolo VNC suporta diferentes tipos de conexões criptografadas, o que não deve ser confundido com autenticação de senha. Se uma conexão não usar TLS, o texto <quote>(Conexão não criptografada)!</quote> poderá aparecer no título da janela do viewer do VNC.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.vnc.one-time">
  <title>Sessões VNC únicas</title>

  <para>
   Uma sessão única é iniciada por um cliente remoto. Ela inicia uma tela gráfica de login no servidor. Desse modo, você pode escolher o usuário que inicia a sessão e, se suportado pelo gerenciador de login, o ambiente de área de trabalho. Quando você terminar a conexão do cliente com essa sessão VNC, todos os aplicativos iniciados nessa sessão também serão terminados. Sessões VNC únicas não podem ser compartilhadas, mas é possível ter várias sessões em um único host ao mesmo tempo.
  </para>

  <procedure xml:id="pro.vnc.one-time.activate">
   <title>Habilitando sessões VNC únicas</title>
   <step>
    <para>
     Inicie o <menuchoice> <guimenu>YaST</guimenu> <guimenu>Serviços de Rede</guimenu> <guimenu>Administração Remota (VNC)</guimenu> </menuchoice>.
    </para>
   </step>
   <step>
    <para>
     Marque <guimenu>Permitir Administração Remota</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Se necessário, marque também <guimenu>Abrir Porta no Firewall</guimenu> (por exemplo, quando a interface de rede estiver configurada para ficar na Zona Externa). Se você tem mais de uma interface de rede, restrinja a abertura de portas no firewall a uma interface específica em <guimenu>Detalhes do Firewall</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Confirme as suas configurações clicando em <guimenu>Concluir</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Caso nem todos os pacotes necessários já estejam disponíveis, aprove a instalação dos pacotes ausentes.
    </para>
   </step>
  </procedure>

  <sect2 xml:id="sec.vnc.one-time.configs">
   <title>Configurações disponíveis</title>
   <para>
    A configuração padrão no <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> confere às sessões uma resolução de 1024 x 768 pixels com profundidade de cores de 16 bits. As sessões estão disponíveis nas portas <systemitem class="resource">5901</systemitem> para viewers VNC <quote>regulares</quote> (equivalente à exibição VNC <literal>1</literal>) e na porta <systemitem class="resource">5801</systemitem> para browsers da Web.
   </para>
   <para>
    É possível disponibilizar outras configurações em portas diferentes.<phrase os="sled"> Peça os detalhes ao administrador do sistema, se você precisar modificar a configuração.</phrase>
   </para>
   <para>
    Os números de exibição VNC e os números de exibição X são independentes nas sessões únicas. Um número de exibição VNC é atribuído manualmente a todas as configurações suportadas pelo servidor (:1 no exemplo acima). Sempre que uma sessão VNC é iniciada com uma das configurações, ela recebe automaticamente um número de exibição X livre.
   </para>
   <para>
    Por padrão, tanto o cliente quanto o servidor VNC tentam se comunicar de forma segura por meio de um certificado SSL autoassinado, que será gerado após a instalação. É possível usar o padrão ou substituí-lo pelo seu próprio certificado. Ao usar o certificado autoassinado, você precisa confirmar sua assinatura antes da primeira conexão, tanto no viewer do VNC quanto no browser da web. O cliente Java é atendido por HTTPS, usando o mesmo certificado do VNC.
   </para>
  </sect2>

  <sect2 xml:id="sec.vnc.one-time.connect">
   <title>Iniciando uma sessão VNC única</title>
   <para>
    Para conectar-se a uma sessão VNC persistente, é preciso instalar o viewer do VNC. Consulte também a <xref linkend="sec.vnc.viewer"/>. Se preferir, use um browser da Web compatível com Java para ver a sessão VNC digitando o seguinte URL: <literal>http://jupiter.example.com:5801</literal>
   </para>
  </sect2>

  <sect2 xml:id="sec.vnc.one-time.config">
   <title>Configurando sessões VNC únicas</title>
   <para>
    Você poderá ignorar esta seção se não precisar nem desejar modificar a configuração padrão.
   </para>
   <para>
    As sessões VNC únicas são iniciadas pelo daemon <systemitem class="daemon">xinetd</systemitem>. Um arquivo de configuração está localizado em <filename>/etc/xinetd.d/vnc</filename>. Por padrão, ele oferece seis blocos de configuração: três para viewers VNC (<literal>vnc1</literal> a <literal>vnc3</literal>) e três para atender a um applet Java (<literal>vnchttpd1</literal> a <literal>vnchttpd3</literal>). Por padrão, apenas <literal>vnc1</literal> e <literal>vnchttpd1</literal> estão ativos.
   </para>
   <para>
    Para ativar uma configuração, comente a linha <literal>disable = yes</literal> com o caractere <literal>#</literal> na primeira coluna ou remova totalmente essa linha. Para desativar uma configuração, remova o comentário ou adicione a linha.
   </para>
   <para>
    O servidor <command>Xvnc</command> pode ser configurado pela opção <literal>server_args</literal>. Consulte <command>Xnvc --help</command> para obter a lista de opções.
   </para>
   <para>
    Ao adicionar configurações padrão, certifique-se de que elas não usem portas já em uso por outras configurações, outros serviços ou sessões VNC persistentes existentes no mesmo host.
   </para>
   <para>
    Ative as mudanças na configuração digitando o seguinte comando:
   </para>
<screen>sudo systemctl reload xinetd</screen>
   <important>
    <title>Firewall e portas VNC</title>
    <para>
     Ao ativar a Administração Remota conforme descrito no <xref linkend="pro.vnc.one-time.activate"/>, as portas <systemitem class="resource">5801</systemitem> e <systemitem class="resource">5901</systemitem> são abertas no firewall. Se a interface de rede que atende às sessões VNC for protegida por firewall, será necessário abrir manualmente as respectivas portas ao ativar portas adicionais para as sessões VNC. Consulte o <xref linkend="cha.security.firewall"/> para obter instruções.
    </para>
   </important>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.vnc.persistent">
  <title>Sessões VNC persistentes</title>

  <para>
   Uma sessão VNC persistente é iniciada no servidor. A sessão e todos os aplicativos iniciados nessa sessão são executados independentemente das conexões do cliente até a sessão ser terminada.
  </para>

  <para>
   É possível acessar uma sessão persistente de vários clientes ao mesmo tempo. Isso é ideal para fins de demonstração em que um cliente tem acesso total, e todos os outros têm acesso apenas exibição. Outro cenário de uso são treinamentos em que o instrutor pode precisar acessar a área de trabalho do aluno. Mas, na maioria das vezes, você possivelmente não vai querer compartilhar sua sessão VNC. 
  </para>

  <para>
   Ao contrário das sessões únicas que iniciam um gerenciador de exibição, uma sessão persistente inicia uma área de trabalho pronta para funcionar executada como o usuário que iniciou a sessão VNC. O acesso a sessões persistentes é protegido por uma senha.
  </para>

  <para>
   O acesso às sessões persistentes é protegido por dois tipos de senhas possíveis:
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     uma senha regular que permite acesso total ou
    </para>
   </listitem>
   <listitem>
    <para>
     uma senha opcional apenas exibição que permite acesso não interativo (apenas exibição).
    </para>
   </listitem>
  </itemizedlist>

  <para>
   Uma sessão pode ter várias conexões de cliente de ambos os tipos de uma só vez.
  </para>

  <procedure xml:id="pro.vnc.persistent.activate">
   <title>Iniciando uma sessão VNC persistente</title>
   <step>
    <para>
     Abra um shell e verifique se você está conectado como o usuário proprietário da sessão VNC.

    </para>
   </step>
   <step>
    <para>
     Se a interface de rede que atende às sessões VNC for protegida por firewall, será necessário abrir manualmente a porta usada pela sessão no firewall. Se você iniciar várias sessões, poderá também abrir uma faixa de portas. Consulte o <xref linkend="cha.security.firewall"/> para obter os detalhes sobre como configurar o firewall.
    </para>
    <para>
     O <command>vncserver</command> usa as portas <systemitem class="resource">5901</systemitem> para exibição <literal>:1</literal>, <systemitem class="resource">5902</systemitem> para exibição <literal>:2</literal>, e assim por diante. Para sessões persistentes, a exibição VNC e a exibição X geralmente têm o mesmo número.
    </para>
   </step>
   <step>
    <para>
     Para iniciar uma sessão com resolução de 1024 x 769 pixels e profundidade de cores de 16 bits, digite o seguinte comando:
    </para>
<screen>vncserver -geometry 1024x768 -depth 16</screen>
    <para>
     O comando <command>vncserver</command> escolhe um número de exibição não usado quando nenhum número é especificado e imprime essa escolha. Consulte <command>man 1 vncserver</command> para ver mais opções.
    </para>
   </step>
  </procedure>

  <para>
   Quando o <command>vncserver</command> é executado pela primeira vez, ele pede uma senha para acesso total à sessão. Se necessário, forneça também uma senha de acesso apenas exibição à sessão.
  </para>

  <para>
   A(s) senha(s) inserida(s) aqui também será(ão) usada(s) em sessões futuras iniciadas pelo mesmo usuário. Elas podem ser modificadas com o comando <command>vncpasswd</command>.
  </para>

  <important>
   <title>Considerações sobre segurança</title>
   <para>
    Verifique se está usando senhas avançadas de tamanho significativo (oito ou mais caracteres). Não compartilhe essas senhas. 
   </para>
  </important>

  <para>
   Para terminar a sessão, encerre o ambiente de área de trabalho executado na sessão VNC pelo viewer do VNC, da mesma forma que você encerra uma sessão X local regular. 
  </para>

  <para>
   Se preferir terminar a sessão manualmente, abra um shell no servidor VNC e certifique-se de estar conectado como o usuário que possui a sessão VNC que deseja terminar. Execute o seguinte comando para terminar a sessão em execução na exibição <literal>:1</literal>: <command>vncserver -kill :1</command>
  </para>

  <sect2 xml:id="sec.vnc.persistent.connect">
   <title>Conectando-se a uma sessão VNC persistente</title>
   <para>
    Para conectar-se a uma sessão VNC persistente, é preciso instalar o viewer do VNC. Consulte também a <xref linkend="sec.vnc.viewer"/>. Se preferir, use um browser da Web compatível com Java para ver a sessão VNC digitando o seguinte URL: <literal>http://jupiter.example.com:5801</literal>
   </para>
  </sect2>

  <sect2 xml:id="sec.vnc.persistent.configure">
   <title>Configurando sessões VNC persistentes</title>
   <para>
    É possível configurar as sessões VNC persistentes editando <filename>$HOME/.vnc/xstartup</filename>. Por padrão, o script shell inicia o mesmo gerenciador de janelas/GUI do qual ele foi iniciado. No <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase>, pode ser o GNOME ou o IceWM. Para iniciar a sessão com um gerenciador de janelas de sua escolha, defina a variável <envar>WINDOWMANAGER</envar>:
   </para>
<screen>WINDOWMANAGER=gnome vncserver -geometry 1024x768
WINDOWMANAGER=icewm vncserver -geometry 1024x768</screen>
   <note>
    <title>Uma configuração para cada usuário</title>
    <para>
     Sessões VNC persistentes são configuradas em uma única configuração por usuário. Várias sessões iniciadas pelo mesmo usuário utilizarão todos os mesmos arquivos de inicialização e senha.
    </para>
   </note>
  </sect2>
 </sect1>
 <sect1 xml:id="vnc.encrypted">
  <title>Comunicação por VNC criptografada</title>

  <para>
   Se o servidor VNC estiver configurado apropriadamente, todas as comunicações entre o cliente e o servidor VNC serão criptografadas. Isso inclui a autenticação no início e a transferência de todos os dados mais tarde.
  </para>

  <para>
   Independentemente do tipo de sessão VNC (único uso ou persistente) que você pretende iniciar, as opções de segurança são configuradas por meio do parâmetro <option>-securitytypes</option> do comando <command>/usr/bin/Xvnc</command> localizado na linha <literal>server_args</literal>. O parâmetro <option>-securitytypes</option> seleciona tanto o método de autenticação quanto a criptografia. Ele tem as seguintes opções:
  </para>

  <variablelist>
   <title>Autenticações</title>
   <varlistentry>
    <term>None, TLSNone, X509None</term>
    <listitem>
     <para>
      Nenhuma autenticação.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>VncAuth, TLSVnc, X509Vnc</term>
    <listitem>
     <para>
      Autenticação com senha personalizada.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Plain, TLSPlain, X509Plain</term>
    <listitem>
     <para>
      Autenticação que usa PAM para verificar a senha do usuário.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <variablelist>
   <title>Criptografias</title>
   <varlistentry>
    <term>None, VncAuth, Plain</term>
    <listitem>
     <para>
      Sem criptografia.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>TLSNone, TLSVnc, TLSPlain</term>
    <listitem>
     <para>
      Criptografia TLS anônima. Tudo é criptografado, mas não há nenhuma verificação do host remoto. Portanto, você está protegido contra invasores passivos, mas não contra invasores man-in-the-middle.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>X509None, X509Vnc, X509Plain</term>
    <listitem>
     <para>
      Criptografia TLS com certificado. Se você usar um certificado autoassinado, será solicitado a verificá-lo na primeira conexão. Nas conexões subsequentes, você será avisado apenas se o certificado for mudado. Portanto, você está protegido contra tudo, exceto man-in-the-middle na primeira conexão (similar ao uso comum de SSH). Se você usar um certificado assinado por uma autoridade de certificação que corresponde ao nome da máquina, terá segurança total (similar ao uso comum de HTTPS).
     </para>
     <tip>
      <title>Caminho para o Certificado e a Chave</title>
      <para>
       Com a criptografia baseada em X509, você precisa especificar o caminho para o certificado e a chave X509 com as opções <option>-X509Cert</option> e <option>-X509Key</option>.
      </para>
     </tip>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   Se você selecionar vários tipos de segurança separados por vírgula, o primeiro que for suportado e permitido pelo cliente e pelo servidor será utilizado. Dessa forma, você pode configurar criptografia oportunista no servidor. Isso é útil se você precisa suportar clientes VNC que não aceitam criptografia.
  </para>

  <para>
   No cliente, você também pode especificar os tipos de segurança permitidos para impedir ataque de instalação de uma versão menos eficiente, se estiver conectando-se a um servidor que você sabe que tem a criptografia habilitada (embora nosso vncviewer o avisará com a mensagem "Conexão não criptografada!" nesse caso).
  </para>
 </sect1>
</chapter>
