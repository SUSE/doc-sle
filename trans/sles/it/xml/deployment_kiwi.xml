<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xml:base="deployment_kiwi.xml" id="cha.autokiwi">

 <title>Distribuzione automatizzata delle immagini precaricate</title>
 <abstract>
  <para>
   Con KIWI sarà possibile creare immagini del sistema operativo. Questo capitolo spiega come distribuire un'immagine di sistema su un computer client vuoto. A questo scopo, è necessario creare un'immagine di precaricamento contenente un'immagine RAW avviabile. Questo file contiene due componenti importanti: una tabella delle partizioni e il sistema operativo vero e proprio. Questa immagine RAW viene scritta nel disco rigido vuoto e il sistema operativo si estende al restante spazio su disco al primo avvio.
  </para>

 </abstract>
 <para>
  Per informazioni su come creare questa immagine, vedere <ulink url="http://doc.opensuse.org/projects/kiwi/doc/"/>. Quando si crea l'immagine ISO, è possibile trovare il file RAW nella directory di destinazione. Ci sono molti modi per trasferire un'immagine raw su un disco.
 </para>
 <itemizedlist mark="bullet" spacing="normal">
  <listitem>
   <para>
    Connettere il disco ad un server di distribuzione e copiare l'immagine nel dispositivo raw.
   </para>
  </listitem>
  <listitem>
   <para>
    Fornire l'immagine raw tramite un server HTTP o FTP e trasferirla sul disco del computer client.
   </para>
  </listitem>
  <listitem>
   <para>
    Creare un'immagine netboot per ottenere l'immagine e trasferirla sul disco. Questo metodo è valido per una distribuzione di massa.
   </para>
  </listitem>
  <listitem>
   <para>
    Avviare un disco di ripristino ed eseguire manualmente il dump dall'immagine di ripristino.
   </para>
  </listitem>
 </itemizedlist>
 <para>
  Per un avvio rapido è consigliabile utilizzare uno dei metodi descritti nella <xref linkend="sec.autokiwi.manual"/>.
 </para>
 <sect1 id="sec.autokiwi.manual">
  <title>Distribuzione manuale del sistema da un'immagine di ripristino</title>

  <variablelist>
   <varlistentry>
    <term>Distribuzione con file ISO generato da KIWI:</term>
    <listitem>
     <orderedlist spacing="normal">
      <listitem>
       <para>
        Masterizzare l'immagine ISO ottenuta dal processo di creazione di KIWI sul CD/DVD.
       </para>
      </listitem>
      <listitem>
       <para>
        Eseguire l'avvio da questo supporto sul computer client.
       </para>
      </listitem>
      <listitem>
       <para>
        Selezionare il disco rigido per l'installazione.
       </para>
      </listitem>
      <listitem>
       <para>
        Riavviare il computer client ed effettuare l'avvio dal disco rigido.
       </para>
      </listitem>
     </orderedlist>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Distribuzione su sistema di ripristino:</term>
    <listitem>
     <orderedlist spacing="normal">
      <listitem>
       <para>
        Avviare il computer client con un sistema di salvataggio. Tali sistemi sono disponibili su tutti i CD o DVD di installazione di SUSE.
       </para>
      </listitem>
      <listitem>
       <para>
        Eseguire il login come <systemitem class="username">root</systemitem>. Non immettere la password.
       </para>
      </listitem>
      <listitem>
       <para>
        Configurare la rete. Se nella rete è disponibile DHCP, sarà sufficiente il comando <command>ifup-dhcp eth0</command>. Se questa operazione deve essere eseguita manualmente, utilizzare il comando <command>ip</command> per configurare la rete. L'output che avvia DHCP fornisce inoltre l'indirizzo IP del computer.
       </para>
      </listitem>
      <listitem>
       <para>
        Rimanere in ascolto su una porta inutilizzata della rete come <systemitem>1234</systemitem> e trasferire i dati in entrata al disco utilizzando il seguente comando:
       </para>
<screen>netcat -l -p 1234 &gt; /dev/sda</screen>
      </listitem>
      <listitem>
       <para>
        Sul server di imaging, inviare l'immagine raw al computer client utilizzando il comando:
       </para>
<screen>netcat &lt;IP of client&gt; 1234 &lt; $HOME/preload_image/&lt;image_name&gt;</screen>
      </listitem>
      <listitem>
       <para>
        Dopo il trasferimento dell'immagine, rimuovere il sistema di salvataggio dall'unità CD o DVD e arrestare il computer client. Al riavvio, si dovrebbe avviare il boot loader <literal>GRUB</literal> sul client e il primo sistema firstboot dovrebbe assumere il controllo.
       </para>
      </listitem>
     </orderedlist>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 id="sec.autokiwi.pxe">
  <title>Distribuzione automatizzata con PXE Boot</title>

  <para>
   Quando si effettuano più installazioni di un sistema operativo su hardware simile, è utile dedicare un po' di tempo alla preparazione di una distribuzione di massa del sistema operativo per ridurre al minimo il tempo necessario per l'effettiva distribuzione. Tale processo è descritto in questo capitolo. L'obiettivo è semplicemente collegare un computer, collegarlo alla rete, effettuare un'operazione di avvio dalla rete e attendere che il computer si arresti.
  </para>

  <para>
   Per completare questo task, è necessario effettuare le seguenti azioni:
  </para>

  <variablelist>
   <varlistentry>
    <term>Configurare un server di avvio e di installazione</term>
    <listitem>
     <para>
      È necessario un computer dedicato, che dovrebbe essere preparato per offrire avvio PXE nonché un server ftp o Web per fornire un'immagine di precaricamento. È consigliabile fornire al computer sufficiente memoria in modo che possa contenere tutti i dati necessari all'installazione. Per un'installazione di default sono necessari almeno 4 GByte di memoria. Tutti i task necessari possono essere eseguiti con SUSE Linux Enterprise Server. Per ulteriori informazioni, vedere <xref linkend="sec.autokiwi.instserver"/>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Preparazione di un'immagine precaricata</term>
    <listitem>
     <para>
      L'installazione effettiva viene effettuata copiando un'immagine non elaborata del sistema operativo sul nuovo disco rigido. È necessario preparare e verificare con cura tutte le funzioni e le impostazioni. Per fornire questa immagine, è possibile usare KIWI (disponibile nell'SDK del sistema operativo SUSE Linux Enterprise). Ulteriori informazioni sulla creazione di un'immagine con KIWI sono disponibili all'indirizzo <ulink url="http://doc.opensuse.org/projects/kiwi/doc/"/>. Per ulteriori dettagli sui requisiti dell'immagine precaricata, consultare <xref linkend="sec.autokiwi.preloadimage"/>.
     </para>
     <para>
      L'SDK che include KIWI è un prodotto aggiuntivo per SUSE Linux Enterprise ed è disponibile per il download da <ulink url="http://download.suse.com/"/>. Cercare <literal>SUSE Linux Enterprise Software Development Kit</literal>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Creazione di un sistema iniziale per la distribuzione</term>
    <listitem>
     <para>
      Per effettuare questo task, è necessario avere delle conoscenze di Linux. Per una descrizione su come effettuare questa operazione utilizzando un'installazione di esempio, vedere <xref linkend="sec.autokiwi.initrd"/>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Configurazione del server di avvio per la distribuzione automatica</term>
    <listitem>
     <para>
      L'avvio PXE deve essere istruito per avviare il sistema di installazione, che prenderà invece l'immagine precaricata dal server e la copierà sul disco rigido.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <sect2 id="sec.autokiwi.instserver">
   <title>Configurare un server di avvio e di installazione</title>
   <para>
    Per eseguire questo task dopo l'installazione di SUSE Linux Enterprise Server, è necessario effettuare quattro passaggi:
   </para>
   <procedure id="proc.autokiwi.instserver">
    <step performance="required">
     <para>
      Configurare l'origine dell'installazione come descritto nella <xref linkend="sec.deployment.remoteinst.instserver"/>. Scegliere un server di rete HTTP o FTP.
     </para>
    </step>
    <step performance="required">
     <para>
      Configurare un server TFTP per la memorizzazione dell'immagine di avvio (questa immagine verrà creata in un passaggio successivo). Questo passaggio viene descritto nella <xref linkend="sec.deployment.remoteinst.boot.tftp"/>.
     </para>
    </step>
    <step performance="required">
     <para>
      Configurare un server DHCP per l'assegnazione degli indirizzi IP a tutti i computer e la trasmissione dell'ubicazione del server TFTP al sistema di destinazione. Questo passaggio viene descritto nella <xref linkend="sec.deployment.remoteinst.boot.dhcp"/>.
     </para>
    </step>
    <step performance="required">
     <para>
      Preparare l'avvio PXE per il server di installazione. Questo passaggio è descritto dettagliatamente nella <xref linkend="sec.deployment.remoteinst.boot.pxe"/>.
     </para>
    </step>
   </procedure>
   <para>
    Si noti che il processo effettivo di installazione risulta molto più veloce se il computer dispone di memoria sufficiente per contenere l'immagine di precaricamento. Anche l'uso di Gigabit Ethernet rende il processo di distribuzione significativamente più veloce rispetto alle reti più lente).
   </para>
  </sect2>

  <sect2 id="sec.autokiwi.preloadimage">
   <title>Creazione di un'immagine di precaricamento</title>
   <para>
    Il processo di creazione di immagini con KIWI viene descritto in <ulink url="http://doc.opensuse.org/projects/kiwi/doc/"/>. Tuttavia, per creare un'immagine utile per la distribuzione di massa, è necessario tener conto di varie considerazioni:
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      Una tipica immagine di precaricamento, sarà del tipo seguente:
     </para>
<screen>&lt;type primary="true" filesystem="btrfs" boot="oemboot/suse-SLES12"&gt;vmx&lt;/type&gt;</screen>
    </listitem>
    <listitem>
     <para>
      Durante l'impostazione di un'immagine di precaricamento, il processo di creazione dell'immagine viene eseguito più volte. Gli archivi necessari per creare l'immagine devono essere disponibili sul computer locale.
     </para>
    </listitem>
    <listitem>
     <para>
      In relazione all'utilizzo del precaricamento, sarà necessario configurare attentamente firstboot. Ulteriori dettagli su firstboot sono disponibili  nel <xref linkend="cha.deployment_firstboot"/>. Con questo metodo è anche possibile richiedere all'utente di eseguire la configurazione iniziale durante il primo avvio del sistema.
     </para>
    </listitem>
    <listitem>
     <para>
      È possibile configurare numerose funzioni aggiuntive nell'immagine, come l'aggiunta di archivi di aggiornamento o l'esecuzione di un aggiornamento al momento dell'avvio iniziale. È tuttavia impossibile descrivere tutte le opzioni in questo documento. Inoltre, a seconda dei requisiti, occorre tenere presente che per creare un'immagine di precaricamento, è necessario possedere conoscenze approfondite sul sistema di imaging KIWI e sulle numerose altre tecnologie usate in <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    L'immagine effettiva da distribuire deve essere disponibile sul server FTP or HTTP fornito sul server di installazione.
   </para>
  </sect2>

  <sect2 id="sec.autokiwi.initrd">
   <title>Creazione di un sistema iniziale per distribuire un'immagine di precaricamento</title>
   <para>
    Per eseguire una distribuzione automatica, è necessario avviare un sistema Linux iniziale sul computer di destinazione. Durante un'installazione tipica, il kernel e il file system ram iniziale vengono letti da alcuni supporti di avvio e avviati dal Bios. La funzionalità necessaria può essere implementata nel file system RAM che funge da sistema iniziale insieme al kernel.
   </para>
   <para>
    Le funzioni principali che devono essere fornite dal sistema iniziale sono l'abilitazione dell'accesso al disco rigido e la messa in disponibilità della connessione di rete. Entrambe queste funzioni dipendono dall'hardware che si prevede di utilizzare per la distribuzione. Benché sia teoricamente possibile creare un sistema iniziale completamente nuovo, per semplificare questo task è possibile anche modificare il file system RAM iniziale usato dal computer durante l'avvio.
   </para>
   <para>
    La seguente procedura è solo un esempio di come creare il file system RAM iniziale necessario:
   </para>
   <procedure>
    <step performance="required">
     <para>
      Eseguire un'installazione standard di <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> sul sistema di destinazione.
     </para>
    </step>
    <step performance="required">
     <para>
      Installare il pacchetto <systemitem>busybox</systemitem> nel sistema.
     </para>
    </step>
    <step performance="required">

     
     
     <para>
      Creare un nuovo file system RAM con il seguente comando:
     </para>
<screen>mkinitrd -f busybox -D eth0</screen>
     <para>
      Si noti che eth0 rappresenta il dispositivo Ethernet a cui è collegato il cavo di rete. Il parametro <systemitem>-f busybox</systemitem> aggiunge il <systemitem>busybox</systemitem> binario multichiamata al file system RAM. In seguito a questa operazione molti comandi UNIX standard saranno disponibili nel sistema.
     </para>
    </step>
    <step performance="required">
     <para>
      Copiare il nuovo file system RAM e il kernel nel server di avvio con il comando:
     </para>
<screen>scp /boot/initrd /boot/vmlinuz pxe.example.com:</screen>
     <para>
      Sostituire pxe.example.com con il nome del server di avvio locale o dell'indirizzo IP.
     </para>
    </step>
    <step performance="required">
     <para>
      Accedere al bootserver come utente <systemitem class="username">root</systemitem> e creare una directory in cui sia possibile modificare il file system RAM:
     </para>
<screen>mkdir ~/bootimage</screen>
    </step>
    <step performance="required">
     <para>
      Modificare la directory di lavoro impostandola sulla directory indicata tramite il comando <command>cd ~/bootimage</command>.
     </para>
    </step>
    <step performance="required">
     <para>
      Decomprimere il file system RAM iniziale copiato in precedenza con il comando:
     </para>
<screen>zcat ../initrd | cpio -i</screen>
    </step>
    <step performance="required">
     <para>
      Modificare il file <filename>run_all.sh</filename>.
     </para>
    </step>
    <step performance="required">
     <para>
      Cercare la riga seguente, eliminarla ed eliminare il resto del file:
     </para>
<screen>[ "$debug" ] &amp;&amp; echo preping 21-nfs.sh </screen>
    </step>
    <step performance="required">
     <para>
      Aggiungere le seguenti righe al termine del file <filename>run_all.sh</filename>:
     </para>
<screen>[ "$debug" ] &amp;&amp; echo preping 92-install.sh
[ "$debug" ] &amp;&amp; echo running 92-install.sh
source boot/92-install.sh
[ "$modules" ] &amp;&amp; load_modules
     </screen>
    </step>
    <step performance="required">
     <para>
      Creare un nuovo script <filename>boot/92-install.sh</filename> con il seguente contenuto:
     </para>
<screen>#!/bin/bash
if [ "$(get_param rawimage)" ]; then
  rawimage=$(get_param rawimage)
  if  [ "$(get_param rawdevice)" ]; then
    rawdevice=$(get_param rawdevice)
    echo "wget -O ${rawdevice} ${rawimage}"
    wget -O ${rawdevice} ${rawimage}
    sync
    sleep 5
    echo "DONE"
  fi
fi
# /bin/bash
/bin/poweroff -f
</screen>
    </step>
    <step performance="required">
     <para>
      Se si desidera visualizzare una shell di debug prima dello spegnimento del computer, rimuovere il segno di commento davanti a <filename>/bin/bash</filename>.
     </para>
    </step>
    <step performance="required">
     <para>
      Rendere lo script eseguibile con il comando <command>chmod 755 boot/92-install.sh</command>.
     </para>
    </step>
    <step performance="required">
     <para>
      Creare un nuovo file system RAM iniziale con i comandi:
     </para>
<screen>mkdir -p /srv/tftpboot
find . | cpio --quiet -H newc -o | gzip -9 -n &gt; \
/srv/tftpboot/initrd.boot</screen>
    </step>
    <step performance="required">
     <para>
      Copiare il kernel in questa directory:
     </para>
<screen>cp ../vmlinuz /srv/tftpboot/linux.boot</screen>
    </step>
   </procedure>
   <para>
    Il file system RAM iniziale è ora pronto per ricevere due nuovi parametri della riga di comando del kernel. Il parametro <systemitem>rawimage=&lt;URL&gt;</systemitem> viene utilizzato per identificare l'ubicazione dell'immagine di precaricamento. È possibile utilizzare qualsiasi URL comprensibile da parte di wget. Il parametro <systemitem>rawdevice=&lt;device&gt;</systemitem> viene utilizzato per identificare il dispositivo di blocco per il disco rigido sul computer di destinazione.
   </para>
  </sect2>

  <sect2>
   <title>Configurazione del server di avvio</title>
   <para>
    La configurazione del server di avvio viene descritta nei particolari in vari capitoli differenti, elencati nella <xref linkend="sec.autokiwi.instserver"/>. Questa sezione fornisce un elenco di controllo con i passaggi necessari per configurare il sistema.
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      Configurare un server DHCP. La sottorete in cui sono installati i computer necessita delle righe addizionali:
     </para>
<screen>filename "pxelinux.0";
next-server 192.168.1.115;</screen>
     <para>
      In questo esempio 192.168.1.115 è l'indirizzo ip del server PXE pxe.example.com.
     </para>
    </listitem>
    <listitem>
     <para>
      Configurare un server PXE come descritto nella <xref linkend="sec.deployment.remoteinst.boot.pxe"/>. Quando si modifica <filename>/srv/tftpboot/pxelinux.cfg/default</filename>, aggiungere le voci seguenti:
     </para>
<screen>default bootinstall
label bootinstall
  kernel linux.boot
  append initrd=initrd.boot \
  rawimage=ftp://192.168.1.115/preload/preloadimage.raw rawdevice=/dev/sda</screen>
    </listitem>
    <listitem>
     <para>
      Configurare un server ftp e copiare l'immagine di precaricamento preparata in <filename>/srv/ftp/preload/preloadimage.raw</filename>.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Verificare l'impostazione avviando il sistema di destinazione utilizzando l'avvio di rete PXE. In tal modo l'immagine di precaricamento preparata verrà copiata automaticamente sul disco rigido e al termine il computer si spegnerà.
   </para>
  </sect2>


 </sect1>







</chapter>
