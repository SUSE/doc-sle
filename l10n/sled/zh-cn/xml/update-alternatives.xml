<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook51-profile.xsl"
                 type="text/xml"
                 title="Profiling step"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="update-alternatives.xml" version="5.1" xml:id="cha-update-alternative">
 <title><command>update-alternatives</command>：管理命令和文件的多个版本</title>
 <info>
  <abstract>
   <para>
    系统上往往会安装同一个工具的多个版本。为了让管理员可以选择，以及能一起安装和使用多个不同的版本，备选项系统提供了以一致的方式管理此类版本的功能。
   </para>
  </abstract>
 <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>

  <sect1 xml:id="sec-ua-concept">
   <title>概览</title>
   <para>
    在 <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 上，有些程序执行的是相同或类似的任务。例如，如果系统上既安装了 Java 1.7，也安装了 Java 1.8，则会从 RPM 软件包中调用备选项系统脚本 (<command>update-alternatives</command>)。备选项系统默认将参照版本 1.8：版本越高，优先级就越高。不过，管理员可以更改该默认设置，并可将通用名称指向版本 1.7。
   </para>
   <para>
    本章使用了下列术语：
   </para>
   <variablelist>
    <title>术语</title>
    <varlistentry>
     <term>管理目录</term>
     <listitem>
      <para>
       默认的 <filename class="directory">/var/lib/rpm/alternatives</filename> 目录，其中包含有关备选项当前状态的信息。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>备选项</term>
     <listitem>
      <para>
       文件系统中某个特定文件的名称，可使用备选项系统通过通用名称访问。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>备选项目录</term>
     <listitem>
      <para>
       包含符号链接的默认 <filename class="directory">/etc/alternatives</filename> 目录。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>通用名称</term>
     <listitem>
      <para>
       该名称（例如 <command>/usr/bin/edit</command>）参照可通过备选项系统使用的多个文件中的一个。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>链接组</term>
     <listitem>
      <para>
       一组相关的符号链接，可作为一个组更新。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>主链接</term>
     <listitem>
      <para>
       链接组中用于确定如何配置组中其他链接的链接。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>从属链接</term>
     <listitem>
      <para>
       链接组中受主链接控制的链接。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>符号链接 (symlink)</term>
     <listitem>
      <para>
       在同一文件系统中作为另一个文件的参照的文件。备选项系统使用备选项目录中的符号链接在一个文件的各个版本之间切换。
      </para>
      <para>
       管理员可通过 <command>update-alternatives</command> 命令修改备选项目录中的符号链接。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <para>
    备选项系统提供 <command>update-alternatives</command> 命令供您创建、去除、维护和显示有关符号链接的信息。虽然这些符号链接通常是指向命令，但它们也可以指向 JAR 存档、手册页及其他文件。本章中的示例使用了命令和手册页，但它们也适用于其他文件类型。
   </para>
   <para>
    备选项系统使用备选项目录来收集指向可能的备选项的链接。安装包含备选项的新软件包时，就会将新的备选项添加至系统。是否将新软件包的备选项选为默认值取决于它的优先级和设置的模式。一般而言，版本较高的软件包优先级也较高。备选项系统可以在两种模式下工作：
   </para>
   <itemizedlist>
    <listitem>
     <formalpara>
      <title>自动模式</title>
      <para>
       在此模式下，备选项系统会确保组中的链接指向适合组且优先级最高的备选项。
      </para>
     </formalpara>
    </listitem>
    <listitem>
     <formalpara>
      <title>手动模式</title>
      <para>
       在此模式下，备选项系统不会对系统管理员的设置进行任何更改。
      </para>
     </formalpara>
    </listitem>
   </itemizedlist>
   <para>
    例如，在备选项系统中，<command>java</command> 命令具有以下链接层次结构：
   </para>
   <example>
    <title><command>java</command> 命令的备选项系统</title>
    <screen>/usr/bin/java <co xml:id="co-ua-java-name"/>
 -&gt; /etc/alternatives/java <co xml:id="co-ua-java-symbolic-link"/>
     -&gt; /usr/lib64/jvm/jre-10-openjdk/bin/java <co xml:id="co-ua-java-alternatives"/></screen>
    
    <calloutlist>
     <callout arearefs="co-ua-java-name">
      <para>
       通用名称。
      </para>
     </callout>
     <callout arearefs="co-ua-java-symbolic-link">
      <para>
       备选项目录中的符号链接。
      </para>
     </callout>
     <callout arearefs="co-ua-java-alternatives">
      <para>
       备选项之一。
      </para>
     </callout>
    </calloutlist>
   </example>
  </sect1>

  <sect1 xml:id="sec-ua-use-cases">
   <title>使用案例</title>
   <para>
    默认从 RPM 软件包中调用 <command>update-alternatives</command> 脚本。安装或去除一个软件包时，该脚本会处理该软件包所有的符号链接。不过，您可以从命令行中手动运行该脚本，以便：
   </para>
   <itemizedlist>
    <listitem>
     <para>
      显示通用名称的当前备选项。
     </para>
    </listitem>
    <listitem>
     <para>
      更改备选项的默认值。
     </para>
    </listitem>
    <listitem>
     <para>
     为备选项创建一组相关的文件。
     </para>
    </listitem>
   </itemizedlist>
  </sect1>

  <sect1 xml:id="sec-ua-view-all">
   <title>获取备选项的概览</title>
   <para>
    要检索所有已配置备选项的名称，请使用：
   </para>
 <screen><prompt>&gt; </prompt><command>ls /var/lib/alternatives</command></screen>
   <para>
    要获取所有已配置备选项的概览及其值，请使用
   </para>
   <screen><prompt>&gt; </prompt><command>sudo</command> <command>update-alternatives --get-selections</command>
asadmin                        auto     /usr/bin/asadmin-2.7
awk                            auto     /usr/bin/gawk
chardetect                     auto     /usr/bin/chardetect-3.6
dbus-launch                    auto     /usr/bin/dbus-launch.x11
default-displaymanager         auto     /usr/lib/X11/displaymanagers/gdm
[...]</screen>
  </sect1>

  <sect1 xml:id="sec-ua-view">
   <title>查看有关特定备选项的细节</title>
   <para>
    检查备选项最简单的方法就是查看命令的符号链接。例如，如果您想知道 <command>java</command> 命令参照的是什么，请使用以下命令：
   </para>
   <screen><prompt>&gt; </prompt><command>readlink --canonicalize /usr/bin/java</command>
/usr/lib64/jvm/jre-10-openjdk/bin/java</screen>
   <para>
    如果您看到相同的路径（在本例中为 <filename>/usr/bin/java</filename>），则此命令没有备选项。
   </para>
   
   <para>
    要查看全部的备选项（包括从属链接），请使用 <option>--display</option> 选项：
   </para>
   <screen><prompt>&gt; </prompt><command>sudo</command> <command>update-alternatives --display java</command>
java - auto mode
  link best version is /usr/lib64/jvm/jre-1.8.0-openjdk/bin/java
  link currently points to /usr/lib64/jvm/jre-1.8.0-openjdk/bin/java
  link java is /usr/bin/java
  slave java.1.gz is /usr/share/man/man1/java.1.gz
  slave jre is /usr/lib64/jvm/jre
  slave jre_exports is /usr/lib64/jvm-exports/jre
  slave keytool is /usr/bin/keytool
  slave keytool.1.gz is /usr/share/man/man1/keytool.1.gz
  slave orbd is /usr/bin/orbd
  slave orbd.1.gz is /usr/share/man/man1/orbd.1.gz
[...]</screen>
  </sect1>

  <sect1 xml:id="sec-ua-set">
   <title>设置备选项的默认版本</title>
   <para>
    <filename>/usr/bin</filename> 中的命令默认会参照优先级最高的备选项目录。例如，<command>java</command> 命令默认会显示下面的版本号：
   </para>
   <screen><prompt>&gt; </prompt><command>java -version</command>
openjdk version "10.0.1" 2018-04-17
OpenJDK Runtime Environment (build 10.0.1+10-suse-lp150.1.11-x8664)
OpenJDK 64-Bit Server VM (build 10.0.1+10-suse-lp150.1.11-x8664, mixed mode)</screen>
   <para>
    要将默认 <command>java</command> 命令更改为参照先前的版本，请运行：
   </para>
   <screen><prompt>&gt; </prompt><command>sudo</command> <command>update-alternatives --config java</command>
root's password:
There are 2 choices for the alternative java (providing /usr/bin/java).

  Selection    Path                                       Priority   Status
------------------------------------------------------------
* 0            /usr/lib64/jvm/jre-10-openjdk/bin/java      2005      auto mode
  1            /usr/lib64/jvm/jre-1.8.0-openjdk/bin/java   1805      manual mode
  2            /usr/lib64/jvm/jre-10-openjdk/bin/java      2005      manual mode
  3            /usr/lib64/jvm/jre-11-openjdk/bin/java      0         manual mode

Press &lt;enter&gt; to keep the current choice[*], or type selection number:</screen>
   <para>
    根据您的系统和安装的版本，具体的 Java 版本号会有所不同。选择 <literal>1</literal> 之后，<command>java</command> 会显示下面的版本号：
   </para>
   <screen><prompt>&gt; </prompt><command>java -version</command>
java version "1.8.0_171"
OpenJDK Runtime Environment (IcedTea 3.8.0) (build 1.8.0_171-b11 suse-lp150.2.3.1-x86_64)
OpenJDK 64-Bit Server VM (build 25.171-b11, mixed mode)</screen>
   <para>
    另外，请记住以下几点：
   </para>
   <itemizedlist>
    <listitem>
     <para>
      在手动模式下安装另一个 Java 版本时，备选项系统既不会更改链接，也不会更改通用名称。
     </para>
    </listitem>
    <listitem>
     <para>
      在自动模式下安装另一个 Java 版本时，备选项系统会更改 Java 主链接及所有从属链接（如<xref linkend="sec-ua-view"/>中所示）。要检查主/从关系，请使用：
     </para>
     <screen><prompt>&gt; </prompt><command>sudo</command> <command>update-alternatives --display java</command></screen>
    </listitem>
   </itemizedlist>
  </sect1>

  <sect1 xml:id="sec-ua-install">
   <title>安装自定义备选项</title>
   <para>
    本节介绍如何在系统上设置自定义备选项。示例做了以下假设：
   </para>
   <itemizedlist>
    <listitem>
     <para>
      有两个具有类似功能的脚本：<command>foo-2</command> 和 <command>foo-3</command>。
     </para>
    </listitem>
    <listitem>
     <para>
      这些脚本储存在 <filename>/usr/local/bin</filename> 目录中，以免与 <filename>/usr/bin</filename> 中的系统工具产生任何冲突。
     </para>
    </listitem>
    <listitem>
     <para>
      有一个主链接 <command>foo</command> 指向 <command>foo-2</command> 或 <command>foo-3</command>。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    要在您的系统上提供备选项，请执行以下步骤：
   </para>
   <procedure>
    <step>
     <para>
      将您的脚本复制到 <filename>/usr/local/bin</filename> 目录中。
     </para>
    </step>
    <step>
     <para>
      让脚本可执行：
     </para>
     <screen><prompt>&gt; </prompt><command>sudo</command> <command>chmod +x /usr/local/bin/foo-{2,3}</command></screen>
    </step>
    <step>
     <para>
      针对两个脚本运行 <command>update-alternatives</command>：
     </para>
     <screen><prompt>&gt; </prompt><command>sudo</command> update-alternatives --install \
   /usr/local/bin/foo <co xml:id="co-ua-ua-install-usr-local-bin-foo"/>\
   foo <co xml:id="co-ua-ua-install-foo"/>\
   /usr/local/bin/foo-2 <co xml:id="co-ua-ua-install-usr-local-bin-foo-path"/>\
   200 <co xml:id="co-ua-ua-install-prio"/>
<prompt>&gt; </prompt><command>sudo</command> update-alternatives --install \
   /usr/local/bin/foo <xref linkend="co-ua-ua-install-usr-local-bin-foo"/>\
   foo <xref linkend="co-ua-ua-install-foo"/>\
   /usr/local/bin/foo-3 <xref linkend="co-ua-ua-install-usr-local-bin-foo-path"/>\
   300 <xref linkend="co-ua-ua-install-prio"/></screen>
     <para>
      <option>--install</option> 后面的选项含义如下：
     </para>
     <calloutlist>
      <callout arearefs="co-ua-ua-install-usr-local-bin-foo">
       <para>
        通用名称。为了避免混淆，该名称通常是不含任何版本号的脚本名称。
       </para>
      </callout>
      <callout arearefs="co-ua-ua-install-foo">
       <para>
        主链接的名称。必须相同。
       </para>
      </callout>
      <callout arearefs="co-ua-ua-install-usr-local-bin-foo-path">
       <para>
        位于 <filename>/usr/local/bin</filename> 中的原始脚本的路径。
       </para>
      </callout>
      <callout arearefs="co-ua-ua-install-prio">
       <para>
        优先级.我们给 <command>foo-2</command> 设置一个低于 <command>foo-3</command> 的优先级。最好使用增大得非常明显的数字来区分优先级。例如，<command>foo-2</command> 的优先级是 200，<command>foo-3</command> 的优先级是 300。
       </para>
      </callout>
     </calloutlist>
    </step>
    <step>
     <para>
      检查主链接：
     </para>
     <screen><prompt>&gt; </prompt><command>sudo</command> <command>update-alternatives --display foo</command>
foo - auto mode
  link best version is /usr/local/bin/foo-3
  link currently points to /usr/local/bin/foo-3
  link foo is /usr/local/bin/foo
/usr/local/bin/foo-2 - priority 200
/usr/local/bin/foo-3 - priority 300</screen>
    </step>
   </procedure>
   <para>
    完成所述步骤后，便可以使用主链接 <command>/usr/local/bin/foo</command> 了。
   </para>
   <para>
    如果需要，可以安装其他的备选项。要去除备选项，请使用以下命令：
   </para>
   <screen><prompt>&gt; </prompt><command>sudo</command> <command>update-alternatives --remove foo /usr/local/bin/foo-2</command></screen>
   <para>
    去除此脚本之后，foo 组的备选项系统看上去如下所示：
   </para>
   <screen><prompt>&gt; </prompt><command>sudo</command> <command>update-alternatives --display foo</command>
foo - auto mode
  link best version is /usr/local/bin/foo-3
  link currently points to /usr/local/bin/foo-3
  link foo is /usr/local/bin/foo
/usr/local/bin/foo-3 - priority 300</screen>
  </sect1>

  <sect1 xml:id="sec-ua-slave">
   <title>定义依赖备选项</title>
   <para>
    如果您有备选项，则仅凭脚本本身不足以完成任务。大部分命令都不是完全独立的：它们通常随附其他文件，例如扩展、配置或手册页。要创建依赖于主链接的备选项，请使用<emphasis>从属备选项</emphasis>。
   </para>
   <para>
    我们假设要扩展<xref linkend="sec-ua-install"/>中的示例，并提供手册页和配置文件：
   </para>
   <itemizedlist>
    <listitem>
     <para>
      两个手册页（<filename>foo-2.1.gz</filename> 和 <filename>foo-3.1.gz</filename>）储存在 <filename>/usr/local/man/man1</filename> 目录中。
     </para>
    </listitem>
    <listitem>
     <para>
      两个配置文件（<filename>foo-2.conf</filename> 和 <filename>foo-3.conf</filename>）储存在 <filename>/etc</filename> 中。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    请执行以下步骤将其他文件添加至备选项中：
   </para>
   <procedure>
    <step>
     <para>
      将配置文件复制到 <filename>/etc</filename> 中：
     </para>
     <screen><prompt>&gt; </prompt><command>sudo</command> <command>cp foo-{2,3}.conf /etc</command></screen>
    </step>
    <step>
     <para>
      将手册页复制到 <filename>/usr/local/man/man1</filename> 目录中：
     </para>
     <screen><prompt>&gt; </prompt><command>sudo</command> <command>cp foo-{2,3}.1.gz /usr/local/man/man1/</command></screen>
    </step>
    <step>
     <para>
      使用 <option>--slave</option> 选项将从属链接添加至主脚本：
     </para>
     <screen><prompt>&gt; </prompt><command>sudo</command> <command>update-alternatives --install \
   /usr/local/bin/foo foo /usr/local/bin/foo-2 200 \
   --slave /usr/local/man/man1/foo.1.gz \
   foo.1.gz \
   /usr/local/man/man1/foo-2.1.gz \
   --slave /etc/foo.conf \
   foo.conf \
   /etc/foo-2.conf</command>
<prompt>&gt; </prompt><command>sudo</command> <command>update-alternatives --install \
   /usr/local/bin/foo foo /usr/local/bin/foo-3 300 \
   --slave /usr/local/man/man1/foo.1.gz \
   foo.1.gz \
   /usr/local/man/man1/foo-3.1.gz \
   --slave /etc/foo.conf \
   foo.conf \
   /etc/foo-3.conf</command></screen>
    </step>
    <step>
     <para>检查主链接：</para>
     <screen>foo - auto mode
  link best version is /usr/local/bin/foo-3
  link currently points to /usr/local/bin/foo-3
  link foo is /usr/local/bin/foo
  slave foo.1.gz is /usr/local/man/man1/foo.1.gz
  slave foo.conf is /etc/foo.conf
/usr/local/bin/foo-2 - priority 200
  slave foo.1.gz: /usr/local/man/man1/foo-2.1.gz
  slave foo.conf: /etc/foo-2.conf
/usr/local/bin/foo-3 - priority 300
  slave foo.1.gz: /usr/local/man/man1/foo-3.1.gz
  slave foo.conf: /etc/foo-3.conf</screen>
    </step>
   </procedure>
   <para>
    如果您使用 <command>update-alternatives --config foo</command> 将链接更改为 <command>foo-2</command>，则所有从属链接也会随之更改。
   </para>
  </sect1>

  
</chapter>
