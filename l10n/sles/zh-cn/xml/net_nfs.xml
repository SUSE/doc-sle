<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_nfs.xml" version="5.0" xml:id="cha-nfs">
 <title>通过 NFS 共享文件系统</title>
 <info>
  <abstract>
   <para>
    <emphasis>网络文件系统</emphasis> (<emphasis>NFS</emphasis>) 是允许访问服务器上的文件的协议，访问方式与访问本地文件非常相似。
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>是</dm:translation>
  </dm:docmanager>
 </info>

 <sect1 xml:id="sec-nfs-overview">
  <title>概述</title>
  <para>
   <emphasis>网络文件系统</emphasis> (NFS) 是久经考验且广泛支持的标准化网络协议，它允许在单独的主机之间共享文件。
  </para>
  <para>
   <emphasis>网络信息服务</emphasis> (NIS) 可用于在网络中进行集中式用户管理。将 NFS 和 NIS 结合使用可通过文件和目录权限在网络中进行访问控制。NFS 与 NIS 一起使用时网络面向用户是透明的。
  </para>
  <para>
   在默认配置中，NFS 完全信任网络，因此会信任连接到可信网络的任何计算机。在可通过物理方式访问 NFS 服务器所信任的任何网络的任何计算机上，任何具有管理员特权的用户都可以访问该服务器提供的所有文件。
  </para>
  <para>
   在许多情况下，此安全性级别非常适于以下情形：所信任的网络是真正的专用网络，通常局限于单个计算机机柜或机房，并且无法进行未经授权的访问。将整个子网作为一个整体信任的其他情形限制较多，需要更精密的信任机制。为了满足这些情形的需要，NFS 使用 <emphasis>Kerberos</emphasis> 基础架构来支持各种安全性级别。Kerberos 需要 NFSv4（默认使用该协议）。有关细节，请参见<xref linkend="cha-security-kerberos"/>。
  </para>

  <para>
   下面是 YaST 模块中使用的术语。
  </para>

  <variablelist>
   <varlistentry>
    <term>导出</term>
    <listitem>
     <para>
      由 NFS 服务器<emphasis>导出的</emphasis>目录，客户端可将其集成到系统中。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFS 客户端</term>
    <listitem>
     <para>
      NFS 客户端是通过网络文件系统协议使用来自 NFS 服务器的 NFS 服务的系统。TCP/IP 协议已集成到 Linux 内核中；无需再安装任何其他软件。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFS 服务器</term>
    <listitem>
     <para>
      NFS 服务器向客户端提供 NFS 服务。运行中的服务器依赖于以下守护程序：<systemitem class="daemon">nfsd</systemitem> (worker)、<systemitem class="daemon">idmapd</systemitem>（用于 NFSv4 的 ID 到名称映射，仅在某些场景下需要）、<systemitem class="daemon">statd</systemitem>（文件锁定）和 <systemitem class="daemon">mountd</systemitem>（装入请求）。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFSv3</term>
    <listitem>
     <para>
      NFSv3 是版本 3 实施，支持客户端身份验证的<quote>旧版</quote>无状态 NFS。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFSv4</term>
    <listitem>
     <para>
      NFSv4 是新的版本 4 实施，支持通过 kerberos 进行安全用户身份验证。NFSv4 只需要一个端口，因此，它比 NFSv3 更适合用于防火墙后的环境。
     </para>
     <para>
      协议指定为 <link xlink:href="tools.ietf.org"/>。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>pNFS</term>
    <listitem>
     <para>
      并行 NFS，属于 NFSv4 的一种协议扩展。任何 pNFS 客户端都可以直接访问 NFS 服务器上的数据。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <important os="sles;osuse">
   <title>需要 DNS 的原因</title>
   <para>
    从理论上讲，所有导出都可以仅使用 IP 地址来完成。为避免超时，您需要一个有效的 DNS 系统。至少为了日志记录目的也应使用 DNS，因为 mountd 守护程序执行反向查找。
   </para>
  </important>
 </sect1>

 

 <sect1 os="sles;osuse" xml:id="sec-nfs-installation">
  <title>安装 NFS 服务器</title>

  <para>
   默认不会安装 NFS 服务器。要使用 YaST 安装 NFS 服务器，请依次选择<menuchoice> <guimenu>软件</guimenu>
   <guimenu>软件管理</guimenu></menuchoice>、<guimenu>模式</guimenu>，然后启用<guimenu>服务器功能</guimenu>部分的<guimenu>文件服务器</guimenu>选项。按<guimenu>接受</guimenu>安装所需的包。
  </para>
  <para>
   与 NIS 一样，NFS 也是一个客户端/服务器系统。但是，一台计算机可充当这两种角色：它可以通过网络提供文件系统（导出），也可以从其他主机装入文件系统（导入）。
  </para>

  <note>

   <title>在导出服务器上本地装入 NFS 卷</title>
   <para>
    <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 上不支持在导出服务器本地装入 NFS 卷。
   </para>
  </note>
 </sect1>
 <sect1 xml:id="sec-nfs-configuring-nfs-server" os="sles;osuse">
  <title>配置 NFS 服务器</title>

  <para>
   可通过 YaST 配置 NFS 服务器，也可以手动配置它。NFS 还可与 Kerberos 结合来进行身份验证。
  </para>

  <sect2 xml:id="sec-nfs-export-yast2">
   <title>使用 YaST 导出文件系统</title>
   <para>
    使用 YaST 将网络中的某台主机转换为 NFS 服务器，此服务器可将目录和文件导出到所有有权访问它的主机或导出到某个组的所有成员。因此，无需在每台主机本地安装应用程序，服务器也能提供应用程序。
   </para>
   <para>
    要设置此类服务器，请继续执行以下步骤：
   </para>
   <procedure xml:id="pro-nfs-export-yast2-nfs">
    <title>设置 NFS 服务器</title>
    <step>
     <para>
      启动 YaST 并选择<menuchoice> <guimenu>网络服务</guimenu>
      <guimenu> NFS 服务器</guimenu> </menuchoice>；请参见<xref linkend="fig-inst-nfsserver1"/>。系统会提示您安装其他软件。
     </para>

     <figure xml:id="fig-inst-nfsserver1">
      <title>NFS 服务器配置工具</title>
      <mediaobject>
       <imageobject role="fo">
        <imagedata fileref="yast2_inst_nfsserver1.png" width="75%" format="PNG" os="sles;sled"/>
        
       </imageobject>
       <imageobject role="html">
        <imagedata fileref="yast2_inst_nfsserver1.png" width="75%" format="PNG" os="sles;sled"/>
        
       </imageobject>
      </mediaobject>
     </figure>

    </step>
    <step>
     <para>
      激活<guimenu>启动</guimenu>单选按钮。
     </para>
    </step>
    <step>
     <para>
      如果防火墙在您的系统 (SuSEfirewall2) 中处于活动状态，请选中<guimenu>在防火墙中打开端口</guimenu>。YaST 会针对 NFS 服务器更改其配置，方法是启用 <systemitem class="service">nfs</systemitem> 服务。
     </para>
    </step>
    <step>
     <para>
      选中是否<guimenu>启用 NFSv4</guimenu>。如果您停用 NFSv4，YaST 将只支持 NFSv3。有关启用 NFSv2 的信息，请参见<xref linkend="sec-nfs-export-manual-nsfv2"/>。
     </para>
     <substeps performance="required">
      <step>
       <para>
        如果选择 NFSv4，另外还请输入相应的 NFSv4 域名。<systemitem class="daemon">idmapd</systemitem> 守护程序会使用此参数。Kerberos 设置需要该守护程序，当客户端无法处理数字用户名时，也需要使用该守护程序。如果您不运行 <systemitem class="daemon">idmapd</systemitem> 或无任何特殊要求，请将它保留为 <literal>localdomain</literal>（默认值）。有关 <systemitem class="daemon">idmapd</systemitem> 守护程序的详细信息，请参见 <xref linkend="var-nfs-export-manual-idmapd"/>。
       </para>
      </step>
     </substeps>
    </step>
    <step>
     <para>
      如果您需要安全访问服务器，请单击<guimenu>启用 GSS 安全性</guimenu>。先决条件是您的域中安装了 Kerberos 并且服务器和客户端都已采用 Kerberos 系统。<remark>emap 2011-0824: A reference to a Kerberos chapter
      would be good.</remark>单击<guimenu>下一步</guimenu>继续执行下一个配置对话框。
     </para>
    </step>
    <step>
     <para>
      单击对话框上半部分中的<guimenu>添加目录</guimenu>以导出您的目录。
     </para>
    </step>
    <step>
     <para>
      如果您尚未配置允许的主机，系统会自动弹出另一个对话框及相应的选项，供您输入客户端信息。输入主机通配符（通常您可以保留默认值不变）。
     </para>

     <para>
      可以为每个主机设置四类主机通配符：单主机（名称或 IP 地址）、网络组、通配符（如 <literal>*</literal> 表示所有计算机都能访问服务器）和 IP 网络。
     </para>
     <para>
      有关这些选项的更多信息，请参见 <literal>exports</literal> 手册页。
     </para>
    </step>
    <step>
     <para>
      单击<guimenu>完成</guimenu>以完成配置。
     </para>
    </step>
   </procedure>
  </sect2>



  <sect2 xml:id="sec-nfs-export-manual" os="sles;osuse">
   <title>手动导出文件系统</title>
   <para>
    NFS 导出服务的配置文件是 <filename>/etc/exports</filename> 和 <filename>/etc/sysconfig/nfs</filename>。如果 NFSv4 服务器配置包含经过 Kerberos 身份验证的 NFS，或者客户端不能使用数字用户名，则除了这些文件外，还需要 <filename>/etc/idmapd.conf</filename>。
   </para>
   <para>
    要启动或重启动服务，请运行命令 <command>systemctl restart nfsserver</command>。此命令还会将 NFS 服务器必需的 RPC portmapper 重启动。
   </para>
   <para>
    为确保 NFS 服务器始终在引导时启动，请运行 <command>sudo systemctl enable nfsserver</command>。
   </para>
   <note>
    <title>NFSv4</title>
    <para>
     NFSv4 是 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 上可用的最新版 NFS 协议。现在，通过 NFSv4 导出所用的配置目录与通过 NFSv3 导出所用的目录相同。
    </para>
    <para>
     在 <phrase os="sles;sled">SUSE Linux Enterprise Server 11</phrase> 上，必须在 <filename>/etc/exports</filename> 中指定绑定装入。该设置仍然受支持，但现在已弃用。
    </para>
   </note>
   <variablelist>
    <varlistentry>
     <term><filename>/etc/exports</filename></term>
     <listitem>
      <para>
       <filename>/etc/exports</filename> 文件包含项列表。每个条目表示共享的目录以及共享的方式。<filename>/etc/exports</filename> 中的条目通常包含：
      </para>
<screen>/<replaceable>SHARED</replaceable>/<replaceable>DIRECTORY</replaceable>   <replaceable>HOST</replaceable>(<replaceable>OPTION_LIST</replaceable>)</screen>
      <para>
       例如：
      </para>
<screen>/export/data   192.168.1.2(rw,sync)</screen>
      <para>
       在此，使用 IP 地址 <literal>192.168.1.2</literal> 标识允许的客户端。您可以使用主机名、表示一组主机的通配符（<literal>*.abc.com</literal>、<literal>*</literal> 等）或网络组 (<literal>@my-hosts</literal>)。
      </para>
      <para>
       有关所有选项及其含义的详细说明，请参见 <command>exports</command> 的手册页 (<command>man exports</command>)。
      </para>
      <para>
       如果您在 NFS 服务器运行时修改了 <filename>/etc/exports</filename>，则需使用 <command>sudo systemctl restart nfsserver</command> 命令重启动 NFS 服务器，以使更改生效。
      </para>

     </listitem>
    </varlistentry>
    <varlistentry>
     <term><filename>/etc/sysconfig/nfs</filename></term>
     <listitem>
      <para>
       <filename>/etc/sysconfig/nfs</filename> 文件包含一些决定 NFSv4 服务器守护程序行为的参数。请务必将参数 <systemitem>NFS4_SUPPORT</systemitem> 设置为 <literal>yes</literal>（默认值）。<systemitem>NFS4_SUPPORT</systemitem> 决定 NFS 服务器是否支持 NFSv4 导出和客户端。
      </para>
      <para>
       如果您在 NFS 服务器运行时修改了 <filename>/etc/sysconfig/nfs</filename>，则需使用 <command>sudo systemctl restart nfsserver</command> 命令重启动 NFS 服务器，以使更改生效。
      </para>
      <tip>
       <title>装入选项</title>
       <para>
        在 <phrase os="sles;sled">SUSE Linux Enterprise Server 11</phrase> 上，必须在 <filename>/etc/exports</filename> 中指定 <option>--bind</option> 装入。该设置仍然受支持，但现在已弃用。现在，通过 NFSv4 导出所用的配置目录与通过 NFSv3 导出所用的目录相同。
       </para>
      </tip>
      <note xml:id="sec-nfs-export-manual-nsfv2">

       <title>NFSv2</title>
       <para>
        如果 NFS 客户端仍依赖于 NFSv2，请在服务器的 <filename>/etc/sysconfig/nfs</filename> 中设置以下几项启用该协议：
       </para>
<screen>NFSD_OPTIONS="-V2"
MOUNTD_OPTIONS="-V2"</screen>
       <para>
        重启动服务后，请使用以下命令检查版本 2 是否可用：
       </para>
<screen><prompt>tux &gt; </prompt>cat /proc/fs/nfsd/versions
+2 +3 +4 +4.1 -4.2</screen>
      </note>
     </listitem>
    </varlistentry>
    <varlistentry xml:id="var-nfs-export-manual-idmapd">
     <term><filename>/etc/idmapd.conf</filename></term>
     <listitem>
      <para>
       从 SLE 12 SP1 开始，仅当使用 Kerberos 身份验证或客户端不能使用数字用户名时，才需要 <systemitem class="daemon">idmapd</systemitem> 守护程序。自 Linux 内核 2.6.39 起，Linux 客户端可以使用数字用户名。<systemitem class="daemon">idmapd</systemitem> 守护程序会将发送到服务器的 NFSv4 请求进行名称到 ID 的映射，并答复客户端。
      </para>
      <para>
       如果需要，<systemitem class="daemon">idmapd</systemitem> 需在 NFSv4 服务器上运行。客户端上的名称到 ID 映射将由以下包提供的 <command>nfsidmap</command> 来执行：
       <package>nfs-client</package>。
      </para>
      <para>
       对于可能使用 NFS 来共享文件系统的计算机，请确保以统一的方式在这些计算机间为用户指定用户名和 ID (UID)。这可以使用 NIS、LDAP 或域中的任何统一的域身份验证机制来实现。
      </para>
      <para>
       对于客户端和服务器，必须在 <filename>/etc/idmapd.conf</filename> 文件中将参数 <literal>Domain</literal> 设为相同值。如果您不确定，请在服务器和客户端文件中将域保留为 <literal>localdomain</literal>。配置文件样本如下：
      </para>
<screen>[General]
Verbosity = 0
Pipefs-Directory = /var/lib/nfs/rpc_pipefs
Domain = localdomain

[Mapping]
Nobody-User = nobody
Nobody-Group = nobody</screen>
      <para>
       要启动 <systemitem class="daemon">idmapd</systemitem> 守护程序，请运行 <command>systemctl start nfs-idmapd</command>。如果您在守护程序运行时修改了 <filename>/etc/idmapd.conf</filename>，则需使用 <command>systemctl start nfs-idmapd</command> 命令重启动守护程序，以使更改生效。
      </para>
      <para>
       有关更多信息，请参见 <literal>idmapd</literal> 和 <literal>idmapd.conf</literal> 的手册页（<literal>man idmapd</literal> 和 <literal>man idmapd.conf</literal>）。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>



  <sect2 xml:id="sec-nfs-kerberos">
   <title>采用 Kerberos 的 NFS</title>
   <para>
    要对 NFS 使用 Kerberos 身份验证，必须启用通用安全服务 (GSS)。在初始 YaST NFS 服务器对话框中选择<guimenu>启用 GSS 安全</guimenu>。必须具有一个有效的 Kerberos 服务器才能使用此功能。YaST 不会设置服务器，而只使用所提供的功能。如果希望使用 Kerberos 进行身份验证，则除了 YaST 配置外，还必须首先至少完成以下步骤，才能运行 NFS 配置：
   </para>
   <procedure>
    <step>
     <para>
      请确保服务器和客户端都在同一 Kerberos 域中。它们必须访问相同的 KDC（密钥分发中心）服务器并共享其 <filename>krb5.keytab</filename> 文件（在任何计算机上的默认位置是 <filename>/etc/krb5.keytab</filename>）。有关 Kerberos 的更多信息，请参见<xref linkend="cha-security-kerberos"/>。
     </para>
    </step>
    <step>
     <para>
      在客户端上运行 <command>systemctl start rpc-gssd.service</command> 启动 gssd 服务。
     </para>
    </step>
    <step os="sles;osuse">
     <para>
      在服务器上运行 <command>systemctl start rpc-svcgssd.service</command> 启动 svcgssd 服务。
     </para>
    </step>
   </procedure>
   <para>
    要进行 Kerberos 身份验证，也需要在服务器上运行 <systemitem class="daemon">idmapd</systemitem> 守护程序。有关详细信息，请参见<xref linkend="var-nfs-export-manual-idmapd"/>。
   </para>
   <para>
    有关配置采用 Kerberos 的 NFS 的更多信息，请参见<xref linkend="sec-nfs-info" xrefstyle="SectTitleOnPage"/> 中的链接。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-nfs-configuring-nfs-clients">
  <title>配置客户端</title>

  <para>
   要将主机配置为 NFS 客户端，无需安装其他软件。将默认安装所有需要的包。
  </para>

  <sect2 xml:id="sec-nfs-import-yast2">
   <title>使用 Yast 导入文件系统</title>
   <para>
    授权用户可以用 YaST NFS 客户端模块从 NFS 服务器将 NFS 目录装入本地文件树。按如下所示继续：
   </para>
   <procedure xml:id="pro-nfs-import-yast2">
    <title>导入 NFS 目录</title>
    <step>
     <para>
      启动 YaST NFS 客户端模块。
     </para>
    </step>

    <step>
     <para>
      单击 <guimenu>NFS 共享</guimenu>选项卡中的<guimenu>添加</guimenu>。输入 NFS 服务器的主机名、要导入的目录以及要在本地的哪个装入点装入此目录。
     </para>
    </step>


    <step>
     <para>
      使用 NFSv4 时，在 <guimenu>NFS 设置</guimenu>选项卡中选择<guimenu>启用 NFSv4</guimenu>。另外，<guimenu>NFSv4 域名</guimenu>必须包含 NFSv4 服务器所用的相同值。默认域为 <literal>localdomain</literal>。
     </para>
    </step>
    <step>
     <para>
      要对 NFS 使用 Kerberos 身份验证，必须启用 GSS 安全性。选择<guimenu>启用 GSS 安全</guimenu>。
     </para>
    </step>
    <step>
     <para>
      若要使用防火墙并允许从远程计算机访问服务，请启用 <guimenu>NFS 设置</guimenu>选项卡中的<guimenu>打开防火墙中的端口</guimenu>。防火墙状态将显示在复选框旁边。
     </para>
    </step>

    <step>
     <para>
      单击<guimenu>确定</guimenu>保存更改。
     </para>
    </step>
   </procedure>
   <para>
    配置写入<filename>/etc/fstab</filename>，并将装入指定的文件系统。当您稍后启动 YaST 配置客户端时，它还将读取此文件中的现有配置。
   </para>
   <tip>
    <title>NFS 用作根文件系统</title>
    <para>
     在通过网络以 NFS 共享形式装入根分区的（无磁盘）系统中，配置可供访问 NFS 共享的网络设备时需保持谨慎。
    </para>
    <para>
     关闭或重引导系统时，默认的处理顺序是关闭网络连接，然后卸载根分区。对于 NFS 根分区，这种顺序会产生问题，因为在尚未激活与 NFS 共享的网络连接的情况下，根分区无法完全卸载。为防止系统停用相关的网络设备，请按<xref linkend="sec-basicnet-yast-change-start"/>中所述打开网络设备配置选项卡，然后在<guimenu>设备激活</guimenu>窗格中选择<guimenu>通过 NFSroot</guimenu>。
    </para>
   </tip>

  </sect2>

  <sect2 xml:id="sec-nfs-import">
   <title>手动导入文件系统</title>

   <para>
    手动从 NFS 服务器导入文件系统的先决条件是运行 RPC 端口映射器。<option>nfs</option> 服务负责正确启动该程序；因此，请以 <systemitem class="username">root</systemitem> 身份输入 <command>systemctl start nfs</command> 来启动该服务。然后就可以使用 <command>mount</command> 将远程文件系统像本地分区那样装入文件系统中：
   </para>
<screen><prompt>tux &gt; </prompt>sudo mount <replaceable>HOST</replaceable>:<replaceable>REMOTE-PATH</replaceable><replaceable>LOCAL-PATH</replaceable></screen>
   <para>
    例如，要从 <systemitem>nfs.example.com</systemitem> 计算机导入用户目录，请使用：
   </para>
<screen><prompt>tux &gt; </prompt>sudo mount nfs.example.com:/home /home</screen>
   <sect3 xml:id="sec-nfs-automount">
    <title>使用自动装入服务</title>
    <para>
     autofs 守护程序可用于自动装入远程文件系统。请在 <filename>/etc/auto.master</filename> 文件中添加以下条目：
    </para>
<screen>/nfsmounts /etc/auto.nfs</screen>
    <para>
     如果 <filename>auto.nfs</filename> 文件正确填充，<filename>/nfsmounts</filename> 目录将作为客户端上所有 NFS 装入的 root 目录。选择 <filename>auto.nfs</filename> 这个名称是为了方便起见，您可以选择任何名称。在 <filename>auto.nfs</filename> 中为所有 NFS 装入添加条目，如下所示：
    </para>
<screen>localdata -fstype=nfs server1:/data
nfs4mount -fstype=nfs4 server2:/</screen>
    <para>
     以 <systemitem class="username">root</systemitem> 身份运行 <command>systemctl start autofs</command> 来激活该设置。对于此示例，<filename>/nfsmounts/localdata</filename>，<systemitem>server1</systemitem> 的 <filename>/data</filename> 目录将通过 NFS 装入，<systemitem>server2</systemitem> 的 <filename>/nfsmounts/nfs4mount</filename> 将通过 NFSv4 装入。
    </para>
    <para>
     如果在 autofs 服务正在运行时编辑了 <filename>/etc/auto.master</filename> 文件，则必须使用 <command>systemctl restart autofs</command> 重启动自动装载器才能使更改生效。
    </para>
   </sect3>
   <sect3 xml:id="sec-nfs-fstab">
    <title>手动编辑 <filename>/etc/fstab</filename></title>
    <para>
     通常，<filename>/etc/fstab</filename> 中的 NFSv3 装入项如下：
    </para>
<screen>nfs.example.com:/data /local/path nfs rw,noauto 0 0</screen>
    <para>
     对于 NFSv4 装入，请在第三列中使用 <literal>nfs4</literal> 而不是 <literal>nfs</literal>：
    </para>
<screen>nfs.example.com:/data /local/pathv4 nfs4 rw,noauto 0 0</screen>
    <para>
     <literal>noauto</literal> 选项可禁止在启动时自动装入文件系统。如果您要手动安装各文件系统，可以缩短只指定安装点的安装命令：
    </para>
<screen><prompt>tux &gt; </prompt>sudo mount /local/path</screen>
    <note>
     <title>启动时装入</title>
     <para>
      如果您没有输入 <literal>noauto</literal> 选项，系统的 init 脚本将在启动时处理这些文件系统的装入。
     </para>
    </note>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-nfs-pnfs">
   <title>并行 NFS (pNFS)</title>
   <para>
    NFS 是最老的协议之一，开发于上世纪八十年代。因此，如果您要共享小文件，NFS 通常能够满足需求。但是，当您要传送大文件或有大量的客户端要访问数据时，NFS 服务器会成为瓶颈，严重影响系统性能。这是因为文件迅速变大，而以太网的相对速度没有完全跟上这一变化。
   </para>
   <para>
    当您向普通 NFS 服务器请求文件时，服务器会查找文件元数据、收集所有数据并通过网络将数据传送到您的客户端。但是，无论文件的大小如何，性能瓶颈都会凸显出来：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      如果是小文件，则大部分时间都花在收集元数据上。
     </para>
    </listitem>
    <listitem>
     <para>
      如果是大文件，则大部分时间花在将数据从服务器传送到客户端上。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    pNFS 或并行 NFS 则突破了此种限制，因为它将文件系统元数据从数据位置分离出来。因此，pNFS 需要两类服务器：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      一个<emphasis>元数据</emphasis>或<emphasis>控制服务器</emphasis>，用于处理所有非数据通讯
     </para>
    </listitem>
    <listitem>
     <para>
      一个或多个<emphasis>储存服务器</emphasis>，用于存放数据
     </para>
    </listitem>
   </itemizedlist>
   <para>
    元数据和储存服务器组成单独一个逻辑 NFS 服务器。当客户端要读取或写入时，元数据服务器会告诉 NFSv4 客户端使用哪个储存服务器访问文件块。客户端可以直接访问该服务器上的数据。
   </para>
   <para>
    <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 仅在客户端上支持 pNFS。
   </para>
   <sect3 xml:id="sec-nfs-pnfs-yast">
    <title>使用 YaST 配置 pNFS 客户端</title>
    <para>
     请执行<xref linkend="pro-nfs-import-yast2"/>中所述的步骤，但选中 <guimenu>pNFS (v4.1)</guimenu> 复选框以及可选的 <guimenu>NFSv4 共享</guimenu>。YaST 会执行所有必需的步骤，并且会在文件 <filename>/etc/exports</filename> 中写入所有必要选项。 <remark>toms 2013-02-15:
           Is that enough? Any other files for pNFS?</remark>
    </para>
   </sect3>
   <sect3 xml:id="sec-nfs-pnfs-manual">
    <title>手动配置 pNFS 客户端</title>
    <para>
     请参阅<xref linkend="sec-nfs-import"/>着手配置。大多数配置通过 NFSv4 服务器完成。对于 pNFS，唯一的区别是将 <option>minorversion</option> 选项和元数据服务器 <replaceable>MDS_服务器</replaceable>添加到您的 <command>mount</command> 命令：
    </para>
<screen><prompt>tux &gt; </prompt>sudo mount -t nfs4 -o minorversion=1 <replaceable>MDS_SERVER</replaceable> <replaceable>MOUNTPOINT</replaceable></screen>
    <para>
     为方便调试，请更改 <filename>/proc</filename> 文件系统中的值：
    </para>
<screen><prompt>tux &gt; </prompt>sudo echo 32767 &gt; /proc/sys/sunrpc/nfsd_debug
<prompt>tux &gt; </prompt>sudo echo 32767 &gt; /proc/sys/sunrpc/nfs_debug</screen>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-nfs-info">
  <title>更多信息</title>
  <para>
   除了 <command>exports</command>、<command>nfs</command> 和 <command>mount</command> 的手册页外，还可在 <filename>/usr/share/doc/packages/nfsidmap/README</filename> 中找到关于配置 NFS 服务器和客户端的信息。有关更多联机文档，请参见以下网站：
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     在 <link xlink:href="http://nfs.sourceforge.net/">SourceForge</link> 上联机查找详细的技术文档。
    </para>
   </listitem>
   <listitem>
    <para>
     关于设置采用 Kerberos 的 NFS 的描述，请参见 <link xlink:href="http://www.citi.umich.edu/projects/nfsv4/linux/krb5-setup.html">NFS Version 4 Open Source Reference Implementation</link>。
    </para>
   </listitem>
   <listitem>
    <para>
     如果您对 NFSv4 有疑问，请参考 <link xlink:href="http://www.citi.umich.edu/projects/nfsv4/linux/faq/">Linux NFSv4 FAQ</link>（Linux NFSv4 常见问题）。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
