<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_offline.xml" version="5.0" xml:id="cha-update-offline">
 <title>オフラインでのアップグレード</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    この章では、インストールメディアからブートしたYaSTを使用して、既存のSUSE Linux Enterpriseインストール環境をアップグレードする方法を説明します。YaSTインストーラは、たとえばDVDから起動したり、ネットワーク上で起動したり、システムが存在するハードディスクから起動したりできます。
   </para>
  </abstract>
 </info>
 <sect1 xml:id="sec-update-offline-conceptual-overview">
  <title>概念の概要</title>
  <para>
   システムをアップグレードする前に、まず<xref linkend="sec-update-prep"/>をお読みください。
  </para>
  <para>
   システムをアップグレードするには、新規インストールの場合と同じようにインストールソースからブートします。ただし、ブート画面が表示されたときに、<guimenu>アップグレード</guimenu>を選択します(<guimenu>インストール</guimenu>ではありません)。アップグレードは次の場所から開始できます。
  </para>

  <itemizedlist>
   <listitem>
    <formalpara>
     <title>リムーバブルメディア</title>
     <para>
      CD、DVD、USB大容量ストレージデバイスなどです。詳細については、「<xref linkend="sec-update-offline-dvd"/>」を参照してください。
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>ネットワークリソース</title>
     <para>
      ローカルメディアからブートして、それぞれのネットワークインストールタイプを選択することも、PXEを介してブートすることもできます。詳細については、<xref linkend="sec-update-offline-network"/>を参照してください。
     </para>
    </formalpara>
   </listitem>
  </itemizedlist>
 </sect1>


 <sect1 xml:id="sec-update-offline-dvd">
  <title>インストールメディアからのアップグレードの開始</title>
  <para>
   次の手順では、DVDからブートする方法を説明していますが、USB大容量ストレージデバイス上のISOイメージなど、他のローカルインストールメディアを使用することもできます。どのメディアとブート方法を選択するかは、システムアーキテクチャと、マシンに従来のBIOSまたはUEFIのどちらが搭載されているかによって決まります。
  </para>
  <procedure xml:id="pro-update-sle12-offline-dvd">
   <title>SLE 11 SP5からSLE 12 SP4への手動アップグレード</title>
   <step>
    <para>
     ブートメディアを選択して準備します。<xref linkend="sec-i-yast2-startup"/>を参照してください。
    </para>
   </step>
   <step>
    <para>
     SUSE Linux Enterprise 12 SP5インストールメディアのDVDを挿入し、マシンをブートします。<guimenu>ようこそ</guimenu>画面が表示され、続けてブート画面が表示されます。
    </para>
   </step>
   <step>
    <para>
     ブートメニューで［アップグレード］を選択してシステムを起動します。
    </para>
   </step>
   <step>
    <para>
     <xref linkend="sec-update-sle12-start-upgr-after-boot"/>の説明に従って、アップグレードプロセスを進めます。
    </para>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec-update-offline-network">
  <title>ネットワークソースからのアップグレードの開始</title>
  <para>
   ネットワークインストールソースからアップグレードを開始する場合、以下の要件を満たしていることを確認してください。
  </para>
  <variablelist>
   <title>ネットワークインストールソースからのアップグレードの要件</title>
   <varlistentry>
    <term>ネットワークインストールソース</term>
    <listitem>
     <para>
      ネットワークインストールソースが<xref linkend="cha-deployment-instserver"/>の記述どおりにセットアップされていること。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>ネットワーク接続およびネットワークサービス</term>
    <listitem>
     <para>
      インストールサーバとターゲットマシンの両方で、ネットワーク接続が正常に動作すること。必要なネットワークサービスは次のとおりです。
     </para>
     <itemizedlist>
      <listitem><para>ドメインネームサービス</para></listitem>
      <listitem><para>DHCP (PXEでブートする場合にのみ必要。IPはセットアップ時に手動で設定可能)</para></listitem>
      <listitem><para>OpenSLP (オプション)</para></listitem>
     </itemizedlist>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>ブートメディア</term>
    <listitem>
     <para>
      ターゲットシステムのブートに使用する、<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> DVD 1 (またはローカルISOイメージ)を保有していること。「または」<xref linkend="sec-deployment-prep-boot-pxeprep" xrefstyle="HeadingOnPage"/>の説明のとおり、PXEを介したブート用に設定されたターゲットシステムがあること。リモートサーバからのアップグレードの詳細については、<xref linkend="cha-deployment-remoteinst"/>を参照してください。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <sect2 xml:id="sec-update-sle-manual-network-boot-from-dvd">
   <title>ネットワークインストールソース経由での手動アップグレード - DVDからのブート</title>
   <para>
    次の例では、DVDからブートする手順を説明していますが、USB大容量ストレージデバイス上のISOイメージなど、他のローカルインストールメディアを使用することもできます。ブート方式の選択し、メディアからシステムを起動する方法は、システムアーキテクチャ、およびマシンに従来型のBIOSまたはUEFIが装備されているかどうかによって異なります。詳しくは、以下のリンクを参照してください。
   </para>
   <procedure xml:id="pro-update-sle-manual-network-boot-from-dvd">

    <step>
     <para>
      SUSE Linux Enterprise 12 SP5インストールメディアのDVDを挿入し、マシンをブートします。<guimenu>ようこそ</guimenu>画面が表示され、続けてブート画面が表示されます。
     </para>
    </step>
    <step>
     <para>
      使用するネットワークインストールソースのタイプ(FTP、HTTP、NFS、SMB、またはSLP)を選択します。通常、選択肢は<keycap>F4</keycap>キーを押すと表示されますが、ご使用のマシンに従来型のBIOSではなくUEFIが搭載されている場合は、パラメータを手動で調整しなければならない場合があります。詳細については、<xref linkend="sec-i-yast2-source-net"/>内の<xref linkend="cha-inst"/>を参照してください。
     </para>
    </step>
    <step>
     <para>
      <xref linkend="sec-update-sle12-start-upgr-after-boot"/>の説明に従って、アップグレードプロセスを進めます。
     </para>
    </step>
   </procedure>
  </sect2>
  <sect2 xml:id="sec-update-sle-manual-network-pxe-boot">
   <title>ネットワークインストールソース経由での手動アップグレード - PXEでのブート</title>
   <para>
    PXEブートを使用して、ネットワークインストールソースからアップグレードを実行するには、以下のようにします。
   </para>
   <procedure xml:id="pro-update-sle-manual-network-pxe-boot">
    <step>
     <para>
      DHCPサーバの設定を調整してPXEブートに必要なアドレス情報を指定します。詳細については、<xref linkend="sec-deployment-prep-boot-pxeprep"/>を参照してください。
     </para>
    </step>
    <step>
     <para>
      PXEブートに必要なブートイメージを保管するTFTPサーバを設定します。これを行うには、SUSE Linux Enterprise 12 SP5インストールメディアのDVDを使用するか、<xref linkend="sec-deployment-prep-boot-tftp"/>の説明に従います。
     </para>
    </step>
    <step>
     <para>
      ターゲットマシンにPXEブートとWake-on-LANを準備します。
     </para>
    </step>
    <step>
     <para>
      ターゲットシステムのブートを開始し、VNCを使用してこのコンピュータで実行中のインストールルーチンにリモートで接続します。詳細については、<xref linkend="sec-deployment-remoteinst-monitor-vnc"/>を参照してください。
     </para>
    </step>
    <step>
     <para>
      <xref linkend="sec-update-sle12-start-upgr-after-boot"/>の説明に従って、アップグレードプロセスを進めます。
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>

 <sect1 xml:id="sec-update-offline-automated">
  <title>自動アップグレードの有効化</title>
  <para>
   アップグレードプロセスを自動的に実行できます。自動更新を有効にするには、カーネルパラメータ<literal>autoupgrade = 1</literal>を設定する必要があります。このパラメータはブート時に［<literal>ブートオプション</literal>］フィールドで設定できます。<phrase os="sles">詳細については、<xref linkend="introduction"/>を参照してください。</phrase>
  </para>
 </sect1>
 <sect1 xml:id="sec-update-sle12-start-upgr-after-boot">
  <title>SUSE Linux Enterpriseのアップグレード</title>
  <para>
   <remark>taroth 2014-11-13: argh, the following is terminology hell regarding
     the software strings: "upgrade"/"update" are used intermittently and
     without clear differentiation...</remark>
  </para>
  <para>
   システムのアップグレード前に、<xref linkend="sec-update-prep"/>をご覧ください。自動マイグレーションを実行するには、次の手順に従います。
  </para>
  <procedure>
   <step>
    <para>
     ブートした後(インストールメディアまたはネットワーク、いずれかの方法による)、ブート画面の<guimenu>アップグレード</guimenu>エントリを選択します。次の手順で説明されている方法で手動でアップグレードを実行する場合は、自動アップグレードプロセスを無効にする必要があります。「<xref linkend="sec-update-offline-automated"/>」を参照してください。
    </para>
    <warning>
     <title>選択を間違えるとデータを失う場合があります。</title>
     <para>
      <guimenu>アップグレード</guimenu>ではなく<guimenu>インストール</guimenu>を選択すると、データが失われる可能性があります。新規インストールを実行してデータパーティションを壊さないよう十分に注意してください。
     </para>
     <para>
      ここでは、必ず<guimenu>アップグレード</guimenu>を選択してください。
     </para>
    </warning>
    <para>
     YaSTはインストールシステムを起動します。
    </para>
   </step>
   <step>
    <para>
     <guimenu>ようこそ</guimenu>画面で、<guimenu>言語</guimenu>および<guimenu>キーボード</guimenu>を選択し、ライセンス契約に同意します。<guimenu>次へ</guimenu>で続行します。
    </para>
    <para>
     YaSTは、インストール済みのSUSE Linux Enterpriseシステムのパーティションをチェックします。
    </para>
   </step>
   <step>
    <para>
     <guimenu>Select for Upgrade(アップグレードの選択)</guimenu>画面で、アップグレードするパーティションを選択して、<guimenu>次へ</guimenu>をクリックします。
    </para>
    <para>
     YaSTは、選択したパーティションをマウントし、アップグレードするパーティション上の検出されたすべてのリポジトリを表示します。
    </para>
   </step>
   <step>
    <para>
     <guimenu>Previously Used Repositories(前に使用していたリポジトリ)</guimenu>画面で、リポジトリのステータスを調整します。アップグレードプロセスに組み込むリポジトリは有効にして、必要のないリポジトリは無効にします。<guimenu>次へ</guimenu>で続行します。
    </para>
   </step>
   <step>
    <para>
     <guimenu>登録</guimenu>画面で、アップグレードしたシステムを今すぐに登録するか(登録データを入力して、<guimenu>次へ</guimenu>をクリック)、または<guimenu>Skip Registration(登録をスキップ)</guimenu>します。ご使用のシステムの登録について詳しくは、<xref linkend="sec-update-registersystem"/>を参照してください。
    </para>
   </step>
   <step>
    <para>
     アップグレードでの<guimenu>インストール設定</guimenu>を確認します(特に<guimenu>アップグレードオプション</guimenu>を確認します)。次のオプションから選択します。
    </para>
    <itemizedlist>
     <listitem>
      <para>
       <guimenu>Only Update Installed Packages(インストール済みパッケージの更新のみ)</guimenu>。この場合、最新のSUSE Linux Enterpriseバージョンに付属している新機能が欠落する可能性があります。
      </para>
     </listitem>
     <listitem>
      <para>
       <guimenu>Update with Installation of New Software(新しいソフトと機能を含むアップデート)</guimenu>有効、無効にするパターンおよびパッケージを選択したい場合は、<guimenu>Select Patterns(パターンの選択)</guimenu>をクリックします。
      </para>
     </listitem>
    </itemizedlist>

    <note>
     <title>デスクトップの選択</title>
     <para>
      SUSE Linux Enterprise 12へのアップグレード前にKDEを使用していた場合 (<varname>DEFAULT_WM</varname> (<filename>/etc/sysconfig/windowmanager</filename>内)が<literal>kde*</literal>に設定)、デスクトップ環境は、アップグレード後、自動的にGNOMEに置き換わります。デフォルトでは、KDM表示のマネージャはGDMに置き換わります。
     </para>
     <para>
      デスクトップ環境またはウィンドウマネージャの選択を変更するには、<guimenu>Select Patterns(パターンの選択)</guimenu>をクリックして、ソフトウェア選択を調整します。
     </para>
    </note>
   </step>
   <step>
    <para>
     すべての設定を希望どおりに完了したら、<guimenu>アップデート</guimenu>をクリックして、インストールおよび削除の手順を開始します。
    </para>
   </step>
   <step>
    <para>
     アップグレードプロセスが正常に完了したら、<quote>孤立したパッケージ</quote>がないかどうかを確認します。孤立したパッケージとは、どのアクティブなリポジトリにも属していないパッケージのことです。次のコマンドで、それらのリストを表示できます。
    </para>
<screen>zypper packages --orphaned</screen>
    <para>
     このリストを使用して、パッケージが引き続き必要か、それともアンインストールしても安全かを判断できます。
    </para>
   </step>
  </procedure>
  <para>
   アップグレードするマシンがSMTクライアントで、アップグレードが失敗する場合は、<xref linkend="pro-sec-update-prep-smt-de-register"/>を参照して、後でアップグレード手順を再開してください。
  </para>
 </sect1>
 <sect1 xml:id="sec-update-sle-manager">
  <title>SUSE Managerによるアップデート</title>

  <para>
   SUSE Managerは、SUSE Linux Enterpriseクライアントに対するアップデート、パッチ、およびセキュリティ修正を提供するためのサーバソリューションです。これには、一連のツールと、管理タスク用のWebベースのユーザインタフェースが付属しています。SUSE Managerの詳細については、<link xlink:href="https://www.suse.com/products/suse-manager/"/>を参照してください。
  </para>
  
  <para>
   SUSE Managerは、SPマイグレーションまたはシステムの完全アップグレードをサポートできます。
  </para>

  <variablelist>
   
   <varlistentry>
    <term>SPマイグレーション</term>
    <listitem>
     <para>
      SPマイグレーションにより、1つのメジャーバージョン内で特定のサービスパック(SP)を別のSPにマイグレートできます(たとえば、SLES 12 SP1から12 SP2)。詳細については、『<citetitle>SUSE Manager Best Practices』の<quote>Client Migration</quote></citetitle>を参照してください。<link xlink:href="https://documentation.suse.com/external-tree/en-us/suma/3.2/susemanager-best-practices/html/book.suma.best.practices/bp.client.migration.html"/>
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>システムのアップグレード</term>
    <listitem>
     <para>
      SUSE Managerを使用して、システムのアップグレードを実行できます。統合されたAutoYaST技術により、メジャーバージョンから次のメジャーバージョンにアップグレードできます(たとえば、SLES 11 SP3から12 SP2)。詳細については、『<citetitle>SUSE Manager Best Practices』の<quote>Client Migration</quote></citetitle>を参照してください。<link xlink:href="https://documentation.suse.com/external-tree/en-us/suma/3.2/susemanager-best-practices/html/book.suma.best.practices/bp.client.migration.html"/>
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
<para>
  <remark>taroth 2018-09-26: the SUMA docs do not cover migration to
   SLE 12 SP4 yet, therefore removed the specific section title from
   the pointers above and filed https://bugzilla.suse.com/show_bug.cgi?id=1109790
 </remark>
</para>
 </sect1>
 <sect1 xml:id="sec-update-reg-status-after-rollback">
  <title>ロールバック後の登録状態の更新</title>

  <para>
   サービスパックのアップグレードを実行する場合は、登録サーバで設定を変更して、新しいリポジトリへのアクセスを提供する必要があります。アップグレードプロセスが中断されたり、(バックアップまたはスナップショットからの復元によって)取り消されたりすると、登録サーバ上の情報とシステムの状態との一貫性が損なわれます。これにより、更新ポジトリにアクセスできなくなったり、クライアントで間違ったリポジトリが使用されたりすることがあります。
  </para>

  <para>
   Snapperによってロールバックが実行される場合、システムは登録サーバに通知し、ブートプロセス中に正しいリポジトリへのアクセスが設定されるようにします。システムがその他の方法で復元された場合や、登録サーバとの通信が何らかの理由で(たとえば、ネットワークに問題があるためサーバにアクセスできないなど)失敗した場合には、次のコマンドを呼び出して、クライアント上でロールバックを手動でトリガします。
  </para>

<screen><command>snapper</command> rollback</screen>

  <para>
   次のコマンドを使用して、システムに正しいリポジトリが設定されていることを常に確認することをお勧めします。特にサービスの更新後は必ず確認してください。
  </para>

<screen><command>zypper</command> ref -s</screen>

  <para>
   この機能は
   <package>rollback-helper</package>
   パッケージで利用できます。
  </para>
 </sect1>
 <sect1 xml:id="sec-update-registersystem">


  <title>システムの登録</title>

  <para>
   インストールの際に登録のステップを省略していても、YaSTで<guimenu>製品登録</guimenu>モジュールを使用すれば、いつでもシステムを登録できます。
  </para>

  <para>
   ご使用のシステムを登録すると以下の利点があります。
  </para>

  <itemizedlist>
   <listitem>
    <para>
     サポート利用資格
    </para>
   </listitem>
   <listitem>
    <para>
     セキュリティアップデートとバグフィックスの入手
    </para>
   </listitem>
   <listitem>
    <para>
     SUSEカスタマーセンターへのアクセス
    </para>
   </listitem>
  </itemizedlist>

  <procedure>
   <step>
    <para>
     YaSTを起動し、<menuchoice> <guimenu>ソフトウェア</guimenu>
     <guimenu>製品登録</guimenu> </menuchoice>を選択して、<guimenu>登録</guimenu>ダイアログを開きます。
    </para>
   </step>
   <step>
    <para>
     各自または各自の組織が登録の管理に使用しているSUSEアカウントに関連付けられた<guimenu>電子メール</guimenu>アドレスを指定します。SUSEアカウントをまだ作成していない場合は、SUSEのカスタマセンターのホームページ(<link xlink:show="new" xlink:href="https://scc.suse.com/"/>)でアカウントを作成します。
    </para>
   </step>
   <step>
    <para>
     <guimenu>SUSE Linux Enterprise Server</guimenu>に添付されている登録コード<phrase role="productname"><phrase os="sles"/></phrase>を入力します。
    </para>
   </step>
   <step xml:id="step-y2-register-final">
    <para>
     登録を開始するには、<guimenu>次へ</guimenu>で続行します。ネットワーク上で1台または複数台のローカル登録サーバが使用可能な場合は、リストに示されたサーバのうちいずれかを選択できます。または、ローカルの登録サーバを無視し、デフォルトであるSUSEの登録サーバに登録するには、<guimenu>キャンセル</guimenu>を選択します。
    </para>
    <para>
     登録時にオンラインの更新リポジトリがアップグレードのセットアップに追加されます。登録を完了すると、使用可能な最新バージョンのパッケージをその更新リポジトリからインストールするかどうかを選択できます。これにより、すべてのパッケージにクリーンアップグレードパスが提供され、<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>は使用可能な最新のセキュリティアップデートによってアップグレードされるようになります。<guimenu>いいえ</guimenu>を選択すると、インストールメディアからすべてのパッケージがインストールされます。<guimenu>次へ</guimenu>で続行します。
    </para>
    <para>
     正常に登録されると、YaSTにより、システムで使用可能な拡張機能、アドオン、およびモジュールが表示されます。これらを選択してインストールするには、<xref linkend="sec-add-ons-installation"/>に進みます。
    </para>
   </step>
  </procedure>
 </sect1>

</chapter>
