<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xml:base="deployment_kiwi.xml" id="cha.autokiwi">

 <title>Déploiement automatique des images de préchargement</title>
 <abstract>
  <para>
   KIWI vous permet de créer des images du système d'exploitation. Ce chapitre décrit le processus de déploiement d'une image système sur une machine cliente vide. Pour ce faire, vous devez créer une image de préchargement qui contient une image BRUTE amorçable. Ce fichier se divise en deux parties importantes : une table de partition et le système d'exploitation actuel. Cette image BRUTE sera enregistrée sur le disque dur vide et le système d'exploitation occupera l'espace disque restant lors du démarrage initial.
  </para>

 </abstract>
 <para>
  Pour créer ce type d'image, reportez-vous au site <ulink url="http://doc.opensuse.org/projects/kiwi/doc/"/>. Lorsque vous créez l'image ISO, vous pouvez trouver le fichier BRUT dans le répertoire de destination. Il existe plusieurs façons de copier une image brute sur un disque.
 </para>
 <itemizedlist mark="bullet" spacing="normal">
  <listitem>
   <para>
    Insérez le disque dans un serveur de déploiement et copiez l'image sur le périphérique brut.
   </para>
  </listitem>
  <listitem>
   <para>
    Fournissez l'image brute à l'aide d'un serveur HTTP ou FTP et transférez-la sur le disque de la machine cliente.
   </para>
  </listitem>
  <listitem>
   <para>
    Créez une image de démarrage réseau pour récupérer l'image et la transférer sur le disque. Ceci est une bonne méthode pour le déploiement de masse.
   </para>
  </listitem>
  <listitem>
   <para>
    Démarrez un disque de secours et effectuez manuellement le transfert à partir de l'image de secours.
   </para>
  </listitem>
 </itemizedlist>
 <para>
  Pour un démarrage rapide, il est recommandé d'utiliser l'une des méthodes décrites dans la <xref linkend="sec.autokiwi.manual"/>.
 </para>
 <sect1 id="sec.autokiwi.manual">
  <title>Déploiement manuel du système à partir d'une image de secours</title>

  <variablelist>
   <varlistentry>
    <term>Déploiement avec un fichier ISO généré à partir de KIWI :</term>
    <listitem>
     <orderedlist spacing="normal">
      <listitem>
       <para>
        Gravez l'image ISO obtenue via le processus de création de KIWI sur le CD/DVD.
       </para>
      </listitem>
      <listitem>
       <para>
        Démarrez la machine cliente à partir de ce support.
       </para>
      </listitem>
      <listitem>
       <para>
        Sélectionnez le disque dur sur lequel vous allez procéder à l'installation.
       </para>
      </listitem>
      <listitem>
       <para>
        Redémarrez la machine cliente depuis le disque dur.
       </para>
      </listitem>
     </orderedlist>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Déploiement sur un système de secours :</term>
    <listitem>
     <orderedlist spacing="normal">
      <listitem>
       <para>
        Démarrez la machine cliente avec un système de secours. De tels systèmes sont disponibles sur tous les CD ou DVD d'installation SUSE.
       </para>
      </listitem>
      <listitem>
       <para>
        Loguez-vous en tant qu'utilisateur <systemitem class="username">root</systemitem>. N'entrez pas de mot de passe.
       </para>
      </listitem>
      <listitem>
       <para>
        Configurez votre réseau. Si le protocole DHCP est disponible sur votre réseau, utilisez uniquement la commande <command>ifup-dhcp eth0</command>. Si vous devez effectuer cette procédure manuellement, utilisez la commande <command>ip</command> pour configurer votre réseau. Le protocole DHCP de sortie vous indique également l'adresse IP de l'ordinateur.
       </para>
      </listitem>
      <listitem>
       <para>
        Utilisez un port inutilisé de votre réseau, comme <systemitem>1234</systemitem>, et transférez les données entrantes sur le disque à l'aide de la commande suivante :
       </para>
<screen>netcat -l -p 1234 &gt; /dev/sda</screen>
      </listitem>
      <listitem>
       <para>
        Sur le serveur de création d'images, envoyez l'image brute vers la machine cliente à l'aide de la commande :
       </para>
<screen>netcat &lt;IP of client&gt; 1234 &lt; $HOME/preload_image/&lt;image_name&gt;</screen>
      </listitem>
      <listitem>
       <para>
        Une fois l'image transférée, supprimez le système de secours de votre lecteur de CD ou DVD et arrêtez la machine cliente. Lors du redémarrage, le chargeur de démarrage <literal>GRUB</literal> doit être démarré sur le client et le système Firstboot prend le relais.
       </para>
      </listitem>
     </orderedlist>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 id="sec.autokiwi.pxe">
  <title>Déploiement automatisé avec le démarrage PXE</title>

  <para>
   Lorsque vous effectuez plusieurs installations d'un système d'exploitation sur un matériel similaire, il est intéressant de préparer un déploiement de masse du système d'exploitation et de réduire le temps requis pour le déploiement réel. Ce chapitre décrit ce processus. L'objectif consiste simplement à brancher un ordinateur, à le connecter à un réseau, à lancer un démarrage réseau et à attendre qu'il s'éteigne.
  </para>

  <para>
   Les opérations suivantes doivent être exécutées dans l'ordre afin d'accomplir cette tâche :
  </para>

  <variablelist>
   <varlistentry>
    <term>Configuration d'un serveur de démarrage et d'installation</term>
    <listitem>
     <para>
      Une machine dédiée est nécessaire et doit être préparée pour proposer un démarrage PXE, ainsi qu'un serveur FTP ou Web pour fournir une image de préchargement. Il est recommandé de doter la machine de suffisamment de mémoire pour conserver toutes les données d'installation nécessaires. Pour une installation par défaut, vous devez disposer d'une mémoire de 4 Go minimum. Toutes les tâches nécessaires peuvent être exécutées avec SUSE Linux Enterprise Server. Pour plus de détails, reportez-vous à la <xref linkend="sec.autokiwi.instserver"/>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Préparation d'une image de préchargement</term>
    <listitem>
     <para>
      L'installation s'effectue en copiant une image brute du système d'exploitation sur le nouveau disque dur. Les fonctionnalités et les paramètres doivent être attentivement préparés et testés. Pour fournir une telle image, KIWI peut être utilisé (disponible dans le kit SDK du système d'exploitation SUSE Linux Enterprise). Vous trouverez plus d'informations sur la création d'images avec KIWI à l'adresse <ulink url="http://doc.opensuse.org/projects/kiwi/doc/"/>. Pour plus de détails sur les exigences liées à l'image de préchargement, reportez-vous à la <xref linkend="sec.autokiwi.preloadimage"/>.
     </para>
     <para>
      Le kit SDK contenant KIWI est un produit complémentaire pour SUSE Linux Enterprise que vous pouvez télécharger à partir du site <ulink url="http://download.suse.com/"/>. Recherchez ensuite <literal>SUSE Linux Enterprise Software Development Kit</literal>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Création d'un système initial pour le déploiement</term>
    <listitem>
     <para>
      Cette tâche nécessite une bonne connaissance de Linux. Vous trouverez une description de la procédure à suivre et un exemple d'installation dans la <xref linkend="sec.autokiwi.initrd"/>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Configuration du serveur de démarrage en vue d'un déploiement automatique</term>
    <listitem>
     <para>
      Le démarrage PXE doit démarrer le système d'installation qui, à son tour, récupère l'image de préchargement à partir du serveur et la copie sur le disque dur.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <sect2 id="sec.autokiwi.instserver">
   <title>Configuration d'un serveur de démarrage et d'installation</title>
   <para>
    Quatre étapes doivent être effectuées pour accomplir cette tâche après l'installation de SUSE Linux Enterprise Server :
   </para>
   <procedure id="proc.autokiwi.instserver">
    <step performance="required">
     <para>
      Configurez la source d'installation en suivant la procédure décrite à la <xref linkend="sec.deployment.remoteinst.instserver"/>. Choisissez un serveur réseau HTTP ou FTP.
     </para>
    </step>
    <step performance="required">
     <para>
      Configurez un serveur TFTP pour conserver une image de démarrage (qui sera créée à l'étape suivante). Cela est décrit à la <xref linkend="sec.deployment.remoteinst.boot.tftp"/>.
     </para>
    </step>
    <step performance="required">
     <para>
      Configurez un serveur DHCP de manière à fournir des adresses IP à toutes les machines et indiquez l'emplacement du serveur TFTP au système cible. Cela est décrit à la <xref linkend="sec.deployment.remoteinst.boot.dhcp"/>.
     </para>
    </step>
    <step performance="required">
     <para>
      Préparez le démarrage PXE du serveur d'installation. Cette opération est décrite plus en détail à la <xref linkend="sec.deployment.remoteinst.boot.pxe"/>.
     </para>
    </step>
   </procedure>
   <para>
    Notez que le processus d'installation actuel gagnera en rapidité si vous dotez cette machine de suffisamment de mémoire pour héberger l'image de préchargement. Par ailleurs, l'utilisation de Gigabit Ethernet accélère considérablement le processus de déploiement (par rapport à des réseaux plus lents).
   </para>
  </sect2>

  <sect2 id="sec.autokiwi.preloadimage">
   <title>Création d'une image de préchargement</title>
   <para>
    Le processus de création d'images avec KIWI est décrit à l'adresse <ulink url="http://doc.opensuse.org/projects/kiwi/doc/"/>. Toutefois, pour créer une image utile en vue du déploiement de masse, plusieurs considérations doivent être prises en compte :
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      Une image de préchargement typique utilise le type suivant :
     </para>
<screen>&lt;type primary="true" filesystem="btrfs" boot="oemboot/suse-SLES12"&gt;vmx&lt;/type&gt;</screen>
    </listitem>
    <listitem>
     <para>
      Pendant la configuration d'une image de préchargement, le processus de création d'image s'exécute plusieurs fois. Les dépôts nécessaires pour créer l'image doivent être disponibles sur l'ordinateur local.
     </para>
    </listitem>
    <listitem>
     <para>
      En fonction de l'usage souhaité de l'image de préchargement, la configuration de Firstboot peut avoir son importance. Pour plus de détails sur Firstboot, reportez-vous au <xref linkend="cha.deployment_firstboot"/>. Avec cette méthode, vous pouvez également demander à l'utilisateur d'effectuer des configurations initiales au premier démarrage du système.
     </para>
    </listitem>
    <listitem>
     <para>
      De nombreuses fonctionnalités supplémentaires peuvent être configurées dans l'image, comme l'ajout de dépôts de mise à jour ou l'exécution d'une mise à jour au démarrage initial. Il est toutefois impossible de décrire toutes les possibilités dans ce document. Par ailleurs, la création de l'image de préchargement nécessite (selon les exigences) une connaissance approfondie du système de création d'images KIWI, ainsi que d'autres technologies utilisées dans <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    L'image à déployer doit être disponible sur le serveur FTP ou HTTP que vous avez spécifié sur le serveur d'installation.
   </para>
  </sect2>

  <sect2 id="sec.autokiwi.initrd">
   <title>Création d'un système initial pour déployer une image de préchargement</title>
   <para>
    Afin d'exécuter un déploiement automatique, il est nécessaire de démarrer un système Linux initial sur l'ordinateur cible. Lors d'une installation type, le kernel et le système de fichiers RAM initial sont lus à partir d'un support de démarrage et lancés par le BIOS. Les fonctionnalités nécessaires peuvent être mises en oeuvre dans le système de fichiers RAM qui, associé au kernel, fera office de système initial.
   </para>
   <para>
    Les principales fonctionnalités devant être fournies par le système initial sont l'activation de l'accès au disque dur et la mise à disposition de la connexion réseau. Ces deux fonctions dépendent du matériel sur lequel vous voulez effectuer le déploiement. En théorie, il est possible de créer un système initial de toutes pièces mais, pour simplifier cette tâche, vous pouvez également modifier le système de fichiers RAM utilisé par la machine pendant le démarrage.
   </para>
   <para>
    La procédure suivante illustre simplement une façon de créer le système de fichiers RAM initial requis :
   </para>
   <procedure>
    <step performance="required">
     <para>
      Effectuez une installation standard de <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> sur le système cible.
     </para>
    </step>
    <step performance="required">
     <para>
      Installez le paquetage <systemitem>busybox</systemitem> sur le système.
     </para>
    </step>
    <step performance="required">

     
     
     <para>
      Créez un système de fichiers RAM à l'aide de la commande suivante :
     </para>
<screen>mkinitrd -f busybox -D eth0</screen>
     <para>
      Notez que eth0 représente le périphérique Ethernet auquel votre câble réseau est relié. Le paramètre <systemitem>-f busybox</systemitem> ajoute le binaire MultiCall <systemitem>busybox</systemitem> au système de fichiers RAM. Après quoi, de nombreuses commandes Unix standard seront disponibles dans ce système.
     </para>
    </step>
    <step performance="required">
     <para>
      Copiez le nouveau système de fichiers RAM et le kernel sur votre serveur de démarrage à l'aide de la commande :
     </para>
<screen>scp /boot/initrd /boot/vmlinuz pxe.example.com:</screen>
     <para>
      Remplacez pxe.exemple.com par le nom de votre serveur de démarrage local ou son adresse IP.
     </para>
    </step>
    <step performance="required">
     <para>
      Connectez-vous à votre serveur de démarrage en tant qu'utilisateur <systemitem class="username">root</systemitem> et créez un répertoire dans lequel vous pourrez modifier le système de fichiers RAM :
     </para>
<screen>mkdir ~/bootimage</screen>
    </step>
    <step performance="required">
     <para>
      Définissez votre répertoire de travail sur ce répertoire à l'aide de la commande <command>cd ~/bootimage</command>.
     </para>
    </step>
    <step performance="required">
     <para>
      Décompressez le système de fichiers RAM initial précédemment copié à l'aide de la commande :
     </para>
<screen>zcat ../initrd | cpio -i</screen>
    </step>
    <step performance="required">
     <para>
      Modifiez le fichier <filename>run_all.sh</filename>.
     </para>
    </step>
    <step performance="required">
     <para>
      Recherchez la ligne suivante, supprimez-la, ainsi que le reste du fichier :
     </para>
<screen>[ "$debug" ] &amp;&amp; echo preping 21-nfs.sh </screen>
    </step>
    <step performance="required">
     <para>
      Ajoutez les lignes suivantes à la fin des fichiers <filename>run_all.sh</filename>:
     </para>
<screen>[ "$debug" ] &amp;&amp; echo preping 92-install.sh
[ "$debug" ] &amp;&amp; echo running 92-install.sh
source boot/92-install.sh
[ "$modules" ] &amp;&amp; load_modules
     </screen>
    </step>
    <step performance="required">
     <para>
      Créez un nouveau script <filename>boot/92-install.sh</filename> avec le contenu suivant :
     </para>
<screen>#!/bin/bash
if [ "$(get_param rawimage)" ]; then
  rawimage=$(get_param rawimage)
  if  [ "$(get_param rawdevice)" ]; then
    rawdevice=$(get_param rawdevice)
    echo "wget -O ${rawdevice} ${rawimage}"
    wget -O ${rawdevice} ${rawimage}
    sync
    sleep 5
    echo "DONE"
  fi
fi
# /bin/bash
/bin/poweroff -f
</screen>
    </step>
    <step performance="required">
     <para>
      Si vous souhaitez avoir un shell de débogage avant l'arrêt de l'ordinateur, supprimez le signe de commentaire devant <filename>/bin/bash</filename>.
     </para>
    </step>
    <step performance="required">
     <para>
      Exécutez ce script à l'aide de la commande <command>chmod 755 boot/92-install.sh</command>.
     </para>
    </step>
    <step performance="required">
     <para>
      Créez un système de fichiers RAM initial à l'aide des commandes :
     </para>
<screen>mkdir -p /srv/tftpboot
find . | cpio --quiet -H newc -o | gzip -9 -n &gt; \
/srv/tftpboot/initrd.boot</screen>
    </step>
    <step performance="required">
     <para>
      Copiez le kernel dans ce répertoire :
     </para>
<screen>cp ../vmlinuz /srv/tftpboot/linux.boot</screen>
    </step>
   </procedure>
   <para>
    Le système de fichiers RAM initial est maintenant prêt à traiter deux nouveaux paramètres de ligne de commande de kernel. Le paramètre <systemitem>rawimage=&lt;URL&gt;</systemitem> permet d'identifier l'emplacement de l'image de préchargement. Toute URL comprise par wget peut être utilisée. Le paramètre <systemitem>rawdevice=&lt;périphérique&gt;</systemitem> permet d'identifier le périphérique de bloc du disque dur sur la machine cible.
   </para>
  </sect2>

  <sect2>
   <title>Configuration du serveur de démarrage</title>
   <para>
    La configuration du serveur de démarrage est abordée en détails dans différents chapitres. Voir <xref linkend="sec.autokiwi.instserver"/>. Cette section comporte une liste des étapes nécessaires pour configurer le système.
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      Configurez un serveur DHCP. Le sous-réseau dans lequel les machines sont installées requiert les lignes supplémentaires suivantes :
     </para>
<screen>filename "pxelinux.0";
next-server 192.168.1.115;</screen>
     <para>
      Dans cet exemple, 192.168.1.115 correspond à l'adresse IP du serveur PXE pxe.exemple.com.
     </para>
    </listitem>
    <listitem>
     <para>
      Configurez un serveur PXE en suivant les instructions de la <xref linkend="sec.deployment.remoteinst.boot.pxe"/>. Lors de la modification de <filename>/srv/tftpboot/pxelinux.cfg/default</filename>, ajoutez les entrées suivantes :
     </para>
<screen>default bootinstall
label bootinstall
  kernel linux.boot
  append initrd=initrd.boot \
  rawimage=ftp://192.168.1.115/preload/preloadimage.raw rawdevice=/dev/sda</screen>
    </listitem>
    <listitem>
     <para>
      Configurez un serveur FTP et copiez votre image de préchargement préparée dans <filename>/srv/ftp/preload/preloadimage.raw</filename>.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Testez votre configuration en démarrant le système cible avec le démarrage réseau PXE. Celui-ci copiera automatiquement l'image de préchargement préparée sur le disque dur et éteindra la machine lorsqu'elle sera prête.
   </para>
  </sect2>


 </sect1>







</chapter>
