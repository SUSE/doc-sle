<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="vnc.xml" version="5.0" xml:id="cha.vnc">
 <title>VNCによるリモートアクセス</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    VNC (Virtual Network Computing)では、グラフィカルなデスクトップを使用してリモートコンピュータを制御できます。これは、リモートシェルアクセスとは対照的です。VNCはプラットフォームに依存しないので、VNCを使用すれば、任意のオペレーティングシステムからリモートマシンにアクセスできます。
   </para>

   <para>
    <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>では、2種類のVNCセッションをサポートしています。1つはクライアントからのVNC接続が続く限り、<quote/>「存続する」一時的セッションで、もう1つは明示的に終了されるまで<quote/>「存続する」永続的セッションです。
   </para>
  </abstract>
 </info>
 <note>
  <title>セッションタイプ</title>
  <para>
   両方のタイプのセッションを1つのコンピュータの異なるポートから同時に提供ができます。ただし、オープンセッションを1つのタイプからもう一方のタイプに変換することはできません。
  </para>
 </note>
 
 <sect1 xml:id="sec.vnc.viewer">
  <title><command>vncviewer</command>クライアント</title>

  <para>
   サーバによって提供されるVNCサービスに接続するには、クライアントが必要です。<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>のデフォルトは<command>vncviewer</command>で、これは<systemitem class="resource">tigervnc</systemitem>パッケージで提供されます。
  </para>

  <sect2 xml:id="sec.vnc.viewer.connectcli">
   <title>vncviewer CLIを使用した接続</title>
   <para>
    VNCビューアを起動し、サーバとのセッションを開始するには、次のコマンドを使用します。
   </para>
<screen>vncviewer jupiter.example.com:1</screen>
   <para>
    VNCディスプレイ番号の代わりに、2つのコロンを使用してポート番号を指定することもできます。
   </para>
<screen>vncviewer jupiter.example.com::5901</screen>
   <note>
    <title>注: ディスプレイ番号とポート番号</title>
    <para>
     VNCクライアントで実際に指定するディスプレイ番号またはポート番号は、ターゲットマシンで<command>vncserver</command>によって選択されるディスプレイ番号またはポート番号と同じである必要があります。詳細については、<xref linkend="sec.vnc.persistent"/>を参照してください。
    </para>
   </note>
  </sect2>

  <sect2 xml:id="sec.vnc.viewer.connectgui">
   <title>vncviewer GUIを使用した接続</title>
   <para>
    <command>--listen</command>または接続先ホストを指定せずに<command>vncviewer</command>を実行すると、接続の詳細を入力するよう求めるウィンドウが表示されます。<xref linkend="sec.vnc.viewer.connectcli"/>のように<guimenu>VNC server (VNCサーバ)</guimenu>フィールドにホストを入力し、<guimenu>接続</guimenu>をクリックします。
   </para>
   <figure xml:id="fig.vnc.viewer.connectgui">
    <title>vncviewer</title>
    <mediaobject>
     <textobject role="description"><phrase>vncviewerにより接続の詳細を入力するよう求められる</phrase>
     </textobject>
     <imageobject role="html">
      <imagedata fileref="vnc_connect.png" format="PNG"/>
     </imageobject>
     <imageobject role="fo">
      <imagedata fileref="vnc_connect.png" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
  </sect2>

  <sect2 xml:id="sec.vnc.viewer.encrypt">
   <title>暗号化されていない接続の通知</title>
   <para>
    VNCプロトコルは、さまざまな種類の暗号化接続をサポートしています。これをパスワード認証と混同しないでください。接続がTLSを使用していない場合、<quote>(Connection not encrypted!) (接続が暗号化されていません!)</quote>というテキストがVNCビューアのウィンドウタイトルに表示されることがあります。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.vnc.one-time">
  <title>一時的VNCセッション</title>

  <para>
   一時的セッションは、リモートクライアントによって開始されます。これにより、サーバにグラフィカルなログイン画面が開きます。この画面でセッションを開始するユーザを選択できます。さらに、ログインマネージャでサポートされている場合はデスクトップ環境も選択できます。そのようなVNCセッションへのクライアント接続を終了すると、そのセッション内で開始したアプリケーションもすべて終了します。一時的なVNCセッションは共用できませんが、1つのホストで同時に複数のセッションを実行することは可能です。
  </para>

  <procedure xml:id="pro.vnc.one-time.activate">
   <title>一時的VNCセッションの有効化</title>
   <step>
    <para>
     まず、<menuchoice> <guimenu>YaST</guimenu> <guimenu>ネットワークサービス</guimenu> <guimenu>リモート管理(VNC)</guimenu>
     </menuchoice>の順に選択します。
    </para>
   </step>
   <step>
    <para>
     <guimenu>(リモート管理を許可する</guimenu>にチェックマークを付けます。
    </para>
   </step>
   <step>
    <para>
     必要な場合は、<guimenu>ファイアウォールでポートを開く</guimenu>にもチェックマークを付けます (たとえば、ネットワークインタフェースを外部ゾーンに属するように設定する場合)。ネットワークインタフェースが複数ある場合は、<guimenu>ファイアウォールの詳細</guimenu>で、特定のインタフェースにだけファイアウォールポートを開くように制限します。
    </para>
   </step>
   <step>
    <para>
     <guimenu>完了</guimenu>で設定を確認します。
    </para>
   </step>
   <step>
    <para>
     必要なパッケージの一部をまだ入手できない場合は、足りないパッケージのインストールを承認する必要があります。
    </para>
   </step>
  </procedure>

  <sect2 xml:id="sec.vnc.one-time.configs">
   <title>使用可能な設定</title>
   <para>
    <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>のデフォルト設定では、1024x768ピクセルの解像度と16ビットの色数でセッションが提供されます。セッションで使用できるポートは、<quote>正規の</quote> VNCビューアの場合はポート<systemitem class="resource">5901</systemitem>(VNCディスプレイ<literal>1</literal>に相当)、Webブラウザの場合はポート<systemitem class="resource">5801</systemitem>です。
   </para>
   <para>
    その他の設定は、異なるポートで使用できます。<phrase os="sles;osuse"><xref linkend="sec.vnc.one-time.config"/></phrase>を参照してください。
   </para>
   <para>
    VNCディスプレイ番号とXディスプレイ番号は、一時的セッションでは互いに独立しています。VNCディスプレイ番号は、サーバがサポートするすべての設定に手動で割り当てられます(上記の例では1)。VNCセッションは、設定の1つを使用して開始されるたびに、自動的に未使用のXディスプレイ番号を取得します。
   </para>
   <para>
    デフォルトでは、VNCクライアントとサーバの両方が、インストール後に生成される自己署名SSL証明書を使用してセキュアな通信を試みます。デフォルトの証明書を使用することも、独自の証明書に置き換えることもできます。自己署名証明書を使用する際、初回の接続前に、VNCビューアおよびWebブラウザの両方で署名を確認する必要があります。Javaクライアントは、HTTPSを介してサービスが提供されるため、VNCと同じ証明書を使用します。
   </para>
  </sect2>

  <sect2 xml:id="sec.vnc.one-time.connect">
   <title>一時的VNCセッションを開始する</title>
   <para>
    永続的VNCセッションに接続するには、VCNビューアをインストールする必要があります。<xref linkend="sec.vnc.viewer"/>も参照してください。または、Javaを有効にしたWebブラウザで、URLとして「<literal>http://jupiter.example.com:5801</literal>」を入力することにより、VNCセッションを表示できます。
   </para>
  </sect2>

  <sect2 xml:id="sec.vnc.one-time.config">
   <title>一時的VNCセッションを設定する</title>
   <para>
    デフォルト設定を変更する必要も意志もない場合は、このセクションをスキップできます。
   </para>
   <para>
    一時的VNCセッションは、<systemitem class="daemon">xinetd</systemitem>デーモンを介して開始されます。設定ファイルは、<filename>/etc/xinetd.d/vnc</filename>にあります。このファイルは、デフォルトで、6つの設定ブロックを提供します: VNCビューア用に3ブロック(<literal>vnc1</literal>から<literal>vnc3</literal>まで)、Javaアプレット用に3ブロック(<literal>vnchttpd1</literal>から<literal>vnchttpd3</literal>まで)。デフォルトでは、<literal>vnc1</literal> と <literal>vnchttpd1</literal>だけが有効です。
   </para>
   <para>
    設定を有効にするには、<literal>disable = yes</literal>行の最初のカラムに<literal>#</literal>文字を付けて行をコメント化するか、 その行を完全に削除します。設定を無効にするには、その行をコメント解除するか、追加します。
   </para>
   <para>
    <command>Xvnc</command>サーバは、<literal>server_args</literal>オプションで設定できます。オプションのリストについては、<command>Xnvc --help</command>を参照してください。
   </para>
   <para>
    カスタム設定を追加する際には、それらの設定が、同じホスト上の他の設定、他のサービス、または既存の永続的VNCセッションですでに使用中のポートを使用しないことを確認してください。
   </para>
   <para>
    設定の変更を有効にするには、次のコマンドを入力します:
   </para>
<screen>sudo systemctl reload xinetd</screen>
   <important>
    <title>ファイアウォールとVNCポート</title>
    <para>
     <xref linkend="pro.vnc.one-time.activate"/>で説明されているように、リモート管理をアクティブにすると、ファイアウォール内でポート<systemitem class="resource">5801</systemitem>および<systemitem class="resource">5901</systemitem>が開きます。VNCセッションで使用されるネットワークインタフェースがファイアウォールで保護されている場合、VNCセッションの追加ポートをアクティブにする際には各ポートを手動で開く必要があります。手順については、<xref linkend="cha.security.firewall"/>を参照してください。
    </para>
   </important>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.vnc.persistent">
  <title>永続的VNCセッション</title>

  <para>
   永続的VNCセッションは、サーバ上で開始されます。セッションとこのセッションで開始されたすべてのアプリケーションは、クライアント接続とは関わりなく、セッションが終了するまで実行されます。
  </para>

  <para>
   永続的セッションは、複数のクライアントから同時にアクセスすることが可能です。この機能では、1つのクライアントがフルアクセスをもち、他のすべてのクライアントが表示専用アクセスを持つため、デモ用途に最適です。また、講師が受講生のデスクトップにアクセスする必要があるトレーニングでも使用できます。ただし、ほとんどの場合、VNCセッションの共用が必要とされることはありません。
  </para>

  <para>
   ディスプレイマネージャを起動する一時的セッションとは対照的に、永続的セッションでは、操作準備のできたデスクトップを起動し、そのデスクトップがVNCセッションを開始したユーザとしてセッションを実行します。永続的セッションへのアクセスは、パスワードによって保護されます。
  </para>

  <para>
   永続的セッションへのアクセスは、可能な2タイプのパスワードによって保護されます:
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     フルアクセスを付与する通常のパスワード。または、
    </para>
   </listitem>
   <listitem>
    <para>
     非対話的(表示オンリー)アクセスを付与するオプションの表示オンリーパスワード。
    </para>
   </listitem>
  </itemizedlist>

  <para>
   1つのセッションに、両方の種類のクライアント接続が一度に複数存在できます。
  </para>

  <procedure xml:id="pro.vnc.persistent.activate">
   <title>永続的VNCセッションを開始する</title>
   <step>
    <para>
     シェルを開き、VNCセッションを所有するユーザとしてログインしていることを確認します。

    </para>
   </step>
   <step>
    <para>
     VNCセッションで使用されるネットワークインタフェースがファイアウォールで保護されている場合は、ファイアウォール内でセッションによって使用されるポートを手動で開く必要があります。複数のセッションを開始する場合は、一連のポートを開くことができます。ファイアウォールの設定方法の詳細については、<xref linkend="cha.security.firewall"/>を参照してください。
    </para>
    <para>
     <command>vncserver</command>は、ディスプレイ<literal>:1</literal>にはポート<systemitem class="resource">5901</systemitem> 、ディスプレイ<literal>:2</literal>にはポート<systemitem class="resource">5902</systemitem>という順序でポートを使用します。永続的セッションの場合、VNCディスプレイとXディスプレイは、通常、同じ番号です。
    </para>
   </step>
   <step>
    <para>
     1024x769ピクセルの解像度と16ビットの色数でセッションを開始するには、次のコマンドを入力します。
    </para>
<screen>vncserver -geometry 1024x768 -depth 16</screen>
    <para>
     <command>vncserver</command>コマンドは、何も指定されない場合、未使用のディスプレイ番号を選択し、その選択内容を出力します。追加オプションについては、<command>man 1 vncserver</command>を参照してください。
    </para>
   </step>
  </procedure>

  <para>
   初めて<command>vncserver</command>を実行すると、セッションへのフルアクセス用パスワードが要求されます。必要な場合は、セッションへの表示オンリーアクセス用パスワードも入力できます。
  </para>

  <para>
   ここで指定するパスワードは、同じユーザによって開始される今後のセッションにも使用されます。それらのパスワードは、<command>vncpasswd</command>コマンドで変更できます。
  </para>

  <important>
   <title>セキュリティ上の考慮事項</title>
   <para>
    必ず、かなりの長さ(8文字以上)の強力なパスワードを使用してください。これらのパスワードは共用しないでください。
   </para>
  </important>

  <para>
   VNCセッションを終了するには、通常のローカルXセッションのシャットダウンのように、VNC環境内部で実行中のデスクトップ環境をVCNビューアからシャットダウンします。
  </para>

  <para>
   セッションを手動で終了したい場合は、VNCサーバでシェルを開き、終了したいVNCセッションを所有するユーザとしてログインしていることを確認します。次のコマンドを実行して、ディスプレイ<literal>:1</literal>で実行されているセッションを終了します: <command>vncserver -kill :1</command>
  </para>

  <sect2 xml:id="sec.vnc.persistent.connect">
   <title>永続的VNCセッションに接続する</title>
   <para>
    永続的VNCセッションに接続するには、VCNビューアをインストールする必要があります。<xref linkend="sec.vnc.viewer"/>も参照してください。または、Javaを有効にしたWebブラウザで、URLとして「<literal>http://jupiter.example.com:5801</literal>」を入力することにより、VNCセッションを表示できます。
   </para>
  </sect2>

  <sect2 xml:id="sec.vnc.persistent.configure">
   <title>永続的VNCセッションを設定する</title>
   <para>
    永続的VNCセッションは、<filename>$HOME/.vnc/xstartup</filename>を編集することによって設定できます。デフォルトでは、このシェルスクリプトは、起動元と同じGUI/ウィンドウマネージャを起動します。<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>では、これは、GNOMEまたはIceWMのいずれかです。好みのウィンドウマネージャでセッションを開始する場合は、変数<envar>WINDOWMANAGER</envar>を設定します。
   </para>
<screen>WINDOWMANAGER=gnome vncserver -geometry 1024x768
WINDOWMANAGER=icewm vncserver -geometry 1024x768</screen>
   <note>
    <title>ユーザごとに1つの設定</title>
    <para>
     永続的VNCセッションは、ユーザごとの単一設定として設定されます。同じユーザが開始する複数のセッションでは、すべて同じ起動ファイルとパスワードファイルが使用されます。
    </para>
   </note>
  </sect2>
 </sect1>
 <sect1 xml:id="vnc.encrypted">
  <title>暗号化されたVNC通信</title>

  <para>
   VNCサーバが正しく設定されている場合、VNCサーバとクライアント間の通信はすべて暗号化されます。最初の認証や、その後のすべてのデータ転送も対象です。
  </para>

  <para>
   一時的または永続的のいずれのタイプのVNCセッションを開始するかに関係なく、セキュリティオプションは<literal>server_args</literal>の行にある<command>/usr/bin/Xvnc</command>コマンドの<option>-securitytypes</option>パラメータで設定します。<option>-securitytypes</option>パラメータでは、認証方法と暗号化の両方を選択します。次のオプションがあります。
  </para>

  <variablelist>
   <title>認証</title>
   <varlistentry>
    <term>None、TLSNone、X509None</term>
    <listitem>
     <para>
      認証なし。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>VncAuth、TLSVnc、X509Vnc</term>
    <listitem>
     <para>
      カスタムパスワードを使用する認証。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Plain、TLSPlain、X509Plain</term>
    <listitem>
     <para>
      PAMを使用してユーザのパスワードを検証する認証。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <variablelist>
   <title>暗号化</title>
   <varlistentry>
    <term>None、VncAuth、Plain</term>
    <listitem>
     <para>
      暗号化なし。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>TLSNone、TLSVnc、TLSPlain</term>
    <listitem>
     <para>
      匿名のTLS暗号化。すべてが暗号化されますが、リモートホストの検証は行われません。したがって、受動的攻撃からは保護されますが、中間者攻撃からは保護されません。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>X509None、X509Vnc、X509Plain</term>
    <listitem>
     <para>
      証明書によるTLS暗号化。自己署名証明書を使用する場合、初回接続時に証明書を検証するよう要求されます。以降の接続では、証明書が変更された場合にのみ警告が表示されます。したがって、初回接続時には中間者攻撃以外のすべての攻撃から保護されます(SSHの一般的な使用方法と同様)。マシン名に一致する認証局によって署名された証明書を使用すると、完全なセキュリティを実現できます(HTTPSの一般的な使用方法と同様)。
     </para>
     <tip>
      <title>署名とキーのパス</title>
      <para>
       X509ベースの暗号化では、<option>-X509Cert</option>オプションと<option>-X509Key</option>オプションで、X509証明書とキーのパスを指定する必要があります。
      </para>
     </tip>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   複数のセキュリティタイプをカンマで区切って選択した場合、クライアントとサーバの両方でサポートおよび許可されているセキュリティタイプが使用されます。この方法により、サーバ上で日和見暗号化を設定できます。これは、暗号化をサポートしないVNCクライアントをサポートする必要がある場合に便利です。
  </para>

  <para>
   暗号化が有効であることがわかっているサーバに接続する場合、クライアント側で、許可されているセキュリティタイプを指定してダウングレード攻撃を防止することもできます(ただし、この場合、vncviewerに「Connection not encrypted! (接続が暗号化されていません)」という警告メッセージが表示されます)。
  </para>
 </sect1>
</chapter>
