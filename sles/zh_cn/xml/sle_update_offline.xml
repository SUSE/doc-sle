<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_offline.xml" version="5.0" xml:id="cha.update.offline">
 <title>脱机升级</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    本章介绍如何借助从安装媒体引导的 YaST，升级现有 SUSE Linux Enterprise 安装。YaST 安装程序有多种启动方法，例如从 DVD 启动、通过网络启动或从系统所在的硬盘启动。
   </para>
  </abstract>
 </info>
 <sect1 xml:id="sec.update.offline.conceptual-overview">
  <title>概念概述</title>
  <para>
   在升级系统之前，请先阅读<xref linkend="sec.update.prep"/>。
  </para>
  <para>
   要升级系统，请像执行全新安装时那样从安装源引导。但是，当引导屏幕出现时，您需要选择<guimenu>升级</guimenu>（而不是<guimenu>安装</guimenu>）。可从以下媒体启动升级：
  </para>

  <itemizedlist>
   <listitem>
    <formalpara>
     <title>可移动媒体</title>
     <para>
      包括 CD、DVD 或 USB 大容量储存设备等媒体。更多信息请参见<xref linkend="sec.update.offline.dvd"/>。
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>网络 资源</title>
     <para>
      您可以从本地媒体引导然后选择相应的网络安装类型，或者通过 PXE 引导。有关详细信息，请参见<xref linkend="sec.update.offline.network"/>。
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>硬盘</title>
     <para>
      您可以将 ISO 映像中的新内核和 initrd 映像复制到包含当前 SUSE Linux Enterprise 安装的硬盘并调整引导菜单。有关详细信息，请参见<xref linkend="sec.update.offline.harddisk"/>
     </para>
    </formalpara>
   </listitem>
  </itemizedlist>
 </sect1>


 <sect1 xml:id="sec.update.offline.dvd">
  <title>从安装媒体启动升级</title>
  <para>
   下面的过程举例说明了如何从 DVD 引导，不过，您也可以使用其他本地安装媒体，例如 USB 大容量储存设备上的 ISO 映像。要选择的媒体和引导方法取决于系统体系结构，以及计算机使用的是传统的 BIOS 还是 UEFI。
  </para>
  <procedure xml:id="pro.update.sle12.offline.dvd">
   <title>从 SLE 11 SP4 手动升级到 SLE 12 SP3</title>
   <step>
    <para>
     选择并准备引导媒体，请参见<xref linkend="sec.i.yast2.startup"/>。
    </para>
   </step>
   <step>
    <para>
     插入 SUSE Linux Enterprise 12 SP3 安装媒体的 DVD 1 并引导计算机。<guimenu>欢迎</guimenu>屏幕即会显示，接着是引导屏幕。
    </para>
   </step>
   <step>
    <para>
     在引导菜单中选择<emphasis>升级</emphasis>以启动系统。
    </para>
   </step>
   <step>
    <para>
     按<xref linkend="sec.update.sle12.start.upgr.after.boot"/>中所述继续执行升级过程。
    </para>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec.update.offline.network">
  <title>从网络源启动升级</title>
  <para>
   如果要从网络安装源开始升级，请确保符合以下要求：
  </para>
  <variablelist>
   <title>从网络安装源升级的要求</title>
   <varlistentry>
    <term>网络安装源</term>
    <listitem>
     <para>
      网络安装源已按照<xref linkend="cha.deployment.instserver"/>所述设置妥当。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>网络连接和网络服务</term>
    <listitem>
     <para>
      安装服务器与目标计算机的网络连接均必须正常。必需的网络服务如下：
     </para>
     <itemizedlist>
      <listitem><para>域名服务</para></listitem>
      <listitem><para>DHCP（仅在通过 PXE 引导时需要，可在设置期间手动设置 IP）</para></listitem>
      <listitem><para>OpenSLP（可选）</para></listitem>
     </itemizedlist>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>引导媒体</term>
    <listitem>
     <para>
      您已准备好用于引导目标系统的 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> DVD 1（或本地 ISO 映像），<emphasis>或者</emphasis>已按<xref linkend="sec.deployment.prep_boot.pxeprep" xrefstyle="HeadingOnPage"/>中所述将目标系统设置为通过 PXE 引导。请参见<xref linkend="cha.deployment.remoteinst"/>，深入了解从远程服务器开始升级的相关信息。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <sect2 xml:id="sec.update.sle.manual.network.boot-from-dvd">
   <title>通过网络安装源手动升级 — 从 DVD 引导</title>
   <para>
    此过程举例说明了如何从 DVD 引导，不过，您也可以使用其他本地安装媒体，例如 USB 大容量储存设备上的 ISO 映像。如何选择引导方法以及从媒体启动系统取决于系统体系结构，以及计算机使用的是传统 BIOS 还是 UEFI。有关细节，请参见以下链接。
   </para>
   <procedure xml:id="pro.update.sle.manual.network.boot-from-dvd">
    
    <step>
     <para>
      插入 SUSE Linux Enterprise 12 SP2 安装媒体的 DVD 1 并引导计算机。<guimenu>欢迎</guimenu>屏幕即会显示，接着是引导屏幕。
     </para>
    </step>
    <step>
     <para>
      选择要使用的网络安装源类型（FTP、HTTP、NFS、SMB 或 SLP）。通常可以按 <keycap>F4</keycap> 选择此选项，但是，如果您计算机上装配的是 UEFI 而不是传统 BIOS，则可能需要手动调整引导参数。有关细节，请参见<xref linkend="cha.inst"/>中的<xref linkend="sec.i.yast2.source.net"/>。
     </para>
    </step>
    <step>
     <para>
      按<xref linkend="sec.update.sle12.start.upgr.after.boot"/>中所述继续执行升级过程。
     </para>
    </step>
   </procedure>
  </sect2>
  <sect2 xml:id="sec.update.sle.manual.network.pxe-boot">
   <title>通过网络安装源手动升级 — 通过 PXE 引导</title>
   <para>
    要通过 PXE 引导从网络安装源执行升级，请按以下步骤操作：
   </para>
   <procedure xml:id="pro.update.sle.manual.network.pxe-boot">
    <step>
     <para>
      调整 DHCP 服务器的设置以提供通过 PXE 引导所需的地址信息。有关细节，请参见<xref linkend="sec.deployment.prep_boot.pxeprep"/>。
     </para>
    </step>
    <step>
     <para>
      设置 TFTP 服务器，以保存通过 PXE 引导所需的引导映象。为此，请使用 SUSE Linux Enterprise  12 SP2 安装媒体的 DVD 1，或者遵循<xref linkend="sec.deployment.prep_boot.tftp"/>中的指导。
     </para>
    </step>
    <step>
     <para>
      在目标计算机上准备 PXE Boot 和局域网唤醒。
     </para>
    </step>
    <step>
     <para>
      对目标系统引导进行初始化，并用 VNC 远程连接到此计算机正运行的安装例程上。有关详细信息，请参见<xref linkend="sec.deployment.remoteinst.monitor.vnc"/>。
     </para>
    </step>
    <step>
     <para>
      按<xref linkend="sec.update.sle12.start.upgr.after.boot"/>中所述继续执行升级过程。
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>

 <sect1 xml:id="sec.update.offline.harddisk">
  <title>从硬盘启动升级</title>
  <sect2 xml:id="sec.update.sle.offline.automated">
   <title>从 SUSE Linux Enterprise 11 SP3 或 SP4 自动迁移到 SUSE Linux Enterprise 12 SP2</title>
   <procedure xml:id="pro.update.sle.offline.automated">
    <remark>toms 2014-03-19: See FATE#315037</remark>
    <remark role="future">toms 2014-03-20: From SLE12 SP1 on, we should probably base
     this example on GRUB2, but not for GA.</remark>
    <remark>jsrain 2015-09-02: This is still the old system; at some point
        of time we should switch to GRUB2, but as long as amjority of
        customers still runs SLE11, I would stay with legacy GRUB. Anyway, we
        could include both options, that would be probably best solution</remark>
    <step>
     <para>
      将第一张安装 DVD 中 <filename>/boot/x86_64/loader/</filename> 目录下的 <filename>linux</filename> 安装内核和 <filename>initrd</filename> 文件复制到系统的 <filename>/boot</filename> 目录：
     </para>
<screen><prompt role="root">root # </prompt><command>cp</command> -vi <replaceable>DVDROOT</replaceable>/boot/x86_64/loader/linux /boot/linux.upgrade
<prompt role="root">root # </prompt><command>cp</command> -vi <replaceable>DVDROOT</replaceable>/boot/x86_64/loader/initrd /boot/initrd.upgrade</screen>
     <para>
      <replaceable>DVDROOT</replaceable> 表示系统装入 DVD 的路径，通常为 <filename>/run/media/$USER/$DVDNAME</filename>。
     </para>
    </step>
    <step>
     <para>
      打开 GRUB 旧配置文件 <filename>/boot/grub/menu.lst</filename>，另外添加一部分。对于其他引导加载程序，编辑相应的配置文件。相应地调整设备名称和 <parameter>root </parameter> 参数。例如：
     </para>
     <para>
      <remark>sseeberg 2017-04-11: this is only valid for sle11?</remark>
     </para>
<screen>title Linux Upgrade Kernel
kernel (hd0,0)/boot/linux.upgrade root=/dev/sda1 upgrade=1 autoupgrade=1
initrd (hd0,0)/boot/initrd.upgrade</screen>
    </step>
    <step>
     <para>
      执行下面的步骤前，需要将 DVD 放入光驱，或将 ISO 映像放置于本地磁盘上。如果计算机没有 DVD 驱动器，则请下载 ISO 并将它另存为 <filename>/install.iso</filename>，或者从 DVD 复制该 ISO
     </para>
<screen><prompt role="root">root # </prompt><command>dd</command> if=/dev/cdrom of=/install.iso</screen>
     <para>
      如果您已将 ISO 复制到硬盘，则需将一个参数添加到先前编辑的 <filename>/boot/grub/menu.lst</filename> 中。在以 <literal>kernel</literal> 开头的行中添加以下选项：
     </para>
<screen>install=hd:/install.iso</screen>
    </step>
    <step>
     <para>
      重引导计算机，并从引导菜单（这里是 <emphasis>Linux 升级内核</emphasis>）中选择新添加的部分。您可以使用 <command>grubonce</command> 预先选择新创建的 GRUB 项，以便以无人照管方式自动重引导到新创建的项。您也可以在命令行中使用 <command>reboot</command> 来启动重引导。
     </para>
    </step>
    <step>
     <para>
      按<xref linkend="sec.update.sle12.start.upgr.after.boot"/>中所述继续执行升级过程。
     </para>
    </step>
    <step>
     <para>
      升级过程成功完成后，去除安装内核和 initrd 文件（<filename>/boot/linux.upgrade</filename> 和 <filename>/boot/initrd.upgrade</filename>）。现在不再需要这些文件。
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.update.offline.automated">
  <title>启用自动升级</title>
  <para>
   升级过程可以自动执行。要启用自动更新内核的功能，必须设置内核参数 <literal>autoupgrade = 1</literal>。可在引导时于<literal>引导选项</literal>字段中设置该参数。有关细节，请参见<link xlink:href="https://www.suse.com/documentation/sles-12/book_autoyast/data/introduction.html"/>。
  </para>
 </sect1>
 <sect1 xml:id="sec.update.sle12.start.upgr.after.boot">
  <title>升级 SUSE Linux Enterprise</title>
  <para>
   <remark>taroth 2014-11-13: argh, the following is terminology hell regarding
     the software strings: "upgrade"/"update" are used intermittently and
     without clear differentiation...</remark>
  </para>
  <para>
   在升级系统之前，请先阅读<xref linkend="sec.update.prep"/>。要执行自动迁移，请如下操作：
  </para>
  <procedure>
   <step>
    <para>
     （从安装媒体或网络）引导后，请在引导屏幕上选择<guimenu>升级</guimenu>这一项。如果您要按照后续步骤所述手动执行升级，则需禁用自动升级过程。请参考<xref linkend="sec.update.offline.automated"/>。
    </para>
    <warning>
     <title>不当的选择可能会导致数据丢失</title>
     <para>
      如果您选择<guimenu>安装</guimenu>而不是<guimenu>升级</guimenu>，之后数据可能会丢失。在全新安装过程中，您需要格外小心，不要损坏数据分区。例如，重新分割磁盘（这可能会损坏现有分区）或重新格式化数据分区（这会清除分区上的所有数据）都会损坏数据分区。
     </para>
     <para>
      请务必在此处选择<guimenu>升级</guimenu>。
     </para>
    </warning>
    <para>
     YaST 将启动安装系统。
    </para>
   </step>
   <step>
    <para>
     在<guimenu>欢迎</guimenu>屏幕上，选择<guimenu>语言</guimenu>和<guimenu>键盘</guimenu>并接受许可协议。单击<guimenu>下一步</guimenu>继续。
    </para>
    <para>
     YaST 将检查您的分区上是否已安装 SUSE Linux Enterprise 系统。
    </para>
   </step>
   <step>
    <para>
     在<guimenu>选择升级</guimenu>屏幕上，选择要升级的分区，然后单击<guimenu>下一步</guimenu>。
    </para>
    <para>
     YaST 将会装入选定的分区，并显示在您要升级的分区上找到的所有储存库。
    </para>
   </step>
   <step>
    <para>
     在<guimenu>以前使用过的储存库</guimenu>屏幕上，调整储存库的状态：启用您要包含在升级过程中的储存库，并禁用不再需要的所有储存库。单击<guimenu>下一步</guimenu>继续。
    </para>
   </step>
   <step>
    <para>
     在<guimenu>注册</guimenu>屏幕上，选择是要立即注册已升级的系统（输入您的注册数据并单击<guimenu>下一步</guimenu>），还是要<guimenu>跳过注册</guimenu>。有关注册系统的细节，请参见<xref linkend="sec.update.registersystem"/>。
    </para>
   </step>
   <step>
    <para>
     复查有关升级的<guimenu>安装设置</guimenu>，尤其是<guimenu>更新选项</guimenu>。在以下选项之间进行选择：
    </para>
    <itemizedlist>
     <listitem>
      <para>
       <guimenu>仅更新已安装的包</guimenu>，如果选择此选项，您可能会失去最新 SUSE Linux Enterprise 版本随附的新功能。
      </para>
     </listitem>
     <listitem>
      <para>
       <guimenu>安装新软件和功能以执行更新</guimenu>。如果要根据具体需要启用或禁用模式与包，请单击<guimenu>选择模式</guimenu>。
      </para>
     </listitem>
    </itemizedlist>

    <note>
     <title>桌面选择</title>
     <para>
      如果在升级到 SUSE Linux Enterprise 12 之前，您使用的是 KDE<varname>（</varname> <filename>/etc/sysconfig/windowmanager</filename> 中的 DEFAULT_WM 设置为 <literal>kde*</literal>），则在升级后，您的桌面环境将被自动替换为 GNOME。默认情况下，KDM 显示管理器将被替换为 GDM。
     </para>
     <para>
      要更改使用的桌面环境或窗口管理器，请单击<guimenu>选择模式</guimenu>来调整软件选择。
     </para>
    </note>
   </step>
   <step>
    <para>
     如果所有设置都符合您的需要，请单击<guimenu>更新</guimenu>开始安装与去除过程。
    </para>
   </step>
   <step>
    <para>
     升级过程成功完成后，检查是否存在任何<quote>孤立的包</quote>。孤立的包是指不再属于活动储存库的包。以下命令可以列出这些包：
    </para>
<screen>zypper packages --orphaned</screen>
    <para>
     借助该列表，您可以决定是仍需要该包还是可以将其安全卸装。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.sle.manager">
  <title>通过 SUSE Manager 更新</title>

  <para>
   SUSE Manager 是一个服务器解决方案，用于提供适用于 SUSE Linux Enterprise 客户端的更新、增补程序和安全修复。它随附了一套工具和基于 Web 的用户界面，用于执行管理任务。有关 SUSE Manager 的详细信息，请参见 <link xlink:href="https://www.suse.com/products/suse-manager/"/>。
  </para>
  
  <para>
   SUSE Manager 可为您提供 SP 迁移或完整系统升级支持。
  </para>

  <variablelist>
   
   <varlistentry>
    <term>SP 迁移</term>
    <listitem>
     <para>
      SP 迁移允许从一个主要版本中的一个服务包 (SP) 迁移到另一个服务包（例如，从 SLES 12 SP1 迁移到 12 SP2）。有关详细信息，请参见《<citetitle>SUSE Manager Best Practices</citetitle>》（SUSE Manager 最佳实践）<quote>Client Migration</quote>（客户端迁移）一章中的<quote>Migrating SUSE Linux Enterprise Server 12 or later to version 12 SP2</quote>（将 SUSE Linux Enterprise Server 12 或更高版本迁移到版本 12 SP2）一节：
     </para>
     <para>
      
      <link xlink:href="https://www.suse.com/documentation/suse-manager/"/>，版本 3.1
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>系统升级</term>
    <listitem>
     <para>
      您可以使用 SUSE Manager 来执行系统升级。通过集成的 AutoYaST 技术，可以从一个主要版本升级到下一个主要版本（例如，从 SLES 11 SP3 升级到 12 SP2）。有关详细信息，请参见《<citetitle>SUSE Manager Best Practices</citetitle>》（SUSE Manager 最佳实践）<quote>Client Migration</quote>（客户端迁移）一章中的<quote>Migrating SUSE Linux Enterprise 11 SP3 to version 12 SP2</quote>（将 SUSE Linux Enterprise 11 SP3 迁移到版本 12 SP2）一节：
     </para>
     <para>
      
      <link xlink:href="https://www.suse.com/documentation/suse-manager/"/>，版本 3.1
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec.update.reg.status.after.rollback">
  <title>回滚后更新注册状态</title>

  <para>
   执行服务包升级时，必须在注册服务器上更改配置，以提供对新储存库的访问权限。如果升级过程被中断或恢复（通过从备份或快照恢复），注册服务器上的信息会与系统的状态不一致。这样可能会导致您无法访问更新储存库，或是在客户端上使用错误的储存库。
  </para>

  <para>
   如果回滚是通过 Snapper 完成的，系统会通知注册服务器以确保在引导过程中设置对正确储存库的访问信息。如果系统用任何其他方式恢复，或出于某种原因与注册服务器的通讯失败（例如，由于服务器因网络问题而无法访问），请调用以下命令在客户端上手动触发回滚：
  </para>

<screen><command>snapper</command> rollback</screen>

  <para>
   我们建议始终检查系统上是否设置了正确的储存库，特别是使用以下命令刷新服务后：：
  </para>

<screen><command>zypper</command> ref -s</screen>

  <para>
   此功能在
   <package>rollback-helper</package>
   包中提供。
  </para>
 </sect1>
 <sect1 xml:id="sec.update.registersystem">


  <title>注册您的系统</title>

  <para>
   如果您在安装期间跳过了注册步骤，以后可随时使用 YaST 中的<guimenu>产品注册</guimenu>模块来注册您的系统。
  </para>

  <para>
   注册系统可以获得以下优势：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     有资格获得支持
    </para>
   </listitem>
   <listitem>
    <para>
     获取安全性更新和 Bug 修复
    </para>
   </listitem>
   <listitem>
    <para>
     访问 SUSE Customer Center
    </para>
   </listitem>
  </itemizedlist>

  <procedure>
   <step>
    <para>
     启动 YaST 并选择<menuchoice> <guimenu>软件</guimenu>
     <guimenu> 产品注册</guimenu> </menuchoice>以打开<guimenu>注册</guimenu>对话框。
    </para>
   </step>
   <step>
    <para>
     提供与您或您的组织管理订阅时所用的 SUSE 帐户关联的<guimenu>电子邮件</guimenu>地址。如果您没有 SUSE 帐户，请转到 SUSE Customer Center 主页 (<link xlink:show="new" xlink:href="https://scc.suse.com/"/>) 创建一个帐户。
    </para>
   </step>
   <step>
    <para>
     输入与 <guimenu>SUSE Linux Enterprise Server</guimenu> 副本一同收到的<phrase role="productname"><phrase os="sles">注册代码</phrase></phrase>。
    </para>
   </step>
   <step xml:id="step.y2.register.final">
    <para>
     要开始注册，请继续执行<guimenu>下一步</guimenu>。如果您的网络中有一个或多个本地注册服务器可用，您可以从列表中选择一个。或者，要忽略本地注册服务器并向默认的 SUSE 注册服务器注册，请选择<guimenu>取消</guimenu>。
    </para>
    <para>
     注册过程中，联机更新储存库会添加到您的升级设置中。此过程完成后，您可以选择是否安装来自更新储存库的最新可用包版本。这会为所有包提供一个干净的升级路径，并确保 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 通过最新的可用安全更新进行升级。如果您选择<guimenu>否</guimenu>，则所有包都是从安装媒体安装。单击<guimenu>下一步</guimenu>继续。
    </para>
    <para>
     成功注册后，YaST 会列出系统可用的扩展、外接式附件和模块。要选择并安装所列的项，请继续<xref linkend="sec.add-ons.extensions"/>。
    </para>
   </step>
  </procedure>
 </sect1>

</chapter>
