<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_bonding.xml" version="5.0" xml:id="sec-network-iface-bonding">
 <title>设置绑定设备</title>

 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>

 <para>
  对于某些系统，需要实施高于典型以太网设备的标准数据安全性或可用性要求的网络连接。在这些情况下，可以将多个以太网设备聚合到单个绑定设备。
 </para>

 <para>
  绑定设备的配置通过绑定模块选项来完成。其行为主要受绑定设备模式的影响。该模式默认为 <systemitem>active-backup</systemitem>，也就是说，如果活动端口发生故障，另一个绑定端口将变成活动端口。可以使用以下绑定模式：
 </para>

 <variablelist>
  <varlistentry>
   <term><guimenu>0</guimenu> (balance-rr)</term>
   <listitem>
    <para>
     数据包依次通过第一个到最后一个可用接口传输。提供容错和负载平衡。
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>1</guimenu> (active-backup)</term>
   <listitem>
    <para>
     只有一个网络接口处于活动状态。如果它发生故障，另一个接口将变成活动状态。此设置是 <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 的默认设置。提供容错。
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>2</guimenu> (balance-xor)</term>
   <listitem>
    <para>
     流量会根据绑定中包含的设备数量在所有可用接口间拆分。这需要交换机的支持。提供容错和负载平衡。
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>3</guimenu> (broadcast)</term>
   <listitem>
    <para>
     在所有接口上广播所有通讯。需要交换机的支持。提供容错。
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>4</guimenu> (802.3ad)</term>
   <listitem>
    <para>
     将接口聚合成共享相同速度和双工设置的组。需要接口驱动程序中的 <command>ethtool</command> 支持，以及支持 IEEE 802.3ad 动态链路聚合并进行了相应配置的交换机。提供容错和负载平衡。
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>5</guimenu> (balance-tlb)</term>
   <listitem>
    <para>
     自适应传输负载平衡。需要接口驱动程序中的 <command>ethtool</command> 支持，但不需要交换机支持。提供容错和负载平衡。
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>6</guimenu> (balance-alb)</term>
   <listitem>
    <para>
     自适应负载平衡。需要接口驱动程序中的 <command>ethtool</command> 支持，但不需要交换机支持。提供容错和负载平衡。
    </para>
   </listitem>
  </varlistentry>
 </variablelist>

 <para>
  有关各种模式的详细说明，请参见<link xlink:href="https://www.kernel.org/doc/Documentation/networking/bonding.txt"/>。
 </para>

 <tip>
  <title>绑定和 Xen</title>
  <para>
   绑定设备只对于有多个真实网卡可用的计算机有效。这意味着在大多数配置中，您仅应在 Dom0 中使用绑定配置。换言之，只有当您将多个网卡指派给一个 VM Guest 系统时，在 VM Guest 中设置绑定才有效。
  </para>
 </tip>

 <note arch="power">
  <title>
   IBM POWER：ibmveth 不支持绑定模式 5 和 6 (balance-tlb/balance-alb)
  </title>
  <para>
   tlb/alb 绑定配置与 Power 固件之间存在冲突。简单而言，处于 tlb/alb 模式的绑定驱动程序会发送同时包含源和目标 MAC 地址（列作虚拟以太网 MAC 地址）的以太网回写包。Power 固件并不支持这些包。因此，ibmveth 不支持绑定模式 5 和 6。
  </para>
 </note>

 <para>
  要配置绑定设备，请使用以下过程：
 </para>

 <procedure>
  <step>
   <para>
    运行 <menuchoice><guimenu>YaST</guimenu> <guimenu> 系统</guimenu>
    <guimenu> 网络设置</guimenu></menuchoice>。
   </para>
  </step>
  <step>
   <para>
    使用<guimenu>添加</guimenu>并将<guimenu>设备类型</guimenu>更改为<guimenu>绑定</guimenu>。单击<guimenu>下一步</guimenu>继续。
   </para>
   <informalfigure>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="bond_configuration.png" width="70%"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="bond_configuration.png" width="65%"/>
     </imageobject>
    </mediaobject>
   </informalfigure>
  </step>
  <step>
   <para>
    选择如何为绑定设备指派 IP 地址。有三种方法可供选择：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      无 IP 地址
     </para>
    </listitem>
    <listitem>
     <para>
      动态地址（使用 DHCP 或 Zeroconf）
     </para>
    </listitem>
    <listitem>
     <para>
      静态指派的 IP 地址
     </para>
    </listitem>
   </itemizedlist>
   <para>
    请使用最适合您环境的方法。
   </para>
  </step>
  <step>
   <para>
    在<guimenu>绑定端口</guimenu>选项卡中，选中相关复选框选择应加入到绑定中的以太网设备。
   </para>
  </step>
  <step>
   <para>
    编辑<guimenu>绑定驱动程序选项</guimenu>并选择绑定模式。
   </para>
  </step>
  <step>
   <para>
    确保将参数 <literal>miimon=100</literal> 添加到<guimenu>绑定驱动程序选项</guimenu>。如果没有此参数，则不会定期检查数据完整性。
   </para>
  </step>
  <step>
   <para>
    单击<guimenu>下一步</guimenu>，然后单击<guimenu>确定</guimenu>退出 YaST 以创建设备。
   </para>
  </step>
 </procedure>

 <sect2 xml:id="sec-network-iface-bonding-hotplug">
  <title>绑定端口的热插拔</title>
  <para>
   在特定网络环境（如高可用性）中，有时需要将某个绑定端口接口替换为另一个。原因可能在于网络设备持续故障。解决方案是设置绑定端口的热插拔。
  </para>
  <para>
   按常规配置绑定（按照 <command>man 5 ifcfg-bonding</command>），例如：
  </para>
<screen>ifcfg-bond0
          STARTMODE='auto' # or 'onboot'
          BOOTPROTO='static'
          IPADDR='192.168.0.1/24'
          BONDING_MASTER='yes'
          BONDING_SLAVE_0='eth0'
          BONDING_SLAVE_1='eth1'
          BONDING_MODULE_OPTS='mode=active-backup miimon=100'</screen>
  <para>
   使用 <literal>STARTMODE=hotplug</literal> 和 <literal>BOOTPROTO=none</literal> 指定绑定端口：
  </para>
<screen>ifcfg-eth0
          STARTMODE='hotplug'
          BOOTPROTO='none'

ifcfg-eth1
          STARTMODE='hotplug'
          BOOTPROTO='none'</screen>

  <para>
   <literal>BOOTPROTO=none</literal> 使用 <command>ethtool</command> 选项（如果提供），但不会在 <command>ifup eth0</command> 上设置链路，这是因为绑定端口接口由绑定设备控制。
  </para>
  <para>
   <literal>STARTMODE=hotplug</literal> 会使绑定端口接口在可用时自动加入绑定。
  </para>
  <para>
   需要更改 <filename>/etc/udev/rules.d/70-persistent-net.rules</filename> 中的 <systemitem>udev</systemitem> 规则，以便按总线 ID（udev <systemitem>KERNELS</systemitem> 关键字等同于 <command>hwinfo --netcard</command> 中的“SysFS BusID”）而不是 MAC 地址匹配设备。这样将允许更换有缺陷的硬件（位于同一插槽但 MAC 不同的网卡），并避免在绑定更改其所有绑定端口的 MAC 地址时出现混淆。
  </para>
  <para>
   例如：
  </para>
<screen>SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*",
KERNELS=="0000:00:19.0", ATTR{dev_id}=="0x0", ATTR{type}=="1",
KERNEL=="eth*", NAME="eth0"</screen>
  <para>
   在引导时，systemd <systemitem>network.service</systemitem> 不会等待热插拔绑定端口就绪，而是等待绑定就绪，后者至少需要有一个绑定端口可用。当从系统中去除一个绑定端口接口（从 NIC 驱动程序解除绑定、执行 NIC 驱动程序的 <command>rmmod</command> 命令或真正去除 PCI 热插拔）时，内核会自动从将其绑定中去除。当向系统添加新网卡时（更换插槽中的硬件），<systemitem>udev</systemitem> 会使用基于总线的永久名称规则将其重命名为绑定端口的名称，并为其调用 <command>ifup</command>。调用 <command>ifup</command> 会自动将新卡加入绑定。
   <remark>
    ke: I think this can stay that way for now.
   </remark>
  </para>
 </sect2>


</sect1>
