<?xml version="1.0" encoding="UTF-8"?>
<sect2 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="system_repair.xml" version="5.0" xml:id="sec-trouble-data-recover-rescue">
 <title>使用救援系統</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <para>
  系統無法啟動並正常運作的原因可能有幾種。最常見的原因是系統當機後檔案系統損毀、組態檔案損毀，或開機載入程式組態損毀。
 </para>
 <para>
  為了幫助您解決這些狀況，<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 包含可以開機的救援系統。救援系統是一個小型的 Linux 系統，可以載入到 RAM 磁碟上並裝載為根目錄檔案系統，好讓您從外部存取 Linux 分割區。藉由此救援系統，您可以復原或修改任何重要的系統項目。
 </para>
 <itemizedlist mark="bullet" spacing="normal">
  <listitem>
   <para>
    操作任何類型的組態檔案。
   </para>
  </listitem>
  <listitem>
   <para>
    檢查檔案系統有無缺失並啟動自動修復程序。
   </para>
  </listitem>
  <listitem>
   <para>
    在<quote>變更根目錄</quote>環境中存取已安裝的系統。
   </para>
  </listitem>
  <listitem>
   <para>
    檢查、修改和重新安裝開機載入程式組態。
   </para>
  </listitem>
  <listitem>
   <para>
    從錯誤安裝的裝置驅動程式或無法使用的核心復原。
   </para>
  </listitem>
  <listitem>
   <para>
    使用 Parted 指令來調整分割區大小。如需此工具的詳細資訊，請造訪 GNU Parted 網站 <link xlink:href="https://www.gnu.org/software/parted/parted.html"/>。
   </para>
  </listitem>
 </itemizedlist>
 <para>
  救援系統可以從各種來源與位置載入。最簡單的方法就是從原始安裝媒體將救援系統開機。
 </para>
 <note os="sles" arch="zseries">
  <title>IBM Z：啟動救援系統</title>
  <para>
   在 IBM Z 上，可將安裝系統用於救援目的。若要啟動救援系統，請遵照<xref linkend="sec-zseries-rescue"/>中的指示。
  </para>
 </note>
 <procedure>
  <step>
   <para>
    將安裝媒體插入 DVD 光碟機。
   </para>
  </step>
  <step>
   <para>
    重新啟動系統。
   </para>
  </step>
  <step>
   <para>
    在開機畫面中按 <keycap>F4</keycap>，然後選擇<guimenu>DVD-ROM</guimenu>。之後從主功能表中選擇<guimenu>救援系統</guimenu>。
   </para>
  </step>
  <step>
   <para>
    在 <literal>Rescue:</literal> 提示符處輸入 <literal>root</literal>。無須輸入密碼。
   </para>
  </step>
 </procedure>
 <procedure xml:id="proc-trouble-data-recover-rescue-network">
  <para>
   如果硬體設定沒有包含 DVD 光碟機，您可以從網路來源將救援系統開機。以下範例適用於遠端開機的情形，如果使用其他開機媒體 (例如 DVD)，請相應地修改 <filename>info</filename> 檔案，並依照正常的安裝方式開機。
  </para>
  <step>
   <para>
    進入 PXE 開機設定的組態中，新增下面的行：<literal>install=<replaceable>PROTOCOL</replaceable>://<replaceable>INSTSOURCE</replaceable></literal> 和 <literal>rescue=1</literal>。如果需要啟動系統修復，請使用 <literal>repair=1</literal>。如同正常的安裝一樣，<replaceable>PROTOCOL</replaceable> 代表任何受支援的網路通訊協定 (NFS、HTTP、FTP 等)，<replaceable>INSTSOURCE</replaceable> 代表網路安裝來源的路徑。
   </para>
  </step>
  <step>
   <para>
    使用<quote>網路喚醒</quote><phrase os="sles;sled">啟動系統 (如<xref linkend="sec-deployment-prep-boot-wol"/></phrase>中所述)。
   </para>
  </step>
  <step>
   <para>
    在 <literal>Rescue:</literal> 提示符處輸入 <literal>root</literal>。無須輸入密碼。
   </para>
  </step>
 </procedure>
 <para>
  進入該救援系統後，可透過 <keycombo><keycap function="alt"/><keycap>F1</keycap></keycombo> 到 <keycombo><keycap function="alt"/><keycap>F6</keycap></keycombo> 鍵來使用虛擬主控台。
 </para>
 <para>
  <filename>/bin</filename> 目錄中提供了一個外圍程序和其他有用的公用程式，如 mount 程式。<filename>/sbin</filename> 目錄包含重要檔案，以及用於檢視及修復檔案系統的網路公用程式。此目錄還包含用於系統維護的最重要二進位檔案 (如 <command>fdisk</command>、<command>mkfs</command>、<command>mkswap</command>、<command>mount</command>)，以及用於維護網路的 <command>shutdown</command>、<command>ip</command> 和 <command>ss</command>。目錄 <filename>/usr/bin</filename> 包含 vi 編輯器、find、less 和 SSH。
 </para>
 <para>
  若要檢視系統訊息，請使用指令 <command>dmesg</command>，或者使用 <command>journalctl</command> 來檢視系統記錄。
 </para>
 <sect3 xml:id="sec-trouble-data-recover-rescue-file">
  <title>檢查和操作組態檔案</title>
  <para>
   為了舉例說明使用救援系統如何修正組態檔案，請想像系統由於組態檔案損毀而無法正常開機。您可以使用救援系統來解決這個問題。
  </para>
  <procedure>
   <para>
    若要操作組態檔案，請執行下列步驟：
   </para>
   <step>
    <para>
     使用上述的其中一個方法啟動救援系統。
    </para>
   </step>
   <step>
    <para>
     若要將位於 <filename>/dev/sda6</filename> 下的根檔案系統掛接到救援系統，請使用如下指令：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> mount /dev/sda6 /mnt</screen>
    <para>
     系統的所有目錄現在均位於 <filename>/mnt</filename> 下
    </para>
   </step>
   <step>
    <para>
     將此目錄變更到裝載的開機檔案系統中：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> cd /mnt</screen>
   </step>
   <step>
    <para>
     在 vi 編輯器中開啟有問題的組態檔案。調整並儲存設定。
    </para>
   </step>
   <step>
    <para>
     從救援系統解除裝載開機檔案系統：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> umount /mnt</screen>
   </step>
   <step>
    <para>
     將機器重新開機。
    </para>
   </step>
  </procedure>
 </sect3>
 <sect3 xml:id="sec-trouble-data-recover-rescue-filesystem">
  <title>修復和檢查檔案系統</title>
  <para>
    一般而言，檔案系統無法在執行中的系統上修復。如果發生了嚴重的問題，您可能甚至無法裝載開機檔案，而且系統可能會因為<quote>核心異常</quote>而無法開機。在此情況下，唯一的方法就是從外部修復系統。系統包含 <command>fsck</command> 公用程式，可檢查和修復多種檔案系統類型，例如 <literal>ext2</literal>、<literal>ext3</literal>、<literal>ext4</literal>、<literal>msdos</literal> 和 <literal>vfat</literal>。使用 <option>-t</option> 選項指定要檢查的檔案系統。
  </para>
  <para>
    以下指令會檢查在 <filename>/etc/fstab</filename> 規格中找到的所有 <literal>ext4</literal> 檔案系統：
  </para>
<screen><prompt>&gt; </prompt><command>sudo</command> fsck -t ext4 -A</screen>
<tip>
  <para>
    對於 Btrfs，您可以使用 <package>btrfsprogs</package> 套件中的 <command>btrfs check</command> 指令。
  </para>
  <para>
    在以下位置尋找有關 Btrfs 檔案系統的標題：
  </para>
  <itemizedlist>
    <listitem>
      <para>
        《儲存管理指南》包括 <link xlink:href="https://documentation.suse.com/sles/html/SLES-all/cha-filesystems.html#sec-filesystems-major-btrfs"/> 和 <link xlink:href="https://documentation.suse.com/sles/html/SLES-all/cha-resize-fs.html#sec-resize-fs-btrfs"/> 部分。
      </para>
    </listitem>
    <listitem>
      <para>
        以下文章介紹如何從 Btrfs 錯誤中還原：<link xlink:href="https://www.suse.com/support/kb/doc/?id=000018769"/>。
      </para>
    </listitem>
    <listitem>
      <para>
        以下文章包含指向多個 Btrfs 相關主題的連結：<link xlink:href="https://www.suse.com/support/kb/doc/?id=000018779"/>。
      </para>
    </listitem>
    <listitem>
      <para>
        <command>man 8 btrfs-check</command> 手冊頁詳細介紹了 <command>btrfs check</command> 指令的所有選項。
      </para>
    </listitem>
  </itemizedlist>
</tip>
 </sect3>
 <sect3 xml:id="sec-trouble-data-recover-rescue-access">
  <title>存取已安裝系統</title>
  <para>
   如果需要從救援系統存取已安裝的系統，您需要在<emphasis>變更根目錄</emphasis>環境中執行此操作。例如，若要修改開機載入程式組態或執行硬體組態公用程式。
  </para>
  <para>
   若要根據已安裝的系統設定變更根目錄環境，請執行下列步驟：
  </para>
  <procedure>
   <step>
    <tip>
     <title>輸入 LVM 磁碟區群組</title>
     <para>
      如果您使用的是 LVM 設定 (如需更多一般性詳細資料，請參閱<xref os="sles" linkend="part-lvm"/>)，請輸入所有現有的磁碟區群組，以便能夠尋找和掛接裝置：
     </para>
<screen><systemitem class="username">root</systemitem>vgimport -a</screen>
    </tip>
    <para>
     執行 <command>lsblk</command> 以檢查哪個節點對應於根分割區。在本範例中，該節點為 <filename>/dev/sda2</filename>：
    </para>
<screen><prompt>&gt; </prompt>lsblk
NAME        MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT
sda           8:0    0 149,1G  0 disk
├─sda1        8:1    0     2G  0 part  [SWAP]
├─sda2        8:2    0    20G  0 part  /
└─sda3        8:3    0   127G  0 part
  └─cr_home 254:0    0   127G  0 crypt /home</screen>
   </step>
   <step>
    <para>
     從安裝的系統掛接根分割區：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> mount /dev/sda2 /mnt</screen>
   </step>
   <step>
    <para>
     掛接 <filename>/proc</filename>、<filename>/dev</filename> 和 <filename>/sys</filename> 分割區：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> mount -t proc none /mnt/proc
<prompt>&gt; </prompt><command>sudo</command> mount --rbind /dev /mnt/dev
<prompt>&gt; </prompt><command>sudo</command> mount --rbind /sys /mnt/sys</screen>
   </step>
   <step>
    <para>
     現在可以<quote>變更根分割區</quote>為新的環境，並保留 <systemitem>bash</systemitem> 外圍程序：
    </para>
<screen><prompt>&gt; </prompt>chroot /mnt /bin/bash</screen>
   </step>
   <step>
    <para>
     最後，從已安裝的系統裝載其餘分割區：
    </para>
<screen><prompt>&gt; </prompt>mount -a</screen>
   </step>
   <step>
    <para>
     現在您可以存取已安裝的系統。在將系統重新開機之前，請先使用 <command>umount</command> <option>-a</option> 卸載分割區，並使用 <command>exit</command> 離開<quote>變更根</quote>環境。
    </para>
   </step>
  </procedure>
  <warning>
   <title>限制</title>
   <para>
    雖然您可以完全存取已安裝系統的檔案和應用程式，但必須遵守某些限制。執行中的核心是使用救援系統啟動的核心，而不是使用變更根目錄環境啟動的核心。它只支援基本硬體，而且無法從已安裝系統新增核心模組，除非核心版本完全一致。永遠使用 <command>uname -r</command> 檢查目前執行中的 (救援) 核心版本，然後確定變更根環境中的 <filename>/lib/modules</filename> 目錄下是否有相符的子目錄。如果有，您便可以使用已安裝的模組，否則，需要在其他媒體 (例如快閃磁碟機) 上提供模組的正確版本。多數情況下，救援核心版本與已安裝的版本並不相同，因此，舉例來說，您便不能像平常一樣存取聲卡。您也無法啟動圖形使用者介面。
   </para>
   <para>
    另外請注意，當您使用 <keycombo><keycap function="alt"/><keycap>F1</keycap></keycombo> -  <keycombo><keycap function="alt"/><keycap>F6</keycap></keycombo> 來切換主控台時，將會離開<quote>變更根目錄</quote>環境。
   </para>
  </warning>
 </sect3>
 <sect3 xml:id="sec-trouble-data-recover-rescue-grub">
  <title>修改和重新安裝開機載入程式</title>
  <para>
   有時候系統無法開機是因為開機載入程式組態已損毀。譬如說，開機載入程式若未執行，啟動常式便無法將實體磁碟機轉譯為 Linux 檔案系統中的實際位置。
  </para>
  <para>
   若要檢查開機載入程式組態和重新安裝開機載入程式，請執行下列步驟：
  </para>
  <procedure>
   <step>
    <para>
     執行存取已安裝系統所需的必要步驟，如 <xref linkend="sec-trouble-data-recover-rescue-access"/> 所述。
    </para>
   </step>
   <step>
    <para>
     檢查系統上是否已安裝 GRUB 2 開機載入程式。如果未安裝，請安裝 <systemitem>grub2</systemitem> 套件並執行以下指令
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> grub2-install /dev/sda</screen>
   </step>
   <step>
    <para>
     根據<xref linkend="cha-grub2"/>中概述的 GRUB 2 組態原則，檢查下列檔案是否正確設定，並在必要時加以修正。
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       <filename>/etc/default/grub</filename>
      </para>
     </listitem>
     <listitem>
      <para>
       <filename>/boot/grub2/device.map</filename>
      </para>
     </listitem>
     <listitem>
      <para>
       <filename>/boot/grub2/grub.cfg</filename> (此檔案是系統產生的，不要編輯)
      </para>
     </listitem>
     <listitem>
      <para>
       <filename>/etc/sysconfig/bootloader</filename>
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     依序使用下列指令來重新安裝開機載入程式：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> grub2-mkconfig -o /boot/grub2/grub.cfg</screen>
   </step>
   <step>
    <para>
     卸載分割區，登出<quote>變更根目錄</quote>環境，並將系統重新開機：
    </para>
<screen><prompt>&gt; </prompt>umount -a
exit
reboot</screen>
   </step>
  </procedure>
 </sect3>
 <sect3 xml:id="sec-trouble-data-recover-rescue-dud">
  <title>修復核心安裝</title>
  <para>
   核心更新可能會帶來新的錯誤，進而會影響系統作業。例如，系統中某個硬體的驅動程式可能有錯誤，致使您無法存取和使用系統。在這種情況下，請還原至上回正常運作的核心 (如果系統中提供的話)，或者從安裝媒體安裝原始核心。
  </para>
  <tip>
   <title>如何在更新後保留最後幾個核心</title>
   <para>
    為了防止核心更新出現故障後無法進行開機，請使用核心多版本功能，並告知 <systemitem>libzypp</systemitem> 在更新後保留哪些核心。
   </para>
   <para>
    例如，若要永遠保留最後兩個核心和目前執行中的核心，請新增
   </para>
<screen>multiversion.kernels = latest,latest-1,running</screen>
   <para>
    至 <filename>/etc/zypp/zypp.conf</filename> 檔案。如需詳細資訊，請參閱<xref linkend="cha-tuning-multikernel"/>。
   </para>
  </tip>
  <para>
   另一個類似的情況是，當您需要重新安裝或更新 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 不支援之裝置的已損毀驅動程式時。例如，當硬體廠商使用特定裝置時，比如使用硬體 RAID 控制器，這就要求作業系統能夠識別二進位驅動程式。廠商一般會發行「驅動程式更新磁碟」(DUD)，內含所需驅動程式的修復或更新版本。
  </para>
  <para>
   在這兩種情況下，您都需要以救援模式存取安裝的系統，並修正與核心相關的問題，否則系統可能無法正常開機：
  </para>
  <procedure>
   <step>
    <para>
     從 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 安裝媒體開機。
    </para>
   </step>
   <step>
    <para>
     如果您要在錯誤的核心更新之後復原，請跳過此步驟。如果需要使用驅動程式更新磁碟 (DUD)，請在開機功能表出現之後按 <keycap>F6</keycap> 以載入驅動程式更新，並選擇驅動程式更新的路徑或 URL，然後按一下<guimenu>是</guimenu>確認。
    </para>
   </step>
   <step>
    <para>
     從開機功能表中選擇<guimenu>救援系統</guimenu>，然後按 <keycap function="enter"/>。如果您之前選擇使用 DUD，系統將會要求您指定儲存驅動程式更新的位置。
    </para>
   </step>
   <step>
    <para>
     在 <literal>Rescue:</literal> 提示符處輸入 <literal>root</literal>。無須輸入密碼。
    </para>
   </step>
   <step>
    <para>
     手動將目標系統和<quote>變更根目錄</quote>掛接至新環境：如需詳細資訊，請參閱 <xref linkend="sec-trouble-data-recover-rescue-access"/>。
    </para>
   </step>
   <step>
    <para>
     如果使用 DUD，請安裝/重新安裝/更新錯誤的裝置驅動程式套件。請務必確定已安裝的核心版本與要安裝的驅動程式版本完全相符。
    </para>
    <para>
     如果要修正錯誤的核心更新安裝，可以按照以下程序從安裝媒體安裝原始核心。
    </para>
    <substeps performance="required">
     <step>
      <para>
       使用 <command>hwinfo --cdrom</command> 識別 DVD 裝置，並使用 <command>mount /dev/sr0 /mnt</command> 掛接該裝置。
      </para>
     </step>
     <step>
      <para>
       導覽至 DVD 上儲存核心檔案的目錄，例如 <command>cd /mnt/suse/x86_64/</command>。
      </para>
     </step>
     <step>
      <para>
       使用 <command>rpm -i</command> 指令根據您的偏好安裝所需的 <systemitem>kernel-*</systemitem>、<systemitem>kernel-*-base</systemitem> 和 <systemitem>kernel-*-extra</systemitem> 套件。
      </para>
     </step>

    </substeps>
   </step>
   <step>
    <para>
     根據需要更新組態檔，然後重新啟動開機載入程式。如需詳細資訊，請參閱 <xref linkend="sec-trouble-data-recover-rescue-grub"/>。
    </para>
   </step>
   <step>
    <para>
     從系統磁碟機中取出任何可開機的媒體，然後重新開機。
    </para>
   </step>
  </procedure>
 </sect3>
</sect2>
