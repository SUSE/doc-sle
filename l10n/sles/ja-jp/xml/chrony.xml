<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="chrony.xml" version="5.0" xml:id="cha-ntp">



 <title>NTPによる時刻の同期</title>
 <info>
  <abstract>
   <para>
    NTP (network time protocol)メカニズムは、システムの時刻をネットワーク上で同期させるためのプロトコルです。最初に、マシンは信頼できる時刻を持つサーバに時刻を照会できます。次に、ネットワーク上の他のコンピュータがこのマシン自体に対し、時刻を照会できます。目的は2つあり、絶対的な時間を維持することと、ネットワーク内のすべてのマシンのシステム時刻を同期させることです。
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <para>
  正確なシステム時刻を維持することはさまざまな場で重要です。ハードウェア組み込み型クロックがデータベースやクラスタなどのアプリケーション要件に合致しないことがよくあります。システムタイムを手動で修正することは時に問題を発生させる可能性があります。たとえば、時間を逆廻りに戻すことで重要なアプリケーションの誤動作を誘発することもあります。ネットワーク内では、すべてのマシンのシステムタイムを同期させることが通常必要とされますが、手動での時刻調整はよい方法ではありません。NTPには、これらの問題を解決するメカニズムがあります。NTPサービスは、ネットワーク内の信頼できるタイムサーバを使用して、システム時間を継続的に調整します。さらに、電波時計のようなローカルリファレンスクロックを管理する機能があります。
 </para>
 <para>
  <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 15以降、<systemitem class="resource">chrony</systemitem>は、NTPでデフォルトで実装されるようになりました。<systemitem class="resource">chrony</systemitem>は2つの部分で構成されています。<systemitem class="daemon">chronyd</systemitem>は、ブート時に起動可能なデーモンであり、<command>chronyc</command>は、<systemitem class="daemon">chronyd</systemitem>のパフォーマンスを監視し、実行時にさまざまな動作パラメータを変更するためのコマンドラインインタフェースプログラムです。
 </para>
 <para>
  <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 15.2以降、NTPクライアント設定用のYaSTモジュールは、デーモンとして実行するように設定されていない場合に、cronデーモンではなくsystemd-timerを設定し、<systemitem class="resource">chrony</systemitem>を実行します。
 </para>
 
 <sect1 xml:id="sec-ntp-yast">
  <title>YaSTでのNTPクライアントの設定</title>

  <para>
   <systemitem>chrony</systemitem>パッケージ付属のNTPデーモン(<systemitem class="daemon">chronyd</systemitem>)は、ローカルコンピュータハードウェアクロックを時間の参照に使用するように事前設定されています。ハードウェアクロックの精度は、その時間ソースに大きく依存します。たとえば、原子時計やGPS受信機は非常に正確な時間ソースですが、一般的なRTCチップは信頼できる時間ソースではありません。YaSTを利用すれば、NTPクライアントを簡単に設定することができます。
  </para>

  <para>
   YaST NTPクライアント設定(<menuchoice><guimenu>ネットワークサービス</guimenu> <guimenu>NTP設定</guimenu></menuchoice>)ウィンドウでは、NTPデーモンの開始時期や設定ソースの種類を指定したり、カスタムタイムサーバを追加することができます。
  </para>

  <figure>
   <title>［NTP設定］ウィンドウ</title>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="ntp_client.png" width="70%"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="ntp_client.png" width="70%"/>
    </imageobject>
   </mediaobject>
  </figure>

  <sect2>
   <title>NTPデーモン開始</title>
   <para>
    NTPデーモンを開始する時期は、次の3つのオプションから選択できます。
   </para>
   <variablelist>
    <varlistentry>
     <term><guimenu>手動でのみ</guimenu>
     </term>
     <listitem>
      <para>
       <guimenu>手動でのみ</guimenu>は、<systemitem class="resource">chrony</systemitem>デーモンを手動で開始する場合に選択します。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><guimenu>デーモンを使用せずに同期する</guimenu>
     </term>
     <listitem>
      <para>
       <guimenu>デーモンを使用せずに同期する</guimenu>を選択すると、永続的に動作する<systemitem class="resource">chrony</systemitem>を使用せずに、定期的にシステム時間を設定します。<guimenu>同期間隔(分)</guimenu>を設定できます。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><guimenu>今すぐおよびブート時</guimenu>
     </term>
     <listitem>
      <para>
       システムのブート時に自動的に<systemitem class="daemon">chronyd</systemitem>を起動するには、<guimenu>今すぐ開始し、システム起動時に開始するよう設定</guimenu>を選択します。この設定をお勧めします。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2>
   <title>設定元のタイプ</title>
   <para>
    <guimenu>設定元</guimenu>ドロップダウンボックスで、<guimenu>動的</guimenu>または<guimenu>静的</guimenu>のいずれかを選択します。お使いのサーバが(パブリック) NTPサーバの固定セットのみを使用している場合は、<guimenu>静的</guimenu>を設定し、内部ネットワークがDHCP経由でNTPサーバを提供している場合は、<guimenu>動的</guimenu>が適しています。
   </para>
  </sect2>

  <sect2 xml:id="sec-net-ntp-yast-new-sync">
   <title>タイムサーバの設定</title>
   <para>
    クライアントが問い合わせるタイムサーバは、<guimenu>NTP設定</guimenu>ウィンドウの下部に表示されます。必要に応じて、<guimenu>追加</guimenu>、<guimenu>削除</guimenu>、および<guimenu>編集</guimenu>を使用してこのリストを変更します。
   </para>
   <para>
    <guimenu>追加</guimenu>をクリックして、新しいタイムサーバを追加します。
   </para>
   <figure>
    <title>タイムサーバの追加</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="ntp_client_serveradd.png" width="70%"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="ntp_client_serveradd.png" width="70%"/>
     </imageobject>
    </mediaobject>
   </figure>
   <procedure>
    <step>
     <para>
      <guimenu>アドレス</guimenu>フィールドに、マシン時刻を同期させるタイムサーバまたはタイムサーバのプールのURLを入力します。URLを入力したら、<guimenu>テスト</guimenu>をクリックして、有効な時間ソースを指していることを確認します。
     </para>
    </step>
    <step>
     <para>
      <systemitem class="daemon">chronyd</systemitem>デーモンの開始時により多くの要求を送信することによって時刻同期を高速化するには、<guimenu>初期同期の高速化</guimenu>を有効にします。
     </para>
    </step>
    <step>
     <para>
      ブート時に<systemitem class="daemon">chronyd</systemitem>デーモンを自動的に開始しインターネットに接続されていない可能性のあるシステムでブート時間を短縮するには、<guimenu>オフライン起動</guimenu>を有効にします。このオプションは、ネットワーク接続がNetworkManagerによって管理されるラップトップの場合などに役立ちます。
     </para>
    </step>
    <step>
     <para>
      <guimenu>OK</guimenu>をクリックして、確定します。
     </para>
    </step>
   </procedure>
  </sect2>


 </sect1>



 <sect1 xml:id="sec-net-xntp-netconf">
  <title>ネットワークでのNTPの手動設定</title>

  <para>
   <systemitem class="resource">chrony</systemitem>は、その設定を<filename>/etc/chrony.conf</filename>ファイルから読み込みます。コンピュータのクロックを同期させるには、使用するタイムサーバを<systemitem class="resource">chrony</systemitem>に指示する必要があります。特定のサーバ名またはIPアドレスを使用できます。以下に例を示します。
  </para>

<screen>server 0.europe.pool.ntp.org
server 1.europe.pool.ntp.org
server 2.europe.pool.ntp.org</screen>

  <para>
   <emphasis>プール</emphasis>名を指定することもできます。プール名は複数のIPアドレスに解決されます。
  </para>

<screen>pool pool.ntp.org</screen>

  <tip>
   <title>同じネットワーク上のコンピュータ</title>
   <para>
    同じネットワーク上の複数のコンピュータで時刻を同期させる場合、それらのコンピュータをすべて外部サーバと同期させることはお勧めしません。1つのコンピュータを、外部のタイムサーバと同期させるタイムサーバとし、他のコンピュータを、クライアントとして機能させることをお勧めします。信頼性のあるタイムサーバと区別するには、サーバの<filename>/etc/chrony.conf</filename>に<literal>local</literal>ディレクティブを追加します。
   </para>
<screen>local stratum 10</screen>
  </tip>

  <para>
   <systemitem class="resource">chrony</systemitem>を起動するには、次のコマンドを実行します。
  </para>

<screen>systemctl start chronyd.service</screen>

  <para>
   <systemitem class="daemon">chronyd</systemitem>を初期化した後、時間が安定するまでにある程度時間がかかり、ローカルコンピュータクロックを修正するためのドリフトファイルが作成されます。ドリフトファイルを用いることで、ハードウェアクロックの定誤差はコンピュータの電源が入った時点で算出されます。修正はすぐに反映されるため、システム時刻がより安定します。
  </para>

  <para>
   ブート時に<systemitem class="resource">chrony</systemitem>が自動的に起動するようにサービスを有効にするには、次のコマンドを実行します。
  </para>

<screen>systemctl enable chronyd.service</screen>
 </sect1>
 <sect1 xml:id="ntp-chronyc">
  <title><command>chronyc</command>を使用した実行時の<systemitem class="daemon">chronyd</systemitem>の設定</title>

  <para>
   実行時に<command>chronyc</command>を使用して<systemitem class="daemon">chronyd</systemitem>の動作を変更することができます。<systemitem class="daemon">chronyd</systemitem>の操作に関するステータスレポートも生成します。
  </para>

  <para>
   <command>chronyc</command>は、対話的または非対話的モードで実行できます。<command>chronyc</command>を対話形式で実行するには、コマンドラインで<command>chronyc</command>を入力します。プロンプトを表示し、コマンド入力を待ちます。たとえば、オンラインまたはオフラインのNTPソースの数を確認するには、次のコマンドを実行します。
  </para>

<screen><prompt role="root"># </prompt><command>chronyc</command>
chronyc&gt; activity
200 OK
4 sources online
2 sources offline
1 sources doing burst (return to online)
1 sources doing burst (return to offline)
0 sources with unknown address</screen>

  <para>
   <command>chronyc</command>のプロンプトを終了するには、<command>quit</command>または<command>exit</command>を入力します。
  </para>

  <para>
   対話型プロンプトを使用する必要がない場合は、次のようにコマンドを直接入力します。
  </para>

<screen><prompt role="root"># </prompt><command>chronyc</command> activity</screen>

  <note>
   <title>一時的な変更</title>
   <para>
    <command>chronyc</command>を使用して行われた変更は、永続的ではありません。変更内容は、次の<systemitem class="daemon">chronyd</systemitem>の再起動後に失われます。永続的な変更を行う場合は、<filename>/etc/chrony.conf</filename>を変更してください。
   </para>
  </note>

  <para>
   <command>chronyc</command>コマンドの完全なリストについては、そのマニュアルページ(<command>man 1 chronyc</command>)を参照してください。
  </para>
 </sect1>
 <sect1 xml:id="sec-net-xntp-dynamic">
  <title>ランタイム時の動的時刻同期</title>



  <para>
  <systemitem class="daemon">chronyd</systemitem>は、ネットワーク接続なしでブートするシステムでは正常に起動しますが、ツールは設定ファイルで指定されたタイムサーバのDNS名を解決できません。
  </para>

  <para>
   <systemitem class="daemon">chronyd</systemitem>は、<option>server</option>、<option>pool</option>、および<option>peer</option>ディレクティブによって指定されたタイムサーバ名を、時間間隔を増やして成功するまで解決しようとします。 
  </para>

  <para>
   <systemitem class="daemon">chronyd</systemitem>の起動時にタイムサーバにアクセスできない場合は、<option>offline</option>オプションを指定することができます。
  </para>

<screen>server <replaceable>server_address</replaceable> offline</screen>

  <para>
   この場合、<systemitem class="daemon">chronyd</systemitem>は、次のコマンドを使用して有効にするまで、サーバをポーリングしようとしません。
  </para>

<screen><prompt role="root"># </prompt>chronyc online <replaceable>server_address</replaceable></screen>

  <para>
   <option>auto_offline</option>オプションが設定されている場合、タイムサーバに2つの要求を送信して応答を受信しなかったときに、<systemitem class="daemon">chronyd</systemitem>はそのタイムサーバがオフラインになったとみなします。このオプションにより、ネットワークリンクを切断するときに<command>chronyc</command>から&apos;offline&apos;コマンドを実行する必要がなくなります。
  </para>
 </sect1>



 <sect1 xml:id="sec-net-xntp-normal">
  <title>ローカルリファレンスクロックの設定</title>

  <para>
   ソフトウェアパッケージ<systemitem class="resource">chrony</systemitem>は、SHMまたはSOCKドライバを介してタイミングデータにアクセスするために、他のプログラム(<systemitem>gpsd</systemitem>など)を利用しています。<filename>/etc/chrony.conf</filename>の<option>refclock</option>ディレクティブを使用して、時間ソースとして使用するハードウェア基準クロックを指定します。これには、2つの必須パラメータ(ドライバ名とドライバ固有のパラメータ)があります。2つのパラメータの後には、ゼロ以上の<option>refclock</option>オプションが続きます。<systemitem class="daemon">chronyd</systemitem>には、次のドライバが含まれています。
  </para>

  <itemizedlist>
   <listitem>
    <para>
     PPS - カーネル「パルス/秒」API用のドライバ。例:
    </para>
<screen>refclock PPS /dev/pps0 lock NMEA refid GPS</screen>
   </listitem>
   <listitem>
    <para>
     SHM - NTP共有メモリドライバ。例:
    </para>
<screen>refclock SHM 0 poll 3 refid GPS1
refclock SHM 1:perm=0644 refid GPS2</screen>
   </listitem>
   <listitem>
    <para>
     SOCK - Unixドメインソケットドライバ。例:
    </para>
<screen>refclock SOCK /var/run/chrony.ttyS0.sock</screen>
   </listitem>
   <listitem>
    <para>
     PHC - PTPハードウェアクロックドライバ。例:
    </para>
<screen>refclock PHC /dev/ptp0 poll 0 dpoll -2 offset -37
refclock PHC /dev/ptp1:nocrossts poll 3 pps</screen>
   </listitem>
  </itemizedlist>

  <para>
   個々のドライバのオプションの詳細については、<command>man 8 chrony.conf</command>を参照してください。
  </para>
 </sect1>
 <sect1 xml:id="sec-net-xntp-etr" arch="zseries">
  <title>ETR (External Time Reference)とのクロックの同期</title>



  <para>
   ETR（External Time Reference）とのクロック同期のサポートを利用できます。ETRは、2**20(2の20乗)マイクロ秒ごとに、発振器信号と同期信号を送信して、すべての接続先サーバのTODクロックの同期を保ちます。
  </para>

  <para>
   可用性のため、2ユニットのETRをコンピュータに接続できます。クロックが同期チェックの許容値を超えた場合は、すべてのCPUがマシンをチェックし、クロックが同期していないことを示します。この事態が発生した場合は、XRC対応デバイスへのすべてのDASD I/Oがクロックの再同期まで停止します。
  </para>

  <para>
   ETRサポートは2つの<literal>sysfs</literal>属性を介して有効化されます。<systemitem class="username">root</systemitem>として次のコマンドを実行します。
  </para>

<screen>echo 1 &gt; /sys/devices/system/etr/etr0/online
echo 1 &gt; /sys/devices/system/etr/etr1/online
</screen>
 </sect1>
</chapter>
