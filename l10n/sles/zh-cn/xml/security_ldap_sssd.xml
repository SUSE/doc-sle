<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="security_ldap_sssd.xml" version="5.0" xml:id="sec-security-ldap-server-sssd">
 <info>
  <title>使用 SSSD 管理 LDAP 身份验证</title>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
  <para>
    系统安全服务守护程序 (SSSD) 管理远程用户的身份验证、标识和访问控制。本节介绍如何使用 SSSD 来管理 389 Directory Server 的身份验证和标识。
  </para>
  <para>
    SSSD 在 LDAP 服务器和客户端之间进行调解。它支持多个提供者后端，例如 LDAP、Active Directory 和 Kerberos。SSSD 支持 SSH、PAM、NSS 和 sudo 等服务。SSSD 通过缓存用户 ID 和凭据来提供性能优势与复原能力。缓存可以减少对 389 DS 服务器发出的请求数量，并在后端不可用时提供身份验证和身份服务。
  </para>
  <para>
    如果名称服务缓存守护程序 (nscd) 在您的网络中运行，您应该将其禁用或去除。nscd 仅缓存 passwd、group、hosts、service 和 netgroup 等常见名称服务请求，并且与 SSSD 冲突。
  </para>
  <para>
    LDAP 服务器是提供者，SSSD 实例是提供者的客户端。可以在 389 DS 服务器上安装 SSSD，但将其安装在单独的计算机上可以提供一定的复原能力，以防 389 DS 服务器不可用。使用以下过程安装和配置 SSSD 客户端。示例 389 DS 实例名称为 <replaceable>LDAP1</replaceable>：
  </para>
  <procedure>
    <step>
      <para>
    安装 <systemitem>sssd</systemitem> 和 <systemitem>sssd-ldap</systemitem> 软件包。
   </para>
    <screen><prompt>&gt; </prompt><command>sudo</command> <command>zypper in sssd sssd-ldap</command></screen>
  </step>
  <step>
    <para>
    备份 <filename>/etc/sssd/sssd.conf</filename> 文件（如果存在）：
  </para>
  <screen><prompt>&gt; </prompt><command>sudo</command> <command>old /etc/sssd/sssd.conf</command></screen>
  </step>
  <step>
   <para>
     创建新的 SSSD 配置模板。允许的输出文件名为 <literal>sssd.conf</literal> 和 <literal>ldap.conf</literal>。<literal>display</literal> 将输出发送到 stdout。以下示例在 <filename>/etc/sssd/sssd.conf</filename> 中创建客户端配置：
   </para>
   <screen><prompt>&gt; </prompt><command>sudo</command> <command>cd /etc/sssd</command>
<prompt>&gt; </prompt><command>sudo</command> <command>dsidm <replaceable>LDAP1</replaceable> client_config sssd.conf</command>
</screen>
  </step>
  <step>
    <para>
      检查输出，并根据您的环境进行任何必要的更改。以下 <filename>/etc/sssd/sssd.conf</filename> 文件演示了一个可正常工作的示例。
    </para>
    <important>
     <title>MemberOf</title>
     <para>
      LDAP 访问过滤器依赖于所要配置的 <literal>MemberOf</literal>。有关详细信息，请参见<xref linkend="sec-security-ldap-modules"/>。
     </para>
    </important>
    <screen>[sssd]
services = nss, pam, ssh, sudo
config_file_version = 2
domains = default

[nss]
homedir_substring = <replaceable>/home</replaceable>

[domain/default]
# If you have large groups (for example, 50+ members),
# you should set this to True
ignore_group_members = False
debug_level=3
cache_credentials = True
id_provider = ldap
auth_provider = ldap
access_provider = ldap
chpass_provider = ldap

ldap_schema = rfc2307bis
ldap_search_base = <replaceable>dc=example,dc=com</replaceable>
# We strongly recommend ldaps
ldap_uri = <replaceable>ldaps://ldap.example.com</replaceable>
ldap_tls_reqcert = demand
ldap_tls_cacert = /etc/openldap/ldap.crt
ldap_access_filter = (|(memberof=cn=&lt;login group&gt;,ou=Groups,dc=example,dc=com))
enumerate = false
access_provider = ldap

ldap_user_member_of = memberof
ldap_user_gecos = cn
ldap_user_uuid = nsUniqueId
ldap_group_uuid = nsUniqueId
ldap_account_expire_policy = rhds
ldap_access_order = filter, expire
# add these lines to /etc/ssh/sshd_config
#  AuthorizedKeysCommand /usr/bin/sss_ssh_authorizedkeys
#  AuthorizedKeysCommandUser nobody
ldap_user_ssh_public_key = nsSshPublicKey</screen>
  </step>
  <step>
    <para>
      将文件所有权设置为 root，并将读写权限限制为 root：
    </para>
    <screen><prompt>&gt; </prompt><command>sudo</command> <command>chown root:root /etc/sssd/sssd.conf</command>
<prompt>&gt; </prompt><command>sudo</command> <command>chmod 600 /etc/sssd/sssd.conf</command></screen>
  </step>
  <step>
    <para>
      编辑 SSSD 服务器上的 <filename>/etc/nsswitch.conf</filename> 配置文件，在其中包含以下行：
    </para>
    <screen>passwd: compat sss
group:  compat sss
shadow: compat sss</screen>
</step>
<step>
  <para>
    编辑 SSSD 服务器上的 PAM 配置，修改其中的 <filename>common-account-pc</filename>、<filename>common-auth-pc</filename>、<filename>common-password-pc</filename> 和 <filename>common-session-pc</filename>。SUSE Linux Enterprise 提供了 <command>pam-config</command> 命令用于一次性修改所有这些文件：
</para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>pam-config -a --sss</command></screen>
  </step>
  <step>
    <para>
      校验修改后的配置：
    </para>
    <screen><prompt>&gt; </prompt><command>sudo</command> <command>pam-config -q --sss</command>
auth:
account:
password:
session:</screen>
</step>
<step>
    <para>
      将 389 DS 服务器中的 <filename>/etc/dirsrv/slapd-<replaceable>LDAP1/</replaceable>ca.crt</filename> 复制到 SSSD 服务器上的 <filename>/etc/openldap/certs</filename>，然后为其重建哈希：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>c_rehash /etc/openldap/certs</command></screen>
   </step>
   <step>
    <para>
     启用并启动 SSSD：
    </para>
    <screen><prompt>&gt; </prompt><command>sudo</command> <command>systemctl enable --now sssd</command></screen>
   </step>
  </procedure>
        
  <para>
    有关使用 systemctl 管理 sssd.service 的信息，请参见<xref linkend="cha-security-auth"/>。
  </para>
  </sect1>
