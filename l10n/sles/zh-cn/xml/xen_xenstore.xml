<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="xen_xenstore.xml" version="5.0" xml:id="cha-xen-xenstore">
  <title>XenStore：在域之间共享的配置数据库</title>
  <info>
    <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
      <dm:bugtracker/>
      <dm:translation>yes</dm:translation>
    </dm:docmanager>
  </info>
  <para>
    本章介绍有关 XenStore 的基本信息、其在 Xen 环境中的作用、XenStore 所使用的文件的目录结构，以及 XenStore 命令的说明。
  </para>
  <sect1 xml:id="sec-xenstore-intro">
    <title>简介</title>

    <para>
      XenStore 是在 Dom0 中所运行的 VM Guest 与管理工具之间共享的配置和状态信息数据库。VM Guest 和管理工具对 XenStore 进行读取和写入以传达配置信息、状态更新和状态更改。XenStore 数据库由 Dom0 管理，支持读取和写入密钥等简单操作。可以通过监测关注项将 XenStore 中发生的任何更改通知给 VM Guest 和管理工具。<systemitem>xenstored</systemitem> 守护程序由 <systemitem>xencommons</systemitem> 服务管理。
    </para>

    <para>
      XenStore 位于 Dom0 上的单个数据库文件 <filename>/var/lib/xenstored/tdb</filename>（<literal>tdb</literal> 表示<emphasis>树数据库</emphasis>）中。
    </para>
  </sect1>
  <sect1 xml:id="sec-xenstore-fsi">
    <title>文件系统接口</title>

    <para>
      XenStore 数据库内容由与 <filename>/proc</filename> 类似的虚拟文件系统表示（有关 <filename>/proc</filename> 的详细信息，请参见<xref linkend="sec-util-proc"/>）。树有三条主路径：<filename>/vm</filename>、<filename>/local/domain</filename> 和 <filename>/tool</filename>。
    </para>

    <itemizedlist mark="bullet" spacing="normal">
      <listitem>
        <para>
          <filename>/vm</filename> - 存储有关 VM Guest 配置的信息。
        </para>
      </listitem>
      <listitem>
        <para>
          <filename>/local/domain</filename> - 存储有关本地节点上的 VM Guest 的信息。
        </para>
      </listitem>
      <listitem>
        <para>
          <filename>/tool</filename> - 存储有关多个工具的一般信息。
        </para>
      </listitem>
    </itemizedlist>

    <tip>
      <para>
        每个 VM Guest 都有两个不同的 ID 编号。即使 VM Guest 迁移到其他计算机，<emphasis>全局唯一标识符</emphasis> (UUID) 也保持不变。<emphasis>域标识符</emphasis> (DOMID) 是表示正在运行的特定实例的标识号。将 VM Guest 迁移到其他计算机后，此编号通常会改变。
      </para>
    </tip>

    <sect2>
      <title>XenStore 命令</title>
      <para>
        可使用以下命令操作 XenStore 数据库的文件系统结构：
      </para>
      <variablelist>
        <varlistentry>
          <term><command>xenstore-ls</command></term>
          <listitem>
            <para>
              显示 XenStore 数据库的完整转储。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><command>xenstore-read</command><option>path_to_xenstore_entry</option></term>
          <listitem>
            <para>
              显示指定 XenStore 项的值。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><command>xenstore-exists</command><option>xenstore_path</option></term>
          <listitem>
            <para>
              报告指定的 XenStore 路径是否存在。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><command>xenstore-list</command><option>xenstore_path</option></term>
          <listitem>
            <para>
              显示指定 XenStore 路径的所有子项。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><command>xenstore-write</command><option>path_to_xenstore_entry</option></term>
          <listitem>
            <para>
              更新指定 XenStore 项的值。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><command>xenstore-rm</command><option>xenstore_path</option></term>
          <listitem>
            <para>
              去除指定的 XenStore 项或目录。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><command>xenstore-chmod</command><option>xenstore_path</option><option>mode</option></term>
          <listitem>
            <para>
              更新对指定 XenStore 路径的读取/写入权限。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><command>xenstore-control</command></term>
          <listitem>
            <para>
              将一条命令（例如，用于触发完整性检查）发送到 <systemitem>xenstored</systemitem> 后端。
            </para>
          </listitem>
        </varlistentry>
      </variablelist>
    </sect2>

    <sect2 xml:id="xenstore-vm">
      <title><filename>/vm</filename></title>
      <para>
        <filename>/vm</filename> 路径按每个 VM Guest 的 UUID 编制索引，用于存储虚拟 CPU 数量和分配的内存量等配置信息。每个 VM Guest 都有一个 <filename>/vm/&lt;uuid&gt;</filename> 目录。要列出目录内容，请使用 <command>xenstore-list</command>。
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> xenstore-list /vm
00000000-0000-0000-0000-000000000000
9b30841b-43bc-2af9-2ed3-5a649f466d79-1</screen>
      <para>
        输出的第一行属于 Dom0，第二行属于正在运行的 VM Guest。以下命令会列出与 VM Guest 相关的所有项：
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> xenstore-list /vm/9b30841b-43bc-2af9-2ed3-5a649f466d79-1
image
rtc
device
pool_name
shadow_memory
uuid
on_reboot
start_time
on_poweroff
bootloader_args
on_crash
vcpus
vcpu_avail
bootloader
name</screen>
      <para>
        要读取某个项（例如，专用于 VM Guest 的虚拟 CPU 数量）的值，请使用 <command>xenstore-read</command>：
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> xenstore-read /vm/9b30841b-43bc-2af9-2ed3-5a649f466d79-1/vcpus
1</screen>
      <para>
        所选 <filename>/vm/&lt;uuid&gt;</filename> 项的列表如下：
      </para>
      <variablelist>
        <varlistentry>
          <term><literal>uuid</literal></term>
          <listitem>
            <para>
              VM Guest 的 UUID，在迁移过程中不会变化。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><literal>on_reboot</literal></term>
          <listitem>
            <para>
              指定响应重引导请求时是要销毁还是重启动 VM Guest。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><literal>on_poweroff</literal></term>
          <listitem>
            <para>
              指定响应暂停请求时是要销毁还是重启动 VM Guest。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><literal>on_crash</literal></term>
          <listitem>
            <para>
              指定响应崩溃事件时是要销毁还是重启动 VM Guest。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><literal>vcpus</literal></term>
          <listitem>
            <para>
              分配给 VM Guest 的虚拟 CPU 数量。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><literal>vcpu_avail</literal></term>
          <listitem>
            <para>
              VM Guest 的活动虚拟 CPU 的位掩码。位掩码中有多个位等于 <literal>vcpus</literal> 的值，其中有一个位是为每个联机虚拟 CPU 设置的。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><literal>name</literal></term>
          <listitem>
            <para>
              VM Guest 的名称。
            </para>
          </listitem>
        </varlistentry>
      </variablelist>
      <para>
        普通的 VM Guest（不是 Dom0）使用 <filename>/vm/&lt;uuid&gt;/image</filename> 路径：
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> xenstore-list /vm/9b30841b-43bc-2af9-2ed3-5a649f466d79-1/image
ostype
kernel
cmdline
ramdisk
dmargs
device-model
display</screen>
      <para>
        使用的项的解释如下：
      </para>
      <variablelist>
        <varlistentry>
          <term><literal>ostype</literal></term>
          <listitem>
            <para>
              VM Guest 的操作系统类型。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><literal>kernel</literal></term>
          <listitem>
            <para>
              Dom0 上指向 VM Guest 内核的路径。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><literal>cmdline</literal></term>
          <listitem>
            <para>
              引导时对 VM Guest 使用的内核命令行。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><literal>ramdisk</literal></term>
          <listitem>
            <para>
              Dom0 上指向 VM Guest RAM 磁盘的路径。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><literal>dmargs</literal></term>
          <listitem>
            <para>
              显示传递给 QEMU 进程的参数。如果您使用 <command>ps</command> 查看 QEMU 进程，看到的参数应该与 <filename>/vm/&lt;uuid&gt;/image/dmargs</filename> 中的相同。
            </para>
          </listitem>
        </varlistentry>
      </variablelist>
    </sect2>

    <sect2>
      <title><filename>/local/domain/&lt;domid&gt;</filename></title>
      <para>
        此路径按运行中的域 (VM Guest) ID 编制索引，包含有关运行中的 VM Guest 的信息。请记住，在迁移 VM Guest 期间，域 ID 会变化。可用的项如下：
      </para>
      <variablelist>
        <varlistentry>
          <term><literal>vm</literal></term>
          <listitem>
            <para>
              此 VM Guest 的 <filename>/vm</filename> 目录的路径。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><literal>on_reboot, on_poweroff, on_crash, name</literal></term>
          <listitem>
            <para>
              请参见<xref linkend="xenstore-vm"/>中的相同选项。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><literal>domid</literal></term>
          <listitem>
            <para>
              VM Guest 的域标识符。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><literal>cpu</literal></term>
          <listitem>
            <para>
              当前 VM Guest 固定到的 CPU。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><literal>cpu_weight</literal></term>
          <listitem>
            <para>
              出于调度目的指派给 VM Guest 的权重。权重越高，使用物理 CPU 的频率就越高。
            </para>
          </listitem>
        </varlistentry>
      </variablelist>
      <para>
        除了上面所述的各个项以外，<filename>/local/domain/&lt;domid&gt;</filename> 下的多个子目录也包含特定的项。要查看所有可用的项，请参见 <link xlink:href="http://wiki.xen.org/wiki/XenStore_Reference">XenStore
        Reference</link>。
      </para>
      <variablelist>
        <varlistentry>
          <term><literal>/local/domain/&lt;domid&gt;/memory</literal></term>
          <listitem>
            <para>
              包含内存信息。<literal>/local/domain/&lt;domid&gt;/memory/target</literal> 包含 VM Guest 的目标内存大小（以 KB 为单位）。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><literal>/local/domain/&lt;domid&gt;/console</literal></term>
          <listitem>
            <para>
              包含有关 VM Guest 所用控制台的信息。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><literal>/local/domain/&lt;domid&gt;/backend</literal></term>
          <listitem>
            <para>
              包含有关 VM Guest 所用的所有后端设备的信息。该路径包含 VM Guest 自己的子目录。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><literal>/local/domain/&lt;domid&gt;/device</literal></term>
          <listitem>
            <para>
              包含有关 VM Guest 的前端设备的信息。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><literal>/local/domain/&lt;domid&gt;/device-misc</literal></term>
          <listitem>
            <para>
              包含有关设备的其他信息。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><literal>/local/domain/&lt;domid&gt;/store</literal></term>
          <listitem>
            <para>
              包含有关 VM Guest 的储存的信息。
            </para>
          </listitem>
        </varlistentry>
      </variablelist>
    </sect2>
  </sect1>
</chapter>
