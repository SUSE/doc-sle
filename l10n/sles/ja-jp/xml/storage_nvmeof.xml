<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="storage_nvmeof.xml" version="5.0" xml:id="cha-nvmeof" xml:lang="ja">
 <title>NVMe over Fabric</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    この章では、NVMe over Fabricホストおよびターゲットの設定方法について説明します。
   </para>
  </abstract>
 </info>
 <sect1 xml:id="sec-nvmeof-overview">
  <title>概要</title>
  <para>
   <emphasis/>NVM Express (<emphasis/>NVMe)は、不揮発性ストレージ(通常はSSDディスク)にアクセスするためのインタフェース規格です。NVMeはSATAをはるかに上回る処理速度をサポートし、レイテンシも低くなります。
  </para>
  <para>
   <emphasis/>NVMe over Fabricは、<emphasis/>RDMAや<emphasis/>NVMe over Fibre Channel (<emphasis/>FC-NVMe)などの異なるネットワーキングファブリックを介してNVMeストレージにアクセスするためのアーキテクチャです。NVMe over Fabricの機能はiSCSIと同様です。耐障害性を向上させるため、NVMe over Fabricにはマルチパスのサポートが組み込まれています。NVMe over Fabricマルチパスは、従来のデバイスマッパーマルチパスに基づいていません。
  </para>
  <para>
   <emphasis/>NVMeホストは、NVMeターゲットに接続するマシンです。<emphasis/>NVMeターゲットは、そのNVMeブロックデバイスを共有するマシンです。
  </para>
  <para>
   NVMeはSUSE Linux Enterprise Server <phrase role="productnumber"><phrase os="sles;sled">15 SP1</phrase></phrase>でサポートされています。NVMeブロックストレージおよびNVMe over Fabricターゲットとホストには、専用のカーネルモジュールが用意されています。
  </para>
  <para>
   ご使用のハードウェアに関する特別な考慮事項があるかどうかを確認するには、<xref linkend="sec-nvmeof-hardware"/>を参照してください。
  </para>
 </sect1>
 <sect1 xml:id="sec-nvmeof-host-configuration">
  <title>NVMe over Fabricホストの設定</title>
  <para>
   NVMe over Fabricを使用するには、サポートされているネットワーキング方法のいずれかでターゲットを使用可能にする必要があります。NVMe over Fibre ChannelおよびRDMAがサポートされています。以降のセクションでは、NVMe over FabricホストをNVMeターゲットに接続する方法について説明します。
  </para>
  <sect2 xml:id="sec-nvmeof-host-configuration-cli">
   <title>コマンドラインクライアントのインストール</title>
   <para>
    NVMe over Fabricを使用するには、<command>nvme</command>コマンドラインツールが必要です。インストールするには、<command>zypper</command>を実行します。
   </para>
   <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>zypper in nvme-cli</command></screen>
   <para>
    すべての使用可能なサブコマンドを一覧にするには、<command>nvme --help</command>を使用します。<command>nvme</command>サブコマンド用のマニュアルページが提供されています。<command>man nvme-<replaceable>SUBCOMMAND</replaceable></command>を実行すると、このページを参照できます。たとえば、<option>discover</option>サブコマンドのマニュアルページを参照するには、<command>man nvme-discover</command>を実行します。
   </para>
  </sect2>
  <sect2 xml:id="sec-nvmeof-host-configuration-target-discovery">
   <title>NVMe over Fabricターゲットの検出</title>
   <para>
    NVMe over Fabricターゲットで使用可能なNVMeサブシステムを一覧にするには、検出コントローラのアドレスとサービスIDが必要です。
   </para>
   <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>nvme discover -t <replaceable>TRANSPORT</replaceable> -a <replaceable>DISCOVERY_CONTROLLER_ADDRESS</replaceable> -s <replaceable>SERVICE_ID</replaceable></command></screen>
   <para>
    <replaceable>TRANSPORT</replaceable>は、基盤となる転送メディア(<option>loop</option>、<option>rdma</option>、または<option>fc</option>)で置き換えます。<replaceable>DISCOVERY_CONTROLLER_ADDRESS</replaceable>は、検出コントローラのアドレスで置き換えます。RDMAの場合、これはIPv4アドレスである必要があります。<replaceable>SERVICE_ID</replaceable>は、転送サービスIDで置き換えます。RDMAのように、サービスがIPベースの場合、サービスIDはポート番号を指定します。ファイバチャネルの場合、サービスIDは必要ありません。
   </para>
   <para>
    NVMeホストは、接続が許可されているサブシステムのみを参照します。
   </para>
   <para>
    例:
   </para>
   <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>nvme discover -t rdma -a 10.0.0.1 -s 4420</command></screen>
   <para>
    詳細については、<command>man nvme-discover</command>を参照してください。
   </para>
  </sect2>
  <sect2 xml:id="sec-nvmeof-host-configuration-connect-target">
   <title>NVMe over Fabricターゲットへの接続</title>
   <para>
    NVMeサブシステムを特定した後で、<command>nvme connect</command>コマンドを使用して接続できます。
   </para>
   <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>nvme connect -t <replaceable>transport</replaceable> -a <replaceable>DISCOVERY_CONTROLLER_ADDRESS</replaceable> -s <replaceable>SERVICE_ID</replaceable> -n <replaceable>SUBSYSTEM_NQN</replaceable></command></screen>
   <para>
    <replaceable>TRANSPORT</replaceable>は、基盤となる転送メディア(<option>loop</option>、<option>rdma</option>、または<option>fc</option>)で置き換えます。<replaceable>DISCOVERY_CONTROLLER_ADDRESS</replaceable>は、検出コントローラのアドレスで置き換えます。RDMAの場合、これはIPv4アドレスである必要があります。<replaceable>SERVICE_ID</replaceable>は、転送サービスIDで置き換えます。RDMAのように、サービスがIPベースの場合、これはポート番号を指定します。<replaceable>SUBSYSTEM_NQN</replaceable>は、検出コマンドによって検出された、目的のサブシステムのNVMe修飾名で置き換えます。<emphasis/><emphasis/>NQNは、NVMe修飾名(NVMe Qualified Name)の略語です。NQNは固有である必要があります。
   </para>
   <para>例:</para>
   <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>nvme connect -t rdma -a 10.0.0.1 -s 4420 -n nqn.2014-08.com.example:nvme:nvm-subsystem-sn-d78432</command></screen>
   <para>
    または、<command>nvme connect-all</command>を使用して、すべての検出されたネームスペースに接続します。高度な使用法については、<command>man nvme-connect</command>および<command>man nvme-connect-all</command>を参照してください。
   </para>
  </sect2>
  <sect2 xml:id="sec-nvmeof-host-configuration-multipathing">
   <title>マルチパス処理</title>
   <para>
    NVMeネイティブマルチパス処理はデフォルトで有効になっています。マルチパスデバイスのレイアウトを印刷するには、<command>nvme list-subsys</command>コマンドを使用します。NVMeネイティブマルチパス処理を無効にするには、ブートパラメータとして<option>nvme-core.multipath=N</option>を追加します。
   </para>
   <para>
    <command>multipath -ll</command>コマンドには互換性モードがあり、NVMeマルチパスデバイスを表示します。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-nvmeof-target-configuration">
  <title>NVMe over Fabricターゲットの設定</title>
  <sect2 xml:id="sec-nvmeof-target-configuration-cli">
   <title>コマンドラインクライアントのインストール</title>
   <para>
    NVMe over Fabricターゲットを設定するには、<command>nvmetcli</command>コマンドラインツールが必要です。インストールするには、<command>zypper</command>を実行します。
   </para>
   <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>zypper in nvmetcli</command></screen>
   <para>
    <command>nvmetcli</command>の現在のドキュメントは<link xlink:href="http://git.infradead.org/users/hch/nvmetcli.git/blob_plain/HEAD:/Documentation/nvmetcli.txt"/>から入手できます。
   </para>
  </sect2>
  <sect2 xml:id="sec-nvmeof-target-configuration-steps">
   <title>設定手順</title>
   <para>
    次の手順に、NVMe over Fabricターゲットの設定方法の例を示します。
   </para>
   <para>
    設定はツリー構造で格納されます。移動するには、<command>cd</command>コマンドを使用します。オブジェクトを一覧にするには、<command>ls</command>を使用します。<command>create</command>を使用して新しいオブジェクトを作成できます。
   </para>
   <procedure>
    <step>
     <para>
      <command>nvmectli</command>インタラクティブシェルを起動します。
     </para>
     <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>nvmetcli</command></screen>
    </step>
    <step>
     <para>
      新しいポートを作成します。
     </para>
<screen><prompt>(nvmetcli)&gt; </prompt><command>cd ports</command>
<prompt>(nvmetcli)&gt; </prompt><command>create 1</command>
<prompt>(nvmetcli)&gt; </prompt><command>ls 1/</command>
o- 1
  o- referrals
  o- subsystems</screen>
    </step>
    <step>
     <para>
      NVMeサブシステムを作成します。
     </para>
<screen><prompt>(nvmetcli)&gt; </prompt><command>cd /subsystems</command>
<prompt>(nvmetcli)&gt; </prompt><command>create nqn.2014-08.org.nvmexpress:NVMf:uuid:c36f2c23-354d-416c-95de-f2b8ec353a82</command>
<prompt>(nvmetcli)&gt; </prompt><command>cd nqn.2014-08.org.nvmexpress:NVMf:uuid:c36f2c23-354d-416c-95de-f2b8ec353a82/</command>
<prompt>(nvmetcli)&gt; </prompt><command>ls</command>
o- nqn.2014-08.org.nvmexpress:NVMf:uuid:c36f2c23-354d-416c-95de-f2b8ec353a82
  o- allowed_hosts
  o- namespaces</screen>
    </step>
    <step>
     <para>
      新しいネームスペースを作成し、そのネームスペースにNVMeデバイスを設定します。
     </para>
<screen><prompt>(nvmetcli)&gt; </prompt><command>cd namespaces</command>
<prompt>(nvmetcli)&gt; </prompt><command>create 1</command>
<prompt>(nvmetcli)&gt; </prompt><command>cd 1</command>
<prompt>(nvmetcli)&gt; </prompt><command>set device path=/dev/nvme0n1</command>
Parameter path is now '/dev/nvme0n1'.</screen>
    </step>
    <step>
     <para>
      以前に作成したネームスペースを有効にします。
     </para>
<screen><prompt>(nvmetcli)&gt; </prompt><command>cd ..</command>
<prompt>(nvmetcli)&gt; </prompt><command>enable</command>
The Namespace has been enabled.</screen>
    </step>
    <step>
     <para>
      作成したネームスペースを表示します。
     </para>
<screen><prompt>(nvmetcli)&gt; </prompt><command>cd ..</command>
<prompt>(nvmetcli)&gt; </prompt><command>ls</command>
o- nqn.2014-08.org.nvmexpress:NVMf:uuid:c36f2c23-354d-416c-95de-f2b8ec353a82
  o- allowed_hosts
  o- namespaces
    o- 1</screen>
    </step>
    <step>
     <para>
      すべてのホストがサブシステムを使用できるようにします。この操作は、セキュリティ保護された環境でのみ実行します。
     </para>
<screen><prompt>(nvmetcli)&gt; </prompt><command>set attr allow_any_host=1</command>
Parameter allow_any_host is now '1'.</screen>
     <para>
      または、特定のホストのみが接続できるようにします。
     </para>
<screen><prompt>(nvmetcli)&gt; </prompt><command>cd nqn.2014-08.org.nvmexpress:NVMf:uuid:c36f2c23-354d-416c-95de-f2b8ec353a82/allowed_hosts/</command>
<prompt>(nvmetcli)&gt; </prompt><command>create hostnqn</command></screen>
    </step>
    <step>
     <para>
      すべての作成されたオブジェクトを一覧にします。
     </para>
<screen><prompt>(nvmetcli)&gt; </prompt><command>cd /</command>
<prompt>(nvmetcli)&gt; </prompt><command>ls</command>
o- /
  o- hosts
  o- ports
  | o- 1
  |   o- referrals
  |   o- subsystems
  o- subsystems
    o- nqn.2014-08.org.nvmexpress:NVMf:uuid:c36f2c23-354d-416c-95de-f2b8ec353a82
      o- allowed_hosts
      o- namespaces
        o- 1</screen>
    </step>
    <step>
     <para>
      RDMAを介してターゲットを使用できるようにします。
     </para>
<screen><prompt>(nvmetcli)&gt; </prompt><command>cd ports/1/</command>
<prompt>(nvmetcli)&gt; </prompt><command>set addr adrfam=ipv4 trtype=rdma traddr=10.0.0.1 trsvcid=4420</command>
Parameter trtype is now 'rdma'.
Parameter adrfam is now 'ipv4'.
Parameter trsvcid is now '4420'.
Parameter traddr is now '10.0.0.1'.</screen>
     <para>
      または、ファイバチャネルを介して使用可能にすることができます。
     </para>
<screen><prompt>(nvmetcli)&gt; </prompt><command>cd ports/1/</command>
<prompt>(nvmetcli)&gt; </prompt><command>set addr adrfam=fc trtype=fc traddr=nn-0x1000000044001123:pn-0x2000000055001123 trsvcid=none</command></screen>
    </step>
   </procedure>
  </sect2>
  <sect2 xml:id="sec-nvmeof-target-configuration-backup-configuration">
   <title>ターゲット設定のバックアップと復元</title>
   <para>
    次のコマンドを使用してJSONファイルにターゲット設定を保存できます。
   </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> <command>nvmetcli</command>
<prompt>(nvmetcli)&gt; </prompt><command>saveconfig nvme-target-backup.json</command></screen>
    <para>
     設定を復元するには、次のコマンドを使用します。
    </para>
    <screen><prompt>(nvmetcli)&gt; </prompt><command>restore nvme-target-backup.json</command></screen>
    <para>
     現在の設定を消去することもできます。
    </para>
    <screen><prompt>(nvmetcli)&gt; </prompt><command>clear</command></screen>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-nvmeof-hardware">
  <title>特定のハードウェアの設定</title>
  <sect2 xml:id="sec-nvmeof-hardware-overview">
   <title>概要</title>
   <para>
    一部のハードウェアでは、正しく動作させるために特殊な設定が必要です。次の各セクションの見出しを参照し、記載されているデバイスまたはベンダのいずれかに該当しないか確認してください。
   </para>
  </sect2>
  <sect2 xml:id="sec-nvmeof-hardware-broadcom">
   <title>Broadcom</title>
   <para>
    <emphasis/>Broadcom Emulex LightPulse Fibre Channel SCSIドライバを使用している場合は、<literal>lpfc</literal>モジュールのターゲットおよびホスト上にカーネル設定パラメータを追加します。
   </para>
   <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>echo "options lpfc lpfc_enable_fc4_type=3" &gt; /etc/modprobe.d/lpfc.conf</command></screen>
   <para>
    Broadcomアダプタファームウェアのバージョンが11.4.204.33以降であることを確認します。現在のバージョンの
    <package>nvme-cli</package>、 <package>nvmetcli</package> 、およびカーネルがインストールされていることも確認してください。
   </para>
   <para>
    ファイバチャネルポートをNVMeターゲットとして有効にするには、追加のモジュールパラメータを設定する必要があります。たとえば、<option>lpfc_enable_nvmet=<replaceable> COMMA_SEPARATED_WWPNS</replaceable></option>と指定します。先行する<literal>0x</literal>とともにWWPNを入力します。たとえば、<option>lpfc_enable_nvmet=0x2000000055001122,0x2000000055003344</option>と指定します。一覧表示されているWWPNのみがターゲットモードに設定されます。ファイバチャネルポートは、ターゲットまたはイニシエータ<emphasis/>として設定できます。
   </para>
   </sect2>
 </sect1>
 <sect1 xml:id="sec-nvmeof-more-information">
  <title>詳細情報</title>
  <para>
   <command>nvme</command>の機能の詳細については、<command>nvme nvme-help</command>を参照してください。
  </para>
  <para>
   次のリンクには、NVMeおよびNVMe over Fabricの概要があります。
  </para>
  <itemizedlist>
   <listitem>
    <para><link xlink:href="http://nvmexpress.org/"/></para>
   </listitem>
   <listitem>
    <para><link xlink:href="http://www.nvmexpress.org/wp-content/uploads/NVMe_Over_Fabrics.pdf"/></para>
   </listitem>
   <listitem>
    <para><link xlink:href="https://storpool.com/blog/demystifying-what-is-nvmeof"/></para>
   </listitem>
   </itemizedlist>
 </sect1>
</chapter>
