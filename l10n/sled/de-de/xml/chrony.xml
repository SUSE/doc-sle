<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="chrony.xml" version="5.0" xml:id="cha-ntp">



 <title>Zeitsynchronisierung mit NTP</title>
 <info>
  <abstract>
   <para>
    Der NTP-(Network Time Protocol-)Mechanismus ist ein Protokoll für die Synchronisierung der Systemzeit über das Netzwerk. Erstens kann ein Computer die Zeit von einem Server abrufen, der als zuverlässige Zeitquelle gilt. Zweitens kann ein Computer selbst für andere Computer im Netzwerk als Zeitquelle fungieren. Es gibt zwei Ziele – das Aufrechterhalten der absoluten Zeit und das Synchronisieren der Systemzeit aller Computer im Netzwerk.
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>Ja</dm:translation>
  </dm:docmanager>
 </info>
 <para>
  Das Aufrechterhalten der genauen Systemzeit ist in vielen Situationen wichtig. Die integrierte Hardware-Uhr erfüllt häufig nicht die Anforderungen bestimmter Anwendungen, beispielsweise Datenbanken oder Cluster. Die manuelle Korrektur der Systemzeit würde schwerwiegende Probleme nach sich ziehen; das Zurückstellen kann beispielsweise zu Fehlfunktionen wichtiger Anwendungen führen. Die Systemzeiten der in einem Netzwerk zusammengeschlossenen Computer müssen in der Regel synchronisiert werden. Es empfiehlt sich aber nicht, die Zeiten manuell anzugleichen. Vielmehr sollten Sie dazu NTP verwenden. Der NTP-Dienst passt die Systemzeit ständig anhand zuverlässiger Zeitserver im Netzwerk an. Zudem ermöglicht er die Verwaltung lokaler Referenzuhren, beispielsweise funkgesteuerter Uhren.
 </para>
 <para>
  Ab <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 15 ist <systemitem class="resource">chrony</systemitem> Standardimplementation von NTP. <systemitem class="resource">chrony</systemitem> besteht aus zwei Teilen; der Daemon<systemitem class="daemon">chronyd</systemitem> kann beim Booten gestartet werden und mit dem Kommandozeilenschnittstellenprogramm <command>chronyc</command> ist es möglich, die Leistung von <systemitem class="daemon">chronyd</systemitem> zu überwachen und verschiedene Betriebsparameter zur Laufzeit zu ändern.
 </para>
 <note os="sled;osuse">
  <para>
   Folgen Sie den Anweisungen unter <xref linkend="proc-ad-join"/>, um die Zeitsynchronisierung mithilfe von Active Directory zu aktivieren.
  </para>
 </note>
 <sect1 xml:id="sec-ntp-yast">
  <title>Konfigurieren eines NTP-Client mit YaST</title>

  <para>
   Der NTP-Daemon (<systemitem class="daemon">chronyd</systemitem>) im <systemitem>chrony</systemitem>-Paket ist so voreingestellt, dass die Hardware-Uhr des lokalen Computers als Zeitreferenz verwendet wird. Die Präzision einer Hardware-Uhr ist stark von der Zeitquelle abhängig. Eine Atomuhr oder ein GPS-Empfänger ist beispielsweise eine sehr genaue Zeitquelle, ein normaler RTC-Chip ist dagegen keine zuverlässige Zeitquelle. YaST erleichtert die Konfiguration von NTP-Clients.
  </para>

  <para>
   Im Fenster für die YaST-NTP-Client-Konfiguration (<menuchoice><guimenu>Netzwerkdienste</guimenu> <guimenu>NTP-Konfiguration</guimenu></menuchoice>) können Sie den Zeitpunkt für den Start des NTP-Daemons sowie den Typ der Konfigurationsquelle angeben und benutzerdefinierte Zeitserver einfügen.
  </para>

  <figure>
   <title>Fenster „NTP-Konfiguration“</title>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="ntp_client.png" width="70%"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="ntp_client.png" width="70%"/>
    </imageobject>
   </mediaobject>
  </figure>

  <sect2>
   <title>Start des NTP-Daemons</title>
   <para>
    Zum Starten des NTP-Daemons stehen drei Optionen zur Auswahl:
   </para>
   <variablelist>
    <varlistentry>
     <term><guimenu>Nur manuell</guimenu>
     </term>
     <listitem>
      <para>
       Wählen Sie <guimenu>Nur manuell</guimenu>, wenn der <systemitem class="resource">chrony</systemitem>-Daemon manuell gestartet werden soll.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><guimenu>Ohne Daemon synchronisieren</guimenu>
     </term>
     <listitem>
      <para>
       Wählen Sie <guimenu>Ohne Daemon synchronisieren</guimenu> aus, um die Systemzeit regelmäßig festzulegen, ohne dass <systemitem class="resource">chrony</systemitem> ständig ausgeführt wird. Sie können das <guimenu>Synchronisierungsintervall in Minuten</guimenu> festlegen.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><guimenu>Jetzt und beim Booten</guimenu>
     </term>
     <listitem>
      <para>
       Wählen Sie <guimenu>Jetzt und beim Booten</guimenu>, um <systemitem class="daemon">chrony</systemitem> automatisch beim Booten des Systems zu starten. Diese Einstellung wird empfohlen.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2>
   <title>Typ der Konfigurationsquelle</title>
   <para>
    Wählen Sie im Dropdown-Feld <guimenu>Konfigurationsquelle</guimenu> entweder die Option <guimenu>Dynamisch</guimenu> oder <guimenu>Statisch</guimenu>. Verwenden Sie <guimenu>Statisch</guimenu>, wenn Ihr Server nur mit einer bestimmten Gruppe (öffentlicher) NTP-Server arbeitet, und <guimenu>Dynamisch</guimenu>, wenn Ihr internes Netzwerk NTP-Server über DHCP anbietet.
   </para>
  </sect2>

  <sect2 xml:id="sec-net-ntp-yast-new-sync">
   <title>Konfigurieren von Zeitservern</title>
   <para>
    Im unteren Bereich des Fensters <guimenu>NTP-Konfiguration</guimenu> werden die Zeitserver aufgelistet, die der Client abfragen kann. Bearbeiten Sie diese Liste nach Bedarf mithilfe der Optionen <guimenu>Hinzufügen</guimenu>, <guimenu>Bearbeiten</guimenu> und <guimenu>Löschen</guimenu>.
   </para>
   <para>
    Klicken Sie auf <guimenu>Hinzufügen</guimenu>, um einen neuen Zeitserver hinzuzufügen:
   </para>
   <figure>
    <title>Hinzufügen eines Zeitservers</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="ntp_client_serveradd.png" width="70%"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="ntp_client_serveradd.png" width="70%"/>
     </imageobject>
    </mediaobject>
   </figure>
   <procedure>
    <step>
     <para>
      Geben Sie in das Feld <guimenu>Adresse</guimenu> die URL des Zeitservers oder des Zeitserver-Pools ein, mit dem die Computerzeit synchronisiert werden soll. Prüfen Sie mit <guimenu>Test</guimenu>, ob die eingegebene URL auf eine gültige Zeitquelle verweist.
     </para>
    </step>
    <step>
     <para>
      Mit <guimenu>Schnelle erste Synchronisierung</guimenu> wird eine größere Anzahl von Anfragen beim Start des <systemitem class="daemon">chronyd</systemitem>-Daemons gesendet, sodass die Zeitsynchronisierung beschleunigt wird.
     </para>
    </step>
    <step>
     <para>
      Mit <guimenu>Offline starten</guimenu> beschleunigen Sie den Bootvorgang auf Systemen, auf denen der <systemitem class="daemon">chronyd</systemitem>-Daemon automatisch gestartet wird und die beim Booten keine Internetverbindung besitzen. Diese Option eignet sich beispielsweise für Laptops, deren Netzwerkverbindung über NetworkManager verwaltet wird.
     </para>
    </step>
    <step>
     <para>
      Bestätigen Sie Ihre Auswahl mit <guimenu>OK</guimenu>.
     </para>
    </step>
   </procedure>
  </sect2>


 </sect1>



 <sect1 xml:id="sec-netz-xntp-netconf">
  <title>Manuelle Konfiguration von NTP im Netzwerk</title>

  <para>
   <systemitem class="resource">chrony</systemitem> liest die Konfiguration aus der Datei <filename>/etc/chrony.conf</filename> aus. Damit die Computeruhr synchronisiert bleibt, müssen Sie die zu verwendenden Zeitserver in <systemitem class="resource">chrony</systemitem> festlegen. Hierbei können Sie spezielle Servernamen oder IP-Adressen angeben, beispielsweise:
  </para>

<screen>server 0.europe.pool.ntp.org
server 1.europe.pool.ntp.org
server 2.europe.pool.ntp.org</screen>

  <para>
   Sie können auch den Namen für einen <emphasis>Pool</emphasis> angeben. Der Poolname wird in mehrere IP-Adressen aufgelöst:
  </para>

<screen>pool pool.ntp.org</screen>

  <tip>
   <title>Computer in demselben Netzwerk</title>
   <para>
    Soll die Zeit auf mehreren Computern in demselben Netzwerk synchronisiert werden, sollten Sie nicht alle Computer mit einem externen Server synchronisieren. Ein bewährtes Verfahren besteht darin, einen Computer als Zeitserver, der mit einem externen Zeitserver synchronisiert wird, und die anderen Computer als die Clients dieses Computers festzulegen. Tragen Sie eine <literal>local</literal>-Directive in die Datei <filename>/etc/chrony.conf</filename> des Servers ein, sodass dieser Server von einem autoritativen Zeitserver unterschieden wird:
   </para>
<screen>local stratum 10</screen>
  </tip>

  <para>
   Starten Sie <systemitem class="resource">chrony</systemitem> mit dem folgenden Kommando:
  </para>

<screen>systemctl start chronyd.service</screen>

  <para>
   Nach der Initialisierung von <systemitem class="daemon">chronyd</systemitem> dauert es eine gewisse Zeit, bis die Zeit sich stabilisiert und die Drift-Datei zum Korrigieren der lokalen Computeruhr erstellt wird. Mithilfe der Drift-Datei kann der systematische Fehler der Hardware-Uhr berechnet werden, wenn der Computer eingeschaltet wird. Die Korrektur kommt umgehend zum Einsatz und führt zu einer größeren Stabilität der Systemzeit.
  </para>

  <para>
   Aktivieren Sie den Dienst, sodass <systemitem class="resource">chrony</systemitem> automatisch beim Booten gestartet wird, mit dem folgenden Kommando:
  </para>

<screen>systemctl enable chronyd.service</screen>
 </sect1>
 <sect1 xml:id="ntp-chronyc">
  <title>Konfigurieren von <systemitem class="daemon">chronyd</systemitem> zur Laufzeit mit <command>chronyc</command></title>

  <para>
   Mit <command>chronyc</command> können Sie das Verhalten von <systemitem class="daemon">chronyd</systemitem> zur Laufzeit verändern. Hiermit werden außerdem Statusberichte zum Betrieb von <systemitem class="daemon">chronyd</systemitem> erzeugt.
  </para>

  <para>
   Sie können <command>chronyc</command> wahlweise im interaktiven oder im nicht interaktiven Modus ausführen. Soll <command>chronyc</command> interaktiv ausgeführt werden, geben Sie <command>chronyc</command> in die Kommandozeile ein. Eine Eingabeaufforderung wird angezeigt und das System wartet auf Ihre Kommandoeingabe. Mit dem folgenden Kommando prüfen Sie beispielsweise, wie viele NTP-Quellen online oder offline sind:
  </para>

<screen><prompt role="root">root # </prompt><command>chronyc</command>
chronyc&gt; activity
200 OK
4 sources online
2 sources offline
1 sources doing burst (return to online)
1 sources doing burst (return to offline)
0 sources with unknown address</screen>

  <para>
   Mit <command>quit</command> oder <command>exit</command> schließen Sie die <command>chronyc</command>-Eingabeaufforderung.
  </para>

  <para>
   Falls Sie keine interaktive Eingabeaufforderung benötigen, geben Sie das Kommando direkt ein:
  </para>

<screen><prompt role="root">root # </prompt><command>chronyc</command> activity</screen>

  <note>
   <title>Temporäre Änderungen</title>
   <para>
    Die mit <command>chronyc</command> vorgenommenen Änderungen sind nicht dauerhaft. Sie gehen nach dem nächsten Neustart von <systemitem class="daemon">chronyd</systemitem> verloren. Sollen dauerhafte Änderungen erfolgen, bearbeiten Sie <filename>/etc/chrony.conf</filename>.
   </para>
  </note>

  <para>
   Eine vollständige Liste der <command>chronyc</command>-Kommandos finden Sie auf der man-Seite (<command>man 1 chronyc</command>).
  </para>
 </sect1>
 <sect1 xml:id="sec-netz-xntp-dynamic">
  <title>Dynamische Zeitsynchronisierung während der Laufzeit</title>



  <para>
   Wenn das System ohne Netzwerkverbindung startet, fährt <systemitem class="daemon">chronyd</systemitem> zwar hoch, kann jedoch nicht die DNS-Namen der in der Konfigurationsdatei festgelegten Zeitserver auflösen. Dies kann vorkommen, wenn Sie NetworkManager mit einem verschlüsselten WLAN verwenden.
  </para>

  <para>
   <systemitem class="daemon">chronyd</systemitem> versucht in immer größeren Zeitabständen, die in den <option>server</option>-, <option>pool</option>- und <option>peer</option>-Direktiven angegebenen Zeitservernamen aufzulösen, bis die Auflösung erfolgreich ist.
  </para>

  <para>
   Falls der Zeitserver beim Starten von <systemitem class="daemon">chronyd</systemitem> nicht erreichbar sein wird, können Sie die Option <option>offline</option> angeben:
  </para>

<screen>server <replaceable>server_address</replaceable> offline</screen>

  <para>
   Hiermit ruft <systemitem class="daemon">chronyd</systemitem> den Server erst nach Aktivierung mit dem folgenden Kommando ab:
  </para>

<screen><prompt role="root">root # </prompt>chronyc online <replaceable>server_address</replaceable></screen>

  <para>
   Wenn die Option <option>auto_offline</option> eingestellt ist, nimmt <systemitem class="daemon">chronyd</systemitem> an, dass der Zeitserver offline geschaltet wurde, sobald zwei Anfragen ohne Antwort gesendet wurden. Mit dieser Option müssen Sie nicht mehr das Kommando „offline“ über <command>chronyc</command> ausführen, wenn Sie die Netzwerkverbindung trennen.
  </para>
 </sect1>



 <sect1 xml:id="sec-netz-xntp-normal">
  <title>Einrichten einer lokalen Referenzuhr</title>

  <para>
   Das Software-Paket <systemitem class="resource">chrony</systemitem> greift auf andere Programme (z. B. <systemitem>gpsd</systemitem>) zurück, die die Zeitgebungsdaten über den SHM- oder SOCK-Treiber abrufen. Geben Sie mit der <option>refclock</option>-Direktive in der Datei <filename>/etc/chrony.conf</filename> eine Hardware-Referenzuhr als Zeitquelle an. Hierbei sind zwei Parameter obligatorisch, zum einen der Treibername und zum anderen ein treiberspezifischer Parameter. Nach den beiden Parameter können bei Bedarf noch <option>refclock</option>-Optionen angegeben werden. <systemitem class="daemon">chronyd</systemitem> umfasst die folgenden Treiber:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     PPS – Treiber für die Kernel-„Impuls pro Sekunde“-API. Beispiel:
    </para>
<screen>refclock PPS /dev/pps0 lock NMEA refid GPS</screen>
   </listitem>
   <listitem>
    <para>
     SHM – Treiber für den gemeinsam genutzten NTP-Speicher. Beispiel:
    </para>
<screen>refclock SHM 0 poll 3 refid GPS1
refclock SHM 1:perm=0644 refid GPS2</screen>
   </listitem>
   <listitem>
    <para>
     SOCK – Treiber für den Unix-Domänen-Socket. Beispiel:
    </para>
<screen>refclock SOCK /var/run/chrony.ttyS0.sock</screen>
   </listitem>
   <listitem>
    <para>
     PHC – Treiber für die PTP-Hardware-Uhr. Beispiel:
    </para>
<screen>refclock PHC /dev/ptp0 poll 0 dpoll -2 offset -37
refclock PHC /dev/ptp1:nocrossts poll 3 pps</screen>
   </listitem>
  </itemizedlist>

  <para>
   Weitere Informationen zu den Optionen der einzelnen Treiber finden Sie auf der man-Seite <command>man 8 chrony.conf</command>.
  </para>
 </sect1>
 <sect1 xml:id="sec-netz-xntp-etr" arch="zseries">
  <title>Uhrensynchronisierung mit einer externen Zeitreferenz (ETR)</title>



  <para>
   Unterstützung für Uhrensynchronisierung mit einer externen Zeitreferenz (ETR) ist verfügbar. Die externe Zeitreferenz sendet alle 2**20 (2 hoch 20) Millisekunden ein Oszillatorsignal und ein Synchronisierungssignal, um die Tageszeit-Uhren aller angeschlossenen Server synchron zu halten.
  </para>

  <para>
   Zur Verfügbarkeit können zwei ETR-Einheiten an einen Computer angeschlossen werden. Wenn die Uhr um mehr als die Toleranz zum Prüfen der Synchronisierung abweicht, erhalten alle CPUs eine Rechnerprüfung, die darauf hinweist, dass die Uhr nicht synchronisiert ist. In diesem Fall werden sämtliche DASD-E/A an XRC-fähige Geräte gestoppt, bis die Uhr wieder synchron ist.
  </para>

  <para>
   Die ETR-Unterstützung wird mithilfe von zwei <literal>sysfs</literal>-Attributen aktiviert; führen Sie die folgenden Kommandos als <systemitem class="username">root</systemitem> aus:
  </para>

<screen>echo 1 &gt; /sys/devices/system/etr/etr0/online
echo 1 &gt; /sys/devices/system/etr/etr1/online
</screen>
 </sect1>
</chapter>
