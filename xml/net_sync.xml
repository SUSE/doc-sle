<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter
[
  <!ENTITY % entities SYSTEM "entity-decl.ent">
    %entities;
]>
<!-- Converted by suse-upgrade version 1.1 -->
<!--
  TODO for 11.2: Maybe add csync utility into this chapter?

  Add section about csync (http://www.csync.org) from Andreas Schneider (anschneider)
  First announced at opensuse-announce mailinglist 08. January 2008 by Zonker.

  From the announcement:
  »[...] As mobile computing becomes more and more important, file
  synchronization is more important than ever. Our jobs often require
  working not only on multiple computers, but in multiple locations, and
  disconnected from our networks. To help solve this problem, we need
  effective strategies for replication of user data and files.

  csync is a bidirectional file synchronizer for Linux and allows to
  keep two copies of files and directories in sync. It uses uses widely
  adopted protocols like smb or sftp so that there is no need for a
  server component of csync. It is a user-level program which means
  there is no need to be a superuser. With pam_csync it is possible to
  create roaming home directories.
  [...]«

-->
<chapter version="5.0" xml:id="cha.net.sync"
 xmlns="http://docbook.org/ns/docbook"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink">
 <title>File Copying with RSync</title>
 <info>
  <abstract>
   <para>
    These days, many people use several computers&mdash;one computer at home,
    one or several computers at the workplace, and possibly a laptop, tablet,
    or a smartphone on the road. Many files are needed on all these computers.
    You should be able to work with all computers and modify the files so that
    you have the latest version of the data available on all computers.
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker></dm:bugtracker>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>

 <!--<sect1 xml:id="sec.net.sync.soft">
  <title>Available Data Synchronization Software</title>

  <para>
   Data synchronization is no problem for computers that are permanently linked
   by means of a fast network. In this case, use a network file system, like
   NFS, and store the files on a server, enabling all hosts to access the same
   data via the network. This approach is impossible if the network connection
   is poor or not permanent. When you are on the road with a laptop, copies of
   all needed files must be on the local hard disk. However, it is then
   necessary to synchronize modified files. When you modify a file on one
   computer, make sure a copy of the file is updated on all other computers.
   For occasional copies, this can be done manually with <command>scp</command>
   or <command>rsync</command>. However,
   if many files are involved, the procedure can be complicated and requires
   great care to avoid errors, such as overwriting a new file with an old file.
  </para>

  <para>
   The time-consuming and error-prone task of manually synchronizing data can
   be avoided by using one of the programs that use various methods to automate
   this job. The following summaries are merely intended to convey a general
   understanding of how these programs work and how they can be used. If you
   plan to use them, read the program documentation.
  </para>

  <!-\-<para>
<!-\\- http://doccomments.provo.novell.com/comments/28800 -\\->
   These days file synchronization can also be done with a cloud computing
   solution.
  </para>-\->
 </sect1>-->
 <warning>
  <title>Risk of Data Loss</title>
  <para>
   Before you start using a synchronization tool, you
   should familiarize yourself with with its features and functionality.
   Make sure to back up your important files.
  </para>
 </warning>

 <sect1 xml:id="sec.net.sync.rsync">
  <title>Conceptual Overview</title>
  <para>
    For synchronizing a large amount of data over a slow network connection,
    Rsync offers a reliable method of transmitting only changes within files.
    This applies not only to text files but also binary files.
    To detect the
    differences between files, Rsync subdivides the files into blocks and
    computes check sums over them.
   </para>
   <para>
    Detecting changes requires some computing power. So make sure that that
    machines on both ends have enough resources, including RAM.
   </para>
  <para>
   Rsync can be particularly useful when large amounts of data containing only
   minor changes need to be transmitted regularly. This is often the case when
   working with backups. Rsync can also be useful for mirroring staging
   servers that store complete directory trees of Web servers to a web server
   in a DMZ.
  </para>
  <para>
   Despite its name, Rsync is not a synchronization tool. Rsync is a tool that
   copies data only in one direction at a time. It
   does not and cannot do the reverse. If you need a bidirectional tool which
   is able to synchronize both source and destination, use Csync.
  </para>
  <!-- Use cases and properties of Rsync? -->
 </sect1>

  <sect1 xml:id="sec.net.sync.rsync.syntax">
   <title>Basic Syntax</title>
   <para>
    Rsync is a command-line tool that has the following basic syntax:
   </para>
   <screen>rsync [OPTION] SOURCE [SOURCE]... DEST</screen>
   <para>
    You can use Rsync on any local or remote machine, provided you have
    access and writing permissions. It is possible to have multiple
    <replaceable>SOURCE</replaceable> entries. The <replaceable>SOURCE</replaceable> and
     <replaceable>DEST</replaceable> placeholders can be paths, URLs, or both.
   </para>
   <para>
    Below are the most common Rsync options:
   </para>
   <variablelist>
    <varlistentry>
     <term><option>-v</option></term>
     <listitem>
      <para> Outputs more verbose text</para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>-a</option></term>
     <listitem>
      <para> Archive mode; copy files recursively and preserve timestamps,
       user/group ownership, file permissions, and symbolic links. </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>-z</option></term>
     <listitem>
      <para>Compress the transmitted data</para>
     </listitem>
    </varlistentry>
   </variablelist>
   <note>
    <title>Trailing Slashes Count</title>
    <para>
     When working with Rsync, you should pay particular attention to trailing
     slashes. A trailing slash after the directory denotes the
     <emphasis>content</emphasis> of the directory. No trailing slash denotes
     the <emphasis>directory itself</emphasis>.
   </para>
   </note>
  </sect1>

  <sect1 xml:id="sec.net.sync.rsync.copy.local.files-and-dirs">
   <title>Copying Files and Directories Locally</title>
   <para>
    The following description assumes that the current user has write
    permissions to the directory <filename>/var/backup</filename>.
    To copy a single file from one directory on your machine to another path,
    use the following command: </para>
   <screen>&prompt.user;<command>rsync</command> -avz backup.tar.xz /var/backup/</screen>
   <para>The file <filename>backup.tar.xz</filename> is copied to
     <filename>/var/backup/</filename>, the absolute path will be
     <filename>/var/backup/backup.tar.xz</filename>.</para>
   <para>
    Do not forget to add the <emphasis>trailing slash</emphasis> after the
    <filename>/var/backup/</filename> directory! If you do not insert the slash,
    the file <filename>backup.tar.xz</filename> is copied to <filename>/var/backup</filename>
    (file) <emphasis>not</emphasis> inside the directory <filename>/var/backup/</filename>!
   </para>
   <para>
    Copying a directory is similar to copying a single file. The following
    example copies the directory <filename>&exampleuser_plain;/</filename> and
    its content into the directory <filename>/var/backup/</filename>: </para>
    <screen>&prompt.user;<command>rsync</command> -avz &exampleuser_plain; /var/backup/</screen>
    <para> Find the copy in the absolute path
     <filename>/var/backup/&exampleuser_plain;/</filename>. </para>
  </sect1>

  <sect1 xml:id="sec.net.sync.rsync.copy.remote.files-and-dirs">
   <title>Copying Files and Directories Remotely</title>
   <para>
    The Rsync tool is required on both machines.
    To copy files from or to remote directories requires an IP address or
    a domain name. A user name can be optional in case your current user names
    on the local and remote machine are the same.
   </para>
   <para> To copy the file <filename>file.tar.xz</filename> from your local
    host to the remote host <systemitem
     class="ipaddress">&exampledomain1ip;.1</systemitem> with same users (being
    local and remote), use the following command:
   </para>
   <screen>&prompt.user;<command>rsync</command> -avz file.tar.xz  &exampleuser_plain;@&exampledomain1ip;.1:</screen>
    <para> Depending on what you prefer, these commands are also possible and
    equivalent: </para>
   <screen>&prompt.user;<command>rsync</command> -avz file.tar.xz &exampledomain1ip;.1:~
&prompt.user;<command>rsync</command> -avz file.tar.xz &exampledomain1ip;.1:/home/&exampleuser_plain;</screen>
    <para> In all cases with standard configuration, you will be prompted to
     enter your passphrase of the remote user. This command will copy the
     <filename>file.tar.xz</filename> to the home directory of user
     &exampleuser; (usually <filename>/home/&exampleuser_plain;</filename>).
    </para>
   <para>
    Copying a directory remotely is similar to copying a directory locally.
    The following example copies the directory <filename>&exampleuser_plain;/</filename> and
    its content into the remote directory <filename>/var/backup/</filename> on
    the <systemitem class="ipaddress">&exampledomain1ip;.1</systemitem> host:
   </para>
   <screen>&prompt.user;<command>rsync</command> -avz &exampleuser_plain; &exampledomain1ip;.1:/var/backup/</screen>
   <para>
    Assuming you have write permissions on the host <systemitem class="ipaddress">&exampledomain1ip;.1</systemitem>, you will find the
    copy in the absolute path <filename>/var/backup/&exampleuser_plain;</filename>.
   </para>
  </sect1>

  <sect1 xml:id="sec.net.sync.rsync.server">
   <title>Configuring and Using an Rsync Server</title>
   <para>
    Rsync can run as a daemon (<systemitem class="daemon"
     >rsyncd</systemitem>) listing on default port 873 for incoming
    connections. This daemon can receive <quote>copying targets</quote>.
   </para>
   <para>
    The following description explains how to create an Rsync server on
    <systemitem>&wsI;</systemitem> with a <emphasis>backup</emphasis> target.
    This target can be used to store your backups. To create a Rsync server,
    do the following:
   </para>
   <procedure>
    <title>Setting Up an Rsync Server</title>
    <step xml:id="st.rsync.server.mkdir">
     <para>
      On &wsI;, create a directory to store all your backup files.
      In this example, we use <filename>/var/backup</filename>:
     </para>
     <screen>&prompt.root;<command>mkdir</command> /var/backup</screen>
    </step>
    <step>
     <para>Specify ownership. In this case, the directory is owned by
      user &exampleuser; in group <systemitem class="groupname"
       >users</systemitem>:</para>
     <screen>&prompt.root;<command>chown</command> &exampleuser_plain;.users /var/backup</screen>
    </step>
    <step>
     <para>Configure the rsyncd daemon.</para>
     <para>We will separate the configuration file into a main file and some
       <quote>modules</quote> which holds your backup target. This makes it
      easier to add additional targets later. Global values can be stored in
       <filename>/etc/rsyncd.d/*.inc</filename> files, whereas your modules are
      placed in <filename>/etc/rsyncd.d/*.conf</filename> files: </para>
     <substeps>
      <step>
       <para>Create a directory <filename>/etc/rsyncd.d/</filename>:</para>
       <screen>&prompt.root;<command>mkdir</command> /etc/rsyncd.d/</screen>
      </step>
      <step>
       <para>
        In the main configuration file <filename>/etc/rsyncd.conf</filename>,
        add the following lines:
       </para>
       <screen># rsyncd.conf main configuration file
log file = /var/log/rsync.log
pid file = /var/lock/rsync.lock

&amp;merge /etc/rsyncd.d <co xml:id="co.rsync.conf.merge"/>
&amp;include /etc/rsyncd.d <co xml:id="co.rsync.conf.include"/></screen>
       <calloutlist>
        <callout arearefs="co.rsync.conf.merge">
         <para> Merge global values from
           <filename>/etc/rsyncd.d/*.inc</filename> files into the main
          configuration file. </para>
        </callout>
        <callout arearefs="co.rsync.conf.include">
         <para> Loads any modules (or targets) from
           <filename>/etc/rsyncd.d/*.conf</filename> files. These files should
          not contain any references to global values. </para>
        </callout>
       </calloutlist>
      </step>
      <step>
       <para> Create your module (your backup target) in the file
         <filename>/etc/rsyncd.d/backup.conf</filename> with the following
        lines: </para>
       <screen># backup.conf: backup module
[backup] <co xml:id="co.rsync.conf.target"/>
   uid = &exampleuser_plain; <co xml:id="co.rsync.conf.uid-gid"/>
   gid = users <xref linkend="co.rsync.conf.uid-gid"/>
   path = /var/backup <co xml:id="co.rsync.conf.path"/>
   auth users = &exampleuser_plain;  <co xml:id="co.rsync.conf.authusers"/>
   secrets file = /etc/rsyncd.secrets <co xml:id="co.rsync.conf.secretfiles"/>
   comment = Our backup target</screen>
       <calloutlist>
        <!--<callout arearefs="co.rsync.conf.usechroot">
         <para>
          Set protection against security holes. Before starting the transfer,
          the Rsync daemon will change to this path (<quote>change root</quote>).
         </para>
        </callout>-->
        <!--<callout arearefs="co.rsync.conf.logging">
         <para>
          Enables logging and store it in <filename>/var/log/rsyncd.log</filename>
          with the format of <varname>log&nbsp;format</varname>.
         </para>
        </callout>-->
        <callout arearefs="co.rsync.conf.target">
         <para>
          The <emphasis>backup</emphasis> target. You can use any name you
          like. However, it is a good idea to name a target according to its
          purpose and use the same name in your <filename>*.conf</filename>
          file.
         </para>
        </callout>
        <callout arearefs="co.rsync.conf.uid-gid">
         <para>
          Specifies the user name or group name that is used when the file
          transfer takes place.
         </para>
        </callout>
        <callout arearefs="co.rsync.conf.path">
         <para>
          Defines the path to store your backups (from <xref linkend="st.rsync.server.mkdir"/>).
         </para>
        </callout>
        <callout arearefs="co.rsync.conf.authusers">
         <para>
          Specifies a comma-separated list of allowed users. In its simplest
          form, it contains the user names that are allowed to connect to this
          module. In our case, only user &exampleuser; is allowed.
         </para>
        </callout>
        <callout arearefs="co.rsync.conf.secretfiles">
         <para>
          Specifies the path of a file that contains lines with user names
          and plain passwords.
         </para>
        </callout>
       </calloutlist>
      </step>
      <step>
       <para>
        Create the <filename>/etc/rsyncd.secrets</filename> file with the
        following content and replace <replaceable>PASSPHRASE</replaceable>:
       </para>
       <screen># user:passwd
&exampleuser_plain;:<replaceable>PASSPHRASE</replaceable></screen>
      </step>
      <step>
       <para>
        Make sure the file is only readable by &rootuser;:
       </para>
       <screen>&prompt.root;<command>chmod</command> 0600 /etc/rsyncd.secrets</screen>
      </step>
     </substeps>

     <!--<screen># rsyncd.conf configuration file
use chroot = true <co xml:id="co.rsync.conf.usechroot"/>
transfer logging = true <co xml:id="co.rsync.conf.logging"/>
log format = %h %o %f %l %b <xref linkend="co.rsync.conf.logging"/>
log file = /var/log/rsyncd.log <xref linkend="co.rsync.conf.logging"/>

[backup] <co xml:id="co.rsync.conf.target"/>
   uid = &exampleuser_plain; <co xml:id="co.rsync.conf.uid-gid"/>
   gid = users <xref linkend="co.rsync.conf.uid-gid"/>
   path = /var/backup <co xml:id="co.rsync.conf.path"/>
   auth users = &exampleuser_plain;  <co xml:id="co.rsync.conf.authusers"/>
   secret files = /etc/rsyncd.secrets <co xml:id="co.rsync.conf.secretfiles"/>
   comment = Our backup target</screen>-->
    </step>
    <step>
     <para>
      Start and enable the rsyncd daemon with:
     </para>
     <screen>&prompt.root;<command>systemctl</command> enable rsyncd
&prompt.root;<command>systemctl</command> start rsyncd</screen>
     <!--<para>
      <remark>taroth 2014-02-25: systemd - what about xinetd? is this
    still valid?</remark> - taroth 2014-03-17: for the records, here fcrozat's
    answer: xinetd is still there (although systemd can provide similar  functionalities
    but the configuration is different)
      rsyncd can alternatively be started by xinetd. This is, however, only
      recommended for servers that rarely use rsyncd.
     </para> -->
    </step>
    <step>
     <para>
      Test the access to your Rsync server:
     </para>
     <screen>&prompt.user;<command>rsync</command> &wsI;::</screen>
     <para>
      You should see a response that looks like follows:
     </para>
     <screen>backup          Our backup target</screen>
     <para>Otherwise, check your configuration file, firewall and network settings.</para>
    </step>
   </procedure>
   <para>
    The above steps create a Rsync server that can now be used to store
    backups.
    The example also creates a log file listing all connections. This file is
    stored in <filename>/var/log/rsyncd.log</filename>. This is useful if you
    want to debug your transfers.
   </para>
   <para>
    To list the content of your backup target, use the following command:
   </para>
<screen>rsync -avz &wsI;::backup</screen>
   <para>
    This command lists all files present in the directory
    <filename>/var/backup</filename> on the server. This request is also logged in
    the log file <filename>/var/log/rsyncd.log</filename>. To start an actual
    transfer, provide a source directory. Use <literal>.</literal> for the
    current directory. For example, the following command copies the current
    directory to your Rsync backup server:
   </para>
   <screen>rsync -avz . &wsI;::backup</screen>
   <para>
    By default, Rsync does not delete files and directories when it runs.
    To enable deletion, the additional option <option>--delete</option> must be
    stated. To ensure that no newer files are deleted, the option
    <option>--update</option> can be used instead. Any conflicts that arise
    must be resolved manually.
   </para>
  </sect1>

 <sect1 xml:id="sec.net.sync.summary">
  <title>For More Information</title>
  <variablelist>
   <varlistentry>
    <term>CSync</term>
    <listitem>
     <para>Bidirectional file synchronizer, see <link xlink:href="https://www.csync.org/"/>.</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>RSnapshot</term>
    <listitem>
     <para>Does create incremental backups, see <link xlink:href="http://rsnapshot.org"/>.</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Unison</term>
    <listitem>
     <para>It is a file synchronizer similar to CSync but with a graphical
      interface, see <link
      xlink:href="http://www.seas.upenn.edu/~bcpierce/unison/"/>.</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Rear</term>
    <listitem>
     <para>A disaster recovery framework, see the <citetitle>Administration
      Guide</citetitle> of the &sle; &hasi; <link
       xlink:href="https://www.suse.com/documentation/sle-ha-12/"/>.</para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
</chapter>
