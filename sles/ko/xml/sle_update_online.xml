<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_online.xml" version="5.0" xml:id="cha.update.online">
 <title>온라인 업그레이드</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>예</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    SUSE는 실행 중인 시스템을 새로운 서비스 팩으로 업그레이드하기 위한 직관적인 그래픽과 간단한 명령줄 도구를 제공합니다. 서비스 팩 <quote>롤백</quote> 등도 지원합니다. 이 장에서는 이러한 도구를 사용하여 서비스 팩 업그레이드를 수행하는 방법을 단계별로 설명합니다.
   </para>
  </abstract>
 </info>
 <sect1 xml:id="sec.update.migr.conceptual-overview">
  <title>개념 개요</title>

  <para>
   SUSE는 정기적으로 SUSE Linux Enterprise 제품군을 위한 새로운 서비스 팩을 공개합니다. 고객이 쉽게 새로운 서비스 팩으로 마이그레이션하고 작동 중지 시간을 최소화할 수 있도록 시스템 가동 중에 온라인 마이그레이션을 지원합니다.
  </para>

  <para>
   SLE 12 부터 YaST Wagon이 YaST 마이그레이션(GUI)과 Zypper 마이그레이션(명령줄)으로 대체되었습니다. 다음 기능이 지원됩니다.
  </para>

  <itemizedlist>
   <listitem>
    <para>
     첫 번째 RPM을 업데이트할 때까지 시스템이 항상 정의된 상태를 유지
    </para>
   </listitem>
   <listitem>
    <para>
     첫 번째 RPM을 업데이트할 때까지는 취소 가능
    </para>
   </listitem>
   <listitem>
    <para>
     오류 발생 시 간단하게 복구
    </para>
   </listitem>
   <listitem>
    <para>
     시스템 도구를 통한 <quote>롤백</quote>, 백업/복원 필요 없음
    </para>
   </listitem>
   <listitem>
    <para>
     모든 활성 리포지토리 사용
    </para>
   </listitem>
   <listitem>
    <para>
     서비스 팩을 건너뛰는 기능
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.workflow">
  <title>서비스 팩 마이그레이션 워크플로</title>

  <para>
   서비스 팩 마이그레이션은 YaST, <command>zypper</command>, 또는 AutoYaST로 실행할 수 있습니다.
  </para>

  <para>
   서비스 팩 마이그레이션을 시작하려면 먼저 SUSE Customer Center나 로컬 SMT 서버에서 시스템을 등록해야 합니다. SUSE Manager를 사용할 수도 있습니다.
  </para>

  <para>
   방법에 관계없이 서비스 팩 마이그레이션은 다음 단계로 구성됩니다.
  </para>

  <orderedlist>
   <listitem>
    <para>
     등록된 시스템에서 가능한 마이그레이션 대상을 찾습니다.
    </para>
   </listitem>
   <listitem>
    <para>
     하나의 마이그레이션 대상을 선택합니다.
    </para>
   </listitem>
   <listitem>
    <para>
     새 리포지토리를 요청하고 활성화합니다.
    </para>
   </listitem>
   <listitem>
    <para>
     마이그레이션을 실행합니다.
    </para>
   </listitem>
  </orderedlist>



  <para>
   마이그레이션 대상 목록은 설치 및 등록한 제품에 따라 다릅니다. 새 SP를 아직 사용할 수 없는 확장을 설치한 경우 마이그레이션 대상이 제공되지 않을 수 있습니다.
  </para>

  <para>
   호스트에서 사용 가능한 마이그레이션 대상 목록은 항상 SUSE 고객 센터에서 검색되며, 설치된 제품 또는 확장에 따라 달라집니다.
  </para>
 </sect1>
 <sect1 xml:id="sec.update.migr.cancel.spm">
  <title>서비스 팩 마이그레이션 취소</title>

  <para>
   서비스 팩 마이그레이션은 마이그레이션 프로세스 중 특정 단계에서만 취소할 수 있습니다.
  </para>

  <orderedlist>
   <listitem>
    <para>
     패키지 업그레이드를 시작하기 전에는 서비스, 리포지토리 등 시스템 변경이 최소화됩니다. <filename>/etc/zypp/repos.d/*</filename>를 복구하여 이전 상태로 돌아갑니다.
    </para>
   </listitem>
   <listitem>
    <para>
     패키지 업그레이드 시작 후에는 스냅퍼 스냅샷을 사용하여 이전 상태로 돌아갈 수 있습니다(<xref linkend="cha.snapper"/> 참조).
    </para>
   </listitem>
   <listitem>
    <para>
     마이그레이션 대상을 선택하면 SUSE 고객 센터에서 리포지토리 데이터를 변경합니다. 이 상태를 수동으로 되돌리려면 <command>SUSEConnect</command>
     <option> --rollback</option>을 사용하십시오.
    </para>
   </listitem>
  </orderedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.yast.onlinemigr">
  <title>온라인 마이그레이션 도구(YaST)를 통한 업그레이드</title>

  <para>
   YaST를 사용하여 서비스 팩 마이그레이션을 수행하려면 <guimenu>온라인 마이그레이션</guimenu> 도구를 사용하십시오. 기본적으로 YaST는 타사 리포지토리에서 패키지를 설치하지 않습니다. 타사 리포지토리에서 패키지가 설치된 경우 YaST는 패키지가 SUSE에서 가져오는 동일한 패키지로 바뀌지 않도록 방지합니다.
  </para>

  <note>
   <title>설치 크기 줄이기 </title>
   <para>
    SIP 마이그레이션을 수행할 때 YaST는 모든 권장 패키지를 설치합니다. 따라서 특히 사용자 정의 최소 설치의 경우 시스템의 설치 크기가 상당히 증가할 수 있습니다.
   </para>
   <para>
    이 기본 동작을 변경하고 필요한 패키지만 허용하려면 <filename>/etc/zypp/zypp.conf</filename>를 조정하고 다음 변수를 설정하십시오.
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   그러면 모든 패키지 작업의 동작이 변경됩니다(예: 패치 또는 새로운 패키지의 설치).
  </para>

  <para>
   서비스 팩 마이그레이션을 시작하려면 다음을 수행하십시오.
  </para>

  <procedure xml:id="pro.update.migr.yast">
   <step>
    <para>
     향후 종속성 충돌을 방지하기 위해 등록 서버에서 사용되지 않는 확장을 모두 비활성화합니다. 확장을 기억하지 못하는 경우 YaST에서 나중에 사용되지 않는 확장 리포지토리를 검색하고 비활성화합니다.
    </para>
   </step>
   <step>
    <para>
     업데이트할 시스템에서 실행 중인 GNOME 세션에 로그인한 경우 텍스트 콘솔로 전환합니다. GNOME 세션에서 업데이트를 실행하지 않는 것이 좋습니다. 원격 시스템에서 로그인한 경우에는 이 내용이 적용되지 않습니다(GNOME과 함께 VNC 세션을 실행 중인 경우 제외).
    </para>
   </step>
   <step>
    <para>
     LTSS 가입자인 경우 LTSS 확장 리포지토리가 활성화되어 있는지 확인하십시오.
    </para>
   </step>
   <step>
    <para>
     YaST 온라인 업데이트를 실행하여 시스템을 위한 최신 패키지 업데이트를 받습니다.
    </para>
   </step>
   <step>
    <para>
     yast2-migration
     <package>패키지 및</package>
     종속 항목을 설치합니다(YaST 에서 <menuchoice>
     <guimenu> 소프트웨어</guimenu> <guimenu> 소프트웨어 관리</guimenu>
     </menuchoice> 아래).
    </para>
   </step>
   <step>
    <para>
     YaST를 재시작합니다. 그렇지 않으면 새로 설치한 모듈이 관리 센터에 표시되지 않습니다.
    </para>
   </step>
   <step>
    <para>
     YaST <menuchoice> <guimenu> 시스템</guimenu> <guimenu> 온라인 마이그레이션</guimenu> </menuchoice> 에서 시작합니다. 가능한 마이그레이션 대상 및 요약이 표시됩니다. 시스템에서 마이그레이션 대상을 둘 이상 사용할 수 있는 경우 목록에서 하나를 선택합니다.
    </para>
   </step>
   <step>
    <para>
     목록에서 마이그레이션 대상을 하나 선택하고 <guimenu>다음</guimenu>을 선택하여 계속 진행합니다.
    </para>
   </step>
   <step>
    <para>
     마이그레이션 도구가 업데이트 리포지토리를 제공할 경우 <guimenu>예</guimenu>를 선택하여 진행하는 것이 좋습니다.
    </para>
   </step>
   <step>
    <para>
     <remark>toms 2015-09-09: FATE#319140</remark> 온라인 마이그레이션 도구가 DVD 또는 로컬 서버에서 구식 리포지토리를 찾는 경우 해당 리포지토리를 비활성화하는 것이 좋습니다. 구식 리포지토리는 이전 SP에서 온 것입니다. SCC 또는 SMT의 오래된 리포지토리는 자동으로 제거됩니다.
    </para>
   </step>
   <step>
    <para>
     요약을 확인하고 <guimenu>[다음]</guimenu>을 눌러 마이그레이션을 계속합니다. <guimenu>업데이트 시작</guimenu>을 눌러 확인합니다.
    </para>
    <remark>toms 2016-07-13: What to do in case of problems?</remark>
   </step>
   <step>
    <para>
     마이그레이션이 끝나면 시스템을 재시작합니다.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.zypper.onlinemigr">
  <title>Zypper로 업그레이드</title>

  <para>
   Zypper를 사용하여 서비스 팩 마이그레이션을 수행하려면 명령줄 도구 <command>zypper</command> <option> migration</option>을 사용합니다.
  </para>

  <note>
   <title>설치 크기 줄이기 </title>
   <para>
    SIP 마이그레이션을 수행할 때 YaST는 모든 권장 패키지를 설치합니다. 따라서 특히 사용자 정의 최소 설치의 경우 시스템의 설치 크기가 상당히 증가할 수 있습니다.
   </para>
   <para>
    이 기본 동작을 변경하고 필요한 패키지만 허용하려면 <filename>/etc/zypp/zypp.conf</filename>를 조정하고 다음 변수를 설정하십시오.
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   그러면 모든 패키지 작업의 동작이 변경됩니다(예: 패치 또는 새로운 패키지의 설치). 단일 호출에 대한 Zypper의 동작을 변경하려면 명령줄에 <option>--no-recommends</option> 파라미터를 추가합니다.
  </para>

  <para>
   서비스 팩 마이그레이션을 시작하려면 다음을 수행하십시오.
  </para>

  <procedure xml:id="pro.update.migr.zypper">
   <step>
    <para>
     업데이트할 시스템에서 실행 중인 GNOME 세션에 로그인한 경우 텍스트 콘솔로 전환합니다. GNOME 세션에서 업데이트를 실행하지 않는 것이 좋습니다. 원격 시스템에서 로그인한 경우에는 이 내용이 적용되지 않습니다(GNOME과 함께 VNC 세션을 실행 중인 경우 제외).
    </para>
   </step>
   <step>
    <para>
     SUSE Linux Enterprise 시스템을 아직 등록하지 않았다면 지금 등록합니다.
    </para>
<screen>sudo <command>SUSEConnect</command> --regcode <replaceable>YOUR_REGISTRATION_CODE</replaceable></screen>
   </step>
   <step>
    <para>
     LTSS 가입자인 경우 LTSS 확장 리포지토리가 활성화되어 있는지 확인하십시오.
    </para>
   </step>
   <step>
    <para>
     최신 업데이트를 설치합니다:
    </para>
<screen>sudo <command>zypper</command> patch</screen>
   </step>
   <step>
    <para>
     즉, <package>zypper-migration-plugin</package> 패키지와 종속성을 설치합니다.
    </para>
<screen>sudo <command>zypper</command> in zypper-migration-plugin</screen>
   </step>
   <step>
    <para>
     <command>zypper</command> <option> migration</option>을 실행합니다.
    </para>
<screen><prompt>tux &gt; </prompt>sudo <command>zypper</command> migration
Executing 'zypper  patch-check'

Refreshing service 'SUSE_Linux_Enterprise_Server_12_x86_64'.
Loading repository data...
Reading installed packages...
0 patches needed (0 security patches)

Available migrations:

    1 | SUSE Linux Enterprise Server 12 SP1 x86_64
    2 | SUSE Linux Enterprise Server 12 SP2 x86_64</screen>
    <para>
     마이그레이션 프로세스에 대한 몇 가지 참고 사항:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       시스템에서 마이그레이션 대상을 둘 이상 사용할 수 있는 경우 목록에서 SP를 하나 선택할 수 있습니다. 이는 하나 이상의 SP를 건너뛰는 것과 같습니다. 기본 제품(SLES, SLED)에 대한 온라인 마이그레이션은 주요 버전의 SP 사이에서만 가능합니다. 
      </para>
     </listitem>
     <listitem>
      <para>
       기본적으로 Zypper는 <option>zypper</option> dup<command>로 전달되는 </command> <option>--no-allow-vendor-change</option> 옵션을 사용합니다. 타사 리포지토리에서 패키지가 설치된 경우 이 옵션은 패키지가 SUSE에서 가져오는 동일한 패키지로 바뀌지 않도록 방지합니다.
      </para>
     </listitem>
     <listitem>
      <para>
       <remark>toms 2015-09-09: FATE#319140</remark> Zypper가 DVD 또는 로컬 서버에서 구식 리포지토리를 찾는 경우 해당 리포지토리를 비활성화하는 것이 좋습니다. 오래된 SCC 또는 SMT 리포지토리는 자동으로 제거됩니다.
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     모든 변경 사항 특히, 제거될 패키지를 검토합니다. <literal>y</literal>를 입력하여 계속합니다(업그레이드할 정확한 패키지 수는 시스템에 따라 다를 수 있음).
    </para>
<screen>266 packages to upgrade, 54 to downgrade, 17 new, 8 to reinstall, 5 to remove, 1 to change arch.
Overall download size: 285.1 MiB. Already cached: 0 B  After the operation, additional 139.8 MiB will be used.
Continue? [y/n/? shows all options] (y):</screen>
    <para>
     셸에서 스크롤하려면 <keycombo> <keycap function="shift"/> <keycap function="pageup"/>
     </keycombo>    또는 <keycombo> <keycap function="shift"/>
     <keycap function="pagedown"/> </keycombo>    키를 사용합니다.
    </para>
   </step>
   <step>
    <para>
     마이그레이션이 끝나면 시스템을 재시작합니다.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.plainzypper.onlinemigr">
  <title>일반 Zypper로 업그레이드</title>

  <para>
   YaST 마이그레이션 또는 Zypper 마이그레이션을 사용할 수 없어도 일반 Zypper 및 몇 가지 수동 작업을 사용하여 마이그레이션할 수 있습니다. 서비스 팩 마이그레이션을 시작하려면 다음을 수행하십시오.
  </para>

  <procedure>
   <step>
    <para>
     업데이트할 시스템에서 실행 중인 GNOME 세션에 로그인한 경우 텍스트 콘솔로 전환합니다. GNOME 세션에서 업데이트를 실행하지 않는 것이 좋습니다. 원격 시스템에서 로그인한 경우에는 이 내용이 적용되지 않습니다(GNOME과 함께 VNC 세션을 실행 중인 경우 제외).
    </para>
   </step>
   <step>
    <para>
     이전 SUSE Linux Enterprise 리포지토리를 사용하여 패키지 관리 도구를 업데이트합니다.
    </para>
<screen>sudo <command>zypper</command> patch --updatestack-only</screen>
   </step>
   <step>
    <para>
     시스템이 등록된 경우 등록을 해제해야 합니다.
    </para>
<screen>sudo <command>SUSEConnect</command> --de-register</screen>
   </step>
   <step>
    <para>
     이전 설치 원본과 리포지토리를 제거하고 타사 리포지토리를 조정합니다.
    </para>
   </step>
   <step>
    <para>
     로컬 또는 원격 원본인 새로운 설치 원본을 추가합니다(<replaceable>REPOSITORY</replaceable>자리 표시자는 <xref linkend="sec.update.nmm.repositories"/>를 참조하십시오.):
    </para>
<screen>sudo <command>zypper</command> addrepo <replaceable>REPOSITORY</replaceable></screen>
    <para>
     SUSE 고객 센터나 구독 관리 도구를 사용할 수도 있습니다. x86-64에서 SUSE Linux Enterprise 12 SP1을 위한 명령은 다음과 같습니다.
    </para>
<screen>sudo <command>SUSEConnect</command> -p SLES/12.2/x86_64 <replaceable>OPTIONS</replaceable></screen>
    <para>
     아키텍처 간 업그레이드는 지원되지 않습니다.
    </para>
    <para>
     Zypper에서 이전 커널과 새 커널 간 충돌을 표시합니다. 계속하려면 솔루션 1을 선택합니다.
    </para>
<screen>Problem: product:SLES-12.2-0.x86_64 conflicts with kernel &lt; 4.4 provided by kernel-default-<replaceable>version</replaceable>
 Solution 1: Following actions will be done:
  replacement of kernel-default-<replaceable>version</replaceable> with kernel-default-<replaceable>version</replaceable>
  deinstallation of kernel-default-<replaceable>version</replaceable>
 Solution 2: do not install product:SLES-12.2-0.x86_64
</screen>
   </step>
   <step>
    <para>
     마이그레이션을 마무리합니다.
    </para>
<screen>sudo <command>zypper</command> ref -f -s
sudo <command>zypper</command> dup --no-allow-vendor-change --no-recommends</screen>
    <para>
     첫 번째 명령은 모든 서비스 및 리포지토리를 업데이트합니다. 두 번째 명령은 배포 업그레이드를 수행합니다. 여기서 마지막 두 옵션이 중요합니다. <option>-no-allow-vendor-change</option>는 타사 RPM이 기본 시스템의 RPM을 덮어쓰지 않도록 합니다. <option>--no-recommends</option> 옵션은 초기 설치 중 선택 취소된 패키지가 다시 추가되지 않도록 합니다.
    </para>
   </step>
  </procedure>
 </sect1>



 <sect1 xml:id="sec.update.migr.rollback">
  <title>서비스 팩 롤백</title>

  <para>
   서비스 팩이 작동하지 않을 경우 SUSE Linux Enterprise에서는 서비스 팩 마이그레이션이 시작되기 이전 상태로 시스템을 되돌릴 수 있습니다. 이를 위해서는 스냅샷을 활성화한 Btrfs 루트 파티션(SLES 12를 설치할 경우 기본값)이 필요합니다. 자세한 내용은 <xref linkend="cha.snapper"/>를 참조하십시오.
  </para>

  <procedure xml:id="pro.update.migr.rollback">
   <step>
    <para>
     모든 스냅퍼 스냅샷 목록을 가져옵니다.
    </para>
    <screen>sudo snapper list</screen>
    <para>
     출력을 검토하여 서비스 팩 마이그레이션이 시작되기 직전에 생성된 스냅샷을 찾습니다. <guimenu>설명</guimenu> 열에 해당하는 설명이 포함되어 있고 스냅샷은 <guimenu>사용자 데이터</guimenu> 열에서 <literal>중요</literal>로 표시되어 있습니다. <guimenu>#</guimenu> 열의 스냅샷 번호와 <guimenu>날짜</guimenu> 열의 날짜를 기록해 둡니다.
    </para>
   </step>
   <step>
    <para>
     시스템을 재부팅합니다. 부팅 메뉴에서 <guimenu>읽기 전용 스냅샷에서 부트 로더 시작</guimenu>을 선택하고 이전 단계에서 기록해 둔 날짜와 번호의 스냅샷을 선택합니다. 두 번째 부팅 메뉴(스냅샷의 메뉴)가 로드됩니다. <literal>SLES 12</literal>로 시작하는 항목을 선택하여 부팅합니다.
    </para>
   </step>
   <step>
    <para>
     시스템이 시스템 파티션이 읽기 전용으로 탑재된 이전 상태로 부팅됩니다. <systemitem class="username">root</systemitem>로 로그인하고 올바른 스냅샷을 선택했는지 확인합니다. 모든 기능이 제대로 작동하는지도 확인합니다. 루트 파일 시스템이 읽기 전용으로 탑재되었으므로 기능이 제한될 수 있습니다.
    </para>
    <para>
     문제가 발생하거나 잘못된 스냅샷을 부팅한 경우 재부팅하고 다른 스냅샷을 선택하여 부팅합니다. 이때까지는 영구적으로 변경되지 않았습니다. 스냅샷이 올바르고 제대로 작동하는 경우 다음 명령을 실행하여 영구적으로 변경합니다.
    </para>
    <screen>snapper rollback</screen>
    <para>
     이후 재부팅합니다. 부팅 화면에서 기본 부팅 항목을 선택하여 복구된 시스템으로 재부팅합니다.
    </para>
   </step>
   <step>
    <para>
     리포지토리 구성이 올바로 재설정되었는지 확인합니다. 또한 모든 제품이 올바로 등록되었는지 확인합니다. 하나라도 잘못된 경우 나중에 시스템을 업데이트할 수 없거나 시스템이 잘못된 패키지 리포지토리를 사용하여 업데이트될 수 있습니다.
    </para>
    <para>
     이 절차를 시작하기 전에 인터넷에 액세스할 수 있는지 확인하십시오.
    </para>
    <substeps>
     <step>
      <para>
       다음을 실행하여 서비스 및 리포지토리를 새로 고칩니다.
      </para>
      <screen>sudo zypper ref -fs</screen>
     </step>
     <step>
      <para>
       다음을 실행하여 활성 리포지토리 목록을 가져옵니다.
      </para>
      <screen>sudo zypper lr</screen>
      <para>
       이 명령을 출력을 자세히 확인하십시오. 업데이트를 위해 추가된 서비스와 리포지토리가 나열되지 않아야 합니다. 예를 들어 SLES 12 SP1에서 SLES 12 SP2로의 서비스 팩 마이그레이션에서 롤백하는 경우 목록에 <literal>SLES12-SP2-Pool</literal> 및 <literal>SLES12-SP2-Updates</literal> 리포지토리가 포함되지 <emphasis>않고</emphasis>, <literal>SP1</literal> 버전이 포함되어야 합니다.
      </para>
      <para>
       잘못된 리포지토리가 나열되는 경우 삭제해야 하며 필요한 경우 사용 중인 제품 또는 서비스 팩과 일치하는 버전으로 바꾸어야 합니다. 지원되는 마이그레이션 경로에 대한 리포지토리 목록은 <xref linkend="sec.update.nmm.repositories"/>을 참조하십시오.
      </para>
     </step>
     <step>
      <para>
       마지막으로 다음을 실행하여 설치한 모든 제품의 등록 상태를 확인합니다.
      </para>
      <screen>SUSEConnect --status</screen>
      <para>
       모든 제품이 <literal>등록됨</literal>으로 보고되어야 합니다. 그렇지 않으면 다음을 실행하여 등록을 복구합니다.
      </para>
      <screen>SUSEConnect --rollback</screen>
     </step>
    </substeps>
   </step>
  </procedure>
  <para>
   이제 시스템을 서비스 팩 마이그레이션이 시작되기 직전에 캡처된 상태로 되돌렸습니다.
  </para>
 </sect1>
</chapter>
