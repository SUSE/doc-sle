<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_offline.xml" version="5.0" xml:id="cha.update.offline">
 <title>離線升級</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    本章介紹如何借助從安裝媒體開機的 YaST，升級現有 SUSE Linux Enterprise 安裝。YaST 安裝程式有多種啟動方法，例如從 DVD 啟動、透過網路啟動或從系統所在的硬碟啟動。
   </para>
  </abstract>
 </info>
 <sect1 xml:id="sec.update.offline.conceptual-overview">
  <title>概念綜覽</title>
  <para>
   在升級系統之前，請先閱讀<xref linkend="sec.update.prep"/>。
  </para>
  <para>
   若要升級系統，請像執行全新安裝時那樣，從安裝來源開機。不過，當開機螢幕出現時，您需要選取<guimenu>升級</guimenu> (而不是<guimenu>安裝</guimenu>)。可從以下媒體啟動升級︰
  </para>

  <itemizedlist>
   <listitem>
    <formalpara>
     <title>抽取式媒體</title>
     <para>
      包括 CD、DVD 或 USB 大量儲存裝置等媒體。若需要更多的資訊，請參閱 <xref linkend="sec.update.offline.dvd"/>。
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>網路 資源</title>
     <para>
      您可以從本地媒體開機並選取相應的網路安裝類型，或者透過 PXE 開機。如需詳細資訊，請參閱<xref linkend="sec.update.offline.network"/>。
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>硬碟</title>
     <para>
      您可以將 ISO 影像中的新核心和 initrd 影像複製到包含目前 SUSE Linux Enterprise 安裝的硬碟，並調整開機功能表。如需詳細資訊，請參閱<xref linkend="sec.update.offline.harddisk"/>
     </para>
    </formalpara>
   </listitem>
  </itemizedlist>
 </sect1>


 <sect1 xml:id="sec.update.offline.dvd">
  <title>從安裝媒體啟動升級</title>
  <para>
   以下程序舉例說明如何從 DVD 開機，不過，您也可以使用其他本地安裝媒體，例如 USB 大量儲存裝置上的 ISO 影像。要選取的媒體和開機方法取決於系統架構，以及機器使用的是傳統 BIOS 還是 UEFI。
  </para>
  <procedure xml:id="pro.update.sle12.offline.dvd">
   <title>從 SLE 11 SP4 手動升級到 SLE 12 SP3</title>
   <step>
    <para>
     選取並準備開機媒體，請參閱<xref linkend="sec.i.yast2.startup"/>。
    </para>
   </step>
   <step>
    <para>
     插入 SUSE Linux Enterprise 12 SP3 安裝媒體的 DVD 1 並將機器開機。隨即會依次顯示<guimenu>歡迎使用</guimenu>螢幕和開機螢幕。
    </para>
   </step>
   <step>
    <para>
     在開機功能表中選取<emphasis>升級</emphasis>以啟動系統。
    </para>
   </step>
   <step>
    <para>
     如<xref linkend="sec.update.sle12.start.upgr.after.boot"/>中所述繼續執行升級程序。
    </para>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec.update.offline.network">
  <title>從網路來源啟動升級</title>
  <para>
   如果要從網路安裝來源開始升級，請確定符合以下要求︰
  </para>
  <variablelist>
   <title>從網路安裝來源升級的要求</title>
   <varlistentry>
    <term>網路安裝來源</term>
    <listitem>
     <para>
      網路安裝來源已依據<xref linkend="cha.deployment.instserver"/>所述完成設定。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>網路連接和網路服務</term>
    <listitem>
     <para>
      安裝伺服器與目標機器的網路連接均必須正常。必需的網路服務如下︰
     </para>
     <itemizedlist>
      <listitem><para>網域名稱服務</para></listitem>
      <listitem><para>DHCP (僅在透過 PXE 開機時需要，可在設定期間手動設定 IP)</para></listitem>
      <listitem><para>OpenSLP (選擇性)</para></listitem>
     </itemizedlist>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>開機媒體</term>
    <listitem>
     <para>
      提前備好一張用於將目標系統開機的 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> DVD 1 (或本地 ISO 影像)，<emphasis>或者</emphasis>已依<xref linkend="sec.deployment.prep_boot.pxeprep" xrefstyle="HeadingOnPage"/>所述將目標系統設定為透過 PXE 開機。請參閱<xref linkend="cha.deployment.remoteinst"/>，深入瞭解從遠端伺服器開始升級的相關資訊。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <sect2 xml:id="sec.update.sle.manual.network.boot-from-dvd">
   <title>透過網路安裝來源手動升級 — 從 DVD 開機</title>
   <para>
    此程序舉例說明如何從 DVD 開機，不過，您也可以使用其他本地安裝媒體，例如 USB 大量儲存裝置上的 ISO 影像。如何選取開機方法以及從媒體啟動系統取決於系統架構，以及機器使用的是傳統 BIOS 還是 UEFI。如需詳細資料，請參閱以下連結。
   </para>
   <procedure xml:id="pro.update.sle.manual.network.boot-from-dvd">
    
    <step>
     <para>
      插入 SUSE Linux Enterprise 12 SP2 安裝媒體的 DVD 1 並將機器開機。隨即會依次顯示<guimenu>歡迎使用</guimenu>螢幕和開機螢幕。
     </para>
    </step>
    <step>
     <para>
      選取要使用的網路安裝來源類型 (FTP、HTTP、NFS、SMB 或 SLP)。通常可以按 <keycap>F4</keycap> 選取此選項，但是，如果您機器上裝配的是 UEFI 而不是傳統 BIOS，則您可能需要手動調整開機參數。如需詳細資料，請參閱<xref linkend="cha.inst"/>中的<xref linkend="sec.i.yast2.source.net"/>。
     </para>
    </step>
    <step>
     <para>
      如<xref linkend="sec.update.sle12.start.upgr.after.boot"/>中所述繼續執行升級程序。
     </para>
    </step>
   </procedure>
  </sect2>
  <sect2 xml:id="sec.update.sle.manual.network.pxe-boot">
   <title>透過網路安裝來源手動升級 — 透過 PXE 開機</title>
   <para>
    若要透過 PXE 開機從網路安裝來源執行升級，請依照以下步驟操作︰
   </para>
   <procedure xml:id="pro.update.sle.manual.network.pxe-boot">
    <step>
     <para>
      調整 DHCP 伺服器的設定以提供透過 PXE 開機時所需的位址資訊。如需詳細資料，請參閱<xref linkend="sec.deployment.prep_boot.pxeprep"/>。
     </para>
    </step>
    <step>
     <para>
      設定 TFTP 伺服器，以存放透過 PXE 開機時所需的開機影像。為此，請使用 SUSE Linux Enterprise  12 SP2 安裝媒體的 DVD 1，或者遵循<xref linkend="sec.deployment.prep_boot.tftp"/>中的指示。
     </para>
    </step>
    <step>
     <para>
      在目標機器上準備 PXE 開機和網路喚醒功能。
     </para>
    </step>
    <step>
     <para>
      啟始目標系統開機，並使用 VNC 遠端連接到這部機器所執行的安裝常式。如需詳細資訊，請參閱<xref linkend="sec.deployment.remoteinst.monitor.vnc"/>。
     </para>
    </step>
    <step>
     <para>
      如<xref linkend="sec.update.sle12.start.upgr.after.boot"/>中所述繼續執行升級程序。
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>

 <sect1 xml:id="sec.update.offline.harddisk">
  <title>從硬碟啟動升級</title>
  <sect2 xml:id="sec.update.sle.offline.automated">
   <title>從 SUSE Linux Enterprise 11 SP3 或 SP4 自動移轉到 SUSE Linux Enterprise 12 SP2</title>
   <procedure xml:id="pro.update.sle.offline.automated">
    <remark>toms 2014-03-19: See FATE#315037</remark>
    <remark role="future">toms 2014-03-20: From SLE12 SP1 on, we should probably base
     this example on GRUB2, but not for GA.</remark>
    <remark>jsrain 2015-09-02: This is still the old system; at some point
        of time we should switch to GRUB2, but as long as amjority of
        customers still runs SLE11, I would stay with legacy GRUB. Anyway, we
        could include both options, that would be probably best solution</remark>
    <step>
     <para>
      將第一張安裝 DVD 中 <filename>/boot/x86_64/loader/</filename> 目錄下的 <filename>linux</filename> 安裝核心和 <filename>initrd</filename> 檔案複製到系統的 <filename>/boot</filename> 目錄︰
     </para>
<screen><prompt role="root">root # </prompt><command>cp</command> -vi <replaceable>DVDROOT</replaceable>/boot/x86_64/loader/linux /boot/linux.upgrade
<prompt role="root">root # </prompt><command>cp</command> -vi <replaceable>DVDROOT</replaceable>/boot/x86_64/loader/initrd /boot/initrd.upgrade</screen>
     <para>
      <replaceable>DVDROOT</replaceable> 表示系統掛接 DVD 的路徑，通常是 <filename>/run/media/$USER/$DVDNAME</filename>。
     </para>
    </step>
    <step>
     <para>
      開啟 GRUB 舊組態檔案 <filename>/boot/grub/menu.lst</filename> 並新增另一個區段。對於其他開機載入程式，請編輯相應的組態檔案。相應地調整裝置名稱和 <parameter>根部</parameter> 參數。例如︰
     </para>
     <para>
      <remark>sseeberg 2017-04-11: this is only valid for sle11?</remark>
     </para>
<screen>title Linux Upgrade Kernel
kernel (hd0,0)/boot/linux.upgrade root=/dev/sda1 upgrade=1 autoupgrade=1
initrd (hd0,0)/boot/initrd.upgrade</screen>
    </step>
    <step>
     <para>
      執行下面的步驟前，需要將 DVD 放入光碟機，或將 ISO 影像放置於本地磁碟上。如果電腦沒有 DVD 光碟機，則請下載 ISO 並將其儲存為 <filename>/install.iso</filename>，或者從 DVD 複製該 ISO
     </para>
<screen><prompt role="root">root # </prompt><command>dd</command> if=/dev/cdrom of=/install.iso</screen>
     <para>
      如果您已將 ISO 複製到硬碟，則需將一個參數新增到先前編輯的 <filename>/boot/grub/menu.lst</filename> 中。在以 <literal>kernel</literal> 開頭的行中新增以下選項︰
     </para>
<screen>install=hd:/install.iso</screen>
    </step>
    <step>
     <para>
      將機器重新開機，並從開機功能表中選取新增的區段 (此處是 <emphasis>Linux 升級核心</emphasis>)。您可以使用 <command>grubonce</command> 預先選取新建立的 GRUB 項目，以便以無人管理的方式自動重新開機到新建立的項目。您還可以使用 <command>reboot</command> 來從指令行啟動重新開機。
     </para>
    </step>
    <step>
     <para>
      如<xref linkend="sec.update.sle12.start.upgr.after.boot"/>中所述繼續執行升級程序。
     </para>
    </step>
    <step>
     <para>
      升級程序成功完成後，移除安裝核心和 initrd 檔案 (<filename>/boot/linux.upgrade</filename> 和 <filename>/boot/initrd.upgrade</filename>)。現在不再需要這些檔案。
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.update.offline.automated">
  <title>啟用自動升級</title>
  <para>
   升級程序可以自動執行。若要啟用自動更新核心的功能，必須設定核心參數 <literal>autoupgrade = 1</literal>。可在開機時於<literal>開機選項</literal>欄位中設定該參數。如需詳細資料，請參閱<link xlink:href="https://www.suse.com/documentation/sles-12/book_autoyast/data/introduction.html"/>。
  </para>
 </sect1>
 <sect1 xml:id="sec.update.sle12.start.upgr.after.boot">
  <title>升級 SUSE Linux Enterprise</title>
  <para>
   <remark>taroth 2014-11-13: argh, the following is terminology hell regarding
     the software strings: "upgrade"/"update" are used intermittently and
     without clear differentiation...</remark>
  </para>
  <para>
   在升級系統之前，請先閱讀<xref linkend="sec.update.prep"/>。若要執行自動移轉，請執行下列步驟︰
  </para>
  <procedure>
   <step>
    <para>
     (從安裝媒體或網路) 開機後，請在開機螢幕上選取<guimenu>升級</guimenu>項目。如果您要依照後續步驟所述手動執行升級，則需停用自動升級程序。請參閱<xref linkend="sec.update.offline.automated"/>。
    </para>
    <warning>
     <title>不當的選擇可能會導致資料遺失</title>
     <para>
      如果您選取<guimenu>安裝</guimenu>而不是<guimenu>升級</guimenu>，稍後可能會遺失資料。在全新安裝期間，您需要格外小心，以免某些操作損毀資料分割區，這些操作包括重新分割磁碟 (可能會損毀現有分割區) 或重新格式化資料分割區 (這會去除資料分割區上的所有資料)。
     </para>
     <para>
      請確定在這裡選取<guimenu>升級</guimenu>。
     </para>
    </warning>
    <para>
     YaST 將會啟動安裝系統。
    </para>
   </step>
   <step>
    <para>
     在<guimenu>歡迎</guimenu>螢幕上，選擇<guimenu>語言</guimenu>和<guimenu>鍵盤</guimenu>並接受授權合約。按<guimenu>下一步</guimenu>繼續。
    </para>
    <para>
     YaST 將會檢查您的分割區上是否已安裝 SUSE Linux Enterprise 系統。
    </para>
   </step>
   <step>
    <para>
     在<guimenu>選取升級</guimenu>螢幕上，選取要升級的分割區，然後按<guimenu>下一步</guimenu>。
    </para>
    <para>
     YaST 將會裝入選定的分割區，並顯示在您要升級的分割區上找到的所有儲存庫。
    </para>
   </step>
   <step>
    <para>
     在<guimenu>之前使用的儲存庫</guimenu>螢幕上，調整儲存庫的狀態︰啟用您要包含在升級程序中的儲存庫，並停用不再需要的所有儲存庫。按<guimenu>下一步</guimenu>繼續。
    </para>
   </step>
   <step>
    <para>
     在<guimenu>註冊</guimenu>螢幕上，選取是要立即註冊已升級的系統 (輸入您的註冊資料並按<guimenu>下一步</guimenu>)，還是要<guimenu>跳過註冊</guimenu>。如需註冊系統的詳細資料，請參閱<xref linkend="sec.update.registersystem"/>。
    </para>
   </step>
   <step>
    <para>
     檢閱關於升級的<guimenu>安裝設定</guimenu>，尤其是<guimenu>更新選項</guimenu>。在以下選項之間進行選擇︰
    </para>
    <itemizedlist>
     <listitem>
      <para>
       <guimenu>只更新安裝的套件</guimenu>，如果選取此選項，您可能會失去最新 SUSE Linux Enterprise 版本隨附的新功能。
      </para>
     </listitem>
     <listitem>
      <para>
       <guimenu>透過安裝新軟體和功能進行更新</guimenu>。如果要根據自己的需要啟用或停用模式與套件，請按一下<guimenu>選取模式</guimenu>。
      </para>
     </listitem>
    </itemizedlist>

    <note>
     <title>桌面選擇</title>
     <para>
      如果在升級到 SUSE Linux Enterprise 12 之前您使用的是 KDE<varname>(</varname> <filename>/etc/sysconfig/windowmanager</filename> 中的 DEFAULT_WM 設定為 <literal>kde*</literal>)，則在升級後，您的桌面環境會自動取代為 GNOME。依預設，KDM 顯示管理員會取代為 GDM。
     </para>
     <para>
      若要變更桌面環境或視窗管理員的選擇，請按一下<guimenu>選取模式</guimenu>來調整軟體選擇。
     </para>
    </note>
   </step>
   <step>
    <para>
     如果所有設定都如您所願，請按一下<guimenu>更新</guimenu>啟動安裝與移除程序。
    </para>
   </step>
   <step>
    <para>
     成功完成升級過程後，請檢查是否有任何<quote>孤立的套件</quote>。孤立的套件是指不再屬於任何使用中的儲存庫的套件。以下指令可以列出這些套件︰
    </para>
<screen>zypper packages --orphaned</screen>
    <para>
     藉由此清單，您可以確定某個套件是否仍然需要，或者是否可以將其安全解除安裝。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.sle.manager">
  <title>透過 SUSE Manager 進行更新</title>

  <para>
   SUSE Manager 是一個伺服器解決方案，用於提供適用於 SUSE Linux Enterprise 用戶端的更新、修補程式和安全性修正程式。它隨附一組工具和一個 Web 式使用者介面，用於執行管理任務。如需 SUSE Manager 的詳細資訊，請參閱 <link xlink:href="https://www.suse.com/products/suse-manager/"/>。
  </para>
  
  <para>
   SUSE Manager 可為您提供 SP 移轉或完整系統升級支援。
  </para>

  <variablelist>
   
   <varlistentry>
    <term>SP 移轉</term>
    <listitem>
     <para>
      SP 移轉允許從某主要版本中的一個 Service Pack (SP) 移轉到另一個 Service Pack (例如，從 SLES 12 SP1 移轉到 12 SP2)。如需詳細資訊，請參閱《<citetitle>SUSE Manager Best Practices</citetitle>》(SUSE Manager 最佳實務) 中<quote>Client Migration</quote>(用戶端移轉) 一章中的<quote>Migrating SUSE Linux Enterprise Server 12 or later to version 12 SP2</quote>(將 SUSE Linux Enterprise Server 12 或更新版本移轉到版本 12 SP2) 一節︰
     </para>
     <para>
      
      <link xlink:href="https://www.suse.com/documentation/suse-manager/"/>，版本 3.1
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>系統升級</term>
    <listitem>
     <para>
      您可以使用 SUSE Manager 來執行系統升級。透過整合的 AutoYaST 技術，可以從一個主要版本升級到下一個主要版本 (例如，從 SLES 11 SP3 升級到 12 SP2)。如需詳細資訊，請參閱《<citetitle>SUSE Manager Best Practices</citetitle>》(SUSE Manager 最佳實務) 中<quote>Client Migration</quote>(用戶端移轉) 一章中的<quote>Migrating SUSE Linux Enterprise 11 SP3 to version 12 SP2</quote>(將 SUSE Linux Enterprise 11 SP3 移轉到版本 12 SP2) 一節︰
     </para>
     <para>
      
      <link xlink:href="https://www.suse.com/documentation/suse-manager/"/>，版本 3.1
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec.update.reg.status.after.rollback">
  <title>復原後更新註冊狀態</title>

  <para>
   執行 Service Pack 升級時，需要在註冊伺服器上變更組態，以提供對新儲存庫的存取權限。如果升級程序被中斷或回復 (透過從備份或快照還原)，註冊伺服器上的資訊將與系統的狀態不一致。這可能會導致您無法存取更新儲存庫，或者導致在用戶端上使用錯誤的儲存庫。
  </para>

  <para>
   若透過 Snapper 進行復原，系統將會向註冊伺服器傳送通知，確保在開機過程中設定正確儲存庫的存取權限。若系統以其他任何方式還原，或者由於任何原因導致與註冊伺服器的通訊失敗 (例如由於網路問題而導致伺服器無法存取)，請透過調用以下指令在用戶端上觸發復原︰
  </para>

<screen><command>snapper</command> rollback</screen>

  <para>
   建議您始終使用以下指令檢查系統上是否已設定正確的儲存庫 (特別是在重新整理服務後)︰
  </para>

<screen><command>zypper</command> ref -s</screen>

  <para>
   此功能在 
   <package>rollback-helper </package>
   套件中可用。
  </para>
 </sect1>
 <sect1 xml:id="sec.update.registersystem">


  <title>注册您的系統</title>

  <para>
   如果您在安裝期間跳過註冊步驟，日後可隨時使用 YaST 中的<guimenu>產品註冊</guimenu>模組來註冊您的系統。
  </para>

  <para>
   註冊系統可以獲得以下優勢︰
  </para>

  <itemizedlist>
   <listitem>
    <para>
     有資格獲得支援
    </para>
   </listitem>
   <listitem>
    <para>
     取得安全性更新和錯誤修復
    </para>
   </listitem>
   <listitem>
    <para>
     存取 SUSE Customer Center
    </para>
   </listitem>
  </itemizedlist>

  <procedure>
   <step>
    <para>
     啟動 YaST 並選取<menuchoice> <guimenu> 軟體</guimenu>
     <guimenu> 產品註冊</guimenu> </menuchoice> 以開啟<guimenu>註冊</guimenu>對話方塊。
    </para>
   </step>
   <step>
    <para>
     提供與您或您的組織用於管理訂閱的 SUSE 帳戶關聯的<guimenu>電子郵件</guimenu>地址。如果您還沒有 SUSE 帳戶，請前往 SUSE Customer Center 首頁 (<link xlink:show="new" xlink:href="https://scc.suse.com/"/>) 建立一個帳戶。
    </para>
   </step>
   <step>
    <para>
     輸入與 <guimenu>SUSE Linux Enterprise Server</guimenu> 副本一起收到的「<phrase role="productname"><phrase os="sles">註冊代碼</phrase></phrase>」。
    </para>
   </step>
   <step xml:id="step.y2.register.final">
    <para>
     若要開始註冊，請繼續執行<guimenu>下一步</guimenu>。如果您的網路上有一個或多個本地註冊伺服器可用，您可以從清單中選擇其中一個伺服器。或者，若要忽略本地註冊伺服器並在預設的 SUSE 註冊伺服器中註冊，請選擇<guimenu>取消</guimenu>。
    </para>
    <para>
     註冊期間，線上更新儲存庫將會新增到您的升級設定中。結束後，您可以選擇是否從更新儲存庫安裝最新可用的套件版本。這會為所有套件提供一個干淨的升級路徑，並確保使用可用的最新安全更新升級 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>。如果您選擇<guimenu>否</guimenu>，則所有套件將從安裝媒體安裝。按<guimenu>下一步</guimenu>繼續。
    </para>
    <para>
     成功註冊後，YaST 將列出系統可用的延伸、附加產品和模組。若要選取並安裝它們，請繼續<xref linkend="sec.add-ons.extensions"/>。
    </para>
   </step>
  </procedure>
 </sect1>

</chapter>
