<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_online.xml" version="5.0" xml:id="cha.update.online">
 <title>Mise à niveau en ligne</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>oui</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    SUSE offre un outil graphique intuitif et un outil de ligne de commande simple pour effectuer la mise à niveau d'un système en cours d'exécution vers un nouveau Service Pack. Ces outils permettent un <quote>retour à l'état initial</quote> des Service Packs et bien plus encore. Ce chapitre explique comment effectuer une mise à niveau de Service Pack étape par étape à l'aide de ces outils.
   </para>
  </abstract>
 </info>
 <sect1 xml:id="sec.update.migr.conceptual-overview">
  <title>Présentation conceptuelle</title>

  <para>
   SUSE publie régulièrement de nouveaux Service Packs pour la gamme de produits SUSE Linux Enterprise. Pour faciliter la migration vers un nouveau Service Pack et minimiser les temps hors service, SUSE prend en charge la migration en ligne pendant que le système est en cours d'exécution.
  </para>

  <para>
   À partir de SLE 12 , YaST Wagon a été remplacé par la migration YaST (pour l'interface graphique) et la migration Zypper (pour la ligne de commande). Les fonctions prises en charge sont les suivantes :
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Le système est toujours dans un état défini jusqu'à la mise à jour du premier RPM.
    </para>
   </listitem>
   <listitem>
    <para>
     L'annulation est possible jusqu'à la mise à jour du premier RPM.
    </para>
   </listitem>
   <listitem>
    <para>
     La récupération est simple en cas d'erreur.
    </para>
   </listitem>
   <listitem>
    <para>
     <quote>Retour à l'état initial</quote> à l'aide des outils système ; aucune sauvegarde/restauration nécessaire.
    </para>
   </listitem>
   <listitem>
    <para>
     Utilisation de tous les dépôts actifs.
    </para>
   </listitem>
   <listitem>
    <para>
     La possibilité d'ignorer un Service Pack.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.workflow">
  <title>Déroulement de la migration des Service Packs</title>

  <para>
   Une migration de Service Pack peut être exécutée à l'aide des outils YaST, <command>zypper</command> ou AutoYaST.
  </para>

  <para>
   Avant de pouvoir démarrer la migration d'un Service Pack, votre système doit être enregistré auprès du SUSE Customer Center ou d'un serveur SMT local. Il est également possible d'utiliser SUSE Manager.
  </para>

  <para>
   Quelle que soit la méthode utilisée, la migration de Service Packs comporte les étapes suivantes :
  </para>

  <orderedlist>
   <listitem>
    <para>
     L'identification de cibles de migration possibles sur vos systèmes enregistrés
    </para>
   </listitem>
   <listitem>
    <para>
     La sélection d'une cible de migration
    </para>
   </listitem>
   <listitem>
    <para>
     La demande et l'activation de nouveaux dépôts
    </para>
   </listitem>
   <listitem>
    <para>
     L'exécution de la migration
    </para>
   </listitem>
  </orderedlist>



  <para>
   La liste des cibles de migration dépend des produits que vous avez installés et enregistrés. Si vous avez une extension installée pour laquelle le nouveau Service Pack n'est pas encore disponible, il se peut qu'aucune cible de migration ne vous soit proposée.
  </para>

  <para>
   La liste des cibles de migration disponibles pour votre hôte sera toujours récupérée à partir du SUSE Customer Center et dépend des produits ou des extensions installées.
  </para>
 </sect1>
 <sect1 xml:id="sec.update.migr.cancel.spm">
  <title>Annulation de la migration d'un Service Pack</title>

  <para>
   La migration d'un Service Pack peut uniquement être annulée à certains stades au cours du processus de migration :
  </para>

  <orderedlist>
   <listitem>
    <para>
     Jusqu'au démarrage de la mise à niveau du paquetage, les modifications sur le système sont minimes et concernent par exemple, les services et dépôts. Restaurez <filename>/etc/zypp/repos.d/*</filename> pour revenir à l'état précédent.
    </para>
   </listitem>
   <listitem>
    <para>
     Après le démarrage de la mise à niveau du paquetage, vous pouvez revenir à l'état précédent à l'aide d'un instantané Snapper (reportez-vous au manuel <xref linkend="cha.snapper"/>).
    </para>
   </listitem>
   <listitem>
    <para>
     Une fois la cible de migration sélectionnée, SUSE Customer Center modifie les données du dépôt. Pour rétablir cet état manuellement, utilisez <command>SUSEConnect</command><option>--rollback</option>.
    </para>
   </listitem>
  </orderedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.yast.onlinemigr">
  <title>Mise à niveau à l'aide de l'outil de migration en ligne (YaST)</title>

  <para>
   Pour effectuer une migration de Service Packs à l'aide de YaST, utilisez l'outil de <guimenu>migration en ligne</guimenu>. Par défaut, YaST n'installe pas les paquetages à partir d'un dépôt tiers. Si un paquetage a été installé à partir d'un dépôt tiers, YaST empêche le remplacement des paquetages par les mêmes provenant de SUSE.
  </para>

  <note>
   <title>réduction de la taille de l'installation</title>
   <para>
    Lorsque vous effectuez la migration de Service Packs, YaST installe tous les paquetages recommandés. En particulier dans le cas d'installations minimales personnalisées, cela peut augmenter considérablement la taille de l'installation sur le système.
   </para>
   <para>
    Pour modifier ce comportement par défaut et autoriser uniquement les paquetages requis, adaptez <filename>/etc/zypp/zypp.conf</filename> et définissez la variable suivante :
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   Cette opération modifie le comportement de toutes les opérations de paquetages, telles que l'installation de correctifs ou de nouveaux paquetages.
  </para>

  <para>
   Pour démarrer la migration de Service Packs, procédez comme suit :
  </para>

  <procedure xml:id="pro.update.migr.yast">
   <step>
    <para>
     Désactivez toutes les extensions non utilisées sur votre serveur d'enregistrement pour éviter les futurs conflits de dépendance. Si vous oubliez une extension, YaST détectera ultérieurement les dépôts d'extension inutilisés et les désactivera.
    </para>
   </step>
   <step>
    <para>
     Si vous êtes connecté à une session GNOME en cours d'exécution sur la machine que vous allez mettre à jour, basculez vers une console de texte. L'exécution de la mise à jour à partir d'une session GNOME n'est pas recommandée. Notez que cela ne s'applique pas lorsque vous êtes connecté à partir d'une machine distante (sauf si vous exécutez une session VNC avec GNOME).
    </para>
   </step>
   <step>
    <para>
     Si vous êtes un abonné LTSS, assurez-vous que le dépôt d'extension LTSS est actif.
    </para>
   </step>
   <step>
    <para>
     Exécutez la mise à jour en ligne de YaST pour obtenir les dernières mises à jour des paquetages de votre système.
    </para>
   </step>
   <step>
    <para>
     Installez le paquetage 
     <package>yast2-migration</package>
     et ses dépendances (dans YaST sous<menuchoice> <guimenu>Logiciels</guimenu> <guimenu>Gestion des logiciels</guimenu></menuchoice>).
    </para>
   </step>
   <step>
    <para>
     Redémarrez YaST, car dans le cas contraire, le nouveau module installé ne s'affiche pas dans SUSE Control Center.
    </para>
   </step>
   <step>
    <para>
     Dans YaST, accédez à <menuchoice><guimenu>Système</guimenu> <guimenu>Migration en ligne</guimenu></menuchoice>. YaST affiche les cibles de migration possibles ainsi qu'un récapitulatif. Si plusieurs cibles de migration sont disponibles pour votre système, sélectionnez-en une dans la liste.
    </para>
   </step>
   <step>
    <para>
     Sélectionnez une cible de migration à partir de la liste et cliquez sur <guimenu>Suivant</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Si l'outil de migration propose des dépôts de mise à jour, il est recommandé de cliquer sur <guimenu>Oui</guimenu>.
    </para>
   </step>
   <step>
    <para>
     <remark>toms 2015-09-09: FATE#319140</remark> Si l'outil de migration en ligne détecte des dépôts obsolètes provenant d'un DVD ou d'un serveur local, il est vivement recommandé de les désactiver. Les dépôts obsolètes proviennent d'un ancien Service Pack. Tous les anciens dépôts de SCC ou SMT sont automatiquement supprimés.
    </para>
   </step>
   <step>
    <para>
     Vérifiez le récapitulatif et procédez à la migration en cliquant sur <guimenu>Suivant</guimenu>. Confirmez en cliquant sur <guimenu>Start Update</guimenu> (Démarrer la mise à jour).
    </para>
    <remark>toms 2016-07-13: What to do in case of problems?</remark>
   </step>
   <step>
    <para>
     Une fois la migration réussie, redémarrez votre système.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.zypper.onlinemigr">
  <title>Mise à niveau avec zypper</title>

  <para>
   Pour effectuer une migration de Service Packs à l'aide de Zypper, utilisez de l'outil de ligne de commande <command>zypper</command> <option>migration</option>.
  </para>

  <note>
   <title>réduction de la taille de l'installation</title>
   <para>
    Lorsque vous effectuez la migration de Service Packs, YaST installe tous les paquetages recommandés. En particulier dans le cas d'installations minimales personnalisées, cela peut augmenter considérablement la taille de l'installation sur le système.
   </para>
   <para>
    Pour modifier ce comportement par défaut et autoriser uniquement les paquetages requis, adaptez <filename>/etc/zypp/zypp.conf</filename> et définissez la variable suivante :
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   Cette opération modifie le comportement de toutes les opérations de paquetages, telles que l'installation de correctifs ou de nouveaux paquetages. Pour modifier le comportement de Zypper pour une seule invocation, ajoutez le paramètre <option>--no-recommends</option> à votre ligne de commande.
  </para>

  <para>
   Pour démarrer la migration de Service Packs, procédez comme suit :
  </para>

  <procedure xml:id="pro.update.migr.zypper">
   <step>
    <para>
     Si vous êtes connecté à une session GNOME en cours d'exécution sur la machine que vous allez mettre à jour, basculez vers une console de texte. L'exécution de la mise à jour à partir d'une session GNOME n'est pas recommandée. Notez que cela ne s'applique pas lorsque vous êtes connecté à partir d'une machine distante (sauf si vous exécutez une session VNC avec GNOME).
    </para>
   </step>
   <step>
    <para>
     Enregistrez votre machine SUSE Linux Enterprise si ce n'est pas déjà fait :
    </para>
<screen>sudo <command>SUSEConnect</command> --regcode <replaceable>YOUR_REGISTRATION_CODE</replaceable></screen>
   </step>
   <step>
    <para>
     Si vous êtes un abonné LTSS, assurez-vous que le dépôt d'extension LTSS est actif.
    </para>
   </step>
   <step>
    <para>
     Installez les dernières mises à jour :
    </para>
<screen>sudo <command>zypper</command> patch</screen>
   </step>
   <step>
    <para>
     Installez le paquetage <package>zypper-migration-plugin</package> et ses dépendances :
    </para>
<screen>sudo <command>zypper</command> in zypper-migration-plugin</screen>
   </step>
   <step>
    <para>
     Exécutez <command>zypper</command> <option>migration</option> :
    </para>
<screen><prompt>tux &gt; </prompt>sudo <command>zypper</command> migration
Executing 'zypper  patch-check'

Refreshing service 'SUSE_Linux_Enterprise_Server_12_x86_64'.
Loading repository data...
Reading installed packages...
0 patches needed (0 security patches)

Available migrations:

    1 | SUSE Linux Enterprise Server 12 SP1 x86_64
    2 | SUSE Linux Enterprise Server 12 SP2 x86_64</screen>
    <para>
     Quelques remarques concernant le processus de migration :
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Si plusieurs cibles de migration sont disponibles pour votre système, Zypper vous autorise à sélectionner un Service Pack dans la liste. Cette opération revient à ignorer un ou plusieurs Service Packs. N'oubliez pas, la migration en ligne pour les produits de base (SLES, SLED) reste uniquement disponible entre les Service Packs d'une version majeure.
      </para>
     </listitem>
     <listitem>
      <para>
       Par défaut, Zypper utilise l'option <option>--no-allow-vendor-change</option> transmise à <command>zypper</command> <option>dup</option> Si un paquetage a été installé à partir d'un dépôt tiers, cette option empêche le remplacement des paquetages par les mêmes provenant de SUSE.
      </para>
     </listitem>
     <listitem>
      <para>
       <remark>toms 2015-09-09: FATE#319140</remark> Si Zypper détecte des dépôts obsolètes provenant d'un DVD ou d'un serveur local, il est vivement recommandé de les désactiver. Les anciens dépôts de SCC ou SMT sont supprimés automatiquement.
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     Passez en revue toutes les modifications, en particulier les paquetages qui vont être supprimés. Poursuivez en saisissant <literal>y</literal> (le nombre exact de paquetages à mettre à niveau peut varier sur votre système) :
    </para>
<screen>266 packages to upgrade, 54 to downgrade, 17 new, 8 to reinstall, 5 to remove, 1 to change arch.
Overall download size: 285.1 MiB. Already cached: 0 B  After the operation, additional 139.8 MiB will be used.
Continue? [y/n/? shows all options] (y):</screen>
    <para>
     Utilisez les touches de défilement <keycombo> <keycap function="shift"/> <keycap function="pageup"/> </keycombo> ou <keycombo> <keycap function="shift"/> <keycap function="pagedown"/> </keycombo> dans votre shell.
    </para>
   </step>
   <step>
    <para>
     Une fois la migration réussie, redémarrez votre système.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.plainzypper.onlinemigr">
  <title>Mise à niveau à l'aide de Plain Zypper</title>

  <para>
   Si vous ne pouvez pas utiliser la migration YaST ou Zypper, vous pouvez toujours effectuer la migration à l'aide de Zypper brut et de certaines interactions manuelles. Pour démarrer une migration de Service Packs, procédez comme suit :
  </para>

  <procedure>
   <step>
    <para>
     Si vous êtes connecté à une session GNOME en cours d'exécution sur la machine que vous allez mettre à jour, basculez vers une console de texte. L'exécution de la mise à jour à partir d'une session GNOME n'est pas recommandée. Notez que cela ne s'applique pas lorsque vous êtes connecté à partir d'une machine distante (sauf si vous exécutez une session VNC avec GNOME).
    </para>
   </step>
   <step>
    <para>
     Mettez à jour les outils de gestion des paquetages avec les anciens dépôts SUSE Linux Enterprise :
    </para>
<screen>sudo <command>zypper</command> patch --updatestack-only</screen>
   </step>
   <step>
    <para>
     Si le système a été enregistré, vous devez annuler son enregistrement :
    </para>
<screen>sudo <command>SUSEConnect</command> --de-register</screen>
   </step>
   <step>
    <para>
     Supprimez les anciens dépôts et sources d'installation et ajustez les dépôts tiers.
    </para>
   </step>
   <step>
    <para>
     Ajoutez les nouvelles sources d'installation, qu'elles soient locales ou distantes (pour la marque de réservation <replaceable>DÉPÔT</replaceable>, reportez-vous à la <xref linkend="sec.update.nmm.repositories"/>) :
    </para>
<screen>sudo <command>zypper</command> addrepo <replaceable>REPOSITORY</replaceable></screen>
    <para>
     Vous pouvez également utiliser l'outil SMT ou SUSE Customer Center. La commande pour SUSE Linux Enterprise 12 SP1 sous x86-64 est la suivante :
    </para>
<screen>sudo <command>SUSEConnect</command> -p SLES/12.2/x86_64 <replaceable>OPTIONS</replaceable></screen>
    <para>
     N'oubliez pas que les mises à niveau simultanées sur plusieurs architectures ne sont pas prises en charge.
    </para>
    <para>
     Zypper affiche un conflit entre l'ancien et le nouveau kernel. Choisissez la solution 1 pour continuer.
    </para>
<screen>Problem: product:SLES-12.2-0.x86_64 conflicts with kernel &lt; 4.4 provided by kernel-default-<replaceable>version</replaceable>
 Solution 1: Following actions will be done:
  replacement of kernel-default-<replaceable>version</replaceable> with kernel-default-<replaceable>version</replaceable>
  deinstallation of kernel-default-<replaceable>version</replaceable>
 Solution 2: do not install product:SLES-12.2-0.x86_64
</screen>
   </step>
   <step>
    <para>
     Finalisez la migration :
    </para>
<screen>sudo <command>zypper</command> ref -f -s
sudo <command>zypper</command> dup --no-allow-vendor-change --no-recommends</screen>
    <para>
     La première commande mettra à jour tous les services et dépôts. La seconde commande effectue une mise à niveau de distribution. Ici, les deux dernières options sont importantes : <option>-no-allow-vendor-change</option> permet de s'assurer que les RPM tiers n'écrasent pas ceux du système de base. L'option <option>--no-recommends</option> permet de s'assurer que les paquetages désélectionnés au cours de l'installation initiale ne sont pas ajoutés à ce stade.
    </para>
   </step>
  </procedure>
 </sect1>



 <sect1 xml:id="sec.update.migr.rollback">
  <title>Restauration de l'état initial d'un Service Pack</title>

  <para>
   Si un Service Pack ne fonctionne pas pour vous, SUSE Linux Enterprise prend en charge le rétablissement de l'état qu'il avait avant le démarrage de la migration de ce Service Pack. Vous devez toutefois disposer d'une partition racine Btrfs avec des instantanés activés (il s'agit de la valeur par défaut lorsque vous installez SLES 12). Reportez-vous au <xref linkend="cha.snapper"/> pour plus d'informations. 
  </para>

  <procedure xml:id="pro.update.migr.rollback">
   <step>
    <para>
     Obtenez une liste des instantanés Snapper :
    </para>
    <screen>sudo snapper list</screen>
    <para>
     Passez en revue la sortie pour localiser l'instantané créé juste avant le début de la migration du Service Pack. La colonne <guimenu>Description</guimenu> contient une instruction correspondante et l'instantané est marqué comme <literal>important</literal> dans la colonne <guimenu>Userdata</guimenu>. Mémorisez le numéro de l'instantané indiqué dans la colonne <guimenu>#</guimenu> ainsi que la date reprise dans la colonne <guimenu>Date</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Redémarrez le système. Dans le menu de démarrage, sélectionnez <guimenu>Start boot loader from a read-only snapshot</guimenu> (Démarrer le chargeur de démarrage à partir d'un instantané en lecture seule), puis choisissez l'instantané avec la date et le numéro mémorisé à l'étape précédente. Un second menu de démarrage (celui de l'instantané) est chargé. Sélectionnez l'entrée commençant par <literal>SLES 12</literal> et démarrez-la.
    </para>
   </step>
   <step>
    <para>
     Le système démarre en utilisant son état précédent avec la partition système montée en lecture seule. Connectez-vous en tant qu'utilisateur <systemitem class="username">root</systemitem> et vérifiez si vous avez sélectionné l'instantané approprié. Vérifiez également que tout fonctionne comme prévu. Notez que le système de fichiers racine étant monté en lecture seule, certaines fonctionnalités pourraient être restreintes.
    </para>
    <para>
     En cas de problème ou si vous n'avez pas démarré l'instantané approprié, redémarrez et choisissez un autre instantané à partir duquel démarrer. À ce stade, aucune modification permanente n'a été effectuée. Si l'instantané est correct et fonctionne comme prévu, confirmez la modification pour la rendre définitive en exécutant la commande suivante :
    </para>
    <screen>snapper rollback</screen>
    <para>
     Veuillez ensuite redémarrer. Dans l'écran de démarrage, sélectionnez l'entrée de démarrage par défaut pour redémarrer sur le système rétabli.
    </para>
   </step>
   <step>
    <para>
     Vérifiez si la configuration du dépôt a bien été réinitialisée. En outre, vérifiez si tous les produits sont correctement enregistrés. Si l'un d'entre eux ne l'est pas, le système risque de ne plus pouvoir être mis à jour par la suite ou risque d'être mis à jour avec des dépôts de paquetage incorrects.
    </para>
    <para>
     Assurez-vous que le système a accès à Internet avant de démarrer cette procédure.
    </para>
    <substeps>
     <step>
      <para>
       Rafraîchissez les dépôts et les services en exécutant la commande suivante :
      </para>
      <screen>sudo zypper ref -fs</screen>
     </step>
     <step>
      <para>
       Obtenez une liste des dépôts actifs en exécutant la commande suivante :
      </para>
      <screen>sudo zypper lr</screen>
      <para>
       Vérifiez attentivement la sortie de cette commande. Aucun service ni dépôt ajoutés pour la mise à jour ne doivent être répertoriés. Si, par exemple, vous effectuez un retour à l'état initial à partir d'une migration de Service Pack de SLES 12 SP2 vers SLES 12 SP1, la liste ne doit <emphasis>pas</emphasis> contenir les dépôts <literal>SLES12-SP2-Pool</literal> ni <literal>SLES12-SP2-Updates</literal>, mais plutôt ceux des versions <literal>SP1</literal>.
      </para>
      <para>
       Si les dépôts répertoriés sont incorrects, assurez-vous de les supprimer et, si nécessaire, remplacez-les par les versions correspondant à votre version du produit ou du Service Pack. Pour obtenir la liste des dépôts et les chemins de migration pris en charge, reportez-vous à la <xref linkend="sec.update.nmm.repositories"/>.
      </para>
     </step>
     <step>
      <para>
       Enfin, vérifiez l'état d'enregistrement de tous les produits installés en exécutant la commande suivante :
      </para>
      <screen>SUSEConnect --status</screen>
      <para>
       Tous les produits doivent être signalés comme étant <literal>Enregistré</literal>. Si ce n'est pas le cas, réparez l'enregistrement en exécutant la commande
      </para>
      <screen>SUSEConnect --rollback</screen>
     </step>
    </substeps>
   </step>
  </procedure>
  <para>
   Vous avez à présent réinitialisé le système dans l'état capturé immédiatement avant le début de la migration du Service Pack.
  </para>
 </sect1>
</chapter>
