<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="transactional_updates.xml" version="5.0" xml:id="cha-transactional-updates" xml:lang="zh-tw">
 <title>交易更新</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    交易更新在 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 中以技術預覽形式提供，當根檔案系統為唯讀時，可使用技術更新來更新 SLES。交易更新具有原子性 (僅當所有更新都成功時，才會套用所有更新)，且支援復原。它不影響正在執行的系統，因為只有在將系統重新開機後，才會啟用變更。由於重新開機是中斷性操作，管理員必須判定重新開機的開銷是否高於中斷正在執行服務的開銷。如果重新開機的開銷過高，則不要使用交易更新。
   </para>

   <para>
    交易更新由 <command>transactional-update</command> 程序檔每天執行。該程序檔將檢查可用的更新。如果存在任何更新，則它會在背景中建立根檔案系統的新快照，然後從發行通道擷取更新。完全更新新快照後，該快照將被標示為作用中快照，並在下一次將系統重新開機後，成為新的預設根檔案系統。當 <command>transactional-update</command> 設定為自動執行 (預設行為) 時，該程序檔還會將系統重新開機。更新執行時間以及重新開機維護時間均為可設定組態。
   </para>

   <para>
    只能更新屬於根檔案系統快照的套件。如果套件中包含不屬於該快照的檔案，更新可能會失敗或中斷系統。
   </para>

   <para>
    無法更新需要接受授權的 RPM。
   </para>
  </abstract>
 </info>
 
 <sect1 xml:id="sec-tu-limitations">
  <title>技術預覽的限制</title>

  <para>
   技術預覽的功能存在某些限制。<command>transactional-update</command> 對於以下套件不起作用：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     <package>nginx</package> 的預設 index.html 頁面可能不可用
    </para>
   </listitem>
   <listitem>
    <para>
     <package>tomcat-webapps</package> 和 <package>tomcat-admin-webapps</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>phpMyAdmin</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>sca-appliance-*</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>mpi-selector</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>emacs</package> 可正常運作 (Emacs 遊戲除外)
    </para>
   </listitem>
   <listitem>
    <para>
     <package>bind</package> 和 <package>bind-chrootenv</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>docbook*</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>sblim-sfcb*</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>texlive*</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>iso_ent</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>openjade</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>opensp</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>pcp</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>plymouth</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>postgresql-server-10</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>pulseaudio-gdm-hooks</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>smartmontools</package>
    </para>
   </listitem>
  </itemizedlist>

  <para>
   系統安裝程式的更新程式元件不適用於唯讀檔案系統，因為此類檔案系統不支援交易更新。
  </para>

  <para>
   其他注意事項：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     一般情況下，最好在更新系統之後儘早將機器重新開機。
    </para>
   </listitem>
   <listitem>
    <para>
     每次只能套用一項更新。在套用一項更新之後直至套用下一項更新之前，請務必重新開機。
    </para>
   </listitem>
   <listitem>
    <para>
     在交易更新之後直至將機器重新開機，都不應執行 <command>update-alternatives</command>。
    </para>
   </listitem>
   <listitem>
    <para>
     在交易更新之後直至重新開機，都不要建立新的系統使用者或系統群組。允許建立一般使用者和群組 (UID &gt; 1000，GID &gt; 1000)。
    </para>
   </listitem>
   <listitem>
    <para>
     YaST 尚不能識別交易更新。如果 YaST 模組需要安裝額外的套件，此操作將無法正常執行。而只是修改 <filename>/etc</filename> 中組態檔案的一般系統操作可正常進行。
    </para>
   </listitem>
   <listitem>
    <para>
     對於 <package>php7-fastcgi</package>，必須以手動方式建立指向 <filename>/usr/bin/php-cgi</filename> 的符號連結 <filename>/srv/www/cgi-bin/php</filename>。
    </para>
   </listitem>
   <listitem>
    <para>
     <package>ntp</package> 是要從較舊 SLES 版本移轉的 Legacy Module 的一部分。新的 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 安裝中已不再支援，且已被 <package>chrony</package> 取代。如果您繼續使用 <package>ntp</package>，需要進行全新安裝才能正常使用交易更新。
    </para>
   </listitem>
   <listitem>
    <para>
     <package>sblim-sfcb</package>：整個 sblim 生態系統都與交易更新不相容。
    </para>
   </listitem>
   <listitem>
    <para>
     <package>btrfsmaintenance</package> 套件中的 <command>btrfs-defrag</command> 無法與唯讀根檔案系統配合使用。
    </para>
   </listitem>
   <listitem>
    <para>
     對於 <command>btrfs-balance</command>，<filename>/etc/sysconfig/btrfsmaintenance</filename> 中的變數 <literal>BTRFS_BALANCE_MOUNTPOINTS</literal> 必須從 <literal>/</literal> 變更為 <literal>/.snapshots</literal>。
    </para>
   </listitem>
   <listitem>
    <para>
     對於 <command>btrfs-scrub</command>，<filename>/etc/sysconfig/btrfsmaintenance</filename> 中的變數 <literal>BTRFS_SCRUB_MOUNTPOINTS</literal> 必須從 <literal>/</literal> 變更為 <literal>/.snapshots</literal>。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec-install-tu">
  <title>啟用 <package>transactional-update</package></title>
  <para>
   必須在系統安裝期間啟用 Transactional Server 模組，然後選取 Transactional Server 系統角色。不支援稍後再於正在執行的系統中從 Transactional Server 模組安裝任何套件，此操作可能會使系統中斷。
  </para>
  <para>
      請注意，不支援變更根分割區的子磁碟區配置，或者將根分割區的子目錄或子磁碟區置於其各自的分割區中 (<filename>/home</filename>、<filename>/var</filename>、<filename>/srv</filename> 和 <filename>/opt</filename> 除外)，此類操作很可能會使系統中斷。
  </para>
 </sect1>
 
  <sect1 xml:id="sec-tu-disable">
  <title>管理自動更新</title>
  <para>
      自動更新由每天執行一次的 <command>systemd.timer</command> 控制。此操作會套用所有更新，並告知 <command>rebootmgrd</command> 應將機器重新開機。您可以調整更新的執行時間，具體請參閱「systemd.timer(5)」。若要調整維護時間 (即 <command>rebootmgrd</command> 將系統重新開機的時間)，請參閱「rebootmgrd(8)」。
  </para>
  <para>
   您可以使用以下指令停用自動交易更新：
  </para>

<screen><prompt role="root"># </prompt><command>systemctl --now disable transactional-update.timer</command></screen>
</sect1>
 
 <sect1>
  <title><command>transactional-update</command> 指令</title>
  <para>
   <command>transactional-update</command> 指令會啟用更新的原子性安裝或移除，即僅當所有更新都可以成功安裝時，才會套用這些更新。在套用更新之前，<command>transactional-update</command> 會建立系統的快照，您可以還原此快照。重新開機後，所有變更才會生效。
  </para>

<variablelist>
  <varlistentry>
   <term><literal>--continue</literal></term>
   <listitem>
     <para>
         可使用 <command>--continue</command> 選項對現有快照進行多次變更，而無需重新開機。
     </para>
     <para>
         預設的 <command>transactional-update</command> 行為是從目前根檔案系統建立新快照。如果您忘記執行某個操作，例如，忘記安裝某個新套件，必須重新開機以套用先前的變更，然後再次執行 <command>transactional-update</command> 以安裝忘記安裝的套件，並再次重新開機。不能在未進行重新開機的情況下多次執行 <command>transactional-update</command> 指令來向快照新增更多變更，因為這樣做只會建立多個獨立的快照，這些快照並不會包含先前快照中的變更。
     </para>
     <para>
         您可使用 <command>--continue</command> 選項在不重新開機的情況下，進行任意次數的變更。每次會建立一個獨立的快照，且每個快照都包含您在先前快照中進行的所有變更以及新的變更。視需要重複此程序任意次數，當最終快照包含所需的全部變更時，再將系統重新開機，然後最終快照便會成為新的根檔案系統。
     </para>
     <para>
         <command>--continue</command> 選項的另一個有用功能是，可讓您選取任一現有快照做為新快照的基礎快照。以下範例展示如何執行 <command>transactional-update</command> 在基於快照 13 的某個快照中安裝新套件，然後再次執行該指令來安裝另一個套件：
     </para>
     <screen><prompt role="root"># </prompt><command>transactional-update pkg install <replaceable>package_1</replaceable></command></screen>
    <screen><prompt role="root"># </prompt><command>transactional-update --continue 13 pkg install <replaceable>package_2</replaceable></command></screen>
    <para>
        <command>--continue [num]</command> 選項會呼叫 <command>snapper create --from</command>，請參閱<xref linkend="sec-snapper-manage-create"/>。
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><literal>cleanup</literal></term>
   <listitem>
  <para>
    如果目前的根檔案系統與作用中的根檔案系統相同 (在重新開機之後，<command>transactional-update</command> 建立包含更新的新快照之前)，將為沒有清理演算法的所有舊快照設定一個清理演算法。如此可確保 Snapper 會刪除舊快照。(請參閱「snapper(8)」中有關清理演算法的章節。)此操作還會移除 <filename>/var/lib/overlay</filename> 中所有未參考的 (因此也未使用) <filename>/etc</filename> 覆蓋目錄：
  </para>
<screen><prompt role="root"># </prompt><command>transactional-update cleanup</command></screen>
    </listitem>
   </varlistentry>  
   <varlistentry>
    <term><literal>pkg in/install</literal></term>
    <listitem>
     <para>
      使用 <command>zypper install</command> 指令從可用通道安裝個別套件。此指令還可用於安裝程式暫時修復 (PTF) RPM 檔案。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update pkg install <replaceable>package_name</replaceable></command></screen>
     <para>
      或
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update pkg install <replaceable>rpm1 rpm2</replaceable></command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>pkg rm/remove</literal></term>
    <listitem>
     <para>
      使用 <command>zypper remove</command> 指令從作用中快照移除個別套件。此指令還可用於移除 PTF RPM 檔案。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update pkg remove <replaceable>package_name</replaceable></command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>pkg up/update</literal></term>
    <listitem>
     <para>
      使用 <command>zypper update</command> 指令更新作用中快照中的個別套件。只能更新屬於基礎檔案系統快照一部份的套件。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update pkg remove <replaceable>package_name</replaceable></command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>up/update</literal></term>
    <listitem>
     <para>
      如果有新的可用更新，將會建立一個新快照，並使用 <command>zypper up/update</command> 更新該快照。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update up</command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>dup</literal></term>
    <listitem>
     <para>
      如果有新的可用更新，將會建立一個新快照，並使用 <command>zypper dup –no-allow-vendor-change</command> 更新該快照。然後，該快照將會啟用，並在重新開機後成為新的根檔案系統。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update dup</command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>patch</literal></term>
    <listitem>
     <para>
      如果有新的可用更新，將會建立一個新快照，並使用 <command>zypper patch</command> 更新該快照。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update patch</command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>rollback</literal></term>
    <listitem>
     <para>
      此選項會設定預設子磁碟區。在使用讀取/寫入檔案系統的系統上可呼叫 <command>snapper rollback</command>。在唯讀檔案系統上，如果未提供任何引數，目前系統將設定為新的預設根檔案系統。如果您指定了編號，則該快照將用做預設的根檔案系統。在唯讀檔案系統上，不會建立任何額外快照。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update rollback <replaceable>snapshot_number</replaceable></command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>grub.cfg</literal></term>
    <listitem>
     <para>
      此選項會建立新的 GRUB2 組態。有時需要調整開機組態，例如，新增額外的核心參數。編輯 <replaceable>/etc/default/grub</replaceable>，執行 <command>transactional-update grub.cfg</command>，然後重新開機以啟用變更。您必須立即重新開機，否則，下一次執行 transactional-update 時會使用預設值覆寫新的 GRUB2 組態。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update grub.cfg</command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>reboot</literal></term>
    <listitem>
     <para>
      此參數在完成動作後會觸發重新開機。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update <replaceable>dup</replaceable> reboot</command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>--help</literal></term>
    <listitem>
     <para>
      此時會輸出包含選項和子指令的說明螢幕。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update --help</command></screen>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>

 <sect1 xml:id="sec-tu-troubleshooting">
  <title>疑難排解</title>

  <para>
   如果升級失敗，請執行 <command>supportconfig</command> 來收集記錄資料。將產生的檔案 (包括 <filename>/var/log/transactional-update.log</filename>) 提供給 SUSE 支援人員。
  </para>
 </sect1>
</chapter>
