<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_bonding.xml" version="5.0" xml:id="sec.bond">
 <title>Einrichten von Bonding-Geräten</title>

 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>Ja</dm:translation>
  </dm:docmanager>
 </info>

 <para>
  Für bestimmte Systeme sind Netzwerkverbindungen erforderlich, die die normalen Anforderungen an die Datensicherheit oder Verfügbarkeit von typischen Ethernet-Geräten übertreffen. In diesen Fällen lassen sich mehrere Ethernet-Geräte zu einem einzigen Bonding-Gerät zusammenschließen.
 </para>

 <para>
  Die Konfiguration des Bonding-Geräts erfolgt dabei über die Bonding-Moduloptionen. Das Verhalten ergibt sich im wesentlichen aus dem Modus des Bonding-Geräts. Standardmäßig gilt <systemitem>mode=active-backup</systemitem>; wenn das aktive Slave-Gerät ausfällt, wird also ein anderes Slave-Gerät aktiviert.
 </para>

 <tip>
  <title>Bonding und Xen</title>
  <para>
   Der Einsatz von Bonding-Geräten empfiehlt sich nur für Computer, in denen mehrere physische Netzwerkkarten eingebaut sind. Bei den meisten Konstellationen sollten Sie die Bonding-Konfiguration daher lediglich in Dom0 verwenden. Die Bond-Einrichtung in einem VM-Gast-System ist dabei nur dann sinnvoll, wenn dem VM-Gast mehrere Netzwerkkarten zugewiesen sind.
  </para>
 </tip>

 <para>
  Zum Konfigurieren eines Bonding-Geräts gehen Sie wie folgt vor:
 </para>

 <procedure>
  <step>
   <para>
    Führen Sie <menuchoice><guimenu>YaST</guimenu> <guimenu>System</guimenu> <guimenu>Netzwerkeinstellungen</guimenu></menuchoice> aus.
   </para>
  </step>
  <step>
   <para>
    Wählen Sie <guimenu>Hinzufügen</guimenu> und ändern Sie die Einstellung unter <guimenu>Gerätetyp</guimenu> in <guimenu>Bond</guimenu>. Fahren Sie mit <guimenu>Weiter</guimenu> fort.
   </para>
   <informalfigure>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="bond_configuration.png" width="70%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="bond_configuration.png" width="65%" format="PNG"/>
     </imageobject>
    </mediaobject>
   </informalfigure>
  </step>
  <step>
   <para>
    Geben Sie an, wie dem Bonding-Gerät eine IP-Adresse zugewiesen werden soll. Hierfür stehen drei Methoden zur Auswahl:
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      No IP Address (Keine IP-Adresse)
     </para>
    </listitem>
    <listitem>
     <para>
      Dynamic Address (with DHCP or Zeroconf) (Dynamische Adresse (mit DHCP oder Zeroconf))
     </para>
    </listitem>
    <listitem>
     <para>
      Statisch zugewiesene IP-Adresse
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Wählen Sie die passende Methode für Ihre Umgebung aus.
   </para>
  </step>
  <step>
   <para>
    Wählen Sie auf dem Karteireiter <guimenu>Bond-Slaves</guimenu> die Ethernet-Geräte aus, die in den Bond aufgenommen werden sollen. Aktivieren Sie hierzu die entsprechenden Kontrollkästchen.
   </para>
  </step>
  <step>
   <para>
    Bearbeiten Sie die Einstellungen unter <guimenu>Bond-Treiberoptionen</guimenu>. Für die Konfiguration stehen die folgenden Modi zur Auswahl:
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      balance-rr
     </para>
    </listitem>
    <listitem>
     <para>
      active-backup
     </para>
    </listitem>
    <listitem>
     <para>
      balance-xor
     </para>
    </listitem>
    <listitem>
     <para>
      Rundsendung
     </para>
    </listitem>
    <listitem>
     <para>
      802.3ad
     </para>
     <para>
      <literal>802.3ad</literal> ist der standardisierte LACP-Modus mit <quote>dynamischer Link-Aggregation nach IEEE 802.3ad</quote>.
     </para>
    </listitem>
    <listitem>
     <para>
      balance-tlb
     </para>
    </listitem>
    <listitem>
     <para>
      balance-alb
     </para>
    </listitem>
   </itemizedlist>
  </step>
  <step>
   <para>
    Der Parameter <literal>miimon=100</literal> muss unter <guimenu>Bond-Treiberoptionen</guimenu> angegeben werden. Ohne diesen Parameter wird die Datenintegrität nicht regelmäßig überprüft.
   </para>
  </step>
  <step>
   <para>
    Klicken Sie auf <guimenu>Weiter</guimenu>, und beenden Sie YaST mit <guimenu>OK</guimenu>. Das Gerät wird erstellt.
   </para>
  </step>
 </procedure>

 <para>
  Alle Modi und viele weitere Optionen werden ausführlich im Dokument <guimenu>Linux Ethernet Bonding Driver HOWTO</guimenu> erläutert, das nach der Installation des Pakets <systemitem>kernel-source</systemitem> unter <filename>/usr/src/linux/Documentation/networking/bonding.txt</filename> verfügbar ist.
 </para>

 <sect2 xml:id="sec.bond.hotplug">
  <title>Hot-Plugging von Bonding-Slaves</title>
  <para>
   In bestimmten Netzwerkumgebungen (z. B. High Availability) muss eine Bonding-Slave-Schnittstelle durch eine andere Schnittstelle ersetzt werden. Dieser Fall tritt beispielsweise ein, wenn ein Netzwerkgerät wiederholt ausfällt. Die Lösung ist hier das Hot-Plugging der Bonding-Slaves.
  </para>
  <para>
   Der Bond wird wie gewohnt konfiguriert (gemäß <command>man 5 ifcfg-bonding</command>), beispielsweise:
  </para>
<screen>ifcfg-bond0
          STARTMODE='auto' # or 'onboot'
          BOOTPROTO='static'
          IPADDR='192.168.0.1/24'
          BONDING_MASTER='yes'
          BONDING_SLAVE_0='eth0'
          BONDING_SLAVE_1='eth1'
          BONDING_MODULE_OPTS='mode=active-backup miimon=100'</screen>
  <para>
   Die Slaves werden mit <literal>STARTMODE=hotplug</literal> und <literal>BOOTPROTO=none</literal> angegeben:
  </para>
<screen>ifcfg-eth0
          STARTMODE='hotplug'
          BOOTPROTO='none'

ifcfg-eth1
          STARTMODE='hotplug'
          BOOTPROTO='none'</screen>

  <para>
   Bei <literal>BOOTPROTO=none</literal><command/> werden die ethtool-Optionen herangezogen (sofern bereitgestellt), es wird jedoch kein Link zu <command>ifup eth0 eingerichtet</command>. Dies ist darin begründet, dass die Slave-Schnittstelle durch den Bond-Master gesteuert wird.
  </para>
  <para>
   Bei <literal>STARTMODE=hotplug</literal> wird die Slave-Schnittstelle dem Bond automatisch zugefügt, wenn diese verfügbar ist.
  </para>
  <para>
   Die <systemitem>udev</systemitem>-Regeln unter <filename>/etc/udev/rules.d/70-persistent-net.rules</filename> müssen so geändert werden, dass das Gerät über die Bus-ID (udev-Schlüsselwort <systemitem>KERNELS</systemitem> „SysFS BusID“ wie in <command>hwinfo --netcard</command>) statt über die MAC-Adresse angesteuert wird, damit fehlerhafte Hardware ausgetauscht werden kann (Netzwerkkarte im gleichen Steckplatz, jedoch mit anderer MAC) und Verwirrung vermieden wird, da der Bond die MAC-Adresse aller Slaves ändert.
  </para>
  <para>
   Beispiel:
  </para>
<screen>SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*",
KERNELS=="0000:00:19.0", ATTR{dev_id}=="0x0", ATTR{type}=="1",
KERNEL=="eth*", NAME="eth0"</screen>
  <para>
   Beim Booten wartet der systemd-Service <systemitem>network.service</systemitem> nicht darauf, dass die Hot-Plug-Slaves einsatzbereit sind, sondern es wird die Bereitschaft des gesamten Bonds abgewartet, wofür mindestens ein verfügbarer Slave erforderlich ist. Wenn eine Slave-Schnittstelle aus dem System entfernt wird (durch Aufheben der Bindung an den NIC-Treiber, durch <command>rmmod</command> des NIC-Treibers oder durch normales PCI-Hot-Plug-Entfernen), so entfernt der Kernel die betreffende Schnittstelle automatisch aus dem Bond. Wird eine neue Karte in das System eingebaut (Austausch der Hardware im Steckplatz), benennt <systemitem>udev</systemitem> diese Karte anhand der Regel für busgestützte permanente Namen in den Namen des Slaves um und ruft <command>ifup</command> für die Karte auf. Mit dem <command>ifup</command>-Aufruf tritt die Karte automatisch in den Bond ein. <remark>
    ke: I think this can stay that way for now.
   </remark>
  </para>
 </sect2>


</sect1>
