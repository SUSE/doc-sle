<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="xen_virtualization_vhost.xml" version="5.0" xml:id="cha-xen-vhost">
  <title>设置虚拟机主机</title>
  <info>
    <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
      <dm:bugtracker/>
      <dm:translation>yes</dm:translation>
    </dm:docmanager>
  </info>
  <para>
    本节介绍如何设置并使用 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> <phrase role="productnumber"><phrase os="sles;sled">15 SP5</phrase></phrase> 作为虚拟机主机。
  </para>
  <para>
    Dom0 的硬件要求通常与 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 操作系统的硬件要求相同。应该添加额外的 CPU、磁盘、内存和网络资源才能满足规划的所有 VM Guest 系统的需求。
  </para>
  <tip>
    <title>资源</title>
    <para>
      请记住，如果 VM Guest 系统在更快的处理器上运行并且可以访问更多系统内存，其性能就会更好，这与物理机一样。
    </para>
  </tip>
  
  <para>
    虚拟机主机要求安装多个软件包及其依赖项。要安装全部所需的软件包，请运行 YaST <guimenu>软件管理</guimenu>，选择<menuchoice><guimenu>视图</guimenu>
    <guimenu>软件集</guimenu></menuchoice>，然后选择 <guimenu>Xen 虚拟机主机服务器</guimenu>进行安装。也可以在 YaST 中使用模块<menuchoice><guimenu>虚拟化</guimenu><guimenu>安装超级管理程序和工具</guimenu></menuchoice>来执行安装。
  </para>
  <para>
    安装 Xen 软件后，重启动计算机，并在引导屏幕上选择新添加的具有 Xen 内核的选项。
  </para>
  <para>
    通过更新通道可使用更新。为了确保安装最新的更新，请在完成安装后运行 YaST <guimenu>联机更新</guimenu>。
  </para>
  <sect1 xml:id="sec-xen-vhost-best">
    <title>最佳实践和建议</title>

    <para>
      在主机上安装并配置 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 操作系统后，请实施以下最佳实践和建议：
    </para>

    <itemizedlist mark="bullet" spacing="normal">
      <listitem>
        <para>
          如果该主机应始终作为 Xen 主机运行，请运行 YaST <menuchoice>
          <guimenu>系统</guimenu> <guimenu>引导加载程序</guimenu>
          </menuchoice>，并激活 Xen 引导项作为默认引导部分。
        </para>
        <itemizedlist mark="bullet" spacing="normal">
          <listitem>
            <para>
              在 YaST 中单击<guimenu>系统 &gt; 引导加载程序</guimenu>。
            </para>
          </listitem>
          <listitem>
            <para>
              将默认引导更改为 <guimenu>Xen</guimenu> 标签，然后单击<guimenu>设置为默认值</guimenu>。
            </para>
          </listitem>
          <listitem>
            <para>
              单击<guimenu>完成</guimenu>。
            </para>
          </listitem>
        </itemizedlist>
      </listitem>
      <listitem>
        <para>
          为获得最佳性能，请仅在虚拟机主机上安装虚拟化所需的应用程序和进程。
        </para>
      </listitem>
      <listitem>
        <para>
          如果您打算使用挂接到 Xen 主机的检查包设备，请每次仅使用一个设备。建议使用提供实际硬件集成的驱动程序，而不要使用通用软件驱动程序。
        </para>
      </listitem>
    </itemizedlist>

    <note>
      
      <title>硬件监视</title>
      <para>
        Dom0 内核以虚拟化模式运行，因此 <command>irqbalance</command> 或 <command>lscpu</command> 等工具不会反映真实的硬件特征。
      </para>
    </note>
  </sect1>
  <sect1 xml:id="sec-xen-vhost-memory">
    <title>管理 Dom0 内存</title>

    <para>
      在以前的 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 版本中，Xen 主机的默认内存分配模式是将所有主机物理内存都分配给 Dom0，并启用自动气球式调节功能。当有其他域启动后，内存会自动从 Dom0 进行气球式调节。此行为总是容易出错，因此强烈建议将其禁用。从 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> <phrase os="sles;sled">15 SP1</phrase> 开始，默认已禁用自动气球式调节，而是为 Dom0 分配 10% 的主机物理内存外加 1GB。例如，在物理内存大小为 32 GB 的主机上，将为 Dom0 分配 4.2 GB 内存。
    </para>

    <para>
      我们仍支持并建议在 <filename>/etc/default/grub</filename> 中使用 <option>dom0_mem</option> Xen 命令行选项。可以通过将 <option>dom0_mem</option> 设置为主机物理内存大小，并在 <filename>/etc/xen/xl.conf</filename> 中启用 <option>autoballoon</option> 设置，来恢复旧行为。
    </para>

    <warning>
      <title>Dom0 内存不足</title>
      <para>
        为 Dom0 保留的内存量取决于主机上运行的 VM Guest 数量，因为 Dom0 会为每个 VM Guest 提供后端网络和磁盘 I/O 服务。计算 Dom0 内存分配时，还应考虑到 Dom0 中运行的其他工作负载。一般而言，应该像确定任何其他虚拟机的内存大小一样来确定 Dom0 的内存大小。
      </para>
    </warning>

    <sect2 xml:id="sec-xen-vhost-maxmem">
      <title>设置 Dom0 内存分配</title>
      <procedure>
        <step>
          <para>
            确定需要为 Dom0 分配的内存。
          </para>
        </step>
        <step>
          <para>
            在 Dom0 中，键入 <command>xl info</command> 以查看计算机上可用的内存量。可以使用 <command>xl list</command> 命令确定当前为 Dom0 分配的内存。
          </para>
        </step>
        <step>
          <para>
            编辑 <filename>/etc/default/grub</filename> 并调整 <option>GRUB_CMDLINE_XEN</option> 选项，使其包含 <literal>dom0_mem=<replaceable>MEM_AMOUNT</replaceable></literal>。将 <replaceable>MEM_AMOUNT</replaceable> 替换为要分配给 Dom0 的最大内存量。添加 <command>K</command>、<command>M</command> 或 <command>G</command> 以指定大小单位。例如：
          </para>
<screen>GRUB_CMDLINE_XEN="dom0_mem=2G"</screen>
        </step>
        <step>
          <para>
            重启动计算机以应用更改。
          </para>
        </step>
      </procedure>
      <tip>
        <para>
          有关 Xen 相关引导配置选项的更多细节，请参见<xref linkend="sec-grub2-etc-default-grub"/>。
        </para>
      </tip>
      <warning>
        <title>Xen Dom0 内存</title>
        <para>
          对 GRUB 2 中的 Xen 超级管理程序使用 XL 工具堆栈和 <command>dom0_mem=</command> 选项时，需在 <filename>etc/xen/xl.conf</filename> 中禁用 xl <emphasis>autoballoon</emphasis>。否则，启动 VM 时将会失败，并出现有关无法压缩 Dom0 内存气球的错误。因此，如果您为 Xen 指定了 <command>dom0_mem=</command> 选项，请在 <filename>xl.conf</filename> 中添加 <emphasis>autoballoon=0</emphasis>。另请参见 <link xlink:href="http://wiki.xen.org/wiki/Xen_Best_Practices#Xen_dom0_dedicated_memory_and_preventing_dom0_memory_ballooning">Xen
          dom0 memory</link>
        </para>
      </warning>
    </sect2>
  </sect1>
  <sect1 xml:id="sec-xen-vhost-netcard">
    <title>全虚拟化 Guest 中的网卡</title>

    <para>
      在全虚拟化 Guest 中，默认网卡是一个模拟的 Realtek 网卡。不过，您也可以使用分离式网络驱动程序来管理 Dom0 与 VM Guest 之间的通讯。默认情况下，这两个接口都会呈现给 VM Guest，因为某些操作系统的驱动程序要求这两个接口都存在。
    </para>

    <para>
      使用 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 时，默认只有半虚拟化网卡可供 VM Guest 使用。可用的网络选项如下：
    </para>

    <variablelist>
      <varlistentry>
        <term>模拟</term>
        <listitem>
          <para>
            要使用模拟 Realtek 网卡之类的模拟网络接口，请在域 xl 配置的 <literal>vif</literal> 设备部分指定 <literal>type=ioemu</literal>。示例配置如下所示：
          </para>
<screen>vif = [ 'type=ioemu,mac=00:16:3e:5f:48:e4,bridge=br0' ]</screen>
          <para>
            <filename>xl.conf</filename> 手册页 <command>man 5
            xl.conf</command> 中提供了有关 xl 配置的更多细节。
          </para>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>半虚拟化</term>
        <listitem>
          <para>
            如果指定 <literal>type=vif</literal> 但不指定型号或类型，将使用半虚拟化网络接口：
          </para>
<screen>vif = [ 'type=vif,mac=00:16:3e:5f:48:e4,bridge=br0,backen=0' ]</screen>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>模拟和半虚拟化</term>
        <listitem>
          <para>
            如果要为管理员提供上述两个选项，只需同时指定类型和型号即可。xl 配置如下所示：
          </para>
<screen>vif = [ 'type=ioemu,mac=00:16:3e:5f:48:e4,model=rtl8139,bridge=br0' ]</screen>
          <para>
            在这种情况下，应在 VM Guest 上禁用其中一个网络接口。
          </para>
        </listitem>
      </varlistentry>
    </variablelist>
  </sect1>
  <sect1 xml:id="sec-xen-vhost-start">
    <title>启动虚拟机主机</title>

    <para>
      如果正确安装了虚拟化软件，计算机引导时会显示 GRUB 2 引导加载程序，且其菜单中会包含 <guimenu>Xen</guimenu> 选项。选择此选项即可启动虚拟机主机。
    </para>

    <warning>
      <para>
        引导 Xen 系统时，dom0 的 /var/log/messages 日志文件或 <systemitem class="daemon">systemd</systemitem> 日志中可能会出现如下所示的错误消息：
      </para>
<screen>
isst_if_mbox_pci: probe of 0000:ff:1e.1 failed with error -5
isst_if_pci: probe of 0000:fe:00.1 failed with error -5
</screen>
      <para>
        请忽略这些消息，因为它们是无害的，其原因是 ISST 驱动程序无法为虚拟机提供任何电源或频率调节功能。
      </para>
    </warning>

    <note>
      <title>Xen 和 Kdump</title>
      <para>
        在 Xen 中，超级管理程序会管理内存资源。如果您需要为 Dom0 中的恢复内核保留系统内存，需由超级管理程序保留此内存。因此，需要将参数 <systemitem>crashkernel=size</systemitem> 添加到 <literal>kernel</literal> 行，而不能在该行中使用其他引导参数。
      </para>
      <para>
        有关 crashkernel 参数的详细信息,请参见<xref linkend="sec-tuning-kexec-crashkernel"/>。
      </para>
    </note>

    <para>
      如果 GRUB 2 菜单中不包含 <guimenu>Xen</guimenu> 选项，请检查安装步骤，并校验是否已更新 GRUB 2 引导加载程序。如果安装是在未选择 Xen 软件集的情况下完成的，请运行 YaST <guimenu>软件管理</guimenu>，选择<guimenu>软件集</guimenu>过滤器，然后选择 <guimenu>Xen 虚拟机主机服务器</guimenu>进行安装。
    </para>

    <para>
      引导超级管理程序后，Dom0 虚拟机将会启动并显示其图形桌面环境。如果您未安装图形桌面，则会显示命令行环境。
    </para>

    <tip>
      <title>图形问题</title>
      <para>
        有时可能会发生图形系统无法正常工作的问题。在这种情况下，请将 <literal>vga=ask</literal> 添加到引导参数。要激活永久设置，请使用 <literal>vga=mode-0x???</literal>，其中 <literal>???</literal> 的计算方式为 <literal>0x100</literal> + <link xlink:href="http://en.wikipedia.org/wiki/VESA_BIOS_Extensions"/> 中所述的 VESA 模式，例如 <literal>vga=mode-0x361</literal>。
      </para>
    </tip>

    <para>
      在开始安装虚拟 Guest 之前，请确保系统时间正确。为此，请在控制域上配置 NTP（网络时间协议）：
    </para>

    <procedure>
      <step>
        <para>
          在 YaST 中选择<menuchoice> <guimenu>网络服务</guimenu>
          <guimenu>NTP 配置</guimenu> </menuchoice>。
        </para>
      </step>
      <step>
        <para>
          选择在引导期间自动启动 NTP 守护程序的选项。提供现有 NTP 时间服务器的 IP 地址，然后单击<guimenu>完成</guimenu>。
        </para>
      </step>
    </procedure>

    <note>
      <title>虚拟 Guest 上的时间服务</title>
      <para>
        硬件时钟并不精确。所有新式操作系统都会尝试通过一个额外的时间源来更正系统时间（对比硬件时间）。要使所有 VM Guest 系统上的时间正确，请也在每个相应 Guest 上激活网络时间服务，或确保 Guest 使用主机的系统时间。有关 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 中的<literal>Independent Wallclocks</literal>的详细信息，请参见<xref linkend="sec-xen-guests-suse-time"/>。
      </para>
    </note>

    <para>
      有关管理虚拟机的详细信息，请参见<xref linkend="cha-xen-manage"/>。
    </para>
  </sect1>
  <sect1 xml:id="sec-xen-vhost-pciback">
    <title>PCI 直通</title>

    <para>
      为了充分利用 VM Guest 系统，有时需要将特定的 PCI 设备指派给专用的域。如果使用的是全虚拟化 Guest，仅当系统的芯片组支持并且已在 BIOS 中激活此功能时，此功能才可用。
    </para>

    <para>
      AMD* 和 Intel* 都提供此功能。对于 AMD 计算机，此功能称为 <xref linkend="gloss-vt-acronym-iommu"/>。对于 Intel 而言，此功能称为 <xref linkend="gloss-vt-acronym-vtd"/>。请注意，具备 Intel-VT 技术还不足以对全虚拟化 Guest 使用此功能。为确保您的计算机支持此功能，需专门要求您的供应商提供一个支持 PCI 直通的系统。
    </para>

    <itemizedlist mark="bullet" spacing="normal">
      <title>限制</title>
      <listitem>
        <para>
          有些图形驱动程序使用高度优化的方法来访问 DMA。这种方法不受支持，因此使用显卡可能会存在问题。
        </para>
      </listitem>
      <listitem>
        <para>
          访问 <xref linkend="gloss-vt-acronym-pcie"/> 网桥后面的 PCI 设备时，必须将所有 PCI 设备都指派到单个 Guest。这项限制不适用于 <xref linkend="gloss-vt-acronym-pcie"/> 设备。
        </para>
      </listitem>
      <listitem>
        <para>
          具有专用 PCI 设备的 Guest 无法实时迁移到其他主机。
        </para>
      </listitem>
    </itemizedlist>

    <para>
      PCI 直通的配置要兼顾两个方面。首先，在引导时必须告知超级管理程序应使某个 PCI 设备可供重新指派。其次，必须将该 PCI 设备指派给 VM Guest。
    </para>

    <sect2 xml:id="config-hypervisor-pciback">
      <title>配置超级管理程序以使用 PCI 直通</title>
      <procedure>
        <step>
          <para>
            选择要重指派给 VM Guest 的设备。为此，请运行 <command>lspci -k</command>，并读取设备编号以及指派给该设备的原始模块的名称：
          </para>
<screen>06:01.0 Ethernet controller: Intel Corporation Ethernet Connection I217-LM (rev 05)
        Subsystem: Dell Device 0617
        Kernel driver in use: e1000e
        Kernel modules: e1000e</screen>
          <para>
            在本例中，PCI 编号为 <literal>(06:01.0)</literal>，相关的内核模块为 <literal>e1000e</literal>。
          </para>
        </step>
        <step>
          <para>
            指定模块依赖项以确保 <systemitem>xen_pciback</systemitem> 是用于控制设备的第一个模块。添加包含以下内容的 <filename>/etc/modprobe.d/50-e1000e.conf</filename> 文件：
          </para>
<screen>install e1000e /sbin/modprobe xen_pciback ; /sbin/modprobe \
 --first-time --ignore-install e1000e</screen>
        </step>
        <step>
          <para>
            指示 <systemitem>xen_pciback</systemitem> 模块使用 <literal>hide</literal> 选项来控制设备。编辑或创建包含以下内容的 <filename>/etc/modprobe.d/50-xen-pciback.conf</filename> 文件：
          </para>
<screen>options xen_pciback hide=(06:01.0)</screen>
        </step>
        <step>
          <para>
            重新启动系统。
          </para>
        </step>
        <step>
          <para>
            使用以下命令检查该设备是否在可指派设备列表中
          </para>
<screen>xl pci-assignable-list</screen>
        </step>
      </procedure>
      <sect3 xml:id="config-hypervisor-pciback-xl">
        <title>通过 xl 进行动态指派</title>
        <para>
          为了避免重启动主机系统，您可以利用通过 xl 进行的动态指派来使用 PCI 直通。
        </para>
        <para>
          首先确保 Dom0 中已装载 pciback 模块：
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> modprobe pciback</screen>
        <para>
          然后使用 <command>xl
          pci-assignable-add</command> 使设备可供指派。例如，要使设备 <emphasis>06:01.0</emphasis> 可供 Guest 使用，请运行以下命令：
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> xl pci-assignable-add 06:01.0</screen>
      </sect3>
    </sect2>

    <sect2 xml:id="config-hypervisor-pciback-guests">
      <title>将 PCI 设备指派给 VM Guest 系统</title>
      <para>
        可通过多种方法来使 PCI 设备专用于某个 VM Guest：
      </para>
      <variablelist>
        <varlistentry>
          <term>安装时添加该设备：</term>
          <listitem>
            <para>
              在安装期间，在配置文件中添加 <literal>pci</literal> 行：
            </para>
<screen>pci=['06:01.0']</screen>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term>将 PCI 设备热插入到 VM Guest 系统</term>
          <listitem>
            <para>
              可以使用 <literal>xl</literal> 命令即时添加或去除 PCI 设备。要将编号为 <literal>06:01.0</literal> 的设备添加到名为 <literal>sles12</literal> 的 Guest，请使用：
            </para>
<screen>xl pci-attach sles12 06:01.0</screen>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term>将 PCI 设备添加到 Xend</term>
          <listitem>
            <para>
              要将设备永久添加到 Guest，请在 Guest 配置文件中添加以下代码段：
            </para>
<screen>pci = [ '06:01.0,power_mgmt=1,permissive=1' ]</screen>
          </listitem>
        </varlistentry>
      </variablelist>
      <para>
        将 PCI 设备指派给 VM Guest 后，Guest 系统必须负责处理此设备的配置和设备驱动程序。
      </para>
    </sect2>

    <sect2 xml:id="config-hypervisor-vgaback">
      <title>VGA 直通</title>
      <para>
        Xen 4.0 和更高版本支持在全虚拟化 VM Guest 上实现 VGA 图形适配器直通。Guest 可以全面控制提供高性能全 3D 和视频加速的图形适配器。
      </para>
      <itemizedlist mark="bullet" spacing="normal">
        <title>限制</title>
        <listitem>
          <para>
            VGA 直通功能与 PCI 直通类似，因此也需要主板芯片组和 BIOS 提供 <xref linkend="gloss-vt-acronym-iommu"/>（或 Intel VT-d）支持。
          </para>
        </listitem>
        <listitem>
          <para>
            只有主图形适配器（打开计算机电源时使用的图形适配器）能够与 VGA 直通搭配使用。
          </para>
        </listitem>
        <listitem>
          <para>
            仅支持对全虚拟化 Guest 使用 VGA 直通。不支持半虚拟 (PV) Guest。
          </para>
        </listitem>
        <listitem>
          <para>
            不能在多个使用 VGA 直通的 VM Guest 之间共享显卡 — 显卡只能供一个 Guest 专用。
          </para>
        </listitem>
      </itemizedlist>
      <para>
        要启用 VGA 直通，请在全虚拟化 Guest 配置文件中添加以下设置：
      </para>
<screen>gfx_passthru=1
pci=['yy:zz.n']</screen>
      <para>
        其中，<literal>yy:zz.n</literal> 是使用 <command>lspci -v</command> 在 Dom0 上找到的 VGA 图形适配器的 PCI 控制器 ID。
      </para>
    </sect2>

    <sect2 xml:id="sec-xen-vm-known">
      <title>查错</title>
      <para>
        在某些情况下，安装 VM Guest 期间可能会出现问题。本节将描述多个已知问题及其解决方法。
      </para>
      <variablelist>
        <varlistentry>
          <term>系统在引导期间挂起</term>
          <listitem>
            <para>
              软件 I/O 转换缓冲区会提前在引导进程中分配一大块低速内存。如果内存请求超出了缓冲区大小，可能会导致引导进程挂起。要检查是否存在这种情况，请切换到控制台 10，并检查其输出是否包含如下所示的消息
            </para>
<screen>kernel: PCI-DMA: Out of SW-IOMMU space for 32768 bytes at device 000:01:02.0</screen>
            <para>
              在这种情况下，您需要增加 <literal>swiotlb</literal> 的大小。在 Dom0 的命令行中添加 <literal>swiotlb=<replaceable>VALUE</replaceable></literal>（其中 <replaceable>VALUE</replaceable> 指定为 slab 项数）。可以通过增大或减小该数字来找到适合计算机的最佳大小。
            </para>
          </listitem>
        </varlistentry>
      </variablelist>
      <note>
        <title>为 PV Guest 启用 swiotlb</title>
        <para>
          要在 PV Guest 上正常进行 PCI 设备的 DMA 访问，必须指定 <literal>swiotlb=force</literal> 内核参数。有关 IOMMU 和 <literal>swiotlb</literal> 选项的详细信息，请参见软件包 <systemitem>kernel-source</systemitem> 中的 <filename>boot-options.txt</filename> 文件。
        </para>
      </note>
    </sect2>

    <sect2 xml:id="sec-xen-vm-info">
      <title>更多信息</title>
      <para>
        互联网上的一些资源提供了有关 PCI 直通的有趣信息：
      </para>
      <itemizedlist mark="bullet" spacing="normal">
        <listitem>
          <para>
            <link xlink:href="https://wiki.xenproject.org/wiki/VTd_HowTo"/>
          </para>
        </listitem>
        <listitem>
          <para>
            <link xlink:href="http://software.intel.com/en-us/articles/intel-virtualization-technology-for-directed-io-vt-d-enhancing-intel-platforms-for-efficient-virtualization-of-io-devices/"/>
          </para>
        </listitem>
        <listitem>
          <para>
            <link xlink:href="http://support.amd.com/TechDocs/48882_IOMMU.pdf"/>
          </para>
        </listitem>
      </itemizedlist>
    </sect2>
  </sect1>
  <sect1 xml:id="sec-xen-vhost-usbpass">
    <title>USB 直通</title>

    <para>
      可通过两种方法将单个主机 USB 设备直通到 Guest。第一种方法是使用模拟的 USB 设备控制器，第二种方法是使用 PVUSB。
    </para>

    <sect2 xml:id="xen-usb-identify">
      <title>标识 USB 设备</title>
      <para>
        在将 USB 设备直通到 VM Guest 之前，需要先在 VM 主机服务器上标识该设备。使用 <command>lsusb</command> 命令列出主机系统上的 USB 设备：
      </para>
<screen><prompt role="root"># </prompt>lsusb
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 002 Device 003: ID 0461:4d15 Primax Electronics, Ltd Dell Optical Mouse
Bus 002 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub</screen>
      <para>
        例如，要直通 Dell 鼠标，请以 <literal>vendor_id:device_id</literal> (0461:4d15) 格式指定设备标记，或以 <literal>bus.device</literal> (2.3) 格式指定总线地址。请记得去除前导零，否则 <command>xl</command> 会将数字解释为八进制值。
      </para>
    </sect2>

    <sect2 xml:id="xen-usb-emulated">
      <title>模拟的 USB 设备</title>
      <para>
        在模拟的 USB 中，设备模型 (QEMU) 会向 Guest 呈现模拟的 USB 控制器。然后，将通过 Dom0 控制 USB 设备，而 USB 命令将在 VM Guest 与主机 USB 设备之间转换。此方法仅适用于全虚拟化域 (HVM)。
      </para>
      <para>
        使用 <option>usb=1</option> 选项启用模拟的 USB 集线器。然后使用 <literal>host:USBID</literal> 在配置文件中指定设备列表中的设备以及其他模拟的设备。例如：
      </para>
<screen>
usb=1
usbdevice=['tablet','host:2.3','host:0424:460']
</screen>
    </sect2>

    <sect2 xml:id="xen-usb-pv">
      <title>半虚拟化 PVUSB</title>
      <para>
        PVUSB 是以高性能方式实现从 Dom0 到虚拟化 Guest 的 USB 直通的新方法。借助 PVUSB，可以通过两种方式将 USB 设备添加到 Guest：
      </para>
      <itemizedlist>
        <listitem>
          <para>
            在创建域时通过配置文件添加
          </para>
        </listitem>
        <listitem>
          <para>
            当 VM 正在运行时通过热插入方式添加
          </para>
        </listitem>
      </itemizedlist>
      <para>
        PVUSB 使用半虚拟化前端和后端接口。PVUSB 支持 USB 1.1 和 USB 2.0，适用于 PV 和 HVM Guest。要使用 PVUSB，Guest 操作系统中需要有 USB 前端，并且 Dom0 中需要有 USB 后端或者 QEMU 中需要有 USB 后端。在 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 上，QEMU 已随附了 USB 后端。
        
      </para>
      <para>
        从 Xen 4.7 开始引入了 <command>xl</command> PVUSB 支持和热插入支持。
      </para>
      <para>
        在配置文件中，使用 <literal>usbctrl</literal> 和 <literal>usbdev</literal> 指定 USB 控制器和 USB 主机设备。例如，对于 HVM Guest：
      </para>
<screen>usbctrl=['type=qusb,version=2,ports=4', 'type=qusb,version=1,ports=4', ]
usbdev=['hostbus=2, hostaddr=1, controller=0,port=1', ]</screen>
      <note>
        <para>
          必须为 HVM Guest 的控制器指定 <literal>type=qusb</literal>。
        </para>
      </note>
      <para>
        要管理 PVUSB 设备的热插入，请使用 <literal>usbctrl-attach</literal>、<literal>usbctrl-detach</literal>、<literal>usb-list</literal>、<literal>usbdev-attach</literal> 和 <literal>usb-detach</literal> 子命令。例如：
      </para>
      <para>
        创建版本为 USB 1.1 并包含 8 个端口的 USB 控制器：
      </para>
<screen><prompt role="root"># </prompt>xl usbctrl-attach test_vm version=1 ports=8 type=qusb</screen>
      <para>
        在域中找到第一个可用的 controller:port，并将 busnum:devnum 为 2:3 的 USB 设备挂接到该端口；您也可以指定<literal>controller</literal>和<literal>port</literal>：
      </para>
<screen><prompt role="root"># </prompt>xl usbdev-attach test_vm hostbus=2 hostaddr=3</screen>
      <para>
        显示域中的所有 USB 控制器和 USB 设备：
      </para>
<screen><prompt role="root"># </prompt>xl usb-list test_vm
Devid  Type   BE  state usb-ver ports
0      qusb   0   1     1       8
  Port 1: Bus 002 Device 003
  Port 2:
  Port 3:
  Port 4:
  Port 5:
  Port 6:
  Port 7:
  Port 8:</screen>
      <para>
        分离控制器 0 端口 1 下的 USB 设备：
      </para>
<screen><prompt role="root"># </prompt>xl usbdev-detach test_vm 0 1</screen>
      <para>
        去除具有所示 <literal>dev_id</literal> 的 USB 控制器，以及其下的所有 USB 设备：
      </para>
<screen><prompt role="root"># </prompt>xl usbctrl-detach test_vm dev_id</screen>
      <para>
        有关详细信息，请参见<link xlink:href="https://wiki.xenproject.org/wiki/Xen_USB_Passthrough"/>。
      </para>
    </sect2>
  </sect1>
</chapter>
