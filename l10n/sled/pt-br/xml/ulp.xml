<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ulp.xml" version="5.0" xml:id="cha-ulp" xml:lang="pt-br">
 <title>Aplicação de patches ativos no espaço do usuário</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    Este documento descreve os princípios básicos e o uso da aplicação de patches ativos no espaço do usuário.
   </para>
  </abstract>
 </info>
 <sect1 xml:id="sec-ulp">
  <title>Sobre a aplicação de patches ativos no espaço do usuário</title>

  <para>
   A aplicação de patches ativos no espaço do usuário (ULP, Userspace Live Patching) refere-se ao processo de aplicar patches às bibliotecas usadas por um processo em execução sem o interromper. As operações de aplicação de patches ativos são executadas usando a ferramenta <systemitem>ulp</systemitem>, que faz parte do <systemitem>libpulp</systemitem>.
  </para>

  <para>
   O <systemitem>libpulp</systemitem> é uma estrutura que permite a aplicação de patches ativos no espaço do usuário. Ele consiste na biblioteca <systemitem>libpulp.so</systemitem> e em ferramentas que tornam possível aplicar patches ativos às bibliotecas (o binário <systemitem>ulp</systemitem>).
  </para>

  <sect2 xml:id="sec-ulp-prereqs">
   <title>Pré-requisitos</title>
   <para>
    Para que a ULP funcione, é necessário cumprir dois requisitos.
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Para que possa receber patches ativos , uma biblioteca deve ser compilada com o flag <option>-fpatchable-function-entry</option> do GCC. Não é necessária nenhuma mudança no código-fonte da biblioteca.
     </para>
    </listitem>
    <listitem>
     <para>
      Os processos devem pré-carregar a biblioteca <systemitem>libpulp.so</systemitem>.
     </para>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="sec-ulp-libpulp">
   <title>Usando o libpulp</title>
   <para>
    Para usar o <systemitem>libpulp</systemitem> com um aplicativo, você deve executar as seguintes etapas:
   </para>
   <orderedlist>
    <listitem>
     <para>
      Permita que uma biblioteca receba patches ativos.
     </para>
    </listitem>
    <listitem>
     <para>
      Ao iniciar o aplicativo, pré-carregue o <systemitem>libpulp</systemitem> usando o comando <command>LD_PRELOAD=/usr/lib64/libpulp.so ./<replaceable>APLICATIVO</replaceable></command>.
     </para>
    </listitem>
   </orderedlist>
   <sect3 xml:id="sec-ulp-prep-lib">
    <title>Preparando uma biblioteca para receber patch ativos</title>
    <para>
     Para que seja possível aplicar patches ativos a uma biblioteca, ela deve conter um prólogo <literal>NOP</literal> em todas as chamadas de função. O GCC versão 8 e posterior, bem como a versão do GCC que acompanha o SUSE Linux Enterprise Server, oferece a função <option>-fpatchable-function-entry</option> especificamente para essa finalidade. Portanto, na arquitetura AMD64/Intel 64, compilar uma biblioteca escrita em C com o flag <option>-fpatchable-function-entry=16,14</option> é suficiente para permitir que ela receba patches ativos.
    </para>
    <para>
     As bibliotecas glibc, libssl.so.1.1 e libcrypto.so.1.1 já podem receber patches ativos no SUSE Linux Enterprise 15 SP4.
    </para>
   </sect3>
   <sect3 xml:id="sec-ulp-livepatch-check">
    <title>Verificando se uma biblioteca pode receber patches ativos</title>
    <para>
     Para verificar se uma biblioteca pode receber patches ativos, use o seguinte comando:
    </para>
<screen>ulp livepatchable <replaceable>LIBRARY</replaceable></screen>
   </sect3>
   <sect3 xml:id="sec-ulp-apply-livepatch">
    <title>Aplicando patches ativos</title>
    <para>
     Os patches ativos são aplicados usando o comando <systemitem>ulp trigger</systemitem>, por exemplo:
    </para>
<screen>ulp trigger -p <replaceable>PID</replaceable> <replaceable>LIVEPATCH</replaceable>.ulp</screen>
    <para>
     Neste exemplo, o <literal>PID</literal> é do processo em execução que usa a biblioteca que recebrá o patch, e <literal>LIVEPATCH.ulp</literal> é o arquivo de patch ativo específico.
    </para>
    <para>
     A mensagem <literal>live patching succeeded</literal> indica que a operação de aplicação de patches ativos foi bem-sucedida.
    </para>
   </sect3>
   <sect3 xml:id="sec-ulp-revert-livepatch">
    <title>Revertendo patches ativos</title>
    <para>
     É possível usar o <command>ulp trigger</command> para reverter patches ativos. Há duas maneiras de reverter patches ativos. Você pode aplicar o patch <filename>.rev</filename> apropriado:
    </para>
<screen>ulp trigger -p <replaceable>PID</replaceable> <replaceable>LIVEPATCH</replaceable>.rev</screen>
    <para>
     Se preferir, remova todos os patches associados a uma biblioteca específica. Por exemplo:
    </para>
<screen>ulp trigger -p <replaceable>PID</replaceable> --revert-all=<replaceable>LIBRARY</replaceable></screen>
    <para>
     No exemplo acima, <replaceable>LIBRARY</replaceable> refere-se à biblioteca específica, por exemplo: <systemitem>libcrypto.so.1.1</systemitem>.
    </para>
    <para>
     A última abordagem pode ser útil quando o código-fonte do patch ativo original não está disponível ou para remover um determinado patch antigo e aplicar um novo, sem que o aplicativo de destino execute um código que talvez não seja seguro. Por exemplo:
    </para>
<screen>ulp trigger -p <replaceable>PID</replaceable>  --revert-all=libcrypto.so.1.1 new_livepatch2.ulp</screen>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-ulp-info">
  <title>Mais informações</title>

  <para>
   Há mais informações sobre o <systemitem>libpulp</systemitem> disponíveis no <link xlink:href="https://github.com/SUSE/libpulp">repositório Git</link> do projeto.
  </para>
 </sect1>
</chapter>
