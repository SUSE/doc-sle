<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="automated_upgrade.xml" version="5.0" xml:id="cha.update.auto" os="sles">
 <title>Upgrade automatizado do SUSE Linux Enterprise 11 SP2 para o 11 SP3</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:bugtracker>
        </dm:bugtracker>
        <dm:translation>yes (sim)</dm:translation>
      </dm:docmanager>
    </info>
    <para>
  O seguinte procedimento descreve como fazer um upgrade em massa autônomo do SUSE Linux Enterprise 11 SP2 para o SUSE Linux Enterprise 11 SP3. Várias etapas de preparação são necessárias para criar um perfil do AutoYaST adequado. Por fim, o AutoYaST executará o processo de upgrade.
 </para>
 <sect1 xml:id="sec.update.auto.prep_autoyast">
  <title>Preparando o perfil do AutoYaST</title>

  <para>
   O perfil do AutoYaST para o upgrade automatizado utiliza o mesmo formato de arquivo que a instalação do AutoYaST. Para obter mais informações sobre o AutoYaST, consulte o <xref linkend="cha.deployment.autoinst"/> e o <xref linkend="book.autoyast"/>.
  </para>

  <para>
   Entretanto, existem algumas partes do sistema (por exemplo, particionamento) em que não faz sentido haver configuração durante o upgrade. Por outro lado, é útil definir opções específicas de upgrade pelo perfil do AutoYaST.
  </para>

  <sect2>
   <title>Upgrade</title>
   <para>
    As opções de upgrade definem o comportamento do solver de dependências durante o upgrade:
   </para>
<screen>&lt;upgrade&gt;
  &lt;only_installed_packages
    config:type="boolean"&gt;false&lt;/only_installed_packages&gt;
  &lt;stop_on_solver_conflict
    config:type="boolean"&gt;true&lt;/stop_on_solver_conflict&gt;
&lt;/upgrade&gt;</screen>
   <variablelist>
    <varlistentry>
     <term><literal>only_installed_packages</literal>
     </term>
     <listitem>
      <para>
       Defina como <literal>true</literal> para upgrades baseados em pacotes (recomendado para upgrade para o próximo service pack do mesmo produto) ou <literal>false</literal> para upgrades baseados em padrão (recomendado para upgrade entre versões de um produto, por exemplo, do SLES10 para o SLES11).
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><literal>stop_on_solver_conflict</literal>
     </term>
     <listitem>
      <para>
       Define se é para mostrar a proposta em caso de falha ao resolver as dependências do pacote interativamente (recomenda-se definir como <literal>true</literal>, mas isso poderá resultar em um processo interativo, em que o usuário terá que resolver os conflitos manualmente).
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2>
   <title>Seleção de Software</title>
   <para>
    As opções de seleção de software definem quais componentes selecionar ou não, além dos resultados do resolver:
   </para>
<screen>&lt;software&gt;
  &lt;packages config:type="list"&gt;
    &lt;package&gt;autoyast2-installation&lt;/package&gt;
    &lt;package&gt;apparmor-profile-editor&lt;/package&gt;
  &lt;/packages&gt;
  &lt;patterns config:type="list"&gt;
    &lt;pattern&gt;base&lt;/pattern&gt;
  &lt;/patterns&gt;
  &lt;remove-packages config:type="list"/&gt;
  &lt;remove-patterns config:type="list"/&gt;
&lt;/software&gt;</screen>
   <para>
    É importante principalmente definir pacotes ou padrões a serem selecionados ou não selecionados para resolver conflitos de pacote e assim evitar a necessidade de intervenção interativa. Uma vez feito o upgrade, o arquivo recém-criado <filename>autoupg_updated.xml</filename> incluirá esses pacotes e padrões, além daqueles que foram selecionados ou não selecionados por qualquer outro motivo.
   </para>
  </sect2>

  <sect2>
   <title>Fazer backup antes do upgrade</title>
   <para>
    As opções de backup antes do upgrade combinam com estes recursos na proposta do upgrade.
   </para>
<screen>&lt;backup&gt;
  &lt;sysconfig config:type="boolean"&gt;true&lt;/sysconfig&gt;
  &lt;modified config:type="boolean"&gt;true&lt;/modified&gt;
  &lt;remove_old config:type="boolean"&gt;false&lt;/remove_old&gt;
&lt;/backup&gt;</screen>
   <variablelist>
    <varlistentry>
     <term><literal>sysconfig</literal>
     </term>
     <listitem>
      <para>
       define se é para fazer backup do sysconfig antes do upgrade.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><literal>modified</literal>
     </term>
     <listitem>
      <para>
       define se é para fazer backup dos arquivos de configuração modificados antes do upgrade.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><literal>remove_old</literal>
     </term>
     <listitem>
      <para>
       define se removerá backups antigos dos upgrades anteriores.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.update.auto.run">
  <title>Executando o upgrade automático</title>

  <para>
   Para iniciar o upgrade automatizado, inicialize a mídia de instalação e passe o perfil do AutoYaST para ela. Há duas maneiras de passar o perfil para o sistema:
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     Passe o perfil para a linha de comando do kernel da mesma forma que na instalação do AutoYaST (use o parâmetro <literal>autoupgrade=1</literal> <filename>autoyast=http://host/path/profile.xml</filename>. Para o System z, essa é a única possibilidade.
    </para>
   </listitem>
   <listitem>
    <para>
     Passe o parâmetro <literal>autoupgrade=1</literal> para a linha de comando do kernel. Antes de começar o upgrade, copie o perfil para <filename>/root/autoupg.xml</filename>. Não há necessidade de parâmetros adicionais do kernel.
    </para>
   </listitem>
  </itemizedlist>

  <para>
   Esta última abordagem permite ter uma única linha de comando do kernel de instalação mesmo para máquinas diferentes, basta copiar o perfil apropriado no respectivo sistema de arquivos.
  </para>

  <para>
   Desde que você tenha apenas um sistema SUSE Linux Enterprise instalado na máquina, não haja conflitos de pacotes e o perfil não esteja definido para parar na proposta de upgrade, todo o processo será não interativo. Caso você forneça a proposta de upgrade, poderá modificar suas configurações para o upgrade.
  </para>

  <para>
   Após o término do upgrade, o YaST gravará o arquivo <filename>/root/autoupg-updated.xml</filename>, que contém o perfil com as mudanças aplicadas de seleção de software feitas na proposta. Isso é útil principalmente no caso de upgrades em massa de máquinas com a mesma seleção de pacotes. Deste modo, resoluções de conflitos de uma máquina podem facilmente ser aplicadas a outras máquinas; o que, por consequência, resolverá esses conflitos automaticamente e o próprio upgrade será não interativo.
  </para>

  <para>
   Se houver mais sistemas SUSE Linux Enterprise instalados na máquina, sempre será perguntado de qual deverá ser feito upgrade, não tem como selecionar isso antecipadamente.
  </para>
 </sect1>
 <sect1 xml:id="sec.update.auto.grub">
  <title>Seção de menu do GRUB 2 para inicialização do upgrade</title>

  <remark condition="clarity">
   2014-02-10 - fs: FIXME: This entry needs to be adjusted to GRUB 2. ATM I
                           have no clue how to do it in GRUB 2.
  </remark>

  <para>
   Uma outra forma de inicializar o sistema é criar uma seção adicional no menu do GRUB 2 (e igualmente para outros carregadores de boot e arquiteturas) que inicie a instalação. O seguinte exemplo assume que há uma partição separada <filename>/boot</filename>, que é citada no GRUB 2 como <literal>(hd0,0)</literal>:
  </para>

<screen>title Upgrade
    root (hd0,0)
    kernel /upgrade/linux
    install=<replaceable>inst_source_url</replaceable> autoupgrade=1
    autoyast=<replaceable>autoyast_profile_url</replaceable> vga=0x314
    initrd /upgrade/initrd
  </screen>

  <para>
   O exemplo acima assume que o kernel e o <systemitem>initrd</systemitem> de instalação estão localizados no diretório <filename>/boot/upgrade</filename>.
  </para>

  <para>
   No System z, você deve adicionar os parâmetros ao arquivo PARM, processado da mesma forma como você faz ao executar uma instalação orientada pelo AutoYaST.
  </para>
 </sect1>
 <sect1 xml:id="sec.update.auto.2nd-stage">
  <title>Segundo estágio do upgrade</title>

  <para>
   O upgrade automático por padrão não faz mudanças de configuração durante o segundo estágio do upgrade. A única exceção é a configuração da rede, que precisa ser definida para ser preservada no perfil de upgrade do AutoYaST.
  </para>

  <para>
   Se forem necessários ajustes de configuração de algumas áreas do sistema após o upgrade (por exemplo, configuração de um novo serviço), adicione as seções relevantes ao perfil do AutoYaST para o upgrade, e a configuração das áreas do sistema selecionadas será gravada durante o upgrade.
  </para>

  <warning>
   <title>A configuração do AutoYaST fornecida substitui a configuração existente</title>
   <para>
    Esteja ciente de que a configuração existente dessa área do sistema será substituída e, portanto, destruída pela configuração do AutoYaST.
   </para>
  </warning>

  <para>
   Normalmente, o único ajuste de configuração que deve estar presente no perfil do AutoYaST é o registro do sistema com a SMT (Subscription Management Tool) ou o Novell Customer Center (NCC). Se estiver faltando, o sistema não obterá o repositório de atualização e não será possível realizar as atualizações, a menos que seja configurado novamente mais tarde.
  </para>
 </sect1>
 <sect1 xml:id="sec.update.auto.limitations">
  <title>Limitações e dicas</title>

  <para/>

  <sect2>
   <title>NetworkManager e registro</title>
   <para>
    Caso seja utilizado o NetworkManager para gerenciar dispositivos de rede e conexões de rede, a conexão de rede não estará disponível durante a segunda fase do upgrade. Isso impede o sistema de fazer o registro.
   </para>
  </sect2>

  <sect2>
   <title>Limpando a configuração de upgrade</title>
   <para>
    Se você fizer alguma mudança no sistema para acionar o processo de upgrade (por exemplo, adicionar uma nova seção ao menu do carregador de boot), provavelmente vai querer removê-la quando o upgrade for concluído.
   </para>
   <para>
    <remark condition="clarity">
     2014-02-10 - fs: FIXME: Check if such a script still exists for GRUB 2
     and/or ELILO
    </remark> Isso pode ser feito automaticamente com um script posterior à instalação. Encontre exemplos em <xref linkend="createprofile.scripts"/>. Um <filename>menu.lst</filename> de exemplo de script de limpeza do GRUB 2 foi incluído no arquivo <filename>autoupg.xml</filename> de amostra. Verifique se o script corresponde à sua configuração específica e se não removerá mais do que você realmente deseja!
   </para>
  </sect2>

  <sect2>
   <title>Para obter mais informações</title>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      Documentação do Linuxrc: <link xlink:href="http://en.opensuse.org/SDB:Linuxrc"/>
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
 </sect1>
</chapter>
