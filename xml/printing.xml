<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd"
[
  <!ENTITY % NOVDOC.DEACTIVATE.IDREF "INCLUDE">
  <!ENTITY % entities SYSTEM "entity-decl.ent">
  %entities;
]>
<chapter id="cha.p">
 <title>Printer Operation</title><indexterm>
 <primary>printing</primary></indexterm>
 <para>
  &productnamereg; supports printing with many types of printers, including
  remote network printers. Printers can be configured manually or with
  &yast;. For configuration instructions, refer to
  <xref linkend="sec.y2.hw.print"/>. Both graphical and command line
  utilities are available for starting and managing print jobs. If your
  printer does not work as expected, refer to
  <xref linkend="sec.drucken.prob"/>.
 </para>
 <para>
  CUPS (Common Unix Printing System) is the standard print system in
  &productname;.
 </para>
 <para>
  Printers can be distinguished by interface, such as USB or network, and
  printer language. When buying a printer, make sure that the printer has an
  interface that is supported (USB, Ethernet, or Wi-fi) and a suitable printer
  language. Printers can be categorized on the basis of the following three
  classes of printer languages:
 </para>
 <variablelist>
  <varlistentry>
   <term>PostScript Printers</term>
   <listitem>
    <para>
     PostScript is the printer language in which most print jobs in Linux
     and Unix are generated and processed by the internal print system. If
     PostScript documents can be processed directly by the printer and do
     not need to be converted in additional stages in the print system, the
     number of potential error sources is reduced.
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term>Standard Printers (Languages Like PCL and ESC/P)</term>
   <listitem>
    <para>
     Although these printer languages are quite old, they are still
     undergoing expansion to address new features in printers. In the case
     of known printer languages, the print system can convert PostScript
     jobs to the respective printer language with the help of Ghostscript.
     This processing stage is referred to as interpreting. The best-known
     languages are PCL (which is mostly used by HP printers and their
     clones) and ESC/P (which is used by Epson printers). These printer
     languages are usually supported by Linux and produce an adequate print
     result. Linux may not be able to address some special printer
     functions. Except for HP developing HPLIP (HP Linux Imaging and
     Printing), there are currently no printer manufacturers who develop
     Linux drivers and make them available to Linux distributors under an
     open source license.
    </para>
   </listitem>
  </varlistentry>
  <varlistentry id="sec.p.prep.gdi">
   <term>Proprietary Printers (Also Called GDI Printers)</term>
   <listitem>
    <para>
     These printers do not support any of the common printer languages. They
     use their own undocumented printer languages, which are subject to
     change when a new edition of a model is released. Usually only Windows
     drivers are available for these printers. See
     <xref
      linkend="sec.drucken.gdi"/> for more information.
    </para>
   </listitem>
  </varlistentry>
 </variablelist>
 <para>
  Before you buy a new printer, refer to the following sources to check how
  well the printer you intend to buy is supported:
 </para>
 <variablelist>
  <varlistentry>
   <term><ulink url="http://www.linuxfoundation.org/OpenPrinting/"/>
   </term>
   <listitem>
    <para>
     The OpenPrinting home page with the printer database. The database
     shows the latest Linux support status. However, a Linux distribution
     can only integrate the drivers available at production time.
     Accordingly, a printer currently rated as <quote>perfectly
     supported</quote> may not have had this status when the latest
     &productname; version was released. Thus, the databases may not
     necessarily indicate the correct status, but only provide an
     approximation.
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><ulink url="http://pages.cs.wisc.edu/~ghost/"/>
   </term>
   <listitem>
    <para>
     The Ghostscript Web page.
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><filename>/usr/share/doc/packages/ghostscript/catalog.devices</filename>
   </term>
   <listitem>
    <para>
     List of included drivers.
    </para>
   </listitem>
  </varlistentry>
 </variablelist>
 <sect1 id="sec.p.workflow">
  <title>The Workflow of the Printing System</title>

  <para>
   The user creates a print job. The print job consists of the data to print
   plus information for the spooler, such as the name of the printer or the
   name of the print queue, and optionally, information for the filter, such
   as printer-specific options.
  </para>

  <para>
   At least one dedicated print queue exists for every printer. The spooler
   holds the print job in the queue until the desired printer is ready to
   receive data. When the printer is ready, the spooler sends the data
   through the filter and back-end to the printer.
  </para>

  <para>
   The filter converts the data generated by the application that is
   printing (usually PostScript or PDF, but also ASCII, JPEG, etc.) into
   printer-specific data (PostScript, PCL, ESC/P, etc.). The features of the
   printer are described in the PPD files. A PPD file contains
   printer-specific options with the parameters needed to enable them on the
   printer. The filter system makes sure that options selected by the user
   are enabled.
  </para>

  <para>
   If you use a PostScript printer, the filter system converts the data into
   printer-specific PostScript. This does not require a printer driver. If
   you use a non-PostScript printer, the filter system converts the data
   into printer-specific data. This requires a printer driver suitable for
   your printer. The back-end receives the printer-specific data from the
   filter then passes it to the printer.
  </para>
 </sect1>
 <sect1 id="sec.p.method">
  <title>Methods and Protocols for Connecting Printers</title>

  <para>
   There are various possibilities for connecting a printer to the system.
   The configuration of the CUPS print system does not distinguish between a
   local printer and a printer connected to the system over the network.
   <phrase
    os="osuse">For more information about the printer connection,
   read the article <emphasis>CUPS in a Nutshell</emphasis> in the Support
   Database at
   <ulink url="http://en.opensuse.org/SDB:CUPS_in_a_Nutshell"/>.</phrase>
  </para>

  <para arch="zseries" os="sles">
   Printers and similar devices provided by the z/VM that connect locally
   with the IBM &zseries; mainframes are not supported by CUPS. On
   these platforms, printing is only possible over the network. The cabling
   for network printers must be installed according to the instructions of
   the printer manufacturer.
  </para>

  <warning>
   <title>Changing Cable Connections in a Running System</title>
   <para>
    When connecting the printer to the machine, do not forget that only USB
    devices can be plugged in or unplugged during operation. To avoid
    damaging your system or printer, shut down the system before changing
    any connections that are not USB.
   </para>
  </warning>
 </sect1>
 <sect1 id="sec.p.software">
  <title>Installing the Software</title>

  <para>
   PPD (PostScript printer description) is the computer language that
   describes the properties, like resolution, and options, such as the
   availability of a duplex unit. These descriptions are required for using
   various printer options in CUPS. Without a PPD file, the print data would
   be forwarded to the printer in a <quote>raw</quote> state, which is
   usually not desired. During the installation of &productname;, many PPD
   files are pre-installed.
  </para>

  <para>
   To configure a PostScript printer, the best approach is to get a suitable
   PPD file. Many PPD files are available in the package
   <systemitem>manufacturer-PPDs</systemitem>, which is automatically
   installed within the scope of the standard installation. See
   <xref
   linkend="sec.p.special.ppd"/> and
   <xref
   linkend="sec.drucken.prob.ppd"/>.
  </para>

  <para>
   New PPD files can be stored in the directory
   <filename>/usr/share/cups/model/</filename> or added to the print system
   with &yast; as described in
   <xref
   linkend="sec.y2.hw.print.local.get_ppd" />. Subsequently, the
   PPD file can be selected during the printer setup.
  </para>

  <para>
   Be careful if a printer manufacturer wants you to install entire software
   packages. First, this kind of installation may result in the loss of the
   support provided by &productname; and second, print commands may work
   differently and the system may no longer be able to address devices of
   other manufacturers. For this reason, the installation of manufacturer
   software is not recommended.
  </para>
 </sect1>
 <sect1 id="sec.p.net">
  <title>Network Printers</title>

  <para>
   A network printer can support various protocols, some of them even
   concurrently. Although most of the supported protocols are standardized,
   some manufacturers modify the standard. Manufacturers then provide
   drivers for only a few operating systems. Unfortunately, Linux drivers
   are rarely provided. The current situation is such that you cannot act on
   the assumption that every protocol works smoothly in Linux. Therefore,
   you may have to experiment with various options to achieve a functional
   configuration.
  </para>

<!--  fs: 2008-10-08:
     wrong place. This would be suitable for a cups server section 
  <important>
   <title>Remote Access Settings</title>
   <para>
    By default, the cupsd only listens on internal network interfaces
    (<systemitem>localhost</systemitem>). When setting up a CUPS network
    server you need to adjust the <literal>Listen</literal> directive in
    <filename>/etc/cups/cupsd.conf</filename> to listen to the outer network.
   </para>
  </important>
-->

  <para>
   CUPS supports the <systemitem>socket</systemitem>,
   <systemitem>LPD</systemitem>, <systemitem>IPP</systemitem> and
   <systemitem>smb</systemitem> protocols.
  </para>

  <variablelist>
   <varlistentry>
    <term>socket</term>
    <listitem>
     <para>
      <emphasis>Socket</emphasis> refers to a connection in which the plain
      print data is sent directly to a TCP socket. Some of the socket port
      numbers that are commonly used are <option>9100</option> or
      <option>35</option>. The device URI (uniform resource identifier)
      syntax is:
      socket://<replaceable>IP.of.the.printer</replaceable>:<replaceable>port</replaceable>,
      for example: <systemitem>socket://&subnetII;.202:9100/</systemitem>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>LPD (Line Printer Daemon)</term>
    <listitem>
     <para>
      The LPD protocol is described in RFC&nbsp;1179. Under this protocol,
      some job-related data, such as the ID of the print queue, is sent
      before the actual print data is sent. Therefore, a print queue must be
      specified when configuring the LPD protocol. The implementations of
      diverse printer manufacturers are flexible enough to accept any name
      as the print queue. If necessary, the printer manual should indicate
      what name to use. LPT, LPT1, LP1 or similar names are often used. The
      port number for an LPD service is <option>515</option>. An example
      device URI is <systemitem>lpd://&subnetII;.202/LPT1</systemitem>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>IPP (Internet Printing Protocol)</term>
    <listitem>
     <para>
      IPP is a relatively new protocol (1999) based on the HTTP protocol.
      With IPP, more job-related data is transmitted than with the other
      protocols. CUPS uses IPP for internal data transmission. The name of
      the print queue is necessary to configure IPP correctly. The port
      number for IPP is <literal>631</literal>. Example device URIs are
      <systemitem>ipp://&subnetII;.202/ps</systemitem> and
      <systemitem>ipp://&subnetII;.202/printers/ps</systemitem>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>SMB (Windows Share)</term>
    <listitem>
     <para>
      CUPS also supports printing on printers connected to Windows shares.
      The protocol used for this purpose is SMB. SMB uses the port numbers
      <option>137</option>, <option>138</option> and <option>139</option>.
      Example device URIs are
      <systemitem>smb://user:password@workgroup/&smbname;/printer</systemitem>,
      <systemitem>smb://user:password@&smbname;/printer</systemitem>, and
      <systemitem>smb://&smbname;/printer</systemitem>.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   The protocol supported by the printer must be determined before
   configuration. If the manufacturer does not provide the needed
   information, the command <command>nmap</command> (which comes with the
   <systemitem>nmap</systemitem> package) can be used to ascertain the
   protocol. <command>nmap</command> checks a host for open ports. For
   example:
  </para>

<screen
>nmap -p 35,137-139,515,631,9100-10000 <replaceable>printerIP</replaceable></screen>

  <sect2 id="sec.p.net.config_cmdl">
   <title>Configuring CUPS with Command Line Tools</title>
   <para>
    CUPS can be configured with command line tools like
    <command>lpinfo</command>, <command>lpadmin</command> and
    <command>lpoptions</command>. You need a device URI consisting of a
    back-end, such as USB, and parameters. To determine valid device
    URIs on your system use the command <command>lpinfo -v | grep
    ":/"</command>:
   </para>
<screen># lpinfo -v | grep ":/"
direct usb://ACME/FunPrinter%20XL
network socket://&cupsip;</screen>
   <para>
    With <command>lpadmin</command> the CUPS server administrator can add,
    remove or manage print queues. To add a print queue, use the following
    syntax:
   </para>
<screen>lpadmin -p <replaceable
  >queue</replaceable> -v <replaceable
  >device-URI</replaceable> -P <replaceable
    >PPD-file</replaceable> -E</screen>
   <para>
    Then the device (<option>-v</option>) is available as
    <replaceable>queue</replaceable> (<option>-p</option>), using the
    specified PPD file (<option>-P</option>). This means that you must know
    the PPD file and the device URI to configure the printer manually.
   </para>
   <para>
    Do not use <option>-E</option> as the first option. For all CUPS
    commands, <option>-E</option> as the first argument sets use of an
    encrypted connection. To enable the printer, <option>-E</option> must be
    used as shown in the following example:
   </para>
<screen>lpadmin -p ps -v usb://ACME/FunPrinter%20XL -P \
/usr/share/cups/model/Postscript.ppd.gz -E</screen>
   <para>
    The following example configures a network printer:
   </para>
<screen>lpadmin -p ps -v socket://&subnetII;.202:9100/ -P \
/usr/share/cups/model/Postscript-level1.ppd.gz -E</screen>
   <para>
    For more options of <command>lpadmin</command>, see the man page of
    <systemitem>lpadmin(8)</systemitem>.
   </para>
   <para>
    During printer setup, certain options are set as default. These options
    can be modified for every print job (depending on the print tool used).
    Changing these default options with &yast; is also possible. Using
    command line tools, set default options as follows:
   </para>
   <procedure>
    <step>
     <para>
      First, list all options:
     </para>
<screen>lpoptions -p <replaceable>queue</replaceable> -l</screen>
     <para>
      Example:
     </para>
<screen>Resolution/Output Resolution: 150dpi *300dpi 600dpi</screen>
     <para>
      The activated default option is identified by a preceding asterisk
      (<literal>*</literal>).
     </para>
    </step>
    <step>
     <para>
      Change the option with <command>lpadmin</command>:
     </para>
<screen>lpadmin -p <replaceable>queue</replaceable> -o Resolution=600dpi</screen>
    </step>
    <step>
     <para>
      Check the new setting:
     </para>
<screen>lpoptions -p <replaceable>queue</replaceable> -l

Resolution/Output Resolution: 150dpi 300dpi *600dpi</screen>
    </step>
   </procedure>
   <para>
    When a normal user runs <command>lpoptions</command>, the settings are
    written to <filename>~/.cups/lpoptions</filename>. However,
    <systemitem
    class="username">root</systemitem> settings are written
    to <filename>/etc/cups/lpoptions</filename>.
   </para>
  </sect2>
 </sect1>
 <sect1 id="sec.p.appl.commandline">
  <title>Printing from the Command Line</title><indexterm>

  <primary>printing</primary>

  <secondary>command line</secondary></indexterm><indexterm>

  <primary>commands</primary>

  <secondary>lp</secondary></indexterm>

  <para>
   To print from the command line, enter <command>lp -d
   <replaceable>queuename</replaceable>
   <replaceable>filename</replaceable></command>, substituting the
   corresponding names for <replaceable>queuename</replaceable> and
   <replaceable>filename</replaceable>.
  </para>

  <para>
   Some applications rely on the <command>lp</command> command for printing.
   In this case, enter the correct command in the application's print
   dialog, usually without specifying <replaceable>filename</replaceable>,
   for example, <command>lp -d
   <replaceable>queuename</replaceable></command>.
  </para>
 </sect1>
 <sect1 id="sec.p.special">
  <title>Special Features in &productname;</title>

  <para>
   A number of CUPS features have been adapted for &productname;. Some of
   the most important changes are covered here.
  </para>

  <sect2 id="sec.p.special.cupsfire">
   <title>CUPS and Firewall</title>
   <para>
    After having performed a default installation of &productname;,
    &susefirewall; is active and the network interfaces are configured to be
    in the <literal>External Zone</literal> which blocks incoming traffic.
    More information about the &susefirewall; configuration is available in
    <xref
     linkend="sec.security.firewall.SuSE"/> and at
    <ulink
      url="http://en.opensuse.org/SDB:CUPS_and_SANE_Firewall_settings"/>.
   </para>
   <sect3 id="sec.p.special.cupsfire.client">
    <title>CUPS Client</title>
    <para>
     Normally, a CUPS client runs on a regular workstation located in a
     trusted network environment behind a firewall. In this case it is
     recommended to configure the network interface to be in the
     <literal>Internal Zone</literal>, so the workstation is reachable from
     within the network.
    </para>
   </sect3>
   <sect3 id="sec.p.special.cupsfire.server">
    <title>CUPS Server</title>
    <para>
     If the CUPS server is part of a trusted network environment protected
     by a firewall, the network interface should be configured to be in the
     <literal>Internal Zone</literal> of the firewall. It is not recommended
     to set up a CUPS server in an untrusted network environment unless you
     take care that it is protected by special firewall rules and secure
     settings in the CUPS configuration.
    </para>
   </sect3>
  </sect2>

  <sect2 id="sec.p.special.ppd">
   <title>PPD Files in Various Packages</title>
   <para>
    The &yast; printer configuration sets up the queues for CUPS using the
    PPD files installed in <filename>/usr/share/cups/model</filename>. To
    find the suitable PPD files for the printer model, &yast; compares the
    vendor and model determined during hardware detection with the vendors
    and models in all PPD files. For this purpose, the &yast; printer
    configuration generates a database from the vendor and model information
    extracted from the PPD files.
   </para>
   <para>
    The configuration using only PPD files and no other information sources
    has the advantage that the PPD files in
    <filename>/usr/share/cups/model</filename> can be modified freely. For
    example, if you only have PostScript printers, normally you do not need
    the Foomatic PPD files in the <systemitem>cups-drivers</systemitem>
    package or the Gutenprint PPD files in the
    <systemitem>gutenprint</systemitem> package. Instead, the PPD files for
    your PostScript printers can be copied directly to
    <filename>/usr/share/cups/model</filename> (if they do not already exist
    in the <systemitem>manufacturer-PPDs</systemitem> package) to achieve an
    optimum configuration for your printers.
   </para>
   <sect3 id="sec.p.special.ppd.cups">
    <title>CUPS PPD Files in the <systemitem>cups</systemitem> Package</title>
    <para>
     The generic PPD files in the <systemitem>cups</systemitem> package have
     been complemented with adapted Foomatic PPD files for PostScript level
     1 and level 2 printers:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       <filename>/usr/share/cups/model/Postscript-level1.ppd.gz</filename>
      </para>
     </listitem>
     <listitem>
      <para>
       <filename>/usr/share/cups/model/Postscript-level2.ppd.gz</filename>
      </para>
     </listitem>
    </itemizedlist>
   </sect3>
   <sect3 id="sec.p.special.ppd.foomatic">
    <title>PPD Files in the <systemitem>cups-drivers</systemitem> Package</title>
    <para>
     Normally, the Foomatic printer filter
     <systemitem>foomatic-rip</systemitem> is used together with Ghostscript
     for non-PostScript printers. Suitable Foomatic PPD files have the
     entries <systemitem>*NickName: ... Foomatic/Ghostscript
     driver</systemitem> and <systemitem>*cupsFilter: ...
     foomatic-rip</systemitem>. These PPD files are located in the
     <systemitem>cups-drivers</systemitem> package.
    </para>
    <para>
     &yast; generally prefers a <systemitem>manufacturer-PPD</systemitem>
     file. However, when no suitable
     <systemitem>manufacturer-PPD</systemitem> file exists, a Foomatic PPD
     file with the entry <systemitem>*NickName: ... Foomatic ...
     (recommended)</systemitem> is selected.
    </para>
   </sect3>
   <sect3 id="sec.p.special.ppd.gimp">
    <title>Gutenprint PPD Files in the <systemitem>gutenprint</systemitem> Package</title>
    <para>
     Instead of <systemitem>foomatic-rip</systemitem>, the CUPS filter
     <systemitem>rastertogutenprint</systemitem> from Gutenprint (formerly
     known as GIMP-Print) can be used for many non-PostScript printers. This
     filter and suitable Gutenprint PPD files are available in the
     <systemitem>gutenprint</systemitem> package. The Gutenprint PPD files
     are located in <filename>/usr/share/cups/model/gutenprint/</filename>
     and have the entries <systemitem>*NickName: ...
     CUPS+Gutenprint</systemitem> and <systemitem>*cupsFilter: ...
     rastertogutenprint</systemitem>.
    </para>
   </sect3>
   <sect3 id="sec.p.special.ppd.manu">
    <title>PPD Files from Printer Manufacturers in the <systemitem>manufacturer-PPDs</systemitem> Package</title>
    <para>
     The <systemitem>manufacturer-PPDs</systemitem> package contains PPD
     files from printer manufacturers that are released under a sufficiently
     liberal license. PostScript printers should be configured with the
     suitable PPD file of the printer manufacturer, because this file
     enables the use of all functions of the PostScript printer. &yast;
     prefers a PPD file from the <systemitem>manufacturer-PPDs</systemitem>.
     &yast; cannot use a PPD file from the
     <systemitem>manufacturer-PPDs</systemitem> package if the model name
     does not match. This may happen if the
     <systemitem>manufacturer-PPDs</systemitem> package contains only one
     PPD file for similar models, like Funprinter 12xx series. In this case,
     select the respective PPD file manually in &yast;.
    </para>
   </sect3>
  </sect2>
 </sect1>
 <sect1 id="sec.drucken.prob">
  <title>Troubleshooting</title>

  <para>
   The following sections cover some of the most frequently encountered
   printer hardware and software problems and ways to solve or circumvent
   these problems. Among the topics covered are GDI printers, PPD files and
   port configuration. Common network printer problems, defective printouts,
   and queue handling are also addressed.
  </para>

  <sect2 id="sec.drucken.gdi">
   <title>Printers without Standard Printer Language Support</title><indexterm>
   <primary>printing</primary>
   <secondary>GDI printers</secondary></indexterm>
   <para>
    These printers do not support any common printer language and can only
    be addressed with special proprietary control sequences. Therefore they
    can only work with the operating system versions for which the
    manufacturer delivers a driver. GDI is a programming interface developed
    by Microsoft* for graphics devices. Usually the manufacturer delivers
    drivers only for Windows, and since the Windows driver uses the GDI
    interface these printers are also called <emphasis>GDI
    printers</emphasis>. The actual problem is not the programming
    interface, but the fact that these printers can only be addressed with
    the proprietary printer language of the respective printer model.
   </para>
   <para>
    Some GDI printers can be switched to operate either in GDI mode or in
    one of the standard printer languages. See the manual of the printer
    whether this is possible. Some models require special Windows software
    to do the switch (note that the Windows printer driver may always switch
    the printer back into GDI mode when printing from Windows). For other
    GDI printers there are extension modules for a standard printer language
    available.
   </para>
   <para>
    Some manufacturers provide proprietary drivers for their printers. The
    disadvantage of proprietary printer drivers is that there is no
    guarantee that these work with the installed print system or that they
    are suitable for the various hardware platforms. In contrast, printers
    that support a standard printer language do not depend on a special
    print system version or a special hardware platform.
   </para>
   <para>
    Instead of spending time trying to make a proprietary Linux driver work,
    it may be more cost-effective to purchase a printer which supports a
    standard printer language (preferably PostScript). This would solve the
    driver problem once and for all, eliminating the need to install and
    configure special driver software and obtain driver updates that may be
    required due to new developments in the print system.
   </para>
  </sect2>

  <sect2 id="sec.drucken.prob.ppd">
   <title>No Suitable PPD File Available for a PostScript Printer</title>
   <para>
    If the <systemitem>manufacturer-PPDs</systemitem> package does not
    contain a suitable PPD file for a PostScript printer, it should be
    possible to use the PPD file from the driver CD of the printer
    manufacturer or download a suitable PPD file from the Web page of the
    printer manufacturer.
   </para>
   <para>
    If the PPD file is provided as a zip archive (.zip) or a self-extracting
    zip archive (<filename>.exe</filename>), unpack it with
    <command>unzip</command>. First, review the license terms of the PPD
    file. Then use the <command>cupstestppd</command> utility to check if
    the PPD file complies with <quote>Adobe PostScript Printer Description
    File Format Specification, version 4.3.</quote> If the utility returns
    <quote>FAIL,</quote> the errors in the PPD files are serious and are
    likely to cause major problems. The problem spots reported by
    <command>cupstestppd</command> should be eliminated. If necessary, ask
    the printer manufacturer for a suitable PPD file.
   </para>
  </sect2>

  <sect2 id="sec.drucken.prob.netconnect">
   <title>Network Printer Connections</title><indexterm>
   <primary>printing</primary>
   <secondary>network</secondary></indexterm><indexterm>
   <primary>printing</primary>
   <secondary>troubleshooting</secondary>
   <tertiary>network</tertiary></indexterm>
   <variablelist>
    <varlistentry>
     <term>Identifying Network Problems</term>
     <listitem>
      <para>
       Connect the printer directly to the computer. For test purposes,
       configure the printer as a local printer. If this works, the problems
       are related to the network.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Checking the TCP/IP Network</term>
     <listitem>
      <para>
       The TCP/IP network and name resolution must be functional.
      </para>
     </listitem>
    </varlistentry>
<!-- fs 2008-10-08: only relevant for CUPS server, commenting for now
    <varlistentry>
     <term>Checking the Remote Accessibility</term>
     <listitem>
      <para>
       By default, the cupsd only listens on internal network interfaces
       (<systemitem>localhost</systemitem>). Check whether the
       <literal>Listen</literal> directive(s) in
       <filename>/etc/cups/cupsd.conf</filename> allow access from the
       outer network:
      </para>
<screen>Listen &subnetII;,*:631</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Checking the Firewall Settings</term>
     <listitem>
      <para>
       A CUPS server either needs to be in the internal firewall zone or, when
       being in the external zone, must be able to send and receive data on
       the UDP and TCP port 631.
      </para>
     </listitem>
    </varlistentry>
-->
    <varlistentry>
     <term>Checking a Remote <command>lpd</command>
     </term>
     <listitem>
      <para>
       Use the following command to test if a TCP connection can be
       established to <command>lpd</command> (port <literal>515</literal>)
       on <replaceable>host</replaceable>:
      </para>
<screen>netcat -z <replaceable
  >host</replaceable> 515 &amp;&amp; echo ok || echo failed</screen>
      <para>
       If the connection to <command>lpd</command> cannot be established,
       <command>lpd</command> may not be active or there may be basic
       network problems.
      </para>
      <para>
       As the user <systemitem class="username">root</systemitem>, use the
       following command to query a (possibly very long) status report for
       <replaceable>queue</replaceable> on remote
       <replaceable>host</replaceable>, provided the respective
       <command>lpd</command> is active and the host accepts queries:
      </para>
<screen>echo -e "\004queue" \
| netcat -w 2 -p 722 <replaceable>host</replaceable> 515</screen>
      <para>
       If <command>lpd</command> does not respond, it may not be active or
       there may be basic network problems. If <command>lpd</command>
       responds, the response should show why printing is not possible on
       the <literal>queue</literal> on <literal>host</literal>. If you
       receive a response like that shown in <xref linkend="aus.d.lpd"/>,
       the problem is caused by the remote <command>lpd</command>.
      </para>
      <example id="aus.d.lpd">
       <title>Error Message from <command>lpd</command></title>
<screen>lpd: your host does not have line printer access
lpd: queue does not exist
printer: spooling disabled
printer: printing disabled</screen>
      </example>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Checking a Remote <command>cupsd</command>
     </term>
     <listitem>
      <para>
       A CUPS network server can broadcast its queues by default every 30
       seconds on UDP port <literal>631</literal>. Accordingly, the
       following command can be used to test whether there is a broadcasting
       CUPS network server in the network. Make sure to stop your local CUPS
       daemon before executing the command.
      </para>
<screen>netcat -u -l -p 631 &amp; PID=$! ; sleep 40 ; kill $PID</screen>
      <para>
       If a broadcasting CUPS network server exists, the output appears as
       shown in <xref linkend="aus.d.bcast"/>.
      </para>
      <example id="aus.d.bcast">
       <title>Broadcast from the CUPS Network Server</title>
<screen>ipp://&subnetII;.202:631/printers/queue</screen>
      </example>
      <para arch="zseries" os="sles">
       Take into account that IBM &zseries; ethernet devices do not receive
       broadcasts by default.
      </para>
      <para>
       The following command can be used to test if a TCP connection can be
       established to <command>cupsd</command> (port <literal>631</literal>)
       on <replaceable>host</replaceable>:
      </para>
<screen>netcat -z <replaceable
  >host</replaceable> 631 &amp;&amp; echo ok || echo failed</screen>
      <para>
       If the connection to <command>cupsd</command> cannot be established,
       <command>cupsd</command> may not be active or there may be basic
       network problems. <command>lpstat -h <replaceable>host</replaceable>
       -l -t</command> returns a (possibly very long) status report for all
       queues on <replaceable>host</replaceable>, provided the respective
       <command>cupsd</command> is active and the host accepts queries.
      </para>
      <para>
       The next command can be used to test if the
       <replaceable>queue</replaceable> on <replaceable>host</replaceable>
       accepts a print job consisting of a single carriage-return character.
       Nothing should be printed. Possibly, a blank page may be ejected.
      </para>
<screen>echo -en "\r" \
| lp -d queue -h <replaceable>host</replaceable></screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>
      Troubleshooting a Network Printer or Print Server Box
     </term>
     <listitem>
      <para>
       Spoolers running in a print server box sometimes cause problems when
       they have to deal with multiple print jobs. Since this is caused by
       the spooler in the print server box, there no way to resolve this
       issue. As a work-around, circumvent the spooler in the print server
       box by addressing the printer connected to the print server box
       directly with the TCP socket. See <xref linkend="sec.p.net"/>.
      </para>
      <para>
       In this way, the print server box is reduced to a converter between
       the various forms of data transfer (TCP/IP network and local printer
       connection). To use this method, you need to know the TCP port on the
       print server box. If the printer is connected to the print server box
       and turned on, this TCP port can usually be determined with the
       <command>nmap</command> utility from the
       <systemitem>nmap</systemitem> package some time after the print
       server box is powered up. For example,
       <command>nmap&nbsp;<replaceable>IP-address</replaceable></command>
       may deliver the following output for a print server box:
      </para>
<screen>Port       State       Service
23/tcp     open        telnet
80/tcp     open        http
515/tcp    open        printer
631/tcp    open        cups
9100/tcp   open        jetdirect</screen>
      <para>
       This output indicates that the printer connected to the print server
       box can be addressed via TCP socket on port <literal>9100</literal>.
       By default, <command>nmap</command> only checks a number of commonly
       known ports listed in
       <filename>/usr/share/nmap/nmap-services</filename>. To check all
       possible ports, use the command <command>nmap
       -p&nbsp;<replaceable>from_port</replaceable>-<replaceable>to_port</replaceable>&nbsp;<replaceable>IP-address</replaceable></command>.
       This may take some time. For further information, refer to the man
       page of <command>nmap</command>.
      </para>
      <para>
       Enter a command like
      </para>
<screen>echo -en "\rHello\r\f" | netcat -w 1 IP-address port
cat file | netcat -w 1 IP-address port</screen>
      <para>
       to send character strings or files directly to the respective port to
       test if the printer can be addressed on this port.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 id="sec.drucken.prob.defective_printouts">
   <title>Defective Printouts without Error Message</title>
   <para>
    For the print system, the print job is completed when the CUPS back-end
    completes the data transfer to the recipient (printer). If further
    processing on the recipient fails (for example, if the printer is not
    able to print the printer-specific data) the print system does not
    notice this. If the printer is not able to print the printer-specific
    data, select a PPD file that is more suitable for the printer.
   </para>
  </sect2>

  <sect2 id="sec.drucken.prob.disabled_queues">
   <title>Disabled Queues</title>
   <para>
    If the data transfer to the recipient fails entirely after several
    attempts, the CUPS back-end, such as <literal>USB</literal> or
    <literal>socket</literal>, reports an error to the print system (to
    <command>cupsd</command>). The back-end determines how many unsuccessful
    attempts are appropriate until the data transfer is reported as
    impossible. As further attempts would be in vain,
    <command>cupsd</command> disables printing for the respective queue.
    After eliminating the cause of the problem, the system administrator
    must re-enable printing with the command <command>cupsenable</command>.
   </para>
  </sect2>

  <sect2 id="sec.drucken.prob.deleting_jobs">
   <title>CUPS Browsing: Deleting Print Jobs</title>
   <para>
    If a CUPS network server broadcasts its queues to the client hosts via
    browsing and a suitable local <command>cupsd</command> is active on the
    client hosts, the client <command>cupsd</command> accepts print jobs
    from applications and forwards them to the <command>cupsd</command> on
    the server. When <command>cupsd</command> on the server accepts a print
    job, it is assigned a new job number. Therefore, the job number on the
    client host is different from the job number on the server. As a print
    job is usually forwarded immediately, it cannot be deleted with the job
    number on the client host This is because the client
    <command>cupsd</command> regards the print job as completed as soon as
    it has been forwarded to the server <command>cupsd</command>.
   </para>
   <para>
    When it becomes desirable to delete the print job on the server, use a
    command such as <command>lpstat -h &cupsname; -o</command> to determine
    the job number on the server, provided the server has not already
    completed the print job (that is, sent it completely to the printer).
    Using this job number, the print job on the server can be deleted:
   </para>
<screen>cancel -h &cupsname; <replaceable
  >queue-jobnumber</replaceable></screen>
  </sect2>

  <sect2 id="sec.drucken.prob.brokenjobs">
   <title>Defective Print Jobs and Data Transfer Errors</title>
   <para>
    If you switch the printer off or shut down the computer during the
    printing process, print jobs remain in the queue. Printing resumes when
    the computer (or the printer) is switched back on. Defective print jobs
    must be removed from the queue with <command>cancel</command>.
   </para>
   <para>
    If a print job is defective or an error occurs in the communication
    between the host and the printer, the printer prints numerous sheets of
    paper with unintelligible characters, because it is unable to process
    the data correctly. To rectify this situation, follow these steps:
   </para>
   <procedure>
    <step>
     <para>
      To stop printing, remove all paper from ink jet printers or open the
      paper trays of laser printers. High-quality printers have a button for
      canceling the current printout.
     </para>
    </step>
    <step>
     <para>
      The print job may still be in the queue, because jobs are only removed
      after they are sent completely to the printer. Use <command>lpstat
      -o</command> or <command>lpstat -h &cupsname; -o</command> to check
      which queue is currently printing. Delete the print job with
      <command>cancel
      <replaceable>queue</replaceable>-<replaceable>jobnumber</replaceable>
      </command> or <command>cancel -h &cupsname;
      <replaceable>queue</replaceable>-<replaceable>jobnumber</replaceable></command>.
     </para>
    </step>
    <step>
     <para>
      Some data may still be transferred to the printer even though the
      print job has been deleted from the queue. Check if a CUPS back-end
      process is still running for the respective queue and terminate it.
      For example, for a printer connected to the USB port, the command
      FIXME <command>fuser -k /dev/lp0</command> can be used to terminate all
      processes that are still accessing the printer (more precisely: the
      USB port).
     </para>
    </step>
    <step>
     <para>
      Reset the printer completely by switching it off for some time. Then
      insert the paper and turn on the printer.
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 id="sec.drucken.prob.debugging">
   <title>Debugging the CUPS Print System</title>
   <para>
    Use the following generic procedure to locate problems in the CUPS print
    system:
   </para>
   <procedure>
    <step>
     <para>
      Set <command>LogLevel debug</command> in
      <filename>/etc/cups/cupsd.conf</filename>.
     </para>
    </step>
    <step>
     <para>
      Stop <command>cupsd</command>.
     </para>
    </step>
    <step>
     <para>
      Remove <filename>/var/log/cups/error_log*</filename> to avoid having
      to search through very large log files.
     </para>
    </step>
    <step>
     <para>
      Start <command>cupsd</command>.
     </para>
    </step>
    <step>
     <para>
      Repeat the action that led to the problem.
     </para>
    </step>
    <step>
     <para>
      Check the messages in <filename>/var/log/cups/error_log*</filename> to
      identify the cause of the problem.
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2  id="sec.drucken.prob.more_information">
   <title>For More Information</title>
   <para os="osuse">
    Solutions to many specific problems are presented in the &suse; Support
    Database
    (<ulink url="http://en.opensuse.org/Portal:Support_database"/>). Locate
    the relevant articles with a text search for
    <literal>SDB:CUPS</literal>.
   </para>
   <para os="sles;sled;">
    Solutions to many specific problems are presented in the SUSE
    Knowledgebase (<ulink url="http://www.suse.com/support/"/>). Locate the
    relevant articles with a text search for <literal>CUPS</literal>.
   </para>
  </sect2>
 </sect1>
</chapter>
