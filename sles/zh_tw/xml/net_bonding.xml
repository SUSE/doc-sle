<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_bonding.xml" version="5.0" xml:id="sec.bond">
 <title>設定 Bonding 裝置</title>

 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>

 <para>
  對於某些系統而言，實作的網路連接除了需要符合一般乙太網路裝置的標準資料安全性或可用性要求之外，還需要符合其他要求。在這些情況下，數個乙太網路裝置可以結集成單個 Bonding 裝置。
 </para>

 <para>
  bonding 裝置的組態是透過 bonding 模組選項來設定，而其行為主要受 Bonding 裝置的模式影響。該模式預設為 <systemitem>mode=active-backup</systemitem>，這表示如果使用中的從屬裝置失敗，另一個從屬裝置將變成使用中狀態。
 </para>

 <tip>
  <title>Bonding 和 Xen</title>
  <para>
   Bonding 裝置僅適用於具有多個實際網路卡的機器。在大多數組態中，這表示您只應該在 Dom0 中使用結合組態。此外，只有在您將多個網路卡指定給 VM 客體系統的情況下，在 VM 客體中設定結合才有用。
  </para>
 </tip>

 <para>
  若要設定 bonding 裝置，請執行以下程序︰
 </para>

 <procedure>
  <step>
   <para>
    執行 <menuchoice><guimenu>YaST</guimenu> <guimenu> 系統</guimenu>
    <guimenu> 網路設定</guimenu></menuchoice>。
   </para>
  </step>
  <step>
   <para>
    使用<guimenu>新增</guimenu>，然後將<guimenu>裝置類型</guimenu>變更為<guimenu>Bond</guimenu>。按<guimenu>下一步</guimenu>繼續。
   </para>
   <informalfigure>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="bond_configuration.png" width="70%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="bond_configuration.png" width="65%" format="PNG"/>
     </imageobject>
    </mediaobject>
   </informalfigure>
  </step>
  <step>
   <para>
    選取為結合裝置指定 IP 位址的方法。有三種方法可供您選擇︰
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      無 IP 位址
     </para>
    </listitem>
    <listitem>
     <para>
      動態位址 (透過 DHCP 或 Zeroconf)
     </para>
    </listitem>
    <listitem>
     <para>
      靜態指定的 IP 位址
     </para>
    </listitem>
   </itemizedlist>
   <para>
    請使用適合您環境的方法。
   </para>
  </step>
  <step>
   <para>
    在<guimenu>Bond 從屬</guimenu>索引標籤中，透過啟用相關的核取方塊來選取應包含在 Bond 中的乙太網路裝置。
   </para>
  </step>
  <step>
   <para>
    編輯<guimenu>Bond 驅動程式選項</guimenu>。可用於設定的模式顯示如下︰
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      balance-rr
     </para>
    </listitem>
    <listitem>
     <para>
      active-backup
     </para>
    </listitem>
    <listitem>
     <para>
      balance-xor
     </para>
    </listitem>
    <listitem>
     <para>
      廣播
     </para>
    </listitem>
    <listitem>
     <para>
      802.3ad
     </para>
     <para>
      <literal>802.3ad</literal> 是標準化的 LACP<quote>IEEE 802.3ad 動態連結彙總</quote>模式。
     </para>
    </listitem>
    <listitem>
     <para>
      balance-tlb
     </para>
    </listitem>
    <listitem>
     <para>
      balance-alb
     </para>
    </listitem>
   </itemizedlist>
  </step>
  <step>
   <para>
    確認參數 <literal>miimon=100</literal> 已新增至<guimenu>Bond 驅動程式選項</guimenu>。若沒有此參數，就無法定期檢查資料的完整性。
   </para>
  </step>
  <step>
   <para>
    按<guimenu>下一步</guimenu>，然後按一下<guimenu>確定</guimenu>離開 YaST，以建立裝置。
   </para>
  </step>
 </procedure>

 <para>
  所有模式以及其他更多選項的詳細說明請見<guimenu>Linux 乙太網路 Bonding 驅動程式 HOWTO</guimenu>(安裝套件 <systemitem>kernel-source</systemitem> 之後可在 <filename>/usr/src/linux/Documentation/networking/bonding.txt</filename> 中找到)。
 </para>

 <sect2 xml:id="sec.bond.hotplug">
  <title>Bonding 從屬的熱插拔</title>
  <para>
   在特定網路環境 (例如高可用性) 中，有時候您需要將 Bonding 從屬介面取代成其他介面。原因可能在於網路裝置不斷發生故障。解決方案是設定 Bonding 從屬的熱插拔。
  </para>
  <para>
   請依一般方式設定 Bond (根據 <command>man 5 ifcfg-bonding</command>)，例如︰
  </para>
<screen>ifcfg-bond0
          STARTMODE='auto' # or 'onboot'
          BOOTPROTO='static'
          IPADDR='192.168.0.1/24'
          BONDING_MASTER='yes'
          BONDING_SLAVE_0='eth0'
          BONDING_SLAVE_1='eth1'
          BONDING_MODULE_OPTS='mode=active-backup miimon=100'</screen>
  <para>
   使用 <literal>STARTMODE=hotplug</literal> 和 <literal>BOOTPROTO=none</literal> 指定從屬︰
  </para>
<screen>ifcfg-eth0
          STARTMODE='hotplug'
          BOOTPROTO='none'

ifcfg-eth1
          STARTMODE='hotplug'
          BOOTPROTO='none'</screen>

  <para>
   <literal>BOOTPROTO=none</literal> 會使用 <command>ethtool</command> 選項 (若提供)，但不會使用 <command>ifup eth0</command> 設定連結。這是因為從屬介面是由 Bond 主要裝置所控制的。
  </para>
  <para>
   <literal>STARTMODE=hotplug</literal> 會使從屬介面在可用時自動加入 Bond。
  </para>
  <para>
   需要變更 <filename>/etc/udev/rules.d/70-persistent-net.rules</filename> 中的 <systemitem>udev</systemitem> 規則，以按匯流排 ID (udev <systemitem>KERNELS</systemitem> 關鍵字等於執行 <command>hwinfo --netcard</command> 後顯示的「SysFS BusID」) 比對裝置 (而不是按 MAC 位址)，從而允許更換有故障的硬體 (網路卡位於相同的插槽中但具有不同的 MAC)，以及避免在結合變更其所有從屬的 MAC 位址時引起混淆。
  </para>
  <para>
   例如︰
  </para>
<screen>SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*",
KERNELS=="0000:00:19.0", ATTR{dev_id}=="0x0", ATTR{type}=="1",
KERNEL=="eth*", NAME="eth0"</screen>
  <para>
   開機時，systemd <systemitem>network.service</systemitem> 不會等待熱插拔從屬，但會等待結合就緒 (至少需要一個可用的從屬)。當從系統移除其中一個從屬介面 (從 NIC 驅動程式解除結合、NIC 驅動程式的 <command>rmmod</command> 或實際 PCI 熱插拔移除) 時，核心會自動將它從 Bond 中移除。當將新卡新增至系統時 (更換插槽中的硬體)，<systemitem>udev</systemitem> 會使用匯流排型永久命名規則將它重新命名為從屬的名稱，然後為它呼叫 <command>ifup</command>。<command>ifup</command> 呼叫會自動將它加入 Bond。 <remark>
    ke: I think this can stay that way for now.
   </remark>
  </para>
 </sect2>


</sect1>
