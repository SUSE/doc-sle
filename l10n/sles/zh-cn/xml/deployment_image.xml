<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="deployment_image.xml" version="5.0" role="General" xml:id="cha-deployment-clone-image">
 <title>克隆磁盘映像</title>
 <info>
  <abstract>
   <para>
    本章介绍如何使用克隆的映像来安装 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>。此过程主要用于虚拟化环境中。
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <sect1 xml:id="sec-deployment-clone-image-overview">
  <title>概述</title>
  <para>
   <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 提供了一个脚本用于清理每项安装的独特配置。随着 <systemitem class="daemon">systemd</systemitem> 的引入，可以在不同的位置与文件中使用和设置唯一的系统标识符。因此，建议不要再使用克隆方式来构建系统映像。可以使用 KIWI 创建映像，具体请参见 <link xlink:href="https://doc.suse.com/kiwi/"/>。
  </para>
  <para>
   要克隆计算机的磁盘，请参见您虚拟化环境的相关文档。
  </para>
 </sect1>
 <sect1 xml:id="sec-deployment-clone-image-clean">
  <title>清理唯一的系统标识符</title>
  <warning>
   <title>重要配置丢失</title>
   <para>
    执行以下过程会将重要的系统配置数据永久删除。如果生产环境中在使用克隆的源系统，请对克隆的映像运行清理脚本。
   </para>
  </warning>
  <para>
   要清理所有唯一的系统标识符，请在克隆磁盘映像之前或之后执行以下过程。如果对克隆运行此过程，则需要对每个克隆都运行。因此，建议创建一个不在生产环境中使用，而是仅充当新克隆的源的<literal>黄金映像</literal>。已对该黄金映像执行清理操作，可以立即使用克隆。
  </para>
  <para>
   例如，<command>clone-master-clean-up</command> 命令会去除以下数据：
  </para>
  <itemizedlist>
   <listitem>
    <para>交换文件</para>
   </listitem>
   <listitem>
    <para>Zypper 储存库</para>
   </listitem>
   <listitem>
    <para>SSH 主机和客户端密钥</para>
   </listitem>
   <listitem>
    <para>临时目录，例如 <filename>/tmp/*</filename></para>
   </listitem>
   <listitem>
    <para>Postfix 数据</para>
   </listitem>
   <listitem>
    <para>HANA 防火墙脚本</para>
   </listitem>
   <listitem>
    <para>systemd 日记</para>
   </listitem>
  </itemizedlist>
  <procedure>
   <step>
    <para>
     使用 <command>zypper</command> 安装 <package>clone-master-clean-up</package>:
    </para>
    <screen><prompt>&gt; </prompt><command>sudo</command> <command>zypper</command> install clone-master-clean-up</screen>
   </step>
   <step>
    <para>
     编辑 <filename>/etc/sysconfig/clone-master-clean-up</filename> 以配置 <command>clone-master-clean-up</command> 的行为。此配置文件定义是否应去除 UID 大于 1000 的用户、<filename>/etc/sudoers</filename> 文件、用于安装软件包的软件储存库和 Btrfs 快照。
    </para>
   </step>
   <step>
    <para>
     运行以下脚本去除现有的配置和唯一标识符：
    </para>
    <screen><prompt>&gt; </prompt><command>sudo</command> <command>clone-master-clean-up</command></screen>
   </step>
  </procedure>
 </sect1>
</chapter>
