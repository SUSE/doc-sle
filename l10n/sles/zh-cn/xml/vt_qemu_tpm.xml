<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="vt_qemu_tpm.xml" version="5.0" xml:id="tpm">
  <title>软件 TPM 模拟器</title>
  <info>
    <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
      <dm:bugtracker/>
      <dm:translation>yes</dm:translation>
    </dm:docmanager>
  </info>
  <sect1 xml:id="tpm-introduction">
    <title>简介</title>

    <para>
      可信平台模块 (TPM) 是使用加密密钥保护硬件的加密处理器。对于使用 TPM 开发安全功能的开发人员而言，软件 TPM 模拟器是一种便利的解决方案。与硬件 TPM 设备相比，该模拟器对可以访问它的 Guest 数不设限制。此外，您可以方便地在 TPM 版本 1.2 与 2.0 之间切换。QEMU 支持 <package>swtpm</package> 软件包中包含的软件 TPM 模拟器。
    </para>
  </sect1>
  <sect1 xml:id="tpm-prerequisite">
    <title>先决条件</title>

    <para>
      您需要先安装 <systemitem class="library">libvirt</systemitem> 虚拟化环境，然后才能安装并使用软件 TPM 模拟器。请参见<xref linkend="install-virtualization-components"/>并安装所提供的虚拟化解决方案之一。
    </para>
  </sect1>
  <sect1 xml:id="tpm-installation">
    <title>安装</title>

    <para>
      要使用软件 TPM 模拟器，请安装 <package>swtpm</package> 软件包：
    </para>

<screen><prompt>&gt; </prompt><command>sudo</command> zypper install swtpm</screen>
  </sect1>
  <sect1 xml:id="tpm-qemu">
    <title>将 <command>swtpm</command> 与 QEMU 配合使用</title>

    <para>
      <command>swtpm</command> 提供三种类型的接口：<literal>socket</literal>、<literal>chardev</literal> 和 <literal>cuse</literal>。以下过程重点介绍 <emphasis>socket</emphasis> 接口。
    </para>

    <procedure>
      <step>
        <para>
          在 VM 目录（例如 <filename>/var/lib/libvirt/qemu/sle15sp3</filename>）中创建 <filename>mytpm0</filename> 目录用于存储 TPM 状态：
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> mkdir /var/lib/libvirt/qemu/sle15sp3/mytpm0</screen>
      </step>
      <step>
        <para>
          开始 <command>swtmp</command>.它将创建 QEMU 可以使用的套接字文件，例如 <filename>/var/lib/libvirt/qemu/sle15sp3</filename>：
        </para>
<screen>
 <prompt>&gt; </prompt><command>sudo</command> swtpm socket
  --tpmstate dir=/var/lib/libvirt/qemu/sle15sp3/mytpm0 \
  --ctrl type=unixio,path=/var/lib/libvirt/qemu/sle15sp3/mytpm0/swtpm-sock \
  --log level=20
 </screen>
        <tip>
          <title>TPM 版本 2.0</title>
          <para>
            默认情况下，<command>swtpm</command> 会启动 TPM 版本 1.2 模拟器，并将此模拟器的状态存储在 <filename>tpm-00.permall</filename> 目录中。要创建 TPM 2.0 实例，请运行以下命令：
          </para>
<screen>
 <prompt>&gt; </prompt><command>sudo</command> swtpm socket
  --tpm2
  --tpmstate dir=/var/lib/libvirt/qemu/sle15sp3/mytpm0 \
  --ctrl type=unixio,path=/var/lib/libvirt/qemu/sle15sp3/mytpm0/swtpm-sock \
  --log level=20
 </screen>
          <para>
            TPM 2.0 状态存储在 <filename>tpm2-00.permall</filename> 目录中。
          </para>
        </tip>
      </step>
      <step>
        <para>
          将以下命令行参数添加到 <command>qemu-system-<replaceable>ARCH</replaceable></command> 命令：
        </para>
<screen>
<prompt>&gt; </prompt>qemu-system-x86_64 \
[...]
-chardev socket,id=chrtpm,path=/var/lib/libvirt/qemu/sle15sp3/mytpm0/swtpm-sock \
-tpmdev emulator,id=tpm0,chardev=chrtpm \
-device tpm-tis,tpmdev=tpm0
</screen>
      </step>
      <step>
        <para>
          运行以下命令，以校验在 Guest 中是否可以使用 TPM 设备：
        </para>
<screen><prompt>&gt; </prompt>tpm_version
TPM 1.2 Version Info:
Chip Version:        1.2.18.158
Spec Level:          2
Errata Revision:     3
TPM Vendor ID:       IBM
TPM Version:         01010000
Manufacturer Info:   49424d00
</screen>
      </step>
    </procedure>
  </sect1>
  <sect1 xml:id="tpm-libvirt">
    <title>将 swtpm 与 <systemitem class="library">libvirt</systemitem> 配合使用</title>

    <para>
      要将 swtpm 与 <systemitem class="library">libvirt</systemitem> 搭配使用，请将以下 TPM 设备添加到 Guest XML 规范中：
    </para>

<screen>
&lt;devices&gt;
 &lt;tpm model='tpm-tis'&gt;
  &lt;backend type='emulator' version='2.0'/&gt;
 &lt;/tpm&gt;
&lt;/devices&gt;
</screen>

    <para>
      <systemitem class="library">libvirt</systemitem> 将自动为 Guest 启动 swtpm。您无需提前手动启动 swtpm。相应的 <filename>permall</filename> 文件是在 <filename>/var/lib/libvirt/swtpm/<replaceable>VM_UUID</replaceable></filename> 中创建的。
    </para>
  </sect1>
  <sect1 xml:id="tpm-ovmf">
    <title>使用 OVMF 固件进行 TPM 测量</title>

    <para>
      如果 Guest 使用开放虚拟机固件 (OVMF)，它将使用 TPM 来测量组件。可以在 <filename>/sys/kernel/security/tpm0/binary_bios_measurements</filename> 中找到事件日志。
    </para>
  </sect1>
  <sect1 xml:id="qemu-tpm-resources">
    <title>资源</title>

    <itemizedlist>
      <listitem>
        <para>
          维基百科在 <link xlink:href="https://en.wikipedia.org/wiki/Trusted_Platform_Module"/> 页面上全面介绍了 TPM。
        </para>
      </listitem>
      <listitem>
        <para>
          <xref linkend="cha-vt-installation"/>中介绍了如何在 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 上配置特定的虚拟化环境。
        </para>
      </listitem>
      <listitem>
        <para>
          有关如何使用<package>swtpm</package> 的细节，请参见其手册页 (<command>man 8 swtpm</command>)。
        </para>
      </listitem>
      <listitem>
        <para>
          <link xlink:href="https://libvirt.org/formatdomain.html#elementsTpm"/> 上提供了 TPM 的详细 <systemitem class="library">libvirt</systemitem> 规范
        </para>
      </listitem>
      <listitem>
        <para>
          <xref linkend="sec-vt-installation-ovmf"/>中介绍了如何使用 OVMF 启用 UEFI 固件。
        </para>
      </listitem>
    </itemizedlist>
  </sect1>
</chapter>
