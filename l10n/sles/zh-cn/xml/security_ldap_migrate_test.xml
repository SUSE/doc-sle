<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="security_ldap_migrate_test.xml" version="5.0" xml:id="sec-security-ldap-migrate">
  <info>
    <title>从 OpenLDAP 迁移到 389 Directory Server</title>
    <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
      <dm:translation>yes</dm:translation>
    </dm:docmanager>
  </info>

  <para>
    <phrase os="sles;sled">从 SUSE Linux Enterprise 15 SP3 开始</phrase>，OpenLDAP 已弃用且不再受支持。它已由 389 Directory Server 取代。SUSE 提供了 <command>openldap_to_ds</command> 实用程序用于帮助迁移，该实用程序随附在 <package>389-ds</package> 软件包中。
  </para>

  <para>
    <command>openldap_to_ds</command> 实用程序会自动执行尽可能多的迁移工作。但是，每个 LDAP 部署各不相同，因此我们无法开发适合所有情况的工具。请在必要时进行干预并执行手动步骤。此外还需在尝试进行生产迁移之前全面测试您的迁移过程。
  </para>

  <important>
    <title>查看 <command>help</command> 页面</title>
    <para>
      在使用 <command>openldap_to_ds</command> 迁移工具之前，强烈建议您查看 <command>openldap_to_ds
      &#x2011;&#x2011;help</command> 的输出。它有助于您了解迁移工具的功能和限制，并防止您做出错误的假设。
    </para>
  </important>

  <sect2 xml:id="sec-security-ldap-migrate-test">
    <title>测试从 OpenLDAP 迁移</title>
    <para>
      由于 OpenLDAP 与 389 Directory Server 的差异非常大，因此需要对迁移进行反复测试和调整。执行快速迁移测试会很有帮助，这样可大致了解需要执行哪些步骤才能确保迁移成功。
    </para>
    <para>
      先决条件：
    </para>
    <itemizedlist>
      <listitem>
        <para>
          正在运行的 389 Directory Server 实例
        </para>
      </listitem>
      <listitem>
        <para>
          采用动态 ldif 格式的 OpenLDAP <filename>slapd</filename> 配置文件或目录
        </para>
      </listitem>
      <listitem>
        <para>
          OpenLDAP 数据库的 ldif 文件备份
        </para>
      </listitem>
    </itemizedlist>
    <para>
      如果您的 slapd 配置不是动态 ldif 格式，请使用 <command>slaptest</command> 创建动态副本。创建一个 <filename>slapd.d</filename> 目录（例如 <filename>/root/slapd.d/</filename>），然后运行以下命令：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>slaptest -f /etc/openldap/slapd.conf -F /root/slapd.d</command>
     </screen>
    <para>
      这会生成几个类似于以下示例的文件：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>ls /root/slapd.d/*</command>

/root/slapd.d/cn=config.ldif

/root/slapd.d/cn=config:
cn=module{0}.ldif  cn=schema.ldif                 olcDatabase={0}config.ldif
cn=schema          olcDatabase={-1}frontend.ldif  olcDatabase={1}mdb.ldif
</screen>
    <para>
      为每个后缀创建一个 ldif 文件。在以下示例中，后缀为 dc=<replaceable>LDAP1</replaceable>,dc=<replaceable>COM</replaceable>。如果您使用的是 <filename>/etc/openldap/slapd.conf</filename> 格式，请运行以下命令创建 ldif 备份文件：
    </para>
<screen>
<prompt>&gt; </prompt><command>sudo</command> <command>slapcat -f /etc/openldap/slapd.conf -b dc=<replaceable>LDAP1</replaceable>,dc=<replaceable>COM</replaceable></command> \
<command>-l <replaceable>/root/LDAP1-COM</replaceable>.ldif</command>
   </screen>
    <para>
      使用 <command>openldap_to_ds</command> 分析配置和文件，并显示迁移计划而不更改任何内容：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>openldap_to_ds <replaceable>LDAP1</replaceable></command>\
<command>/root/slapd.d <replaceable>/root/LDAP1-COM</replaceable>.ldif.ldif</command></screen>
    <para>
      这会执行试运行，但不更改任何内容。输出如下所示：
    </para>
<screen>Examining OpenLDAP Configuration ...
Completed OpenLDAP Configuration Parsing.
Examining Ldifs ...
Completed Ldif Metadata Parsing.
The following migration steps will be performed:
 * Schema Skip Unsupported Attribute -&gt; otherMailbox (0.9.2342.19200300.100.1.22)
 * Schema Skip Unsupported Attribute -&gt; dSAQuality (0.9.2342.19200300.100.1.49)
 * Schema Skip Unsupported Attribute -&gt; singleLevelQuality (0.9.2342.19200300.100.1.50)
 * Schema Skip Unsupported Attribute -&gt; subtreeMinimumQuality (0.9.2342.19200300.100.1.51)
 * Schema Skip Unsupported Attribute -&gt; subtreeMaximumQuality (0.9.2342.19200300.100.1.52)
 * Schema Create Attribute -&gt; suseDefaultBase (SUSE.YaST.ModuleConfig.Attr:2)
 * Schema Create Attribute -&gt; suseNextUniqueId (SUSE.YaST.ModuleConfig.Attr:3)
[...]
 * Schema Create ObjectClass -&gt; suseDhcpConfiguration (SUSE.YaST.ModuleConfig.OC:10)
 * Schema Create ObjectClass -&gt; suseMailConfiguration (SUSE.YaST.ModuleConfig.OC:11)
 * Database Reindex -&gt; dc=example,dc=com
 * Database Import Ldif -&gt; dc=example,dc=com from example.ldif -
excluding entry attributes = [{'structuralobjectclass', 'entrycsn'}]
No actions taken. To apply migration plan, use '--confirm'
</screen>
    <para>
      以下示例会执行迁移，其输出与试运行后的输出不同：
    </para>
    <screen><?dbfo keep-together="always"?>

  <prompt>&gt; </prompt><command>sudo</command> <command>openldap_to_ds <replaceable>LDAP1</replaceable> /root/slapd.d <replaceable>/root/LDAP1-COM</replaceable>.ldif --confirm</command>
Starting Migration ... This may take some time ...
migration: 1 / 40 complete ...
migration: 2 / 40 complete ...
migration: 3 / 40 complete ...
[...]
Index task index_all_05252021_120216 completed successfully
post: 39 / 40 complete ...
post: 40 / 40 complete ...
🎉 Migration complete!
----------------------
You should now review your instance configuration and data:
 * [ ] - Create/Migrate Database Access Controls (ACI)
 * [ ] - Enable and Verify TLS (LDAPS) Operation
 * [ ] - Schedule Automatic Backups
 * [ ] - Verify Accounts Can Bind Correctly
 * [ ] - Review Schema Inconistent ObjectClass -&gt; pilotOrganization (0.9.2342.19200300.100.4.20)
 * [ ] - Review Database Imported Content is Correct -&gt; dc=ldap1,dc=com
</screen>
    <para>
      迁移完成后，<command>openldap_to_ds</command> 会创建必须完成的迁移后任务核对清单。最好记录迁移后步骤，以便可以在后期生产过程中再现这些步骤。然后测试客户端和应用程序与迁移后 389 Directory Server 实例的集成。
    </para>
    <important>
      <title>制定回滚计划</title>
      <para>
        制定回滚计划以防发生任何失败。此计划应该定义成功迁移的要素、用于确定哪些方面正常以及哪些方面需要修复的测试、至关重要的步骤、可以推迟的事项、如何确定何时撤消更改、如何在尽量减少服务中断的情况下撤消更改，以及其他哪些团队需要参与迁移。
      </para>
    </important>
    <para>
      由于部署的可变性，很难提供成功进行生产迁移的通用方法。在全面测试迁移过程并确认结果正常后，以下常规步骤将有助于：
    </para>
    <itemizedlist>
      <listitem>
        <para>
          在做出更改之前的 48 小时将所有主机名/DNS TTL 减少至 5 分钟，以便能够快速回滚到现有的 OpenLDAP 部署。
        </para>
      </listitem>
      <listitem>
        <para>
          暂停所有数据同步和传入数据过程，以确保 OpenLDAP 环境中的数据在迁移期间不会更改。
        </para>
      </listitem>
      <listitem>
        <para>
          在迁移之前准备好所有要部署 389 Directory Server 的主机。
        </para>
      </listitem>
      <listitem>
        <para>
          准备好测试迁移文档。
        </para>
      </listitem>
    </itemizedlist>
  </sect2>

  <sect2 xml:id="sec-security-ldap-migrate-saslauthd">
    <title>测试使用 <literal>saslauthd</literal> 的 OpenLDAP 服务器迁移</title>
    <para>
      在 OpenLDAP 部署中，常会使用 <literal>saslauthd</literal> 来进行用户的直通身份验证。身份验证过程涉及以下组件：
    </para>
<screen>
 ┌─────────────────┐
 │                 │
 │   LDAP client   │
 │                 │
 └─────────────────┘
          │
      binds to
          │
          ▼
 ┌─────────────────┐
 │    OpenLDAP     │
 │     server      │
 │                 │
 └─────────────────┘
          │
          │
          ▼
 ┌─────────────────┐
 │                 │
 │    saslauthd    │
 │                 │
 └─────────────────┘
          │
          │
          ▼
 ┌─────────────────┐
 │                 │
 │  External auth  │
 │                 │
 └─────────────────┘
</screen>
    <para>
      为了检查配置的正确性以及以后进行故障排除，务必要了解以下信息：
    </para>
    <itemizedlist>
      <listitem>
        <para>
          如果 <literal>userPassword</literal> 属性的值采用 <literal>userPassword:
          {SASL}<replaceable>USERNAME@REALM</replaceable></literal> 格式，则 OpenLDAP 会发现允许对用户进行直通身份验证。前提是要构建 OpenLDAP 服务器，并设置 <literal>--enable-spasswd</literal> 选项以启用直通身份验证。
        </para>
      </listitem>
      <listitem>
        <para>
          OpenLDAP 通过 <filename>/usr/lib/sasl2/slapd.conf</filename> 配置与 <literal>saslauthd</literal> 的连接。
        </para>
      </listitem>
      <listitem>
        <para>
          <literal>saslauthd</literal> 会使用 <literal>/etc/sysconfig/saslauthd</literal> 中配置的命令行参数来发现相关模块。
        </para>
      </listitem>
      <listitem>
        <para>
          <literal>saslauthd</literal> 的后端模块则使用自己的配置（如 <command>man saslauthd</command> 中所述）。
        </para>
      </listitem>
    </itemizedlist>
    <para>
      有关使用 OpenLDAP 的直通身份验证的详细信息，请参见官方 <link xlink:href="https://openldap.org/doc/admin24/security.html#Pass-Through%20authentication">OpenLDAP 管理指南</link>。
    </para>
    <sect3 xml:id="sec-security-ldap-migrate-saslauthd-procedure">
      <title>将 SASL 直通身份验证从 OpenLDAP 迁移到 389 Directory Server</title>
      <para>
        为遵循将 SASL 直通身份验证从 OpenLDAP 正确迁移到 389 Directory Server 的最佳实践，请按照以下步骤操作：
      </para>
      <procedure>
        <step>
          <para>
            在迁移之前，确保您可以在 OpenLDAP 服务器上成功运行 <command>testsaslauthd</command>。
          </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>testsaslauthd -u <replaceable>USERNAME@REALM</replaceable> -p <replaceable>PASSWORD</replaceable></command></screen>
          <para>
            该领域会将身份验证路由到 <literal>saslauthd</literal> 中的正确后端，然后使用用户名来检查身份。
          </para>
        </step>
        <step>
          <para>
            安装可使 389 Directory Server 能与 <literal>saslauthd</literal> 连接的软件包 <package>pam_saslauthd</package>。
          </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>zypper install -y pam_saslauthd</command></screen>
        </step>
        <step>
          <para>
            运行 <command>openldap_to_ds</command> 命令行工具从 OpenLDAP 迁移到 389 Directory Server。有关该迁移过程的详细信息，请参见<xref linkend="sec-security-ldap-migrate-test"/>。
          </para>
          <note>
            <para>
              在 <command>openldap_to_ds</command> 进程运行时，如果检测到某用户 <literal>userPssword</literal> 属性的值采用 <literal>userPassword:
              {SASL}<replaceable>USERNAME@REALM</replaceable></literal> 格式，则会将该值去除并设置为 <literal>nsSaslauthId</literal> 属性的值（采用 <literal>nsSaslauthId:
              <replaceable>USERNAME@REALM</replaceable></literal> 格式）。此外，系统会自动添加属性值 <literal>objectClass:
              nsSaslauthAccount</literal> 以支持修改。
            </para>
          </note>
        </step>
        <step>
          <para>
            迁移完成后，运行以下命令检查是否正确配置了 PAM 直通身份验证：
          </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>dsconf <replaceable>INSTANCE</replaceable> plugin pam-pass-through-auth show</command></screen>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>dsconf <replaceable>INSTANCE</replaceable> plugin pam-pass-through-auth list</command></screen>
        </step>
      </procedure>
      <para>
        成功迁移后，直通身份验证流程涉及以下组件：
      </para>
<screen><?dbfo keep-together="always"?>

  ┌─────────────────┐
  │                 │
  │   LDAP client   │
  │                 │
  └─────────────────┘
           │
       binds to
           │
           ▼
  ┌─────────────────┐
  │     389-DS      │
  │     server      │
  │                 │
  └─────────────────┘
           │
           ▼
  ┌─────────────────┐
  │                 │
  │  pam saslauthd  │
  │                 │
  └─────────────────┘
           │
           ▼
  ┌─────────────────┐
  │                 │
  │    saslauthd    │
  │                 │
  └─────────────────┘
           │
           │
           ▼
  ┌─────────────────┐
  │                 │
  │  External auth  │
  │                 │
  └─────────────────┘

</screen>
    </sect3>
    <sect3 xml:id="sec-security-ldap-troubleshoot-saslauthd">
      <title><literal>saslauthd</literal> 直通身份验证查错</title>
      <para>
        要对从 OpenLDAP 迁移到 389 Directory Server 之前和之后的 <literal>saslauthd</literal> 直通身份验证问题查错，请参见以下提示：
      </para>
      <variablelist>
        <varlistentry>
          <term>确保 <command>testsaslauthd</command> 适用于 <replaceable>USERNAME@REALM</replaceable>。</term>
          <listitem>
            <para>
              请参见<xref linkend="sec-security-ldap-migrate-saslauthd"/>中运行 <command>testsaslauthd</command> 的步骤。
            </para>
            <para>
              如果出现问题，请尝试以下方法：
            </para>
            <itemizedlist>
              <listitem>
                <para>
                  检查 <filename>/etc/sysconfig/saslauthd</filename>，确保 <literal>saslauthd</literal> 后端模块配置正确。有关 <literal>saslauthd</literal> 后端模块及其配置的详细信息，请运行 <command>man saslauthd</command>
                </para>
              </listitem>
              <listitem>
                <para>
                  在 <filename>/etc/sysconfig/saslauthd</filename> 中添加 <literal>SASLAUTHD_PARAMS="-d"</literal> 以启用调试日志记录。
                </para>
              </listitem>
              <listitem>
                <para>
                  查看 <command>journalctl</command> 命令输出中的 <literal>saslauthd</literal> 日志。
                </para>
              </listitem>
            </itemizedlist>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term>确保 PAM <literal>saslauthd</literal> 可正常工作。</term>
          <listitem>
            <para>
              要检查 PAM <literal>saslauthd</literal> 是否正常工作，您可以使用 <link xlink:href="https://github.com/kanidm/pam_tester"/> 上提供的 <command>pam_tester</command> 工具。
            </para>
            <note>
              <para>
                <command>pam_tester</command> 工具不受官方支持。
              </para>
            </note>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term>确保已启用 PAM Pass Through Auth 插件。</term>
          <listitem>
            <para>
              运行以下命令检查 PAM Pass Through Auth 插件的状态：
            </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>dsconf <replaceable>INSTANCE</replaceable> plugin pam-passt-through-auth status</command></screen>
            <para>
              要启用该插件，请运行以下命令：
            </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>dsconf <replaceable>INSTANCE</replaceable> plugin pam-pass-through-auth enable</command></screen>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term>检查 PAM Pass Through Auth 插件的配置。</term>
          <listitem>
            <para>
              要检查服务器实例的 PAM Pass Through Auth 插件配置，请运行以下命令：
            </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>dsconf <replaceable>INSTANCE</replaceable> plugin pam-pass-through-auth show</command></screen>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term>检查服务器实例的用户错误日志。</term>
          <listitem>
            <para>
              检查 <filename>/var/lib/<replaceable>SERVER_USER_NAME</replaceable>/<replaceable>INSTANCE</replaceable>/error</filename> 中的日志。
            </para>
          </listitem>
        </varlistentry>
      </variablelist>
    </sect3>
  </sect2>

  <sect2 xml:id="sec-security-ldap-migrate-plan">
    <title>规划迁移</title>
    <para>
      由于 OpenLDAP 如同一个<quote>零件箱</quote>且高度可自定义，因此无法制定出<quote>放之四海皆准</quote>的迁移计划。因而有必要针对 OpenLDAP 和其他集成评估您的当前环境和配置。这包括但不限于：
    </para>
    <itemizedlist>
      <listitem>
        <para>
          复制拓扑
        </para>
      </listitem>
      <listitem>
        <para>
          高可用性和负载平衡器配置
        </para>
      </listitem>
      <listitem>
        <para>
          外部数据流（IGA、HR、AD 等）
        </para>
      </listitem>
      <listitem>
        <para>
          配置的叠加组件（389 Directory Server 中的插件）
        </para>
      </listitem>
      <listitem>
        <para>
          客户端配置和预期的服务器功能
        </para>
      </listitem>
      <listitem>
        <para>
          自定义纲要
        </para>
      </listitem>
      <listitem>
        <para>
          TLS 配置
        </para>
      </listitem>
    </itemizedlist>
    <para>
      规划 389 Directory Server 部署的最终大致结果。此项规划包含的内容与上面的列表相同，不过需要将叠加组件替换为插件。评估当前环境并规划您预期的 389 Directory Server 环境后，便可以制定迁移计划。建议构建与 OpenLDAP 环境并行的 389 Directory Server 环境，以便可以在两者之间切换。
    </para>
    <para>
      从 OpenLDAP 迁移到 389 Directory Server 属于单向迁移。两者之间的差异相当大，因此它们不可互操作，并且不存在从 389 Directory Server 到 OpenLDAP 的迁移路径。下表重点指出了两者的主要相似和不同之处。
    </para>
    <informaltable>
      <tgroup cols="4">
        <thead>
          <row>
            <entry>功能</entry>
            <entry>OpenLDAP</entry>
            <entry>389 Directory Server</entry>
            <entry>兼容</entry>
          </row>
        </thead>
        <tbody>
          <row>
            <entry>双向复制</entry>
            <entry>SyncREPL</entry>
            <entry>特定于 389 DS 的系统</entry>
            <entry>否</entry>
          </row>
          <row>
            <entry>MemberOf</entry>
            <entry>叠加组件</entry>
            <entry>插件</entry>
            <entry>是，仅限简单配置</entry>
          </row>
          <row>
            <entry>外部身份验证</entry>
            <entry>代理</entry>
            <entry>-</entry>
            <entry>否</entry>
          </row>
          <row>
            <entry>Active Directory 同步</entry>
            <entry>-</entry>
            <entry>Winsync 插件</entry>
            <entry>否</entry>
          </row>
          <row>
            <entry>内置纲要</entry>
            <entry>OLDAP 纲要</entry>
            <entry>389 Directory Server 纲要</entry>
            <entry>是，受迁移工具支持</entry>
          </row>
          <row>
            <entry>自定义纲要</entry>
            <entry>OLDAP 纲要</entry>
            <entry>389 Directory Server 纲要</entry>
            <entry>是，受迁移工具支持</entry>
          </row>
          <row>
            <entry>数据库导入</entry>
            <entry>LDIF</entry>
            <entry>LDIF</entry>
            <entry>是，受迁移工具支持</entry>
          </row>
          <row>
            <entry>口令哈希</entry>
            <entry>不确定</entry>
            <entry>不确定</entry>
            <entry>是，支持除 Argon2 以外的所有格式</entry>
          </row>
          <row>
            <entry>OpenLDAP 到 389 DS 的复制</entry>
            <entry>-</entry>
            <entry>-</entry>
            <entry>不提供用于复制到 389 DS 的机制</entry>
          </row>
          <row>
            <entry>基于时间的一次性口令 (TOTP)</entry>
            <entry>TOTP 叠加组件</entry>
            <entry>-</entry>
            <entry>否，目前不支持</entry>
          </row>
          <row>
            <entry>entryUUID</entry>
            <entry>OpenLDAP 的组成部分</entry>
            <entry>插件</entry>
            <entry>是</entry>
          </row>
        </tbody>
      </tgroup>
    </informaltable>
  </sect2>
</sect1>
