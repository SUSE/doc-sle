<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="storage_fcoe.xml" version="5.0" xml:id="cha.fcoe" xml:lang="zh-cn">
 <title>以太网光纤通道储存：FCoE</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <para>
  许多企业数据中心的 LAN 和数据流量都依赖于以太网，而其储存基础设施则依赖于光纤通道网络。开放以太网光纤通道 (FCoE) 发起程序软件允许配有以太网适配器的服务器经由以太网网络连接光纤通道储存子系统。而在以前，只允许配有光纤通道适配器的系统经由光纤通道架构进行连接。FCoE 技术通过支持网络融合降低了数据中心的复杂度。这有助于保护您在光纤通道储存基础设施方面的现有投资，并简化网络管理。
 </para>
 <figure>
  <title>开放以太网 SAN 光纤通道</title>
  <mediaobject>
   <imageobject role="fo">
    <imagedata fileref="fcoe_san_a.svg" width="80%" format="SVG"/>
   </imageobject>
   <imageobject role="html">
    <imagedata fileref="fcoe_san_a.png" width="100%" format="PNG"/>
   </imageobject>
  </mediaobject>
 </figure>
 <para>
  Open-FCoE 可让您在主机上而不是主机总线适配器上的专有硬件上运行光纤通道协议。它专用于 10 Gbps（每秒千兆位）以太网适配器，但也可用于任何支持暂停帧的以太网适配器。发起端软件提供光纤通道协议处理模块以及基于以太网的传输模块。Open-FCoE 模块充当 SCSI 的低级驱动程序。Open-FCoE 传输使用 <command>net_device</command> 发送和接收包。数据中心桥接 (DCB) 驱动程序提供 FCoE 的服务质量。
 </para>
 <para>
  FCoE 是一种封装协议，它可以通过以太网连接移动光纤通道协议流量而无需更改光纤通道数据帧。如此一来，您的网络安全和流量管理基础设施就可以像使用光纤通道一样使用 FCoE。
 </para>
 <para>
  如果存在下列情况，您可以选择在您的企业中部署 FCoE：
 </para>
 <itemizedlist mark="bullet" spacing="normal">
  <listitem>
   <para>
    贵企业已有光纤通道储存子系统，并拥有具备光纤通道技能和知识的管理员。
   </para>
  </listitem>
  <listitem>
   <para>
    您的网络中部署的是 10 Gbps 以太网。
   </para>
  </listitem>
 </itemizedlist>
 <para>
  本节说明如何在您的网络中设置 FCoE。
 </para>
 <sect1 xml:id="sec.fcoe.installation">
  <title>安装过程中配置 FCoE 接口</title>

  <para>
   如果在交换器上为服务器与光纤通道储存基础结构之间的连接启用了 FCoE，则可以通过适用于 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 的 YaST 来在操作系统安装期间设置 FCoE 磁盘。有些类型的系统 BIOS 能够自动检测到 FCoE 磁盘，并向 YaST 安装软件报告该磁盘。但不是所有类型的 BIOS 都支持 FCoE 磁盘自动检测。在此情况下若要启用自动检测，您可以在开始安装时将 <command>withfcoe</command> 选项添加到内核命令行：
  </para>

<screen>withfcoe=1</screen>

  <para>
   当检测到 FCoE 磁盘时，YaST 安装便会在当时提供配置 FCoE 实例的选项。在“磁盘激活”页面上，选择<guimenu>配置 FCoE 接口</guimenu>，以访问 FCoE 配置。有关配置 FCoE 接口的信息，请参见<xref linkend="sec.fcoe.yast" xrefstyle="SectTitleOnPage"/>。
  </para>

  <informalfigure>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="fcoe_inst_disk_activation_a.png" width="80%" format="PNG"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="fcoe_inst_disk_activation_a.png" width="10%" format="PNG"/>
    </imageobject>
   </mediaobject>
  </informalfigure>
 </sect1>
 <sect1 xml:id="sec.fcoe.install">
  <title>安装 FCoE 和 YaST FCoE 客户端</title>

  <para>
   您可以通过在交换机上为服务器的连接启用 FCoE，来于储存基础设施中设置 FCoE 磁盘。如果在安装 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 操作系统时 FCoE 磁盘可用，系统会在那时自动安装 FCoE 发起程序软件。
  </para>

  <para>
   如果 FCoE 发起程序软件和 YaST FCoE 客户端软件均未安装，请使用下列程序通过下面的命令手动安装它们：
  </para>

<screen>sudo zypper in yast2-fcoe-client fcoe-utils</screen>

  <para>
   也可以使用 YaST 软件管理器来安装以上所列包。
  </para>
 </sect1>
 <sect1 xml:id="sec.fcoe.yast">
  <title>使用 YaST 管理 FCoE 服务</title>

  <para>
   您可以使用“YaST FCoE 客户端配置”选项为光纤通道储存基础设施中的 FCoE 磁盘创建、配置和删除 FCoE 接口。若要使用此选项，必须安装并运行 FCoE 发起程序服务（<systemitem class="daemon">fcoemon</systemitem> 守护程序）和“链路层发现协议”代理守护程序 (<systemitem class="daemon">llpad</systemitem>)，并且必须在支持 FCoE 的交换器上启用 FCoE 连接。
  </para>

  <procedure>
   <step>
    <para>
     起动 YaST 并选择<menuchoice><guimenu>网络服务</guimenu><guimenu>FCoE 客户端配置</guimenu></menuchoice>。
    </para>
    <informalfigure>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="fcoe_services_a.png" width="80%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="fcoe_services_a.png" width="100%" format="PNG"/>
      </imageobject>
     </mediaobject>
    </informalfigure>
   </step>
   <step>
    <para>
     在<guimenu>服务</guimenu>选项卡上，可按需要查看或修改 FCoE 服务和 Lldpad（链路层发现协议代理守护程序）服务启动时间。
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <formalpara>
       <title>FCoE 服务启动：</title>
       <para>
        指定是在服务器引导时启动以太网光纤通道服务 <command>fcoemon</command> 守护程序还是手动启动。该守护程序用于控制 FCoE 接口，并可与 <systemitem class="daemon">llpad</systemitem> 守护程序创建连接。可用值为<guimenu>引导时</guimenu>（默认）或<guimenu>手动</guimenu>。
       </para>
      </formalpara>
     </listitem>
     <listitem>
      <formalpara>
       <title>Lldpad 服务启动：</title>
       <para>
        指定是在服务器引导时启动“链路层发现协议”代理 <systemitem class="daemon">llpad</systemitem> 守护程序，还是手动启动该守护程序。<systemitem class="daemon">llpad</systemitem> 守护程序会向 <command>fcoemon</command> 守护程序报告数据中心桥接功能和 FCoE 接口配置的相关信息。可用值为<guimenu>引导时</guimenu>（默认）或<guimenu>手动</guimenu>。
       </para>
      </formalpara>
     </listitem>
    </itemizedlist>
    <para>
     如果修改设置，则单击<guimenu>确定</guimenu>保存并应用更改。
    </para>
   </step>
   <step>
    <para>
     在<guimenu>接口</guimenu>选项卡上，可查看有关服务器上所有检测到的网络适配器的信息，包括有关 VLAN 和 FCoE 配置的信息。您也可以创建 FCoE VLAN 接口、更改现有 FCoE 接口的设置，或删除 FCoE 接口。
    </para>
    <informalfigure>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="fcoe_notconfig_interface_a.png" width="80%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="fcoe_notconfig_interface_a.png" width="100%" format="PNG"/>
      </imageobject>
     </mediaobject>
    </informalfigure>
    <para>
     请使用 <guimenu>FCoE VLAN 接口</guimenu>列来确定 FCoE 是否可用：
    </para>
    <variablelist>
     <varlistentry>
      <term><replaceable>接口名</replaceable>
      </term>
      <listitem>
       <para>
        如果将 <filename>eth4.200</filename> 之类名称指派给接口，则 FCoE 在交换机上可用，并会为该适配器激活 FCoE 接口。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>未配置：</term>
      <listitem>
       <para>
        如果状态为<guimenu>未配置</guimenu>，则表示在交换机上启用 FCoE 但尚未为适配器激活 FCoE 接口。选择适配器，然后单击<guimenu>创建 FCoE VLAN 接口</guimenu>，以在适配器上激活接口。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>不可用：</term>
      <listitem>
       <para>
        如果状态为<guimenu>不可用</guimenu>，则表示因为没有在交换机上为该连接启用 FCoE，所以 FCoE 对适配器不可用。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </step>
   <step>
    <para>
     若要设置未经设置的支持 FCoE 的适配器，予以选中，然后单击<guimenu>创建 FCoE VLAN 接口</guimenu>。对出现的问题请单击<guimenu>是</guimenu>确认。
    </para>
    <para>
     该适配器现在会以某个接口名称列在 <guimenu>FCoE VLAN 接口</guimenu>列中。
    </para>
   </step>
   <step>
    <para>
     若要更改已设置适配器的设置，请在列表中选择它，然后单击<guimenu>更改设置</guimenu>。
    </para>
    <para>
     可设置下列选项：
    </para>
    <variablelist>
     <varlistentry>
      <term><guimenu>启用 FCoE</guimenu>
      </term>
      <listitem>
       <para>
        启用或禁用为适配器创建 FCoE 实例。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><guimenu>需要 DCB</guimenu>
      </term>
      <listitem>
       <para>
        指定适配器是否需要数据中心桥接（通常会需要）。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><guimenu>自动 VLAN</guimenu>
      </term>
      <listitem>
       <para>
        指定 <systemitem class="daemon">fcoemon</systemitem> 守护程序是否自动创建 VLAN 接口。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     如果修改设置，则单击<guimenu>下一步</guimenu>保存并应用更改。设置将写入 <filename>/etc/fcoe/cfg-eth<replaceable>X</replaceable></filename> 文件。<systemitem class="daemon">fcoemon</systemitem> 守护程序会在初始化时读取每个 FCoE 接口的配置文件。
    </para>
   </step>
   <step>
    <para>
     若要去除已设置的接口，请从列表中选择它。单击<guimenu>删除接口</guimenu>，然后单击<guimenu>继续</guimenu>确认。FCoE 接口值将更改为<guimenu>未配置</guimenu>。
    </para>
   </step>
   <step>
    <para>
     在<guimenu>配置</guimenu>选项卡上，可查看或修改 FCoE 系统服务的常规设置。您可以从 FCoE 服务脚本和 <systemitem class="daemon">fcoemon</systemitem> 守护程序中启用或禁用调试讯息，并可指定是否将讯息发送至系统日志。
    </para>
    <informalfigure>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="fcoe_configtab_a.png" width="80%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="fcoe_configtab_a.png" width="100%" format="PNG"/>
      </imageobject>
     </mediaobject>
    </informalfigure>
   </step>
   <step>
    <para>
     单击<guimenu>确定</guimenu>保存并应用更改。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.fcoe.cli">
  <title>使用命令配置 FCoE</title>

  <procedure>
   <step>
    <para>
     打开一个终端控制台。
    </para>
   </step>
   <step>
    <para>
     使用 YaST 配置以太网网络接口卡，例如 <filename>eth2</filename>。
    </para>
   </step>
   <step>
    <para>
     启动“链接层发现协议”代理守护程序 (<systemitem class="daemon">llpad</systemitem>)。
    </para>
<screen>sudo systemctl start lldpad</screen>
   </step>
   <step>
    <para role="intro">
     在以太网适配器上启用数据中心桥接。
    </para>
<screen><prompt>tux &gt; </prompt>dcbtool sc eth2 dcb on
  Version:       2
  Command:       Set Config
  Feature:       DCB State
  Port:          eth2
  Status:        Successful</screen>
   </step>
   <step>
    <para>
     启用并设置数据中心桥接的优先级流量控制 (PFC) 设置。
    </para>
<screen>sudo dcbtool sc eth&lt;x&gt; pfc e:1 a:1 w:1</screen>
    <para>
     自变量设置值为：
    </para>
    <variablelist>
     <varlistentry xml:id="bynkj1s">
      <term>e:&lt;0|1&gt;</term>
      <listitem>
       <para>
        控制功能的启用。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="bynkjej">
      <term>a:&lt;0|1&gt;</term>
      <listitem>
       <para>
        控制是否通过数据中心桥接交换协议向对等体推广功能。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="bynkjy8">
      <term>w:&lt;0|1&gt;</term>
      <listitem>
       <para>
        控制功能是否希望根据从对等体接收到的反馈来更改其操作配置。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </step>
   <step>
    <para>
     启用数据中心桥接，以接受交换机的 FCoE 优先级设置。
    </para>
<screen><prompt>tux &gt; </prompt>sudo dcbtool sc eth2 app:fcoe e:1
  Version:       2
  Command:       Set Config
  Feature:       Application FCoE
  Port:          eth2
  Status:        Successful</screen>
   </step>
   <step>
    <para>
     将默认的 FCoE 配置文件复制到 <filename>/etc/fcoe/cfg-eth2</filename>。
    </para>
<screen>sudo cp /etc/fcoe/cfg-ethx /etc/fcoe/cfg-eth2</screen>
   </step>
   <step>
    <para>
     启动 FCoE 发起程序服务。
    </para>
<screen>systemctl start fcoe.service</screen>
   </step>
   <step>
    <para>
     将“链接层发现协议”代理守护程序 (<systemitem class="daemon">llpad</systemitem>) 和 FCoE 发起程序服务设置为引导时启动。
    </para>
<screen>systemctl enable llpad fcoe</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.fcoe.admin">
  <title>使用 FCoE 管理工具管理 FCoE 实例</title>

  <para>
   <command>fcoeadm</command> 实用程序是以太网光纤通道 (FCoE) 管理工具。可以使用该工具创建、销毁和重置指定网络接口上的 FCoE 实例。<command>fcoeadm</command> 实用程序通过套接字接口将命令发送给正在运行的 <systemitem class="daemon">fcoemon</systemitem> 进程。有关 <command>fcoemon</command> 的相关信息，请参见 <command>man 8 fcoemon</command>。
  </para>

  <para>
   <command>fcoeadm</command> 实用程序可让您查询 FCoE 实例的以下相关信息：
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     接口
    </para>
   </listitem>
   <listitem>
    <para>
     目标 LUN
    </para>
   </listitem>
   <listitem>
    <para>
     端口统计数字
    </para>
   </listitem>
  </itemizedlist>

  <para>
   <command>fcoeadm</command> 实用程序是 <filename>fcoe-utils</filename> 包的组成部分，该命令的一般语法如下所示：
  </para>

<screen>fcoeadm
  [-c|--create] [&lt;ethX&gt;]
  [-d|--destroy] [&lt;ethX&gt;]
  [-r|--reset] [&lt;ethX&gt;]
  [-S|--Scan] [&lt;ethX&gt;]
  [-i|--interface] [&lt;ethX&gt;]
  [-t|--target] [&lt;ethX&gt;]
  [-l|--lun] [&lt;ethX&gt;]
  [-s|--stats &lt;ethX&gt;] [&lt;interval&gt;]
  [-v|--version]
  [-h|--help]
</screen>

  <para>
   有关细节，请参见 <command>man 8 fcoeadm</command>。
  </para>

  <bridgehead>示例</bridgehead>

  <variablelist>
   <varlistentry>
    <term><command>fcoeadm -c eth2.101</command>
    </term>
    <listitem>
     <para>
      在 eth2.101 上创建 FCoE 实例。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>fcoeadm -d eth2.101</command>
    </term>
    <listitem>
     <para>
      删除 eth2.101 上的 FCoE 实例。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>fcoeadm -i eth3</command>
    </term>
    <listitem>
     <para>
      显示接口 <literal>eth3</literal> 上所有 FCoE 实例的相关信息。如果未指定任何接口，则会显示所有已创建 FCoE 实例的接口的相关信息。下面的示例显示连接 eth0.201 的相关信息：
     </para>
<screen><prompt>tux &gt; </prompt>sudo fcoeadm -i eth0.201
  Description:      82599EB 10-Gigabit SFI/SFP+ Network Connection 
  Revision:         01
  Manufacturer:     Intel Corporation 
  Serial Number:    001B219B258C 
  Driver:           ixgbe 3.3.8-k2 
  Number of Ports:  1      

      Symbolic Name:     fcoe v0.1 over eth0.201     
      OS Device Name:    host8     
      Node Name:         0x1000001B219B258E     
      Port Name:         0x2000001B219B258E     
      FabricName:        0x2001000573D38141     
      Speed:             10 Gbit     
      Supported Speed:   10 Gbit     
      MaxFrameSize:      2112     
      FC-ID (Port ID):   0x790003     
      State:             Online
</screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>fcoeadm -l eth3.101</command>
    </term>
    <listitem>
     <para>
      显示在连接 eth3.101 上发现到的所有 LUN 的详细信息。如果未指定任何连接，则会显示在所有 FCoE 连接上发现到的所有 LUN 的相关信息。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>fcoeadm -r eth2.101</command>
    </term>
    <listitem>
     <para>
      重设置 eth2.101 上的 FCoE 实例。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>fcoeadm -s eth3 3</command>
    </term>
    <listitem>
     <para>
      以三秒的时间间隔显示具有 FCoE 实例的特定 eth 3 端口的统计信息。每隔一段时间会显示一行统计数字。若未指定时间间隔，则使用默认值一秒。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>fcoeadm -t eth3</command>
    </term>
    <listitem>
     <para>
      显示从具有 FCoE 实例的指定 eth3 端口发现到的所有目标的相关信息。每一个已发现目标后面列出了所有关联的 LUN。若未指定实例，则显示来自具有 FCoE 实例的所有端口的目标。下面的示例显示来自 eth0.201 连接的目标的相关信息：
     </para>
<screen><prompt>tux &gt; </prompt>sudo fcoeadm -t eth0.201  
  Interface:        eth0.201 
  Roles:            FCP Target 
  Node Name:        0x200000D0231B5C72 
  Port Name:        0x210000D0231B5C72 
  Target ID:        0 
  MaxFrameSize:     2048 
  OS Device Name:   rport-8:0-7 
  FC-ID (Port ID):  0x79000C 
  State:            Online  

LUN ID  Device Name   Capacity   Block Size  Description 
------  -----------  ----------  ----------  ----------------------------     
    40  /dev/sdqi     792.84 GB      512     IFT DS S24F-R2840-4 (rev 386C)
    72  /dev/sdpk     650.00 GB      512     IFT DS S24F-R2840-4 (rev 386C)
   168  /dev/sdgy       1.30 TB      512     IFT DS S24F-R2840-4 (rev 386C)
</screen>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec.fcoe.info">
  <title>其他信息</title>

  <para>
   有关信息，请参见以下文档：
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     有关 Open-FCoE 服务守护程序的信息，请参见 <command>fcoemon(8)</command> 手册页。
    </para>
   </listitem>
   <listitem>
    <para>
     有关 Open-FCoE 管理工具的信息，请参见 <command>fcoeadm(8)</command> 手册页。
    </para>
   </listitem>
   <listitem>
    <para>
     有关数据中心桥接配置工具的信息，请参见 <command>dcbtool(8)</command> 手册页。
    </para>
   </listitem>
   <listitem>
    <para>
     有关链路层发现协议代理守护程序的信息，请参见 <filename>lldpad(8)</filename> 手册页。
    </para>
   </listitem>
   <listitem>
    <para>
     有关一般信息，请参见 Open-FCoE 主页：<link xlink:href="http://www.open-fcoe.org/dokuwiki/start"/>。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
