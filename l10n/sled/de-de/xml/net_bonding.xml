<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_bonding.xml" version="5.0" xml:id="sec-network-iface-bonding">
 <title>Einrichten von Bonding-Geräten</title>

 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>

 <para>
  Für bestimmte Systeme sind Netzwerkverbindungen erforderlich, die die normalen Anforderungen an die Datensicherheit oder Verfügbarkeit von typischen Ethernet-Geräten übertreffen. In diesen Fällen lassen sich mehrere Ethernet-Geräte zu einem einzigen Bonding-Gerät zusammenschließen.
 </para>

 <para>
  Die Konfiguration des Bonding-Geräts erfolgt dabei über die Bonding-Moduloptionen. Das Verhalten ergibt sich im wesentlichen aus dem Modus des Bonding-Geräts. Standardmäßig gilt <systemitem>active-backup</systemitem>; wenn der aktive Bond-Port ausfällt, wird also ein anderer Bond-Port aktiviert. Die folgenden Bonding-Modi sind verfügbar:
 </para>

 <variablelist>
  <varlistentry>
   <term><guimenu>0</guimenu> (balance-rr)</term>
   <listitem>
    <para>
     Die Pakete werden per Round-Robin von der ersten bis zur letzten verfügbaren Schnittstelle übertragen. Bietet Fehlertoleranz und Lastausgleich.
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>1</guimenu> (active-backup)</term>
   <listitem>
    <para>
     Nur eine Netzwerkschnittstelle ist aktiv. Wenn diese Schnittstelle ausfällt, wird eine andere Schnittstelle aktiv. Dies ist die Standardeinstellung für <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase>. Bietet Fehlertoleranz.
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>2</guimenu> (balance-xor)</term>
   <listitem>
    <para>
     Der Datenverkehr wird auf alle verfügbaren Schnittstellen aufgeteilt, je nach der Anzahl der Geräte im Bonding. Erfordert Unterstützung durch den Switch. Bietet Fehlertoleranz und Lastausgleich.
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>3</guimenu> (broadcast)</term>
   <listitem>
    <para>
     Der gesamte Datenverkehr wird per Broadcast an alle Schnittstellen übertragen. Erfordert Unterstützung durch den Switch. Bietet Fehlertoleranz.
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>4</guimenu> (802.3ad)</term>
   <listitem>
    <para>
     Aggregiert mehrere Schnittstellen zu einer Gruppe, in der dieselben Geschwindigkeits- und Duplexeinstellungen gelten. Erfordert <command>ethtool</command>-Unterstützung durch die Schnittstellentreiber sowie einen Switch, der die dynamische Link-Aggregation nach IEEE 802.3ad unterstützt und entsprechend konfiguriert ist. Bietet Fehlertoleranz und Lastausgleich.
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>5</guimenu> (balance-tlb)</term>
   <listitem>
    <para>
     Adaptiver Übertragungslastausgleich. Erfordert <command>ethtool</command>-Unterstützung durch die Schnittstellentreiber, jedoch keine Unterstützung durch den Switch. Bietet Fehlertoleranz und Lastausgleich.
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>6</guimenu> (balance-alb)</term>
   <listitem>
    <para>
     Adaptiver Lastausgleich. Erfordert <command>ethtool</command>-Unterstützung durch die Schnittstellentreiber, jedoch keine Unterstützung durch den Switch. Bietet Fehlertoleranz und Lastausgleich.
    </para>
   </listitem>
  </varlistentry>
 </variablelist>

 <para>
  Eine ausführlichere Beschreibung der Modi finden Sie unter <link xlink:href="https://www.kernel.org/doc/Documentation/networking/bonding.txt"/>.
 </para>

 <tip>
  <title>Bonding und Xen</title>
  <para>
   Der Einsatz von Bonding-Geräten empfiehlt sich nur für Computer, in denen mehrere physische Netzwerkkarten eingebaut sind. Bei den meisten Konstellationen sollten Sie die Bonding-Konfiguration daher lediglich in Dom0 verwenden. Die Bond-Einrichtung in einem VM-Gast-System ist dabei nur dann sinnvoll, wenn dem VM-Gast mehrere Netzwerkkarten zugewiesen sind.
  </para>
 </tip>

 <note arch="power">
  <title>
   IBM POWER: Bonding-Modi 5 und 6 (balance-tlb / balance-alb) werden von ibmveth nicht mehr unterstützt
  </title>
  <para>
   Es besteht ein Konflikt zwischen der tlb/alb-Bonding-Konfiguration und der Power-Firmware. Kurz gesagt, der Bonding-Treiber im tlb/alb-Modus sendet Ethernet-Loopback-Pakete mit den Ursprungs- und Ziel-MAC-Adressen, die als virtuelle Ethernet-MAC-Adressen aufgelistet sind. Diese Pakete werden von der Power-Firmware nicht unterstützt. Daher werden die Bonding-Modi 5 und 6 von ibmveth nicht mehr unterstützt.
  </para>
 </note>

 <para>
  Zum Konfigurieren eines Bonding-Geräts gehen Sie wie folgt vor:
 </para>

 <procedure>
  <step>
   <para>
    Führen Sie <menuchoice><guimenu>YaST</guimenu> <guimenu>System</guimenu>
    <guimenu>Netzwerkeinstellungen</guimenu></menuchoice> aus.
   </para>
  </step>
  <step>
   <para>
    Wählen Sie <guimenu>Hinzufügen</guimenu> und ändern Sie die Einstellung unter <guimenu>Gerätetyp</guimenu> in <guimenu>Bond</guimenu>. Fahren Sie mit <guimenu>Weiter</guimenu> fort.
   </para>
   <informalfigure>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="bond_configuration.png" width="70%"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="bond_configuration.png" width="65%"/>
     </imageobject>
    </mediaobject>
   </informalfigure>
  </step>
  <step>
   <para>
    Geben Sie an, wie dem Bonding-Gerät eine IP-Adresse zugewiesen werden soll. Hierfür stehen drei Methoden zur Auswahl:
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      No IP Address (Keine IP-Adresse)
     </para>
    </listitem>
    <listitem>
     <para>
      Dynamic Address (with DHCP or Zeroconf) (Dynamische Adresse (mit DHCP oder Zeroconf))
     </para>
    </listitem>
    <listitem>
     <para>
      Statisch zugewiesene IP-Adresse
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Wählen Sie die passende Methode für Ihre Umgebung aus.
   </para>
  </step>
  <step>
   <para>
    Wählen Sie auf der Registerkarte <guimenu>Bond Ports</guimenu> (Bond-Ports) die Ethernet-Geräte aus, die in den Bond aufgenommen werden sollen. Aktivieren Sie hierzu die entsprechenden Kontrollkästchen.
   </para>
  </step>
  <step>
   <para>
    Bearbeiten Sie die <guimenu>Bond-Treiberoptionen</guimenu> und wählen Sie einen Bonding-Modus aus.
   </para>
  </step>
  <step>
   <para>
    Der Parameter <literal>miimon=100</literal> muss unter <guimenu>Bond-Treiberoptionen</guimenu> angegeben werden. Ohne diesen Parameter wird die Datenintegrität nicht regelmäßig überprüft.
   </para>
  </step>
  <step>
   <para>
    Klicken Sie auf <guimenu>Weiter</guimenu>, und beenden Sie YaST mit <guimenu>OK</guimenu>. Das Gerät wird erstellt.
   </para>
  </step>
 </procedure>

 <sect2 xml:id="sec-network-iface-bonding-hotplug">
  <title>Hot-Plugging der Bond-Ports</title>
  <para>
   In bestimmten Netzwerkumgebungen (z. B. High Availability) muss eine Bond-Port-Schnittstelle durch eine andere Schnittstelle ersetzt werden. Dieser Fall tritt beispielsweise ein, wenn ein Netzwerkgerät wiederholt ausfällt. Die Lösung ist hier das Hot-Plugging der Bond-Ports.
  </para>
  <para>
   Der Bond wird wie gewohnt konfiguriert (gemäß <command>man 5 ifcfg-bonding</command>), beispielsweise:
  </para>
<screen>ifcfg-bond0
          STARTMODE='auto' # or 'onboot'
          BOOTPROTO='static'
          IPADDR='192.168.0.1/24'
          BONDING_MASTER='yes'
          BONDING_SLAVE_0='eth0'
          BONDING_SLAVE_1='eth1'
          BONDING_MODULE_OPTS='mode=active-backup miimon=100'</screen>
  <para>
   Die Bond-Ports werden mit <literal>STARTMODE=hotplug</literal> und <literal>BOOTPROTO=none</literal> angegeben:
  </para>
<screen>ifcfg-eth0
          STARTMODE='hotplug'
          BOOTPROTO='none'

ifcfg-eth1
          STARTMODE='hotplug'
          BOOTPROTO='none'</screen>

  <para>
   Bei <literal>BOOTPROTO=none</literal><command></command> werden die ethtool-Optionen herangezogen (sofern bereitgestellt), es wird jedoch kein Link zu <command>ifup eth0 eingerichtet</command>. Dies ist darin begründet, dass die Bond-Port-Schnittstelle durch das Bond-Gerät gesteuert wird.
  </para>
  <para>
   Bei <literal>STARTMODE=hotplug</literal> wird die Bond-Port-Schnittstelle dem Bond automatisch zugefügt, wenn diese verfügbar ist.
  </para>
  <para>
   Die <systemitem>udev</systemitem>-Regeln in <filename>/etc/udev/rules.d/70-persistent-net.rules</filename> müssen so angepasst werden, dass der Abgleich mit dem Gerät über die Bus-ID (das udev-Schlüsselwort <systemitem>KERNELS</systemitem> entspricht „SysFS BusID“, wie in <command>hwinfo --netcard</command> dargestellt) statt über die MAC-Adresse erfolgt. So ist es möglich, defekte Hardware auszutauschen (eine Netzwerkkarte in demselben Steckplatz, jedoch mit einer anderen MAC), und es treten keine Verwechselungen auf, wenn der Bond die MAC-Adresse aller Bond-Ports ändert.
  </para>
  <para>
   Beispiel:
  </para>
<screen>SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*",
KERNELS=="0000:00:19.0", ATTR{dev_id}=="0x0", ATTR{type}=="1",
KERNEL=="eth*", NAME="eth0"</screen>
  <para>
   Beim Booten wartet der systemd-Service <systemitem>network.service</systemitem> nicht darauf, dass die Hot-Plug-Bond-Ports einsatzbereit sind, sondern es wird die Bereitschaft des gesamten Bonds abgewartet, wofür mindestens ein verfügbarer Bond-Port erforderlich ist. Wenn eine Bond-Port-Schnittstelle aus dem System entfernt wird (durch Aufheben der Bindung an den NIC-Treiber, durch <command>rmmod</command> des NIC-Treibers oder durch normales PCI-Hot-Plug-Entfernen), entfernt der Kernel die betreffende Schnittstelle automatisch aus dem Bond. Wird eine neue Karte in das System eingebaut (Austausch der Hardware im Steckplatz), benennt <systemitem>udev</systemitem> diese Karte anhand der Regel für busgestützte permanente Namen in den Namen des Bond-Ports um und ruft <command>ifup</command> für die Karte auf. Mit dem <command>ifup</command>-Aufruf tritt die Karte automatisch in den Bond ein.
   <remark>
    ke: I think this can stay that way for now.
   </remark>
  </para>
 </sect2>


</sect1>
