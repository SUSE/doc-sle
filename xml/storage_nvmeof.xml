<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter
[
  <!ENTITY % entities SYSTEM "entity-decl.ent">
    %entities;
]>

<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="cha.nvmeof" xml:lang="en">
 <title>&nvmeof;</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker></dm:bugtracker>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    Abstract.
   </para>
  </abstract>
 </info>
 <sect1 xml:id="cha.nvmeof.overview">
  <title>Overview</title>
  <para>
   The <emphasis>NVM Express</emphasis> (<emphasis>&nvme;</emphasis>)
   standard is a replacement for SATA. &nvme; supports much higher
   speeds and has a lower latency than SATA.
  </para>
  <para>
   &nvmeof; is an architecture to access &nvme; storage over different
   networking fabrics, like RDMA and &nvme; over Fibre Channel. The role
   of &nvmeof; is similar to iSCSI. To increase the fault-tolerance,
   &nvmeof; has a built-in support for multipathing. The &nvmeof; multipathing
   is not based on the traditional &dmmpio;.
  </para>
  <para>
   There are Kernel modules available for the &nvme; block storage and
   &nvmeof; target and client.
  </para>
  <para>
   &nvme; is supported on &slea; &productnumber;. &nvme; native
   multipathing is enabled by default. To print the layout of the
   multipath devices, use the command <command>nvme
   list-subsys</command>. To disable NVMe native multipathing, add
   <option>nvme-core.multipath=N</option> as a boot parameter.
  </para>
 </sect1>
 <sect1 xml:id="cha.nvmeof.installation">
  <title>Setting Up a &nvmeof; Client</title>
  <para>
   To use &nvmeof;, a target must be available with one of the supported
   networking methods. Supported are &nvme; over Fibre Channel and RDMA.
   The following sections describe how to connect a client to a &nvme;
   target.
  </para>
  <sect2>
   <title>Command Line Client</title>
   <para>
    To use &nvmeof; you need the <command>nvme</command> command line
    tool. Install it with <command>zypper</command>:
   </para>
   <screen>&prompt.sudo;<command>zypper in nvme-cli</command></screen>
   <para>
    Use <command>nvme --help</command> to list all available
    subcommands. Man pages are available for <command>nvme</command>
    subcommands. Consult them by executing <command>man
    nvme-<replaceable>SUBCOMMAND</replaceable></command>. For example,
    to view the man page for the <option>discover</option> subcommand,
    execute <command>man nvme-discover</command>.
   </para>
  </sect2>
  <sect2>
   <title>Discovering &nvmeof; Targets</title>

   <para>
    Retrieve discovery controller address and service ID.
   </para>
   <screen>&prompt.sudo;<command>nvme discover -t <replaceable>TRANSPORT</replaceable> -a <replaceable>DISCOVERY_CONTROLLER_ADDRESS</replaceable> -s <replaceable>SERVICE_ID</replaceable></command></screen>
   <para>
    Replace <replaceable>TRANSPORT</replaceable> with the underlying
    transport medium: <option>loop</option>, <option>rdma</option> or
    <option>fc</option>.
    Replace <replaceable>DISCOVERY_CONTROLLER_ADDRESS</replaceable> with
    the address of the discovery controller.
    Replace <replaceable>SERVICE_ID</replaceable> with the transport
    service ID.
   </para>
   <para>
    Example:
   </para>
   <screen>&prompt.sudo;<command>nvme discover -t rdma -a 1.1.1.1 -s 4420</command></screen>
   <para>
    For more details, see <command>man nvme-discover</command>.
   </para>
  </sect2>
  <sect2>
   <title>Connecting to &nvmeof; Targets</title>
<para>
nvme connect -t &lt;transport> -a &lt;target address> -s &lt;service ID> -n &lt;Subsystem NQN>

transport:
The underlying transport medium, one of loop, rdma or fc

address:
The address of the discovery controller

service id:
The transport service ID

Subsytem NQN:
The NVMe qualified name of the desired subsystem as found by the discovery
command.

Example:
nvme connect -t rdma -a 1.1.1.1 -s 4420 -n nqn.2014-08.com.example:nvme:nvm-subsystem-sn-d78432

Or use 'nvme connect-all' to connect to all discovered namespaces.

For advanced usage please see man nvme-connect and man nvme-connect-all
</para>
  </sect2>
 </sect1>
 <sect1>
  <title>Setting Up &nvmeof; Target</title>
  <para>
   To configure a &nvmeof; target, you need the <command>nvmetcli</command> command line
   tool. Install it with <command>zypper</command>:
  </para>
  <screen>&prompt.sudo;<command>zypper in nvmetcli</command></screen>
<para>
ramones:~/:[0]# nvmetcli 
/> cd ports 
/ports> create 1
/ports> ls 1/
o- 1 ......................................................................................................................... [...]
  o- referrals ............................................................................................................... [...]
  o- subsystems .............................................................................................................. [...]
/ports> cd /subsystems 
/subsystems> create nqn.2014-08.org.nvmexpress:NVMf:uuid:c36f2c23-354d-416c-95de-f2b8ec353a82
/subsystems> cd nqn.2014-08.org.nvmexpress:NVMf:uuid:c36f2c23-354d-416c-95de-f2b8ec353a82/
/subsystems/n...-f2b8ec353a82> ls
o- nqn.2014-08.org.nvmexpress:NVMf:uuid:c36f2c23-354d-416c-95de-f2b8ec353a82 ................................................. [...]
  o- allowed_hosts ........................................................................................................... [...]
  o- namespaces .............................................................................................................. [...]
/subsystems/n...-f2b8ec353a82> cd namespaces
/subsystems/n...82/namespaces> create 1
/subsystems/n...82/namespaces> cd 1 
/subsystems/n.../namespaces/1> set device path=/dev/nullb0
Parameter path is now '/dev/nullb0'.
/subsystems/n.../namespaces/1> cd ..
/subsystems/n.../namespaces/1> enable
The Namespace has been enabled.
/subsystems/n...82/namespaces> cd ..
/subsystems/n...-f2b8ec353a82> ls
o- nqn.2014-08.org.nvmexpress:NVMf:uuid:c36f2c23-354d-416c-95de-f2b8ec353a82 ................................................. [...]
  o- allowed_hosts ........................................................................................................... [...]
  o- namespaces .............................................................................................................. [...]
    o- 1 ..................................................................................................................... [...]
/subsystems/n...-f2b8ec353a82> set attr allow_any_host=1
Parameter allow_any_host is now '1'.
/subsystems/n...-f2b8ec353a82> cd /
/> ls
o- / ......................................................................................................................... [...]
  o- hosts ................................................................................................................... [...]
  o- ports ................................................................................................................... [...]
  | o- 1 ..................................................................................................................... [...]
  |   o- referrals ........................................................................................................... [...]
  |   o- subsystems .......................................................................................................... [...]
  o- subsystems .............................................................................................................. [...]
    o- nqn.2014-08.org.nvmexpress:NVMf:uuid:c36f2c23-354d-416c-95de-f2b8ec353a82 ............................................. [...]
      o- allowed_hosts ....................................................................................................... [...]
      o- namespaces .......................................................................................................... [...]
        o- 1 ................................................................................................................. [...]
/> cd ports/1/
/ports/1> set addr adrfam=ipv4 trtype=rdma traddr=1.1.1.2 trsvcid=4420
Parameter trtype is now 'rdma'.
Parameter adrfam is now 'ipv4'.
Parameter trsvcid is now '4420'.
Parameter traddr is now '1.1.1.2'.
/ports/1> cd subsystems 
/ports/1/subsystems> create nqn.2014-08.org.nvmexpress:NVMf:uuid:c36f2c23-354d-416c-95de-f2b8ec353a82
</para>
 </sect1>
 <sect1 xml:id="cha.nvmeof.more_information">
  <title>More Information</title>
  <para>
   For more details about the abilities of <command>nvme</command>,
   refer to <command>nvme nvme-help</command>.
  </para>
  <para>
   The following blog posts are recommended for a basic introduction to
   &nvme; and &nvmeof;:
  </para>
  <itemizedlist>
   <listitem>
    <para><link xlink:href="http://nvmexpress.org/"/></para>
   </listitem>
   <listitem>
    <para><link xlink:href="http://www.nvmexpress.org/wp-content/uploads/NVMe_Over_Fabrics.pdf"/></para>
   </listitem>
   <listitem>
    <para><link xlink:href="https://storpool.com/blog/demystifying-what-is-nvmeof"/></para>
   </listitem>
   <listitem>
    <para><link xlink:href="https://medium.com/@metebalci/a-quick-tour-of-nvm-express-nvme-3da2246ce4ef"/></para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
