<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_online.xml" version="5.0" xml:id="cha.update.online">
 <title>Fazendo upgrade online</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes (sim)</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    O SUSE oferece uma ferramenta gráfica intuitiva e uma ferramenta de linha de comando simples para fazer upgrade de um sistema em execução para um novo pacote de serviço. Elas oferecem suporte para <quote>rollback</quote> de pacotes de serviço e muito mais. Este capítulo explica passo a passo como fazer upgrade do pacote de serviço com essas ferramentas.
   </para>
  </abstract>
 </info>
 <sect1 xml:id="sec.update.migr.conceptual-overview">
  <title>Visão geral conceitual</title>

  <para>
   A SUSE lança novos pacotes de serviço para a família do SUSE Linux Enterprise regularmente. Para facilitar aos clientes a migração para um novo pacote de serviço e minimizar o tempo de espera, o SUSE oferece suporte à migração online durante a execução do sistema.
  </para>

  <para>
   A partir do SLE 12, o YaST Wagon foi substituído pela migração do YaST (GUI) e pela migração do Zypper (linha de comando). Os seguintes recursos são suportados:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Sistema sempre em um estado definido até a atualização do primeiro RPM
    </para>
   </listitem>
   <listitem>
    <para>
     Cancelamento possível até a atualização do primeiro RPM
    </para>
   </listitem>
   <listitem>
    <para>
     Recuperação simples, em caso de erro
    </para>
   </listitem>
   <listitem>
    <para>
     <quote>Rollback</quote> por meio de ferramentas do sistema; sem necessidade de backup/restauração
    </para>
   </listitem>
   <listitem>
    <para>
     Uso de todos os repositórios ativos
    </para>
   </listitem>
   <listitem>
    <para>
     Capacidade de ignorar um pacote de serviço
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.workflow">
  <title>Workflow de migração de service pack</title>

  <para>
   É possível executar a migração do pacote de serviço pelo YaST, <command>zypper</command> ou AutoYaST.
  </para>

  <para>
   Antes de começar a migração do pacote de serviço, o sistema deve ser registrado no SUSE Customer Center ou em um servidor SMT local. É possível também usar o SUSE Manager.
  </para>

  <para>
   Independentemente do método, a migração de service pack consiste nas seguintes etapas:
  </para>

  <orderedlist>
   <listitem>
    <para>
     Localize os destinos de migração possíveis em seus sistemas registrados.
    </para>
   </listitem>
   <listitem>
    <para>
     Selecione um destino de migração.
    </para>
   </listitem>
   <listitem>
    <para>
     Solicite e habilite novos repositórios.
    </para>
   </listitem>
   <listitem>
    <para>
     Execute a migração.
    </para>
   </listitem>
  </orderedlist>



  <para>
   A lista de destinos de migração depende dos produtos que você instalou e registrou. Se você tem uma extensão instalada para a qual ainda não há um novo SP disponível, talvez nenhum destino de migração seja oferecido a você.
  </para>

  <para>
   A lista de destinos de migração disponíveis para o seu host sempre será recuperada do SUSE Customer Center e depende dos produtos ou extensões instalados.
  </para>
 </sect1>
 <sect1 xml:id="sec.update.migr.cancel.spm">
  <title>Cancelando a migração do pacote de serviço</title>

  <para>
   É possível cancelar a migração do pacote de serviço apenas em fases específicas do processo:
  </para>

  <orderedlist>
   <listitem>
    <para>
     Até o upgrade do pacote ser iniciado, há apenas mudanças mínimas no sistema, como para serviços e repositórios. Restaure <filename>/etc/zypp/repos.d/*</filename> para reverter ao estado anterior.
    </para>
   </listitem>
   <listitem>
    <para>
     Depois que o upgrade do pacote é iniciado, você poderá reverter ao estado anterior usando um instantâneo do Snapper (consulte o <xref linkend="cha.snapper"/>).
    </para>
   </listitem>
   <listitem>
    <para>
     Depois que o destino de migração for selecionado, o SUSE Customer Center mudará os dados do repositório. Para reverter esse estado manualmente, use <command>SUSEConnect</command> <option>--rollback</option>.
    </para>
   </listitem>
  </orderedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.yast.onlinemigr">
  <title>Fazendo upgrade com a ferramenta Migração Online (YaST)</title>

  <para>
   Para executar a migração do pacote de serviço com o YaST, use a ferramenta <guimenu>Migração Online</guimenu>. Por padrão, o YaST não instala nenhum pacote de um repositório de terceiros. Se um pacote foi instalado de um repositório de terceiros, o YaST impede que os pacotes sejam substituídos pelo mesmo pacote que vem do SUSE.
  </para>

  <note>
   <title>Reduzir o tamanho da instalação</title>
   <para>
    Ao executar a migração do SP, o YaST instalará todos os pacotes recomendados. Principalmente no caso das instalações mínimas personalizadas, isso pode aumentar o tamanho da instalação do sistema de forma significativa.
   </para>
   <para>
    Para mudar esse comportamento padrão e permitir apenas os pacotes necessários, ajuste <filename>/etc/zypp/zypp.conf</filename> e defina a seguinte variável:
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   Isso muda o comportamento de todas as operações de pacote, como a instalação de patches ou novos pacotes.
  </para>

  <para>
   Para iniciar a migração do pacote de serviço, faça o seguinte:
  </para>

  <procedure xml:id="pro.update.migr.yast">
   <step>
    <para>
     Desative todas as extensões não utilizadas em seu servidor de registro para evitar conflitos futuros de dependência. Se você se esquecer de uma extensão, o YaST detectará posteriormente os repositórios de extensões não utilizadas e as desativará.
    </para>
   </step>
   <step>
    <para>
     Se você efetuou login em uma sessão GNOME em execução na máquina que você pretende atualizar, alterne para um console de texto. Não é recomendável executar a atualização de uma sessão GNOME. Observe que isso não se aplica quando o login é efetuado de uma máquina remota (a menos que você esteja executando uma sessão VNC com GNOME).
    </para>
   </step>
   <step>
    <para>
     Se você é assinante do LTSS, verifique se o repositório de extensões LTSS está ativo.
    </para>
   </step>
   <step>
    <para>
     Execute a atualização online do YaST para obter as atualizações de pacote mais recentes para o seu sistema.
    </para>
   </step>
   <step>
    <para>
     Instale o pacote
     <package>yast2-migration</package>
     e suas dependências (no YaST em <menuchoice> <guimenu>Software</guimenu> <guimenu>Gerenciamento de Software</guimenu> </menuchoice>).
    </para>
   </step>
   <step>
    <para>
     Reinicie o YaST; do contrário, o módulo recém-instalado não será mostrado no centro de controle.
    </para>
   </step>
   <step>
    <para>
     Inicie em YaST <menuchoice> <guimenu>Sistema</guimenu> <guimenu>Migração Online</guimenu> </menuchoice>. O YaST mostra os destinos de migração possíveis e um resumo. Se houver mais de um destino de migração disponível para o seu sistema, selecione um deles na lista.
    </para>
   </step>
   <step>
    <para>
     Selecione um destino de migração na lista e clique em <guimenu>Avançar</guimenu> para continuar.
    </para>
   </step>
   <step>
    <para>
     Se a ferramenta de migração oferecer repositórios de atualização, recomenda-se clicar em <guimenu>Sim</guimenu> para continuar.
    </para>
   </step>
   <step>
    <para>
     <remark>toms 2015-09-09: FATE#319140</remark> Se a ferramenta Migração Online encontrar repositórios obsoletos de DVD ou de um servidor local, será altamente recomendado desabilitá-los. Os repositórios obsoletos são de um SP anterior. Qualquer repositório antigo do SCC ou da SMT é removido automaticamente.
    </para>
   </step>
   <step>
    <para>
     Confira o resumo e clique em <guimenu>Avançar</guimenu> para continuar a migração. Clique em <guimenu>Iniciar Atualização</guimenu> para confirmar.
    </para>
    <remark>toms 2016-07-13: What to do in case of problems?</remark>
   </step>
   <step>
    <para>
     Reinicie o sistema após a migração bem-sucedida.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.zypper.onlinemigr">
  <title>Fazendo upgrade com o Zypper</title>

  <para>
   Para executar a migração do pacote de serviço com o Zypper, use a ferramenta de linha de comando <command>zypper</command> <option>migration</option>.
  </para>

  <note>
   <title>Reduzir o tamanho da instalação</title>
   <para>
    Ao executar a migração do SP, o YaST instalará todos os pacotes recomendados. Principalmente no caso das instalações mínimas personalizadas, isso pode aumentar o tamanho da instalação do sistema de forma significativa.
   </para>
   <para>
    Para mudar esse comportamento padrão e permitir apenas os pacotes necessários, ajuste <filename>/etc/zypp/zypp.conf</filename> e defina a seguinte variável:
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   Isso muda o comportamento de todas as operações de pacote, como a instalação de patches ou novos pacotes. Para mudar o comportamento do Zypper para uma única chamada, adicione o parâmetro <option>--no-recommends</option> à linha de comando.
  </para>

  <para>
   Para iniciar a migração do pacote de serviço, faça o seguinte:
  </para>

  <procedure xml:id="pro.update.migr.zypper">
   <step>
    <para>
     Se você efetuou login em uma sessão GNOME em execução na máquina que você pretende atualizar, alterne para um console de texto. Não é recomendável executar a atualização de uma sessão GNOME. Observe que isso não se aplica quando o login é efetuado de uma máquina remota (a menos que você esteja executando uma sessão VNC com GNOME).
    </para>
   </step>
   <step>
    <para>
     Registre a máquina do SUSE Linux Enterprise, caso ainda não tenha feito isso:
    </para>
<screen>sudo <command>SUSEConnect</command> --regcode <replaceable>YOUR_REGISTRATION_CODE</replaceable></screen>
   </step>
   <step>
    <para>
     Se você é assinante do LTSS, verifique se o repositório de extensões LTSS está ativo.
    </para>
   </step>
   <step>
    <para>
     Instale as atualizações mais recentes:
    </para>
<screen>sudo <command>zypper</command> patch</screen>
   </step>
   <step>
    <para>
     Instale o pacote <package>zypper-migration-plugin</package> e suas dependências:
    </para>
<screen>sudo <command>zypper</command> in zypper-migration-plugin</screen>
   </step>
   <step>
    <para>
     Execute <command>zypper</command> <option>migration</option>:
    </para>
<screen><prompt>tux &gt; </prompt>sudo <command>zypper</command> migration
Executing 'zypper  patch-check'

Refreshing service 'SUSE_Linux_Enterprise_Server_12_x86_64'.
Loading repository data...
Reading installed packages...
0 patches needed (0 security patches)

Available migrations:

    1 | SUSE Linux Enterprise Server 12 SP1 x86_64
    2 | SUSE Linux Enterprise Server 12 SP2 x86_64</screen>
    <para>
     Algumas observações sobre o processo de migração:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Se houver mais de um destino de migração disponível para o seu sistema, o Zypper permitirá selecionar um SP na lista. Isso equivale a ignorar um ou mais SPs. Lembre-se de que a migração online para produtos base (SLES, SLED) permanece disponível apenas entre os SPs de uma versão principal.
      </para>
     </listitem>
     <listitem>
      <para>
       Por padrão, o Zypper usa a opção <option>--no-allow-vendor-change</option>, que é passada para o <command>zypper</command> <option>dup</option>. Se um pacote foi instalado de um repositório de terceiros, essa opção impede que os pacotes sejam substituídos pelo mesmo pacote que vem do SUSE.
      </para>
     </listitem>
     <listitem>
      <para>
       <remark>toms 2015-09-09: FATE#319140</remark> Se o Zypper encontrar repositórios obsoletos de DVD ou de um servidor local, será altamente recomendado desabilitá-los. Os repositórios SCC ou SMT antigos são automaticamente removidos.
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     Revise todas as mudanças, principalmente os pacotes que serão removidos. Digite <literal>y</literal> para continuar (o número exato de pacotes para upgrade pode variar de acordo com o sistema):
    </para>
<screen>266 packages to upgrade, 54 to downgrade, 17 new, 8 to reinstall, 5 to remove, 1 to change arch.
Overall download size: 285.1 MiB. Already cached: 0 B  After the operation, additional 139.8 MiB will be used.
Continue? [y/n/? shows all options] (y):</screen>
    <para>
     Use as teclas <keycombo> <keycap function="shift"/> <keycap function="pageup"/> </keycombo> ou <keycombo> <keycap function="shift"/> <keycap function="pagedown"/> </keycombo> para mover a barra de rolagem no shell.
    </para>
   </step>
   <step>
    <para>
     Reinicie o sistema após a migração bem-sucedida.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.plainzypper.onlinemigr">
  <title>Fazendo upgrade com o Zypper simples</title>

  <para>
   Se você não pode usar a migração do YaST ou do Zypper, ainda pode migrar com o Zypper simples e algumas interações manuais. Para iniciar a migração do pacote de serviço, faça o seguinte:
  </para>

  <procedure>
   <step>
    <para>
     Se você efetuou login em uma sessão GNOME em execução na máquina que você pretende atualizar, alterne para um console de texto. Não é recomendável executar a atualização de uma sessão GNOME. Observe que isso não se aplica quando o login é efetuado de uma máquina remota (a menos que você esteja executando uma sessão VNC com GNOME).
    </para>
   </step>
   <step>
    <para>
     Atualize as ferramentas de gerenciamento de pacote com os repositórios antigos do SUSE Linux Enterprise:
    </para>
<screen>sudo <command>zypper</command> patch --updatestack-only</screen>
   </step>
   <step>
    <para>
     Se o sistema foi registrado, o registro precisa ser cancelado:
    </para>
<screen>sudo <command>SUSEConnect</command> --de-register</screen>
   </step>
   <step>
    <para>
     Remova as fontes de instalação e repositórios antigos e ajuste os repositórios de terceiros.
    </para>
   </step>
   <step>
    <para>
     Adicione as novas fontes de instalação, sejam elas locais ou remotas (para o marcador <replaceable>REPOSITÓRIO</replaceable>, consulte a <xref linkend="sec.update.nmm.repositories"/>):
    </para>
<screen>sudo <command>zypper</command> addrepo <replaceable>REPOSITORY</replaceable></screen>
    <para>
     Você também pode usar o SUSE Customer Center ou a SMT (Subscription Management Tool). O comando para o SUSE Linux Enterprise 12 SP1 em x86-64 é:
    </para>
<screen>sudo <command>SUSEConnect</command> -p SLES/12.2/x86_64 <replaceable>OPTIONS</replaceable></screen>
    <para>
     Lembre-se de que os upgrades compatíveis com várias arquiteturas não são suportados.
    </para>
    <para>
     O Zypper exibirá um conflito entre o kernel antigo e o novo. Escolha a Solução 1 para continuar.
    </para>
<screen>Problem: product:SLES-12.2-0.x86_64 conflicts with kernel &lt; 4.4 provided by kernel-default-<replaceable>version</replaceable>
 Solution 1: Following actions will be done:
  replacement of kernel-default-<replaceable>version</replaceable> with kernel-default-<replaceable>version</replaceable>
  deinstallation of kernel-default-<replaceable>version</replaceable>
 Solution 2: do not install product:SLES-12.2-0.x86_64
</screen>
   </step>
   <step>
    <para>
     Finalize a migração:
    </para>
<screen>sudo <command>zypper</command> ref -f -s
sudo <command>zypper</command> dup --no-allow-vendor-change --no-recommends</screen>
    <para>
     O primeiro comando atualiza todos os serviços e repositórios. O segundo comando executa o upgrade da distribuição. Neste ponto, as duas últimas opções são importantes: <option>-no-allow-vendor-change</option> garante que os RPMs de terceiros não sobregravarão os RPMs do sistema básico. A opção <option>--no-recommends</option> garante que os pacotes desmarcados durante a instalação inicial não serão adicionados novamente.
    </para>
   </step>
  </procedure>
 </sect1>



 <sect1 xml:id="sec.update.migr.rollback">
  <title>Voltando um pacote de serviço</title>

  <para>
   Se um pacote de serviço não funcionar para você, o SUSE Linux Enterprise permitirá reverter o sistema ao estado anterior à inicialização da migração do pacote de serviço. O pré-requisito é uma partição raiz Btrfs com instantâneos ativados (este é o padrão ao instalar o SLES 12). Consulte a <xref linkend="cha.snapper"/> para obter os detalhes. 
  </para>

  <procedure xml:id="pro.update.migr.rollback">
   <step>
    <para>
     Confira uma lista de todos os instantâneos do Snapper:
    </para>
    <screen>sudo snapper list</screen>
    <para>
     Revise a saída para localizar o instantâneo que foi criado logo antes da inicialização da migração do pacote de serviço. A coluna <guimenu>Descrição</guimenu> contém uma declaração correspondente, e o instantâneo está marcado como <literal>important</literal> (importante) na coluna <guimenu>Userdata</guimenu>. Memorize o número do instantâneo da coluna <guimenu>Nº</guimenu> e a data da coluna <guimenu>Data</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Reinicialize o sistema. No menu de boot, selecione <guimenu>Iniciar carregador de boot de um instantâneo apenas leitura</guimenu> e escolha o instantâneo com a data e o número que você memorizou na etapa anterior. Um segundo menu de boot (aquele do instantâneo) é carregado. Selecione a entrada que começa com <literal>SLES 12</literal> e inicialize-a.
    </para>
   </step>
   <step>
    <para>
     O sistema é inicializado no estado anterior com a partição do sistema montada como apenas leitura. Efetue login como <systemitem class="username">root</systemitem> e verifique se você escolheu o instantâneo correto. Verifique também se tudo funciona conforme o esperado. Como o sistema de arquivos raiz foi montado como apenas leitura, poderá haver restrições na funcionalidade.
    </para>
    <para>
     Em caso de problemas ou se você inicializou o instantâneo errado, reinicialize e escolha outro instantâneo do qual inicializar. Até este ponto, não foram feitas mudanças permanentes. Se o instantâneo está correto e funciona conforme o esperado, faça a mudança permanente executando o seguinte comando:
    </para>
    <screen>snapper rollback</screen>
    <para>
     Reinicialize posteriormente. Na tela de boot, escolha a entrada de boot padrão para reinicializar no sistema restaurado.
    </para>
   </step>
   <step>
    <para>
     Verifique se a configuração do repositório foi redefinida apropriadamente. Verifique também se todos os produtos foram registrados apropriadamente. Se não for nenhum desses casos, a atualização do sistema em um momento posterior talvez não funcione mais, ou o sistema pode ser atualizado usando os repositórios de pacotes errados.
    </para>
    <para>
     Verifique se o sistema pode acessar a Internet antes de iniciar este procedimento.
    </para>
    <substeps>
     <step>
      <para>
       Atualize serviços e repositórios executando
      </para>
      <screen>sudo zypper ref -fs</screen>
     </step>
     <step>
      <para>
       Obtenha uma lista de repositórios ativos executando
      </para>
      <screen>sudo zypper lr</screen>
      <para>
       Verifique cuidadosamente a saída deste comando. Não deve aparecer na lista serviços e repositórios que foram adicionados para a atualização. Por exemplo, se você está voltando de uma migração de pacote de serviço do SLES 12 SP1 para o SLES 12 SP2, a lista <emphasis>não</emphasis> deve incluir os repositórios <literal>SLES12-SP2-Pool</literal> e <literal>SLES12-SP2-Updates</literal>; mas, em vez disso, as versões <literal>SP1</literal>.
      </para>
      <para>
       Se os repositórios errados forem listados, exclua-os e, se necessário, substitua-os pelas versões correspondentes à versão do produto ou do pacote de serviço. Para obter uma lista de repositórios para os caminhos de migração suportados, consulte a <xref linkend="sec.update.nmm.repositories"/>.
      </para>
     </step>
     <step>
      <para>
       Por fim, verifique o status do registro para todos os produtos instalados executando
      </para>
      <screen>SUSEConnect --status</screen>
      <para>
       Todos os produtos devem ser relatados como <literal>Registered</literal> (Registrados). Se não for esse o caso, conserte o registro executando
      </para>
      <screen>SUSEConnect --rollback</screen>
     </step>
    </substeps>
   </step>
  </procedure>
  <para>
   Agora, você reverteu com êxito o sistema ao estado que foi capturado logo antes da inicialização da migração do pacote de serviço.
  </para>
 </sect1>
</chapter>
