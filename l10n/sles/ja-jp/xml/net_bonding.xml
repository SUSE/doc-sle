<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_bonding.xml" version="5.0" xml:id="sec-network-iface-bonding">
 <title>ボンディングデバイスの設定</title>

 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>

 <para>
  システムによって、通常のEthernetデバイスの規格のデータセキュリティ/可用性の要件を超えるネットワーク接続の実装が望ましいことがあります。その場合、数台のEthernetデバイスを集めて1つのボンディングデバイスを設定できます。
 </para>

 <para>
  ボンディングデバイスの設定には、ボンディングモジュールオプションを使用します。ボンディングデバイスの振る舞いは、主にボンディングデバイスのモードによって影響されます。デフォルトの動作は、<systemitem>active-backup</systemitem>であり、アクティブなポートに障害が発生すると、別のBondポートがアクティブになります。以下のボンディングモードが使用可能です。
 </para>

 <variablelist>
  <varlistentry>
   <term><guimenu>0</guimenu> (balance-rr)</term>
   <listitem>
    <para>
     パケットは、ラウンドロビン方式で、最初の使用可能なインタフェースから最後の使用可能なインタフェースに送信されます。耐障害性と負荷分散を提供します。
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>1</guimenu> (active-backup)</term>
   <listitem>
    <para>
     1つのネットワークインタフェースのみがアクティブです。失敗すると、別のインタフェースがアクティブになります。この設定は、<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>のデフォルトです。耐障害性を提供します。
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>2</guimenu> (balance-xor)</term>
   <listitem>
    <para>
     トラフィックは、ボンディングに含まれるデバイスの数に基づいて、使用可能なすべてのインタフェース間で分割されます。スイッチのサポートが必要です。耐障害性と負荷分散を提供します。
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>3</guimenu> (broadcast)</term>
   <listitem>
    <para>
     すべてのトラフィックはすべてのインタフェースに対してブロードキャストされます。スイッチのサポートが必要です。耐障害性を提供します。
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>4</guimenu> (802.3ad)</term>
   <listitem>
    <para>
     同じ速度と両面設定を共有するグループにインタフェースを集約します。インタフェースドライバでの<command>ethtool</command>のサポート、およびIEEE 802.3adダイナミックリンク集約をサポートし、それ用に設定されているスイッチが必要です。耐障害性と負荷分散を提供します。
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>5</guimenu> (balance-tlb)</term>
   <listitem>
    <para>
     アダプティブ送信負荷分散。インタフェースドライバでの<command>ethtool</command>のサポートが必要ですが、スイッチのサポートは必要ありません。耐障害性と負荷分散を提供します。
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>6</guimenu> (balance-alb)</term>
   <listitem>
    <para>
     アダプティブ負荷分散。インタフェースドライバでの<command>ethtool</command>のサポートが必要ですが、スイッチのサポートは必要ありません。耐障害性と負荷分散を提供します。
    </para>
   </listitem>
  </varlistentry>
 </variablelist>

 <para>
  モードの詳細については、<link xlink:href="https://www.kernel.org/doc/Documentation/networking/bonding.txt"></link>を参照してください。
 </para>

 <tip>
  <title>ボンディングとXen</title>
  <para>
   ボンディングデバイスの使用が有用なのは、利用可能なネットワークカードが複数あるマシンの場合のみです。大半の設定では、Dom0でのみボンディング設定を使用する必要があることになります。VMゲストシステムに複数のネットワークカードが割り当てられている場合のみ、VMゲストでのボンド設定が役立つことがあります。
  </para>
 </tip>

 <note arch="power">
  <title>
   IBM POWER:ボンディングモード5および6 (balance-tlb / balance-alb)がibmvethでサポートされない
  </title>
  <para>
   tlb/albボンディング設定と電源ファームウェアで競合が発生しています。つまり、tlb/albモードのボンディングドライバが仮想Etnernet MACアドレスとして一覧表示されているソースおよび宛先MACアドレスの両方を使用してEthernet Loopbackパケットを送信します。これらのパケットは電源ファームウェアによってサポートされていません。したがって、ボンディングモード5および6はibmvethによってサポートされません。
  </para>
 </note>

 <para>
  ボンディングデバイスを設定するには、次の手順に従います。
 </para>

 <procedure>
  <step>
   <para>
    <menuchoice><guimenu>YaST</guimenu> <guimenu>システム</guimenu> <guimenu>ネットワーク設定</guimenu></menuchoice>を実行します。
   </para>
  </step>
  <step>
   <para>
    <guimenu>追加</guimenu>を使用し、<guimenu>デバイスの型</guimenu>を<guimenu>ボンド</guimenu>に変更します。<guimenu>次へ</guimenu>で続行します。
   </para>
   <informalfigure>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="bond_configuration.png" width="70%"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="bond_configuration.png" width="65%"/>
     </imageobject>
    </mediaobject>
   </informalfigure>
  </step>
  <step>
   <para>
    IPアドレスをボンディングデバイスに割り当てる方法を選択します。3つの方法から選択できます。
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      IPアドレスなし
     </para>
    </listitem>
    <listitem>
     <para>
      可変IPアドレス(DHCPまたはZeroconf)
     </para>
    </listitem>
    <listitem>
     <para>
      固定IPアドレス
     </para>
    </listitem>
   </itemizedlist>
   <para>
    ご使用の環境に適合する方法を使用します。
   </para>
  </step>
  <step>
   <para>
    <guimenu>Bondポート</guimenu>タブで該当するチェックボックスをオンにして、ボンドに含めるEthernetデバイスを選択します。
   </para>
  </step>
  <step>
   <para>
    <guimenu>ボンドドライバオプション</guimenu>を編集し、ボンディングモードを選択します。
   </para>
  </step>
  <step>
   <para>
    パラメータ<literal>miimon=100</literal>が<guimenu>ボンドドライバオプション</guimenu>に追加されていることを確認します。このパラメータがないと、データの整合性が定期的にチェックされません。
   </para>
  </step>
  <step>
   <para>
    <guimenu>次へ</guimenu>をクリックし、<guimenu>OK</guimenu>でYaSTを終了して、デバイスを作成します。
   </para>
  </step>
 </procedure>

 <sect2 xml:id="sec-network-iface-bonding-hotplug">
  <title>Bondポートのホットプラグ</title>
  <para>
   特定のネットワーク環境(高可用性など)では、Bondポートインタフェースを別のものに置換しなければならないことがあります。ネットワークデバイスで頻繁に障害が発生するなどの理由があります。解決方法として、Bondポートのホットプラグを設定します。
  </para>
  <para>
   ボンドは以下のように(<command>man 5
   ifcfg-bonding</command>に従って)通常通りに設定されます。たとえば、
  </para>
<screen>ifcfg-bond0
          STARTMODE='auto' # or 'onboot'
          BOOTPROTO='static'
          IPADDR='192.168.0.1/24'
          BONDING_MASTER='yes'
          BONDING_SLAVE_0='eth0'
          BONDING_SLAVE_1='eth1'
          BONDING_MODULE_OPTS='mode=active-backup miimon=100'</screen>
  <para>
   ボンドポートは、<literal>STARTMODE=hotplug</literal>と<literal>BOOTPROTO=none</literal>で指定されます。
  </para>
<screen>ifcfg-eth0
          STARTMODE='hotplug'
          BOOTPROTO='none'

ifcfg-eth1
          STARTMODE='hotplug'
          BOOTPROTO='none'</screen>

  <para>
   <literal>BOOTPROTO=none</literal>は<command>ethtool</command>オプション(指定した場合)を使用しますが、<command>ifup
   eth0</command>にはリンクアップを設定しません。これは、Bondポートインタフェースがボンドデバイスによって制御されるためです。
  </para>
  <para>
   <literal>STARTMODE=hotplug</literal>により、Bondポートインタフェースが利用可能になると、ボンドに自動的に追加されます。
  </para>
  <para>
   <filename>/etc/udev/rules.d/70-persistent-net.rules</filename>の<systemitem>udev</systemitem>ルールは、MACアドレスではなく、バスID(<command>hwinfo
   --netcard</command>で表示される"SysFS BusID"に等しいudev <systemitem>KERNELS</systemitem>キーワード)によってデバイスを一致させるために変更する必要があります。これにより、異常なハードウェア(同じスロットにあるがMACが異なるネットワークカード)の交換が可能になり、ボンドがすべてのBondポートのMACアドレスを変更するときに混乱を避けることができます。
  </para>
  <para>
   次に例を示します。
  </para>
<screen>SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*",
KERNELS=="0000:00:19.0", ATTR{dev_id}=="0x0", ATTR{type}=="1",
KERNEL=="eth*", NAME="eth0"</screen>
  <para>
   ブート時にsystemd <systemitem>network.service</systemitem>はホットプラグBondポートを待機しませんが、ボンドの準備が整うのを待機します。これには少なくとも1つのBondポートが利用可能であることが必要です。Bondポートインタフェースの1つがシステムから削除されると(NICドライバからアンバインド、NICドライバの<command>rmmod</command>、または実際のPCIホットプラグ取り外し)、カーネルによってボンドから自動的に削除されます。システムに新しいカードが追加されると(スロットのハードウェアが置換されると)、<systemitem>udev</systemitem>は、バスベースの永続名規則を使って名前をBondポート名に変更し、<command>ifup</command>を呼び出します。<command>ifup</command>呼び出しによって、ボンドに自動的に追加されます。<remark>
    ke: I think this can stay that way for now.
   </remark>
  </para>
 </sect2>
<sect2 xml:id="sec-predictable-naming-scheme">
  <title>予測可能な命名スキーム</title>
  <para>
    永続ネットワーク名ジェネレータとボンディングには制限があります。インタフェースがボンドに対してスレーブ化されると、MACアドレスは一時的に上書きされ、ボンドインタフェースのMACアドレスと一致するように設定されます。これにより、スレーブ化インタフェースのルールがMACアドレスに基づいている場合、<literal>70-persistent-net.rules</literal>ファイルに不整合が生じます。
   </para>
   <para>
  更新されたMACアドレスを持つスレーブ化NICで<systemitem>uevent</systemitem>が発生した場合、<systemitem>udev</systemitem>は最初のスレーブ化インタフェースの名前を使用して名前の変更を試みることがあり、その結果、<literal>rename4</literal>のような一時的な名前が付けられます。MACベースのルールを回避するように永続ネットワーク名ジェネレータを変更することは、回帰のリスクが高く、場合によってはMACフィルタリングが必要になるため、現実的ではありません。永続ネットワーク名ジェネレータは廃止され、予測可能な命名スキームに置き換えられました。これにより、設定が容易になり、MACアドレスへの依存が回避されます。新規システムのインストール時に<literal>Boot Options</literal>プロンプトに<literal>net.ifnames=1'</literal>を追加して、予測可能な命名スキームを有効にすることをお勧めします。
  </para>
  <procedure>
    <title>インストール済みのシステム上で命名スキームを有効化</title>
    <step>
      <para>
        <package>biosdevname</package>パッケージがインストールされている場合は、それをアンインストールします。
      </para>
  <screen><prompt>&gt; </prompt><command>sudo</command> zypper rm biosdevname</screen>
    </step>
    <step>
      <para>
        既存の命名ルールが存在する場合は、<filename>/etc/udev/rules.d</filename>のバックアップを作成します。次に例を示します。
      </para>
  <screen><prompt>&gt; </prompt><command>sudo</command> cp /etc/udev/rules.d/70-persistent-net.rules /backup</screen>
  <note><para>予測可能なネットワークインタフェース名を有効にするには、ファイル<filename>/etc/udev/rules.d/70-persistent-net.rules</filename>が存在する場合は削除してください。</para></note>
    </step>
      <step>
      <para>
        initrdを再生成します。
      </para>
  <screen><prompt>&gt; </prompt><command>sudo</command> dracut -f</screen>
    </step>
    <step>
      <para>
        YaSTブートローダモジュールを起動し、カーネルコマンドラインに<literal>net.ifnames=1</literal>を追加します。<guimenu>OK</guimenu>をクリックして確認し、システムを再起動します。
      </para>
       </step>
    <step>
      <para>
        ネットワークマネージャとしてWickedが使用されている場合は、それに合わせてネットワークインタフェースの設定を調整します。<command>yast
        lan</command>モジュールを使用するか、<filename>/etc/sysconfig/network/ifcfg-*</filename>ファイルの名前を適宜変更します。つづいて、Wickedを再起動します。
      </para>
  <screen><prompt>&gt; </prompt><command>sudo</command> systemctl restart wicked.service</screen>
    </step>
  </procedure>
</sect2>

</sect1>
