<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_samba.xml" version="5.0" xml:id="cha-samba">
 <title>Samba</title>
 <info>
  <abstract>
   <para>
    使用 Samba 可以将 Unix 计算机配置为 macOS、Windows 和 OS/2 计算机的文件和打印服务器。Samba 已经发展成为一个功能完备且相当复杂的产品。使用 YaST 或手动编辑配置文件来配置 Samba。
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <sect1 xml:id="sec-samba-term">
  <title>术语</title>

  <para>
   以下是 Samba 文档和 YaST 模块中使用的一些术语。
  </para>

  <variablelist>
   <varlistentry>
    <term>SMB 协议</term>
    <listitem>
     <para>
        Samba 使用基于 <phrase role="productname">NetBIOS</phrase> 服务的 SMB（服务器消息块）协议。Microsoft 发布该协议以便其他软件制造商能够与 Microsoft 域网络建立连接。使用 Samba 时，SMB 协议在 TCP/IP 协议之上工作，所以必须在所有客户端上安装 TCP/IP 协议。
     </para>
     <tip arch="zseries" os="sles">
      <title>IBM Z：NetBIOS 支持</title>
      <para>
       IBM Z 仅支持基于 TCP/IP 的 SMB。这些系统上不提供 NetBIOS 支持。
      </para>
     </tip>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>CIFS 协议</term>
    <listitem>
     <para>
       （常用因特网文件系统）协议是 Samba 支持的另一种协议。CIFS 定义网络中使用的标准远程文件系统访问协议，使用户组能够一起工作并在网络中共享文档。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NetBIOS</term>
    <listitem>
     <para>
       NetBIOS 是为用于提供名称服务的计算机之间进行通讯而设计的软件接口 (API)。它使连接到网络的计算机能够为自己保留名称。之后便可以根据名称对这些计算机进行寻址。没有任何中心进程来检查这些名称。网络上的任何计算机均可以保留所需数量的名称，前提是这些名称均未使用。可以为不同的网络体系结构实施 NetBIOS 接口。<phrase role="productname">NetBEUI</phrase> 是与网络硬件结合相对密切的一种实施，但它常被称为 <phrase role="productname">NetBIOS</phrase>。使用 NetBIOS 实施的网络协议包括 Novell 的 IPX（通过 TCP/IP 的 NetBIOS）和 TCP/IP。
     </para>
     <para>
      通过 TCP/IP 发送的 NetBIOS 名称与 <filename>/etc/hosts</filename> 中使用的名称或 DNS 定义的名称没有相同之处。NetBIOS 使用它自己的、完全独立的命名约定。但为了方便管理，建议您使用与 DNS 主机名对应的名称，或本机使用 DNS。Samba 默认采用这种方式。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Samba 服务器</term>
    <listitem>
     <para>
      Samba 服务器向客户端提供 SMB/CIFS 服务和 NetBIOS over IP 命名服务。对于 Linux，Samba 服务器有三个守护程序：smbd 用于 SMB/CIFS 服务，nmbd 用于命名服务，winbind 用于身份验证。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Samba 客户端</term>
    <listitem> 
     <para>
      Samba 客户端是一种能够通过 SMB 协议从 Samba 服务器使用 Samba 服务的系统。常见操作系统（例如 Windows 和 macOS）都支持 SMB 协议。必须在所有计算机上安装 TCP/IP 协议。Samba 提供适用于多种不同类型 UNIX 的客户端。对于 Linux，有一个用于 SMB 的内核模块，它允许在 Linux 系统级别上集成 SMB 资源。不需要对 Samba 客户端运行任何守护程序。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>共享</term>
    <listitem>
     <para>
      SMB 服务器通过共享为其客户端提供资源。共享就是服务器上的打印机和目录及其子目录。可以通过名称来导出并访问共享。可以将共享名称设置为任何名称 — 不一定是导出目录的名称。也可以为打印机指派一个名称。客户端可以根据打印机的名称来访问打印机。  
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>DC</term>
    <listitem>
     <para>
       域控制器 (DC) 是处理域中帐户的服务器。为了复制数据，一个域中可有更多域控制器可用。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec-samba-install">
  <title>安装 Samba 服务器</title>

  <para>
   要安装 Samba 服务器，请启动 YaST 并选择<menuchoice><guimenu>软件</guimenu> <guimenu> 软件管理</guimenu></menuchoice>。选择<menuchoice><guimenu>视图</guimenu> <guimenu> 模式</guimenu></menuchoice>，然后选择<guimenu>文件服务器</guimenu>。确认已安装完成安装进程所需的包。
  </para>
 </sect1>
 <sect1 xml:id="sec-samba-serv-start" os="sles;osuse">
  <title>启动和停止 Samba</title>

  <para>
   （引导时）可以自动启动或停止 Samba 服务器，或者手动执行这两个操作。启动和停止策略是<xref linkend="sec-samba-yast2-conf"/>中所述的 YaST Samba 服务器配置的一部分。
  </para>

  <para>
   在命令行中使用 <command>systemctl stop smb nmb</command> 可停止 Samba 所需的服务，使用 <command>systemctl start nmb smb</command> 可启动它们。<literal>smb</literal> 服务会根据需要处理 <literal>winbind</literal>。
  </para>

  <tip>
   <title><systemitem>winbind</systemitem></title>
   <para>
    <systemitem>winbind</systemitem> 是一项独立服务，同样也是以单独的 <systemitem>samba-winbind</systemitem> 包提供。
   </para>
  </tip>
 </sect1>
 <sect1 xml:id="sec-samba-serv-inst">
  <title>配置 Samba 服务器</title>

  <para os="sles;osuse">
   <phrase role="productname"><phrase os="sles">SUSE® Linux Enterprise Server</phrase></phrase> 中的 Samba 服务器可通过两种不同方式进行配置：用 YaST 或手动方式。手工配置可提供更详细的信息，但没有 YaST GUI 方便。
  </para>

  

  <sect2 xml:id="sec-samba-yast2-conf" os="sles;osuse">
   <title>使用 YaST 配置 Samba 服务器</title>
   <para>
    要配置 Samba 服务器，请启动 YaST 并选择<menuchoice><guimenu>网络服务</guimenu><guimenu> Samba 服务器</guimenu></menuchoice>。
   </para>
   <sect3 xml:id="sec-samba-yast2-conf-inst">
    <title>初始 Samba 配置</title>
    <para>
     第一次启动此模块时，系统会启动 <guimenu>Samba 安装</guimenu>对话框，提示您做一些涉及服务器管理的基本设置。配置结束时，系统会提示您输入 Samba 管理员口令（<guimenu>Samba root 口令</guimenu>）。以后启动时，会显示 <guimenu>Samba 配置</guimenu>对话框。
    </para>
    <para>
     <guimenu>Samba 安装</guimenu>对话框包括两个步骤和详细设置（可选）：
    </para>
    <variablelist>
     <varlistentry>
      <term>工作组名或域名</term>
      <listitem>
       <para>
        在<guimenu>工作组名或域名</guimenu>中选择一个现有名称或输入一个新的名称，然后单击<guimenu>下一步</guimenu>。
       </para>

      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Samba 服务器类型</term>
      <listitem>
       <para>
        在下一步中，指定服务器是应该充当主域控制器 (PDC)、备用域服务器 (BDC) 还是不充当域控制器。按<guimenu>下一步</guimenu>继续。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     如果不想再继续详细的服务器配置，请单击<guimenu>确定</guimenu>确认。然后在最后的弹出框中，设置 <guimenu>Samba root 口令</guimenu>。
    </para>
    <para>
     稍后可以在 <guimenu>Samba 配置</guimenu>对话框的<guimenu>启动</guimenu>、<guimenu>共享</guimenu>、<guimenu>身份</guimenu>、<guimenu>可信域</guimenu>和 <guimenu>LDAP 设置</guimenu>选项卡中更改所有设置。
    </para>
   </sect3>
   <sect3 xml:id="sec-samba-yast2-conf-adv">
    <title>高级 Samba 配置</title>
    <para>
     在 Samba 服务器模块第一次启动时，<guimenu>Samba 配置</guimenu>对话框会在两个初始步骤后立即显示，如<xref linkend="sec-samba-yast2-conf-inst"/>所述。使用它调整您的 Samba 服务器配置。
    </para>
    <para>
     编辑配置之后，单击<guimenu>确定</guimenu>保存设置。
    </para>
    <sect4 xml:id="sec-samba-yast2-conf-adv-start">
     <title>启动服务器</title>
     <para>
      在<guimenu>启动</guimenu>选项卡中，配置 Samba 服务器的启动。若想在每次系统引导时启动服务，请选择<guimenu>引导时</guimenu>。要激活手动启动，请选择<guimenu>手动</guimenu>。有关启动 Samba 服务器的更多信息，请参见<xref linkend="sec-samba-serv-start"/>。
     </para>
     <para>
      在此选项卡中，还可以打开防火墙中的端口。为此应选择<guimenu>打开防火墙中的端口</guimenu>。如果有多个网络接口，则请通过单击<guimenu>防火墙细节</guimenu>、选择接口并单击<guimenu>确定</guimenu>来为 Samba 服务选择网络接口。
     </para>

    </sect4>
    <sect4 xml:id="sec-samba-yast2-conf-adv-shares">
     <title>共享</title>
     <para>
      在<guimenu>共享</guimenu>选项卡中，确定要激活的 Samba 共享。存在一些预定义的共享，例如主页和打印机。使用<guimenu>切换状态</guimenu>可在<guimenu>活动</guimenu>和<guimenu>不活动</guimenu>之间进行切换。单击<guimenu>添加</guimenu>可添加新共享，单击<guimenu>删除</guimenu>可删除选中共享。
     </para>

     <para>
      <guimenu>允许用户共享目录</guimenu>使<guimenu>允许的组</guimenu>中的组成员可以与其他用户共享他们拥有的目录。例如，<systemitem>users</systemitem> 用于本地范围，<systemitem>DOMAIN\Users</systemitem> 用于域范围。该用户必须还确保文件系统权限允许访问。<guimenu>最大共享数</guimenu>可限制可以创建的共享的总数。要允许访问用户共享而无需身份验证，请启用<guimenu>允许来宾访问</guimenu>。

     </para>
    </sect4>
    <sect4 xml:id="sec-samba-yast2-conf-adv-identity">
     <title>身份</title>
     <para>
      在<guimenu>身份</guimenu>选项卡中，确定与主机关联的域（<guimenu>基本设置</guimenu>）以及是否在网络中使用备用主机名（<guimenu>NetBIOS 主机名</guimenu>）。可以使用 Microsoft Windows Internet Name Service (WINS) 进行名称解析。在这种情况下，激活<guimenu>使用 WINS 进行主机名解析</guimenu>，并确定是否<guimenu>通过 DHCP 检索 WINS 服务器</guimenu>。要设置专家全局设置或设置用户身份验证源，<phrase os="sles;osuse">例如 LDAP 而不是 TDB 数据库，</phrase>请单击<guimenu>高级设置</guimenu>。

     </para>

    </sect4>
    <sect4 xml:id="sec-samba-yast2-conf-adv-trusted">
     <title>可信域(T)</title>
     <para>
      要使其他域的用户能够访问您的域，在<guimenu>可信域</guimenu>选项卡中进行适当的设置。要添加新域，请单击<guimenu>添加</guimenu>。要除去所选的域，请单击<guimenu>删除</guimenu>。
     </para>
    </sect4>
    <sect4 xml:id="sec-samba-yast2-conf-adv-ldap">
     <title>LDAP 设置</title>
     <para>
      在选项卡 <guimenu>LDAP 设置</guimenu>中，您可以确定要用于身份验证的 LDAP 服务器。要测试到 LDAP 服务器的连接，请单击<guimenu>测试连接</guimenu>。要设置专家 LDAP 设置或使用默认值，请单击<guimenu>高级设置</guimenu>。
     </para>
     <para>
      有关 LDAP 配置的更多信息，请参见<xref linkend="cha-security-ldap"/>。
     </para>
    </sect4>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-samba-serv-inst-manual" os="sles;osuse">
   <title>手动配置服务器</title>
   <para>
       如果想将 Samba 用作服务器，请安装 <systemitem class="resource">samba</systemitem>。Samba 的主配置文件是 <filename>/etc/samba/smb.conf</filename>。可以将此文件分为两个逻辑部分。<literal>[global]</literal> 部分包含中央和全局设置。以下默认部分包含各个文件和打印机共享：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      [homes]
     </para>
    </listitem>
    <listitem>
     <para>
      [profiles]
     </para>
    </listitem>
    <listitem>
     <para>
      [users]
     </para>
    </listitem>
    <listitem>
     <para>
      [groups]
     </para>
    </listitem>
    <listitem>
     <para>
      [printers]
     </para>
    </listitem>
    <listitem>
     <para>
      [print$]
     </para>
    </listitem>
   </itemizedlist>
   <para>
    通过此方法，您可以设置不同的共享选项，或在 <literal>[global]</literal> 部分设置全局共享选项，这使得配置文件更容易理解。
   </para>
   <sect3 xml:id="sec-samba-smb-conf-Erlaeuterung">
    <title>global 部分</title>
    <para>
     应该修改 <literal>[global]</literal> 部分的以下参数来满足网络设置的要求，以使其他计算机能在 Windows 环境中通过 SMB 访问 Samba 服务器。
    </para>
    <remark>ke: Important entries missing?</remark>
    <variablelist>
     <varlistentry>
      <term><literal>workgroup = WORKGROUP</literal>
      </term>
      <listitem>
       <para>
        此行将 Samba 服务器指派到工作组。将 <literal>WORKGROUP</literal> 替换为您网络环境的适当工作组。您的 Samba 服务器将出现在其 DNS 名称下，除非此名称已指派给网络中的其他计算机。如果 DNS 名称不可用，请使用 <literal>netbiosname=<replaceable>MYNAME</replaceable></literal> 设置服务器名称。有关此参数的更多细节，请参见 <systemitem>smb.conf</systemitem> 手册页。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>os level = 20</literal>
      </term>
      <listitem>
       <para>
        此参数确定您的 Samba 服务器是否会尝试成为其工作组的 LMB（本地主浏览器）。为了避免现有 Windows 网络因 Samba 服务器配置不当而中断，应选择非常低的值，如 <literal>2</literal>。有关此主题的更多信息，可以在《Samba 3 Howto》（Samba 3 操作指南）的“Network Browsing”（网络浏览）一章中找到；有关《Samba 3 Howto》的更多信息，请参见<xref linkend="sec-samba-info"/>。
       </para>
       <para>
        如果网络中没有其他 SMB 服务器（如 Windows 2000 服务器），并且您希望 Samba 服务器保留一份本地环境中存在的所有系统的列表，请将 <literal>os level</literal> 设置为一个较高的值（例如 <literal>65</literal>）。然后便可以选择您的 Samba 服务器作为本地网络的 LMB。
       </para>
       <para>
        在更改此设置时，应认真考虑这样做对现有 Windows 网络环境的影响。应该首先在一个孤立网络中或一天中的非重要时间测试这些更改。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>wins support</literal> 和 <literal>wins server</literal>
      </term>
      <listitem>
       <para>
        为了将您的 Samba 服务器集成到具有活动 WINS 服务器的现有 Windows 网络中，应启用 <option>wins server</option> 选项并将其值设置为 WINS 服务器的 IP 地址。
       </para>
       <para>
        如果您的各 Windows 计算机连接到不同的子网，而它们又需要看到彼此，您必须设置一个 WINS 服务器。要将 Samba 服务器转变为这样的 WINS 服务器，请设置选项 <literal>wins support = Yes</literal>。确保网络中只有一个 Samba 服务器启用了此设置。切勿在您的 <filename>smb.conf</filename> 文件中同时启用选项 <literal>wins server</literal> 和 <literal>wins support</literal>。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="sec-samba-smb-conf-shares">
    <title>共享</title>
    <para>
     以下示例描述了如何使 CD-ROM 驱动器和用户目录 (<literal>homes</literal>) 对 SMB 客户端可用。
    </para>
    <variablelist>
     <varlistentry>
      <term>[cdrom]</term>
      <listitem>
       <para>
        为了避免意外地使 CD-ROM 驱动器变得可用，应使用注释标记（在本例中是分号）取消这些行。删除第一列中的分号，以便与 Samba 共享 CD-ROM 驱动器。
       </para>
       <example xml:id="dat-cd-rom">
        <title>CD-ROM 共享</title>
<screen>[cdrom]
       comment = Linux CD-ROM
       path = /media/cdrom
       locking = No</screen>
       </example>
       <variablelist>
        <varlistentry>
         <term><option>[cdrom]</option> 和 <option>comment</option>
         </term>
         <listitem>
          <para>
           <literal>[cdrom]</literal> 部分项是网络上的所有 SMB 客户端均可看到的共享的名称。可以添加一个附加 <literal>comment</literal> 来进一步描述此共享。
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><option>path = /media/cdrom</option>
         </term>
         <listitem>
          <para>
           <option>path</option> 导出目录 <filename>/media/cdrom</filename>。
          </para>
         </listitem>
        </varlistentry>
       </variablelist>
       <para>
        通过严格限制的默认配置，可使这种共享仅对此系统上存在的用户可用。如果应使此共享对所有用户可用，请向配置中添加一行 <literal>guest ok = yes</literal>。此设置为网络上的所有用户提供读权限。建议您认真处理此参数。在 <literal>[global]</literal> 部分使用此参数时更应如此。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>[homes]</option>
      </term>
      <listitem>
       <para>
        <option>[home]</option> 共享在这里特别重要。如果用户具有 Linux 文件服务器的有效帐户和口令以及自己的主目录，则该用户可以连接到此共享。
       </para>
       <example xml:id="dat-homes-frei">
        <title>[homes] 共享</title>
<screen>[homes]
        comment = Home Directories
        valid users = %S
        browseable = No
        read only = No
        inherit acls = Yes</screen>
       </example>
       <variablelist>
        <varlistentry>
         <term>[homes]</term>
         <listitem>
          <para>
           只要没有其他共享使用连接到 SMB 服务器的用户的共享名称，就会使用 <literal>[homes]</literal> 共享指令动态生成一个共享。生成的共享名称就是用户名。
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><option>valid users = %S</option>
         </term>
         <listitem>
          <para>
           成功建立连接后，会使用具体的共享名称替换 <literal>%S</literal>。对于 <option>[homes]</option> 共享，此名称始终是用户名。这样就可以将用户的共享访问权仅限制于此用户。
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><option>browseable = No</option>
         </term>
         <listitem>
          <para>
           此设置使共享在网络环境中不可见。
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><option>read only = No</option>
         </term>
         <listitem>
          <para>
           默认情况下，Samba 通过 <literal>read only = Yes</literal> 参数来禁止对任何已导出共享的写访问。要使共享可写，请设置值 <literal>read only = No</literal>，它与 <literal>writable = Yes</literal> 是等效的。
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><option>create mask = 0640</option>
         </term>
         <listitem>
          <para>
           那些不是基于 MS Windows NT 的系统不能理解 Unix 权限的概念，所以它们在创建文件时不能指派权限。参数 <literal>create mask</literal> 定义了为新创建文件指派的访问权限。这仅适用于可写共享。事实上，此设置意味着拥有者具有读写权限，且拥有者的主组的成员具有读权限。<option>valid users = %S</option> 禁止读访问，即使该组具有读权限。要使该组能够进行读或写访问，应取消 <option>valid users = %S</option> 一行。
          </para>
         </listitem>
        </varlistentry>
       </variablelist>
      </listitem>
     </varlistentry>
    </variablelist>
    <warning>
     <title>不要与 Samba 共享 <literal>NFS</literal> 载具</title>
     <para>
      与 Samba 共享 <literal>NFS</literal> 载具可能导致数据丢失，并且不支持这样做。请直接在文件服务器上安装 Samba，或者考虑使用替代方式，例如 <literal>iSCSI</literal>。
     </para>
    </warning>
   </sect3>
   <sect3 xml:id="sec-samba-rechte">
    <title>安全性级别</title>
    <para>
     要提高安全性，可以使用口令来保护每个共享访问。SMB 提供以下检查许可权限的方式：
    </para>
    <variablelist>
     <varlistentry>
      <term>用户级安全性 (<literal>security = user</literal>)</term>
      <listitem>
       <para>
        此变体将用户的概念引入了 SMB。每个用户都必须使用自己的口令在服务器上注册。注册后，服务器可以根据用户名来授予访问各个已导出共享的权限。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term>ADS 级安全性 (<literal>security = ADS</literal>)</term>
      <listitem>
       <para>
        在该模式中，Samba 将在 Active Directory 环境中充当域成员。要在该模式中工作，运行 Samba 的计算机需要安装并配置 Kerberos。必须使用 Samba 将该计算机加入到 ADS 领域。此步骤可通过使用 YaST <guimenu>Windows 域成员资格</guimenu>模块完成。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>域级安全性 (<literal>security = domain</literal>)</term>
      <listitem>
       <para>
        仅当计算机已加入到 Windows NT 域中时，该模式才能正常工作。Samba 将尝试验证用户名和口令，方法是将其传递到 Windows NT 主域控制器或备份域控制器。与 Windows NT 服务器所采用的方式相同。它期望将加密口令参数设置为 <literal>yes</literal>。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     选择共享、用户或域级安全性适用于整个服务器。无法既为服务器配置的某些共享提供共享级安全性，同时又为其他共享提供用户级安全性。但是，您可以为系统上每个已配置的 IP 地址运行单独的 Samba 服务器。
    </para>
    <para>
     有关此主题的更多信息，可以在《Samba 3 操作指南》中找到。对于一个系统上的多个服务器，应注意选项 <option>interfaces</option> 和 <option>bind interfaces only</option>。
    </para>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-samba-client-inst">
  <title>配置客户端</title>

  <para>
   客户端只能通过 TCP/IP 访问 Samba 服务器。NetBEUI 和通过 IPX 的 NetBIOS 不能与 Samba 共用。
  </para>

  <sect2 xml:id="sec-samba-client-inst-yast">
   <title>使用 YaST 配置 Samba 客户端</title>
   <para>
    配置 Samba 客户端来访问 Samba 或 Windows 服务器上的资源（文件或打印机）。在<menuchoice> <guimenu> 网络服务</guimenu>
    <guimenu> Windows 域成员资格</guimenu></menuchoice>对话框中输入 NT 或 Active Directory 域或工作组。如果激活<guimenu>将 SMB 信息也用于 Linux 身份验证</guimenu>，则用户身份验证将在 Samba、NT 或 Kerberos 服务器上运行。
   </para>
   <para>
    单击<guimenu>专家设置</guimenu>获取高级配置选项。例如，使用<guimenu>装入服务器目录</guimenu>表启用自动装入服务器用户主目录和身份验证。这样用户就能访问他们在 CIFS 上的主目录。有关细节，请参见 <systemitem>pam_mount</systemitem> 手册页。
   </para>
   <para>
    完成所有设置后，请确认对话框以完成配置。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-samba-anmeld-serv">
  <title>将 Samba 用作登录服务器</title>

  <para>
   在主要由 Windows 客户端组成的网络中，使用户只能使用有效帐户和口令进行注册通常是最好的选择。在基于 Windows 的网络中，此任务由主域控制器 (PDC) 来处理。您可以使用配置为 PDC 的 Windows NT 服务器，但是此任务也可以借助 Samba 服务器来完成。<xref linkend="dat-samba-smb-conf-dom"/>中显示了必须在 <filename>smb.conf</filename> 的 <literal>[global]</literal> 部分设置的项。
  </para>

  <example xml:id="dat-samba-smb-conf-dom">
   <title>smb.conf 中的 global 部分</title>
<screen>[global]
    workgroup = WORKGROUP
    domain logons = Yes
    domain master = Yes</screen>
  </example>

  <para>
   需要准备适合 Windows 加密格式的用户帐户和口令。使用命令 <command>smbpasswd</command> <option>-a name </option>可完成此任务。使用以下命令为计算机创建 Windows 域概念要求的域帐户：
  </para>

<screen>useradd hostname\$
smbpasswd -a -m hostname</screen> 

  <para>
   使用 <command>useradd</command> 命令可添加一个美元符号。命令 <command>smbpasswd</command> 在使用参数 <option>-m</option> 时自动插入此符号。带注释的配置示例 (<filename>/usr/share/doc/packages/samba/examples/smb.conf.SUSE</filename>) 包含自动执行此任务的设置。
  </para>

<screen>add machine script = /usr/sbin/useradd -g nogroup -c "NT Machine Account" \
-s /bin/false %m\$
     </screen>

  <para>
   要确保 Samba 能够正确执行此脚本，请选择具有必需的管理员权限的 Samba 用户，并将其添加到 <systemitem class="groupname">ntadmin</systemitem> 组中。然后可以使用以下命令为属于此 Linux 组的所有用户指派 <literal>Domain Admin</literal> 状态：
  </para>

<screen>net groupmap add ntgroup="Domain Admins" unixgroup=ntadmin</screen>
 </sect1>
 <sect1 xml:id="sec-samba-adnet" os="sles;osuse">
  <title>带有 Active Directory 的网络中的 Samba 服务器</title>

  <para>
   如果您同时运行 Linux 服务器和 Windows 服务器，则可以构建两个独立的身份验证系统和网络，或者将服务器连接到使用一个中央身份验证系统的网络。由于 Samba 可以与 Active Directory 域协作，因此您可以将 SUSE Linux Enterprise Server 加入 Active Directory（AD）。
  </para>

  <para>
   要加入到 AD 域，请执行以下操作：
  </para>

  <procedure>
   <step>
    <para>
     作为 <systemitem class="username">root</systemitem> 登录并启动 YaST。
    </para>
   </step>
   <step>
    <para>
     启动<menuchoice> <guimenu> 网络服务</guimenu> <guimenu> Windows 域成员资格</guimenu> </menuchoice>。
    </para>
   </step>
   <step>
    <para>
     在 <guimenu>Windows 域成员资格</guimenu>屏幕上的<guimenu>域或工作组</guimenu>中输入要加入的域。
    </para>
    <figure>
     <title>确定 Windows 域成员资格</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="ad_sambaclient.png" width="75%"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="ad_sambaclient.png" width="75%"/>
      </imageobject>
     </mediaobject>
    </figure>
   </step>
   <step>
    <para>
     选中<guimenu>同时使用 SMB 信息进行 Linux 身份验证</guimenu>，以在服务器上使用 SMB 源进行 Linux 身份验证。
    </para>
   </step>
   <step>
    <para>
     单击<guimenu>确定</guimenu>并在提示时确认域连接。
    </para>
   </step>
   <step>
    <para>
     在 AD 服务器上提供 Windows Administrator 的口令，并单击<guimenu>确定</guimenu>。
    </para>
    <para>
     现在您的服务器已经设置了从 Active Directory 域控制器获取认证数据。
    </para>
   </step>
  </procedure>

  <tip>
   <title>标识映射</title>
   <para>
    在有多个 Samba 服务器的环境中，将不会采用一致的方式创建 UID 和 GID。指派给用户的 UID 将取决于用户首次登录的顺序，而这会导致在服务器间产生 UID 冲突。要解决此问题，您需要使用身份映射。有关详细信息，请参见<link xlink:href="https://www.samba.org/samba/docs/man/Samba-HOWTO-Collection/idmapper.html"/>。
   </para>
  </tip>
 </sect1>
 <sect1 xml:id="samba-advanced">
  <title>高级主题</title>

  <para>
   本节介绍用于管理 Samba 套件中客户端部分与服务器部分的高级方法。
  </para>

  <sect2 xml:id="samba-advanced-compress">
   <title>Btrfs 上的透明文件压缩</title>
   <para>
    Samba 允许客户端针对 Btrfs 文件系统中的共享远程操作文件与目录压缩标志。Windows 资源管理器可让用户通过<menuchoice><guimenu>文件</guimenu><guimenu>属性</guimenu><guimenu>高级</guimenu></menuchoice>对话框来标记要进行透明压缩的文件/目录：
   </para>
   <figure>
    <title>Windows 资源管理器<guimenu>高级属性</guimenu>对话框</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="samba_win_expl_advattr.png" width="30%"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="samba_win_expl_advattr.png" width="30%"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    带有压缩标志的文件将以透明方式进行压缩，当用户访问或修改这些文件时，底层文件系统会将其解压缩。这通常可以节省储存容量，不过，在访问文件时会造成额外的 CPU 开销。除非新文件和目录是使用 FILE_NO_COMPRESSION 选项创建的，否则，它们将继承父目录的压缩标志。
   </para>
   <para>
    Windows 资源管理器以不同的显示方式区分压缩文件和未压缩文件：
   </para>
   <figure>
    <title>列有压缩文件的 Windows 资源管理器目录</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="samba_win_expl_view_compressed.png" width="30%"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="samba_win_expl_view_compressed.png" width="30%"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    要启用 Samba 共享压缩，您可以将以下内容
   </para>
<screen>vfs objects = btrfs</screen>
   <para>
    手动添加到 <filename>/etc/samba/smb.conf</filename> 中的共享配置，或者使用 YaST：<menuchoice><guimenu>网络服务</guimenu><guimenu>Samba 服务器</guimenu><guimenu>添加</guimenu></menuchoice>，然后选中<guimenu>使用 Btrfs 功能</guimenu>。
   </para>
   <para os="sles">
    有关 Btrfs 上的压缩功能的一般概述，请参见<xref linkend="sec-filesystems-major-btrfs-compress"/>。
   </para>
  </sect2>

  <sect2 xml:id="samba-advanced-snapshots">
   <title>快照</title>
   <para>
    快照也称为阴影副本，是指某个文件系统子卷在特定时间点的状态副本。在 Linux 中，可以使用 Snapper 工具来管理这些快照。Btrfs 文件系统或精简配置的 LVM 卷支持快照。Samba 套件支持通过服务器端和客户端的 FSRVP 协议管理远程快照。
   </para>
   <sect3 xml:id="samba-advanced-snapshots-client">
    <title>先前版本</title>
    <para>
     Samba 服务器上的快照可以作为文件或目录的先前版本公开给远程 Windows 客户端。
    </para>
    <para>
     要在 Samba 服务器上启用快照，必须符合以下条件：
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       SMB 网络共享位于 Btrfs 子卷上。
      </para>
     </listitem>
     <listitem>
      <para>
       SMB 网络共享路径中包含相关的 snapper 配置文件。可以使用以下命令创建 snapper 文件
      </para>
<screen>snapper -c &lt;cfg_name&gt; create-config <option>/path/to/share</option></screen>
      <para>
       有关 snapper 的更多信息，请参见<xref linkend="cha-snapper"/>。
      </para>
     </listitem>
     <listitem>
      <para>
       必须允许相关用户访问快照目录树。有关更多信息，请参见 vfs_snapper 手册页 (<command>man 8 vfs_snapper</command>) 的 PERMISSIONS（权限）部分。
      </para>
     </listitem>
    </itemizedlist>
    <para>
     要支持远程快照，需要修改 <filename>/etc/samba/smb.conf</filename> 文件。要完成此操作，您可以选择 <menuchoice><guimenu>YaST</guimenu><guimenu>网络服务</guimenu><guimenu>Samba 服务器</guimenu></menuchoice>，或者使用以下命令手动增强相关的共享部分
    </para>
<screen>vfs objects = snapper</screen>
    <para>
     请注意，只有在重启动 Samba 服务后，对 <filename>smb.conf</filename> 所做的手动更改才能生效：
    </para>
<screen>systemctl restart nmb smb</screen>
    <figure xml:id="fig-yast2-samba-snapshot">
     <title>在启用快照的情况下添加新的 Samba 共享</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="yast2_samba_snapshot.png" width="70%"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="yast2_samba_snapshot.png" width="75%"/>
      </imageobject>
     </mediaobject>
    </figure>
    <para>
     经过配置后，可以通过 Windows 资源管理器中某个文件或目录的<guimenu>以前的版本</guimenu>选项卡访问 snapper 为 Samba 共享路径创建的快照。
    </para>
    <figure xml:id="fig-samba-win-explorer">
     <title>Windows 资源管理器中的<guimenu>以前的版本</guimenu>选项卡</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="samba_winexpl_previous_versions.png" width="70%"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="samba_winexpl_previous_versions.png" width="75%"/>
      </imageobject>
     </mediaobject>
    </figure>
   </sect3>
   <sect3 xml:id="samba-advanced-snapshots-server">
    <title>远程共享快照</title>
    <para>
     默认情况下，只能在 Samba 服务器本地通过 snapper 命令行实用程序或者使用 snapper 时间轴功能来创建和删除快照。
    </para>
    <para>
     可将 Samba 配置为使用文件服务器远程 VSS 协议 (FSRVP) 处理远程主机发出的共享快照创建和删除请求。
    </para>
    <para>
     除了<xref linkend="samba-advanced-snapshots-client"/>中所述的配置和先决条件以外，还需要在 <filename>/etc/samba/smb.conf</filename> 中指定以下全局配置：
    </para>
<screen>[global]
rpc_daemon:fssd = fork
registry shares = yes
include = registry</screen>
    <para>
     然后，FSRVP 客户端（包括 Samba 的 <command>rpcclient</command> 以及 Windows Server 2012 <command>DiskShadow.exe</command>）便可以指示 Samba 为指定的共享创建或删除快照，并将该快照公开为新共享。
    </para>
   </sect3>
   <sect3 xml:id="samba-advanced-snapshots-client-linux">
    <title>使用 <command>rpcclient</command> 从 Linux 远程管理快照</title>
    <para>
     <systemitem>samba-client</systemitem> 包中有一个 FSRVP 客户端，它可以远程请求 Windows/Samba 服务器创建并公开指定共享的快照。然后，您可以使用 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 中的现有工具装入公开的共享并备份其文件。向服务器发出的请求将使用 <command>rpcclient</command> 二进制文件发送。
    </para>
    <example>
     <title>使用 <command>rpcclient</command> 请求 Windows Server 2012 共享快照</title>
     <para>
      以 <literal>EXAMPLE</literal> 域中管理员的身份连接到 <literal>win-server.example.com</literal> 服务器：
     </para>
<screen># rpcclient -U '<replaceable>EXAMPLE</replaceable>\Administrator' ncacn_np:<replaceable>win-server.example.com</replaceable>[ndr64,sign]
Enter EXAMPLE/Administrator's password:</screen>
     <para>
      检查 SMB 共享是否对于 <command>rpcclient</command> 可见：
     </para>
<screen>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)</screen>
     <para>
      检查 SMB 共享是否支持创建快照：
     </para>
<screen>rpcclient $&gt; fss_is_path_sup windows_server_2012_share \
UNC \\WIN-SERVER\windows_server_2012_share\ supports shadow copy requests</screen>
     <para>
      请求创建共享快照：
     </para>
<screen>rpcclient $&gt; fss_create_expose backup ro windows_server_2012_share
13fe880e-e232-493d-87e9-402f21019fb6: shadow-copy set created
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
\\WIN-SERVER\windows_server_2012_share\ shadow-copy added to set
13fe880e-e232-493d-87e9-402f21019fb6: prepare completed in 0 secs
13fe880e-e232-493d-87e9-402f21019fb6: commit completed in 1 secs
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
share windows_server_2012_share@{1C26544E-8251-445F-BE89-D1E0A3938777} \
exposed as a snapshot of \\WIN-SERVER\windows_server_2012_share\</screen>
     <para>
      确认服务器是否已公开快照共享：
     </para>
<screen>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)

netname: windows_server_2012_share@{1C26544E-8251-445F-BE89-D1E0A3938777}
remark: (null)
path:   \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy{F6E6507E-F537-11E3-9404-B8AC6F927453}\Shares\windows_server_2012_share\
password:       (null)</screen>
     <para>
      尝试删除快照共享：
     </para>
<screen>rpcclient $&gt; fss_delete windows_server_2012_share \
13fe880e-e232-493d-87e9-402f21019fb6 1c26544e-8251-445f-be89-d1e0a3938777
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
\\WIN-SERVER\windows_server_2012_share\ shadow-copy deleted</screen>
     <para>
      确认服务器是否已去除快照共享：
     </para>
<screen>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)</screen>
    </example>
   </sect3>
   <sect3 xml:id="samba-advanced-snapshots-client-winserver">
    <title>使用 <command>DiskShadow.exe</command> 从 Windows 远程管理快照</title>
    <para>
     您也可以在充当客户端的 Windows 环境中，管理 Linux Samba 服务器上的 SMB 共享的快照。Windows Server 2012 提供了 <command>DiskShadow.exe</command> 实用程序，该程序可以像<xref linkend="samba-advanced-snapshots-client-linux"/>中所述的 <command>rpcclient</command> 那样管理远程共享。请注意，首先您需要妥善设置 Samba 服务器。
    </para>
    <para>
     以下示例步骤描述了如何设置 Samba 服务器，使 Windows Server 客户端能够管理其共享的快照。请注意，<replaceable>EXAMPLE</replaceable> 是在测试环境中使用的 Active Directory 域，
     <uri>fsrvp-server.example.com</uri> 是 Samba 服务器的主机名，<filename>/srv/smb</filename> 是 SMB 共享的路径。
    </para>
    <procedure>
     <title>Samba 服务器配置详细说明</title>
     <step>
      <para>
       通过 YaST 加入到 Active Directory 域。<phrase os="sles;osuse"> 详细信息, <xref linkend="sec-samba-adnet"/>.</phrase>
      </para>
     </step>
     <step>
      <para>
       确保“活动域 DNS”项正确：
      </para>
<screen>fsrvp-server:~ # net -U 'Administrator' ads dns register \
fsrvp-server.example.com &lt;IP address&gt;
Successfully registered hostname with DNS</screen>
     </step>
     <step>
      <para>
       在 <filename>/srv/smb</filename> 位置创建 Btrfs 子卷
      </para>
<screen>fsrvp-server:~ # btrfs subvolume create /srv/smb</screen>
     </step>
     <step>
      <para>
       为路径 <filename>/srv/smb</filename> 创建 snapper 配置文件
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; create-config /srv/smb</screen>
     </step>
     <step>
      <para>
       创建路径为 <filename>/srv/smb</filename> 的新共享，并启用 YaST <guimenu>公开快照</guimenu>复选框。确保将以下代码片段添加到 <filename>/etc/samba/smb.conf</filename> 的 global 部分，如<xref linkend="samba-advanced-snapshots-server"/>中所述：
      </para>
<screen>[global]
 rpc_daemon:fssd = fork
 registry shares = yes
 include = registry</screen>
     </step>
     <step>
      <para>
       使用 <command>systemctl restart nmb smb</command> 重启动 Samba
      </para>
     </step>
     <step>
      <para>
       配置 snapper 权限：
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; set-config \
ALLOW_USERS="EXAMPLE\\\\Administrator EXAMPLE\\\\win-client$"</screen>
      <para>
       确保也允许任何 ALLOW_USERS 浏览 <filename>.snapshots</filename> 子目录。
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; set-config SYNC_ACL=yes</screen>
      <important>
       <title>路径转义</title>
       <para>
        请小心使用“\”转义！请转义两次，以确保 <filename>/etc/snapper/configs/&lt;snapper_config&gt;</filename> 中储存的值转义一次。
       </para>
      </important>
      <para>
       "EXAMPLE\win-client$" 对应于 Windows 客户端计算机帐户。对此帐户进行验证后，Windows 将发出初始 FSRVP 请求。
      </para>
     </step>
     <step>
      <para>
       授予 Windows 客户端帐户必要的特权：
      </para>
<screen>fsrvp-server:~ # net -U 'Administrator' rpc rights grant \
"EXAMPLE\\win-client$" SeBackupPrivilege
Successfully granted rights.</screen>
      <para>
       不需要对 "EXAMPLE\Administrator" 用户执行上一条命令，因为已授予该用户特权。
      </para>
     </step>
    </procedure>
    <procedure>
     <title>运行 Windows 客户端设置和 <command>DiskShadow.exe</command></title>
     <step>
      <para>
       引导 Windows Server 2012（示例主机名为 WIN-CLIENT）。
      </para>
     </step>
     <step>
      <para>
       就像在 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 上那样，加入到同一个 Active Directory 域 EXAMPLE。
      </para>
     </step>
     <step>
      <para>
       重引导。
      </para>
     </step>
     <step>
      <para>
       打开 Powershell。
      </para>
     </step>
     <step>
      <para>
       启动 <command>DiskShadow.exe</command>，然后开始执行备份过程：
      </para>
<screen>PS C:\Users\Administrator.EXAMPLE&gt; diskshadow.exe
Microsoft DiskShadow version 1.0
Copyright (C) 2012 Microsoft Corporation
On computer:  WIN-CLIENT,  6/17/2014 3:53:54 PM

DISKSHADOW&gt; begin backup</screen>
     </step>
     <step>
      <para>
       指定每次程序退出、重设置或重引导时要保留的阴影副本：
      </para>
<screen>DISKSHADOW&gt; set context PERSISTENT</screen>
     </step>
     <step>
      <para>
       检查指定的共享是否支持快照，然后创建一个快照：
      </para>
<screen>DISKSHADOW&gt; add volume \\fsrvp-server\sles_snapper

DISKSHADOW&gt; create
Alias VSS_SHADOW_1 for shadow ID {de4ddca4-4978-4805-8776-cdf82d190a4a} set as \
 environment variable.
Alias VSS_SHADOW_SET for shadow set ID {c58e1452-c554-400e-a266-d11d5c837cb1} \
 set as environment variable.

Querying all shadow copies with the shadow copy set ID \
 {c58e1452-c554-400e-a266-d11d5c837cb1}

 * Shadow copy ID = {de4ddca4-4978-4805-8776-cdf82d190a4a}     %VSS_SHADOW_1%
    - Shadow copy set: {c58e1452-c554-400e-a266-d11d5c837cb1}  %VSS_SHADOW_SET%
    - Original count of shadow copies = 1
    - Original volume name: \\FSRVP-SERVER\SLES_SNAPPER\ \
      [volume not on this machine]
    - Creation time: 6/17/2014 3:54:43 PM
    - Shadow copy device name:
      \\FSRVP-SERVER\SLES_SNAPPER@{31afd84a-44a7-41be-b9b0-751898756faa}
    - Originating machine: FSRVP-SERVER
    - Service machine: win-client.example.com
    - Not exposed
    - Provider ID: {89300202-3cec-4981-9171-19f59559e0f2}
    - Attributes:  No_Auto_Release Persistent FileShare

Number of shadow copies listed: 1</screen>
     </step>
     <step>
      <para>
       完成备份过程：
      </para>
<screen>DISKSHADOW&gt; end backup</screen>
     </step>
     <step>
      <para>
       创建快照后，尝试将它删除，并确认删除结果：
      </para>
<screen>DISKSHADOW&gt; delete shadows volume \\FSRVP-SERVER\SLES_SNAPPER\
Deleting shadow copy {de4ddca4-4978-4805-8776-cdf82d190a4a} on volume \
 \\FSRVP-SERVER\SLES_SNAPPER\ from provider \
{89300202-3cec-4981-9171-19f59559e0f2} [Attributes: 0x04000009]...

Number of shadow copies deleted: 1

DISKSHADOW&gt; list shadows all

Querying all shadow copies on the computer ...
No shadow copies found in system.</screen>
     </step>
    </procedure>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-samba-info">
  <title>更多信息</title>

  <para>
   Samba 文档包含在 <systemitem>samba-doc</systemitem> 包中，默认情况下不会安装该包。您可以使用 <command>zypper install samba-doc</command> 进行安装。在命令行中输入 <command>apropos</command>
   <option> samba</option> 可显示一些手册页；或浏览 <filename>/usr/share/doc/packages/samba</filename> 目录以获取更多的联机文档和示例。<filename>examples</filename> 子目录中提供了一个带注释的示例配置 (<filename>smb.conf.SUSE</filename>)。另一个可以查看 Samba 相关信息的文件是 <filename>/usr/share/doc/packages/samba/README.SUSE</filename>。
  </para>

  <para>
   Samba 小组提供的《Samba 操作指南》（请参见 <link xlink:href="https://wiki.samba.org"/>）中有一节专门介绍查错。此外，文档的第 V 部分提供了检查配置的逐步指南。
  </para>
 </sect1>
</chapter>
