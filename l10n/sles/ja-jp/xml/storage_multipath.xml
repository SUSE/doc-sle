<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="storage_multipath.xml" version="5.0" xml:id="cha-multipath" xml:lang="ja">
 <title>デバイスのマルチパスI/Oの管理</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <para>
  本項では、マルチパスI/O (MPIO)を使用して、サーバ/ブロックストレージデバイス間のマルチパスのフェールオーバーおよびパスの負荷分散を管理する方法について説明します。
 </para>
 <sect1 xml:id="sec-multipath-intro">
  <title>マルチパスI/Oの理解</title>

  <para>
   マルチパス処理とは、サーバのホストバスアダプタおよびデバイスのストレージコントローラ間で、複数の物理パスをまたいで、同じ物理または論理ブロックストレージデバイスと通信するサーバの機能です。これは、通常、FC (Fibre Channel)環境またはiSCSI SAN環境で行われます。
  </para>

  <para>
   Linuxマルチ処理は、接続に耐障害性を与え、アクティブな接続全体.に負荷を分散します。マルチパス処理が設定および実行されていると、自動的に、デバイス接続の障害が特定され、I/Oが代替の接続に再経路指定されます。
  </para>

  <para>
    マルチパス処理は、接続の障害に対して耐障害性を提供しますが、ストレージデバイス自体の障害に対する耐障害性は提供しません。後者は、ミラーリングのような補完テクニックによって提供されます。
  </para>

  <sect2>
    <title>マルチパスの用語</title>
    <variablelist>
      <varlistentry>
	<term>
	  ストレージアレイ
	</term>
	<listitem>
	  <para>
	    SANストレージまたはNASストレージをクライアントに提供する多数のディスクおよび複数のファブリック接続(コントローラ)を備えたハードウェアデバイス。通常、ストレージアレイはRAIDおよびフェールオーバー機能を備えていて、マルチパス処理をサポートしています。これまでは、アクティブ/パッシブ(フェールオーバー)ストレージアレイおよびアクティブ/アクティブ(ロードバランシング)ストレージアレイは区別されていました。このような概念は依然として存在していますが、最新ハードウェアによってサポートされるパスグループおよびアクセス状態の特殊な概念に過ぎません。
	  </para>
	</listitem>
      </varlistentry>
      <varlistentry>
	<term>
	  ホスト、ホストシステム
	</term>
	<listitem>
	  <para>
	    <emphasis>ストレージアレイ</emphasis>のクライアントシステムとして動作する<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>を実行しているコンピュータ。
	  </para>
	</listitem>
      </varlistentry>
      <varlistentry>
	<term>
	  マルチパスマップ、マルチパスデバイス
	</term>
	<listitem>
	  <para>
	  一連の<emphasis>パスデバイス</emphasis>です。これは、ストレージアレイのストレージボリュームを表し、ホストシステムからは単一のブロックデバイスとして見なされます。
	  </para>
	</listitem>
      </varlistentry>
      <varlistentry>
	<term>
	  パスデバイス、低レベルデバイス
	</term>
	<listitem>
	  <para>
	    マルチパスマップのメンバー(通常はSCSIデバイス)です。ホストコンピュータと実際のストレージボリューム(iSCSIセッションの論理ユニットなど)との間における一意の接続を各パスデバイスが表します。Linuxデバイスマッパーマルチパスでは、ホストシステムから認識可能かつアクセス可能な状態がパスデバイスで維持されます。
	  </para>
	</listitem>
      </varlistentry>
      <varlistentry>
	<term>
	  WWID、UID、UUID
	</term>
	<listitem>
	  <para>
	    「World Wide Identifier」、「Unique Identifier」、「Universally Unique Identifier」です。WWIDは、ストレージボリュームのプロパティであるため、マルチパスマップのすべてのパスデバイスで同じです。<filename>multipath-tools</filename>ではWWIDを使用して、マルチパスマップにアセンブルする必要がある低レベルデバイスを判断します。マルチパスでは<command>udev</command>を使用してパスデバイスのWWIDを判断します。マルチパスマップのWWIDは変更されません。マルチパスデバイスには<filename>/dev/disk/by-id/dm-uuid-mpath-<replaceable>WWID</replaceable></filename>を使用して安定してアクセスできます。
	  </para>
	  <para>
	    WWIDは設定可能な<emphasis>マップ名</emphasis>と区別する必要があります(<xref linkend="sec-multipath-names" xrefstyle="SectTitleOnPage"/>を参照)。
	  </para>
	</listitem>
      </varlistentry>
      <varlistentry>
	<term>
	  uevent、udevイベント
	</term>
	<listitem>
	  <para>
	    カーネルによってユーザスペースに送信されて<command>udev</command>サブシステムによって処理されるイベント。デバイスの追加や削除、またはプロパティの変更を行うと、ueventが生成されます。
	  </para>
	</listitem>
      </varlistentry>
      <varlistentry>
	<term>
	  デバイスマッパー
	</term>
	<listitem>
	  <para>
	    仮想ブロックデバイスを作成するためのLinuxカーネルのフレームワークです。マップデバイスに対するI/O操作は基礎となるブロックデバイスにリダイレクトされます。デバイスマッピングはスタックされる場合があります。デバイスマッパーでは独自のイベントシグナル処理を実装します。これは「デバイスマッパーイベント」または「dmイベント」とも呼ばれます。
	  </para>
	</listitem>
      </varlistentry>
    </variablelist>
 </sect2>
 </sect1>
 <sect1 xml:id="sec-multipath-hardware">
  <title>ハードウェアサポート</title>

  <para>
   <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>がサポートしているすべてのアーキテクチャで、マルチパス処理のドライバおよびツールが使用できます。プロトコルを区別しない汎用ドライバは、市販のほとんどのマルチパス対応ストレージハードウェアで動作します。一部のストレージアレイベンダは、独自のマルチパス処理管理ツールを提供しています。ベンダのハードウェアマニュアルを参照して、どのような設定が必要か判別してください。
  </para>

  <sect2 xml:id="sec-multipath-hardware-implementations">
    <title>マルチパス実装: デバイスマッパーとNVMe</title>

    <para>
      Linuxにおけるマルチパス処理で従来の一般的な実装では、デバイスマッパーフレームワークを使用します。SCSIデバイスなどのほとんどのデバイスタイプでは、デバイスマッパーのマルチパス処理が唯一使用可能な実装です。デバイスマッパーのマルチパス処理は高度に設定可能であり、柔軟です。
    </para>
    <para>
      Linux <emphasis>NVM Express</emphasis> (NVMe)カーネルサブシステムでは、カーネルでマルチパス処理をネイティブに実装します。通常高速で遅延が非常に小さいNVMeデバイスの演算オーバーヘッドが、この実装で軽減されています。ネイティブNVMeマルチパス処理ではユーザスペースコンポーネントは不要です。SLE 15以降、ネイティブマルチパス処理がNVMeマルチパスデバイスのデフォルトになっています。
    </para>
    <para>
      この章の残りの部分ではデバイスマッパーのマルチパスについて説明します。
    </para>
  </sect2>

  <sect2 xml:id="sec-multipath-hardware-autodetect">
    <title>マルチパス処理のストレージアレイ自動検出</title>
    <para>
      デバイスマッパーのマルチパスは一般的な技術です。マルチパスデバイスの検出で必要なことは、低レベルデバイス(SCSIなど)がカーネルによって検出されることと、デバイスのプロパティが複数の低レベルデバイスを(実際に異なるデバイスではなく)同じボリュームへの異なる「パス」として安定的に特定することのみです。
    </para>
    <para>
      <filename>multipath-tools</filename>パッケージはベンダおよび製品名でストレージアレイを検出します。これには、広範なストレージ製品に対して検証済みのデフォルト設定が組み込まれています。ご使用のストレージアレイのハードウェアドキュメントを参照してください。Linuxのマルチパス処理設定に対して独自の推奨事項を提示しているベンダもあります。ご使用のシステムで検出されたストレージの組み込み設定を確認するには、コマンド<command>multipath -T</command>を実行します。<xref linkend="sec-multipath-mpiotools-multipath" xrefstyle="SectTitleOnPage"/>を参照してください。
    </para>
   <para>
    ご使用のストレージアレイ用に組み込み設定を変更する必要がある場合、<filename>/etc/multipath.conf</filename>ファイルを作成して設定します。<xref linkend="sec-multipath-conf-file" xrefstyle="SectTitleOnPage"/>を参照してください。
   </para>
   <note>
     <para>
       <filename>multipath-tools</filename>には、多くのストレージアレイ用の事前設定が組み込まれています。あるストレージ製品用にこのような事前設定が存在することは、そのストレージ製品のベンダが<systemitem>dm-multipath</systemitem>で製品をテストしたことを意味しませんし、ベンダがその製品で<systemitem>dm-multipath</systemitem>の使用に関して保証やサポートを行うことも<emphasis>意味しません</emphasis>。サポート関連の質問については、ベンダのドキュメントを必ず参照してください。
     </para>
   </note>
  </sect2>

  <sect2 xml:id="sec-multipath-hardware-handlers">
   <title>特定のハードウェアハンドラを必要とするストレージアレイ</title>
   <para>
    あるパスから別のパスにフェールオーバーするための特殊なコマンドや標準と異なるエラー処理方法が必要なストレージアレイもあります。これらの特殊なコマンドや処理方法は、Linuxカーネルのハードウェアハンドラによって実装されています。最新のSCSIストレージアレイは、SCSI標準で定義されている「Asymmetric Logical Unit Access」(ALUA)ハードウェアハンドラをサポートしています。ALUAに加えて、SLEカーネルにはNetapp E-Series (RDAC)、Dell/EMC CLARiiON CXアレイファミリ、およびHPのレガシアレイのハードウェアハンドラが含まれています。Linuxカーネル4.4以降では、ほとんどのアレイ(ALUAをサポートするすべてのアレイを含む)のハードウェアハンドラをLinuxカーネルで自動検出します。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-multipath-planning">
  <title>マルチパス処理のプラニング</title>

  <para>
   マルチパスI/Oソリューションのプラニング時には、本項のガイドラインに従ってください。
  </para>

  <sect2 xml:id="sec-multipath-planning-prereq">
   <title>前提条件</title>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      マルチパス処理対象のデバイスに使用するストレージアレイで、マルチパス処理がサポートされている必要があります。詳細については、<xref linkend="sec-multipath-hardware" xrefstyle="SectTitleOnPage"/>を参照してください。
     </para>
    </listitem>
    <listitem>
     <para>
      サーバのホストバスアダプタおよびブロックストレージデバイスのバスコントローラ間に複数の物理パスが存在している場合のみ、マルチパス処理を設定する必要があります。
     </para>
    </listitem>
    <listitem>
     <para>
      一部のストレージアレイについては、アレイの物理および論理デバイスのマルチパス処理を管理するための独自のマルチパス処理ソフトウェアがベンダから提供されます。この場合は、ベンダの指示に従って、それらのデバイスのマルチ処理を設定してください。
     </para>
    </listitem>
    <listitem>
     <para>
      仮想化環境でマルチパス処理を使用する場合、マルチパス処理は、ホストサーバ環境で制御されます。デバイスのマルチパス処理を設定してから、デバイスを仮想ゲストマシンに割り当ててください。
     </para>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="sec-multipath-planning-types">
    <title>マルチパスのインストールタイプとinitramfs</title>
    <sect3 xml:id="sec-multipath-planning-type-root">
      <title>マルチパスのルートファイルシステム(SANブート)</title>
      <para>
	ルートファイルシステムはマルチパスデバイス上にあります(通常、他のすべてのファイルシステムもマルチパスストレージ上にあります)。これは通常、ディスクのないサーバでSANストレージまたはNASストレージのみを使用する場合です。このようなシステムでは、起動時にマルチパスのサポートが必須で、マルチパス処理をinitramfs (initrd)で有効にする必要があります。<xref linkend="sec-multipath-initrd-sync" xrefstyle="SectTitleOnPage"/>を参照してください。
      </para>
    </sect3>
    <sect3 xml:id="sec-multipath-planning-type-noroot">
      <title>ローカルディスクのルートファイルシステム</title>
      <para>
	ルートファイルシステム(および場合によってはその他のファイルシステム)はローカルストレージ(直接アタッチされているSATAディスク、ローカルRAIDなど)にありますが、このシステムはマルチパスのSANストレージまたはNASストレージのファイルシステムを追加で使用します。このシステムタイプは次の3つの方法で設定できます。
      </para>
      <variablelist>
      <varlistentry>
      <term>root-on-multipathセットアップの使用</term>
      
	<listitem>
	  <para>
	  
	  すべてのブロックデバイスはローカルディスクを含むマルチパスマップの一部です。このようなセットアップでは、1つのパスのみを含むディグレードマルチパスマップとして現れます。YaSTによる初期システムインストール中にマルチパス処理が有効になると、この設定が作成されます。これは最も単純な設定ですが、パフォーマンスのオーバーヘッドがあります。
	  </para>
	</listitem>
	</varlistentry>
	<varlistentry>
	<term><systemitem>multipath-tools</systemitem>でローカルディスクを無視する </term>
	<listitem>
	  <para>
	    この設定では、マルチパス処理はinitramfsで有効になります。ブラックリスト化によるインストール後や、<literal>find_multipaths</literal>設定パラメータで、この設定を実行できます。
	  </para>
	</listitem>
	</varlistentry>
	<varlistentry xml:id="vl-multipath-planning-type-noroot-noinitrd">
	<term>initramfsでマルチパス処理を無効にする</term>
	<listitem>
	  <para>
	  YaSTがマルチパスデバイスを検出しなかったことやユーザがインストール中にマルチパスを有効にしなかったことのいずれかが原因で、YaSTによる初期システムインストール中にマルチパス処理が有効にされなかった場合、このセットアップが作成されます。これは<xref linkend="sec-multipath-initrd-sync" xrefstyle="SectTitleOnPage"/>が適用されない唯一の状況です。
	  </para>
	</listitem>
      </varlistentry>
      </variablelist>
      <para>
	
	
      </para>
    </sect3>
    <sect3 xml:id="sec-multipath-initrd-sync">
      <title>初期RAMディスクの同期状態を維持する</title>
      <important>
	<para>
	  すべてのブロックデバイスでマルチパス処理の使用に関して一貫性のある動作が初期RAMディスクおよびブートシステムで確保されることを確認してください。マルチパス設定の変更を適用した後にinitramfsを再構築します。
	</para>
      </important>
      <para>システムでマルチパス処理が有効になっている場合は<filename>initramfs</filename>でも有効にする必要があり、その逆も同様です。このルールの唯一の例外は<xref linkend="sec-multipath-planning-type-noroot" xrefstyle="SectTitleOnPage"/>のオプション<xref linkend="vl-multipath-planning-type-noroot-noinitrd"/>です。
      </para>
      <para>
  このマルチパス設定はブートシステムとinitrdの間で同期させる必要があります。したがって、<filename>/etc/multipath.conf</filename>、<filename>/etc/multipath/wwids</filename>、<filename>/etc/multipath/bindings</filename>などの設定ファイルが変更されたり、デバイス識別に関するudevルールが変更されると、次のコマンドを使用して初期のRAM FSを再構築する必要があります。
</para>
  <screen><prompt>&gt; </prompt><command>sudo</command> dracut -f</screen>
      <para>
  <filename>initrd</filename>とシステムが同期されていない場合、システムは正しくブートせず、起動手順を実行すると緊急シェルが起動する場合があります。このようなシナリオを回避または修復する方法については、<xref linkend="sec-multipath-trouble-root"/>を参照してください。
      </para>
      <para>
  初期のRAMディスクが非標準的な状況で再構築される場合(カーネルパラメータの<literal>multipath=off</literal>を使用してブートした後やレスキューシステムからなど)、特別な注意が必要です。<command>dracut</command>では、initrdが構築されるときにルートファイルシステムがマルチパスデバイス上にあることを検出した場合のみ初期RAMディスクにマルチパス処理のサポートを自動的に組み込みます。このような場合、マルチパス処理を明示的に有効または無効にする必要があります。
      </para>
      <para>
      <filename>initrd</filename>でマルチパスのサポートを有効にするには、次のコマンドを実行します。
      </para>
      <screen>
<prompt>&gt; </prompt><command>sudo</command> dracut --force --add multipath
</screen>
<para>
<filename>initrd</filename>でマルチパスのサポートを無効にするには、次のコマンドを実行します。
</para>
<screen>
<prompt>&gt; </prompt><command>sudo</command> dracut --force --omit multipath
</screen>
    </sect3>
  </sect2>
  <sect2 xml:id="sec-multipath-planning-disks">
   <title>ディスク管理タスク</title>
   <para>
     サードパーティのSANアレイ管理ツールまたはご使用のストレージアレイのユーザインタフェースを使用して、論理デバイスを作成し、それらをホストに割り当てます。両側でホストの資格情報を正しく設定してください。
   </para>
   <para>
     実行中のホストでボリュームの追加や削除ができますが、変更を検出するには、SCSIターゲットを再スキャンし、ホストでマルチパス処理を再設定する必要がある場合があります。
   </para>
  </sect2>

  <sect2 xml:id="sec-multipath-planning-raid">
    <title>ソフトウェアRAIDと複雑なストレージスタック</title>
    <para>
      マルチパス処理は、SCSIデバイスなどの基本的なストレージデバイスの上にセットアップされます。マルチレイヤのストレージスタックでは、マルチパス処理は常に最下位レイヤです。ソフトウェアRAID、論理ボリューム管理、ブロックデバイスの暗号化などのその他のレイヤは、マルチパス処理の上に重ねられます。したがって、複数のI/Oパスを持ち、ソフトウェアRAIDで使用予定の各デバイスは、まず、マルチパス処理用に設定してから、ソフトウェアRAIDデバイスとして作成する必要があります。
   </para>
   <para>
    既存のソフトウェアRAID用のマルチパス処理の設定については、<xref linkend="sec-multipath-raid" xrefstyle="SectTitleOnPage"/>を参照してください。
   </para>
  </sect2>

  <sect2 xml:id="sec-multipath-planning-ha">
   <title>高可用性ソリューション</title>
   <para>
    ストレージリソースのクラスタリング用の高可用性ソリューションは、各ノード上でマルチパス処理サービスをベースとして実行されます。各ノード上の<filename>/etc/multipath.conf</filename>ファイル内の構成設定が、クラスタ全体で同一であるようにしてください。
   </para>
   <para>
    マルチパスデバイスがすべてのデバイス間で同じ名前であるようにしてください。詳細については、<xref linkend="sec-multipath-names-ha"/>を参照してください。
   </para>
   <para>
    LAN上のデバイスをミラーリングするDRBD (Distributed Replicated Block Device)高可用性ソリューションは、マルチパス処理をベースとして実行されます。複数のI/Oパスを持ち、DRDBソリューションで使用予定のデバイスごとに、マルチパス処理用デバイスを設定してから、DRBDを設定する必要があります。
   </para>
   <para>
     <command>pacemaker</command>と<command>sbd</command>などフェンシングに共有ストレージを使用するクラスタリングソフトウェアと共にマルチパス処理を使用する場合、特別な注意が必要です。詳細については<xref linkend="sec-multipath-policies-default"/>を参照してください。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-multipath-mpiotools">
  <title>マルチパス管理ツール</title>

  <para>
   <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>のマルチパス処理のサポートは、Linuxカーネルのデバイスマッパーマルチパスモジュールと<systemitem>multipath-tools</systemitem>ユーザスペースパッケージに基づいています。MDADM (Multiple Devices Administration)ユーティリティ(<command>multipath</command>)を使用すると、マルチパスデバイスの状態を表示できます。
  </para>

  <sect2 xml:id="sec-multipath-mpiotools-dm">
   <title>デバイスマッパーマルチパスモジュール</title>
   <para>
    デバイスマッパーマルチパス(DM-MP)モジュールは、Linuxに一般的なマルチパス処理機能を提供します。DM-MPIOは、SCSIデバイスおよびDASDデバイスに対して<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>でマルチパス処理を行う際に推奨されるソリューションであり、NVMeデバイスにも使用できます。 
   </para>
   <note>
     <title>NVMeデバイスに対してDM-MPを使用する</title>
     <para>
       <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 15以降、ネイティブNVMeマルチパス処理(<xref linkend="sec-multipath-hardware-implementations"/>を参照)がNVMeに対して推奨されており、デフォルトで使用されます。ネイティブのNVMeマルチパス処理を無効にして、デバイスマッパーマルチパスで代用するには、カーネルパラメータの<literal>nvme-core.multipath=0</literal>を指定してブートします。
     </para>
   </note>
   <para>
    DM-MPIOは、多様なセットアップでマルチパス処理サブシステムを自動設定します。
   </para>
   <para>
    マルチパスデーモンの<command>multipathd</command>により、自動的なパス検出とグループ化のほか、自動的なパス再テストが実行されるので、障害が発生したパスは、正常に戻ると自動的に復帰します。これにより、管理者の手間を最低限に抑えることができます。
   </para>
   <para>
    DM-MPIOは、デバイス自体の障害ではなく、デバイスへのパスの障害からシステムを保護します。アクティブなパスの1つが失われると(たとえば、ネットワークアダプタが破損する、光ファイバケーブルが外れるなど)、残りのパスにI/Oをリダイレクトします。すべての有効なパスで障害が発生すると、無効なセカンダリパスを有効にする必要があるため、ストレージアレイのプロパティに応じて最長30秒の遅延の後にフェールオーバーが行われます。
   </para>
   <para>
    指定デバイスへのすべてのパスで障害が発生すると、カーネルではこのデバイスとのI/Oを指定時間または無期限でキューに格納できます(無期限の場合、キューに格納するIOの総数はシステムメモリで制限されます)。
   </para>
   <para>
    ディスクアレイに複数のストレージプロセッサがある場合は、アクセスしたいLUNを所有するストレージプロセッサにSANスイッチが接続していることを必ず確認してください。ほとんどのディスクアレイでは、すべてのLUNが両方のストレージプロセッサに属しているので、両方の接続がアクティブです。
   </para>
   <note>
    <title>ストレージプロセッサ</title>
    <para>
     一部のディスクアレイでは、ストレージアレイがストレージプロセッサを介してトラフィックを管理するので、一度に1つのストレージプロセッサだけが提示されます。1つのプロセッサがアクティブとなり、もう1つのプロセッサは障害が発生するまでパッシブとなります。間違ったストレージプロセッサ(パッシブなパスをもつプロセッサ)に接続している場合は、予期されたLUNが表示されなかったり、それらのLUNが表示されてもアクセスしようとするとエラーが発生することがあります。
    </para>
   </note>
  </sect2>

  <sect2 xml:id="sec-multipath-mpiotools-io-management">
   <title>マルチパスI/O管理ツール</title>
   <para>
    パッケージ<systemitem class="resource">multipath-tools</systemitem>および<systemitem class="resource">kpartx</systemitem>では、自動パス検出とグループ化を扱うツールが提供されています。
   </para>
   <variablelist>
     <varlistentry>
       <term>
	 <command>multipathd</command>
       </term>
       <listitem>
	 <para>
	   マルチパスマップをセットアップして監視するデーモン、およびデーモンプロセスと通信するコマンドラインクライアント。<xref linkend="sec-multipath-mpiotools-multipathd" xrefstyle="SectTitleOnPage"/>を参照してください。
	 </para>
       </listitem>
     </varlistentry>
     <varlistentry>
       <term>
	 <command>multipath</command>
       </term>
       <listitem>
	 <para>
	   マルチパスオペレーション用のコマンドラインツール。<xref linkend="sec-multipath-mpiotools-multipath" xrefstyle="SectTitleOnPage"/>を参照してください。
	 </para>
       </listitem>
     </varlistentry>
     <varlistentry>
       <term>
	 <command>kpartx</command>
       </term>
       <listitem>
	 <para>
	   マルチパスデバイスの「パーティション」を管理するためのコマンドラインツール。<xref linkend="sec-multipath-configuration-partitioning" xrefstyle="SectTitleOnPage"/>を参照してください。
	 </para>
       </listitem>
     </varlistentry>
     <varlistentry>
       <term>
	 <command>mpathpersist</command>
       </term>
       <listitem>
	 <para>
	   SCSIの永続的な予約を管理するためのコマンドラインツール。<xref linkend="sec-multipath-mpiotools-mpathpersist" xrefstyle="SectTitleOnPage"/>を参照してください。
	 </para>
       </listitem>
     </varlistentry>
     <varlistentry>
       <term>
       </term>
       <listitem>
	 <para>
	 </para>
       </listitem>
     </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec-multipath-mpiotools-mdadm">
   <title>マルチパスデバイスのMD RAID</title>
   <para>
     マルチパス処理の上部でMD RAIDアレイは、システムのudevルールによって自動的にセットアップされます。<filename>/etc/mdadm.conf</filename>の特別な設定は不要です。
   </para>
  </sect2>

  <sect2 xml:id="sec-multipath-mpiotools-multipathd">
    <title><command>multipathd</command>デーモンおよび<command>multipath</command>コマンド</title>
    <para>
      <command>multipathd</command>は、最新Linuxデバイスマッパーのマルチパスにおけるセットアップの最重要部分です。これは通常、systemdサービス<filename>multipathd.service</filename>を通じて開始されます。<filename>multipathd.socket</filename>を介したソケットのアクティブ化はサポートされていますが、マルチパスハードウェアを備えたシステムで<filename>multipathd.service</filename>を有効にすることを<emphasis>強くお勧め</emphasis>します。
    </para>
    <para>
      <command>multipathd</command>は次のタスクを実行します(設定によって異なるものもあります)。
    </para>
      <itemizedlist>
	<listitem>
	  <para>
	    起動時、パスデバイスを検出し、検出したデバイスからマルチパスマップをセットアップします。
	  </para>
	</listitem>
	<listitem>
	  <para>
	    ueventおよびデバイスマッパーイベントを監視し、必要に応じてマルチパスマップでパスマッピングの追加や削除を行い、フェールオーバー操作またはフェールバック操作を開始します。
	  </para>
	</listitem>
	<listitem>
	  <para>
	    新しいパスデバイスが検出されるとすぐに新しいマップをセットアップします。
	  </para>
	</listitem>
	<listitem>
	  <para>
	    一定の間隔でパスデバイスをチェックして障害を検出し、障害が発生したパスをテストして正常に戻った場合には復帰させます。
	  </para>
	</listitem>
	<listitem>
	  <para>
	    すべてのパスで障害が発生した場合、<command>multipathd</command>はそのマップを無効にするか、またはマップデバイスを指定時間でキュー待ちモードに切り替えます。
	  </para>
	</listitem>
	<listitem>
	  <para>
	    パス状態の変更を処理し、必要に応じてパスグループの切り替えまたはパスの再グループ化を行います。
	  </para>
	</listitem>
	<listitem>
	  <para>
	    パスをテストし、「ぎりぎりの」状態(つまり、パスの状態が正常と異常の間で切り替わる不安定な状態)かどうかを確認します。
	  </para>
	</listitem>
	<listitem>
	  <para>
	    設定されている場合、パスデバイスでSCSIの永続的な予約キーを処理します。<xref linkend="sec-multipath-mpiotools-mpathpersist" xrefstyle="SectTitleOnPage"/>を参照してください。
	  </para>
	</listitem>
      </itemizedlist>
    
    <para>
      <command>multipathd</command>では、コマンドラインのクライアントとしても動作し、インタラクティブコマンドを実行デーモンに送信することでコマンドを処理します。デーモンにコマンドを送信する一般的な構文は次のとおりです。
      </para>
      <screen>multipathd <replaceable>COMMAND</replaceable></screen>
      <para>
      あるいは、
      </para>
      <screen>multipathd -k"<replaceable>COMMAND</replaceable>"</screen>
     <para>
       デーモンでインタラクティブモードにするには、次のコマンドを実行します。
      </para>
      <screen>multipathd -k</screen>
      <note>
	<title>multipathとmultipathdを同時動作させる方法</title>
	<para>
	  <command>multipathd</command>のコマンドには<command>multipath</command>のコマンドと同等のものが多数あります。たとえば、<command>multipathd show topology</command>の動作は<command>multipath -ll</command>の動作と同じです。重要な差異は、multipathdのコマンドでは実行中の<command>multipathd</command>デーモンの内部状態を問い合わせるのに対して、multipathではカーネルおよびI/O操作から情報を直接取得することです。
	</para>
	<para>
	  マルチパスデーモンが実行中の場合、<command>multipathd</command>のコマンドを使用してシステムを変更することをお勧めします。このようにしないと、デーモンが設定変更に気付き、変更に反応する場合があります。場合によっては、適用された変更をデーモンで元に戻そうとします。したがって、<command>multipath</command>は、実行中のデーモンが検出されると、マップの破棄やフラッシュなど危険性のあるコマンドを<command>multipathd</command>に自動的に委任します。
	</para>
      </note>
   <para>下記のリストでは、使用頻度が高い<command>multipathd</command>コマンドについて説明します。</para>
   <variablelist>
    <varlistentry>
     <term>show topology</term>
     <listitem>
      <para>
	現在のマップトポロジおよびプロパティを表示します。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>show paths</term>
     <listitem>
      <para>
	現在既知のパスデバイスを表示します。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>show paths format &quot;<replaceable>FORMAT STRING</replaceable>&quot;</term>
     <listitem>
      <para>
	フォーマット文字列を使用して現在既知のパスデバイスを表示します。サポートされているフォーマット指定子のリストを表示するには、<command>show wildcards</command>を使用します。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>show maps</term>
     <listitem>
      <para>
	現在設定されているマップデバイスを表示します。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>show maps format <replaceable>FORMAT STRING</replaceable></term>
     <listitem>
      <para>
	フォーマット文字列を使用して、現在設定されているマップデバイスを表示します。サポートされているフォーマット指定子のリストを表示するには、<command>show wildcards</command>を使用します。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>show config local</term>
     <listitem>
      <para>
	multipathdが使用している現在の設定を表示します。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>reconfigure</term>
     <listitem>
      <para>
	設定ファイルを再度読み込み、デバイスを再スキャンし、マップを再度セットアップします。これは<command>multipathd</command>の再起動と基本的に同じです。いくつかのオプションは再起動しないと変更できません。これらについてはマニュアルページの<systemitem>multipath.conf(5)</systemitem>で説明します。<option>reconfigure</option>コマンドを実行すると、何らかの方法で変更されたマップデバイスのみが再ロードされます。すべてのマップデバイスを強制的に再ロードするには、<command>reconfigure all</command>を使用します。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>del map <replaceable>MAP DEVICE NAME</replaceable></term>
     <listitem>
      <para>
	指定のマップデバイスおよびそのパーティションを設定解除して削除します。<replaceable>MAP DEVICE NAME</replaceable>には、<filename>dm-0</filename>などのデバイスノード名、WWID、またはマップ名を使用できます。このコマンドは、デバイスを使用中には失敗します。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <para>
     パスの状態の変更、キューの有効化または無効化などを実行できるコマンドもあります。詳細については<systemitem>multipathd(8)</systemitem>を参照してください。
   </para>
  </sect2>
  <sect2 xml:id="sec-multipath-mpiotools-multipath">
   <title>multipathコマンド</title>
   <para>
     マルチパスのセットアップはほぼ自動で<command>multipathd</command>によって処理されますが、<command>multipath</command>も依然として一部の管理タスクで有用です。このコマンドの使用例を次に示します。
   </para>
   <variablelist>
    <varlistentry>
     <term>multipath</term>
     <listitem>
      <para>
       パスデバイスを検出し、すべての検出マルチパスマップを設定します。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -d</term>
     <listitem>
      <para>
	<command>multipath</command>に似ていますが、マップをセットアップしません(試行動作)。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath <replaceable>DEVICENAME</replaceable></term>
     <listitem>
      <para>
       特定のマルチパスデバイスを設定します。<replaceable>DEVICENAME</replaceable>は、デバイスノード名(<filename>/dev/sdb</filename>)またはデバイス番号(<literal>major:minor</literal>フォーマット)でメンバーパスデバイスを示すことができます。または、WWIDやマルチパスマップの名前も使用できます。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -f <replaceable>DEVICENAME</replaceable></term>
     <listitem>
      <para>
	マルチパスマップおよびそのパーティションマッピングを設定解除(「フラッシュ」)します。そのパーティションのいずれかまたはマップが使用中の場合、このコマンドは失敗します。<replaceable>DEVICENAME</replaceable>で使用できる値については上記を参照してください。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -F</term>
     <listitem>
      <para>
	すべてのマルチパスマップおよびそのパーティションマッピングを設定解除(「フラッシュ」)します。マップを使用中の場合、このコマンドは失敗します。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -ll</term>
     <listitem>
      <para>
	現在設定されているすべてのマルチパスデバイスのステータスおよびトポロジを表示します。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -ll <replaceable>DEVICENAME</replaceable></term>
     <listitem>
      <para>
       指定されたマルチパスデバイスのステータスを表示します。<replaceable>DEVICENAME</replaceable>で使用できる値については上記を参照してください。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -t</term>
     <listitem>
      <para>
       マルチパスの内部ハードウェアテーブルとアクティブな設定を表示します。設定パラメータの詳細については、<systemitem>multipath.conf(5)</systemitem>を参照してください。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -T</term>
     <listitem>
      <para>
	<command>multipath -t</command>コマンドの機能と似ていますが、ホストで検出されたハンドウェアのハードウェアエントリのみを表示します。
      </para>
     </listitem>
    </varlistentry>
  </variablelist>
  <para>
    <option>-v</option>オプションによって、出力の詳細レベルが制御されます。0(重大なエラー)から4(詳細ロギング)の値を使用できます。デフォルトは<option>-v2</option>です。<filename>/etc/multipath.conf</filename>の<option>verbosity</option>オプションを使用すると、<command>multipath</command>と<command>multipathd</command>の両方でデフォルトの詳細レベルを変更できます。
  </para>
  </sect2>

  <sect2 xml:id="sec-multipath-mpiotools-mpathpersist">
   <title>mpathpersistユーティリティ</title>
   <para>
    <command>mpathpersist</command>ユーティリティを使用して、デバイスマッパーマルチパスのデバイスでSCSIの永続的な予約を管理します。永続的な予約を行うと、SCSIの論理ユニットへのアクセスが特定のSCSIイニシエータに制限されます。マルチパス設定では、指定ボリュームですべてのI_T関連付け(パス)に同じ予約キーを使用することが重要です。そのようにしないと、あるパスで予約を作成すると別のパスで障害が発生する場合があります。
   </para>
   <para>
    このユーティリティを<filename>/etc/multipath.conf</filename>ファイルの<literal>reservation_key</literal>属性と共に使用して、SCSIデバイスの永続的な予約を設定します。このオプションが設定されている場合(のみ)、<command>multipathd</command>デーモンは、新しく検出したパスまたは復帰したパスについて永続的な予約をチェックします。
   </para>
   <para>
    この属性は、<filename>multipath.conf</filename>の<literal>defaults</literal>セクションまたは<literal>multipaths</literal>セクションに追加できます。例:
   </para>
   <screen>multipaths {
    multipath {
        wwid             3600140508dbcf02acb448188d73ec97d
        alias            yellow
        reservation_key  0x123abc
    }
}</screen>
   <para>
    永続的な管理に適用可能なすべてのmpathデバイスに対して<literal>reservation_key</literal>パラメータを設定した後、<command>multipathd reconfigure</command>を使用して設定を再ロードします。
   </para>
   <note>
     <title>
       「<option>reservation_key file</option>」の使用
     </title>
     <para>
       特別な値である<literal>reservation_key file</literal>が<filename>multipath.conf</filename>の<literal>defaults</literal>セクションで使用される場合、<command>mpathpersist</command>を使用して<filename>/etc/multipath/prkeys</filename>ファイルで予約キーを動的に管理できます。
     </para>
     <para>
       これは、マルチパスマップで永続的な予約を処理する際のお勧めの方法です。この方法は<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 12 SP4から使用できます。
     </para>
   </note>
   <para>
    <command>mpathpersist</command>コマンドを使用して、SCSIデバイスで構成されているマルチパスマップの永続的な予約を問い合わせて設定します。詳細については、<systemitem>mpathpersist(8)</systemitem>のマニュアルページを参照してください。このコマンドラインオプションは、<systemitem>sg3_utils</systemitem>パッケージの<command>sg_persist</command>のオプションと同じです。<systemitem>sg_persist(8)</systemitem>のマニュアルページでは、このオプションの意味を詳細に説明しています。
   </para>
  
   <para>
     次の例では、<replaceable>DEVICE</replaceable>は<filename>/dev/mapper/mpatha</filename>など、デバイスマッパーのマルチパスデバイスを示しています。下記のコマンドは、読みやすくするために長いオプションと共にリストしています。すべてのオプションには、<command>mpathpersist -oGS 123abc <replaceable>DEVICE</replaceable></command>のように1文字の置換文字が含まれています。
   </para>
   <variablelist>
    <varlistentry>
     <term>mpathpersist --in --read-keys <replaceable>DEVICE</replaceable></term>
     <listitem>
      <para>
       デバイスに登録されている予約キーを読み取ります。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>mpathpersist --in --read-reservation <replaceable>DEVICE</replaceable></term>
     <listitem>
      <para>
       デバイスの既存の予約を表示します。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>mpathpersist --out --register --param-sark=123abc <replaceable>DEVICE</replaceable></term>
     <listitem>
      <para>
       デバイスの予約キーを登録します。これにより、ホストですべてのI_T関連付け(パスデバイス)の予約キーが追加されます。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>mpathpersist --out --reserve --param-rk=123abc --prout-type=5 <replaceable>DEVICE</replaceable></term>
     <listitem>
      <para>
       以前登録したキーを使用して、デバイスのタイプ5(登録者のみの排他書き込み)の予約を作成します。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>mpathpersist --out --release --param-rk=123abc --prout-type=5 <replaceable>DEVICE</replaceable></term>
     <listitem>
      <para>
       デバイスのタイプ5の予約を解放します。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>mpathpersist --out --register-ignore --param-sark=0 <replaceable>DEVICE</replaceable></term>
     <listitem>
       <para>
	 以前存在していた予約キーをデバイスから削除します。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-multipath-config">
  <title>マルチパス処理用システムの設定</title>

  <para/>

  <sect2 xml:id="sec-multipath-configuration-start">
   <title>マルチパスサービスの有効化、起動、および停止</title>
   <para>
    マルチパスサービスを有効にしてブート時に起動するには、次のコマンドを実行します。
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl enable multipathd</screen>
   <para>
    実行中のシステムでサービスを手動で開始するには、次のように入力します。
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl start multipathd</screen>
   <para>
    サービスを再開するには、次のように入力します。
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl restart multipathd</screen>
   <para>
    ほとんどの状況で、サービスの再開は不要です。単に<command>multipathd</command>に設定を再ロードさせるには、次のコマンドを実行します。
   </para>
   <screen><prompt>&gt; </prompt><command>sudo</command> systemctl reload multipathd</screen>
   <para>
    サービスのステータスを確認するには、次のように入力します。
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl status multipathd</screen>
   <para>
    現行セッションのマルチパスサービスを停止するには、次のコマンドを実行します。
   </para>
   <screen>
<prompt>&gt; </prompt><command>sudo</command> systemctl stop multipathd
<prompt>&gt; </prompt><command>sudo</command> systemctl stop multipathd.socket
   </screen>
   <warning xml:id="ann-multipath-configuration-disable">
    <title>multipathdの無効化</title>
    <para>
      <filename>multipathd.service</filename>は常に有効にしておき、マルチパスハードウェアにアクセスできるすべてのホストで実行することを強くお勧めします。ただし、マルチパスハードウェアが撤去されたり、別のマルチパス処理ソフトウェアが導入されたため、またはトラブルシューティングの目的で、サービスを無効にする必要が生じる場合があります。
    </para>
     <para>
       <emphasis>1回のシステムブートに対してのみ</emphasis>マルチパス処理を無効にするには、カーネルパラメータの<literal>multipath=off</literal>を使用します。これは、ブートシステムと初期のramfsの両方に影響します。この場合、ramfsを再構築する必要はありません。
     </para>
     <para>
      multipathdサービスを<emphasis>恒久的に</emphasis>無効にして、今後のシステムブートでこのサービスが開始されないようにするには、次のコマンドを実行します。
     </para>
    <screen><prompt>&gt; </prompt><command>sudo</command> systemctl disable multipathd
<prompt>&gt; </prompt><command>sudo</command> systemctl disable multipathd.socket
<prompt>&gt; </prompt><command>sudo</command> dracut --force --omit multipath
</screen>
    <para>
      (マルチパスサービスを無効または有効にするときには必ず<systemitem>initrd</systemitem>を再構築してください。詳細については、<xref linkend="sec-multipath-initrd-sync" xrefstyle="SectTitleOnPage"/>を参照してください。)
    </para>
    <para>
     (オプション)さらに、<command>multipath</command>を手動で実行するときにもマルチパスデバイスが設定されないようにする場合は、initrdを再構築する前に、<filename>/etc/multipath.conf</filename>の最後に次の行を追加します。
    </para>
<screen>blacklist {
    wwid .*
}</screen>
   </warning>
  </sect2>

  <sect2 xml:id="sec-multipath-configuration-sandevs">
   <title>マルチパス処理用SANデバイスの準備</title>
   <para>
    SANデバイスのマルチパスI/Oを設定する前に、必要に応じて、次のようにSANデバイスを準備してください。
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      ベンダのツールで、SANデバイスを設定し、ゾーン化します。
     </para>
    </listitem>
    <listitem>
     <para>
      ベンダのツールで、ストレージアレイ上のホストLUNのパーミッションを設定します。
     </para>
    </listitem>
    <listitem>
     <para>
       <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>でホストバスアダプタ(HBA)用ドライバが同梱されていない場合、HBAベンダからLinuxドライバをインストールします。詳細については、ベンダの特定マニュアルを参照してください。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    マルチパスデバイスが検出され、<filename>multipathd.service</filename>が有効になっている場合、マルチパスマップは自動的に作成されます。作成されない場合、<command>lsscsi</command>などのコマンドを使用して下位レベルデバイスを確認してください。また、<command>journalctl -b</command>でシステムログを調査してください。LUNがHBAドライバによって認識されない場合は、SANのゾーン化セットアップをチェックします。特に、LUNのマスキングがアクティブであるかどうか、LUNがサーバに正しく割り当てられているかどうかをチェックしてください。
   </para>
   <para>
    LUNがHBAドライバによって認識できるが、対応するブロックデバイスが作成されない場合は、追加のカーネルパラメータが必要な場合があります。SUSEナレッジベース(<link xlink:href="https://www.suse.com/support/kb/doc.php?id=3955167"/>)で「<citetitle>TID 3955167: Troubleshooting SCSI (LUN) Scanning Issues</citetitle>」を参照してください。
   </para>
  </sect2>

  <sect2 xml:id="sec-multipath-configuration-partitioning">
    <title>マルチパスデバイスのパーティション</title>
    <para>
      マルチパスマップには、そのパスデバイスのようなパーティションを設けることができます。パーティションテーブルのスキャンおよびパーティションのデバイスノード作成は、ユーザスペースで<command>kpartx</command>ツールによって実行されます。<command>kpartx</command>は、udevルールによって自動的に起動します。通常、手動での実行は不要です。技術的には、kpartxによって作成される「パーティション」デバイスは、親デバイスからのブロックの線形範囲をマップするだけのデバイスマッパーのデバイスでもあります。既知のWWIDを持つマルチパスデバイスで<replaceable>N</replaceable>番目のパーティションには、<filename>/dev/disk/by-id/dm-uuid-part<replaceable>N</replaceable>-mpath-<replaceable>WWID</replaceable></filename>を介して安定的にアクセスできます。
    </para>
    <note>
      <title><command>kpartx</command>の起動の無効化</title>
      <para>
	<filename>/etc/multipath.conf</filename>の<literal>skip_kpartx</literal>オプションを使用して、選択したマルチパスマップでの<command>kpartx</command>の起動を無効にできます。たとえば、これは仮想化ホストで有用である場合があります。
      </para>
    </note>
    <para>
      マルチパスデバイスのパーティションテーブルおよびパーティションは、YaSTまたは<command>fdisk</command>や<command>parted</command>のようなツールを使用して普通に操作できます。パーティションテーブルに適用する変更は、パーティション処理ツールが終了するとシステムによって記録されます。これが動作しない場合(デバイスがビジーであることが原因であることが多い)、<command>multipathd reconfigure</command>を試すか、またはシステムを再起動してください。
    </para>
    <para>
      パーティション化されたマルチパスデバイスはそれ以外の方法では使用できません。たとえば、パーティション化されたデバイスからLVM物理ボリュームは作成できません。これを実行する前にパーティションテーブルを消去する必要があります。
    </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-multipath-conf-file">
  <title>マルチパス設定</title>

  <para>
    組み込みの<systemitem>multipath-tools</systemitem>は、ほとんどのセットアップでデフォルトで正しく動作します。カスタマイズが必要な場合、設定ファイルを作成する必要があります。主要設定ファイルは<filename>/etc/multipath.conf</filename>です。また、<filename>/etc/multipath/conf.d/*.conf</filename>のパターンと一致するファイルはアルファベット順に読み込まれます。優先されるルールについては、<xref linkend="sec-multipath-conf-file-syntax" xrefstyle="SectTitleOnPage"/>を参照してください。
  </para>
  <note>
    <title>
      生成される設定ファイル
    </title>
    <para>
      <filename>/etc/multipath/wwids</filename>、<filename>/etc/multipath/bindings</filename>、および<filename>/etc/multipath/prkeys</filename>のファイルは<systemitem>multipath-tools</systemitem>によって管理され、前に作成されたマルチパスマップ、マップ名、およびSCSIの永続的な予約の予約キーに関して永続的な情報をそれぞれ格納します。これらの生成された設定ファイルは編集しないでください。
      
    </para>
  </note>
  <note>
    <title>設定可能なパス</title>
    <para>
      <filename>/etc/multipath.conf</filename>を除いて、設定ディレクトリおよびファイルのパスは設定可能ですが、これらのパスを変更しないことを強くお勧めします。
    </para>
  </note>

  <sect2 xml:id="sec-multipath-conf-file-create">
    <title>/etc/multipath.confファイルの作成</title>
   <para>
     組み込みのデフォルトテンプレートから<filename>multipath.conf</filename>テンプレートを生成できます。これを行うことによってすべてのデフォルト設定が明示的になります。生成されたファイルを変更しない限り<systemitem>multipath-tools</systemitem>の動作は変わりません。設定テンプレートを生成するには、次のコマンドを実行します。
   </para>
   <screen>multipath -T &gt;/etc/multipath.conf</screen>
   <para>
     または、変更する設定のみを含む最低限の<filename>/etc/multipath.conf</filename>を作成できます。この動作は、生成されたテンプレートの該当行のみを変更する操作と同じです。
   </para>
  </sect2>

  <sect2 xml:id="sec-multipath-conf-file-syntax">
    <title>multipath.confの構文</title>
    <para>
      <filename>/etc/multipath.conf</filename>ファイルでは、セクション、サブセクション、および属性/値のペアで階層を使用します。
    </para>
    <itemizedlist>
      <listitem>
	<para>
	  空白によってトークンが分離されます。連続する空白文字は、引用符で囲まれていない限り1つの空白に圧縮されます(下記参照)。
	</para>
      </listitem>
      <listitem>
	<para>
	  ハッシュ(<literal>#</literal>)および感嘆符(<literal>! </literal>)文字を使用すると、残りの行はコメントとして無視されます。
	</para>
      </listitem>
      <listitem>
	<para>
	  セクションとサブセクションは、同じ行の開き中かっこ(<literal>{</literal>)で始まり、その行の閉じ中かっこ(<literal>}</literal>)で終わります。
	</para>
      </listitem>
      <listitem>
	<para>
	  属性および値は1行に書き込まれます。行の継続はサポートされていません。
	</para>
      </listitem>
      <listitem>
	<para>
	  属性とセクション名はキーワードにする必要があります。使用できるキーワードについては、<systemitem>multipath.conf(5)</systemitem>を参照してください。
	</para>
      </listitem>
      <listitem>
	<para>
	  値は二重引用符(<literal>&quot;</literal>)で囲むことができます。値に空白またはコメント文字が含まれている場合、その値を引用符で囲む必要があります。値の内側にある二重引用符文字は二重引用符のペア(<literal>&quot;&quot;</literal>)で表されます。
	</para>
      </listitem>
      <listitem>
	<para>
	  一部の属性の値はPOSIXの正規表現です(<systemitem>regex(7)</systemitem>を参照)。これらは大文字と小文字が区別され、固定されないため、“<literal>bar</literal>”と“<literal>rhabarber</literal>”は一致します。
	</para>
      </listitem>
    </itemizedlist>
    <bridgehead>構文の例</bridgehead>
    <screen>
section {
    subsection {
        attr1 value
	   attr2      "complex value!"
	attr3    "value with ""quoted"" word"
    } ! subsection end
} # section end
    </screen>
    <bridgehead>優先ルール</bridgehead>
    <para>
      <xref linkend="sec-multipath-conf-file" xrefstyle="HeadingOnPage"/>の最初に記述されているとおり、複数の設定ファイルを備えることができます。追加のファイルは<filename>/etc/multipath.conf</filename>と同じ構文ルールに従います。セクションと属性は複数回使用できます。同じ属性が複数のファイルで設定されたり、同じファイルの複数の行で設定されると、最後に読み取られた値が優先されます。
    </para>
  </sect2>
  <sect2 xml:id="sec-multipath-conf-file-sections">
   <title><filename>/etc/multipath.conf</filename>のセクション</title>
   <para>
    <filename>/etc/multipath.conf</filename>ファイルは、以下のセクションで構成されています。一部の属性は複数のセクションで使用できます。詳細については<systemitem>multipath.conf(5)</systemitem>を参照してください。
   </para>
   <variablelist>
    <varlistentry>
     <term>defaults</term>
     <listitem>
      <para>
       一般的なデフォルト設定。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>blacklist</term>
     <listitem>
      <para>
       無視するデバイスをリストします。<xref linkend="sec-multipath-blacklist" xrefstyle="HeadingOnPage"/>を参照してください。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>blacklist_exceptions</term>
     <listitem>
      <para>
       マルチパス処理されるデバイスをリストします(ブラックリストに含まれている場合もリストされます)。<xref linkend="sec-multipath-blacklist" xrefstyle="HeadingOnPage"/>を参照してください。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>devices</term>
     <listitem>
      <para>
	ストレージコントローラ専用の設定。このセクションは<literal>デバイス</literal>サブセクションのコレクションです。このセクションの値は、<filename>defaults</filename>セクションの同じ属性の値を上書きします。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipaths</term>
     <listitem>
      <para>
	個々のマルチパスデバイスの設定。このセクションは<literal>マルチパス</literal>サブセクションのリストです。値は<literal>defaults</literal>セクションと<literal>devices</literal>セクションを上書きします。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>上書き</term>
     <listitem>
       <para>
	 他のすべてのセクションの値を上書きする設定。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec-multipath-conf-file-apply">
   <title><filename>/etc/multipath.conf</filename>の変更の適用</title>
   <para>
     設定変更を適用するには、次のコマンドを実行します。
   </para>
   <screen><prompt>&gt; </prompt><command>sudo</command> multipathd reconfigure</screen>
   <para>
     忘れずにinitrdの設定と同期してください。<xref linkend="sec-multipath-initrd-sync" xrefstyle="SectTitleOnPage"/>を参照してください。
   </para>
   <warning>
     <title><command>multipath</command>を使用して設定を適用しない</title>
     <para>
       <command>multipathd</command>を実行中に<command>multipath</command>コマンドを使用して新しい設定を適用しないでください。これを行うと、セットアップの整合性が失われ、セットアップが破損する場合があります。
     </para>
   </warning>
   <note xml:id="sec-multipath-conf-file-verify">
     <title>変更したセットアップの確認</title>
     <para>
       変更した設定を適用する前にテストできます。そのためには次のコマンドを実行します。
     </para>
     <screen>multipath -d -v2</screen>
     <para>
       このコマンドを実行すると、指定したトポロジを使用して作成される新しいマップが表示されます。ただし、マップの削除やフラッシュが実行されるかどうかはこのコマンドで示されません。さらに詳細を取得するには、次のコマンドを実行します。
     </para>
     <screen>multipath -d -v3 2&gt;&amp;1 | less</screen>
   </note>
  </sect2>

  <sect2 xml:id="sec-multipath-conf-file-wwid">
   <title>WWIDの生成</title>
   <para>
    異なるパス上のデバイスを識別するため、マルチパスは、各デバイスに対してWorld Wide Identification (WWID)を使用します。2つのデバイスパスのWWIDが同じである場合、それらは同じデバイスを表すものと想定されます。やむを得ない理由がある場合を除き、WWIDの生成方法を変更しないことをお勧めします。詳細については、<command>man multipath.conf</command>を参照してください。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-multipath-policies-default">
  <title>ポーリング、待ち行列、およびフェールバック用のポリシーの設定</title>

  <para>
   このセクションでは、耐障害性を実現するために最も重要な<systemitem>multipath-tools</systemitem>設定パラメータについて説明します。
  </para>
  <variablelist>
    <varlistentry>
      <term>polling_interval</term>
      <listitem>
	<para>
	  パスデバイスの正常性チェック間の間隔(秒単位)。デフォルトは5秒です。障害が発生したデバイスはこの間隔でチェックされます。デバイスが正常な場合、この間隔を最長<literal>max_polling_interval</literal>秒まで長くすることができます。
	</para>
      </listitem>
    </varlistentry>
    <varlistentry>
     <term>no_path_retry</term>
     <listitem>
       <para>
	 指定マルチパスマップのすべてのパスで障害が発生した場合やパスが存在しなくなった場合における処理を決定します。次の値を使用できます。
       </para>
       <variablelist>
	 <varlistentry>
	   <term>fail</term>
	   <listitem>
	     <para>
	       マルチパスマップのI/Oは失敗します。そのため、マウントされたファイルシステムなどの上位レイヤでI/Oエラーが発生します。影響を受けるファイルシステム、および場合によってはホスト全体がディグレードモードになります。
	     </para>
	   </listitem>
	 </varlistentry>
	 <varlistentry>
	   <term>queue</term>
	   <listitem>
	     <para>
	       マルチパスマップのI/Oがデバイスマッパーレイヤのキューに入り、パスデバイスを再度使用できるようになると、そのデバイスに送信されます。これは、データ損失を回避するための最も安全なオプションですが、パスデバイスが長時間復帰しないと悪影響を被る可能性があります。デバイスからの読み取りプロセスは中断できないスリープ(<literal>D</literal>)状態でハングします。キューに格納されたデータでメモリが一杯になり、処理できなくなります。最終的にメモリが枯渇します。
	     </para>
	   </listitem>
	 </varlistentry>
	 <varlistentry>
	   <term><replaceable>N</replaceable></term>
	   <listitem>
	     <para>
	       <replaceable>N</replaceable>は正の整数です。<replaceable>N</replaceable>秒のポーリング間隔でマップデバイスをキューモードのままにします。この時間が経過すると、マップデバイスの<command>multipathd</command>は失敗します。<literal>polling_interval</literal>が5秒で<literal>no_path_retry</literal>が6の場合、<command>multipathd</command>はI/Oをキューに約30秒間(5秒X6)格納し、時間が経過するとそのマップデバイスのI/Oは失敗します。タイムアウト値を注意深く選択すると、多くの場合、<literal>障害</literal>と<literal>キュー</literal>の間の良い折衷点になります。
	     </para>
	   </listitem>
	 </varlistentry>
       </variablelist>
     </listitem>
    </varlistentry>
  </variablelist>
  <para>
   マルチパスI/Oの最終目標は、ストレージシステムとサーバ間のコネクティビティ耐障害性を提供することです。望ましいデフォルトの動作は、サーバがスタンダロンのサーバか、高可用性クラスタ内のノードかによって異なります。
  </para>

  <para>
   スタンドアロンサーバに対してマルチパスI/Oを構成する際は、<literal>no_path_retry</literal>の設定により、サーバのオペレーティングシステムを、I/Oエラーの受信から可能な限り保護することができます。この設定により、メッセージはマルチパスのフェールオーバーが発生するまで待ち行列に入れられ、正常な接続が保たれます。
  </para>

  <para>
   高可用性クラスタ内のノードに対してマルチパスI/Oを構成するときには、マルチパスでリソースのフェールオーバーをトリガするためにI/O障害が報告されるようにして、マルチパスのフェールオーバーが解決されるのを待たなくて済むようにするとよいでしょう。クラスタ環境では、<literal>no_path_retry</literal>設定を、ストレージシステムへの接続が失われた場合に、クラスタノードがクラスタ検証プロセスに関連するI/Oエラー(ハートビート許容値の50%を推奨)を受信するように変更する必要があります。また、パスの障害によるリソースのピンポンを避けるため、マルチパスI/Oのフェールバックをマニュアルに設定するとよいでしょう。
  </para>

  <para>
   <filename>/etc/multipath.conf</filename>ファイルには、ポーリング、待ち行列、およびフェールバックのデフォルト動作を指定できる<command>defaults</command>セクションが含まれています。<command>device</command>セクションで、フィールドが別途指定されていない場合は、そのSAN構成にデフォルト設定が適用されます。
  </para>

  <para>
   デフォルト設定では、以下のようにコンパイルされています。パーソナライズした<filename>/etc/multipath.conf</filename>ファイルを作成して構成することでこれらの値を上書きしない限り、この設定が使用されます。
  </para>

<screen>defaults {
  verbosity 2
#  udev_dir is deprecated in SLES 11 SP3
#  udev_dir              /dev
  polling_interval      5
#  path_selector default value is service-time in SLES 11 SP3
#  path_selector         "round-robin 0"
  path selector         "service-time 0"
  path_grouping_policy  failover
#  getuid_callout is deprecated in SLES 11 SP3 and replaced with uid_attribute
#  getuid_callout        "/usr/lib/udev/scsi_id --whitelisted --device=/dev/%n"
#  uid_attribute is new in SLES 11 SP3
  uid_attribute         "ID_SERIAL"
  prio                  "const"
  prio_args             ""
  features              "0"
  path_checker          "tur"
  alias_prefix          "mpath"
  rr_min_io_rq          1
  max_fds               "max"
  rr_weight             "uniform"
  queue_without_daemon  "yes"
  flush_on_last_del     "no"
  user_friendly_names   "no"
  fast_io_fail_tmo      5
  bindings_file         "/etc/multipath/bindings"
  wwids_file            "/etc/multipath/wwids"
  log_checker_err       "always"

  retain_attached_hw_handler  "no"
  detect_prio           "no"
  failback              "manual"
  no_path_retry         "fail"
  }</screen>

  <para>
   ポーリング、待ち行列、およびフェールバックの詳細については、<xref linkend="sec-multipath-policies-failover" xrefstyle="SectTitleOnPage"/>に記載のパラメータを参照してください。
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     <xref linkend="vle-polling-interval" xrefstyle="HeadingOnPage"/>
    </para>
   </listitem>
   <listitem>
    <para>
     <xref linkend="vle-no-path-retry" xrefstyle="HeadingOnPage"/>
    </para>
   </listitem>
   <listitem>
    <para>
     <xref linkend="vle-failback" xrefstyle="HeadingOnPage"/>
    </para>
   </listitem>
  </itemizedlist>

  <para>
   <filename>/etc/multipath.conf</filename>ファイルの変更後、<command>dracut</command> <option>-f</option>を実行してシステム上に<filename>initrd</filename>を再作成してから、サーバを再起動して変更内容を有効にする必要があります。詳細については<xref linkend="sec-multipath-conf-file-apply"/>を参照してください。
  </para>
 </sect1>
 <sect1 xml:id="sec-multipath-blacklist">
  <title>非マルチパスデバイスのブラックリスト化</title>

  <para>
   <filename>/etc/multipath.conf</filename>ファイルに<command>blacklist</command>セクションを含め、すべての非マルチパスデバイスを一覧にできます。WWID (<literal>wwid</literal>キーワード)、デバイス名(<literal>devnode</literal>キーワード)、またはデバイスタイプ(<literal>device</literal>セクション)を使用してデバイスをブラックリスト化できます。<literal>blacklist_exceptions</literal>セクションを使って、<literal>blacklist</literal>セクションで使用している正規表現によってブラックリスト化された特定のデバイスに対してマルチパスを有効にすることもできます。
  </para>

  <note>
   <title>推奨するブラックリスト化方法</title>
   <para>
    デバイスをブラックリスト化する場合に推奨する方法は、<emphasis></emphasis>「WWID」または<emphasis></emphasis>「ベンダーと製品」です。<emphasis></emphasis>「devnode」によるブラックリスト化は推奨しません。デバイスノードは変わる可能性があり、デバイスを常時識別する目的では役に立たないからです。
   </para>
  </note>

  <warning>
   <title>multipath.confの正規表現</title>
   <para>
    <filename>/etc/multipath.conf</filename>では、正規表現は一般に「無効」です。<emphasis></emphasis>正規表現は、一般的な文字列を検索する場合にのみ有効です。ただし、マルチパスの標準設定には、すでにさまざまなデバイスとベンダーを表す正規表現が含まれています。正規表現で別の正規表現を検索することはできません。<command>multipath -t</command>で表示される文字列のみを検索するようにしてください。
   </para>
  </warning>

  <para>
   通常、非マルチパスデバイス(<literal>hpsa</literal>、<literal>fd</literal>、<literal>hd</literal>、<literal>md</literal>、<literal>dm</literal>、<literal>sr</literal>、<literal>scd</literal>、<literal>st</literal>、<literal>ram</literal>、<literal>raw</literal>、<literal>loop</literal>など)は無視できます。たとえば、ローカルのSATAハードディスクやフラッシュディスクにはマルチパスはありません。<command>multipath</command>で単一パスデバイスを無視する場合は、それらのデバイスを<command>blacklist</command>セクションに記述します。
  </para>

  <note>
   <title>互換性</title>
   <para>
    キーワード<literal>devnode_blacklist</literal>は廃止され、キーワード<literal>blacklist</literal>に代わりました。
   </para>
   <para>
    SUSE Linux Enterprise Server 12では、glibcで提供されている正規表現が使用されます。任意の文字列に一致させるには、<literal>&quot;.</literal>&quot;*&quot;<literal>ではなく*&quot;</literal>を使用する必要があります。
   </para>
  </note>

  <para>
   たとえば、<filename>hpsa</filename>ドライバからローカルデバイスとすべてのアレイを、multipathによる管理から外してブラックリストに載せるには、<command>blacklist</command>セクションを次のように指定します。
  </para>

<screen>blacklist {
      wwid "26353900f02796769"
      devnode "^(ram|raw|loop|fd|md|dm-|sr|scd|st)[0-9]*"
      devnode "^sd[a-z][0-9]*"
}</screen>

  <para>
   アレイ全体でなく、ドライバからのパーティションだけをブラックリスト化することもできます。たとえば、次の正規表現を使用すると、アレイ全体ではなく、ccissドライバからのパーティションだけをブラックリスト化できます。
  </para>

<screen>blacklist {
      devnode "^cciss!c[0-9]d[0-9]*[p[0-9]*]"
}</screen>

  <para>
   特定のデバイスタイプをブラックリスト化するには、ブラックリストに<literal>device</literal>セクションを追加して、キーワード<literal>vendor</literal>および<literal>product</literal>を使用します。
  </para>

<screen>blacklist {
      device {
           vendor  "DELL"
           product ".*"
       }
}</screen>

  <para>
   <literal>blacklist_exceptions</literal>セクションを使って、<literal>blacklist</literal>セクションで使用している正規表現によってブラックリスト化された特定のデバイスに対してマルチパスを有効にできます。WWID (<literal>wwid</literal>キーワード)、デバイス名(<literal>devnode</literal>キーワード)、またはデバイスタイプ(<literal>device</literal>セクション)を使用して例外を追加します。例外は、対応するデバイスをブラックリスト化したときと同じ方法で指定する必要があります。つまり、<literal>wwid</literal>例外は<literal>wwid</literal>ブラックリストに適用され、<literal>devnode</literal>例外は<literal>devnode</literal>ブラックリストに適用され、デバイスタイプ例外はデバイスタイプブラックリストに適用されます。
  </para>

  <para>
   たとえば、同じベンダのデバイスタイプが複数ある場合、目的のデバイスタイプに対してマルチパスを有効にできます。そのベンダのデバイスタイプすべてを<literal>blacklist</literal>セクションに記述してブラックリスト化してから、<literal>blacklist_exceptions</literal>セクションに<literal>device</literal>セクションを追加し、目的のデバイスタイプに対してマルチパスを有効にします。
  </para>

<screen>blacklist {
      devnode "^(ram|raw|loop|fd|md|dm-|sr|scd|st|sda)[0-9]*"
      device {
           vendor  "DELL"
           product ".*"
       }
}

blacklist_exceptions {
      device {
           vendor  "DELL"
           product "MD3220i"
       }
}</screen>

  <para>
   blacklist_exceptionsを使用して、特定のデバイスに対してのみマルチパスを有効にすることもできます。例:
  </para>

<screen>blacklist {
      wwid ".*"
}

blacklist_exceptions {
        wwid "3600d0230000000000e13955cc3751234"
        wwid "3600d0230000000000e13955cc3751235"
}</screen>

  <para>
   <filename>/etc/multipath.conf</filename>ファイルの変更後、<command>dracut</command> <option> -f</option>を実行してシステム上に<filename>initrd</filename>を再作成してから、サーバを再起動して変更内容を有効にする必要があります。詳細については<xref linkend="sec-multipath-conf-file-apply"/>を参照してください。
  </para>

  <para>
   再起動後は、<command>multipath -ll</command>コマンドを発行しても、ローカルデバイスはマルチパスマップにリストされません。
  </para>

  <note>
   <title><literal>find_multipaths</literal>オプションの使用</title>
   <para>
    <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 12 SP2より、マルチパスツールは、<filename>/etc/multipath.conf</filename>の<literal>defaults</literal>セクションでオプション<literal>find_multipaths</literal>をサポートするようになりました。このオプションは、マルチパスと<systemitem class="daemon">multipathd</systemitem>が、パスが1つだけのデバイスにマルチパスマップを設定しないようにします(詳細については、<command>man 5 multipath.conf</command>を参照してください)。特定の設定では、これによって、管理者がローカルSATAディスクなどのブラックリストエントリを作成する手間を省くことができます。
   </para>
   <para>
    <literal>find_multipaths</literal>オプションを使用すると一見便利そうですが、欠点もあります。まず、システムのブートが複雑化して低速になります。見つかったすべてのデバイスについて、そのデバイスに2つ目のパスが存在するかどうかを確認するため、すべてのデバイスが検出されるまでブートロジックが待機しなければならないからです。さらに、ブート時に一部のパスがダウンしていたり、他の理由で不可視になっていたりすると、問題が発生する可能性もあります。つまり、デバイスがシングルパスデバイスとして誤検出されてアクティブ化され、後で他のパスを追加できなくなる可能性があります。
   </para>
   <para>
    <literal>find_multipaths</literal>は、WWIDが一致すれば、<filename>/etc/multipath/wwids</filename>に一覧にされたデバイスをすべてマルチパスデバイスとみなします。これは、<literal>find_multipaths</literal>を初めて有効にする場合に重要です。wwidsファイルには既存のすべてのマルチパスマップ(シングルパスマップを含む)が一覧にされているため、<filename>/etc/multipath/wwids</filename>を削除または編集しない限り、このオプションを有効にしても効果はありません。マルチパスルートファイルシステムを持つSANブートシステムでは、初期RAMディスクとファイルシステムとの間で<filename>/etc/multipath/wwids</filename>の同期が維持されるようにしてください。
   </para>
   <para>
    まとめると、<literal>find_multipaths</literal>を使用すると便利ですが、SUSEは、これまでと同様に適切に設定されたブラックリストとブラックリスト例外を使うデフォルト設定をお勧めします。
   </para>
  </note>
 </sect1>
 <sect1 xml:id="sec-multipath-names">
  <title>ユーザフレンドリ名または別名の設定</title>

  <para>
   マルチパスデバイスは、そのWWID、ユーザフレンドリな名前、またはそれに割り当てた別名で識別されます。<filename>/dev/sdn</filename>および<filename>/dev/dm-n</filename>の形式のデバイスノード名は、再起動の際に変わる可能性があり、毎回異なるデバイスに割り当てられることになります。デバイスのWWID、ユーザフレンドリ名、および別名は、再起動の際にも変わることなく、デバイスの識別には望ましい方法です。
  </para>

  <important>
   <title>永続的な名前の使用の推奨</title>
   <para>
    <filename>/dev/sdn</filename>および<filename>/dev/dm-n</filename>形式のデバイスノード名は、再起動時に変更される可能性があるので、マルチパスデバイスは、そのWWIDで参照することを推奨します。また、再起動時にデバイスを一意に識別するために、WWIDにマップされたユーザフレンドリ名または別名を使用することもできます。
   </para>
  </important>

  <para>
   次の表では、<filename>/etc/multipath.conf</filename>ファイル内のデバイスに使用できるデバイス名のタイプについて説明しています。<filename>multipath.conf</filename>設定の例については、<filename>/usr/share/doc/packages/multipath-tools/multipath.conf.synthetic</filename>ファイルを参照してください。
  </para>

  <table>
   <title>マルチパスデバイス名のタイプの比較</title>
   <tgroup cols="2">
    <colspec colnum="1" colname="1" colwidth="1667*"/>
    <colspec colnum="2" colname="2" colwidth="8334*"/>
    <thead>
     <row>
      <entry>
       <para>
        名前のタイプ
       </para>
      </entry>
      <entry>
       <para>
        説明
       </para>
      </entry>
     </row>
    </thead>
    <tbody>
     <row>
      <entry>
       <para>
        WWID (デフォルト)
       </para>
      </entry>
      <entry>
       <para>
        シリアルWWID (Worldwide Identifier)は、グローバルに固有または非変更であることを保証されたマルチパスデバイスの識別子です。マルチパス処理で使用されるデフォルト名は、<filename>/dev/disk/by-id</filename>ディレクトリにある論理ユニットのIDです。たとえば、WWIDが<literal>3600508e0000000009e6baa6f609e7908</literal>のデバイスは、<filename>/dev/disk/by-id/scsi-3600508e0000000009e6baa6f609e7908</filename>と記載されています。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        ユーザフレンドリ
       </para>
      </entry>
      <entry>
       <para>
        <filename>/dev/mapper</filename>ディレクトリ内のデバイスマッパーマルチパスのデバイス名は、論理ユニットのIDも参照します。これらのマルチパスデバイス名は、<filename>/dev/mapper/mpath<replaceable>N</replaceable></filename>形式を使用するユーザフレンドリな名前です(たとえば、<filename>/dev/mapper/mpath0</filename>)。これらの名前は、<filename>/var/lib/multipath/bindings</filename>ファイルを使用してUUIDとユーザフレンドリな名前の関連付けを追跡するので、固有かつ永続的です。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        別名
       </para>
      </entry>
      <entry>
       <para>
        別名は、グローバルに固有な名前であり、管理者がマルチパスデバイスに提供します。別名は、WWIDとユーザフレンドリな<filename>/dev/mapper/mpath<replaceable>N</replaceable></filename>名に優先します。
       </para>
       <para>
        user_friendly_nameを使用している場合は、別名をmpath<replaceable>N</replaceable>形式に設定しないでください。mpathN形式にすると、自動的に割り当てられたユーザフレンドリ名と競合し、デバイスノードが正しくなくなる可能性があります。
       </para>
      </entry>
     </row>
    </tbody>
   </tgroup>
  </table>

  <para>
   <filename>/etc/multipath.conf</filename>ファイルのグローバルマルチパスオプション<literal>user_friendly_names</literal>は、マルチパスデバイスのユーザフレンドリ名の使用を有効または無効にするために使用されます。このオプションが<literal>no</literal> (デフォルト)に設定されている場合、マルチパスはデバイス名としてWWIDを使用します。このオプションが<literal>yes</literal>に設定されている場合は、<filename>/var/lib/multipath/bindings</filename>ファイルが使用されて、<filename>mpath&lt;<replaceable>N</replaceable>&gt;</filename>形式の永続的で固有の名前が、<filename>/dev/mapper</filename>ディレクトリ内でデバイスに割り当てられます。<literal>/etc/multipath.conf</literal>ファイルの<literal>bindings file</literal>オプションを使用すると、<filename>bindings</filename>ファイルに代替の場所を指定できます。
  </para>

  <para>
   <filename>/etc/multipath.conf</filename>ファイルのグローバルマルチパスオプション<literal>alias</literal>は、デバイスに名前を明示的に割り当てるために使用されます。別名がマルチパスデバイスに設定されている場合は、WWIDまたはユーザフレンドリ名の代わりにその別名が使用されます。
  </para>

  <para>
   <literal>user_friendly_names</literal>オプションの使用は、以下の状況では問題を引き起こす可能性があります。
  </para>

  <variablelist>
   <varlistentry>
    <term>ルートデバイスでマルチパスを使用している場合:</term>
    <listitem>
     <para>
      システムルートデバイスでマルチパスを使用中に、<literal>user_friendly_names</literal>オプションを使用する場合は、 option, the user-friendly settings in the <filename>/var/lib/multipath/bindings</filename>ファイルのユーザフレンドリ設定が<filename>initrd</filename>に組み込まれます。デバイスの追加や削除などで、後でストレージのセットアップを変更した場合は、<filename>initrd</filename>内のバインディング設定と<filename>/var/lib/multipath/bindings</filename>内のバインディング設定に不一致が生じます。
     </para>
     <warning>
      <title>バインディングの不一致</title>
      <para>
       <filename>initrd</filename>と<filename>/var/lib/multipath/bindings</filename>のバインディングが不一致だと、デバイスに間違ったマウントポイントが割り当てられることがあり、その場合は、ファイルシステムが破損し、データが失われます。
      </para>
     </warning>
     <para>
      この問題を回避するには、システムルートデバイスにデフォルトのWWID設定を使用することを推奨します。システムのルートデバイスには、別名を使用してはなりません。デバイス名が異なることがあるため、別名を使用すると、カーネルのコマンドラインを通じてマルチパス処理をシームレスにスイッチオフすることができなくなります。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>別のパーティションから/varをマウントする場合:</term>
    <listitem>
     <para>
      <literal>user_friendly_names</literal>設定ファイルのデフォルトの格納場所は、<filename>/var/lib/multipath/bindings</filename>です。<filename>/var</filename>データがシステムルートデバイス上になく、このデータを別のパーティションからマウントする場合は、マルチパス処理のセットアップ時に<filename>bindings</filename>ファイルを利用できません。
     </para>
     <para>
      <filename>/var/lib/multipath/bindings</filename>ファイルをシステムルートデバイスで使用し、マルチパスで検出できるようにしてください。これは、たとえば、次の手順で実行できます。
     </para>
     <orderedlist spacing="normal">
      <listitem>
       <para>
        <filename>/var/lib/multipath/bindings</filename>ファイルを<filename>/etc/multipath/bindings</filename>に移動します。
       </para>
      </listitem>
      <listitem>
       <para>
        この新しい場所に、/<filename>etc/multipath.conf</filename>の<literal>defaults</literal>セクションにある<literal>bindings_file</literal>オプションを設定します。例:
       </para>
<screen>
defaults {
               user_friendly_names yes
               bindings_file "/etc/multipath/bindings"
}
</screen>
      </listitem>
     </orderedlist>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>マルチパスがinitrdに含まれている場合:</term>
    <listitem>
     <para>
      システムルートデバイスがマルチパス上にない場合でも、マルチパスが<filename>initrd</filename>に含まれることがあります。これは、たとえば、システムルートデバイスがLVM上にある場合に起こります。<literal>user_friendly_names</literal>オプションを使用し、マルチパスが<filename>initrd</filename>内にある場合は、パラメータ<command>multipath=off</command>でブートして問題を回避してください。
     </para>
     <para>
      これにより、システムブート中は、<filename>initrd</filename>内でのみマルチパスが無効になります。システムブート後は、ブートスクリプト<filename>boot.multipath</filename>および<filename>multipathd</filename>によって、マルチパス処理を有効にすることができます。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>HAクラスタでマルチパス処理を行う場合:</term>
    <listitem>
     <para>
      詳細については<xref linkend="sec-multipath-names-ha"/>を参照してください。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   ユーザフレンドリな名前を有効にするか、別名を指定する場合:
  </para>

  <procedure>
   <step>
    <para>
     <systemitem class="username">root</systemitem>特権を使用して<filename>/etc/multipath.conf</filename>ファイルをテキストエディタで開きます。
    </para>
   </step>
   <step>
    <para>
     (オプション)<filename>/var/lib/multipath/bindings</filename>ファイルの場所を変更します。
    </para>
    <para>
     代替パスは、マルチパスが代替パスを見つけることができるシステムルートデバイス上に存在する必要があります。
    </para>
    <substeps performance="required">
     <step>
      <para>
       <filename>/var/lib/multipath/bindings</filename>ファイルを<filename>/etc/multipath/bindings</filename>に移動します。
      </para>
     </step>
     <step>
      <para>
       この新しい場所に、/<filename>etc/multipath.conf</filename>の<literal>defaults</literal>セクションにある<literal>bindings_file</literal>オプションを設定します。例:
      </para>
<screen>
defaults {
          user_friendly_names yes
          bindings_file "/etc/multipath/bindings"
}
</screen>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     (オプション、非推奨)ユーザフレンドリ名の有効にする:
    </para>
    <substeps performance="required">
     <step>
      <para>
       <literal>defaults</literal>セクションとその閉じ括弧を非コメント化します。
      </para>
     </step>
     <step>
      <para>
       <literal>user_friendly_names</literal>オプションを非コメント化し、次に、その値をNoからYesに変更します。
      </para>
      <para>
       例:
      </para>
<screen>## Use user-friendly names, instead of using WWIDs as names.
defaults {
  user_friendly_names yes
}</screen>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     (オプション)<command>alias</command>オプション(<command>multipath</command>セクションにある)を使用して、独自のデバイス名を指定します。
    </para>
    <para>
     例:
    </para>
<screen>## Use alias names, instead of using WWIDs as names.
multipaths {
       multipath {
               wwid           36006048000028350131253594d303030
               alias             blue1
       }
       multipath {
               wwid           36006048000028350131253594d303041
               alias             blue2
       }
       multipath {
               wwid           36006048000028350131253594d303145
               alias             yellow1
       }
       multipath {
               wwid           36006048000028350131253594d303334
               alias             yellow2
       }
}
</screen>
    <important>
     <title>WWNと比較したWWID</title>
     <para>
      <filename>/etc/multipath.conf</filename>ファイル内でデバイスの別名を定義する場合は、必ず各デバイスのWWID (<filename>3600508e0000000009e6baa6f609e7908</filename>など)を使用し、そのWWNは使用しないようにしてください。WWNは、デバイスIDの最初の文字を<filename>0x</filename>で置き換えます(<filename>0x600508e0000000009e6baa6f609e7908</filename>など)。
     </para>
    </important>
   </step>
   <step>
    <para>
     変更内容を保存し、ファイルを閉じます。
    </para>
   </step>
   <step>
    <para>
     <filename>/etc/multipath.conf</filename>ファイルの変更後、<command>dracut</command> <option> -f</option>を実行してシステム上に<filename>initrd</filename>を再作成してから、サーバを再起動して変更内容を有効にする必要があります。詳細については<xref linkend="sec-multipath-conf-file-apply"/>を参照してください。
    </para>
   </step>
  </procedure>

  <para>
   LUNディレクトリ全体を使用する場合は(たとえばSAN機能を使用してストレージのパーティションを行っている場合など)、<command>mkfs</command>、<filename>/etc/fstab</filename>、ご使用のアプリケーションなどに、<filename>/dev/disk/by-id/xxx</filename>という名前を使用することができます。パーティションで分割されたデバイスは、デバイス名の後ろに<filename>_part&lt;n&gt;</filename>が付加されます(<filename>/dev/disk/by-id/xxx_part1</filename>など)。
  </para>

  <para>
   <filename>/dev/disk/by-id</filename>ディレクトリでは、マルチパスのマップ処理がなされたデバイスは、<filename>dm-uuid*</filename>名または別名(<filename>/etc/multipath.conf</filename>ファイル内で別名を割り当てている場合)で表されます。<filename>scsi-</filename>および<filename>wwn-</filename>のデバイス名は、そのデバイスへの物理的パスを表します。
  </para>

  <sect2 xml:id="sec-multipath-names-ha">
   <title>HAクラスタにおけるマルチパスデバイスの名前</title>
   <para>
    以下を行って、マルチパスデバイスがすべてのデバイス間で同じ名前であるようにしてください。
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      UUIDと別名を使用して、マルチパスデバイスの名前が、クラスタ内のすべてのノードで同一となるようにします。別名は、すべてのノードにわたって一意である必要があります。<filename>/etc/multipath.conf</filename>ファイルを、ノードからクラスタ内の他のすべてのノードの<filename>/etc/</filename>ディレクトリにコピーします。
     </para>
    </listitem>
    <listitem>
     <para>
      マルチパスがマップされたデバイスを使用する場合は、<filename>dm-uuid*</filename>名または別名を<filename>/dev/disk/by-id</filename>ディレクトリ内で指定し、デバイスの固定パスインスタンスは指定しないようにします。詳細については、「<xref linkend="sec-multipath-names" xrefstyle="SectTitleOnPage"/>」を参照してください。
     </para>
    </listitem>
    <listitem>
     <para>
      <literal>user_friendly_names</literal>構成オプションを、無効にしないよう設定します。<literal></literal>ユーザフレンドリ名はノードに固有ですが、クラスタ内のすべてのノードにおいてデバイスに同じユーザフレンドリ名が割り当てられてはいない可能性があります。
     </para>
    </listitem>
   </itemizedlist>
   <note>
    <title>ユーザフレンドリ名</title>
    <para>
     実際にユーザフレンドリ名を使用する必要がある場合は、以下の操作により、システム定義のユーザフレンドリ名を、クラスタ内のすべてのノードについて同一にすることができます。
    </para>
    <procedure>
     <step>
      <para>
       1つのノード上の<filename>/etc/multipath.conf</filename>ファイル内で、
      </para>
      <orderedlist>
       <listitem>
        <para>
         <literal>user_friendly_names</literal>構成オプションを<literal>yes</literal>に設定して有効にします。
        </para>
        <para>
         マルチパスは、<filename>/var/lib/multipath/bindings</filename>ファイルを使用して、<filename>/dev/mapper</filename>ディレクトリ内で<filename>mpath&lt;<replaceable>N</replaceable>&gt;</filename>の形式で、デバイスに永続的かつ固有の名前を割り当てます。
        </para>
       </listitem>
       <listitem>
        <para>
         (オプション) <literal>bindings</literal>ファイルに対して別の場所を指定するには、<literal>/etc/multipath.conf</literal>ファイルの<literal>defaults</literal>セクションにある、<filename>bindings_file</filename>オプションを設定します。
        </para>
        <para>
         デフォルトの場所は、<filename>/var/lib/multipath/bindings</filename>です。
        </para>
       </listitem>
      </orderedlist>
     </step>
     <step>
      <para>
       ノード上のマルチパスデバイスをすべて設定します。
      </para>
     </step>
     <step>
      <para>
       <filename>/etc/multipath.conf</filename>ファイルを、ノードからクラスタ内の他のすべてのノードの<filename>/etc/</filename>ディレクトリにコピーします。
      </para>
     </step>
     <step>
      <para>
       <filename>bindings</filename>ファイルを、ノードから、クラスタ内の他のすべてのノード上の<filename>bindings_file</filename>パスにコピーします。
      </para>
     </step>
     <step>
      <para>
       <filename>/etc/multipath.conf</filename>ファイルの変更後、<command>dracut</command> <option> -f</option>を実行してシステム上に<filename>initrd</filename>を再作成してから、ノードを再起動して変更内容を有効にする必要があります。詳細については<xref linkend="sec-multipath-conf-file-apply"/>を参照してください。これは、影響を受けるすべてのノードに適用されます。
      </para>
     </step>
    </procedure>
   </note>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-multipath-policies-failover">
  <title>パスフェールオーバーのポリシーと優先度の設定</title>

  <para>
   Linuxホスト内で、ストレージコントローラへのパスが複数ある場合は、各パスが別個のブロックデバイスとして表示され、その結果、1つのLUNに複数のブロックデバイスが存在することになります。デバイスマッパーマルチパスサービスは、同じLUN IDをもつ複数のパスワードを検出し、そのIDで新しいマルチパスデバイスを作成します。たとえば、1つの非ゾーン化されたファイバチャネルのスイッチを介して2つのポートでストレージコントローラに接続した2つのHBAをもつホストは、4つのブロックデバイスを認識します(<filename>/dev/sda</filename>、<filename>/dev/sdb</filename>、<filename>/dev/sdc</filename>、<filename>/dev/sdd</filename>)。デバイスマッパーマルチパスサービスは、1つのブロックデバイス<filename>/dev/mpath/mpath1</filename>を作成します。このデバイスは、既に示した4つのブロックデバイスを介してI/Oを再経路指定します。
  </para>

  <para>
   本項では、フェールオーバーのポリシーを指定し、パスの優先順位を設定する方法について説明します。<filename>/etc/multipath.conf</filename>ファイルの変更後、<command>dracut</command> <option> -f</option>を実行してシステム上に<filename>initrd</filename>を再作成してから、サーバを再起動して変更内容を有効にする必要があることに注意してください。詳細については<xref linkend="sec-multipath-conf-file-apply"/>を参照してください。
  </para>

  <sect2 xml:id="sec-multipath-policies-failover-path">
   <title>パスのフェールオーバーポリシーの設定</title>
   <para>
    <command>multipath</command>コマンドを<option>-p</option>オプション付きで使用して、パスフェールオーバーポリシーを設定します。
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> multipath <replaceable>DEVICENAME</replaceable> -p <replaceable>POLICY</replaceable></screen>
   <para>
    次のポリシーオプションの1つで、<replaceable>POLICY</replaceable>を置き換えます。
   </para>
   <table>
    <title>multipath -pコマンドのグループポリシーオプション</title>
    <tgroup cols="2">
     <colspec colnum="1" colname="1" colwidth="2381*"/>
     <colspec colnum="2" colname="2" colwidth="7620*"/>
     <thead>
      <row>
       <entry>
        <para>
         ポリシーオプション
        </para>
       </entry>
       <entry>
        <para>
         説明
        </para>
       </entry>
      </row>
     </thead>
     <tbody>
      <row>
       <entry>
        <para>
         failover (フェールオーバー)
        </para>
       </entry>
       <entry>
        <para>
         (デフォルト)優先度グループごとに1つのパス
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         multibus
        </para>
       </entry>
       <entry>
        <para>
         1つの優先度グループ内にすべてのパス
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         group_by_serial
        </para>
       </entry>
       <entry>
        <para>
         検出されたシリアル番号ごとに1つの優先度グループ
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         group_by_prio
        </para>
       </entry>
       <entry>
        <para>
         パス優先度値ごとに1つの優先度グループ優先度は、コールアウトプログラムで決定されます。それらのプログラムは、グローバル、コントローラごと、またはマルチパスごとのオプションとして<filename>/etc/multipath.conf</filename>環境設定ファイルで指定されます。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         group_by_node_name
        </para>
       </entry>
       <entry>
        <para>
         ターゲットノード名ごとに1つの優先度グループターゲットノード 名は、<filename> /sys/class/fc_transport/target*/node_name</filename>にフェッチされます。
        </para>
       </entry>
      </row>
     </tbody>
    </tgroup>
   </table>
  </sect2>

  <sect2 xml:id="sec-multipath-policies-failover-prio">
   <title>フェールオーバーポリシーの設定</title>
   <para>
    デバイスのフェールオーバーポリシーは、手動で、<filename>/etc/multipath.conf</filename>ファイルに入力する必要があります。すべての設定とオプションの例は、<filename>/usr/share/doc/packages/multipath-tools/multipath.conf.annotated</filename>ファイルにあります。
   </para>
   <sect3 xml:id="sec-multipath-policies-failover-prio-info">
    <title>優先度グループと属性の理解</title>
    <para>
     <emphasis>優先度グループ</emphasis>は、同じ物理LUNに属するパスのコレクションです。デフォルトでは、I/Oは、グループ内のすべてのパス全体にラウンドロビン方式で配分されます。<command>multipath</command>コマンドは、SANのpath_grouping_policy設定に基づいてそのSANの各LUNごとに、自動的に優先度グループを作成します。<literal></literal><command>multipath</command>コマンドは、グループ内のパス数にグループの優先度を掛け合わせて、どのグループがプライマリか決定します。計算された値が最も高いグループがプライマリグループです。プライマリグループ内のすべてのパスが失敗すると、次に値の高い優先度グループがアクティブになります。
    </para>
    <para>
     <emphasis>パス優先度</emphasis>は、パスに割り当てられた整数値です。値が高いほど、優先度が高くなります。パスごとに優先度を割り当てるには、外部プログラムが使用されます。所定のデバイスに関して、同じ優先度のパスが同じ優先度グループに属します。
    </para>
    <para>
     <filename>prio</filename>設定は、<literal>/etc/multipath.conf</literal>ファイルの<literal>defaults{}</literal>または<literal>devices{}</literal>セクションで使用します。<literal>multipath{)</literal>セクションの個別の<literal>multipaths</literal>定義に指定されている場合は、暗黙のうちに無視されます。<literal>prio</literal>行で、Prioritizerが指定されます。Prioritizerが引数を必要とする場合、その引数は2行目の<literal>prio_args</literal>キーワードで指定します。
    </para>
    <bridgehead>デフォルトセクションまたはデバイスセクションのprio設定</bridgehead>
    <variablelist>
     <varlistentry>
      <term><literal>prio</literal></term>
      <listitem>
       <para>
        パス優先度の値を取得するために呼び出すPrioritizerプログラムを指定します。加重は、障害の発生時に使用する次のパスグループを決定するため、それぞれのパスグループに対して合計されます。
       </para>
       <para>
        指定したPrioritizerで引数が必要な場合は、<literal>prio_args</literal>キーワードを使用して、引数を指定します。
       </para>
       <para>
        <literal>prio</literal>キーワードを指定しない場合は、すべてのパスが同等になりますデフォルトの設定は<literal>const</literal>で、<literal>prio_args</literal>の設定には値がありません。
       </para>
<screen>prio "const"
prio_args ""</screen>
       <para>
        Prioritizerのプログラム例には、以下のものがあります。
       </para>
       <informaltable>
        <tgroup cols="2">
         <colspec colnum="1" colname="1" colwidth="2907*"/>
         <colspec colnum="2" colname="2" colwidth="7096*"/>
         <thead>
          <row>
           <entry>
            <para>
             Prioritizerプログラム
            </para>
           </entry>
           <entry>
            <para>
             説明
            </para>
           </entry>
          </row>
         </thead>
         <tbody>
          <row>
           <entry>
            <para>
             <literal>alua</literal>
            </para>
           </entry>
           <entry>
            <para>
             SCSI-3 ALUA設定に基づいてパス優先度を生成します。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>const</literal>
            </para>
           </entry>
           <entry>
            <para>
             すべてのパスに同じ優先度を生成します。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>emc</literal>
            </para>
           </entry>
           <entry>
            <para>
             EMCアレイのパス優先度を生成します。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>hdc</literal>
            </para>
           </entry>
           <entry>
            <para>
             Hitachi HDS Modularストレージアレイのパス優先度を生成します。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>hp_sw</literal>
            </para>
           </entry>
           <entry>
            <para>
             アクティブ/スタンバイモードのCompaq/HPコントローラのパス優先度を生成します。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>ontap</literal>
            </para>
           </entry>
           <entry>
            <para>
             NetAppアレイのパス優先度を生成します。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>random</literal>
            </para>
           </entry>
           <entry>
            <para>
             パスごとにランダムな優先度を生成します。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>rdac</literal>
            </para>
           </entry>
           <entry>
            <para>
             LSI/Engenio RDACコントローラのパスの優先度を生成します。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>weightedpath</literal>
            </para>
           </entry>
           <entry>
            <para>
             <literal>prio_args</literal>に対する引数内で指定した加重値に基づいて、パス優先度を生成します。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>path_latency</literal>
            </para>
           </entry>
           <entry>
            <para>
             <literal>prio_args</literal>キーワードで設定されているレイテンシアルゴリズムに基づいて、パスの優先度を生成します。
            </para>
           </entry>
          </row>
         </tbody>
        </tgroup>
       </informaltable>
      </listitem>
     </varlistentry>
    </variablelist>
    <bridgehead><literal>prio_args</literal>引数</bridgehead>
    <para>
     これらは、引数を必要とするPrioritizerプログラムの引数です。ほとんどの<literal>prio</literal>プログラムでは、引数は不要です。デフォルト値はありません。値は、<literal>prio</literal>の設定と、Prioritizerが次の引数のいずれかを必要とするかどうかによります。
    </para>
    <variablelist>
     <varlistentry>
      <term>weighted</term>
      <listitem>
       <para>
        フォーム<literal>[hbtl|devname|serial|wwn]</literal>
        <replaceable>REGEX1</replaceable> <replaceable>PRIO1</replaceable>
        <replaceable>REGEX2</replaceable> <replaceable>PRIO2</replaceable>の値が必要です...
       </para>
       <para>
        Regexでは、SCSI H:B:T:L形式(1:0:.:.および*:0:0:.など)を、加重値とともに使用する必要があります。ここで、H、B、T、Lはそれぞれ、デバイスのホスト、バス、ターゲット、およびLUN IDを示します。例:
       </para>
<screen>prio "weightedpath"
prio_args "hbtl 1:.:.:. 2 4:.:.:. 4"</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>devname</term>
      <listitem>
       <para>
        Regexはデバイス名形式です。例: sda, sd.e
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>serial</term>
      <listitem>
       <para>
        Regexはシリアル番号形式です。例: .*J1FR.*324.<command>multipathd show paths format %z</command>コマンドを使用してシリアル番号を検索します。(<command>multipathd show wildcards</command>では、すべての<literal>format</literal>のワイルドカードが表示されます。)
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>alua</term>
      <listitem>
       <para>
        <literal>exclusive_pref_bit</literal>がデバイスに対して設定される場合(<literal>alua exclusive_pref_bit</literal>)、<literal>preferred path</literal>ビットセットを持つパスは常に独自のパスグループ内になります。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>path_latency</term>
      <listitem>
       <para>
        <literal>path_latency</literal>では、リモートとローカルの両方のストレージアレイが同じタイプのハードウェアを使用する場合に、これらのアレイ間のレイテンシを調整します。通常、リモートアレイのレイテンシは高くなるため、レイテンシを調整してそれらを互いに近づけることができます。これには<literal>io_num=<replaceable>20</replaceable> base_num=<replaceable>10</replaceable></literal>という形式の値ペアが必要です。
       </para>
       <para>
        <literal>io_num</literal>は、現在のパスに継続的に送信される読み込みIO数で、平均のパスレイテンシを計算するために使用されます。有効な値は2～200の間の整数です。
       </para>
       <para>
        <literal>base_num</literal>は、異なる優先順位を分割するために使用される対数の基数です。有効な値は2～10の間の整数です。最大平均レイテンシ値は100s、最小は1μsです。たとえば、<literal>base_num=10</literal>の場合、パスはパスレイテンシが &lt;=1 μs、(1 μs, 10 μs]、(10 μs, 100 μs)、(100 μs, 1 ms)、(1 ms, 10 ms)、(10 ms, 100 ms)、(100 ms, 1 s)、(1 s, 10 s)、(10 s, 100 s)、&gt;100 sの優先グループにグループ化されます。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <bridgehead>マルチパス属性</bridgehead>
    <para>
     デバイスに対するマルチパスI/Oの動作を制御するには、マルチパス属性を使用します。すべてのマルチパスデバイスに対して、デフォルトとして属性を指定できます。また、あるマルチパスデバイスにのみ適用する属性を、そのデバイス用のエントリを、マルチパス設定ファイルの<literal>multipaths</literal>セクションで作成することで、指定することもできます。
    </para>
    <variablelist>
     <varlistentry>
      <term><literal>user_friendly_names</literal></term>
      <listitem>
       <para>
        WWID(world-wide ID)を使用するか、または<filename>/var/lib/multipath/bindings</filename>ファイルを使用して永続的で固有な別名を<filename>/dev/mapper/mpathN</filename>形式のマルチパスデバイスに割り当てるか指定します。
       </para>
       <para>
        このオプションは、<literal>devices</literal>セクションおよび<literal>multipaths</literal>セクションで使用できます。
       </para>
       <informaltable>
        <tgroup cols="2">
         <colspec colnum="1" colname="1" colwidth="2642*"/>
         <colspec colnum="2" colname="2" colwidth="7360*"/>
         <thead>
          <row>
           <entry>
            <para>
             値
            </para>
           </entry>
           <entry>
            <para>
             説明
            </para>
           </entry>
          </row>
         </thead>
         <tbody>
          <row>
           <entry>
            <para>
             <literal>×</literal>
            </para>
           </entry>
           <entry>
            <para>
             (デフォルト) <filename>/dev/disk/by-id/</filename>に示されたWWIDを使用します。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>yes</literal>
            </para>
           </entry>
           <entry>
            <para>
             実際のIDの代わりに、マルチパスデバイスのエイリアスとして、ユーザフレンドリな名前を自動生成します。
            </para>
           </entry>
          </row>
         </tbody>
        </tgroup>
       </informaltable>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="vle-failback">
      <term><literal>failback (フェールバック)</literal></term>
      <listitem>
       <para>
        エラーになったパスの回復を監視するかどうか指定し、パスサービス回復後のグループのフェールバックのタイミングを示します。
       </para>
       <para>
        エラーになったパスは、回復すると、この設定に基づいてマルチパス対応パスのリストに戻されます。multipathは、優先度グループを評価し、プライマリパスの優先度がセカンダリパスのそれを超えると、アクティブな優先度グループを変更します。
       </para>
       <informaltable>
        <tgroup cols="2">
         <colspec colnum="1" colname="1" colwidth="2642*"/>
         <colspec colnum="2" colname="2" colwidth="7360*"/>
         <thead>
          <row>
           <entry>
            <para>
             値
            </para>
           </entry>
           <entry>
            <para>
             説明
            </para>
           </entry>
          </row>
         </thead>
         <tbody>
          <row>
           <entry>
            <para>
             <literal>manual</literal>
            </para>
           </entry>
           <entry>
            <para>
             デフォルト。エラーになったパスの回復は監視されません。管理者が<command>multipath</command>コマンドを実行して、有効なパスと優先度グループを更新します。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>followover</literal>
            </para>
           </entry>
           <entry>
            <para>
             パスグループの最初のパスがアクティブになるときにのみ自動フェールバックを実行します。これにより、別のノードがフェールオーバーを要求したときに、ノードが自動的にフェールバックされないようにします。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>immediate</literal>
            </para>
           </entry>
           <entry>
            <para>
             パスが回復したら、ただちにパスを有効にします。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal><replaceable>N</replaceable></literal>
            </para>
           </entry>
           <entry>
            <para>
             パスが回復したら、<replaceable>N</replaceable>秒後にパスを有効にします。0より大きい整数値を指定してください。
            </para>
           </entry>
          </row>
         </tbody>
        </tgroup>
       </informaltable>
       <para>
        クラスタ環境内のマルチパスに対するフェールバックの設定は、マルチパスのフェールオーバーのピンポンを避けるため、<literal>manual</literal>にすることを推奨します。
       </para>
<screen>failback "manual"</screen>
       <important>
        <title>検証</title>
        <para>
         フェールバックの設定については、ストレージシステムのベンダに確認するようにしてください。ストレージシステムが異なれば、必要な設定も異なります。
        </para>
       </important>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="vle-no-path-retry">
      <term><literal>no_path_retry</literal></term>
      <listitem>
       <para>
        パスの障害時に使用する動作を指定します。
       </para>
       <informaltable>
        <tgroup cols="2">
         <colspec colnum="1" colname="1" colwidth="2642*"/>
         <colspec colnum="2" colname="2" colwidth="7360*"/>
         <thead>
          <row>
           <entry>
            <para>
             値
            </para>
           </entry>
           <entry>
            <para>
             説明
            </para>
           </entry>
          </row>
         </thead>
         <tbody>
          <row>
           <entry>
            <para>
             <literal><replaceable>N</replaceable></literal>
            </para>
           </entry>
           <entry>
            <para>
             <command>multipath</command>コマンドで待ち行列が停止し、パスがエラーになるまでの再試行数を指定します。0より大きい整数値を指定してください。
            </para>
            <para>
             クラスタでは、「0」を指定して、待ち行列を回避し、リソースのフェールオーバーを許可することができます。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>fail</literal>
            </para>
           </entry>
           <entry>
            <para>
             即時失敗(待ち行列なし)を指定します。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>queue</literal>
            </para>
           </entry>
           <entry>
            <para>
             待ち行列を停止しません(パスが復帰するまで永久に待機します)。
            </para>
           </entry>
          </row>
         </tbody>
        </tgroup>
       </informaltable>
       <para>
        クラスタでの作業では、<filename>/etc/multipath.conf</filename>ファイルの再試行設定を、<literal>fail</literal>または<literal>0</literal>にすることを推奨します。これにより、ストレージへの接続が失われた場合に、リソースのフェールオーバーが起こります。そうしないと、メッセージの待ち行列とリソースのフェールオーバーが行えません。
       </para>
<screen>no_path_retry "fail"
no_path_retry "0"</screen>
       <important>
        <title>検証</title>
        <para>
         再試行設定については、ストレージシステムのベンダに確認するようにしてください。ストレージシステムが異なれば、必要な設定も異なります。
        </para>
       </important>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>path_checker</literal></term>
      <listitem>
       <para>
        パスの状態を判別します。
       </para>
       <informaltable>
        <tgroup cols="2">
         <colspec colnum="1" colname="1" colwidth="30%"/>
         <colspec colnum="2" colname="2" colwidth="70%"/>
         <thead>
          <row>
           <entry>
            <para>
             値
            </para>
           </entry>
           <entry>
            <para>
             説明
            </para>
           </entry>
          </row>
         </thead>
         <tbody>
          <row>
           <entry>
            <para>
             <literal>directio</literal>
            </para>
           </entry>
           <entry>
            <para>
             直接I/Oを持つ最初のセクタを読み込みます。DASDデバイスの場合、有用です。障害メッセージを<systemitem class="daemon">systemd</systemitem>ジャーナルに記録します(<xref linkend="cha-journalctl"/>を参照してください)。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>tur</literal>
            </para>
           </entry>
           <entry>
            <para>
             デバイスに対してSCSIテストユニットレディコマンドを発行します。これはLUNによってサポートされている場合の推奨設定です。このコマンドは、障害時に、<systemitem class="daemon">systemd</systemitem>ログジャーナルにメッセージを出力しません。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <replaceable>CUSTOM_VENDOR_VALUE</replaceable>
            </para>
           </entry>
           <entry>
            <para>
             一部のSANベンダは、カスタムオプションとしてpath_checkerを提供しています。
            </para>
            <itemizedlist mark="bullet" spacing="normal">
             <listitem>
              <formalpara>
               <title><literal>cciss_tur</literal>:</title>
               <para>
                HP Smart Storage Arrayへのパスの状態をチェックします。
               </para>
              </formalpara>
             </listitem>
             <listitem>
              <formalpara>
               <title><literal>emc_clariion</literal>:</title>
               <para>
                EMC ClariionのEVPDページ0xC0をクエリしてパスの状態を判別します。
               </para>
              </formalpara>
             </listitem>
             <listitem>
              <formalpara>
               <title><literal>hp_sw</literal>:</title>
               <para>
                Active/StandbyファームウェアをもつHPストレージアレイのパスの状態(アップ、ダウン、またはゴースト)をチェックします。
               </para>
              </formalpara>
             </listitem>
             <listitem>
              <formalpara>
               <title><literal>rdac</literal>:</title>
               <para>
                LSI/Engenio RDACストレージコントローラのパスｍｐ状態をチェックします。
               </para>
              </formalpara>
             </listitem>
            </itemizedlist>
           </entry>
          </row>
         </tbody>
        </tgroup>
       </informaltable>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>path_grouping_policy</literal></term>
      <listitem>
       <para>
        所定のコントローラがホストとなるマルチパスデバイスのパスグループ化ポリシーを指定します。
       </para>
       <informaltable>
        <tgroup cols="2">
         <colspec colnum="1" colname="1" colwidth="2642*"/>
         <colspec colnum="2" colname="2" colwidth="7360*"/>
         <thead>
          <row>
           <entry>
            <para>
             値
            </para>
           </entry>
           <entry>
            <para>
             説明
            </para>
           </entry>
          </row>
         </thead>
         <tbody>
          <row>
           <entry>
            <para>
             <literal>フェールオーバー</literal>
            </para>
           </entry>
           <entry>
            <para>
             (デフォルト)一度に1つのパスだけ使用されるように、優先度グループごとに1つのパスが割り当てられます。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>multibus</literal>
            </para>
           </entry>
           <entry>
            <para>
             すべての有効なパスが1つの優先度グループに含まれます。トラフィックが、グループ内のアクティブなパスすべてに渡って負荷分散されます。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>group_by_prio</literal>
            </para>
           </entry>
           <entry>
            <para>
             パス優先度値ごとに、1つの優先度グループが存在します。同じ優先度のパスは同じ優先度グループに属します。優先度は外部プログラムによって割り当てられます。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>group_by_serial</literal>
            </para>
           </entry>
           <entry>
            <para>
             パスがSCSIターゲットシリアル番号(コントローラノードのWWN)でグループ化されます。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>group_by_node_name</literal>
            </para>
           </entry>
           <entry>
            <para>
             ターゲットノード名ごとに1つの優先度グループが割り当てられます。ターゲットノード名は<filename>/sys/class/fc_transport/target*/node_name</filename>にフェッチされます。
            </para>
           </entry>
          </row>
         </tbody>
        </tgroup>
       </informaltable>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>path_selector</literal></term>
      <listitem>
       <para>
        負荷分散に使用するパスセレクタアルゴリズムを指定します。
       </para>
       <informaltable>
        <tgroup cols="2">
         <colspec colnum="1" colname="1" colwidth="2642*"/>
         <colspec colnum="2" colname="2" colwidth="7360*"/>
         <thead>
          <row>
           <entry>
            <para>
             値
            </para>
           </entry>
           <entry>
            <para>
             説明
            </para>
           </entry>
          </row>
         </thead>
         <tbody>
          <row>
           <entry>
            <para>
             <literal>round-robin 0</literal>
            </para>
           </entry>
           <entry>
            <para>
             優先度グループ内のすべてのアクティブパスに渡るトラフィックの分散に使用される負荷分散アルゴリズム。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>queue-length 0</literal>
            </para>
           </entry>
           <entry>
            <para>
             least-pendingオプションと同様に、パス上で実行中のI/Oの数に基づく、動的負荷分散装置。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>service-time 0</literal>
            </para>
           </entry>
           <entry>
            <para>
             (デフォルト)遅延に従って、パス上のI/Oを調整するサービス時間に基づく負荷分散装置。
            </para>
           </entry>
          </row>
         </tbody>
        </tgroup>
       </informaltable>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>pg_timeout</term>
      <listitem>
       <para>
        パスグループのタイムアウト処理を指定します。値を指定することはできません。内部のデフォルトが設定されています。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="vle-polling-interval">
      <term><literal>polling_interval</literal></term>
      <listitem>
       <para>
        1つのパスチェックサイクルの終了から次回のパスチェックサイクルの開始までの時間を、秒単位で指定します。
       </para>
       <para>
        0より大きい整数値を指定してください。デフォルト値は5です。polling_intervalの設定については、ストレージシステムのベンダに確認するようにしてください。ストレージシステムが異なれば、必要な設定も異なります。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>rr_min_io_rq</literal></term>
      <listitem>
       <para>
        現在のパスグループ内の次のパスに切り替える前に、リクエストベースのデバイス-マッパー-マルチパスを使用して、あるパスへルートするI/Oリクエストの回数を指定します。
       </para>
       <para>
        0より大きい整数値を指定してください。デフォルト値は「1」です。
       </para>
<screen>rr_min_io_rq "1"</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>rr_weight</literal></term>
      <listitem>
       <para>
        パスの重み付けの方法を指定します。
       </para>
       <informaltable>
        <tgroup cols="2">
         <colspec colnum="1" colname="1" colwidth="2642*"/>
         <colspec colnum="2" colname="2" colwidth="7360*"/>
         <thead>
          <row>
           <entry>
            <para>
             値
            </para>
           </entry>
           <entry>
            <para>
             説明
            </para>
           </entry>
          </row>
         </thead>
         <tbody>
          <row>
           <entry>
            <para>
             <literal>uniform</literal>
            </para>
           </entry>
           <entry>
            <para>
             (デフォルト)すべてのパスが同じラウンドロビン方式の重み付けを持ちます。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>priorities</literal>
            </para>
           </entry>
           <entry>
            <para>
             各パスの重み付けは、パスの優先度にrr_min_io_rq設定値を掛け合わせて決定します。
            </para>
           </entry>
          </row>
         </tbody>
        </tgroup>
       </informaltable>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>uid_attribute</literal></term>
      <listitem>
       <para>
        固有のパス識別子を提供するudev属性。デフォルト値は<literal>ID_SERIAL</literal>です。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="sec-multipath-policies-failover-rr">
    <title>ラウンドロビン式負荷分散の設定</title>
    <para>
     すべてのパスがアクティブです。一定の秒数または一定数のI/Oトランザクションの後で、シーケンスの次のオープンパスに移動するように、I/Oを設定します。
    </para>
   </sect3>
   <sect3 xml:id="sec-multipath-policies-failover-prio-single">
    <title>単一パスフェールオーバーの設定</title>
    <para>
     優先度が最も高い（最も低い値の)単一パスがトランザクションに対してアクティブになります。他のパスは、フェールオーバーに使用できますが、フェールオーバーの発生までは使用されません。
    </para>
   </sect3>
   <sect3 xml:id="sec-multipath-policies-failover-prio-rr-grouping">
    <title>ラウンドロビン式負荷分散用I/Oパスのグループ化</title>
    <para>
     同じ優先度をもつ複数のパスがアクティブグループを形成します。そのグループのすべてのパスがエラーになると、デバイスが優先度の次に高いグループにフェールオーバーします。グループのすべてのパスが、ラウンドロビン方式の負荷分散で、トラフィックロードを共有します。
    </para>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-multipath-policies-failover-rtpg">
   <title>ターゲットパスグループの報告</title>
   <para>
    SCSIターゲットポートグループの報告(<command>sg_rtpg(8)</command>)コマンドを使用します。詳細については、<command>sg_rtpg(8)</command>のマニュアルページを参照してください。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-multipath-root">
  <title>ルートデバイスのマルチパスI/Oの設定</title>

  <para>
   <filename>SUSE Linux Enterprise Server</filename>では、DM-MPIO (デバイスマッパーマルチパスI/O)が使用可能であり、<filename>/boot</filename>と<phrase role="productname"><phrase os="sles">/root</phrase></phrase>に対してサポートされています。また、YaSTインストーラ内のYaSTパーティショナは、インストール中のマルチパスの有効化をサポートします。
  </para>

  <sect2 xml:id="sec-multipath-root-install">
   <title>インストール時にマルチパスI/Oを有効にする</title>
   <para>
    オペレーティングシステムをマルチパスデバイスにインストールするには、マルチパスソフトウェアがインストール時に実行されている必要があります。<systemitem class="daemon">multipathd</systemitem>デーモンは、システムのインストール時に自動的にアクティブになりません。このデーモンは、YaSTパーティショナの<guimenu>マルチパスの設定</guimenu>オプションを使用することによって起動できます。
   </para>
   <sect3 xml:id="sec-multipath-root-install-aa-lun">
    <title>アクティブ/アクティブマルチパスストレージLUNでインストール時にマルチパスI/Oを有効にする</title>
    <procedure>
     <step>
      <para>
       インストール時に<guimenu>推奨されたパーティション分割</guimenu>画面で<guimenu>エキスパートパーティショナ</guimenu>を選択します。
      </para>
     </step>
     <step>
      <para>
       <guimenu>ハードディスク</guimenu>メインアイコンを選択し、<guimenu>設定</guimenu>ボタンをクリックし、最後に、<guimenu>マルチパスの設定</guimenu>を選択します。
      </para>
     </step>
     <step>
      <para>
       multipathを起動します。
      </para>
      <para>
       YaSTがディスクの再スキャンを開始し、利用可能なマルチパスデバイスを表示します(<filename>/dev/disk/by-id/dm-uuid-mpath-3600a0b80000f4593000012ae4ab0ae65</filename>など)。これが、以降の処理すべての対象デバイスになります。
      </para>
     </step>
     <step>
      <para>
       <guimenu>次へ</guimenu>をクリックして、インストールを続行します。
      </para>
     </step>
    </procedure>
   </sect3>
   <sect3 xml:id="sec-multipath-root-install-ap-lun">
    <title>アクティブ/パッシブマルチパスストレージLUNでインストール時にマルチパスI/Oを有効にする</title>
    <para>
     <systemitem class="daemon">multipathd</systemitem>デーモンは、システムのインストール時に自動的にアクティブになりません。このデーモンは、YaSTパーティショナの<guimenu>マルチパスの設定</guimenu>オプションを使用することによって起動できます。
    </para>
    <para>
     アクティブ/パッシブマルチパスストレージLUNに対するインストール時にマルチパスI/Oを有効にするには:
    </para>
    <procedure>
     <step>
      <para>
       インストール時に<guimenu>推奨されたパーティション分割</guimenu>画面で<guimenu>エキスパートパーティショナ</guimenu>を選択します。
      </para>
     </step>
     <step>
      <para>
       <guimenu>ハードディスク</guimenu>メインアイコンを選択し、<guimenu>設定</guimenu>ボタンをクリックし、最後に、<guimenu>マルチパスの設定</guimenu>を選択します。
      </para>
     </step>
     <step>
      <para>
       multipathを起動します。
      </para>
      <para>
       YaSTがディスクの再スキャンを開始し、利用可能なマルチパスデバイスを表示します(<filename>/dev/disk/by-id/dm-uuid-mpath-3600a0b80000f4593000012ae4ab0ae65</filename>など)。これが、以降の処理すべての対象デバイスになります。デバイスのパスとUUIDを書き留めてください。後で必要になります。
      </para>
     </step>
     <step>
      <para>
       <guimenu>次へ</guimenu>をクリックして、インストールを続行します。
      </para>
     </step>
     <step>
      <para>
       すべての設定が完了し、インストールが終了すると、YaSTは、ブートローダ情報の書き込みを開始し、システム再起動のカウントダウンを表示します。<guimenu>中止</guimenu>をクリックしてカウンタを中止し、<keycombo><keycap function="control"/><keycap function="alt"/><keycap>F5</keycap></keycombo>を押してコンソールにアクセスします。
      </para>
     </step>
     <step>
      <para>
       コンソールを使用して、<filename>/boot/grub/device.map</filename>ファイルの<filename>hd0</filename>エントリにパッシブパスが入力されているかどうか判別します。
      </para>
      <para>
       これは、インストールではアクティブパスとパッシブパスが区別されないので必要です。
      </para>
      <substeps performance="required">
       <step>
        <para role="intro">
         次のように入力して、ルートデバイスを<filename>/mnt</filename>にマウントします。
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> mount /dev/disk/by-id/<replaceable>UUID</replaceable>;_part2 /mnt</screen>
        <para>
         例えば、次のように入力して、すべてのフォントについてアンチエイリアスを無効にします。
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> mount /dev/disk/by-id/dm-uuid-mpath-3600a0b80000f4593000012ae4ab0ae65_part2 /mnt</screen>
       </step>
       <step>
        <para>
         次のように入力して、ブートデバイスを<filename>/mnt/boot</filename>にマウントします。
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> mount /dev/disk/by-id/<replaceable>UUID</replaceable>_part1 /mnt/boot</screen>
        <para>
         例えば、次のように入力して、すべてのフォントについてアンチエイリアスを無効にします。
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> mount /dev/disk/by-id/dm-uuid-mpath-3600a0b80000f4593000012ae4ab0ae65_part2 /mnt/boot</screen>
       </step>
       <step>
        <para>
         <filename>/mnt/boot/grub/device.map</filename>ファイルで<filename>hd0</filename>エントリがパッシブパスをポイントしているかどうか判別し、次のいずれかを実行します。
        </para>
        <itemizedlist mark="bullet" spacing="normal">
         <listitem>
          <formalpara>
           <title>アクティブパス:</title>
           <para>
            操作は必要ありません。残りの手順をすべてスキップし、<keycombo><keycap function="control"/><keycap function="alt"/><keycap>F7</keycap></keycombo>を押してYaSTグラフィック環境に戻り、インストールを続行します。
           </para>
          </formalpara>
         </listitem>
         <listitem>
          <formalpara>
           <title>パッシブパス:</title>
           <para>
            設定を変更し、ブートローダを再インストールする必要があります。
           </para>
          </formalpara>
         </listitem>
        </itemizedlist>
       </step>
      </substeps>
     </step>
     <step>
      <para role="intro">
       <filename>hd0</filename>エントリがパッシブパスをポイントする場合は、設定を変更し、ブートローダを再インストールします。
      </para>
      <substeps performance="required">
       <step>
        <para role="intro">
         コンソールプロンプトで、次のコマンドを入力します。
        </para>
<screen>
          mount -o bind /dev /mnt/dev
          mount -o bind /sys /mnt/sys
          mount -o bind /proc /mnt/proc
          chroot /mnt</screen>
       </step>
       <step>
        <para role="intro">
         コンソールで、<command>multipath -ll</command>を実行し、その出力をチェックして、アクティブパスを見つけます。
        </para>
        <para>
         パッシブパスには<literal>ghost</literal>フラグが付いています。
        </para>
       </step>
       <step>
        <para>
         <filename>/boot/grub/device.map</filename>ファイルで<literal>hd0</literal>エントリをアクティブパスに変更し、変更内容を保存し、ファイルを閉じます。
        </para>
       </step>
       <step>
        <para>
         次のコマンドを入力して、ブートローダを再インストールします。
        </para>
<screen>grub-install /dev/disk/by-id/<replaceable>UUID</replaceable>_part1 /mnt/boot</screen>
        <para>
         例えば、次のように入力して、すべてのフォントについてアンチエイリアスを無効にします。
        </para>
<screen>grub-install /dev/disk/by-id/dm-uuid-mpath-3600a0b80000f4593000012ae4ab0ae65_part2 /mnt/boot</screen>
       </step>
       <step>
        <para>
         次のコマンドを入力します。
        </para>
<screen>exit
umount /mnt/*
umount /mnt</screen>
       </step>
      </substeps>
     </step>
     <step>
      <para>
       <keycombo><keycap function="control"/><keycap function="alt"/><keycap>F7</keycap></keycombo>を押して、YaSTグラフィック環境に戻ります。
      </para>
     </step>
     <step>
      <para>
       <guimenu>OK</guimenu>をクリックして、インストールを再起動します。
      </para>
     </step>
    </procedure>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-multipath-root-enable-existing">
   <title>既存ルートデバイス用マルチパスI/Oの有効化</title>
   <procedure>
    <step>
     <para>
      Linuxをインストールし、1つだけパスをアクティブにします。このパスは、パーティショナで<filename>by-id</filename>シンボリックリンクがリストされるパスがお勧めです。
     </para>
    </step>
    <step>
     <para>
      インストール時に使用した<filename>/disk/disk/by-id</filename>パスを使用してデバイスをマウントします。
     </para>
    </step>
    <step>
     <para>
      <filename>/etc/dracut.conf.d/10-mp.conf</filename>を開くか作成し、次の行を追加してください(行頭の空白に注意):
     </para>
<screen>force_drivers+=" dm-multipath"</screen>
    </step>
    <step>
     <para>
      <remark condition="clarity">
       2014-09-05 - fs: Check if the following is still true
      </remark>
      IBM Zの場合、<command>dracut</command>の実行前に、<filename>/etc/zipl.conf</filename>ファイルを編集して<filename>zipl.conf</filename>内のby-path情報を、<filename>/etc/fstab</filename>で使用されたby-id情報に変更します。
     </para>
    </step>
    <step>
     <para>
      <command>dracut</command> <option>-f</option>を実行して、<filename>initrd</filename>イメージを更新します。
     </para>
    </step>
    <step>
     <para>
      IBM Zの場合は、<command>dracut</command>の実行後、<command>zipl</command>を実行します。
     </para>
    </step>
    <step>
     <para>
      サーバを再起動します。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec-multipath-root-disable">
   <title>ルートデバイスのマルチパスI/Oの無効化</title>
   <para>
    <literal>multipath=off</literal>をカーネルコマンドラインに追加します。この変更はYaSTのブートローダモジュールで行うことができます。<menuchoice> <guimenu>ブートローダのインストール</guimenu> <guimenu>Kernel Parameters (カーネルパラメータ)</guimenu>
    </menuchoice>の順に開き、両方のコマンドラインにパラメータを追加します。
   </para>
   <para>
    これは、ルートデバイスだけに影響します。他のすべてのデバイスは影響されません。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-multipath-raid">
  <title>既存ソフトウェアRAID用マルチパスI/Oの設定</title>

  <para>
   理想的には、デバイスのマルチパス処理を設定してから、それらのデバイスをソフトウェアRAIDデバイスのコンポーネントとして使用してください。ソフトウェアRAIDデバイスの作成後にマルチパス処理を追加した場合は、再起動時に<command>multipath</command>サービスの後でDM-MPIOサービスが開始することがあります。その場合は、マルチパス処理がRAIDに使用できないように見えます。本項の手順を使用すると、すでに存在しているソフトウェアRAIDに対してマルチパス処理を実行できます。
  </para>

  <para>
   たとえば、次のような場合は、ソフトウェアRAID内のデバイスにマルチパス処理を設定する必要があることがあります。
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     新規インストールまたはアップグレード時にパーティショニング設定の一部として、新しいソフトウェアRAIDを作成する場合
    </para>
   </listitem>
   <listitem>
    <para>
     マルチパス処理用に設定しなかったデバイスをメンバーデバイスまたはスペアとしてソフトウェアRAIDで使用する場合
    </para>
   </listitem>
   <listitem>
    <para>
     新しいHBAアダプタをサーバに追加するか、またはSAN内でストレージサブシステムを拡張することで、システムを大きくする場合
    </para>
   </listitem>
  </itemizedlist>

  <note>
   <title>前提</title>
   <para>
    以降の説明では、ソフトウェアRAIDデバイスを<filename>/dev/mapper/mpath0</filename>(カーネルによって認識されるデバイス名)と想定しています。<filename>/etc/multipath.conf</filename>ファイルで、ユーザフレンドリ名を有効にしている(<xref linkend="sec-multipath-names" xrefstyle="HeadingOnPage"/>に記載)ことを想定しています。
   </para>
   <para>
    ソフトウェアRAIDのデバイス名の指定は、必ず変更してください。
   </para>
  </note>

  <procedure>
   <step>
    <para role="intro">
     端末コンソールを開きます。
    </para>
    <para>
     特に指示のない限り、この端末を使用して、以降のステップでコマンドを入力します。
    </para>
   </step>
   <step>
    <para>
     ソフトウェアRAIDデバイスが現在マウントされているか、または実行中の場合、デバイスごとに次のコマンドを入力して、デバイスをアンマウントし、停止します。
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> umount /dev/mapper/mpath0
<prompt>&gt; </prompt><command>sudo</command> mdadm --misc --stop /dev/mapper/mpath0</screen>
   </step>
   <step>
    <para>
     次のように入力して、<command>md</command>サービスを停止します。
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl stop mdmonitor</screen>
   </step>
   <step>
    <para>
     次のコマンドを入力することにより、<systemitem class="daemon">multipathd</systemitem>デーモンを起動します。
    </para>
<screen><prompt>&gt; </prompt>systemctl start multipathd</screen>
   </step>
   <step>
    <para>
     マルチパス処理サービスの開始後、ソフトウェアRAIDのコンポーネントデバイスが<filename>/dev/disk/by-id</filename>ディレクトリにリストされているかどうか確認します。次のいずれかの操作を行います。
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <formalpara>
       <title>デバイスがリストされている:</title>
       <para>
        デバイス名に、デバイスマッパーマルチパスのデバイス名(<filename>/dev/dm-1</filename>など)へのシンボリックリンクがあるはずです。
       </para>
      </formalpara>
     </listitem>
     <listitem>
      <formalpara>
       <title>デバイスがリストされていない:</title>
       <para>
        次のように入力して、デバイスをフラッシュし、再検出することで、マルチパスサービスにデバイスを認識させます。
       </para>
      </formalpara>
<screen><prompt>&gt; </prompt><command>sudo</command> multipath -F
<prompt>&gt; </prompt><command>sudo</command> multipath -v0</screen>
      <para>
       これで、デバイスが<filename>/dev/disk/by-id</filename>内にリストされ、デバイスマッパーマルチパスのデバイス名へのシンボリックリンクを持ちます。例:
      </para>
<screen>lrwxrwxrwx 1 root root 10 2011-01-06 11:42 dm-uuid-mpath-36006016088d014007e0d0d2213ecdf11 -&gt; ../../dm-1</screen>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     次のように入力して、<filename>mdmonitor</filename>サービスとRAIDデバイスを再起動します。
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl start mdmonitor</screen>
   </step>
   <step>
    <para>
     次のように入力して、ソフトウェアRAIDの状態をチェックします。
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> mdadm --detail /dev/mapper/mpath0</screen>
    <para>
     RAIDのコンポーネントデバイスは、そのデバイスマッパーマルチパスのデバイス名(<filename>/dev/disk/by-id</filename>ディレクトリにデバイスのシンボリックリンクとしてリストされている）と一致する必要があります。
    </para>
   </step>
   <step>
    <para>
     ルート(<filename>/</filename>)デバイス、またはそのいずれかの要素(<filename>/var</filename>、<filename>/etc</filename>、<filename>/log</filename>など)がSAN上にあり、ブートするためにマルチパスが必要な場合、<systemitem>initrd</systemitem>を再構築します。
    </para>
<screen><prompt>&gt; </prompt>dracut -f --add-multipath</screen>
   </step>
   <step>
    <para>
     サーバを再起動して、変更内容を適用します。
    </para>
   </step>
   <step>
    <para>
     RAIDステータスをチェックして、ソフトウェアRAIDアレイが、マルチパスデバイスの上に正しく示されることを確認します。以下を入力してください。
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> mdadm --detail /dev/mapper/mpath0</screen>
    <para>
     例:
    </para>
    <simplelist>
     <member><literal>メジャーマイナーRaidDevice状態の数</literal></member>
     <member><literal>0 253 0 0アクティブ同期/dev/dm-0</literal></member>
     <member><literal>1 253 1 1アクティブ同期/dev/dm-1</literal></member>
     <member><literal>2 253 2 2アクティブ同期/dev/dm-2</literal></member>
    </simplelist>
   </step>
  </procedure>

  <note>
   <title>マルチパスデバイスでのmdadmの使用</title>
   <para>
    <command>mdadm</command>ツールでは、デバイスのノードパスではなく、IDでデバイスにアクセスする必要があります。詳細については、<xref linkend="sec-multipath-mpiotools-mdadm"/>を参照してください。
   </para>
  </note>
 </sect1>
 <sect1 xml:id="sec-multipath-lvm">
  <title>マルチパスデバイスでのLVM2の使用</title>

  <para>
   マルチパス使用時に、リソースへのすべてのパスがデバイスツリーのデバイスとして存在します。デフォルトでは、LVMは、デバイスツリーの任意のデバイス上にマルチパスデバイスがあるかどうかを確認します。LVMがマルチパスデバイスを検出すると、そのデバイスはマルチパスコンポーネントであるとみなされ、(基盤となっている)デバイスは無視されます。ほとんどの場合はこの動作で問題ありませんが、<filename>/etc/lvm/lvm.conf</filename>で設定を変更できます。multipath_component_detectionを1に設定すると、LVMはマルチパスコンポーネントデバイスをスキャンします。lvm.confのデフォルトのエントリは次のとおりです。
  </para>

<screen>    # By default, LVM2 will ignore devices used as component paths
    # of device-mapper multipath devices.
    # 1 enables; 0 disables.
    multipath_component_detection = 1</screen>
 </sect1>
 <sect1 xml:id="sec-multipath-best-practice">
  <title>ベストプラクティス</title>

  <para/>

  <sect2 xml:id="sec-multipath-best-practice-scandev">
   <title>新規デバイスのスキャン(再起動なし)</title>
   <para>
    ご使用のシステムがマルチパス処理用に設定されており、後からSANにストレージを追加する必要がある場合は、<command>rescan-scsi-bus.sh</command>スクリプトを使用して新しいデバイスをスキャンすることができます。デフォルトでは、このスクリプトは典型的なLUN範囲ですべてのHBAをスキャンします。このコマンドの一般的な構文は、次のようになります。
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> rescan-scsi-bus.sh [options] [host [host ...]]</screen>
   <para>
    ほとんどのストレージサブシステムでは、このスクリプトはオプションを指定しなくても正常に実行されます。ただし、特殊な場合は、次のオプションを1つ以上使用する必要があります。詳細については、<command>rescan-scsi-bus.sh --help</command>を実行してください。
   </para>
   <warning>
    <title>EMC PowerPath環境</title>
    <para>
     EMC PowerPath環境では、SCSIバスをスキャンする場合に、オペレーティングシステムに付属する<filename>rescan-scsi-bus.sh</filename>ユーティリティまたはHBAベンダスクリプトを使用しないでください。ファイルシステムが破損する可能性を避けるため、EMCでは、Linux用EMC PowerPathのベンダマニュアルに記載されている手順に従うよう求めています。
    </para>
   </warning>
   <para>
    次のプロシージャを使用して、システムを再起動せずに、デバイスをスキャンして、マルチパス処理に使用できるようにします。
   </para>
   <procedure>
    <step>
     <para>
      ストレージサブシステムで、ベンダのツールを使用してデバイスを割り当て、そのアクセス制御設定を更新して、Linuxシステムが新しいストレージをアクセスできるようにします。詳細については、ベンダのマニュアルを参照してください。
     </para>
    </step>
    <step>
     <para>
      すべてのターゲットをスキャンしてホストの有無を調べ、LinuxカーネルのSCSIサブシステムのミドルレイヤに新しいデバイスを認識させます。端末コンソールのプロンプトで、次のように入力します。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> rescan-scsi-bus.sh</screen>
     <para>
      セットアップによっては、オプションのパラメータを指定して<command>rescan-scsi-bus.sh</command>を実行しなければならない場合があります。詳細については、<command>rescan-scsi-bus.sh --help</command>を参照してください。
     </para>
    </step>
    <step>
     <para>
      <systemitem class="daemon">systemd</systemitem>ジャーナルでスキャンの進行状況を確認します(詳細については、<xref linkend="cha-journalctl"/>を参照してください)。端末コンソールのプロンプトで、次のように入力します。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> journalctl -r</screen>
     <para>
      このコマンドは、ログの最後の行を表示します。例:
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> journalctl -r
Feb 14 01:03 kernel: SCSI device sde: 81920000
Feb 14 01:03 kernel: SCSI device sdf: 81920000
Feb 14 01:03 multipathd: sde: path checker registered
Feb 14 01:03 multipathd: sdf: path checker registered
Feb 14 01:03 multipathd: mpath4: event checker started
Feb 14 01:03 multipathd: mpath5: event checker started
Feb 14 01:03:multipathd: mpath4: remaining active paths: 1
Feb 14 01:03 multipathd: mpath5: remaining active paths: 1
[...]</screen>
    </step>
    <step>
     <para>
      前の各手順を繰り返し、新しいデバイスに接続しているLinuxシステム上の他のHBAアダプタを介して、パスを追加します。
     </para>
    </step>
    <step>
     <para>
      <command>multipath</command>コマンドを実行して、DM-MPIO設定用のデバイスを認識します。端末コンソールのプロンプトで、次のように入力します。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> multipath</screen>
     <para>
      これで、新しいデバイスをマルチパス処理用に設定できます。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec-multipath-best-practice-scanpart">
   <title>パーティショニングされた新規デバイスのスキャン(再起動なし)</title>
   <para>
    本項の例を使用して、新たに追加したマルチパスLUNを再起動なしで検出します。
   </para>
   <warning>
    <title>EMC PowerPath環境</title>
    <para>
     EMC PowerPath環境では、SCSIバスをスキャンする場合に、オペレーティングシステムに付属する<filename>rescan-scsi-bus.sh</filename>ユーティリティまたはHBAベンダスクリプトを使用しないでください。ファイルシステムが破損する可能性を避けるため、EMCでは、Linux用EMC PowerPathのベンダマニュアルに記載されている手順に従うよう求めています。
    </para>
   </warning>
   <procedure>
    <step>
     <para>
      端末コンソールを開きます。
     </para>
    </step>
    <step>
     <para>
      すべてのターゲットをスキャンしてホストの有無を調べ、LinuxカーネルのSCSIサブシステムのミドルレイヤに新しいデバイスを認識させます。端末コンソールのプロンプトで、次のように入力します。
     </para>
<screen><prompt>&gt; </prompt>rescan-scsi-bus.sh</screen>
     <para>
      セットアップによっては、オプションのパラメータを指定して<command>rescan-scsi-bus.sh</command>を実行しなければならない場合があります。詳細については、<command>rescan-scsi-bus.sh --help</command>を参照してください。
     </para>
    </step>
    <step>
     <para>
      次のように入力して、デバイスが認識されていること(リンクに新しいタイムスタンプが付いているかどうかなど)を確認します。
     </para>
<screen><prompt>&gt; </prompt>ls -lrt /dev/dm-*</screen>
     <para>
      次のように入力して、<filename>/dev/disk/by-id</filename>内のデバイスを確認することもできます。
     </para>
<screen><prompt>&gt; </prompt>ls -l /dev/disk/by-id/</screen>
    </step>
    <step>
     <para>
      次のように入力して、新しいデバイスがログに表示されることを確認します。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> journalctl -r</screen>
    </step>
    <step>
     <para>
      テキストエディタで、デバイスの新しいエイリアス定義を<filename>/etc/multipath.conf</filename>ファイルに追加します(<filename>data_vol3</filename>など)。
     </para>
     <para>
      たとえば、UUIDが<filename>36006016088d014006e98a7a94a85db11</filename>であれば、次の変更を行います。
     </para>
<screen>defaults {
     user_friendly_names   yes
  }
multipaths {
     multipath {
          wwid    36006016088d014006e98a7a94a85db11
          alias  data_vol3
          }
  }</screen>
    </step>
    <step>
     <para>
      次の入力で、デバイスのパーティションテーブルを作成します。
     </para>
<screen><prompt>&gt; </prompt>fdisk /dev/disk/by-id/dm-uuid-mpath-&lt;UUID&gt;</screen>
     <para>
      UUIDをデバイスのWWID(<filename>36006016088d014006e98a7a94a85db11</filename>など)で置き換えます。
     </para>
    </step>
    <step>
     <para>
      次のように入力して、udevをトリガします。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> echo 'add' &gt; /sys/block/<replaceable>DM_DEVICE</replaceable>/uevent</screen>
     <para>
      たとえば、<filename>dm-8</filename>上のパーティションに対して、デバイスマッパーデバイスを生成するには、次のように入力します。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> echo 'add' &gt; /sys/block/dm-8/uevent</screen>
    </step>
    <step>
     <para>
      デバイス<filename>/dev/disk/by-id/dm-uuid-mpath-<replaceable>UUID_partN</replaceable></filename>上にファイルシステムを作成します。選択するファイルシステムに応じて、このために<command>mkfs.btrfs</command>
      <command> mkfs.ext3</command>、<command>mkfs.ext4</command>、または<command>mkfs.xfs</command>のいずれかのコマンドを使用できます。詳細については、それぞれのマニュアルページを参照してください。<filename>UUID_partN</filename>を、実際のUUIDおよびパーティション番号(36006016088d014006e98a7a94a85db11_part1など)で置き換えます。
     </para>
    </step>
    <step>
     <para>
      次のコマンドを入力して、新しいパーティションのラベルを作成します。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> tune2fs -L <replaceable>LABELNAME</replaceable> /dev/disk/by-id/dm-uuid-<replaceable>UUID_partN</replaceable>
</screen>
     <para>
      <filename>UUID_partN</filename>を、実際のUUIDおよびパーティション番号(36006016088d014006e98a7a94a85db11_part1など)で置き換えます。<replaceable>LABELNAME</replaceable>は好みのラベルに代えてください。
     </para>
    </step>
    <step>
     <para>
      次の入力で、DM-MPIOを再設定して、エイリアスを読み込ませます。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> multipathd -k'reconfigure'</screen>
    </step>
    <step>
     <para>
      次の入力で、デバイスが<systemitem class="daemon">multipathd</systemitem>によって認識されていることを確認します。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> multipath -ll</screen>
    </step>
    <step>
     <para>
      テキストエディタで、<filename>/etc/fstab</filename>ファイルにマウントエントリを追加します。
     </para>
     <para>
      この時点では、前の手順で作成したエイリアスは、まだ<filename>/dev/disk/by-label</filename>ディレクトリにあります。マウントエントリを<filename>/dev/dm-9</filename>パスに追加した後、次回の再起動の前に、マウントエントリを次のように変更します。
     </para>
<screen>LABEL=<replaceable>LABELNAME</replaceable></screen>
    </step>
    <step>
     <para>
      マウントポイントとして使用するディレクトリを作成し、デバイスをマウントします。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec-multipath-best-practice-status">
   <title>マルチパスI/Oステータスの表示</title>
   <para>
    マルチパスI/Oのステータスをクエリすると、マルチパスマップの現在のステータスが出力されます。
   </para>
   <para>
    <command>multipath -l</command>オプションを使用すると、パスチェッカが最後に実行された時点での現行パスステータスが表示されます。ただし、パスチェッカは実行されません。
   </para>
   <para>
    <command>multipath -ll</command>オプションを使用すると、パスチェッカが実行され、パス情報が更新され、最後に、現在のステータス情報が表示されます。このコマンドは、常にパスステータスの最新情報を表示します。
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> multipath -ll
3600601607cf30e00184589a37a31d911
[size=127 GB][features="0"][hwhandler="1 emc"]

\_ round-robin 0 [active][first]
  \_ 1:0:1:2 sdav 66:240  [ready ][active]
  \_ 0:0:1:2 sdr  65:16   [ready ][active]

\_ round-robin 0 [enabled]
  \_ 1:0:0:2 sdag 66:0    [ready ][active]
  \_ 0:0:0:2 sdc  8:32    [ready ][active]</screen>
   <para>
    デバイスごとに、デバイスのID、サイズ、機能、およびハードウェアハンドラが表示されます。
   </para>
   <para>
    デバイスへのパスは、自動的に、デバイス検出時に優先度グループとしてグループ化されます。一度に1つの優先度グループだけがアクティブになります。アクティブ/アクティブ構成の場合、すべてのパスが同じグループに属します。アクティブ/パッシブ構成の場合、パッシブパスは別個の優先度グループに属します。
   </para>
   <para>
    グループごとに、次の情報が表示されます。
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      ラウンドロビン方式など、グループ内でのI/O負荷の分散に使用されるスケジューリングポリシー
     </para>
    </listitem>
    <listitem>
     <para>
      グループがアクティブか、無効か、または有効か
     </para>
    </listitem>
    <listitem>
     <para>
      最初の(優先度の最も高い)グループかどうか
     </para>
    </listitem>
    <listitem>
     <para>
      グループ内に含まれるパス
     </para>
    </listitem>
   </itemizedlist>
   <para>
    パスごとに、次の情報が表示されます。
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      <replaceable>HOST:BUS:TARGET:LUN</replaceable>としての物理アドレス(1:0:1:2など)
     </para>
    </listitem>
    <listitem>
     <para>
      デバイスノード 名(<filename>sda</filename>など)
     </para>
    </listitem>
    <listitem>
     <para>
      メジャー/マイナー番号
     </para>
    </listitem>
    <listitem>
     <para>
      デバイスのステータス
     </para>
    </listitem>
   </itemizedlist>
   <note>
    <title>マルチパスセットアップで<command>iostat</command>を使用する</title>
    <para>
     マルチパス環境では、<command>iostat</command>コマンドによって予期しない結果が発生する可能性があります。デフォルトでは、<command>iostat</command>は、I/Oのないすべてのブロックデバイスをフィルタして排除します。<command>iostat</command>で<emphasis>すべての</emphasis>デバイスを表示するには、次のコマンドを使用します。
    </para>
    <screen>iostat -p ALL</screen>
   </note>
  </sect2>

  <sect2 xml:id="sec-multipath-best-practice-io-error">
   <title>エラーになったI/Oの管理</title>
   <para>
    queue_if_no_pathを有効にすることで、すべてのパスで同時に障害が発生した場合は、I/Oをキューに登録するように、マルチパス処理を設定する必要があるかもしれません。設定しておかないと、すべてのパスに障害が発生するとI/Oもすぐに失敗してしまいます。ドライバ、HBA、またはファブリックにスプリアスエラーが発生したというシナリオでは、それらのエラーですべてのパスが失われるI/Oをすべて待ち行列に入れ、エラーを上方にプロパゲートしないように、DM-MPIOを設定してください。
   </para>
   <para>
    マルチパスデバイスをクラスタで使用する場合は、queue_if_no_pathを無効にすることができます。これにより、I/Oがキューに入る代わりに、パスがエラーになり、そのI/Oエラーがエスカレートしてクラスタリソースのフェールオーバーを引き起こします。
   </para>
   <para>
    ただし、queue_if_no_pathを有効にすると、パスが回復しない限り、I/Oがいつまでもキューに留まることになるので、<command>multipathd</command>が実行中であり、シナリオに有効なことを必ず確認してください。確認しておかないと、再起動するまで、またはキューの代わりに手動でフェールオーバーに戻すまで、影響を受けたマルチパスデバイスでI/Oが無限に停止する可能性があります。
   </para>
   <para>
    シナリオをテストするには:
   </para>
   <procedure>
    <step>
     <para>
      端末コンソールを開きます。
     </para>
    </step>
    <step>
     <para>
      次のように入力して、デバイスI/Oに関して、フェールオーバーの代わりに待ち行列処理をアクティブにします。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> dmsetup message <replaceable>DEVICE_ID</replaceable> 0 queue_if_no_path</screen>
     <para>
      <replaceable>DEVICE_ID</replaceable>を実際のデバイスのIDに置き換えます。値0はセクタを表し、セクタ情報が必要でないときに使用されます。
     </para>
     <para>
      たとえば、次のように入力します。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> dmsetup message 3600601607cf30e00184589a37a31d911 0 queue_if_no_path</screen>
    </step>
    <step>
     <para>
      次のように入力して、デバイスI/Oのフェールオーバーに戻ります。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> dmsetup message <replaceable>DEVICE_ID</replaceable> 0 fail_if_no_path</screen>
     <para>
      このコマンドにより、ただちに、待ち行列に入ったすべてのI/Oがエラーになります。
     </para>
     <para>
      <replaceable>DEVICE_ID</replaceable>を実際のデバイスのIDに置き換えます。例えば、次のように入力して、すべてのフォントについてアンチエイリアスを無効にします。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> dmsetup message 3600601607cf30e00184589a37a31d911 0 fail_if_no_path</screen>
    </step>
   </procedure>
   <para>
    待ち行列内のI/Oをすべてのパスがエラーになるシナリオ用に設定するには:
   </para>
   <procedure>
    <step>
     <para>
      端末コンソールを開きます。
     </para>
    </step>
    <step>
     <para>
      <filename>/etc/multipath.conf</filename>ファイルをテキストエディタで開きます。
     </para>
    </step>
    <step>
     <para>
      defaultsセクションとその閉じ括弧を非コメント化した後、次のように<literal>default_features</literal>設定を追加します。
     </para>
<screen>defaults {
  default_features "1 queue_if_no_path"
}</screen>
    </step>
    <step>
     <para>
      <filename>/etc/multipath.conf</filename>ファイルの変更後、<command>dracut</command> <option> -f</option>を実行してシステム上に<filename>initrd</filename>を再作成してから、再起動して変更内容を有効にします。
     </para>
    </step>
    <step>
     <para>
      デバイスI/Oのフェールオーバーに戻る準備ができたら、次のように入力します。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> dmsetup message <replaceable>MAPNAME</replaceable> 0 fail_if_no_path</screen>
     <para>
      <replaceable>MAPNAME</replaceable>を該当デバイスのマップされたエイリアス名またはデバイスIDに置き換えます。値0はセクタを表し、セクタ情報が必要でないときに使用されます。
     </para>
     <para>
      このコマンドにより、待ち行列で待機中のすべてのI/Oがエラーとなり、エラーが呼び出し側アプリケーションにプロパゲートします。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec-multipath-best-practice-io-stalled">
   <title>停止したI/Oの解決</title>
   <para>
    すべてパスが同時にエラーとなり、I/Oが待ち行列に入って停止している場合は、次のプロシージャを実行します。
   </para>
   <procedure>
    <step>
     <para>
      端末コンソールのプロンプトで、次のコマンドを入力します。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> dmsetup message <replaceable>MAPNAME</replaceable> 0 fail_if_no_path</screen>
     <para>
      <literal><replaceable>MAPNAME</replaceable></literal>をデバイスの正しいデバイスIDまたはマップされたエイリアス名で置き換えます。値0はセクタを表し、セクタ情報が必要でないときに使用されます。
     </para>
     <para>
      このコマンドにより、待ち行列で待機中のすべてのI/Oがエラーとなり、エラーが呼び出し側アプリケーションにプロパゲートします。
     </para>
    </step>
    <step>
     <para>
      次のコマンドを入力して、待ち行列を再びアクティブにします。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> dmsetup message <replaceable>MAPNAME</replaceable> 0 queue_if_no_path</screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec-multipath-best-practice-zseries">
   <title>IBM Zデバイスのデフォルト設定</title>
   <para>
    IBM Zデバイスのマルチパス処理に関するテストを実施した結果、<literal>dev_loss_tmo</literal>パラメータをinfinity (2147483647)に、<literal>fast_io_fail_tmo</literal>パラメータを 5秒に設定する必要があることわかりました。IBM Zデバイスを使用している場合は、<filename>/etc/multipath.conf</filename>ファイルを変更して、値を次のように指定します。
   </para>
<screen>defaults {
       dev_loss_tmo 2147483647
       fast_io_fail_tmo 5
}</screen>
   <para>
    <literal>dev_loss_tmo</literal>パラメータは、マルチパスリンクに不良のマーキングがされるまでの秒数を設定します。パスに障害が発生したら、そのパスの現在のI/Oが失敗します。デフォルト値は使用するデバイスドライバによって異なります。ドライバの内部タイムアウトを使用するには、値をゼロ(0)に設定します。「infinity」(2147483647)に設定することもできます。これにより、最大値が2147483647秒(68年)に設定されます。
   </para>
   <para>
    <literal>fast_io_fail_tmo</literal>パラメータは、リンク障害を検出した場合に、I/Oが失敗するまでの待機時間を設定します。ドライバに到達したI/Oは失敗します。ブロックしたキューにI/Oがある場合は、I/Oは<literal>dev_loss_tmo</literal>で指定された時間が経過するまでは失敗せず、キューのブロックが解除されます。
   </para>
   <para>
    <filename>/etc/multipath.conf</filename>ファイルを変更した場合、その変更内容は、マルチパスマップを更新するまで、または<systemitem class="daemon">multipathd</systemitem>デーモンを再起動(<command>systemctl restart multipathd</command>)するまで適用されません。
   </para>
  </sect2>

  <sect2 xml:id="sec-multipath-best-practice-netapp">
   <title>NetAppデバイスでのマルチパスの使用</title>
   <para>
    NetAppデバイスでマルチパスを使用する場合は、<filename>/etc/multipath.conf</filename>ファイルで次の設定を行うことを推奨します。
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      NetAppデバイスに対してグローバルに、次のパラメータにデフォルト値を設定する。
     </para>
<screen>max_fds max
queue_without_daemon no</screen>
    </listitem>
    <listitem>
     <para>
      ハードウェアテーブル内で、NetAppデバイスに対する次のパラメータにデフォルト値を設定する。
     </para>
<screen>dev_loss_tmo infinity
fast_io_fail_tmo 5
features "3 queue_if_no_path pg_init_retries 50"</screen>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="sec-multipath-best-practice-noflush">
   <title>マルチパスデバイスでの--noflushの使用</title>
   <para>
    マルチパスデバイス上で実行する場合は、オプション<option>--noflush</option>を必ず使用する必要があります。
   </para>
   <para>
    たとえば、テーブルのリロードを行うスクリプトでは、マルチパストポロジ情報が必要なので、再開時に<literal>--noflush</literal>オプションを使用して、残っているI/Oがフラッシュされないようにします。
   </para>
<screen>load
resume --noflush</screen>
  </sect2>

  <sect2 xml:id="sec-multipath-best-practice-san-timeout">
   <title>ルートデバイスがマルチパスの場合のSANタイムアウト設定</title>

   <para>
    マルチパスデバイスにルート(<filename>/</filename>)があるシステムは、すべてのパスに障害が発生し、それらのパスがシステムから削除されると、停止することがあります。これは、ストレージサブシステム(ファイバチャネルストレージアレイなど)から<literal>dev_loss_tmo</literal>タイムアウトを受信するからです。
   </para>
   <para>
    システムデバイスがマルチパスを使用して設定され、マルチパスの<literal>no_path_retry</literal>設定がアクティブな場合は、ストレージサブシステムの<literal>dev_loss_tmo</literal>設定を適宜変更して、すべてのパスがダウンするシナリオでデバイスが削除されないようにする必要があります。<literal>dev_loss_tmo</literal>値をマルチパスの<literal>no_path_retry</literal>設定以上にすることを強くお勧めします。
   </para>
   <para>
    ストレージサブシステムの<literal>dev_los_tmo</literal>の推奨設定は、次のとおりです。
   </para>
<screen>&lt;dev_loss_tmo&gt; = &lt;no_path_retry&gt; * &lt;polling_interval&gt;</screen>
   <para>
    マルチパス値については、次の定義が適用されます。
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      <literal>no_path_retry</literal>は、パスが失われたとみなされて入出力のキューイングが停止されるまでのマルチパス入出力の再試行数です。
     </para>
    </listitem>
    <listitem>
     <para>
      <literal>polling_interval</literal>は、パッチチェックの間隔(秒単位)です。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    これらの各マルチパス値は、<filename>/etc/multipath.conf</filename>環境設定ファイルから設定する必要があります。詳細については、「<xref linkend="sec-multipath-conf-file" xrefstyle="SectTitleOnPage"/>」を参照してください。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-multipath-trouble">
  <title>MPIOのトラブルシューティング</title>

  <para>
   本項では、MPIOに関するいくつかの既知の問題と、考えられる解決手段について説明します。
  </para>

  <sect2 xml:id="sec-multipath-trouble-grub2">
   <title>マルチパスデバイスへのGRUB2のインストール</title>
   <para>
    Btrfsを使用したレガシBIOSシステムでは、許可がないため<command>grub2-install</command>が失敗する可能性があります。<emphasis></emphasis>これを修正するには、<filename>/boot/grub2/<replaceable>SUBDIR</replaceable>/</filename>サブボリュームが読み書き(rw)モードでマウントされるようにしてください。<replaceable>SUBDIR</replaceable>は<literal>x86_64-efi</literal>または<literal>i386-pc</literal>にできます。
   </para>
  </sect2>

  <sect2 xml:id="sec-multipath-trouble-root">
   <title>マルチパスが有効な場合、ブート時にシステムが終了して緊急シェルが起動する</title>
   <para>
    ブート中にシステムが終了して緊急シェルが起動し、次のようなメッセージが表示されます。
   </para>
<screen>[  OK  ] Listening on multipathd control socket.
         Starting Device-Mapper Multipath Device Controller...
[  OK  ] Listening on Device-mapper event daemon FIFOs.
         Starting Device-mapper event daemon...
         Expecting device dev-disk-by\x2duuid-34be48b2\x2dc21...32dd9.device...
         Expecting device dev-sda2.device...
[  OK  ] Listening on udev Kernel Socket.
[  OK  ] Listening on udev Control Socket.
         Starting udev Coldplug all Devices...
         Expecting device dev-disk-by\x2duuid-1172afe0\x2d63c...5d0a7.device...
         Expecting device dev-disk-by\x2duuid-c4a3d1de\x2d4dc...ef77d.device...
[  OK  ] Started Create list of required static device nodes ...current kernel.
         Starting Create static device nodes in /dev...
[  OK  ] Started Collect Read-Ahead Data.
[  OK  ] Started Device-mapper event daemon.
[  OK  ] Started udev Coldplug all Devices.
         Starting udev Wait for Complete Device Initialization...
[  OK  ] Started Replay Read-Ahead Data.
         Starting Load Kernel Modules...
         Starting Remount Root and Kernel File Systems...
[  OK  ] Started Create static devices
[*     ] (1 of 4) A start job is running for dev-disk-by\x2du...(7s / 1min 30s)
[*     ] (1 of 4) A start job is running for dev-disk-by\x2du...(7s / 1min 30s)

...

Timed out waiting for device dev-disk-by\x2duuid-c4a...cfef77d.device.
[DEPEND] Dependency failed for /opt.
[DEPEND] Dependency failed for Local File Systems.
[DEPEND] Dependency failed for Postfix Mail Transport Agent.
Welcome to emergency shell
Give root password for maintenance
(or press Control-D to continue):</screen>
    <para>
     このステージでは、initrd環境から一時的に<command>dracut</command>緊急シェルを使用しています。以下で説明される設定の変更を永続的にするには、インストールされたシステムの環境で実行する必要があります。
    </para>
    <procedure>
     <step>
      <para>
       システムのルート(<filename>/</filename>)ファイルシステムを識別します。<filename>/proc/cmdline</filename>のコンテンツを調べて、<option>root=</option>パラメータを探します。
      </para>
     </step>
     <step>
      <para>
       ルートファイルシステムがマウントされているかどうかを確認します。
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl status sysroot.mount</screen>
      <tip>
       <para>
        <command>dracut</command>はデフォルトで<filename>/sysroot</filename>の下にルートファイルシステムをマウントします。
       </para>
      </tip>
      <para>
       これからは、<filename>/sysroot</filename>の下にルートファイルシステムがマウントされていることを前提とします。
      </para>
     </step>
     <step>
      <para>
       <filename>/sysroot</filename>の下にシステムが必要とするファイルシステムをマウントし、<command>chroot</command>を実行してから、すべてのファイルシステムをマウントします。例:
      </para>
<screen>
<prompt>&gt; </prompt><command>sudo</command> for x in proc sys dev run; do mount --bind /$x /sysroot/$x; done
<prompt>&gt; </prompt><command>sudo</command> chroot /sysroot /bin/bash
<prompt>&gt; </prompt><command>sudo</command> mount -a
</screen>
      <para>
       詳細については、<xref linkend="sec-trouble-data-recover-rescue-access"/>を参照してください。
      </para>
     </step>
     <step>
      <para>
       次の手順で提示されているように、マルチパスまたはdracut設定に変更を行います。変更を含めるように<filename>initrd</filename>を再構築してください。
      </para>
     </step>
     <step>
      <para>
       <command>exit</command>コマンドを入力して<command>chroot</command>環境を終了し、緊急シェルを終了して、<keycombo><keycap function="control"/>
       <keycap>D</keycap></keycombo>を押してサーバを再起動します。
      </para>
     </step>
    </procedure>

   <procedure xml:id="pro-multipath-trouble-root-blacklist">
    <title>緊急シェル: ファイルシステムのブラックリスト化</title>
    <para>
     この修正は、ルートファイルシステムがマルチパス上にないにもかかわらずマルチパスが有効になっている場合に必要です。このようなセットアップの場合、マルチパスはブラックリスト化されていないすべてのデバイスに対してパスを設定しようとします。ルートファイルシステムがあるデバイスは既にマウントされているためマルチパスではアクセスできず、これが失敗の原因になります。この問題を修復するには、<filename>/etc/multipath.conf</filename>でルートデバイスをブラックリスト化して、マルチパスを正しく設定します。
    </para>
    <step>
     <para>
      緊急シェルで<command>multipath -v2</command>を実行し、ルートファイルシステムのデバイスを特定します。この結果、次のような出力が表示されます。
     </para>
<screen><prompt role="root"># </prompt>multipath -v2
Dec 18 10:10:03 | 3600508b1001030343841423043300400: ignoring map</screen>
     <para>
      <literal>| </literal>～<literal>:</literal>の間の文字列が、ブラックリスト化に必要なWWIDです。
     </para>
    </step>
    <step>
     <para>
      <filename>/etc/multipath.conf</filename>を開いて以下を追加します。
     </para>
<screen>blacklist {
  wwid "<replaceable>WWID</replaceable>"
}</screen>
     <para>
      <replaceable>WWID</replaceable>は、前の手順で取得したIDに置き換えます。詳細については、<xref linkend="sec-multipath-blacklist"/>を参照してください。
     </para>
    </step>
    <step>
     <para>
      次のコマンドを使用して<systemitem>initrd</systemitem>を再構築します。
     </para>
<screen><prompt>&gt; </prompt>dracut -f --add-multipath</screen>
    </step>
   </procedure>
   <procedure xml:id="pro-multipath-trouble-root-initrd">
    <title>緊急シェル: <filename>initrd</filename>の再構築</title>
    <para>
     この修正は、［マルチパスの状態］(有効または無効)が<filename>initrd</filename>とシステムの間で異なる場合に必要です。修正するには、<filename>initrd</filename>を再構築します。
    </para>
    <step>
     <para>
      システムでマルチパスが<emphasis></emphasis>「有効」になっている場合、次のコマンドを使用し、マルチパスサポートを指定してinitrdを再構築します。
     </para>
<screen><prompt>&gt; </prompt>dracut --force --add multipath</screen>
     <para>
      システムでマルチパスが<emphasis></emphasis>「無効」になっている場合、次のコマンドを使用し、マルチパスサポートを指定してinitrdを再構築します。
     </para>
<screen><prompt>&gt; </prompt>dracut --force -o multipath</screen>
    </step>
   </procedure>
   <procedure xml:id="pro-multipath-trouble-root-drivers">
    <title>緊急シェル: <filename>initrd</filename>の再構築</title>
    <para>
     この修正は、initrdにNetwork Attached Storageアクセス用のドライバが含まれていない場合に必要です。たとえば、マルチパスを設定せずにシステムをインストールした場合や、各ハードウェアを追加または交換する場合などが該当します。
    </para>
    <step>
     <para>
      必要なドライバをファイル<filename>/etc/dracut.conf.d/01-dist.conf</filename>内の変数<envar>force_drivers</envar>に追加します。たとえば、システムに<filename>hpsa</filename>ドライバでアクセスされるRAIDコントローラがあり、qla23xxドライバでアクセスされるQlogicコントローラにマルチパスデバイスが接続されている場合は、次のようなエントリになります。
     </para>
<screen>force_drivers+="hpsa qla23xx"</screen>
    </step>
    <step>
     <para>
      次のコマンドを使用して<systemitem>initrd</systemitem>を再構築します。
     </para>
<screen><prompt>&gt; </prompt>dracut -f --add-multipath</screen>
    </step>
    <step>
     <para>
      ネットワークストレージの接続に失敗した場合にシステムが緊急モードでブートしないようにするため、<literal>/etc/fstab</literal>の各エントリにマウントオプション<filename>_netdev</filename>を追加することをお勧めします。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec-multipath-trouble-prio-fail">
   <title>マルチパス0.4.9以降への更新後に、個別デバイスのprio設定が失敗する</title>
   <para>
    バージョン 0.4.9以降のマルチパスツールでは、<literal>/etc/multipath.conf</literal>ファイルの<literal>defaults{}</literal>セクションまたは<literal>devices{}</literal>セクションの<filename>prio</filename>設定を使用します。キーワード<literal>prio</literal>が、<literal>multipath{)</literal>セクションの個別の<literal>multipaths</literal>定義に指定された場合は、暗黙のうちに無視されます。
   </para>
   <para>
    マルチパスツール0.4.8では、<literal>multipaths{)</literal>セクションの個別の<literal>multipath</literal>定義内のprio設定で、<literal>defaults{}</literal>または<literal>devices{}</literal>セクションの<literal>prio</literal>設定を上書きすることができました。
   </para>
  </sect2>

  <sect2 xml:id="sec-multipath-trouble-prio-argument-fail">
   <title>multipath-tools-0.4.9以降への更新後に、引数を伴うprio設定が失敗する</title>
   <para>
    <filename>multipath-tools-0.4.8</filename>から<filename>multipath-tools-0.4.9</filename>に更新すると、引数を必要とするPrioritizerの場合、<literal>/etc/multipath.conf</literal>ファイル内の<filename>prio</filename>設定が壊れます。multipath-tools-0.4.9では、Prioritizerの指定には<literal>prio</literal>キーワードが使われ、引数を必要とするPrioritizerの指定には、<literal>prio_args</literal>キーワードが使われます。これまでは、Prioritizerとその引数はいずれも、同じ<literal>prio</literal>行で指定していました。
   </para>
   <para>
    たとえば、multipath-tools-0.4.8では、次の行を使用してPrioritizerとその引数を同じ行で指定していました。
   </para>
<screen>prio "weightedpath hbtl [1,3]:.:.+:.+ 260 [0,2]:.:.+:.+ 20"</screen>
   <para>
    multipath-tools-0.4.9以降への更新後は、このコマンドを使用するとエラーになります。メッセージの例を以下に示します。
   </para>
<screen>&lt;Month day hh:mm:ss&gt; | Prioritizer 'weightedpath hbtl [1,3]:.:.+:.+ 260
[0,2]:.:.+:.+ 20' not found in /lib64/multipath</screen>
   <para>
    この問題を解決するには、テキストエディタで、<literal>/etc/multipath.conf</literal>ファイル内の<filename>prio</filename>行を変更します。2つの行を作成して、<filename>prio</filename>行にPrioritizerを指定し、その下の<filename>prio_args</filename>行にPrioritizerの引数を指定します。
   </para>
<screen>prio "weightedpath"
prio_args "hbtl [1,3]:.:.+:.+ 260 [0,2]:.:.+:.+ 20"</screen>
   <para>
    <command>sudo systemctl restart multipathd</command> を実行して<systemitem class="daemon">multipathd</systemitem>デーモンを再起動し、変更を有効にします。
   </para>
  </sect2>

  <sect2 xml:id="sec-multipath-trouble-tids">
   <title>技術情報ドキュメント</title>
   <para>
    SUSE Linux Enterprise ServerのマルチパスI/Oの問題のトラブルシューティングについては、SUSEナレッジベースにある、次のTID (技術情報ドキュメント)を参照してください。
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      <link xlink:href="https://www.suse.com/support/kb/doc.php?id=3617600"><citetitle>Using LVM on local and SAN attached devices</citetitle></link>
     </para>
    </listitem>
    <listitem>
     <para>
      <link xlink:href="https://www.suse.com/support/kb/doc.php?id=7007498"><citetitle>Using LVM on Multipath (DM MPIO) Devices</citetitle></link>
     </para>
    </listitem>
    <listitem>
     <para>
      <link xlink:href="https://www.suse.com/support/kb/doc.php?id=7009660"><citetitle>HOWTO: Add, Resize and Remove LUN without restarting SLES</citetitle></link>
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
 </sect1>
</chapter>
