<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="vt_qemu_ga.xml" version="5.0" xml:id="cha-qemu-ga">
 <info>
  <title>QEMU Guest 代理</title>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <para>
  QEMU Guest 代理 (GA) 在 VM Guest 中运行，使 VM 主机服务器能够通过 <systemitem class="library">libvirt</systemitem> 在 Guest 操作系统中运行命令。它支持许多功能 — 例如，获取有关 Guest 文件系统的细节、冻结和解冻文件系统，或者挂起或重引导 Guest。
 </para>
 <para>
  QEMU GA 包含在 <package>qemu-guest-agent</package> 软件包中，默认已在 KVM 虚拟机上安装、配置并激活。
 </para>
 <para>
  QEMU GA 安装在 Xen 虚拟机中，但默认未激活。尽管可以将 QEMU GA 与 Xen 虚拟机配合使用，但无法使用如下所述的适用于 KVM 虚拟机的 libvirt 命令来实现集成。要将 QEMU GA 与 Xen 配合使用，必须将一个通道设备添加到 VM Guest 配置。该通道设备包含 VM 主机服务器上用来与 QEMU GA 通讯的的 Unix 域套接字路径。
 </para>
<screen>&lt;channel type='unix'&gt;
  &lt;source mode='bind' path='/example/path'/&gt;
  &lt;target type='xen' name='org.qemu.guest_agent.0'/&gt;
&lt;/channel&gt;</screen>

 <sect1 xml:id="cha-qemu-ga-libvirt-general">
  <title>运行 QEMU GA 命令</title>

  <para>
   QEMU GA 包含的许多本机命令没有直接对应的 <systemitem class="library">libvirt</systemitem> 命令。请参见<xref linkend="cha-qemu-ga-moreinfo"/>查看完整列表。您可以使用 <systemitem class="library">libvirt</systemitem> 的通用命令 <command>qemu-agent-command</command> 来运行所有 QEMU GA 命令：
  </para>

<screen>virsh qemu-agent-command <replaceable>DOMAIN_NAME</replaceable> '{"execute":"<replaceable>QEMU_GA_COMMAND</replaceable>"}'</screen>

  <para>
   例如：
  </para>

<screen><prompt>&gt; </prompt><command>sudo</command> virsh qemu-agent-command sle15sp2 '{"execute":"guest-info"}' --pretty
{
"return": {
  "version": "4.2.0",
  "supported_commands": [
    {
      "enabled": true,
      "name": "guest-get-osinfo",
      "success-response": true
    },
[...]
</screen>
 </sect1>
 <sect1 xml:id="cha-qemu-ga-commands">
  <title>需要 QEMU GA 的 <command>virsh</command> 命令</title>

  <para>
   有多个 <command>virsh</command> 命令需要 QEMU GA 才能实现其功能。其中包括：
  </para>

  <variablelist>
   <varlistentry>
    <term><command>virsh guestinfo</command></term>
    <listitem>
     <para>
      从 Guest 的角度列显有关该 Guest 的信息。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>virsh guestvcpus</command></term>
    <listitem>
     <para>
      从 Guest 的角度查询或更改虚拟 CPU 的状态。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>virsh set-user-password</command></term>
    <listitem>
     <para>
      为 Guest 中的用户帐户设置口令。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>virsh domfsinfo</command></term>
    <listitem>
     <para>
      显示正在运行的域中挂载的文件系统列表。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>virsh dompmsuspend</command></term>
    <listitem>
     <para>
      挂起正在运行的 Guest。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="cha-qemu-ga-libvirt">
  <title>增强 <systemitem class="library">libvirt</systemitem> 命令</title>

  <para>
   如果在 Guest 中启用了 QEMU GA，一些 <command>virsh</command> 子命令在以<emphasis>代理</emphasis>模式运行时，其功能会得到增强。下面的列表仅包含部分此类子命令示例。有关完整列表，请参见 <command>virsh</command> 手册页并搜索 <literal>agent</literal> 字符串。
  </para>

  <variablelist>
   <varlistentry>
    <term><command>virsh shutdown --mode agent</command> 和 <command>virsh reboot --mode agent</command></term>
    <listitem>
     <para>
      这种关机或重引导方法类似于 ACPI 方法，可让 Guest 为下次运行保持干净状态。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>virsh domfsfreeze</command> 和 <command>virsh domfsthaw</command></term>
    <listitem>
     <para>
      指示 Guest 将其文件系统保持静止状态 — 刷新缓存中的所有 I/O 操作并将卷保持一致状态，以便在重新挂载卷时无需进行任何检查。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>virsh setvcpus --guest</command></term>
    <listitem>
     <para>
      更改指派给 Guest 的 CPU 数量。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>virsh domifaddr --source agent</command></term>
    <listitem>
     <para>
      在 QEMU GA 中查询 Guest 的 IP 地址。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>virsh vcpucount --guest</command></term>
    <listitem>
     <para>
      从 Guest 的角度列显有关虚拟 CPU 计数的信息。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="cha-qemu-ga-moreinfo">
  <title>更多信息</title>

  <itemizedlist>
   <listitem>
    <para>
     <link xlink:href="https://www.qemu.org/docs/master/interop/qemu-ga-ref.html"/> 上提供了 QEMU GA 支持的命令的完整列表。
    </para>
   </listitem>
   <listitem>
    <para>
     <command>virsh</command> 手册页 (<command>man 1 virsh</command>) 包含支持 QEMU GA 界面的命令的说明。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
