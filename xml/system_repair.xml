<?xml version="1.0" encoding="UTF-8"?>
<sect3 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="system_repair.xml" version="5.0" xml:id="sec.trouble.data.recover.rescue">
 <title>Verwenden des Rettungssystems</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>Ja</dm:translation>
  </dm:docmanager>
 </info><indexterm>
 <primary>Rettungssystem</primary></indexterm><indexterm>
 <primary>System</primary>
 <secondary>Rettung</secondary></indexterm>
 <para>
  Ein System kann aus mehreren Gründen nicht aktiviert und ordnungsgemäß betrieben werden. Zu den häufigsten Gründen zählen ein beschädigtes Dateisystem nach einem Systemabsturz, beschädigte Konfigurationsdateien oder eine beschädigte Bootloader-Konfiguration.
 </para>
 <para>
  Zum Beheben dieser Situationen bietet <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> ein Rettungssystem, das Sie booten können. Das Rettungssystem ist ein kleines Linux-System, das auf einen RAM-Datenträger geladen und als Root-Dateisystem eingehängt werden kann. Es ermöglicht Ihnen so den externen Zugriff auf Ihre Linux-Partitionen. Mithilfe des Rettungssystems kann jeder wichtige Aspekt Ihres Systems wiederhergestellt oder geändert werden.
 </para>
 <itemizedlist mark="bullet" spacing="normal">
  <listitem>
   <para>
    Jede Art von Konfigurationsdatei kann bearbeitet werden.
   </para>
  </listitem>
  <listitem>
   <para>
    Das Dateisystem kann auf Fehler hin überprüft und automatische Reparaturvorgänge können gestartet werden.
   </para>
  </listitem>
  <listitem>
   <para>
    Der Zugriff auf das installierte System kann in einer <quote>change-root</quote>-Umgebung erfolgen.
   </para>
  </listitem>
  <listitem>
   <para>
    Die Bootloader-Konfiguration kann überprüft, geändert und neu installiert werden.
   </para>
  </listitem>
  <listitem>
   <para>
    Eine Wiederherstellung ab einem fehlerhaft installierten Gerätetreiber oder einem nicht verwendbaren Kernel kann durchgeführt werden.
   </para>
  </listitem>
  <listitem>
   <para>
    Die Größe von Partitionen kann mithilfe des parted-Kommandos verändert werden. Weitere Informationen zu diesem Werkzeug finden Sie auf der Website von GNU Parted (<link xlink:href="http://www.gnu.org/software/parted/parted.html"/>).
   </para>
  </listitem>
 </itemizedlist>
 <para>
  Das Rettungssystem kann aus verschiedenen Quellen und von verschiedenen Speicherorten geladen werden. Am einfachsten lässt sich das Rettungssystem vom Original-Installationsmedium booten.
 </para>

 <procedure><indexterm>
  <primary> Rettungssystem</primary>
  <secondary>Start vom Medium</secondary></indexterm>
  <step>
   <para>
    Legen Sie das Installationsmedium in Ihr DVD-Laufwerk ein.
   </para>
  </step>
  <step>
   <para>
    Booten Sie das System neu.
   </para>
  </step>
  <step>
   <para>
    Drücken Sie im Boot-Fenster <keycap>F4</keycap> und wählen Sie <guimenu>DVD-ROM</guimenu>. Wählen Sie dann im Hauptmenü die Option <guimenu>Rettungssystem</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Geben Sie an der Eingabeaufforderung <literal>Rescue:</literal><literal>root</literal> ein. Ein Passwort ist nicht erforderlich.
   </para>
  </step>
 </procedure>
 <procedure xml:id="proc.trouble.data.recover.rescue.network"><indexterm>
  <primary> Rettungssystem </primary>
  <secondary>Start von Netzwerkquelle</secondary></indexterm>
  <para>
   Wenn Ihnen kein DVD-Laufwerk zur Verfügung steht, können Sie das Rettungssystem von einer Netzwerkquelle booten. Das nachfolgende Beispiel bezieht sich auf das entfernte Booten – wenn Sie ein anderes Boot-Medium verwenden, beispielsweise eine DVD, ändern Sie die Datei <filename>info</filename> entsprechend, und führen Sie den Boot-Vorgang wie bei einer normalen Installation aus.
  </para>
  <step>
   <para>
    Geben Sie die Konfiguration Ihres PXE-Boot-Setups ein und fügen Sie die Zeilen <literal>install=<replaceable>protocol</replaceable>://<replaceable>instsource</replaceable></literal> und <literal>rescue=1</literal> hinzu. Wenn das Reparatursystem gestartet werden soll, verwenden Sie stattdessen <literal>repair=1</literal>. Wie bei einer normalen Installation steht <replaceable>Protokoll</replaceable> für eines der unterstützten Netzwerkprotokolle (NFS, HTTP, FTP usw.) und <replaceable>Instquelle</replaceable> für den Pfad zur Netzwerkinstallationsquelle.
   </para>
  </step>
  <step>
   <para>
    Booten Sie das System mit <quote>Wake on LAN</quote><phrase os="sles;sled">, wie im <xref linkend="sec.deployment.prep_boot.wol"/></phrase> erläutert.
   </para>
  </step>
  <step>
   <para>
    Geben Sie an der Eingabeaufforderung <literal>Rescue:</literal><literal>root</literal> ein. Ein Passwort ist nicht erforderlich.
   </para>
  </step>
 </procedure>
 <para>
  Sobald Sie sich im Rettungssystem befinden, können Sie die virtuellen Konsolen verwenden, die über die Tasten <keycombo><keycap function="alt"/><keycap>F1</keycap></keycombo> bis <keycombo><keycap function="alt"/><keycap>F6</keycap></keycombo> aufgerufen werden.
 </para>
 <para>
  Eine Shell und viele andere hilfreiche Dienstprogramme, beispielsweise das mount-Programm, stehen im Verzeichnis <filename>/bin</filename> zur Verfügung. Das Verzeichnis <filename>/sbin</filename> enthält wichtige Datei- und Netzwerkdienstprogramme, mit denen das Dateisystem überprüft und repariert werden kann. In diesem Verzeichnis finden Sie auch die wichtigsten Binärdateien für die Systemwartung, beispielsweise <command>fdisk</command>, <command>mkfs</command>, <command>mkswap</command>, <command>mount</command> und <command>shutdown</command>, <command>ip</command> und <command>ss</command> für die Netzwerkwartung. Das Verzeichnis <filename>/usr/bin</filename> enthält den vi-Editor, find, less sowie SSH.
 </para>
 <para>
  Die Systemmeldungen können über das Kommando <command>dmesg </command> angezeigt werden; mit <command>journalctl</command> rufen Sie das Systemprotokoll ab.
 </para>
 <sect4 xml:id="sec.trouble.data.recover.rescue.file">
  <title>Überprüfen und Bearbeiten von Konfigurationsdateien</title>
  <para>
   Als Beispiel für eine Konfiguration, die mithilfe des Rettungssystems repariert werden kann, soll eine beschädigte Konfigurationsdatei dienen, die das ordnungsgemäße Booten des Systems verhindert. Dieses Problem kann mit dem Rettungssystem behoben werden.
  </para>
  <procedure>
   <para>
    Gehen Sie zum Bearbeiten einer Konfigurationsdatei folgendermaßen vor:
   </para>
   <step>
    <para>
     Starten Sie das Rettungssystem mithilfe einer der oben erläuterten Methoden.
    </para>
   </step>
   <step>
    <para>
     Verwenden Sie zum Einhängen eines Root-Dateisystems unter <filename>/dev/sda6</filename> in das Rettungssystem folgendes Kommando:
    </para>
<screen>mount /dev/sda6 /mnt</screen>
    <para>
     Sämtliche Verzeichnisse des Systems befinden sich nun unter <filename>/mnt</filename>
    </para>
   </step>
   <step>
    <para>
     Wechseln Sie in das eingehängte Root -Dateisystem:
    </para>
<screen>cd /mnt</screen>
   </step>
   <step>
    <para>
     Öffnen Sie die fehlerhafte Konfigurationsdatei im vi-Editor. Passen Sie die Konfiguration an und speichern Sie sie.
    </para>
   </step>
   <step>
    <para>
     Hängen Sie das Root-Dateisystem aus dem Rettungssystem aus:
    </para>
<screen>umount /mnt</screen>
   </step>
   <step>
    <para>
     Booten Sie den Computer neu.
    </para>
   </step>
  </procedure>
 </sect4>
 <sect4 xml:id="sec.trouble.data.recover.rescue.filesystem">
  <title>Reparieren und Überprüfen von Dateisystemen</title><indexterm>
  <primary> Dateisysteme</primary>
  <secondary> Reparieren</secondary></indexterm>
  <para>
   Generell ist das Reparieren von Dateisystemen auf einem zurzeit aktiven System nicht möglich. Bei ernsthaften Problemen ist möglicherweise nicht einmal das Einhängen Ihres Root-Dateisystems möglich und das Booten des Systems endet unter Umständen mit einer so genannten <quote>Kernel-Panic</quote>. In diesem Fall ist nur die externe Reparatur des Systems möglich. Das System enthält die Dienstprogramme für die Überprüfung und Reparatur der Dateisysteme <literal>btrfs</literal>, <literal>ext2</literal>, <literal>ext3</literal>, <literal>ext4</literal>, <literal>reiserfs</literal>, <literal>xfs</literal>, <literal>dosfs</literal> und <literal>vfat</literal>. Nutzen Sie das Kommando <command>fsck.</command> <replaceable>FILESYSTEM</replaceable>; wenn Sie beispielsweise eine Dateisystemprüfung für <literal>btrfs</literal> ausführen möchten, verwenden Sie <command>fsck.btrfs</command>.
  </para>

 </sect4>
 <sect4 xml:id="sec.trouble.data.recover.rescue.access">
  <title>Zugriff auf das installierte System</title>
  <para>
   Wenn Sie vom Rettungssystem aus auf das installierte System zugreifen müssen, ist dazu eine <emphasis>change-root</emphasis>-Umgebung erforderlich. Beispiele: Bearbeiten der Bootloader-Konfiguration oder Ausführen eines Dienstprogramms zur Hardwarekonfiguration.
  </para>
  <para>
   Gehen Sie zur Einrichtung einer change-root-Umgebung, die auf dem installierten System basiert, folgendermaßen vor:
  </para>
  <procedure>
   <step>
    <para>
     Ermitteln Sie mit <command>lsblk</command>, welcher Knoten zur Stammpartition gehört. Im Beispiel ist dies <filename>/dev/sda2</filename>:
    </para>
<screen>lsblk
NAME        MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT
sda           8:0    0 149,1G  0 disk
├─sda1        8:1    0     2G  0 part  [SWAP]
├─sda2        8:2    0    20G  0 part  /
└─sda3        8:3    0   127G  0 part
  └─cr_home 254:0    0   127G  0 crypt /home</screen>
   </step>
   <step>
    <para>
     Hängen Sie die Stammpartition vom installierten System aus ein:
    </para>
<screen>mount /dev/sda2 /mnt</screen>
   </step>
   <step>
    <para>
     Hängen Sie die Partitionen <filename>/proc</filename>, <filename>/dev</filename> und <filename>/sys</filename> ein:
    </para>
<screen>mount -t proc none /mnt/proc
mount --rbind /dev /mnt/dev
mount --rbind /sys /mnt/sys</screen>
   </step>
   <step>
    <para>
     Nun können Sie per <quote>change root</quote> in die neue Umgebung wechseln und dabei die <systemitem>bash</systemitem>-Shell beibehalten:
    </para>
<screen>chroot /mnt /bin/bash</screen>
   </step>
   <step>
    <para>
     Abschließend hängen Sie die restlichen Partitionen vom installierten System ein:
    </para>
<screen>mount -a</screen>
   </step>
   <step>
    <para>
     Nun können Sie auf das installierte System zugreifen. Hängen Sie vor dem Reboot des Systems die Partitionen mit <command>umount</command> <option>-a</option> aus und verlassen Sie die <quote>change-root</quote>-Umgebung mit <command>exit</command>.
    </para>
   </step>
  </procedure>
  <warning>
   <title>Einschränkungen</title>
   <para>
    Obwohl Sie über uneingeschränkten Zugriff auf die Dateien und Anwendungen des installierten Systems verfügen, gibt es einige Beschränkungen. Der Kernel, der ausgeführt wird, ist der Kernel, der mit dem Rettungssystem gebootet wurde, nicht mit der change-root-Umgebung. Er unterstützt nur essenzielle Hardware und das Hinzufügen von Kernel-Modulen über das installierte System ist nur möglich, wenn die Kernel-Versionen genau übereinstimmen. Überprüfen Sie immer die Version des aktuell ausgeführten (Rettungssytem-) Kernels mit <command>uname -r</command> und stellen Sie fest, ob im Verzeichnis <filename>/lib/modules</filename> in der change-root-Umgebung passende Unterverzeichnisse vorhanden sind. Wenn dies der Fall ist, können Sie die installierten Module verwenden. Andernfalls müssen Sie diese in den richtigen Version von einem anderen Medium, z. B. einem Flash-Laufwerk, bereitstellen. In den meisten Fällen weicht die Kernel-Version des Rettungssystems von der des installierten ab – dann können Sie z. B. nicht einfach auf eine Soundkarte zugreifen. Der Aufruf einer grafischen Bedienoberfläche ist ebenfalls nicht möglich.
   </para>
   <para>
    Beachten Sie außerdem, dass Sie die <quote>change-root</quote>-Umgebung verlassen, wenn Sie die Konsole mit <keycombo><keycap function="alt"/><keycap>F1</keycap></keycombo> bis <keycombo><keycap function="alt"/><keycap>F6</keycap></keycombo> umschalten.
   </para>
  </warning>
 </sect4>
 <sect4 xml:id="sec.trouble.data.recover.rescue.grub">
  <title>Bearbeiten und erneutes Installieren des Bootloaders</title>
  <para>
   In einigen Fällen kann ein System aufgrund einer beschädigten Bootloader-Konfiguration nicht gebootet werden. Die Start-Routinen sind beispielsweise nicht in der Lage, physische Geräte in die tatsächlichen Speicherorte im Linux-Dateisystem zu übersetzen, wenn der Bootloader nicht ordnungsgemäß funktioniert.
  </para>
  <para>
   Gehen Sie wie folgt vor, um die Bootloader-Konfiguration zu überprüfen und den Bootloader neu zu installieren:
  </para>
  <procedure>
   <step>
    <para>
     Führen Sie die unter <xref linkend="sec.trouble.data.recover.rescue.access"/> erläuterten erforderlichen Schritte für den Zugriff auf das installierte System aus.
    </para>
   </step>
   <step>
    <para>
     Prüfen Sie, ob der GRUB 2-Bootloader auf dem System installiert ist. Falls nicht, installieren Sie das Paket <systemitem>grub2</systemitem> und führen Sie Folgendes aus:
    </para>
<screen>grub2-install /dev/sda</screen>
   </step>
   <step>
    <para>
     Prüfen Sie, ob die nachfolgend angegebenen Dateien gemäß den in <xref linkend="cha.grub2"/> erläuterten GRUB 2-Konfigurationsgrundlagen ordnungsgemäß konfiguriert sind, und wenden Sie gegebenenfalls die Fehlerbehebungen an.
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       <filename>/etc/default/grub</filename>
      </para>
     </listitem>
     <listitem>
      <para>
       <filename>/boot/grub2/device.map</filename> (optionale Datei; nur vorhanden, wenn sie manuell erstellt wurde)
      </para>
     </listitem>
     <listitem>
      <para>
       <filename>/boot/grub2/grub.cfg</filename> (diese Datei wird automatisch generiert; nicht bearbeiten)
      </para>
     </listitem>
     <listitem>
      <para>
       <filename>/etc/sysconfig/bootloader</filename>
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     Installieren Sie den Bootloader mit folgender Befehlssequenz neu:
    </para>
<screen>grub2-mkconfig -o /boot/grub2/grub.cfg</screen>
   </step>
   <step>
    <para>
     Hängen Sie die Partitionen aus, melden Sie sich von der <quote>change-root</quote>-Umgebung ab und führen Sie den Reboot des Systems durch:
    </para>
<screen>umount -a
exit
reboot</screen>
   </step>
  </procedure>
 </sect4>
 <sect4 xml:id="sec.trouble.data.recover.rescue.dud">
  <title>Korrektur der Kernel-Installation</title>
  <para>
   Ein Kernel-Update kann einen neuen Fehler verursachen, der sich auf Ihr System auswirken kann. Es kann z. B. ein Treiber für eine Hardwarekomponente in Ihrem System falsch sein, weshalb Sie nicht auf die Komponente zugreifen und diese nicht verwenden können. Kehren Sie in diesem Fall zum letzten funktionierenden Kernel zurück (sofern er im System verfügbar ist) oder installieren Sie den Original-Kernel vom Installationsmedium.
  </para>
  <tip>
   <title>So erhalten Sie die aktuellsten Kernels nach dem Update</title>
   <para>
    Um Fehler beim Booten durch eine fehlerhaften Kernel-Aktualisierung zu vermeiden, können Sie die Multiversionsfunktion für Kernel nutzen und <systemitem>libzypp</systemitem> mitteilen, welche Kernel Sie nach der Aktualisierung erhalten möchten.
   </para>
   <para>
    Damit z. B. immer die beiden letzten Kernels und der aktuell ausgeführte erhalten bleiben, fügen Sie
   </para>
<screen>multiversion.kernels = latest,latest-1,running</screen>
   <para>
    zur Datei <filename>/etc/zypp/zypp.conf</filename> hinzu. Weitere Informationen finden Sie in <xref linkend="cha.tuning.multikernel"/>.
   </para>
  </tip>
  <para>
   Ähnlich verhält es sich, wenn Sie einen defekten Treiber für ein nicht durch <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> unterstütztes Gerät neu installieren oder aktualisieren müssen. Wenn z. B. ein Hardwarehersteller ein bestimmtes Gerät verwendet, wie einen Hardware-RAID-Controller, für den es erforderlich ist, dass ein Binärtreiber durch das Betriebssystem erkannt wird. Der Hersteller veröffentlicht in der Regel ein Treiberupdate (DUD) mit der korrigierten oder aktualisierten Version des benötigten Treibers.
  </para>
  <para>
   In beiden Fällen müssen Sie im Rettungsmodus auf das installierte System zugreifen und das mit dem Kernel zusammenhängende Problem beheben, da das System andernfalls nicht korrekt booten wird:
  </para>
  <procedure>
   <step>
    <para>
     Booten Sie von den <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase>-Installationsmedien.
    </para>
   </step>
   <step>
    <para>
     Überspringen Sie diese Schritt, wenn Sie eine Wiederherstellung nach einer fehlerhaften Kernel-Aktualisierung durchführen. Wenn Sie eine Driver Update Disk (DUD) verwenden, drücken Sie <keycap>F6</keycap>, um die Treiberaktualisierung nach der Anzeige des Bootmenüs zu laden, wählen Sie den Pfad oder die URL für die Treiberaktualisierung aus und bestätigen Sie die Auswahl mit <guimenu>Ja</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Wählen Sie im Bootmenü den Eintrag <guimenu>Rettungssystem</guimenu>, und drücken Sie <keycap function="enter"/>. Wenn Sie eine DUD verwenden, werden Sie aufgefordert, den Speicherplatz der Treiberaktualisierung anzugeben.
    </para>
   </step>
   <step>
    <para>
     Geben Sie an der Eingabeaufforderung <literal>Rescue:</literal><literal>root</literal> ein. Ein Passwort ist nicht erforderlich.
    </para>
   </step>
   <step>
    <para>
     Hängen Sie das Zielsystem manuell ein und führen Sie <quote>change root</quote> in die neue Umgebung durch. Weitere Informationen finden Sie unter <xref linkend="sec.trouble.data.recover.rescue.access"/>.
    </para>
   </step>
   <step>
    <para>
     Wenn Sie eine DUD verwenden, installieren oder aktualisieren Sie das fehlerhafte Treiberpaket. Stellen Sie stets sicher, dass die installierte Kernel-Version exakt mit der Version des Treibers übereinstimmt, den Sie installieren möchten.
    </para>
    <para>
     Wenn Sie eine fehlerhafte Installation einer Treiberaktualisierung korrigieren, können Sie nach dem folgenden Verfahren den Originaltreiber vom Installationsmedium installieren.
    </para>
    <substeps performance="required">
     <step>
      <para>
       Identifizieren Sie Ihr DVD-Laufwerk mit <command>hwinfo --cdrom</command> und hängen Sie es mit <command>mount /dev/sr0 /mnt</command> ein.
      </para>
     </step>
     <step>
      <para>
       Navigieren Sie zum Verzeichnis, in dem Ihre Kernel-Dateien auf der DVD gespeichert sind, z. B. <command>cd /mnt/suse/x86_64/</command>.
      </para>
     </step>
     <step>
      <para>
       Installieren Sie die benötigten <systemitem>kernel-*</systemitem>-, <systemitem>kernel-*-base</systemitem>- und <systemitem>kernel-*-extra</systemitem>-Pakete mit dem Kommando <command>rpm -i</command>.
      </para>
     </step>

    </substeps>
   </step>
   <step>
    <para>
     Aktualisieren Sie Konfigurationsdateien und initialisieren Sie den Bootloader gegebenenfalls neu. Weitere Informationen finden Sie in <xref linkend="sec.trouble.data.recover.rescue.grub"/>.
    </para>
   </step>
   <step>
    <para>
     Entfernen Sie alle bootbaren Medien aus dem Systemlaufwerk und booten Sie neu.
    </para>
   </step>
  </procedure>
 </sect4>
</sect3>
