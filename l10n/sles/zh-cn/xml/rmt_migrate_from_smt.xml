<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="rmt_migrate_from_smt.xml" version="5.0" xml:id="cha-rmt-migrate">

 <title>从 SMT 迁移到 RMT</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:translation>是</dm:translation>
      </dm:docmanager>
    </info>
    <para>
  本章说明如何从 SLES 11 或 12 上的 SMT 迁移到 SLES 15 上的 RMT。
 </para>
 <sect1 xml:id="sec-rmt-migrate-notes">
  <title>重要注意事项</title>
  <warning>
   <title>请仔细阅读本节内容</title>
   <para>
    请仔细阅读本节内容。其中包含有关迁移过程的重要信息。
   </para>
  </warning>
  <variablelist>
   <varlistentry>
    <term>使用新主机</term>
    <listitem>
     <para>
      我们建议您在新安装的 SLES 15 主机上安装 RMT。RMT 并不能完全取代 SMT。RMT 具有不同于 SMT 的工作流程，仅支持注册 SUSE Linux Enterprise Server 12 及以上版本的系统。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>储存库元数据和设置</term>
    <listitem>
     <para>
      将<emphasis>不会</emphasis>导出 SMT 中的临时储存库的设置。将导出已标记为要镜像的储存库。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>自定义储存库</term>
    <listitem>
     <para>
      只能导出标记为要镜像的储存库。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>已失效订阅</term>
    <listitem>
     <para>
      RMT 上将不会提供组织订阅中已不再可用的产品。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>客户端信息</term>
    <listitem>
     <para>
      将导出系统及其激活的产品。将导出 SMT 中的 SMT 客户端作业和补丁状态。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <table xml:id="sec-rmt-migrate-notes-features">
   <title>功能对比</title>
   <tgroup cols="3">
    <colspec colnum="1" colname="1" colwidth="40*"/>
    <colspec colnum="2" colname="2" colwidth="30*"/>
    <colspec colnum="3" colname="3" colwidth="30*"/>
    <thead>
     <row>
      <entry>
       <para>
        功能
       </para>
      </entry>
      <entry>
       <para>
        SMT
       </para>
      </entry>
      <entry>
       <para>
        RMT
       </para>
      </entry>
     </row>
    </thead>
    <tbody>
     <row>
      <entry>
       <para>
        在 SLES 11 上可用
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
      <entry>
       <para>
        否
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        在 SLES 12 上可用
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
      <entry>
       <para>
        否
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        在 SLES 15 上可用
       </para>
      </entry>
      <entry>
       <para>
        否
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        将产品与 SUSE Customer Center 同步
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        从储存库镜像 RPM
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        选择性镜像（指定要镜像的产品）
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        通过 HTTP 提供 RPM
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        SLE 15 系统注册
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        SLE 12 系统注册
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        SLE 11 系统注册
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
      <entry>
       <para>
        否
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        从 SLE 12 迁移到 SLE 15
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        临时储存库
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
      <entry>
       <para>
        no<superscript>1</superscript>
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        离线镜像
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        NTLM 代理支持
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
     </row><row>
      <entry>
       <para>
        自定义储存库
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        YaST 安装向导
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        YaST 管理向导
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
      <entry>
       <para>
        否
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        客户端管理
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
      <entry>
       <para>
        否
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        RedHat 支持（扩展支持）
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        文件去重
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        将数据从 SMT 转移到 RMT
       </para>
      </entry>
      <entry>
       <para>
        无
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        将注册数据传输到 SUSE Customer Center
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
      <entry>
       <para>
        否
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        报告
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
      <entry>
       <para>
        否
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        Web 服务器的自定义 TLS 证书
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
      <entry>
       <para>
        是
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        Web 服务器
       </para>
      </entry>
      <entry>
       <para>
        Apache 2
       </para>
      </entry>
      <entry>
       <para>
        Nginx
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        平台
       </para>
      </entry>
      <entry>
       <para>
        Perl
       </para>
      </entry>
      <entry>
       <para>
        Ruby
       </para>
      </entry>
     </row>
    </tbody>
   </tgroup>
  </table>
  <para>
   1) SUSE Manager 提供的功能。
  </para>
 </sect1>
 <sect1 xml:id="sec-rmt-migrate-smt-export">
  <title>导出 SMT 数据</title>
  <procedure>
   <title>导出 SMT 数据</title>
   <step>
    <para>
     通过运行 <command>zypper up</command> 更新已安装的 SMT 服务器。
    </para>
   </step>
   <step>
    <para>
     如果您要导出 SSL 证书及其余数据，请运行 <command>smt-data-export</command>。请记得将证书存放在安全位置。
    </para>
    <para>
     如果您不想从 SMT 导出 SSL 证书，请运行 <command>smt-data-export --no-ssl-export</command>。
    </para>
   </step>
   <step>
    <para>
     导出的配置现已保存到 <filename>smt-export.<replaceable>XXXXXX</replaceable>.tar.gz</filename>。将该文件复制到新 RMT 服务器可访问的位置。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-rmt-migrate-rmt-import">
  <title>将 SMT 数据导入到 RMT</title>
  <procedure>
   <step>
    <para>
     运行 <command>zypper up</command> 以确保所安装的 RMT 为最新版本。
    </para>
   </step>
   <step>
    <para>
     将导出的 <literal>.tar.gz</literal> 文件复制到一个空目录，将其解压缩，然后进入解压缩后的文件：
    </para>
<screen><prompt>tux &gt; </prompt><command>mkdir <replaceable>EMPTY_DIR</replaceable></command>
<prompt>tux &gt; </prompt><command>cd <replaceable>EMPTY_DIR</replaceable></command>
<prompt>tux &gt; </prompt><command>tar xf <replaceable>/PATH/TO/</replaceable>smt-export.<replaceable>XXXXXX</replaceable>.tar.gz</command>
<prompt>tux &gt; </prompt><command>cd smt-export</command>
</screen>
   </step>
   <step>
    <para>
     如果您之前选择从 SMT 导出 SSL 证书，请将 CA 私用密钥和证书复制到 <filename>/etc/rmt/ssl/</filename> 中：
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> <command>cp ssl/cacert.key /etc/rmt/ssl/rmt-ca.key</command>
<prompt>tux &gt; </prompt><command>sudo</command> <command>cp ssl/cacert.pem /etc/rmt/ssl/rmt-ca.crt</command></screen>
   </step>
   <step>
    <para>
     按<xref linkend="sec-rmt-installation-yast-configuration"/>中所述运行 YaST RMT 配置模块。如果您已导入 SMT CA 证书，请将 SMT 服务器的域添加到新 SSL 证书的常用名。
    </para>
   </step>
   <step>
    <para>
     运行 RMT 同步功能以从 SUSE Customer Center 获取产品和储存库数据。
    </para>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>rmt-cli sync</command></screen>
   </step>
   <step>
    <para>
     导入来自 SMT 服务器的数据。
    </para>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>rmt-data-import -d ./</command></screen>
   </step>
   <step>
    <para>
     可选：如果 RMT 服务器的 URL 发生变化，请在 <filename>/etc/SUSEConnect</filename> 中更改客户端的 URL 参数，以指向新的 RMT 服务器。或者更改 DNS 记录以重新指派 RMT 服务器的主机名。
    </para>
   </step>
   <step>
    <para>
     可选：将 SMT 中的镜像储存库数据转移到 RMT，并调整所复制数据的所有权。
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> <command>cp -r /var/www/htdocs/repo/* /usr/share/rmt/public/repo/</command>
<prompt>tux &gt; </prompt><command>sudo</command> <command>chown -R _rmt:nginx /usr/share/rmt/public/repo</command></screen>
   </step>
   <step>
    <para>
     如果 SMT 服务器包含您要镜像到 RMT 服务器的自定义储存库，请在镜像前将其激活（它们默认处于禁用状态）。
    </para>
    <substeps>
     <step>
      <para>
       通过运行以下命令检查有无自定义储存库：
      </para>
      <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>rmt-cli repos custom list</command></screen>
      <para>
       一个列出所有自定义储存库的表格将会显示：第一列包含每个储存库的 <literal>ID</literal>，而 <literal>Mirror? </literal> 列将显示 <literal>false</literal>。
      </para>
     </step>
     <step>
      <para>
       通过运行以下命令启用您要镜像的每个自定义储存库：
      </para>
      <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>rmt-cli repos custom enable <replaceable>ID</replaceable></command></screen>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     通过启动镜像过程更新储存库中的软件包：
    </para>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>rmt-cli mirror</command></screen>
   </step>
  </procedure>
 </sect1>
</chapter>
