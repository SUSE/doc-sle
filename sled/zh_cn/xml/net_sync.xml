<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_sync.xml" version="5.0" xml:id="cha.net.sync">
 <title>使用 RSync 复制文件</title>
 <info>
  <abstract>
   <para>
    现今，很多人都在同时使用若干台计算机 — 一台在家用，一台或多台在办公室用，还可能会在途中使用便携式计算机、平板电脑或智能手机。很多文件是所有这些计算机上共同需要的。所以，您必须能在所有计算机上工作和修改文件，以便让所有计算机上都有最新版本的数据。
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>

 
 <warning>
  <title>数据丢失风险</title>
  <para>
   开始使用同步工具之前，应该先熟悉其特性和功能。请务必备份您的重要文件。
  </para>
 </warning>

 <sect1 xml:id="sec.net.sync.rsync">
  <title>概念概述</title>
  <para>
    对于要通过慢速网络连接同步大量数据的情况，Rsync 提供了可靠的方法来只传输文件中的更改。此方法不仅适用于文本文件，还适用于二进制文件。为了检测文件之间的差异，Rsync 将文件分为多个块，并计算它们的校验和。
   </para>
   <para>
    检测更改对计算能力有一定的要求。因此，请确保两端的计算机均具有足够的资源，包括 RAM。
   </para>
  <para>
   当需要定期传输大量只包含微小更改的数据时，Rsync 特别有用。进行备份时就常常用到该工具。Rsync 也非常适合用于镜像分阶段服务器，此类服务器将 Web 服务器的完整目录树储存到 DMZ 内的某台 Web 服务器中。
  </para>
  <para>
   Rsync 并不是同步工具，虽然它的名字看上去有些像。Rsync 工具一次只能在一个方向复制数据。它不会也不能反向复制数据。如果您需要既能同步源又能同步目标的双向工具，请使用 Csync。
  </para>
  
 </sect1>

  <sect1 xml:id="sec.net.sync.rsync.syntax">
   <title>基本语法</title>
   <para>
    Rsync 是一个命令行工具，基本语法如下：
   </para>
   <screen>rsync [OPTION] SOURCE [SOURCE]... DEST</screen>
   <para>
    您可以在任何本地或远程计算机上使用 Rsync，前提是您拥有相应的访问权限和写入权限。可以有多个 <replaceable>SOURCE</replaceable> 项。<replaceable>SOURCE</replaceable> 和 <replaceable>DEST</replaceable> 占位符可以是路径和/或 URL。
   </para>
   <para>
    下面介绍一些最常用的 Rsync 选项：
   </para>
   <variablelist>
    <varlistentry>
     <term><option>-v</option></term>
     <listitem>
      <para> 输出较详细的文本</para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>-a</option></term>
     <listitem>
      <para> 存档模式；以递归方式复制文件并保留时间戳、用户/组所有权、文件许可权限和符号链接。 </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>-z</option></term>
     <listitem>
      <para>压缩传输的数据</para>
     </listitem>
    </varlistentry>
   </variablelist>
   <note>
    <title>尾部斜杠计数</title>
    <para>
     使用 Rsync 时，要特别注意尾部斜杠。目录后面的尾部斜杠表示目录的<emphasis>内容</emphasis>。没有尾部斜杠表示<emphasis>目录本身</emphasis>。
   </para>
   </note>
  </sect1>

  <sect1 xml:id="sec.net.sync.rsync.copy.local.files-and-dirs">
   <title>在本地复制文件和目录</title>
   <para>
    下面的说明假设当前用户拥有 <filename>/var/backup</filename> 目录的写入许可权限。要将单个文件从计算机上的一个目录复制到另一个路径，请使用以下命令： </para>
   <screen><prompt>tux &gt; </prompt><command>rsync</command> -avz backup.tar.xz /var/backup/</screen>
   <para>文件 <filename>backup.tar.xz</filename> 会复制到 <filename>/var/backup/</filename>，绝对路径是 <filename>/var/backup/backup.tar.xz</filename>。</para>
   <para>
    请勿忘记在 <filename>/var/backup/</filename> 目录后面加上<emphasis>尾部斜杠</emphasis>！如果不插入斜杠，文件 <filename>backup.tar.xz</filename> 会复制到 <filename>/var/backup</filename>（文件）中，而<emphasis>不是</emphasis> <filename>/var/backup/</filename> 目录中！
   </para>
   <para>
    复制目录与复制单个文件相似。下面的示例将目录 <filename>tux/</filename> 及其内容复制到 <filename>/var/backup/</filename> 目录中： </para>
    <screen><prompt>tux &gt; </prompt><command>rsync</command> -avz tux /var/backup/</screen>
    <para> 在绝对路径 <filename>/var/backup/tux/</filename> 中可找到副本。 </para>
  </sect1>

  <sect1 xml:id="sec.net.sync.rsync.copy.remote.files-and-dirs">
   <title>远程复制文件和目录</title>
   <para>
    两台计算机上都需要有 Rsync 工具。要从远程目录复制文件或将文件复制到远程目录，需要提供 IP 地址或域名。如果本地计算机和远程计算机上当前的用户名相同，则用户名为可选项。
   </para>
   <para> 要使用相同的用户（在本地和远程主机上）将文件 <filename>file.tar.xz</filename> 从本地主机复制到远程主机 <systemitem class="ipaddress">192.168.1.1</systemitem>，请使用以下命令：
   </para>
   <screen><prompt>tux &gt; </prompt><command>rsync</command> -avz file.tar.xz  tux@192.168.1.1:</screen>
    <para> 根据您的个人偏好，也可以使用下面的命令，它们的作用相同： </para>
   <screen><prompt>tux &gt; </prompt><command>rsync</command> -avz file.tar.xz 192.168.1.1:~
<prompt>tux &gt; </prompt><command>rsync</command> -avz file.tar.xz 192.168.1.1:/home/tux</screen>
    <para> 在使用标准配置的所有情况下，系统会提示您输入远程用户的通行口令。此命令会将 <filename>file.tar.xz</filename> 复制到用户 <systemitem class="username">tux</systemitem> 的主目录（通常为 <filename>/home/tux</filename>）。
    </para>
   <para>
    远程复制目录与在本地复制目录相似。下面的示例将目录 <filename>tux/</filename> 及其内容复制到 <systemitem class="ipaddress">192.168.1.1</systemitem> 主机上的远程目录 <filename>/var/backup/</filename>：
   </para>
   <screen><prompt>tux &gt; </prompt><command>rsync</command> -avz tux 192.168.1.1:/var/backup/</screen>
   <para>
    假设您在主机 <systemitem class="ipaddress">192.168.1.1</systemitem> 上拥有写入许可权限，便可在绝对路径 <filename>/var/backup/tux</filename> 中找到副本。
   </para>
  </sect1>

  <sect1 xml:id="sec.net.sync.rsync.server">
   <title>配置和使用 Rsync 服务器</title>
   <para>
    Rsync 可作为在用于传入连接的默认端口 873 上列出的守护程序 (<systemitem class="daemon">rsyncd</systemitem>) 运行。此守护程序可以接收<quote>复制目标</quote>。
   </para>
   <para>
    下面的说明介绍如何在 <systemitem>jupiter</systemitem> 上创建具有<emphasis>备份</emphasis>目标的 Rsync 服务器。此目标可用于储存您的备份。要创建 Rsync 服务器，请执行以下操作：
   </para>
   <procedure>
    <title>设置 Rsync 服务器</title>
    <step xml:id="st.rsync.server.mkdir">
     <para>
      在 jupiter 上，创建用于储存您所有备份文件的目录。在此示例中，我们使用 <filename>/var/backup</filename>：
     </para>
     <screen><prompt role="root">root # </prompt><command>mkdir</command> /var/backup</screen>
    </step>
    <step>
     <para>指定所有权。在此示例中，该目录为<systemitem class="groupname">用户</systemitem>组中的用户 <systemitem class="username">tux</systemitem> 所拥有：</para>
     <screen><prompt role="root">root # </prompt><command>chown</command> tux.users /var/backup</screen>
    </step>
    <step>
     <para>配置 rsyncd 守护程序。</para>
     <para>我们将配置文件分割成一个主文件和一些用于存放您的备份目标的<quote>模块</quote>。如此，以后便可更轻松地添加其他目标。全局值可以储存在 <filename>/etc/rsyncd.d/*.inc</filename> 文件中，而模块放置在 <filename> etc/rsyncd.d/*.conf</filename> 文件中： </para>
     <substeps>
      <step>
       <para>创建目录 <filename>/etc/rsyncd.d/</filename>：</para>
       <screen><prompt role="root">root # </prompt><command>mkdir</command> /etc/rsyncd.d/</screen>
      </step>
      <step>
       <para>
        在主配置文件 <filename>/etc/rsyncd.conf</filename> 中，添加以下几行：
       </para>
       <screen># rsyncd.conf main configuration file
log file = /var/log/rsync.log
pid file = /var/lock/rsync.lock

&amp;merge /etc/rsyncd.d <co xml:id="co.rsync.conf.merge"/>
&amp;include /etc/rsyncd.d <co xml:id="co.rsync.conf.include"/></screen>
       <calloutlist>
        <callout arearefs="co.rsync.conf.merge">
         <para> 将 <filename>/etc/rsyncd.d/*.inc</filename> 文件中的全局值合并到主配置文件中。 </para>
        </callout>
        <callout arearefs="co.rsync.conf.include">
         <para> 从 <filename>/etc/rsyncd.d/*.conf</filename> 文件中装载任何模块（或目标）。这些文件不应该包含对全局值的任何参照。 </para>
        </callout>
       </calloutlist>
      </step>
      <step>
       <para> 在文件 <filename>/etc/rsyncd.d/backup.conf</filename> 中通过以下几行创建您的模块（您的备份目标）： </para>
       <screen># backup.conf: backup module
[backup] <co xml:id="co.rsync.conf.target"/>
   uid = tux <co xml:id="co.rsync.conf.uid-gid"/>
   gid = users <xref linkend="co.rsync.conf.uid-gid"/>
   path = /var/backup <co xml:id="co.rsync.conf.path"/>
   auth users = tux  <co xml:id="co.rsync.conf.authusers"/>
   secrets file = /etc/rsyncd.secrets <co xml:id="co.rsync.conf.secretfiles"/>
   comment = Our backup target</screen>
       <calloutlist>
        
        
        <callout arearefs="co.rsync.conf.target">
         <para>
          <emphasis>备份</emphasis>目标。可以使用您喜欢的任何名称。但最好根据目标的用途来命名，并使用在 <filename>*.conf</filename> 文件中所用的相同名称。
         </para>
        </callout>
        <callout arearefs="co.rsync.conf.uid-gid">
         <para>
          指定在进行文件传输时所用的用户名或组名。
         </para>
        </callout>
        <callout arearefs="co.rsync.conf.path">
         <para>
          定义用于储存备份的路径（从<xref linkend="st.rsync.server.mkdir"/> 中）。
         </para>
        </callout>
        <callout arearefs="co.rsync.conf.authusers">
         <para>
          指定允许的用户的逗号分隔列表。列表以最简单的方式包含允许连接到此模块的用户名。在我们的示例中，只允许用户 <systemitem class="username">tux</systemitem>。
         </para>
        </callout>
        <callout arearefs="co.rsync.conf.secretfiles">
         <para>
          指定包含用户名和明文口令的行所在文件的路径。
         </para>
        </callout>
       </calloutlist>
      </step>
      <step>
       <para>
        创建包含以下内容的 <filename>/etc/rsyncd.secrets</filename> 文件，并替换 <replaceable>PASSPHRASE</replaceable>：
       </para>
       <screen># user:passwd
tux:<replaceable>PASSPHRASE</replaceable></screen>
      </step>
      <step>
       <para>
        确保该文件只有 <systemitem class="username">root</systemitem> 用户可读：
       </para>
       <screen><prompt role="root">root # </prompt><command>chmod</command> 0600 /etc/rsyncd.secrets</screen>
      </step>
     </substeps>

     
    </step>
    <step>
     <para>
      通过以下命令启动并启用 rsyncd 守护程序：
     </para>
     <screen><prompt role="root">root # </prompt><command>systemctl</command> enable rsyncd
<prompt role="root">root # </prompt><command>systemctl</command> start rsyncd</screen>
     
    </step>
    <step>
     <para>
      测试是否可访问 Rsync 服务器：
     </para>
     <screen><prompt>tux &gt; </prompt><command>rsync</command> jupiter::</screen>
     <para>
      您应可看到类似如下的响应：
     </para>
     <screen>backup          Our backup target</screen>
     <para>若非如此，请检查您的配置文件、防火墙和网络设置。</para>
    </step>
   </procedure>
   <para>
    上述步骤创建了 Rsync 服务器，现在可以使用它来储存备份。下例还创建了一个列出所有连接的日志文件。此文件储存在 <filename>/var/log/rsyncd.log</filename> 中。如果您要对传输进行调试，那么它非常有用。
   </para>
   <para>
    要列出备份目标的内容，请使用以下命令：
   </para>
<screen>rsync -avz jupiter::backup</screen>
   <para>
    此命令会列出服务器上 <filename>/var/backup</filename> 目录中存在的所有文件。此请求还记录在日志文件 <filename>/var/log/rsyncd.log</filename> 中。要开始实际传输，请提供源目录。使用 <literal>.</literal> 表示当前目录。例如，下面的命令会将当前目录复制到 Rsync 备份服务器：
   </para>
   <screen>rsync -avz . jupiter::backup</screen>
   <para>
    默认情况下，Rsync 不会在运行时删除文件和目录。要允许删除，必须另外指定选项 <option>--delete</option>。为保证不删除任何较新的文件，可转而使用选项 <option>--update</option>。必须手动解决所有冲突。
   </para>
  </sect1>

 <sect1 xml:id="sec.net.sync.summary">
  <title>更多信息</title>
  <variablelist>
   <varlistentry>
    <term>CSync</term>
    <listitem>
     <para>双向文件同步程序，请参见 <link xlink:href="https://www.csync.org/"/>。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>RSnapshot</term>
    <listitem>
     <para>创建增量备份，请参见 <link xlink:href="http://rsnapshot.org"/>。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Unison</term>
    <listitem>
     <para>它是一个文件同步程序，类似于 CSync，但具有图形界面，请参见 <link xlink:href="http://www.seas.upenn.edu/~bcpierce/unison/"/>。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Rear</term>
    <listitem>
     <para>一个灾难恢复框架，请参见 <link xlink:href="https://www.suse.com/documentation/sle-ha-12/"/> 上 SUSE Linux Enterprise High Availability Extension 的《<citetitle>管理指南</citetitle>》。</para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
</chapter>
