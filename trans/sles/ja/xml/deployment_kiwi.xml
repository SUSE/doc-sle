<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xml:base="deployment_kiwi.xml" id="cha.autokiwi">

 <title>プリロードイメージの自動展開</title>
 <abstract>
  <para>
   KIWIを使用して、オペレーティングシステムイメージを作成できます。この章では、空のクライアントマシンにシステムイメージを展開するプロセスについて説明します。このためには、ブート可能なRAWイメージを含むプリロードイメージを作成する必要があります。このファイルにはパーティションテーブルと、実際のオペレーティングシステムという2つの重要な部分が含まれます。このRAWイメージは空のハードディスクに書き込まれ、オペレーティングシステムは残りのディスクスペースを初回起動時に拡張します。
  </para>

 </abstract>
 <para>
  このようなイメージの作成については、<ulink url="http://doc.opensuse.org/projects/kiwi/doc/"/>を参照してください。ISOイメージをビルドする場合は、このRAWファイルを宛先フォルダで見つけることができます。RAWイメージをディスクにダンプするには、多数の方法があります。
 </para>
 <itemizedlist mark="bullet" spacing="normal">
  <listitem>
   <para>
    ディスクを展開サーバに挿入し、イメージをRAWデバイスにコピーします。
   </para>
  </listitem>
  <listitem>
   <para>
    HTTPサーバまたはFTPサーバを介してRAWイメージをダウンロードし、クライアントマシンのディスクにダンプします。
   </para>
  </listitem>
  <listitem>
   <para>
    イメージを取得してディスクにダンプするため、netbootイメージを作成します。これは大規模展開にお勧めする方法です。
   </para>
  </listitem>
  <listitem>
   <para>
    レスキューディスクを起動し、rescueイメージから手動でダンプを行ないます。
   </para>
  </listitem>
 </itemizedlist>
 <para>
  迅速な起動には、<xref linkend="sec.autokiwi.manual"/>で説明されている方法のうちいずれかを使用することをお勧めします。
 </para>
 <sect1 id="sec.autokiwi.manual">
  <title>レスキューイメージからの手動によるシステムの展開</title>

  <variablelist>
   <varlistentry>
    <term>KIWIから生成されたISOファイルを使用した展開</term>
    <listitem>
     <orderedlist spacing="normal">
      <listitem>
       <para>
        KIWI構築プロセスから取得したISOイメージをCDまたはDVDに書き込みます。
       </para>
      </listitem>
      <listitem>
       <para>
        このメディアからクライアントコンピュータにブートします。
       </para>
      </listitem>
      <listitem>
       <para>
        インストール用ハードディスクを選択します。
       </para>
      </listitem>
      <listitem>
       <para>
        クライアントコンピュータを再起動し、ハードディスクからブートします。
       </para>
      </listitem>
     </orderedlist>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>レスキューシステム上の展開:</term>
    <listitem>
     <orderedlist spacing="normal">
      <listitem>
       <para>
        レスキューシステムでクライアントコンピュータをブートします。この種のシステムはすべてのSUSEインストールCDまたはDVDで利用できます。
       </para>
      </listitem>
      <listitem>
       <para>
        <systemitem class="username">root</systemitem>としてログインします。パスワードは入力しないでください。
       </para>
      </listitem>
      <listitem>
       <para>
        ネットワークを設定します。ネットワークでDHCPが使用可能な場合、これは<command>ifup-dhcp eth0</command>コマンドを使用するだけで済みます。手動で行なう必要がある場合は、<command>ip</command>コマンドを使用してネットワークを設定します。DHCPを起動する際の出力に、コンピュータのIPアドレスも表示されます。
       </para>
      </listitem>
      <listitem>
       <para>
        次のコマンドを使用して、ネットワークの未使用ポート(たとえば、<systemitem>1234</systemitem>)でリッスンし、着信データをディスクにダンプします。
       </para>
<screen>netcat -l -p 1234 &gt; /dev/sda</screen>
      </listitem>
      <listitem>
       <para>
        イメージ処理サーバ上で、次のコマンドを使用してクライアントコンピュータに未加工イメージを送信します。
       </para>
<screen>netcat &lt;IP of client&gt; 1234 &lt; $HOME/preload_image/&lt;image_name&gt;</screen>
      </listitem>
      <listitem>
       <para>
        イメージが転送されたら、レスキューシステムをCDまたはDVDのドライブから取り出し、クライアントマシンをシャットダウンします。リブートすると、ブートロ－ダ<literal>GRUB</literal>がクライアントで起動し、firstbootシステムが引き継ぎます。
       </para>
      </listitem>
     </orderedlist>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 id="sec.autokiwi.pxe">
  <title>PXEブートを使用した自動展開</title>

  <para>
   同様のハードウェアにオペレーティングシステムを複数インストールする場合、オペレーティングシステムの大規模展開の準備に手間をかけ、実際の展開に必要な時間を最小限にすることが重要です。この章では、このプロセスについて説明します。目標は、コンピュータを電源接続し、ネットワークに接続し、ネットワークブートを開始したら、コンピュータがオフになるまで待機すれば済むようにすることです。
  </para>

  <para>
   このタスクを完了するには次の操作を行う必要があります。
  </para>

  <variablelist>
   <varlistentry>
    <term>ブートおよびインストール用サーバのセットアップ</term>
    <listitem>
     <para>
      PXEブートとFTPまたはWebサーバを提供し、プリロードイメージを提供できるよう準備された専用のマシンが必要です。必要なインストールデータをメモリにすべて保持できるように、コンピュータには十分なメモリを用意しておくことをお勧めします。デフォルトのインストールには、少なくとも4GBのメモリを必要とします。必要なタスクはすべて、SUSE Linux Enterprise Serverで行うことができます。詳細については、<xref linkend="sec.autokiwi.instserver"/>を参照してください。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>プリロードイメージを準備する</term>
    <listitem>
     <para>
      実際のインストールでは、新規のハードディスクにオペレーティングシステムの未加工イメージをコピーします。すべての機能と設定を注意深く準備し、テストする必要があります。このようなイメージの作成には、KIWIを使用できます(KIWIは、SUSE Linux EnterpriseオペレーティングシステムのSDKに含まれています)。KIWIを使用したイメージの作成の詳細については、<ulink url="http://doc.opensuse.org/projects/kiwi/doc/"/>を参照してください。プリロードイメージのシステム要件に関する詳細については、<xref linkend="sec.autokiwi.preloadimage"/>を参照してください。
     </para>
     <para>
      このSDKは、SUSE Linux Enterprise向けのアドオン製品であり、<ulink url="http://download.suse.com/"/>からダウンロードできます。「<literal>SUSE Linux Enterpriseソフトウェア開発キット</literal>」で検索してください。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>展開用の初期システムを作成する</term>
    <listitem>
     <para>
      このタスクにはLinuxの専門知識が必要です。このタスクを達成する方法については、<xref linkend="sec.autokiwi.initrd"/>でインストール例を使用して説明しています。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>ブートサーバを自動展開用に設定する</term>
    <listitem>
     <para>
      PXEブートはインストールシステムをブートするよう設定されている必要があります。インストールシステムはプリロードイメージをサーバから取得して、ハードディスクにコピーします。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <sect2 id="sec.autokiwi.instserver">
   <title>ブートおよびインストール用サーバのセットアップ</title>
   <para>
    SUSE Linux Enterprise Serverのインストール後にこのタスクを実行するには、4つのステップを完了する必要があります。
   </para>
   <procedure id="proc.autokiwi.instserver">
    <step performance="required">
     <para>
      <xref linkend="sec.deployment.remoteinst.instserver"/>で説明されている方法でインストールソースをセットアップします。HTTPまたはFTPのネットワークサーバを選択します。
     </para>
    </step>
    <step performance="required">
     <para>
      ブートイメージ(後で示すステップで作成)を保持するようにTFTPサーバを設定します。これは<xref linkend="sec.deployment.remoteinst.boot.tftp"/>で説明されています。
     </para>
    </step>
    <step performance="required">
     <para>
      すべてのコンピュータにIPアドレスを割り当て、ターゲットシステムにTFTPサーバの場所を知らせるように、DHCPサーバを設定します。これは<xref linkend="sec.deployment.remoteinst.boot.dhcp"/>で説明されています。
     </para>
    </step>
    <step performance="required">
     <para>
      インストールサーバPXEブートを準備します。この詳細は、<xref linkend="sec.deployment.remoteinst.boot.pxe"/>で説明しています。
     </para>
    </step>
   </procedure>
   <para>
    このコンピュータにプリロードイメージを保持できる充分なメモリを用意しておけば、実際のインストールプロセスで非常に役立ちます。また、ギガビットEthernetを使用すると、低速のネットワークを使用する場合と比べて、展開プロセスを大幅にスピードアップできます。
   </para>
  </sect2>

  <sect2 id="sec.autokiwi.preloadimage">
   <title>プリロードイメージの作成</title>
   <para>
    KIWIでのイメージの作成については、<ulink url="http://doc.opensuse.org/projects/kiwi/doc/"/>を参照してください。ただし、大規模展開用のイメージを作成するには、次の点を考慮に入れる必要があります。
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      通常のプリロードイメージでは、次の種類を使用します。
     </para>
<screen>&lt;type primary="true" filesystem="btrfs" boot="oemboot/suse-SLES12"&gt;vmx&lt;/type&gt;</screen>
    </listitem>
    <listitem>
     <para>
      プリロードイメージイメージのセットアップ中、イメージ作成プロセスは複数回実行されます。イメージのビルドに必要なリポジトリをローカルコンピュータ上で利用できる必要があります。
     </para>
    </listitem>
    <listitem>
     <para>
      プリロードの使用に関する希望に応じて、firstbootの設定にはいくらかの労力を要する場合があります。firstbootに関する詳細は、<xref linkend="cha.deployment_firstboot"/>を参照してください。この方法では、システムの初回起動時に初期設定を行うようユーザに求めることができます。
     </para>
    </listitem>
    <listitem>
     <para>
      アップデートリポジトリの追加や初回起動時のアップデートの実行など、イメージには多くの追加機能を設定できます。ただし、本書ですべての可能性を説明することは不可能であり、(要件によっては)プリロードイメージの作成にイメージングシステムKIWIや、<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>で使用される他の技術の詳細な知識が必要になる場合があります。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    展開する実際のイメージは、インストールサーバで指定したFTPサーバまたはHTTPサーバから入手できます。
   </para>
  </sect2>

  <sect2 id="sec.autokiwi.initrd">
   <title>プリロードイメージを展開する初期システムの作成</title>
   <para>
    自動展開を実行するには、ターゲットコンピュータで初期Linuxシステムを起動する必要があります。通常のインストール時には、ブートメディアからカーネルおよび初期RAMファイルシステムが読み込まれ、BIOSによって起動されます。必要な機能はRAMファイルシステムに実装できます。このRAMファイルシステムはカーネルと共に初期システムとして動作します。
   </para>
   <para>
    初期システムが提供する必要のある機能は、主として、ハードウェアへのアクセスを有効にする機能とネットワーク接続を可能にする機能です。これらの機能は両方とも、展開先のハードウェアに依存します。理論的には、初期システムを一から作成することは可能ですが、ブート時にコンピュータによって使用される初期RAMファイルシステムを変更することによって、このタスクを容易にすることができます。
   </para>
   <para>
    次の手順は、必要な初期RAMファイルシステムを作成する方法の一例にすぎません。
   </para>
   <procedure>
    <step performance="required">
     <para>
      ターゲットシステム上で<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>の標準インストールを行います。
     </para>
    </step>
    <step performance="required">
     <para>
      このシステム上にパッケージ<systemitem>busybox</systemitem>をインストールします。
     </para>
    </step>
    <step performance="required">

     
     
     <para>
      次のコマンドを使用して、新しいRAMファイルシステムを作成します。
     </para>
<screen>mkinitrd -f busybox -D eth0</screen>
     <para>
      ここで、eth0はネットワークケーブルの接続先のEthernetデバイスを表します。パラメータ<systemitem>-f busybox</systemitem>は、マルチコールバイナリ<systemitem>busybox</systemitem>をRAMファイルシステムに追加します。これを行った後、このシステム内で多くの標準UNIXコマンドが利用できます。
     </para>
    </step>
    <step performance="required">
     <para>
      次のコマンドを使用して、新しいRAMファイルシステムとカーネルをブートサーバにコピーします。
     </para>
<screen>scp /boot/initrd /boot/vmlinuz pxe.example.com:</screen>
     <para>
      pxe.example.comは、ご使用のローカルブートサーバの名前またはIPアドレスに置き換えます。
     </para>
    </step>
    <step performance="required">
     <para>
      <systemitem class="username">root</systemitem>ユーザとしてブートサーバにログインし、RAMシステムを変更できるディレクトリを作成します。
     </para>
<screen>mkdir ~/bootimage</screen>
    </step>
    <step performance="required">
     <para>
      <command>cd ~/bootimage</command>コマンドで、作業ディレクトリをこのディレクトリに変更します。
     </para>
    </step>
    <step performance="required">
     <para>
      次のコマンドを使用して、前にコピーした初期RAMファイルシステムを展開します。
     </para>
<screen>zcat ../initrd | cpio -i</screen>
    </step>
    <step performance="required">
     <para>
      <filename>run_all.sh</filename>ファイルを編集します。
     </para>
    </step>
    <step performance="required">
     <para>
      次の行を検索し、この行とファイルの残りを削除します。
     </para>
<screen>[ "$debug" ] &amp;&amp; echo preping 21-nfs.sh </screen>
    </step>
    <step performance="required">
     <para>
      <filename>run_all.sh</filename>ファイルの末尾に次の行を追加します。
     </para>
<screen>[ "$debug" ] &amp;&amp; echo preping 92-install.sh
[ "$debug" ] &amp;&amp; echo running 92-install.sh
source boot/92-install.sh
[ "$modules" ] &amp;&amp; load_modules
     </screen>
    </step>
    <step performance="required">
     <para>
      次の内容を含む新しいスクリプト<filename>boot/92-install.sh</filename>を作成します。
     </para>
<screen>#!/bin/bash
if [ "$(get_param rawimage)" ]; then
  rawimage=$(get_param rawimage)
  if  [ "$(get_param rawdevice)" ]; then
    rawdevice=$(get_param rawdevice)
    echo "wget -O ${rawdevice} ${rawimage}"
    wget -O ${rawdevice} ${rawimage}
    sync
    sleep 5
    echo "DONE"
  fi
fi
# /bin/bash
/bin/poweroff -f
</screen>
    </step>
    <step performance="required">
     <para>
      コンピュータを閉じる前にデバッグシェルが必要な場合は、<filename>/bin/bash</filename>の前のコメント署名を削除します。
     </para>
    </step>
    <step performance="required">
     <para>
      <command>chmod 755 boot/92-install.sh</command>コマンドを使用してこのスクリプトを実行可能にします。
     </para>
    </step>
    <step performance="required">
     <para>
      次のコマンドを使用して新しい初期RAMファイルシステムを作成します。
     </para>
<screen>mkdir -p /srv/tftpboot
find . | cpio --quiet -H newc -o | gzip -9 -n &gt; \
/srv/tftpboot/initrd.boot</screen>
    </step>
    <step performance="required">
     <para>
      カーネルをこのディレクトリにコピーします。
     </para>
<screen>cp ../vmlinuz /srv/tftpboot/linux.boot</screen>
    </step>
   </procedure>
   <para>
    これで初期RAMファイルシステムは、2つの新しいカーネルコマンドラインパラメータを使用する準備ができました。パラメータ<systemitem>rawimage=&lt;URL&gt;</systemitem>は、プリロードイメージの場所を特定するために使用されます。wgetが理解できるURLはどれでも使用できます。パラメータ<systemitem>rawdevice=&lt;device&gt;</systemitem>は、ターゲットコンピュータのハードディスクのブロックデバイスを特定するために使用されます。
   </para>
  </sect2>

  <sect2>
   <title>ブートサーバの設定</title>
   <para>
    ブートサーバの設定に関する詳細は、<xref linkend="sec.autokiwi.instserver"/>にリストされているように複数の章で説明されてます。このセクションでは、システムの設定に必要な手順を確認することができます。
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      DHCPサーバをセットアップします。コンピュータがインストールされているサブネットには、次の追加行が必要です。
     </para>
<screen>filename "pxelinux.0";
next-server 192.168.1.115;</screen>
     <para>
      この例の192.168.1.115は、PXEサーバpxe.example.comのIPアドレスです。
     </para>
    </listitem>
    <listitem>
     <para>
      <xref linkend="sec.deployment.remoteinst.boot.pxe"/>で説明されているように、PXEサーバを設定します。<filename>/srv/tftpboot/pxelinux.cfg/default</filename>の編集時には次のエントリを追加します。
     </para>
<screen>default bootinstall
label bootinstall
  kernel linux.boot
  append initrd=initrd.boot \
  rawimage=ftp://192.168.1.115/preload/preloadimage.raw rawdevice=/dev/sda</screen>
    </listitem>
    <listitem>
     <para>
      FTPサーバを設定し、準備済みプリロードイメージを<filename>/srv/ftp/preload/preloadimage.raw</filename>にコピーします。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    PXEネットワークブートを使用して、ターゲットシステムをブートし、セットアップをテストします。これによって、準備されたプリロードイメージが自動的にハードディスクにコピーされ、用意ができた時点でコンピュータが閉じられます。
   </para>
  </sect2>


 </sect1>







</chapter>
