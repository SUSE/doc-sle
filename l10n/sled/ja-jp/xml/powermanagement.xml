<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="powermanagement.xml" version="5.0" xml:id="cha-power-mgmt">
 <title>電源管理</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 
 <para>
  電源管理はラップトップコンピュータで特に重要ですが、他のシステムでも役に立ちます。ACPI(Advanced Configuration and Power Interface)は、最近のすべてのコンピュータ(ラップトップ、デスクトップ、サーバ)で使用できます。電源管理テクノロジでは、適切なハードウェアとBIOSルーチンを必要とします。ほとんどのラップトップと多くの新型デスクトップおよびサーバは、これらの必要条件を満たしています。電源の節約や騒音の低減のために、CPU周波数を制御することもできます。
 </para>
 <sect1 xml:id="sec-power-mgmt-save">
  <title>省電力機能</title>

  <para>
   省電力機能はラップトップをモバイル使用する場合に限らず、デスクトップシステムでも重要です。ACPIの主要な機能と、その使用目的は、以下のとおりです。
  </para>

  <variablelist>
   <varlistentry>
    <term>スタンバイ</term>
    <listitem>
     <para>
      サポートされていません。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>サスペンド(メモリに保存)</term>
    <listitem>
     <para>
      このモードでは、システム状態をすべてRAMに書き込みます。その後、RAMを除くシステム全体がスリープします。この状態では、コンピュータの消費電力が非常に小さくなります。この状態の利点は、ブートやアプリケーションの再起動をせずに、数秒でスリープ前の作業をスリープの時点から再開できることです。この機能は、ACPI状態<literal>S3</literal>に対応します。

     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>ハイバーネーション(ディスクに保存)
    </term>
    <listitem>
     <para>
      この動作モードでは、システム状態がすべてハードディスクに書き込まれ、システムの電源がオフになります。すべてのアクティブデータを書き込むには、少なくともRAMの大きさのスワップパーティションが必要です。この状態から再開するには、30～90秒かかります。サスペンド前の状態が復元されます。メーカの中には、このモードを便利なハイブリッド仕様にして提供するものもあります(たとえば、IBM ThinkpadのRediSafe)。対応するACPI状態は、<literal>S4</literal>です。Linux環境では、suspend to diskはACPIから独立したカーネルルーチンにより実行されます。
     </para>
      <note>
  <title><command>mkswap</command>でフォーマットするとスワップパーティションのUUIDが変更される</title>
  <para>可能であれば、<command>mkswap</command>で既存のスワップパーティションを再フォーマットしないでください。<command>mkswap</command>で再フォーマットすると、スワップパーティションのUUIDの値が変更されます。YaSTで再フォーマットするか(<filename>/etc/fstab</filename>が更新されます)、<filename>/etc/fstab</filename>を手動で調整します。
  </para>
</note>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>バッテリモニタ
    </term>
    <listitem>
     <para>
      ACPIは、バッテリをチェックして、充電ステータスに関する情報を提供します。また、システムは、重要な充電ステータスに達した時点で実行するようにアクションを調整します。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>自動電源オフ</term>
    <listitem>
     <para>
      シャットダウンの後、コンピュータの電源が切れます。これは、バッテリが空になる直前に自動シャットダウンが行われる場合に特に重要です。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>プロセッサ速度の制御</term>
    <listitem>
     <para>
      CPUとの接続では、次の3つの方法で省エネできます:。 周波数と電圧の調節(<phrase role="productname">PowerNow! </phrase>または<phrase role="productname">Speedstep</phrase>)、スロットリング、およびプロセッサをスリープ状態(C-states)にすること。コンピュータの動作モードによっては、この3つの方法を併用することもできます。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec-power-mgmt-acpi">
  <title>ACIP(詳細設定と電源インタフェース)</title>

  <para>
   ACPIは、オペレーティングシステムが個々のハードウェアコンポーネントをセットアップし、制御できるように設計されています。ACPIは、PnP(Power Management Plug and Play)とAPM(Advanced Power Management)の両方に優先します。また、ACPIはバッテリ、ACアダプタ、温度、ファン、および <quote>close lid </quote>や <quote>battery low </quote>などのシステムイベントに関する情報も提供します。
  </para>

  <para>
   BIOSには個々のコンポーネントとハードウェアアクセス方法についての情報が入ったテーブルがあります。オペレーティングシステムは、この情報を使用して、割り込みまたはコンポーネントの有効化と無効化などのタスクを実行します。BIOSに格納されているコマンドを、オペレーティングシステムが実行するとき、機能はBIOSの実装方法に依存します。ACPIが検出可能で、ロードできるテーブルは、journaldにレポートされます。ジャーナルログメッセージの表示の詳細については、<xref linkend="cha-journalctl"/>を参照してください。ACPIに生じた問題のトラブルシューティングについては、<xref linkend="sec-power-mgmt-acpi-trouble"/>を参照してください。
  </para>

  <sect2 xml:id="sec-power-mgmt-acpi-powernow">
   <title>CPUパフォーマンスの制御</title>
   <para>
    CPUには、3つの省エネ方法があります。
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      周波数と電圧の調節
     </para>
    </listitem>
    <listitem>
     <para>
      クロック周波数のスロットリング(T-states)
     </para>
    </listitem>
    <listitem>
     <para>
      プロセッサのスリープ状態への切り替え(C-states)
     </para>
    </listitem>
   </itemizedlist>
   <para>
    コンピュータの動作モードによっては、この3つの方法を併用することもできます。また、省電力とは、システムの温度上昇が少なく、ファンが頻繁にアクティブにならないことを意味します。
   </para>
   <para>
    周波数調節とスロットリングに意味があるのは、プロセッサがビジー状態の場合だけです。これは、プロセッサがアイドル状態のときには、常に、最も経済的なC-stateが適用されるからです。CPUがビジー状態の場合、省電力方式として周波数調節を使用することをお勧めします。通常、プロセッサは部分的な負荷でのみ動作します。この場合は、低周波数で実行できます。通常、カーネルのオンデマンドガバナによって動的に制御される動的な周波数調節が最良のアプローチです。
   </para>
   <para>
    スロットリングは、システムが高負荷であるにもかかわらずバッテリ使用時間を延長する場合など、最後の手段として使用する必要があります。ただし、スロットリングの割合が高すぎると、スムーズに動作しないシステムがあります。さらに、CPUの負荷が小さければ、CPUスロットリングは無意味です。
   </para>
   <para>
    詳細については、<xref linkend="cha-tuning-power"/>を参照してください。
   </para>
  </sect2>

  <sect2 xml:id="sec-power-mgmt-acpi-trouble">
   <title>トラブルシューティング</title>
   <para>
    問題を2つに大別できます。1つはカーネルのACPIコードに、未検出のバグが存在する可能性があることです。この場合は、いずれ修正プログラムがダウンロードできるようになります。ただし、問題の多くはBIOSが原因になっています。また、場合によっては、他の広く普及しているオペレーティングシステムにACPIを実装した場合にエラーが起きないよう、BIOSにおけるACPIの指定を故意に変えていることがあります。ACPIに実装すると重大なエラーを生じるハードウェアコンポーネントは、ブラックリストに記録され、これらのコンポーネントに対してLinuxカーネルがACPIを使用しないようにします。
   </para>
   <para>
    問題に遭遇したときに最初に実行することは、BIOSの更新です。コンピュータがブートしない場合、次のブートパラメータは有用です。
   </para>
   <variablelist>
    <varlistentry>
     <term>pci=noacpi</term>
     <listitem>
      <para>
       PCIデバイスの設定にACPIを使用しません。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>acpi=ht</term>
     <listitem>
      <para>
       単純なリソース設定のみを実行します。ACPIを他の目的には使用しません。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>acpi=off</term>
     <listitem>
      <para>
       ACPIを無効にします。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <warning>
    <title>ACPIなしに起動できない場合</title>
    <para>
     一部の新型のコンピュータは(特に、SMPシステムとAMD64システム)、ハードウェアを正しく設定するためにACPIが必要です。これらのコンピュータでACPIを無効にすると、問題が生じます。
    </para>
   </warning>
   <para>
    コンピュータは時折、USBまたはFireWireを介して接続されたハードウェアと混同されることがあります。コンピュータが起動を拒否した場合、必要のないハードウェアのプラグをすべて外して再試行してください。
   </para>
   <para>
    システムのブートメッセージを調べてみましょう。そのためには、ブート後にコマンド<command>dmesg -T </command> <option>| grep -2i acpi</option>を使用します(または、問題の原因がACPIだとは限らないので、すべてのメッセージを調べます)。ACPIテーブルの解析時にエラーが発生した場合は、最も重要なテーブルDSDT (<emphasis>Differentiated System Description Table</emphasis>)を改善されたバージョンと置き換えることができます。この場合、BIOSで障害のあるDSDTが無視されます。具体的な手順については<xref linkend="sec-power-mgmt-faq"/>を参照してください。
   </para>
   <para>
    カーネルの設定には、ACPIデバッグメッセージを有効にするスイッチがあります。ACPIデバッグを有効にした状態でカーネルをコンパイルおよびインストールすると、詳細情報が発行されます。
   </para>
   <para>
    BIOSまたはハードウェアに問題がある場合は、常にメーカに連絡することをお勧めします。特に、Linuxに関するサポートを常に提供していないメーカには、問題を通知する必要があります。なぜなら、メーカは、自社の顧客の無視できない数がLinuxを使用しているとわかってやっと、問題を真剣に受け止めるからです。
   </para>
   <sect3 xml:id="sec-power-mgmt-acpi-trouble-info">
    <title>詳細情報</title>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       <link xlink:href="https://tldp.org/HOWTO/ACPI-HOWTO/"/> (詳細なACPI HOWTO、DSDTパッチが含まれています)
      </para>
     </listitem>
     <listitem>
      <para>
       <link xlink:href="https://uefi.org/specifications"/> (Advanced Configuration and Power Interface: 詳細設定と電源インタフェース)
      </para>
     </listitem>
    </itemizedlist>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-power-mgmt-silenthd">
  <title>ハードディスクの休止</title>

  <para>
   Linux環境では、不要な場合にハードディスクを完全にスリープ状態にしたり、より経済的な静止モードで動作さることができます。最近のラップトップの場合、ハードディスクを手動でオフに切り替える必要はありません。不要な場合は自動的に経済的な動作モードになります。ただし、最大限に省電力したい場合は、次の方法のいくつかを<command>hdparm</command>コマンドでテストしてください。
  </para>

  <para>
   このコマンドを使用すると、各種のハードディスク設定を変更できます。<option>-y</option>オプションは、簡単にハードディスクをスタンバイモードに切り替えます。<option>-Y</option>を指定すると、スリープ状態になります。<command>hdparm</command>
   <option>-S</option> <replaceable>X</replaceable>を使用すると、一定時間アクティビティがなければハードディスクが回転を停止します。<replaceable>X</replaceable>は、次のように置換します: 。<literal>0</literal>を指定するとこの機構が無効になり、ハードディスクは常時稼働します。<literal>1</literal>から<literal>240</literal>までの値を指定すると、指定した値x 5秒が設定値になります。<literal>241</literal>から<literal>251</literal>は、30分の1倍から11倍(30分から5.5時間)に相当します。
  </para>

  <para>
   ハードディスクの内部省電力オプションは、オプション<literal>-B</literal>で制御できます。<literal>0</literal> (最大限の省電力)～<literal>255</literal> (最大限のスループット)の値を選択します。結果は使用するハードディスクに応じて異なり、査定するのは困難です。ハードディスクを静止状態に近づけるにはオプション<literal>-M</literal>を使用します。<literal>128</literal> (静止)～<literal>254</literal> (高速)の値を選択します。
  </para>

  <para>
   ハードディスクをスリープにするのは、多くの場合簡単ではありません。Linuxでは、多数のプロセスがハードディスクに書き込むので、ウェイクアップが常に繰り返されています。したがって、ハードディスクに書き込むデータを、Linuxがどのように処理するかを理解することは重要です。はじめに、すべてのデータがRAMにバッファされます。このバッファは、<systemitem class="daemon">pdflush</systemitem>デーモンによって監視されます。データが一定の寿命に達するか、バッファがある程度一杯になると、バッファの内容がハードディスクにフラッシュされます。バッファサイズはダイナミックであり、メモリサイズとシステム負荷に対応して変化します。デフォルトでは、データの完全性を最大まで高めるように、pdflushの間隔が短く設定されています。pdflushデーモンはバッファを5秒おきにチェックし、データをハードディスクに書き込みます。次の変数が使用できます。
  </para>

  <variablelist>
   <varlistentry>
    <term><filename>/proc/sys/vm/dirty_writeback_centisecs</filename>
    </term>
    <listitem>
     <para>
      pdflushスレッドが起動するまでの遅延(100分の1秒台)を含みます。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>/proc/sys/vm/dirty_expire_centisecs</filename>
    </term>
    <listitem>
     <para>
      ダーティページが次に最新の変更を書き込まれるまでの時間枠を定義します。デフォルト値は<literal>3000</literal>(つまり 30秒)です。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>/proc/sys/vm/dirty_background_ratio</filename>
    </term>
    <listitem>
     <para>
      pdflushが書き込みを始めるまでのダーティページの最大割合。デフォルトは<literal>5</literal>パーセントです。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>/proc/sys/vm/dirty_ratio</filename>
    </term>
    <listitem>
     <para>
      メモリ全体の中でダーティページの割合がこの値を超えると、プロセスは書き込みを続けずに、短時間でダーティバッファを書き込むように強制されます。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <warning>
   <title>データの完全性リスク</title>
   <para>
    <systemitem class="daemon">pdflush</systemitem>デーモンの設定を変更すると、データの完全性が損なわれる可能性があります。
   </para>
  </warning>

  <para>
   これらのプロセスとは別に、<systemitem class="filesystem">Btrfs</systemitem>、<systemitem class="filesystem">Ext3</systemitem>、<systemitem class="filesystem">Ext4</systemitem>などのジャーナリングファイルシステムは、それらが持つメタデータを<systemitem class="daemon">pdflush</systemitem>とは無関係に書き込むので、ハードディスクがスピンダウンしなくなります。<phrase os="sled;osuse">モバイル機器では、これを避けるために特別なカーネル拡張が開発されています。その拡張を使用するには、<systemitem class="resource">laptop-mode-tools</systemitem>パッケージをインストールし、詳細について、<filename>/usr/src/linux/Documentation/laptops/laptop-mode.txt</filename>を参照してください。</phrase>
  </para>

  <para>
   もう1つの重要な要因は、アクティブプログラムが動作する方法です。たとえば、優れたエディタは、変更中のファイルを定期的にハードディスクに自動バックアップし、これによってディスクがウェイクアップされます。データの完全性を犠牲にすれば、このような機能を無効にできます。
  </para>

  <para>
   この接続では、メールデーモンpostfixが変数 <systemitem>POSTFIX_LAPTOP</systemitem> を使用します。この変数を<literal>yes</literal>に設定すると、postfixがハードディスクにアクセスする頻度は大幅に減少します。
  </para>

  <para os="sled;osuse">

   <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase>では、これらの技術は<systemitem>laptop-mode-tools</systemitem>により制御されます。
  </para>
 </sect1>
 <sect1 xml:id="sec-power-mgmt-faq">
  <title>トラブルシューティング</title>

  <para>
   すべてのエラーメッセージとアラートは、<command>journalctl</command>コマンドで問い合わせ可能なシステムジャーナルに記録されます(詳細については、<xref linkend="cha-journalctl"/>を参照してください)。以下のセクションでは、最も頻繁に起こる問題について解説します。
  </para>

  <sect2 xml:id="sec-power-mgmt-faq-cpufreq">
   <title>CPU周波数調節が機能しない</title>
   <para>
    カーネルのソースを参照して、ご使用のプロセッサがサポートされているか確認してください。CPU周波数制御を有効にするには特別なカーネルモジュールまたはモジュールオプションが必要になる場合があります。<systemitem class="resource">kernel-source</systemitem>パッケージがインストールされている場合は、この情報を<filename>/usr/src/linux/Documentation/cpu-freq/*</filename>で入手できます。
   </para>
  </sect2>
 </sect1>
</chapter>
