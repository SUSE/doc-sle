<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="rmt_client.xml" version="5.0" xml:id="cha-rmt-client">
  
  <title>将客户端配置为使用 RMT</title>
  <info>
    <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
      <dm:translation>yes</dm:translation>
    </dm:docmanager>
  </info>
  <para>
    可以将运行 SUSE Linux Enterprise 12 或以上版本的所有计算机都配置为注册到 RMT 并从其中下载软件更新，而不是直接与 SUSE Customer Center 通讯。
  </para>
  <tip>
    <title>通过 HTTP 在 RMT 服务器中注册</title>
    <para>
      我们建议您通过安全的 HTTPS 协议向 RMT 服务器注册（本文档中的所有示例均使用该协议）。不过，您也可以通过不安全的 HTTP 协议向 RMT 服务器注册。请仅在使用该协议对您的设置有益<emphasis role="bold">并且</emphasis>您处于安全性不是很重要的可信环境中时，才使用此方法。
    </para>
  </tip>
  <para>
    要将客户端配置为使用 RMT 服务器，请使用以下其中一种方法：
  </para>
  <itemizedlist>
    <listitem>
      <para>
        提供包含引导参数的所需信息。请参见<xref linkend="sec-rmt-client-parameters"/>。
      </para>
    </listitem>
    <listitem>
      <para>
        使用 AutoYaST 配置文件配置客户端。请参见<xref linkend="sec-rmt-client-autoyast"/>。
      </para>
    </listitem>
    <listitem>
      <para>
        使用 <command>rmt-client-setup</command> 命令。请参见<xref linkend="sec-rmt-client-clientsetupscript"/>。
      </para>
    </listitem>
    <listitem>
      <para>
        在安装期间或之后使用 YaST 注册模块。请参见<xref linkend="sec-rmt-client-yast"/>。
      </para>
    </listitem>
  </itemizedlist>
  <tip>
    <title>CA 证书</title>
    <para>
      如果您需要 RMT 服务器的 CA 证书，可以在 <filename>/etc/rmt/ssl/rmt-ca.crt</filename> 和 <literal>https://<replaceable>RMT_SERVER</replaceable>/rmt.crt</literal> 中找到。
    </para>
  </tip>
  
  <sect1 xml:id="sec-rmt-client-parameters">
    <title>使用引导参数配置客户端</title>

    <para>
      通过在计算机引导期间提供 <option>regurl</option> 参数，可将任何客户端配置为使用 RMT。
    </para>

    <para>
      需要以 <option>regurl=<replaceable>RMT_SERVER_URL</replaceable></option> 形式输入该参数。URL 需要采用 <literal>https://<replaceable>FQDN</replaceable></literal> 格式，其中 <replaceable>FQDN</replaceable> 为 RMT 服务器的完全限定主机名，必须与 RMT 服务器上使用的服务器证书的 FQDN 相同。示例：
    </para>

<screen>regurl=https://rmt.example.com</screen>

    <warning>
      <title>当心键入错误</title>
      <para>
        确保您输入的值是正确的。如果尚未正确指定 <option>regurl</option>，更新源的注册将失败。
      </para>
    </warning>

    <note>
      <title>更改 RMT 服务器证书</title>
      <para>
        如果 RMT 服务器从不可信 CA 获取新证书，客户端需要检索新 CA 证书文件。YaST 会显示用于导入新证书的对话框。如果您确认导入新证书，旧证书会替换为新证书。
      </para>
    </note>
  </sect1>
  <sect1 xml:id="sec-rmt-client-autoyast">
    <title>使用 AutoYaST 配置文件配置客户端</title>

    <para>
      您可以通过 AutoYaST 配置文件将客户端配置为注册到 RMT 服务器。要了解如何创建 AutoYaST 配置文件和准备自动安装，请参见《<emphasis>AutoYaST 指南</emphasis>》。本节仅介绍针对 RMT 的配置。
    </para>

    <para>
      要使用 AutoYaST 配置特定于 RMT 的数据，请执行适用于相关 RMT 客户端版本的步骤。
    </para>

    <procedure>
      <step>
        <para>
          以 <systemitem class="username">root</systemitem> 身份启动 YaST，然后选择<menuchoice>
          <guimenu> 杂项</guimenu> <guimenu> 自动安装</guimenu>
          </menuchoice> 启动图形 AutoYaST 前端。
        </para>
        <para>
          如果要从命令行启动图形 AutoYaST 前端，可以使用 <command>yast2 autoyast</command> 命令来完成。
        </para>
      </step>
      <step>
        <para>
          使用<menuchoice><guimenu>文件</guimenu>
          <guimenu>打开</guimenu></menuchoice>打开现有的配置文件。使用<menuchoice>
          <guimenu>工具</guimenu> <guimenu>创建参考配置文件</guimenu>
          </menuchoice>基于当前系统配置创建一个配置文件，或者使用空的配置文件。
        </para>
      </step>
      <step>
        <para>
          选择<menuchoice> <guimenu>软件</guimenu> <guimenu>产品注册</guimenu> </menuchoice>。将显示当前配置的概述。
        </para>
      </step>
      <step>
        <para>
          单击<guimenu>编辑</guimenu>。
        </para>
      </step>
      <step>
        <para>
          选中<guimenu>注册产品</guimenu>，在<guimenu>使用特定的服务器 URL 而不是默认值</guimenu>中设置 RMT 服务器的 URL，您还可以设置<guimenu>可选 SSL 服务器证书 URL</guimenu>。服务器 URL 的可能值与内核参数 <option>regurl</option> 的可能值相同。对于 SSL 证书位置，您可以使用采用 HTTP 或 HTTPS 的 URL。
        </para>
      </step>
      <step>
        <para>
          针对要部署的系统执行所有其他所需配置，然后单击<guimenu>完成</guimenu>返回主屏幕。
        </para>
      </step>
      <step>
        <para>
          选择<menuchoice> <guimenu>文件</guimenu> <guimenu>另存为</guimenu> </menuchoice>，然后输入配置文件的名称，例如 <filename>autoinst.xml</filename>。
        </para>
      </step>
    </procedure>
  </sect1>
  
  <sect1 xml:id="sec-rmt-client-clientsetupscript">
    <title>使用 <command>rmt-client-setup</command> 配置客户端</title>

    <para>
      <command>/usr/share/rmt/public/tools/rmt-client-setup</command> 脚本在软件包 <package>rmt-server</package> 中提供。此脚本可用于将客户端计算机配置为使用 RMT 服务器，还可用于将现有客户端重新配置为使用其他 RMT 服务器。
    </para>

    <para>
      要通过 <command>rmt-client-setup</command> 将客户端计算机配置为使用 RMT，请执行以下步骤：
    </para>

    <procedure>
      <step>
        <para>
          从 RMT 服务器下载 <filename>rmt-client-setup</filename>：
        </para>
<screen><prompt role="root"># </prompt><command>curl http://<replaceable>RMT_SERVER</replaceable>/tools/rmt-client-setup --output rmt-client-setup</command> </screen>
      </step>
      <step>
        <para>
          使用 RMT 服务器的 URL 作为参数运行脚本。
        </para>
<screen><prompt role="root"># </prompt><command>sh rmt-client-setup https://<replaceable>RMT_SERVER</replaceable>/</command></screen>
        <para>
          执行此脚本会将 RMT CA 的证书导入到可信证书存储区中。
        </para>
        <para>
          或者，您也可以指定服务器证书的正确指纹或路径。有关详细信息，请参见<command>sh rmt-client-setup
          --help</command>。
        </para>
      </step>
      <step>
        <para>
          该脚本下载服务器的 CA 证书。按 <keycap>Y</keycap> 接受该证书。现在，该工具即会在客户端上执行所有必要的修改。
        </para>
      </step>
      <step>
        <para>
          使用 <command>SUSEConnect</command> 添加更多产品。有关细节，请运行 <command>SUSEConnect --help</command>。
        </para>
      </step>
    </procedure>
  </sect1>
  
  <sect1 xml:id="sec-rmt-client-yast">
    <title>使用 YaST 配置客户端</title>

    <para>
      要将客户端配置为注册到 RMT 服务器，请使用 YaST <guimenu>产品注册</guimenu>模块 <command>yast2 registration</command>。
    </para>

    <para>
      在客户端上无需提供身份凭证，您可以将相关字段留空。单击<guimenu>本地注册服务器</guimenu>并输入其 URL。然后单击<guimenu>下一步</guimenu>，直到退出模块。
    </para>
  </sect1>
  <sect1 xml:id="rmt-client-custom-repo">
    <title>将客户端配置为使用自定义的独立储存库</title>

    <para>
      如果您在 RMT 服务器上创建了自定义的独立储存库，使用 <command>SUSEConnect</command> 将不会在客户端计算机上注册该储存库，因为它没有父产品。
    </para>

    <para>
      要手动添加该储存库，请执行以下步骤：
    </para>

    <procedure>
      <step>
        <para>
          将您的网页浏览器指向以下 RMT 服务器 URL：
        </para>
<screen>https://<replaceable>RMT_SERVER_HOSTNAME/repo/</replaceable></screen>
      </step>
      <step>
        <para>
          通过目录结构将浏览器导航到您的自定义储存库的 <filename>repodata/</filename> 子目录。
        </para>
      </step>
      <step>
        <para>
          在客户端计算机上添加发现的储存库 URL：
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> zypper ar <replaceable>CUSTOM_REPO_URL</replaceable> <replaceable>CUSTOM_REPO_NAME</replaceable></screen>
      </step>
    </procedure>
  </sect1>
  <sect1 xml:id="sec-rmt-client-list-repositories">
    <title>列出可访问的储存库</title>

    <para>
      要列出可用的模块和存储库，请使用 <command>SUSEConnect
      --list-extensions</command>。或者，您也可以通过访问 <literal>https://<replaceable>RMT_SERVER</replaceable>/repo/</literal> 及其子目录来浏览 RMT 服务器的目录列表。
    </para>
  </sect1>
  <sect1 xml:id="sec-rmt-client-online-migration">
    <title>联机迁移 SUSE Linux Enterprise 客户端</title>

    <para>
      您可以将注册到 RMT 中的 SUSE Linux Enterprise 客户端联机迁移到同一主要版本的最新服务包，迁移方法与迁移注册到 SUSE Customer Center 的客户端相同。开始迁移之前，请确保 RMT 中具有并已镜像所需产品。
    </para>

    <para>
      有关联机迁移的详细信息，请参见<xref linkend="cha-upgrade-paths"/>。
    </para>
  </sect1>
</chapter>
