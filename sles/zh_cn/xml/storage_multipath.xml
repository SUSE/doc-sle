<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="storage_multipath.xml" version="5.0" xml:id="cha.multipath" xml:lang="zh-cn">
 <title>管理设备的多路径 I/O </title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <para>
  本章介绍如何使用多路径 I/O (MPIO) 来管理服务器和块储存设备间多路径的故障转移和路径负载平衡。
 </para>
 <sect1 xml:id="sec.multipath.intro">
  <title>了解多路径 I/O</title>

  <para>
   多路径是服务器与跨多个物理路径（这些路径在服务器中的主机总线适配器和设备储存控制器之间）的同一物理或逻辑块储存设备通讯的能力，通常是在光纤通道 (FC) 或 iSCSI SAN 环境中。当多个通道可用时，您还可以实现与直接挂接的储存器的多个连接。
  </para>

  <para>
   Linux 的多路径提供连接容错，并可以跨多个活动连接提供负载平衡。当多路径已配置并且正在运行时，它会自动隔离和识别设备连接故障，并重路由 I/O 以改变连接。
  </para>

  <para>
   常见连接问题包括适配器、电缆或控制器故障。当为一个设备配置多路径 I/O 时，多路径驱动程序将监视设备之间的活动连接。当多路径驱动程序检测到一个活动路径出现 I/O 错误时，它会故障转移到该设备的指定备用路径。当首选路径再次正常时，控制权会返回到首选路径。
  </para>
 </sect1>
 <sect1 xml:id="sec.multipath.hardware">
  <title>硬件支持</title>

  <para>
   多路径驱动程序和工具支持 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 适用的所有体系结构。它们支持大多数储存阵列。存放多路径设备的储存阵列必须支持多路径，才能使用多路径驱动程序和工具。某些储存阵列供应商提供自己的多路径管理工具。请查看供应商的硬件文档以确定需要哪些设置。
  </para>

  <sect2 xml:id="sec.multipath.hardware.autodetect">
   <title>自动检测到支持多路径的储存阵列</title>
   <para>
    <filename>multipath-tools</filename> 包自动检测到以下储存阵列：
   </para>
   <simplelist>
    <member>3PARdata VV</member>
    <member> AIX NVDISK</member>
    <member> AIX VDASD</member>
    <member> APPLE Xserve RAID</member>
    <member> COMPELNT Compellent Vol</member>
    <member> COMPAQ/HP HSV101、HSV111、HSV200、HSV210、HSV300、HSV400、HSV 450</member>
    <member> COMPAQ/HP MSA、HSV</member>
    <member> COMPAQ/HP MSA VOLUME</member>
    <member> DataCore SANmelody</member>
    <member> DDN SAN DataDirector</member>
    <member> DEC HSG80</member>
    <member> DELL MD3000</member>
    <member> DELL MD3000i</member>
    <member> DELL MD32xx</member>
    <member> DELL MD32xxi</member>
    <member> DGC</member>
    <member> EMC Clariion</member>
    <member> EMC Invista</member>
    <member> EMC SYMMETRIX</member>
    <member> EUROLOGC FC2502</member>
    <member> FSC CentricStor</member>
    <member> FUJITSU ETERNUS_DX、DXL、DX400、DX8000</member>
    <member> HITACHI DF</member>
    <member> HITACHI/HP OPEN</member>
    <member> HP A6189A</member>
    <member> HP HSVX700</member>
    <member> HP LOGICAL VOLUME</member>
    <member> HP MSA2012fc、MSA 2212fc、MSA2012i</member>
    <member> HP MSA2012sa、MSA2312 fc/i/sa、MCA2324 fc/i/sa、MSA2000s VOLUME</member>
    <member> HP P2000 G3 FC|P2000G3 FC/iSCSI|P2000 G3 SAS|P2000 G3 iSCSI</member>
    <member> IBM 1722-600</member>
    <member> IBM 1724</member>
    <member> IBM 1726</member>
    <member> IBM 1742</member>
    <member> IBM 1745、1746</member>
    <member> IBM 1750500</member>
    <member> IBM 1814</member>
    <member> IBM 1815</member>
    <member> IBM 1818</member>
    <member> IBM 1820N00</member>
    <member> IBM 2105800</member>
    <member> IBM 2105F20</member>
    <member> IBM 2107900</member>
    <member> IBM 2145</member>
    <member> IBM 2810XIV</member>
    <member> IBM 3303 NVDISK</member>
    <member> IBM 3526</member>
    <member> IBM 3542</member>
    <member> IBM IPR</member>
    <member> IBM Nseries</member>
    <member> IBM ProFibre 4000R</member>
    <member> IBM S/390 DASD ECKD</member>
    <member> IBM S/390 DASD FBA</member>
    <member> Intel Multi-Flex</member>
    <member> LSI/ENGENIO INF-01-00</member>
    <member> NEC DISK ARRAY</member>
    <member> NETAPP LUN</member>
    <member> NEXENTA COMSTAR</member>
    <member> Pillar Axiom</member>
    <member> PIVOT3 RAIGE VOLUME</member>
    <member> SGI IS</member>
    <member> SGI TP9100、TP 9300</member>
    <member> SGI TP9400、TP9500</member>
    <member> STK FLEXLINE 380</member>
    <member> STK OPENstorage D280</member>
    <member> SUN CSM200_R</member>
    <member> SUN LCSM100_[IEFS]</member>
    <member> SUN STK6580、STK6780</member>
    <member> SUN StorEdge 3510、T4</member>
    <member> SUN SUN_6180</member>
   </simplelist>
   <para>
    一般来说，其他的储存阵列多数都可以用。当自动检测到储存阵列时，将应用多路径的默认设置。如果想要使用非默认设置，则必须手动创建和配置 <filename>/etc/multipath.conf</filename> 文件。这对不能自动侦测到的硬件也适用。有关信息，请参见<xref linkend="sec.multipath.conf_file" xrefstyle="SectTitleOnPage"/>。
   </para>
   <para>
    要注意下列事项：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      并非所有自动侦测到的储存阵列都已在 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 上经过测试。另请参见<xref linkend="sec.multipath.hardware.tested" xrefstyle="HeadingOnPage"/>。
     </para>
    </listitem>
    <listitem>
     <para>
      某些储存阵列可能需要特定的硬件处理程序。硬件处理程序是一个内核模块，当切换路径组和处理 I/O 错误时执行特定于硬件的操作。有关信息，请参见<xref linkend="sec.multipath.hardware.handlers" xrefstyle="HeadingOnPage"/>。
     </para>
    </listitem>
    <listitem>
     <para>
      每次修改 <filename>/etc/multipath.conf</filename> 文件后，都必须运行 <command>dracut</command> <option>-f</option> 在系统上重新创建 <systemitem>initrd</systemitem>。然后重引导系统以使更改生效。
     </para>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="sec.multipath.hardware.tested">
   <title>测试过的支持多路径的储存阵列</title>
   <para>
    下列供应商生产的储存阵列已在 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 上经过测试：
   </para>
   <simplelist>
    <member>EMC</member>
    <member> Hitachi</member>
    <member> Hewlett-Packard/Compaq</member>
    <member> IBM</member>
    <member> NetApp</member>
    <member> SGI</member>
   </simplelist>
   <para>
    其他供应商的储存阵列多数也可以用。请查看供应商的文档以获取相关指导。有关 <filename>multipath-tools</filename> 包可以识别的默认储存阵列的列表，请参见<xref linkend="sec.multipath.hardware.autodetect" xrefstyle="HeadingOnPage"/>。
   </para>
  </sect2>

  <sect2 xml:id="sec.multipath.hardware.handlers">
   <title>需要特定硬件处理程序的储存阵列</title>
   <para>
    要求特殊命令来进行一个路径向另一路径故障转移的储存阵列或要求特殊非标准错误处理的储存阵列，可能要求更多支持。因此，设备映射程序多路径服务有用于硬件处理程序的钩子。例如，已为 EMC CLARiiON CX 系列的阵列提供了一个此类处理程序。
   </para>
   <important>
    <title>更多信息</title>
    <para>
     请查看硬件供应商的文档以确定是否必须为设备映射程序多路径安装其硬件处理程序。
    </para>
   </important>
   <para>
    <command>multipath -t</command> 命令显示一个要求使用特定硬件处理程序进行特殊处理的内部储存阵列表。显示的列表不是受支持储存阵列的穷举列表。仅列出要求特殊处理并且在工具开发期间 <filename>multipath-tools</filename> 开发人员可以访问的那些阵列。
   </para>
   <important>
    <title>例外</title>
    <para>
     真正支持活动/活动多路径的阵列不要求特殊处理，所以 <command>multipath -t</command> 命令不会列出它们。
    </para>
   </important>
   <para>
    <command>multipath -t</command> 表中的列表不一定表示在该特定硬件上测试过 SUSE Linux Enterprise Server。<phrase role="productname"><phrase os="sles"/></phrase>对于已测试过的储存阵列的列表，请参见<xref linkend="sec.multipath.hardware.tested" xrefstyle="HeadingOnPage"/>。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.multipath.planning">
  <title>规划多路径</title>

  <para>
   当规划多路径 I/O 解决方案时，请使用本节中的准则。
  </para>

  <sect2 xml:id="sec.multipath.planning.prereq">
   <title>先决条件</title>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      多路径在设备级别进行管理。
     </para>
    </listitem>
    <listitem>
     <para>
      用于多路径设备的储存阵列必须支持多路径。有关详细信息，请参见<xref linkend="sec.multipath.hardware" xrefstyle="SectTitleOnPage"/>。
     </para>
    </listitem>
    <listitem>
     <para>
      仅当在服务器中的主机总线适配器和块储存设备的主机总线控制器之间存在多个物理路径时，才需要配置多路径。您可以将逻辑设备的多路径配置为对服务器可见。
     </para>
    </listitem>
    <listitem>
     <para>
      对于某些储存阵列，供应商提供其自己的多路径软件以管理该阵列物理和逻辑设备的多路径。在这种情况下，您应遵循供应商关于为这些设备配置多路径的说明。
     </para>
    </listitem>
    <listitem>
     <para>
      当在虚拟化环境中使用多路径时，多路径在主机服务器环境中控制。先配置设备的多路径，再将其指派给虚拟 Guest 计算机。
     </para>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="sec.multipath.planning.disks">
   <title>磁盘管理任务</title>
   <para>
    尝试为有多个路径的物理或逻辑设备配置多路径之前，请执行以下磁盘管理任务：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      使用第三方工具将物理磁盘刻为几个较小的逻辑磁盘。
     </para>
    </listitem>
    <listitem>
     <para>
      使用第三方工具将物理或逻辑磁盘分区。如果在运行的系统中更改分区，设备映射程序多路径 (DM-MP) 模块不会自动检测和反映这些更改。DM-MPIO 必须重新初始化，这通常要求重引导。
     </para>
    </listitem>
    <listitem>
     <para>
      使用第三方 SAN 阵列管理工具创建和配置硬件 RAID 设备。
     </para>
    </listitem>
    <listitem>
     <para>
      使用第三方 SAN 阵列管理工具创建诸如 LUN 的逻辑设备。给定阵列支持的逻辑设备类型取决于阵列供应商。
     </para>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="sec.multipath.planning.raid">
   <title>软件 RAID</title>
   <para>
    Linux 软件 RAID 管理软件在多路径的基础上运行。对于具有多个 I/O 路径以及您计划在软件 RAID 中使用的每个设备，必须将该设备配置为支持多路径，才能尝试创建软件 RAID 设备。不能自动发现多路径设备。软件 RAID 并不了解在底层运行的多路径管理。
   </para>
   <para>
    有关为现有软件 RIAD 设置多路径的信息，请参见<xref linkend="sec.multipath.raid" xrefstyle="SectTitleOnPage"/>。
   </para>
  </sect2>

  <sect2 xml:id="sec.multipath.planning.ha">
   <title>高可用性解决方案</title>
   <para>
    群集储存资源的高可用性解决方案基于每个节点上的多路径服务运行。请确保每个节点上的 <filename>/etc/multipath.conf</filename> 文件中的配置设置在整个集群中保持一致。
   </para>
   <para>
    确保多路径设备在所有设备中的名称都相同。有关详细信息，请参见<xref linkend="sec.multipath.names.ha"/>。
   </para>
   <para>
    用于跨 LAN 镜像设备的分布式复制块设备 (DRBD) 高可用性解决方案在多路径的基础上运行。对于具有多个 I/O 路径并且您计划在 DRDB 解决方案中使用的每个设备，必须先将该设备配置为支持多路径，再配置 DRBD。
   </para>
  </sect2>

  <sect2 xml:id="sec.multipath.planning.initrd">
   <title>
    始终让 <filename>initrd</filename> 与系统配置保持同步
   </title>
   <para>
    使用多路径时最重要的一项要求是，需确保在根文件系统及引导系统所需的所有其他文件系统方面，<filename>initrd</filename> 与已安装的系统行为一致。如果在系统中启用了多路径，那么也需要在 <filename>initrd</filename> 中启用多路径，反之亦然。有关详细信息，请参见<xref linkend="sec.multipath.configuration.start"/>。
   </para>
   <para>
    如果 <filename>initrd</filename> 与系统不同步，系统将无法正常引导，启动过程将产生应急外壳。有关如何避免或修复此类情况的说明，请参见<xref linkend="sec.multipath.trouble.root"/>。
   </para>
  </sect2>

 </sect1>
 <sect1 xml:id="sec.multipath.mpiotools">
  <title>多路径管理工具</title>

  <para>
   <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 中的多路径支持以 Linux 内核的设备映射程序多路径模块及 <systemitem>multipath-tools</systemitem> 用户空间包为基础。您可以使用 Multiple Devices Administration 实用程序（MDADM，<command>mdadm</command>）查看多路径设备的状态。
  </para>

  <sect2 xml:id="sec.multipath.mpiotools.dm">
   <title>设备映射程序多路径模块</title>
   <para>
    设备映射程序多路径 (DM-MP) 模块为 Linux 提供多路径功能。DM-MPIO 是在 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 上实施多路径的首选解决方案。它是该产品随附的唯一一个多路径选项，完全受 SUSE 支持。
   </para>
   <para>
    DM-MPIO 可以为各种设置自动配置多路径子系统。每个设备最多可配置 8 个路径。支持活动/不活动（一个路径活动、其他路径不活动）或活动/活动（所有路径都是活动，带循环负载平衡）的配置。
   </para>
   <para>
    DM-MPIO 框架可按两种方式扩展：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      使用特定硬件处理程序。有关信息，请参见<xref linkend="sec.multipath.hardware.handlers" xrefstyle="HeadingOnPage"/>。
     </para>
    </listitem>
    <listitem>
     <para>
      使用比循环算法更精准的负载平衡算法。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    DM-MPIO 的用户空间组件负责自动路径发现和分组以及自动路径再测试，以便先前失败的路径在恢复正常后可以自动重新启用。这可以最大程度地降低管理员对生产环境的关注。
   </para>
   <para>
    DM-MPIO 保护设备路径以及设备本身不会出故障。如果一个活动路径丢失（例如，一个网络适配器 I/O 断开或光纤电缆被删除），I/O 会重定向到剩余的路径。如果该配置是活动/不活动，则路径会故障转移到一个不活动路径。如果正在使用循环负载平衡配置，则会在剩余正常路径间平衡通讯量。如果所有活动路径均失败，则必须唤醒不活动的辅助路径，因此需经过大约 30 秒的延迟之后才会开始故障转移。
   </para>
   <para>
    如果一个磁盘阵列有多个储存处理器，请确保 SAN 交换机连接到拥有要访问的 LUN 的储存处理器。在多数磁盘阵列上，所有 LUN 均属于这两个储存处理器，所以两个连接都是活动的。
   </para>
   <note>
    <title>储存处理器</title>
    <para>
     在某些磁盘阵列上，储存阵列通过储存处理器管理通讯，以便一次仅显示一个储存处理器。一个处理器是活动的，另一个是不活动的，直到发生故障。如果您连接到错误的储存处理器（具有不活动路径的那个），则可能无法看到所需的 LUN，或者可能看到这些 LUN，但在尝试访问它们时会出错。
    </para>
   </note>
   <table>
    <title>储存阵列的多路径 I/O 功能</title>
    <tgroup cols="2">
     <colspec colnum="1" colname="1" colwidth="2857*"/>
     <colspec colnum="2" colname="2" colwidth="7144*"/>
     <thead>
      <row>
       <entry>
        <para>
         储存阵列的功能
        </para>
       </entry>
       <entry>
        <para>
         描述
        </para>
       </entry>
      </row>
     </thead>
     <tbody>
      <row>
       <entry>
        <para>
         活动/不活动控制器
        </para>
       </entry>
       <entry>
        <para>
         一个控制器是活动的，为所有 LUN 提供服务。第二个控制器充当备用控制器。第二个控制器还将 LUN 提供给多路径组件，以便操作系统了解冗余路径。如果主控制器失败，第二个控制器会接管，并且它为所有 LUN 提供服务。
        </para>
        <para>
         在某些阵列中，LUN 可以指派给不同的控制器。给定的 LUN 指派给要充当活动控制器的一个控制器。一个控制器一次可为任何 LUN 执行磁盘 I/O，第二个控制器是该 LUN 的备用控制器。第二个控制器也提供这些路径，但不可执行磁盘 I/O。使用该 LUN 的服务器连接到该 LUN 的指派的控制器。如果一组 LUN 的主控制器失败，第二个控制器会接管，并且它为所有 LUN 提供服务。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         活动/活动控制器
        </para>
       </entry>
       <entry>
        <para>
         两个控制器均分所有 LUN 的负载，并且可以处理任何 LUN 的磁盘 I/O。如果一个控制器失败，第二个处理器会自动处理所有通讯。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         负载平衡
        </para>
       </entry>
       <entry>
        <para>
         设备映射程序多路径驱动程序自动对所有活动路径中的通讯平衡负载。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         控制器故障转移
        </para>
       </entry>
       <entry>
        <para>
         当活动控制器故障转移到不活动控制器（或备用控制器）时，设备映射程序多路径驱动程序会自动激活主机和备用控制器之间的路径，使它们成为主路径。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         引导/根设备支持
        </para>
       </entry>
       <entry>
        <para>
         在 SUSE Linux Enterprise Server 10 和更高版本中，根 (<filename>/</filename>) 设备支持多路径。<phrase role="productname"><phrase os="sles"/></phrase>主机服务器必须连接到引导设备当前活动的控制器和储存处理器。
        </para>
        <para>
         在 SUSE Linux Enterprise Server 11 和更高版本中，<filename>/boot</filename> 设备支持多路径。<phrase role="productname"><phrase os="sles"/></phrase>
        </para>
       </entry>
      </row>
     </tbody>
    </tgroup>
   </table>
   <para>
    设备映射程序多路径将多路径设备的每个路径检测为独立的 SCSI 设备。SCSI 设备名的格式为 <filename>/dev/sd<replaceable>N</replaceable></filename>，其中 <filename><replaceable>N</replaceable></filename> 是为该设备自动生成的字母，从 a 开始，并在设备创建时顺序发放，例如 <filename>/dev/sda</filename>、<filename>/dev/sdb</filename> 等。如果设备数超过 26，则会使用两个字母，这样在 <filename>/dev/sdz</filename> 后的下一个设备将命名为 <filename>/dev/sdaa</filename>、<filename>/dev/sdab</filename> 等。
   </para>
   <para>
    如果未自动检测到多路径，则您可以在 <filename>/etc/multipath.conf</filename> 文件中手动配置它们。<filename>multipath.conf</filename> 文件在您创建和配置之前是不存在的。有关信息，请参见<xref linkend="sec.multipath.conf_file" xrefstyle="SectTitleOnPage"/>。
   </para>
  </sect2>

  <sect2 xml:id="sec.multipath.mpiotools.io_management">
   <title>多路径 I/O 管理工具</title>
   <para>
    <systemitem class="resource">multipath-tools</systemitem> 和 <systemitem class="resource">kpartx</systemitem> 包提供了负责执行自动路径发现和分组的工具。它们会定期自动测试路径，这样，先前失败的路径在恢复正常后，便可自动重新启用。这可以最大程度地降低管理员对生产环境的关注。
   </para>
   <table>
    <title>multipath-tools 包中的工具</title>
    <tgroup cols="2">
     <colspec colnum="1" colname="1" colwidth="2857*"/>
     <colspec colnum="2" colname="2" colwidth="7144*"/>
     <thead>
      <row>
       <entry>
        <para>
         工具
        </para>
       </entry>
       <entry>
        <para>
         描述
        </para>
       </entry>
      </row>
     </thead>
     <tbody>
      <row>
       <entry>
        <para>
         <command>multipath</command>
        </para>
       </entry>
       <entry>
        <para>
         扫描系统中的多路径设备并组装它们。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <command>multipathd</command>
        </para>
       </entry>
       <entry>
        <para>
         等候映射事件，然后执行 <command>multipath</command>。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <command>kpartx</command>
        </para>
       </entry>
       <entry>
        <para>
         将线性 devmaps 映射到多路径设备上的分区，使得能够为设备上的分区创建多路径监视。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <command>mpathpersist</command>
        </para>
       </entry>
       <entry>
        <para>
         在设备映射程序多路径 devices.ppc 上管理 SCSI 永久保留
        </para>
       </entry>
      </row>
     </tbody>
    </tgroup>
   </table>
  </sect2>

  <sect2 xml:id="sec.multipath.mpiotools.mdadm">
   <title>对多路径设备使用 MDADM</title>
   <para>
    udev 是默认设备处理程序，系统会自动知道设备的全球 ID 而不是设备节点名。它解决了以前版本的 MDADM 和 LVM 中的问题，即配置文件（<filename>mdadm.conf</filename> 和 <filename>lvm.conf</filename>）不能正确识别多路径设备。
   </para>
   <para>
    与 LVM2 一样，MDADM 也要求通过 ID 而非设备节点路径访问设备。因此，<filename>/etc/mdadm.conf</filename> 中的 <systemitem>DEVICE</systemitem> 项应如下设置：
   </para>
<screen>DEVICE /dev/disk/by-id/*</screen>
   <para>
    如果要使用用户友好的名称，请按以下方式指定路径，以便在配置多路径后仅对设备映射程序名称进行扫描：
   </para>
<screen>DEVICE /dev/disk/by-id/dm-uuid-.*-mpath-.*</screen>
  </sect2>

  <sect2 xml:id="sec.multipath.mpiotools.multipath">
   <title>multipath 命令</title>
   <para>
    使用 Linux 的 <command>multipath(8)</command> 命令配置和管理多路径设备。该命令的一般语法如下所示：
   </para>
<screen>multipath [-v verbosity_level] [-b bindings_file] [-d] [-h|-l|-ll|-f|-F|-B|-c|-q|-r|-w|-W|-t] [-p failover|multibus|group_by_serial|group_by_prio|group_by_node_name] [<replaceable>devicename</replaceable>]</screen>
   <para>
    有关细节，请参见 <command>man 8 multipath</command>。
   </para>
   <bridgehead>常规示例</bridgehead>
   <variablelist>
    <varlistentry>
     <term>multipath</term>
     <listitem>
      <para>
       配置所有多路径设备。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath <replaceable>设备名</replaceable>
     </term>
     <listitem>
      <para>
       配置特定多路径设备。
      </para>
      <para>
       使用诸如 <filename>/dev/sdb</filename>（如 udev 的 $DEVNAME 变量中所示）或<literal>主要:次要</literal>格式的设备节点名替换<replaceable>设备名</replaceable>。也可以使用该设备的多路径映射名称。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -f</term>
     <listitem>
      <para>
       选择性地抑制多路径映射及其设备映射的分区。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -d</term>
     <listitem>
      <para>
       排演。显示潜在多路径设备，但不创建任何设备，也不更新设备映射。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -v2 -d</term>
     <listitem>
      <para>
       显示试运行中潜在多路径设备的多路径映射信息。-v2 选项仅显示本地磁盘。这种详细级别仅打印创建或更新的多路径名称，用于为 kpartx 之类的其他工具提供输入。
      </para>
      <para>
       如果设备已经存在且未作更改，则无输出。使用 <command>multipath -ll</command> 可以查看配置的多路径设备的状态。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -v2 <replaceable>设备名</replaceable>
     </term>
     <listitem>
      <para>
       配置特定潜在多路径设备并显示它的多路径映射信息。这种详细级别仅打印创建的或更新的多路径名称，以用来为 <command>kpartx</command> 之类的其他工具提供输入。
      </para>
      <para>
       如果设备已经存在且未作更改，则无输出。使用 <command>multipath -ll</command> 可以查看配置的多路径设备的状态。
      </para>
      <para>
       使用诸如 <filename>/dev/sdb</filename>（如 <command>udev</command> 的 $DEVNAME 变量中所示）或<literal>主要:次要</literal>格式的设备节点名替换<replaceable>设备名</replaceable>。也可以使用该设备的多路径映射名称。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -v3</term>
     <listitem>
      <para>
       配置潜在多路径设备并显示它们的多路径映射信息。这种详细级别打印所有检测到的路径、多路径和设备映射。WWID 和 <literal>devnode</literal> 列入黑名单的设备都会显示。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -v3 <replaceable>设备名</replaceable>
     </term>
     <listitem>
      <para>
       配置特定潜在多路径设备并显示相关信息。-v3 选项显示完整的路径列表。这种详细级别打印所有检测到的路径、多路径和设备映射。WWID 和 <literal>devnode</literal> 列入黑名单的设备都会显示。
      </para>
      <para>
       使用诸如 <filename>/dev/sdb</filename>（如 <command>udev</command> 的 $DEVNAME 变量中所示）或<literal>主要:次要</literal>格式的设备节点名替换<replaceable>设备名</replaceable>。也可以使用该设备的多路径映射名称。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -ll</term>
     <listitem>
      <para>
       显示所有多路径设备的状态。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -ll <replaceable>设备名</replaceable>
     </term>
     <listitem>
      <para>
       显示特定多路径设备的状态。
      </para>
      <para>
       使用诸如 <filename>/dev/sdb</filename>（如 <command>udev</command> 的 $DEVNAME 变量中所示）或<literal>主要:次要</literal>格式的设备节点名替换<replaceable>设备名</replaceable>。也可以使用该设备的多路径映射名称。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -F</term>
     <listitem>
      <para>
       刷新所有未用多路径设备映射。它不解析多路径，且不删除设备。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -F <replaceable>设备名</replaceable>
     </term>
     <listitem>
      <para>
       刷新特定多路径设备的未用多路径设备映射。它不解析多路径，且不删除设备。
      </para>
      <para>
       使用诸如 <filename>/dev/sdb</filename>（如 <command>udev</command> 的 $DEVNAME 变量中所示）或<literal>主要:次要</literal>格式的设备节点名替换<replaceable>设备名</replaceable>。也可以使用该设备的多路径映射名称。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -p [ failover | multibus | group_by_serial | group_by_prio | group_by_node_name ]</term>
     <listitem>
      <para>
       指定下表中所述的其中一个组策略选项来设置组策略：
      </para>
      <table>
       <title>multipath -p 命令的组策略选项</title>
       <tgroup cols="2">
        <colspec colnum="1" colname="1" colwidth="2684*"/>
        <colspec colnum="2" colname="2" colwidth="7319*"/>
        <thead>
         <row>
          <entry>
           <para>
            策略选项
           </para>
          </entry>
          <entry>
           <para>
            描述
           </para>
          </entry>
         </row>
        </thead>
        <tbody>
         <row>
          <entry>
           <para>
            failover
           </para>
          </entry>
          <entry>
           <para>
            （默认）每个优先级组对应一个路径。您一次只能使用一个路径。
           </para>
          </entry>
         </row>
         <row>
          <entry>
           <para>
            multibus
           </para>
          </entry>
          <entry>
           <para>
            一个优先级组中的所有路径。
           </para>
          </entry>
         </row>
         <row>
          <entry>
           <para>
            group_by_serial
           </para>
          </entry>
          <entry>
           <para>
            每个检测到的 SCSI 序列号（控制器节点全球编号）一个优先级组。
           </para>
          </entry>
         </row>
         <row>
          <entry>
           <para>
            group_by_prio
           </para>
          </entry>
          <entry>
           <para>
            每个路径优先级值一个优先级组。具有相同优先级的路径在同一优先级组中。优先级由调出程序在 <filename>/etc/multipath.conf</filename> 配置文件中指定为 global、per-controller 或 per-multipath 选项来确定。
           </para>
          </entry>
         </row>
         <row>
          <entry>
           <para>
            group_by_node_name
           </para>
          </entry>
          <entry>
           <para>
            每个目标节点名一个优先级组。目标节点名是在 <filename>/sys/class/fc_transport/target*/node_name</filename> 位置获取的。
           </para>
          </entry>
         </row>
        </tbody>
       </tgroup>
      </table>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -t</term>
     <listitem>
      <para>
       显示内部硬件表和活动的多路径配置。有关配置参数的细节，请参见 <command>man multipath</command>。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec.multipath.mpiotools.mpathpersist">
   <title>mpathpersist 实用程序</title>
   <para>
    <command>mpathpersist</command> 实用程序可用来管理设备映射程序多路径设备上的 SCSI 永久保留。该命令的一般语法如下所示：
   </para>
<screen>mpathpersist [options] [device]</screen>
   <para>
    有关细节，请参见 <command>man 8 mpathpersist</command>。
   </para>
   <para>
    将此实用程序与 <filename>/etc/multipath.conf</filename> 文件中的服务操作保留密钥（<literal>reservation_key</literal> 属性）搭配使用，设置 SCSI 设备的永久保留。默认情况下不会使用该属性。如果未设置该属性，<command>multipathd</command> 守护程序不会检查新发现的路径或已重新启用的路径的永久保留。
   </para>
<screen>reservation_key &lt;<replaceable>reservation key</replaceable>&gt;</screen>
   <para>
    您可以将该属性添加到 <literal>defaults</literal> 或 <literal>multipaths</literal> 部分。例如：
   </para>
<screen>multipaths {
  multipath {
    wwid   XXXXXXXXXXXXXXXX
    alias      yellow
    reservation_key  0x123abc
  }
}</screen>
   <para>
    设置所有适合永久管理的多路径设备的 <literal>reservation_key</literal> 参数，然后运行以下命令重启动 <systemitem class="daemon">multipathd</systemitem> 守护程序：
   </para>
<screen>sudo systemctl restart multipathd</screen>
   <para>
    设置它之后，您可以在 <command>mpathpersist</command> 命令中指定保留密钥。
   </para>
   <bridgehead>示例</bridgehead>
   <variablelist>
    <varlistentry>
     <term>mpathpersist --out --register --param-sark=123abc --prout-type=5 -d /dev/mapper/mpath9</term>
     <listitem>
      <para>
       注册 <filename>/dev/mapper/mpath9</filename> 设备的服务操作保留密钥。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>mpathpersist -i -k -d /dev/mapper/mpath9</term>
     <listitem>
      <para>
       读取 <filename>/dev/mapper/mpath9</filename> 设备的服务操作保留密钥。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>mpathpersist --out --reserve --param-sark=123abc --prout-type=8 -d /dev/mapper/mpath9</term>
     <listitem>
      <para>
       保留 <filename>/dev/mapper/mpath9</filename> 设备的服务操作保留密钥。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>mpathpersist -i -s -d /dev/mapper/mpath9</term>
     <listitem>
      <para>
       读取 <filename>/dev/mapper/mpath9</filename> 设备的保留状态。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.multipath.config">
  <title>为多路径配置系统</title>

  <para/>

  <sect2 xml:id="sec.multipath.configuration.start">
   <title>启用、禁用、启动和停止多路径 I/O 服务</title>
   <para>
    要允许多路径服务在引导时启动，请运行以下命令：
   </para>
<screen>sudo systemctl enable multipathd</screen>
   <para>
    要在正在运行的系统中手动启动服务，或是检查其状态，请输入以下其中一个命令：
   </para>
   <screen>sudo systemctl start multipathd
sudo systemctl status multipathd</screen>
   <para>
    要在当前会话中停止多路径服务，以及要禁用该服务以便在系统下次引导时不启动它，请运行以下命令：
   </para>
   <screen>sudo systemctl stop multipathd
sudo systemctl disable multipathd</screen>

   <important xml:id="ann.multipath.configuration.initrd">
    <title>重构建 <systemitem>initrd</systemitem></title>
    <para>
     每次启用或禁用多路径服务时，还需要重构建 <systemitem>initrd</systemitem>，否则系统可能无法再引导。启用多路径服务时，还要运行以下命令以重构建 initrd：
    </para>
    <screen>dracut --force --add multipath</screen>
    <para>
     禁用服务时，则运行以下命令以重构建 initrd：
    </para>
    <screen>dracut --force -o multipath</screen>
    <para>
     （可选）此外，如果您还想确保任何情况下都不会设置多路径设备（即使手动启动了多路径），请在重构建 initrd 之前，将以下几行添加到 <filename>/etc/multipath.conf</filename> 的末尾：
    </para>
    <screen>blacklist {
    wwid ".*"
}</screen>
   </important>
  </sect2>

  <sect2 xml:id="sec.multipath.configuration.sandevs">
   <title>为多路径准备 SAN 设备</title>
   <para>
    配置 SAN 设备的多路径 I/O 之前，请按需要执行以下操作准备 SAN 设备：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      使用供应商工具配置 SAN 并设置区域。
     </para>
    </listitem>
    <listitem>
     <para>
      使用供应商工具为储存阵列上的主机 LUN 配置访问权限。
     </para>
    </listitem>
    <listitem>
     <para>
      安装 Linux HBA 驱动程序模块。安装好模块后，驱动程序会自动扫描 HBA，以发现对该主机有访问权限的任何 SAN 设备。它将这些 SAN 设备提供给主机以进行进一步的配置。
     </para>
     <note>
      <title>无本机多路径</title>
      <para>
       确保您正在使用的 HBA 驱动程序没有启用本机多路径。
      </para>
     </note>
     <para>
      有关更多细节，请参见供应商的特定说明。
     </para>
    </listitem>
    <listitem>
     <para>
      装载驱动程序模块之后，发现指派给特定阵列 LUN 或分区的设备节点。
     </para>
    </listitem>
    <listitem>
     <para>
      如果将 SAN 设备用作服务器上的根设备，请按<xref linkend="sec.multipath.best_practice.san_timeout" xrefstyle="SectTitleOnPage"/>中所述修改设备超时设置。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    如果 HBA 驱动程序没有看到这些 LUN，则可以使用 <command>lsscsi</command> 检查操作系统是否正确看到这些 SCSI 设备。如果 HBA 驱动程序没有看到这些 LUN，请检查 SAN 的区域设置。特别是要检查 LUN 屏蔽是否是活动的，以及是否已将 LUN 正确指派给服务器。
   </para>
   <para>
    如果 HBA 驱动程序看到这些 LUN，但没有相应的块设备，则需要其他内核参数来更改 SCSI 设备扫描行为，例如表示 LUN 不连续编号。有关信息，请参见 SUSE 知识库 (<link xlink:href="https://www.suse.com/support/kb/doc.php?id=3955167"/>) 中的 <citetitle>TID 3955167：Troubleshooting SCSI (LUN) Scanning Issues</citetitle>（SCSI (LUN) 扫描问题查错）。
   </para>
  </sect2>

  <sect2 xml:id="sec.multipath.configuration.partitioning">
   <title>将多路径设备分区</title>
   <para>
    不建议使用但支持有多个路径的分区设备。使用 <command>kpartx</command> 工具无需重引导即可在多路径设备中创建分区。也可以在尝试配置多路径之前，使用 YaST 中的“分区程序”功能或使用第三方分区工具对设备分区。
   </para>
   <para>
    多路径设备是设备映射程序设备。虽然使用命令行工具（例如 parted、kpartx 或 fdisk）可以修改设备映射程序设备，但这并不一定会生成更新其他层所需的 udev 事件。对设备映射程序设备分区之后，您应该检查多路径映射，确保已映射设备映射程序设备。如果未映射它们，您可以重新映射多路径设备，或重引导服务器，以取得多路径映射中的所有新分区。
   </para>
   <para>
    多路径设备上的一个分区的设备映射程序设备不同于一个独立设备。使用整个设备创建 LVM 逻辑卷时，必须指定不包含分区的设备。如果将多路径分区指定为 LVM 逻辑卷的目标设备，则 LVM 会认为底层物理设备已分区，创建将会失败。如果需要细分 SAN 设备，则可以拆分 SAN 设备上的 LUN，并将每个 LUN 作为独立的多路径设备显示给服务器。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.multipath.conf_file">
  <title>创建或修改 /etc/multipath.conf 文件</title>

  <para>
   只有创建 <filename>/etc/multipath.conf</filename>，该文件才会存在。除非您创建多路径配置文件并进行个性化设置，否则在运行守护程序 <command>multipathd</command> 时，将自动应用默认的多路径设备设置。
  </para>

  <important>
   <title>
    测试及永久性应用 <filename>/etc/multipath.conf</filename> 中的更改
   </title>
   <para>
    无论您何时创建或修改 <filename>/etc/multipath.conf</filename> 文件，当保存该文件时都不会自动应用更改。这样，您便可以在提交更改之前，先进行试运行以校验这些更改。如果对修改后的设置满意，便可按<xref linkend="sec.multipath.conf_file.apply"/>中所述来更新多路径映射。
   </para>
  </important>

  <sect2 xml:id="sec.multipath.conf_file.create">
   <title>创建 /etc/multipath.conf 文件</title>
   <procedure>
    <step>
     <para>
      使用惯用的编辑器创建一个空的 <filename>/etc/multipath.conf</filename> 文件。
     </para>
    </step>
    <step>
     <para>
      请确保为您的 SAN 添加相应的 <literal>device</literal> 部分。多数供应商提供关于正确设置 <command>device</command> 部分的文档。请注意，不同的 SAN 需要单独的 <literal>device</literal> 部分。
     </para>
     <para>
      如果要使用自动检测到的储存子系统（请参见<xref linkend="sec.multipath.hardware.autodetect" xrefstyle="HeadingOnPage"/>），则不需要添加 <literal>device</literal>，因为在此情况下将会应用此设备的默认设置。
     </para>
    </step>
    <step>
     <para>
      创建 <literal>blacklist</literal> 部分，在其中包含您计算机的所有非多路径设备。有关详细信息，请参见<xref linkend="sec.multipath.blacklist"/>。
     </para>
    </step>
    <step>
     <para>
      视需要在配置文件中添加更多部分。有关简要介绍，请参考<xref linkend="sec.multipath.conf_file.sections"/>。运行 <command>man 5 multipath.conf</command> 时会有更多细节可用。
     </para>
    </step>
    <step>
     <para>
      完成后，保存 <filename>/etc/multipath.conf</filename> 并按<xref linkend="sec.multipath.conf_file.verify"/>中所述测试您的设置。
     </para>
    </step>
    <step>
     <para>
      成功校验配置后，请按<xref linkend="sec.multipath.conf_file.apply"/>中所述应用配置。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.multipath.conf_file.sections">
   <title><filename>/etc/multipath.conf</filename> 文件中的部分</title>
   <para>
    <filename>/etc/multipath.conf</filename> 文件由下列部分构成。有关细节，请参见 <command>man 5 multipath.conf</command>。
   </para>
   <variablelist>
    <varlistentry>
     <term>defaults</term>
     <listitem>
      <para>
       多路径 I/0 的常规默认设置。如果在相应的设备或多路径部分中未提供值，则会使用这些值。有关信息，请参阅<xref linkend="sec.multipath.policies_default" xrefstyle="SectTitleOnPage"/>。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>blacklist</term>
     <listitem>
      <para>
       列出不作为候选多路径而丢弃的设备名称。可以通过设备节点名称 (<literal>devnode</literal>)、设备 WWID (<literal>wwid</literal>) 或设备供应商或产品字符串 (<literal>device</literal>) 来识别设备。您通常会忽略非多路径设备，例如 hpsa、fd、hd、md、dm、sr、scd、st、ram、raw 和 loop。有关详细信息和示例，请参见<xref linkend="sec.multipath.blacklist" xrefstyle="HeadingOnPage"/>。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>blacklist_exceptions</term>
     <listitem>
      <para>
       列出即使包含在黑名单中仍视为候选多路径的设备的设备名称。可以通过设备节点名称 (<literal>devnode</literal>)、设备 WWID (<literal>wwid</literal>) 或设备供应商或产品字符串 (<literal>device</literal>) 来识别设备。您必须使用黑名单中使用的相同关键字指定例外的设备。例如，如果您在黑名单中对设备使用了关键字 <literal>devnode</literal>，则需同样使用关键字 <literal>devnode</literal> 在黑名单例外中排除一些设备。您无法使用 <literal>devnode</literal> 关键词将设备加入黑名单，也无法使用 <literal>wwid</literal> 关键词排除其中某些设备。有关详细信息和示例，请参见<xref linkend="sec.multipath.blacklist" xrefstyle="HeadingOnPage"/>。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipaths</term>
     <listitem>
      <para>
       指定单个多路径设备的设置。除不支持单个设置的设置外，这些值会重写配置文件的 <literal>defaults</literal> 和 <literal>devices</literal> 部分中的其他指定值。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>devices</term>
     <listitem>
      <para>
       指定单个储存控制器的设置。这些值会重写配置文件的 <filename>defaults</filename> 部分中指定的值。如果您使用默认情况下不受支持的储存阵列，则可以创建 <literal>devices</literal> 子部分，以指定该储存阵列的默认设置。如果关键字允许，则可以使用单个多路径设备的设置重写这些值。
      </para>
      <para>
       有关信息，请参见以下内容：
      </para>
      <itemizedlist mark="bullet" spacing="normal">
       <listitem>
        <para>
         <xref linkend="sec.multipath.names" xrefstyle="SectTitleOnPage"/>
        </para>
       </listitem>
       <listitem>
        <para>
         <xref linkend="sec.multipath.best_practice.zseries" xrefstyle="SectTitleOnPage"/>
        </para>
       </listitem>
      </itemizedlist>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec.multipath.conf_file.verify">
   <title>校验 /etc/multipath.conf 文件中的多路径设置</title>
   <para>
    无论您何时创建或修改 <filename>/etc/multipath.conf</filename> 文件，当保存该文件时都不会自动应用更改。您可以在更新多路径映射之前对该设置执行<quote>试运行</quote>，以校验多路径设置。
   </para>
   <para>
    在服务器命令提示符处输入
   </para>
<screen>sudo multipath -v2 -d</screen>
   <para>
    此命令会扫描设备，然后显示如果提交更改设置将产生的效果。该命令假设在您修改 <filename>/etc/multipath.conf</filename> 文件并执行试运行时，守护程序 <systemitem class="daemon">multipathd</systemitem> 已使用旧的（或默认）多路径设置运行。如果更改可接受，请继续下一步。
   </para>
   <para>
    其输出类似于如下内容：
   </para>
<screen>26353900f02796769
[size=127 GB]
[features="0"]
[hwhandler="1    emc"]

\_ round-robin 0 [first]
  \_ 1:0:1:2 sdav 66:240  [ready ]
  \_ 0:0:1:2 sdr  65:16   [ready ]

\_ round-robin 0
  \_ 1:0:0:2 sdag 66:0    [ready ]
  \_ 0:0:0:2 sdc   8:32   [ready ]
</screen>
   <para>
    路径可分为多个优先级组。一次只有一个优先级组是活动的。要为活动/活动配置建模，所有路径都要分入同一个组。要构建活动/不活动配置，不应同时活动的路径要放在几个不同的优先级组中。这在设备发现中通常自动发生。
   </para>
   <para>
    输出显示在组里用来平衡 I/O 的顺序、日程安排策略以及每个优先级组的路径。对于每个路径，显示其物理地址 (host:bus:target:lun)、设备节点名称、主要:次要编号以及状态。
   </para>
   <para>
    在试运行中使用详细级别 -v3，即可查看所有检测到的路径、多路径和设备映射。它同时显示 WWID 和设备节点列入黑名单的设备。
   </para>
   <para>
    以下示例显示了有两个 Qlogic HBA 连接到 Xiotech Magnitude 3000 SAN 的 64 位 SLES 11 SP2 服务器的 -v3 输出。为了简化示例，省略了一些多重项。
   </para>
<screen><prompt>tux &gt; </prompt>sudo multipath -v3 d
dm-22: device node name blacklisted
&lt; content omitted &gt;
loop7: device node name blacklisted
&lt; content omitted &gt;
md0: device node name blacklisted
&lt; content omitted &gt;
dm-0: device node name blacklisted
sdf: not found in pathvec
sdf: mask = 0x1f
sdf: dev_t = 8:80
sdf: size = 105005056
sdf: subsystem = scsi
sdf: vendor = XIOtech
sdf: product = Magnitude 3D
sdf: rev = 3.00
sdf: h:b:t:l = 1:0:0:2
sdf: tgt_node_name = 0x202100d0b2028da
sdf: serial = 000028DA0014
sdf: getuid= "/lib/udev/scsi_id --whitelisted --device=/dev/%n" (config file default)
sdf: uid = 200d0b2da28001400 (callout)
sdf: prio = const (config file default)
sdf: const prio = 1
[...]
ram15: device node name blacklisted
[...]
===== paths list =====
uuid              hcil    dev dev_t pri dm_st  chk_st  vend/prod/rev
200d0b2da28001400 1:0:0:2 sdf 8:80  1   [undef][undef] XIOtech,Magnitude 3D
200d0b2da28005400 1:0:0:1 sde 8:64  1   [undef][undef] XIOtech,Magnitude 3D
200d0b2da28004d00 1:0:0:0 sdd 8:48  1   [undef][undef] XIOtech,Magnitude 3D
200d0b2da28001400 0:0:0:2 sdc 8:32  1   [undef][undef] XIOtech,Magnitude 3D
200d0b2da28005400 0:0:0:1 sdb 8:16  1   [undef][undef] XIOtech,Magnitude 3D
200d0b2da28004d00 0:0:0:0 sda 8:0   1   [undef][undef] XIOtech,Magnitude 3D
params = 0 0 2 1 round-robin 0 1 1 8:80 1000 round-robin 0 1 1 8:32 1000
status = 2 0 0 0 2 1 A 0 1 0 8:80 A 0 E 0 1 0 8:32 A 0
sdf: mask = 0x4
sdf: path checker = directio (config file default)
directio: starting new request
directio: async io getevents returns 1 (errno=Success)
directio: io finished 4096/0
sdf: state = 2
[...]</screen>
  </sect2>

  <sect2 xml:id="sec.multipath.conf_file.apply">
   <title>应用 /etc/multipath.conf 文件更改以更新多路径映射</title>
   <para>
    对 <filename>/etc/multipath.conf</filename> 文件的更改在 <command>multipathd</command> 运行时不会生效。进行更改后，保存并关闭该文件，然后执行以下操作以应用更改并更新多路径映射：
   </para>
   <procedure>
    <step>
     <para>
      停止 <systemitem class="daemon">multipathd</systemitem> 服务：
     </para>
<screen>sudo systemctl stop multipathd</screen>
    </step>
    <step>
     <para>
      通过输入以下命令，清除旧的多路径绑定
     </para>
<screen>sudo /sbin/multipath -F</screen>
    </step>
    <step>
     <para>
      通过输入以下命令，创建新的多路径绑定
     </para>
<screen>sudo /sbin/multipath -v2 -l</screen>
    </step>
    <step>
     <para>
      重启动 <systemitem class="daemon">multipathd</systemitem> 服务：
     </para>
<screen>sudo systemctl start multipathd</screen>
    </step>
    <step>
     <para>
      在系统中运行 <command>dracut -f</command> 重新创建 <filename>initrd</filename> 映像，然后重引导以使更改生效。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.multipath.conf_file.wwid">
   <title>生成 WWID</title>
   <para>
    为了在不同的路径上识别设备，多路径使用每台设备的全球通用标识 (WWID)。如果两个设备路径的 WWID 相同，则假定它们代表同一台设备。除非有绝对的理由，否则建议不要更改生成 WWID 的方法。有关细节，请参见 <command>man multipath.conf</command>。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.multipath.policies_default">
  <title>配置巡回检测、排队及故障回复的默认策略</title>

  <para>
   多路径 I/O 旨在于储存系统与服务器之间提供连接容错。所需的默认行为取决于服务器是独立服务器还是高可用性群集中的一个节点。
  </para>

  <para>
   在配置独立服务器的多路径 I/O 时，<literal>no_path_retry</literal> 设置会保护服务器操作系统在尽可能长的时间内不会接收 I/O 错误。它会在出现多路径故障转移前将消息排队，并提供正常的连接。
  </para>

  <para>
   在为高可用性群集中的节点配置多路径 I/O 时，您需要让多路径报告 I/O 故障，以触发资源故障转移而不是等待多路径故障转移被解决。在群集环境中，您必须修改 <literal>no_path_retry</literal> 设置，以确保当与储存系统断开连接时，群集节点会收到与群集验证进程相关的 I/O 错误（建议为 Heartbeat 容错的 50%）。此外，您还希望将多路径 I/O 错误回复设为手动，以避免因路径故障而造成资源的乒乓效应。
  </para>

  <para>
   <filename>/etc/multipath.conf</filename> 文件应包含一个 <command>defaults</command> 部分，您可以在此处指定巡回检测、排队以及故障回复的默认行为。如果该字段未另在 <command>device</command> 部分中指定，则为该 SAN 配置应用默认设置。
  </para>

  <para>
   以下各项是已编译的默认设置。除非在创建及配置个性化 <filename>/etc/multipath.conf</filename> 文件时被重写，否则将使用这些值。
  </para>

<screen>defaults {
  verbosity 2
#  udev_dir is deprecated in SLES 11 SP3
#  udev_dir              /dev
  polling_interval      5
#  path_selector default value is service-time in SLES 11 SP3
#  path_selector         "round-robin 0"
  path selector         "service-time 0"
  path_grouping_policy  failover
#  getuid_callout is deprecated in SLES 11 SP3 and replaced with uid_attribute
#  getuid_callout        "/lib/udev/scsi_id --whitelisted --device=/dev/%n"
#  uid_attribute is new in SLES 11 SP3
  uid_attribute         "ID_SERIAL"
  prio                  "const"
  prio_args             ""
  features              "0"
  path_checker          "tur"
  alias_prefix          "mpath"
  rr_min_io_rq          1
  max_fds               "max"
  rr_weight             "uniform"
  queue_without_daemon  "yes"
  flush_on_last_del     "no"
  user_friendly_names   "no"
  fast_io_fail_tmo      5
  bindings_file         "/etc/multipath/bindings"
  wwids_file            "/etc/multipath/wwids"
  log_checker_err       "always"

  retain_attached_hw_handler  "no"
  detect_prio           "no"
  failback              "manual"
  no_path_retry         "fail"
  }</screen>

  <para>
   有关巡回检测、排队和故障回复策略设置的信息，请参见<xref linkend="sec.multipath.policies_failover" xrefstyle="SectTitleOnPage"/>中的以下参数：
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     <xref linkend="polling_interval" xrefstyle="HeadingOnPage"/>
    </para>
   </listitem>
   <listitem>
    <para>
     <xref linkend="no_path_retry" xrefstyle="HeadingOnPage"/>
    </para>
   </listitem>
   <listitem>
    <para>
     <xref linkend="failback" xrefstyle="HeadingOnPage"/>
    </para>
   </listitem>
  </itemizedlist>

  <para>
   修改 <filename>/etc/multipath.conf</filename> 文件后，必须在系统上运行 <command>dracut</command> <option>-f</option> 重新创建 <filename>initrd</filename>，然后重启动服务器，更改才会生效。有关细节，请参见<xref linkend="sec.multipath.conf_file.apply"/>。
  </para>
 </sect1>
 <sect1 xml:id="sec.multipath.blacklist">
  <title>将非多路径设备列入黑名单</title>

  <para>
   <filename>/etc/multipath.conf</filename> 文件可能包含 <command>blacklist</command> 部分，其中会列出所有非多路径设备。您可以通过 WWID（<literal>wwid</literal> 关键词）、设备名称（<literal>devnode</literal> 关键词）或设备类型（<literal>device</literal> 部分）将设备加入黑名单。您还可以使用 <literal>blacklist_exceptions</literal> 部分，对通过 <literal>blacklist</literal> 部分中所用的正规表达式加入黑名单的一些设备启用多路径。
  </para>

  <note>
   <title>
    首选的加入黑名单方法
   </title>
   <para>
    将设备加入黑名单的首选方法是通过 <emphasis>WWID</emphasis> 或通过<emphasis>供应商和产品</emphasis>进行。建议不要通过 <emphasis>devnode</emphasis> 加入黑名单，因为设备节点可能会更改，因此对长久标识设备无帮助。
   </para>
  </note>

  <warning>
   <title>multipath.conf 中的正则表达式</title>
   <para><filename>/etc/multipath.conf</filename> 中的正则表达式一般情况下<emphasis>不</emphasis>起作用。只有与通用字符串匹配时，它们才会起作用。不过，多路径的标准配置已包含许多设备和供应商的正则表达式。将正则表达式与其他正则表达式相匹配不起作用。请确保只与通过 <command>multipath -t</command> 显示的字符串匹配。
   </para>
  </warning>

  <para>
   您通常会忽略非多路径设备，例如 hpsa、fd、hd、md、dm、sr、scd、st、ram、raw 和 loop。例如，本地 SATA 硬盘和闪存盘没有多个路径。如果您希望 <command>multipath</command> 忽略单路径设备，请将它们放在 <command>blacklist</command> 部分。
  </para>

  <note>
   <title>兼容性</title>
   <para>
    关键词 <literal>devnode_blacklist</literal> 已弃用且已替换为 <literal>blacklist</literal>。
   </para>
   <para>
    在 SUSE Linux Enterprise Server 12 中使用 glibc 提供的正规表达式。要与任意字符串匹配，现在必须使用 <literal>".*"</literal> 而不应使用 <literal>"*"</literal>。
   </para>
  </note>

  <para>
   例如，要将本地设备和 <filename>hpsa</filename> 驱动程序中的所有阵列加入黑名单，以免受到多路径的管理，则 <command>blacklist</command> 部分应为：
  </para>

<screen>blacklist {
      wwid "26353900f02796769"
      devnode "^(ram|raw|loop|fd|md|dm-|sr|scd|st)[0-9]*"
      devnode "^sd[a-z][0-9]*"
}</screen>

  <para>
   您可以仅将一个驱动程序中的分区而不是整个阵列加入黑名单。例如，您可以使用以下正规表达式，只将 cciss 驱动程序中的分区而非整个阵列加入黑名单：
  </para>

<screen>blacklist {
      devnode "^cciss!c[0-9]d[0-9]*[p[0-9]*]"
}</screen>

  <para>
   您可以在 blacklist 中添加 <literal>device</literal> 部分，并使用 <literal>vendor</literal> 和 <literal>product</literal> 关键词按特定设备类型加入黑名单。
  </para>

<screen>blacklist {
      device {
           vendor  "DELL"
           product ".*"
       }
}</screen>

  <para>
   您可以使用 <literal>blacklist_exceptions</literal> 部分，对通过 <literal>blacklist</literal> 部分中所用的正规表达式加入黑名单的一些设备启用多路径。您可以通过 WWID（<literal>wwid</literal> 关键词）、设备名称（<literal>devnode</literal> 关键词）或设备类型（<literal>device</literal> 部分）添加例外。您必须以将相应设备加入黑名单的相同方式指定例外。也就是说，<literal>wwid</literal> 例外适用于 <literal>wwid</literal> 黑名单，<literal>devnode</literal> 例外适用于 <literal>devnode</literal> 黑名单，而设备类型例外适用于设备类型黑名单。
  </para>

  <para>
   例如，如果您拥有来自不同供应商的设备类型，可以针对所需的设备类型启用多路径。在 <literal>blacklist</literal> 部分中将所有供应商的设备类型加入黑名单，然后在 <literal>blacklist_exceptions</literal> 部分中添加 <literal>device</literal> 部分，针对所需的设备类型启用多路径。
  </para>

<screen>blacklist {
      devnode "^(ram|raw|loop|fd|md|dm-|sr|scd|st|sda)[0-9]*"
      device {
           vendor  "DELL"
           product ".*"
       }
}

blacklist_exceptions {
      device {
           vendor  "DELL"
           product "MD3220i"
       }
}</screen>

  <para>
   您还可以使用 blacklist_exceptions 仅针对特定设备启用多路径。例如：
  </para>

<screen>blacklist {
      wwid ".*"
}

blacklist_exceptions {
        wwid "3600d0230000000000e13955cc3751234"
        wwid "3600d0230000000000e13955cc3751235"
}</screen>


  <para>
   修改 <filename>/etc/multipath.conf</filename> 文件后，必须在系统上运行 <command>dracut</command> <option>-f</option> 重新创建 <filename>initrd</filename>，然后重启动服务器，更改才会生效。有关细节，请参见<xref linkend="sec.multipath.conf_file.apply"/>。
  </para>

  <para>
   重引导之后，当您发出 <command>multipath -ll</command> 命令时，这些本地设备应不再列于多路径映射中。
  </para>

  <note>
   <title>使用 <literal>find_multipaths</literal> 选项</title>
   <para>
    从 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 12 SP2 开始，多路径工具支持 <filename>/etc/multipath.conf</filename> 的 <literal>defaults</literal> 部分中的 <literal>find_multipaths</literal> 选项。简而言之，此选项会阻止多路径和 <systemitem class="daemon">multipathd</systemitem> 为只有单个路径的设备设置多路径映射（有关细节，请参见 <command>man 5 multipath.conf</command>）。如此，在某些配置中，管理员就无需为本地 SATA 磁盘等创建黑名单项。
   </para>
   <para>
    虽然使用 <literal>find_multipaths</literal> 选项看似很方便，但也有其弊端。它使得系统引导复杂化且速度变慢，因为对于找到的每台设备，引导逻辑都需要等到发现了所有设备之后才能确定设备是否存在第二个路径。此外，当一些路径已关闭或在引导期间不可视时可能会出现问题 — 可能会错误地将设备检测为单路径设备并激活，导致后面添加更多路径的操作失败。
   </para>
   <para>
    <literal>find_multipaths</literal> 会将 <filename>/etc/multipath/wwids</filename> 中所列的具有匹配 WWID 的所有设备视为多路径设备。在第一次激活 <literal>find_multipaths</literal> 时，以下这一点非常重要：除非删除或编辑了 <filename>/etc/multipath/wwids</filename>，否则激活此选项没有任何效果，因为所有先前存在的多路径映射（包括单路径映射）都列于该 wwids 文件中。在具有多路径根文件系统的 SAN-boot 系统中，应确保 <filename>/etc/multipath/wwids</filename> 在初始 RAM 磁盘和文件系统之间保持同步。
   </para>
   <para>
    总而言之，使用 <literal>find_multipaths</literal> 在某些用例中可能很方便，但是 SUSE 仍建议使用正确配置了黑名单和黑名单例外的默认配置。
   </para>
  </note>

 </sect1>
 <sect1 xml:id="sec.multipath.names">
  <title>配置用户用好的名称或别名</title>

  <para>
   多路径设备可以按 WWID、用户友好的名称或您指派的别名进行标识。格式为 <filename>/dev/sdn</filename> 和 <filename>/dev/dm-n</filename> 的设备节点名称在重引导时会发生更改，且每次都可能会被指派给不同的设备。而设备的 WWID、用户友好名称以及别名则在重引导期间始终不变，因此是标识设备的首选方式。
  </para>

  <important>
   <title>建议使用永久的名称</title>
   <para>
    因为格式为 <filename>/dev/sdn</filename> 和 <filename>/dev/dm-n</filename> 的设备节点名称在重引导时会发生更改，所以最好使用其 WWID 来表示多路径设备。为了在重引导时唯一标识设备，您也可以使用与 WWID 映射的用户友好名称或别名。
   </para>
  </important>

  <para>
   下表介绍了 <filename>/etc/multipath.conf</filename> 文件中可用于设备的设备名称类型。有关 <filename>multipath.conf</filename> 设置的示例，请参见 <filename>/usr/share/doc/packages/multipath-tools/multipath.conf.synthetic</filename> 文件。
  </para>

  <table>
   <title>多路径设备名称类型比较</title>
   <tgroup cols="2">
    <colspec colnum="1" colname="1" colwidth="1667*"/>
    <colspec colnum="2" colname="2" colwidth="8334*"/>
    <thead>
     <row>
      <entry>
       <para>
        名称类型
       </para>
      </entry>
      <entry>
       <para>
        描述
       </para>
      </entry>
     </row>
    </thead>
    <tbody>
     <row>
      <entry>
       <para>
        WWID（默认）
       </para>
      </entry>
      <entry>
       <para>
        WWID（全球标识符）序列是保证全球唯一且不会更改的多路径设备标识符。在多路径中使用的默认名称是 <filename>/dev/disk/by-id</filename> 目录中的逻辑单元的 ID。例如，WWID 为 <literal>3600508e0000000009e6baa6f609e7908</literal> 的设备将作为 <filename>/dev/disk/by-id/scsi-3600508e0000000009e6baa6f609e7908</filename> 列出。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        用户友好
       </para>
      </entry>
      <entry>
       <para>
        <filename>/dev/mapper</filename> 目录中的设备映射程序多路径设备名称也参考逻辑单元的 ID。这些多路径设备名称都是用户友好的名称，格式为 <filename>/dev/mapper/mpath&lt;<replaceable>N</replaceable></filename>&gt;，比如 <filename>/dev/mapper/mpath0</filename>。名称是唯一且永久的，因为它们使用 <filename>/var/lib/multipath/bindings</filename> 文件跟踪 UUID 和用户友好的名称之间的关联。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        别名
       </para>
      </entry>
      <entry>
       <para>
        别名是由管理员为多路径设备提供的全局唯一名称。别名会覆盖 WWID 和用户友好的 <filename>/dev/mapper/mpath<replaceable>N</replaceable></filename> 名称。
       </para>
       <para>
        如果您使用的是 user_friendly_names，请不要将别名设为 mpath<replaceable>N</replaceable> 格式。否则可能会与自动指派的用户友好名称产生冲突，导致所提供的设备节点名称不正确。
       </para>
      </entry>
     </row>
    </tbody>
   </tgroup>
  </table>

  <para>
   <filename>/etc/multipath.conf</filename> 文件中的全局多路径 <literal>user_friendly_names</literal> 选项用于对多路径设备启用或禁用用户友好的名称。如果将它设置为 <literal>no</literal>（默认值），多路径会使用 WWID 作为设备的名称。如果将它设置为 <literal>yes</literal>，多路径将使用 <filename>/var/lib/multipath/bindings</filename> 文件，以 <filename>/dev/mapper</filename> 目录中的 <filename>mpath&lt;<replaceable>n</replaceable>&gt;</filename> 格式为设备指派一个永久、唯一的名称。<literal>/etc/multipath.conf</literal> 文件中的 <literal>bindings_file</literal> 选项可用于指定 <filename>bindings</filename> 文件的备用位置。
  </para>

  <para>
   <filename>/etc/multipath.conf</filename> 文件中的全局多路径 <literal>alias</literal> 选项用于明确为设备指派一个名称。如果为多路径设备设置了别名，则使用别名，而不使用 WWID 或用户友好的名称。
  </para>

  <para>
   使用 <literal>user_friendly_names</literal> 选项时，在以下情形中可能会出现问题：
  </para>

  <variablelist>
   <varlistentry>
    <term>根设备使用的是多路径：</term>
    <listitem>
     <para>
      如果系统根设备使用的是多路径，而您使用的是 <literal>user_friendly_names</literal> 选项，则 <filename>initrd</filename> 文件中将会包含 <filename>/var/lib/multipath/bindings</filename> 文件中的用户友好设置。如果稍后更改储存设置，比如添加或删除了设备，则 <filename>initrd</filename> 内的绑定设置和 <filename>/var/lib/multipath/bindings</filename> 中的绑定设置之间会存在不匹配。
     </para>
     <warning>
      <title>绑定不匹配项</title>
      <para>
       <filename>initrd</filename> 和 <filename>/var/lib/multipath/bindings</filename> 之间的绑定不匹配会导致对设备指派错误的安装点，进而导致文件系统损坏和数据丢失。
      </para>
     </warning>
     <para>
      为了避免此问题，建议对系统根设备使用默认 WWID 设置。对于系统根设备不应使用别名。由于设备名称不同，因此使用别名会导致您无法通过内核命令行无缝关闭多路径。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>从另一个分区装入 /var：</term>
    <listitem>
     <para>
      <literal>user_friendly_names</literal> 配置文件的默认位置是 <filename>/var/lib/multipath/bindings</filename>。如果 <filename>/var</filename> 数据不是位于系统根设备上，而是从另一个分区装入，则设置多路径时 <filename>bindings</filename> 文件不可用。
     </para>
     <para>
      请确保 <filename>/var/lib/multipath/bindings</filename> 文件在系统根设备上可用，并且多路径可以找到它。例如，可以按如下操作来确保这一点：
     </para>
     <orderedlist spacing="normal">
      <listitem>
       <para>
        将 <filename>/var/lib/multipath/bindings</filename> 文件移动到 <filename>/etc/multipath/bindings</filename>。
       </para>
      </listitem>
      <listitem>
       <para>
        将 /<filename>etc/multipath.conf</filename> 的 <literal>defaults</literal> 部分的 <literal>bindings_file</literal> 选项设置为此新位置。例如：
       </para>
<screen>
defaults {
               user_friendly_names yes
               bindings_file "/etc/multipath/bindings"
}
</screen>
      </listitem>
     </orderedlist>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term>多路径在 initrd 中：</term>
    <listitem>
     <para>
      即使系统根设备不在多路径上，多路径也可以包含在 <filename>initrd</filename> 中。例如，如果系统根设备位于 LVM 上，就可能会发生这种情况。如果您使用 <literal>user_friendly_names</literal> 选项，且多路径在 <filename>initrd</filename> 中，则应当使用参数 <command>multipath=off</command> 进行引导，以免出现问题。
     </para>
     <para>
      这样在系统引导过程中仅禁用了 <filename>initrd</filename> 中的多路径。系统引导后，<filename>boot.multipath</filename> 和 <filename>multipathd</filename> 引导脚本能够激活多路径。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>HA 群集中的多路径：</term>
    <listitem>
     <para>
      有关详细信息，请参见<xref linkend="sec.multipath.names.ha"/>。
     </para>
    </listitem>
    </varlistentry>
  </variablelist>

  <para>
   启用用户友好名称或指定别名：
  </para>

  <procedure>
   <step>
    <para>
     使用 <systemitem class="username">root</systemitem> 权限在文本编辑器中打开 <filename>/etc/multipath.conf</filename> 文件。
    </para>
   </step>
   <step>
    <para>
     （可选）修改 <filename>/var/lib/multipath/bindings</filename> 文件的位置。
    </para>
    <para>
     备用路径必须在系统根设备上可用，且多路径可以找到它。
    </para>
    <substeps performance="required">
     <step>
      <para>
       将 <filename>/var/lib/multipath/bindings</filename> 文件移动到 <filename>/etc/multipath/bindings</filename>。
      </para>
     </step>
     <step>
      <para>
       将 /<filename>etc/multipath.conf</filename> 的 <literal>defaults</literal> 部分的 <literal>bindings_file</literal> 选项设置为此新位置。例如：
      </para>
<screen>
defaults {
          user_friendly_names yes
          bindings_file "/etc/multipath/bindings"
}
</screen>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     （可选但不建议使用）启用用户友好的名称：
    </para>
    <substeps performance="required">
     <step>
      <para>
       取消注释 <literal>defaults</literal> 部分及其结尾括号。
      </para>
     </step>
     <step>
      <para>
       取消注释 <literal>user_friendly_names</literal> 选项，然后将其值从 No 更改为 Yes。
      </para>
      <para>
       例如：
      </para>
<screen>## Use user-friendly names, instead of using WWIDs as names.
defaults {
  user_friendly_names yes
}</screen>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     （可选）使用 <command>multipath</command> 部分中的 <command>alias</command> 选项为设备指定您自己的名称。
    </para>
    <para>
     例如：
    </para>
<screen>## Use alias names, instead of using WWIDs as names.
multipaths {
       multipath {
               wwid           36006048000028350131253594d303030
               alias             blue1
       }
       multipath {
               wwid           36006048000028350131253594d303041
               alias             blue2
       }
       multipath {
               wwid           36006048000028350131253594d303145
               alias             yellow1
       }
       multipath {
               wwid           36006048000028350131253594d303334
               alias             yellow2
       }
}
</screen>
    <important>
     <title>WWWID 与 WWN 的比较</title>
     <para>
      在 <filename>/etc/multipath.conf</filename> 文件中定义设备别名时，请确保使用每个设备的 WWID（如 <filename>3600508e0000000009e6baa6f609e7908</filename>）而不是它的 WWN（以 <filename>0x</filename> 替换设备 ID 的第一个字符，如 <filename>0x600508e0000000009e6baa6f609e7908</filename>）。
     </para>
    </important>
   </step>
   <step>
    <para>
     保存更改，然后关闭该文件。
    </para>
   </step>
   <step>
    <para>
     修改 <filename>/etc/multipath.conf</filename> 文件后，必须在系统上运行 <command>dracut</command> <option>-f</option> 重新创建 <filename>initrd</filename>，然后重启动服务器，更改才会生效。有关细节，请参见<xref linkend="sec.multipath.conf_file.apply"/>。
    </para>
   </step>
  </procedure>

  <para>
   如果要直接使用整个 LUN（例如，如果正在使用 SAN 功能对储存区分区），只要将名称 <filename>/dev/disk/by-id/xxx</filename> 用于 <command>mkfs</command>、<command>fstab</command>、应用程序等即可。已分区设备的设备名称后将追加 <filename>_part&lt;n&gt;</filename>，例如 <filename>/dev/disk/by-id/xxx_part1</filename>。
  </para>

  <para>
   在 <filename>/dev/disk/by-id</filename> 目录中，通过设备名 <filename>dm-uuid*</filename> 或别名（如果在 <filename>/etc/multipath.conf</filename> 文件中为其指派了别名）表示多路径映射设备。设备名 <filename>scsi-</filename> 和 <filename>wwn-</filename> 表示设备的物理路径。
  </para>

  <sect2 xml:id="sec.multipath.names.ha">
   <title>HA 群集中的多路径设备名称</title>
   <para>
    请执行下列操作确保多路径设备名称在所有设备中都相同：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      使用 UUID 和别名确保多路径设备名称在集群中的所有节点上保持一致。别名在所有节点上必须唯一。将 <filename>/etc/multipath.conf</filename> 文件从该节点复制到群集中所有其他节点的 <filename>/etc/</filename> 目录下。
     </para>
    </listitem>
    <listitem>
     <para>
      当使用多路径映射设备的链接时，请确保在 <filename>/dev/disk/by-id</filename> 目录中指定 <filename>dm-uuid*</filename> 名称或别名，而不是设备的固定路径实例。有关信息，请参阅<xref linkend="sec.multipath.names" xrefstyle="SectTitleOnPage"/>。
     </para>
    </listitem>
    <listitem>
     <para>
      将 <literal>user_friendly_names</literal> 配置选项设置为“no”以禁用它。<literal/>用户友好名称对某个节点是唯一的，但集群中各个节点上的设备不得指派相同的用户友好名称。
     </para>
    </listitem>
   </itemizedlist>
   <note>
    <title>用户友好名称</title>
    <para>
     如果您确实需要使用用户友好名称，则可以执行下列操作，强制系统定义的用户友好名称在群集的所有节点中保持一致：
    </para>
    <procedure>
     <step>
      <para>
       在一个节点上的 <filename>/etc/multipath.conf</filename> 文件中：
      </para>
      <orderedlist>
       <listitem>
        <para>
         将 <literal>user_friendly_names</literal> 配置选项设置为“yes”以启用它。<literal/>
        </para>
        <para>
         多路径使用 <filename>/var/lib/multipath/bindings</filename> 文件以 <filename>/dev/mapper </filename>目录中的 <filename>mpath&lt;<replaceable>n</replaceable>&gt;</filename> 格式为设备指派一个永久唯一的名称。
        </para>
       </listitem>
       <listitem>
        <para>
         （可选）设置 <literal>/etc/multipath.conf</literal> 文件的 <literal>defaults</literal> 部分中的 <literal>bindings_file</literal> 选项，以指定 <filename>bindings</filename> 文件的备用位置。
        </para>
        <para>
         默认位置为 <filename>/var/lib/multipath/bindings</filename>。
        </para>
       </listitem>
      </orderedlist>
     </step>
     <step>
      <para>
       设置该节点上的所有多路径设备。
      </para>
     </step>
     <step>
      <para>
       将 <filename>/etc/multipath.conf</filename> 文件从该节点复制到群集中所有其他节点的 <filename>/etc/</filename> 目录下。
      </para>
     </step>
     <step>
      <para>
       从该节点将 <filename>bindings</filename> 文件复制到集群中所有其他节点的 <filename>bindings_file</filename> 路径。
      </para>
     </step>
     <step>
      <para>
       修改 <filename>/etc/multipath.conf</filename> 文件后，必须在系统上运行 <command>dracut</command> <option>-f</option> 重新创建 <filename>initrd</filename>，然后重启动节点，更改才会生效。有关细节，请参见<xref linkend="sec.multipath.conf_file.apply"/>。这适用于所有受影响的节点。
      </para>
     </step>
    </procedure>
   </note>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.multipath.policies_failover">
  <title>配置路径故障转移策略和优先级</title>

  <para>
   在 Linux 主机中，当存在多个路径到某储存控制器时，每个路径都显示为独立的块设备，导致单个 LUN 有多个块设备。设备映射程序多路径服务检测到具有同一 LUN ID 的多个路径，并使用该 ID 创建了一个新的多路径设备。例如，如果具有两个 HBA 的主机通过单个未确定区域的光纤通道交换机挂接到一个带两个端口的储存控器，则会看到四个块设备：<filename>/dev/sda</filename>、<filename>/dev/sdb</filename>、<filename>/dev/sdc</filename> 和 <filename>/dev/sdd</filename>。设备映射程序多路径服务会创建单个块设备 <filename>/dev/mpath/mpath1</filename>，由它来通过以上四个底层块设备重新路由 I/O。
  </para>

  <para>
   本节描述如何指定故障转移策略和配置路径的优先级。请注意，修改 <filename>/etc/multipath.conf</filename> 文件后，必须在系统上运行 <command>dracut</command> <option>-f</option> 重新创建 <filename>initrd</filename>，然后重启动服务器，更改才会生效。有关详细信息，请参见<xref linkend="sec.multipath.conf_file.apply"/>。
  </para>

  <sect2 xml:id="sec.multipath.policies_failover.path">
   <title>配置路径故障转移策略</title>
   <para>
    使用带 <option>-p</option> 选项的 <command>multipath</command> 命令来设置路径故障转移策略：
   </para>
<screen>sudo multipath <replaceable>devicename</replaceable> -p <replaceable>policy</replaceable></screen>
   <para>
    将 <replaceable>policy</replaceable> 替换为以下策略选项之一：
   </para>
   <table>
    <title>multipath -p 命令的组策略选项</title>
    <tgroup cols="2">
     <colspec colnum="1" colname="1" colwidth="2381*"/>
     <colspec colnum="2" colname="2" colwidth="7620*"/>
     <thead>
      <row>
       <entry>
        <para>
         策略选项
        </para>
       </entry>
       <entry>
        <para>
         描述
        </para>
       </entry>
      </row>
     </thead>
     <tbody>
      <row>
       <entry>
        <para>
         failover
        </para>
       </entry>
       <entry>
        <para>
         （默认）每个优先级组对应一个路径。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         multibus
        </para>
       </entry>
       <entry>
        <para>
         一个优先级组中的所有路径。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         group_by_serial
        </para>
       </entry>
       <entry>
        <para>
         每个检测到的序列号一个优先级组。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         group_by_prio
        </para>
       </entry>
       <entry>
        <para>
         每个路径优先级值一个优先级组。优先级由调出程序在 <filename>/etc/multipath.conf</filename> 配置文件中指定为 global、per-controller 或 per-multipath 选项来确定。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         group_by_node_name
        </para>
       </entry>
       <entry>
        <para>
         每个目标节点名一个优先级组。目标节点名是在 <filename>/sys/class/fc_transport/target*/node_name</filename> 位置获取的。
        </para>
       </entry>
      </row>
     </tbody>
    </tgroup>
   </table>
  </sect2>

  <sect2 xml:id="sec.multipath.policies_failover.prio">
   <title>配置故障转移优先级</title>
   <para>
    必须在 <filename>/etc/multipath.conf</filename> 文件中手动输入设备的故障转移优先级。<filename>/usr/share/doc/packages/multipath-tools/multipath.conf.annotated</filename> 文件中有所有设置和选项的示例。
   </para>
   <sect3 xml:id="sec.multipath.policies_failover.prio.info">
    <title>了解优先级组和属性</title>
    <para>
     <emphasis>优先级组</emphasis>是通向同一物理 LUN 的路径的集合。默认情况下，I/O 在组中的所有路径中以循环方式分布。<command>multipath</command> 命令会基于 SAN 的 path_grouping_policy 设置为该 SAN 中的每个 LUN 自动创建优先级组。<literal/><command>multipath</command> 命令将一个组中的路径数乘以该组的优先级以确定哪个组是主组。计算出的值最高的组即是主组。当主组中的所有路径失败时，具有下一个最高值的优先级组即变为活动的组。
    </para>
    <para>
     <emphasis>路径优先级</emphasis>是指派给一个路径的整数值。值越高，优先级越高。将使用一个外部程序来指派每个路径的优先级。对于给定的设备，具有相同优先级的路径属于同一优先级组。
    </para>
    <para>
     <literal>prio</literal> 设置在 <filename>/etc/multipath.conf</filename> 文件的 <literal>defaults{}</literal> 或 <literal>devices{}</literal> 部分中使用。当为 <literal>multipaths</literal> 部分的单个 <literal>multipath</literal> 定义指定该设置时，系统会无提示地将它忽略。<literal>prio</literal> 行用于指定优先级排序程序。如果优先级排序程序需要自变量，您要在第二行上使用 <literal>prio_args</literal> 关键字指定自变量。
    </para>
    <bridgehead>Defaults 或 Devices 部分的 PRIO 设置</bridgehead>
    <variablelist>
     <varlistentry>
      <term>prio</term>
      <listitem>
       <para>
        指定要调用的优先级排序程序，以获取路径优先级的值。将加总每个路径组的权重以确定发生故障时要使用的下一个路径组。
       </para>
       <para>
        如果指定的优先级排序程序需要自变量，则使用关键字 <literal>prio_args</literal> 指定自变量。
       </para>
       <para>
        如果未指定关键字 <literal>prio</literal>，则所有路径具有相同优先级。默认设置为 <literal>const</literal>，且 <literal>prio_args</literal> 设置为空。
       </para>
<screen>prio "const"
prio_args ""</screen>
       <para>
        优先级排序程序示例如下：
       </para>
       <informaltable>
        <tgroup cols="2">
         <colspec colnum="1" colname="1" colwidth="2907*"/>
         <colspec colnum="2" colname="2" colwidth="7096*"/>
         <thead>
          <row>
           <entry>
            <para>
             优先级排序程序
            </para>
           </entry>
           <entry>
            <para>
             描述
            </para>
           </entry>
          </row>
         </thead>
         <tbody>
          <row>
           <entry>
            <para>
             <literal>alua</literal>
            </para>
           </entry>
           <entry>
            <para>
             基于 SCSI-3 ALUA 设置生成路径优先级。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>const</literal>
            </para>
           </entry>
           <entry>
            <para>
             为所有路径生成同一优先级。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>emc</literal>
            </para>
           </entry>
           <entry>
            <para>
             为 EMC 阵列生成路径优先级。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>hdc</literal>
            </para>
           </entry>
           <entry>
            <para>
             为 Hitachi HDS Modular 储存阵列生成路径优先级。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>hp_sw</literal>
            </para>
           </entry>
           <entry>
            <para>
             为活动/备用模式的 Compaq/HP 控制器生成路径优先级。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>ontap</literal>
            </para>
           </entry>
           <entry>
            <para>
             为 NetApp 阵列生成路径优先级。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>random</literal>
            </para>
           </entry>
           <entry>
            <para>
             为每个路径生成随机优先级。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>rdac</literal>
            </para>
           </entry>
           <entry>
            <para>
             为 LSI/Engenio RDAC 控制器生成路径优先级。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>weightedpath</literal>
            </para>
           </entry>
           <entry>
            <para>
             根据您在 <literal>prio_args</literal> 自变量中指定的加权值生成路径优先级，例如：
            </para>
<screen>[hbtl|devname] <replaceable>regex1</replaceable> <replaceable>prio1</replaceable> <replaceable>regex2</replaceable> <replaceable>prio2</replaceable>...</screen>
            <para>
             <literal>hbtl regex</literal> 自变量格式采用 SCSI <literal>H:B:T:L</literal> 表示法（例如 <literal>1:0:.:.</literal> 和 <literal>*:0:0:.</literal>）并带有加权值，其中 H、B、T 和 L 分别代表设备的主机、总线、目标以及 LUN ID。例如：
            </para>
<screen>prio "weightedpath"
prio_args "hbtl 1:.:.:. 2 4:.:.:. 4"</screen>
            <para>
             <literal>devname</literal> 正则表达式自变量格式使用设备节点名称以及每个设备的加权值。例如：
            </para>
<screen>prio "weightedpath"
prio_args "devname sda 50 sde 10 sdc 50 sdf 10"</screen>
           </entry>
          </row>
         </tbody>
        </tgroup>
       </informaltable>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>prio_args</literal>
      </term>
      <listitem>
       <para>
        为需要自变量的指定优先级排序程序指定自变量。大多数 <literal>prio</literal> 程序并不需要自变量。
       </para>
       <para>
        无默认值。该值取决于 <literal>prio</literal> 设置以及优先级排序程序是否需要自变量。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <bridgehead>多路径属性</bridgehead>
    <para>
     多路径属性用于控制设备的多路径 I/O 行为。您可以按默认方式为所有多路径设备指定属性。也可以通过在多路径配置文件的 <literal>multipaths</literal> 部分中创建设备项的方式，指定仅对指定多路径设备应用的属性。
    </para>
    <variablelist>
     <varlistentry>
      <term><literal>user_friendly_names</literal>
      </term>
      <listitem>
       <para>
        指定是使用全球 ID (WWID) 还是使用 <filename>/var/lib/multipath/bindings</filename> 文件以 <filename>/dev/mapper/mpathN</filename> 的格式为多路径设备指派一个永久唯一的别名。
       </para>
       <para>
        此选项可以在 <literal>devices</literal> 部分和 <literal>multipaths</literal> 部分使用。
       </para>
       <informaltable>
        <tgroup cols="2">
         <colspec colnum="1" colname="1" colwidth="2642*"/>
         <colspec colnum="2" colname="2" colwidth="7360*"/>
         <thead>
          <row>
           <entry>
            <para>
             值
            </para>
           </entry>
           <entry>
            <para>
             描述
            </para>
           </entry>
          </row>
         </thead>
         <tbody>
          <row>
           <entry>
            <para>
             <literal>no</literal>
            </para>
           </entry>
           <entry>
            <para>
             （默认）使用 <filename>/dev/disk/by-id/</filename> 位置中显示的 WWID。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>yes</literal>
            </para>
           </entry>
           <entry>
            <para>
             自动生成用户友好的名称作为多路径设备的别名而不是实际 ID。
            </para>
           </entry>
          </row>
         </tbody>
        </tgroup>
       </informaltable>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="failback">
      <term><literal>failback</literal>
      </term>
      <listitem>
       <para>
        指定是否监视失败路径恢复，并指明失败路径重新使用之后组故障回复的时间。
       </para>
       <para>
        当失败的路径恢复后，系统会根据此设置将该路径重新添加到支持多路径的路径列表中。多路径计算优先级组，并在主路径的优先级超出备用组时更改活动优先级组。
       </para>
       <informaltable>
        <tgroup cols="2">
         <colspec colnum="1" colname="1" colwidth="2642*"/>
         <colspec colnum="2" colname="2" colwidth="7360*"/>
         <thead>
          <row>
           <entry>
            <para>
             值
            </para>
           </entry>
           <entry>
            <para>
             描述
            </para>
           </entry>
          </row>
         </thead>
         <tbody>
          <row>
           <entry>
            <para>
             <literal>manual</literal>
            </para>
           </entry>
           <entry>
            <para>
             （默认）不监视失败的路径是否恢复。管理员运行 <command>multipath</command> 命令以更新启用的路径和优先级组。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>immediate</literal>
            </para>
           </entry>
           <entry>
            <para>
             当一个路径恢复时，立即启用该路径。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal><replaceable>N</replaceable></literal>
            </para>
           </entry>
           <entry>
            <para>
             当路径恢复时，等待 <replaceable>N</replaceable> 秒再启用该路径。指定大于 0 的整数值。
            </para>
           </entry>
          </row>
         </tbody>
        </tgroup>
       </informaltable>
       <para>
        为了防止多路径故障转移出现乒乓效应，建议将群集环境下的多路径故障回复设置为 <literal>manual</literal>。
       </para>
<screen>failback "manual"</screen>
       <important>
        <title>校验</title>
        <para>
         请确保与您的储存系统供应商确认故障回复设置。不同的储存系统可能会有不同的设置要求。
        </para>
       </important>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="no_path_retry">
      <term><literal>no_path_retry</literal>
      </term>
      <listitem>
       <para>
        指定在路径失败时使用的行为。
       </para>
       <informaltable>
        <tgroup cols="2">
         <colspec colnum="1" colname="1" colwidth="2642*"/>
         <colspec colnum="2" colname="2" colwidth="7360*"/>
         <thead>
          <row>
           <entry>
            <para>
             值
            </para>
           </entry>
           <entry>
            <para>
             描述
            </para>
           </entry>
          </row>
         </thead>
         <tbody>
          <row>
           <entry>
            <para>
             <literal><replaceable>N</replaceable></literal>
            </para>
           </entry>
           <entry>
            <para>
             指定 <command>multipath</command> 停止排队和路径失败之前的重试次数。指定大于 0 的整数值。
            </para>
            <para>
             在群集中，您可以将值指定为 0 以避免发生排队现象，并允许资源进行故障转移。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>fail</literal>
            </para>
           </entry>
           <entry>
            <para>
             指定立即失败（不排队）。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>queue</literal>
            </para>
           </entry>
           <entry>
            <para>
             永不停止排队（一直排队，直到该路径成为活动路径）。
            </para>
           </entry>
          </row>
         </tbody>
        </tgroup>
       </informaltable>
       <para>
        在群集中工作时，建议在 <filename>/etc/multipath.conf</filename> 文件中将重试设置设为 <literal>fail</literal> 或 <literal>0</literal>。如此一来，当与储存的连接中断时便可让资源进行故障转移。否则会将消息排队而不会发生资源故障转移。
       </para>
<screen>no_path_retry "fail"
no_path_retry "0"</screen>
       <important>
        <title>校验</title>
        <para>
         请确保与您的储存系统供应商确认重试设置。不同的储存系统可能会有不同的设置要求。
        </para>
       </important>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>path_checker</literal>
      </term>
      <listitem>
       <para>
        确定路径的状态。
       </para>
       <informaltable>
        <tgroup cols="2">
         <colspec colnum="1" colname="1" colwidth="30%"/>
         <colspec colnum="2" colname="2" colwidth="70%"/>
         <thead>
          <row>
           <entry>
            <para>
             值
            </para>
           </entry>
           <entry>
            <para>
             描述
            </para>
           </entry>
          </row>
         </thead>
         <tbody>
          <row>
           <entry>
            <para>
             <literal>directio</literal>
            </para>
           </entry>
           <entry>
            <para>
             读取具有直接 I/O 的第一个扇区，这对于 DASD 设备非常有用。在 <systemitem class="daemon">systemd</systemitem> 日记中记录失败讯息（请参见<xref linkend="cha.journalctl"/>）。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>tur</literal>
            </para>
           </entry>
           <entry>
            <para>
             向设备发出 SCSI 测试单元就绪命令。如果 LUN 支持，则这是首选设置。如果命令失败，它不会在 <systemitem class="daemon">systemd</systemitem> 日志中填入讯息。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <replaceable>自定义供应商值</replaceable>
            </para>
           </entry>
           <entry>
            <para>
             一些 SAN 供应商提供了自定义的 path_checker 选项：
            </para>
            <itemizedlist mark="bullet" spacing="normal">
             <listitem>
              <formalpara>
               <title><literal>cciss_tur</literal>：</title>
               <para>
                检查 HP 智能储存阵列的路径状态。
               </para>
              </formalpara>
             </listitem>
             <listitem>
              <formalpara>
               <title><literal>emc_clariion</literal>：</title>
               <para>
                查询 EMC Clariion EVPD 页 0xC0 以确定路径状态。
               </para>
              </formalpara>
             </listitem>
             <listitem>
              <formalpara>
               <title><literal>hp_sw</literal>:</title>
               <para>
                使用活动/备用固件检查 HP 储存阵列的路径状态（Up、Down 还是 Ghost）。
               </para>
              </formalpara>
             </listitem>
             <listitem>
              <formalpara>
               <title><literal>rdac</literal>:</title>
               <para>
                检查 LSI/Engenio RDAC 储存控制器的路径状态。
               </para>
              </formalpara>
             </listitem>
            </itemizedlist>
           </entry>
          </row>
         </tbody>
        </tgroup>
       </informaltable>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>path_grouping_policy</literal>
      </term>
      <listitem>
       <para>
        指定由给定控制器托管的多路径设备的路径分组策略。
       </para>
       <informaltable>
        <tgroup cols="2">
         <colspec colnum="1" colname="1" colwidth="2642*"/>
         <colspec colnum="2" colname="2" colwidth="7360*"/>
         <thead>
          <row>
           <entry>
            <para>
             值
            </para>
           </entry>
           <entry>
            <para>
             描述
            </para>
           </entry>
          </row>
         </thead>
         <tbody>
          <row>
           <entry>
            <para>
             <literal>failover</literal>
            </para>
           </entry>
           <entry>
            <para>
             （默认）为每个优先级组指派一个路径，以便每次只使用一个路径。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>multibus</literal>
            </para>
           </entry>
           <entry>
            <para>
             所有有效路径在一个优先级组中。通讯在该组所有活动路径之间平衡负载。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>group_by_prio</literal>
            </para>
           </entry>
           <entry>
            <para>
             对于每个路径优先级值，都存在一个优先级组。具有相同优先级的路径在同一优先级组中。优先级由外部程序指派。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>group_by_serial</literal>
            </para>
           </entry>
           <entry>
            <para>
             路径按 SCSI 目标序列号（控制器节点 WWN）分组。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>group_by_node_name</literal>
            </para>
           </entry>
           <entry>
            <para>
             每个目标节点名指派一个优先级组。目标节点名是在 <filename>/sys/class/fc_transport/target*/node_name</filename> 中获取的。
            </para>
           </entry>
          </row>
         </tbody>
        </tgroup>
       </informaltable>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>path_selector</literal>
      </term>
      <listitem>
       <para>
        指定用于负载平衡的 path-selector 算法。
       </para>
       <informaltable>
        <tgroup cols="2">
         <colspec colnum="1" colname="1" colwidth="2642*"/>
         <colspec colnum="2" colname="2" colwidth="7360*"/>
         <thead>
          <row>
           <entry>
            <para>
             值
            </para>
           </entry>
           <entry>
            <para>
             描述
            </para>
           </entry>
          </row>
         </thead>
         <tbody>
          <row>
           <entry>
            <para>
             <literal>round-robin 0</literal>
            </para>
           </entry>
           <entry>
            <para>
             用于平衡优先级组中所有活动路径之间的通讯的负载平衡算法。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>queue-length 0</literal>
            </para>
           </entry>
           <entry>
            <para>
             用于平衡路径上运行中 I/O 数的动态负载平衡器，类似于 least-pending 选项。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>service-time 0</literal>
            </para>
           </entry>
           <entry>
            <para>
             （默认值）面向服务时间的、用于根据延迟情况来平衡多个路径上的 I/O 的负载平衡器。
            </para>
           </entry>
          </row>
         </tbody>
        </tgroup>
       </informaltable>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>pg_timeout</term>
      <listitem>
       <para>
        指定路径组超时处理。不能指定任何值，已设置了内部默认值。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="polling_interval">
      <term><literal>polling_interval</literal>
      </term>
      <listitem>
       <para>
        指定某个路径检查周期结束到下一个路径检查周期开始之间的时间（以秒为单位）。
       </para>
       <para>
        指定大于 0 的整数值。默认值为 5。请确保与您的储存系统供应商确认 polling_interval 设置。不同的储存系统可能会有不同的设置要求。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>rr_min_io_rq</literal>
      </term>
      <listitem>
       <para>
        指定在使用基于请求的 device-mapper-multipath 切换到当前路径组中的下一个路径前，路由至某个路径的 I/O 请求的数量。
       </para>
       <para>
        指定大于 0 的整数值。默认值是 1。
       </para>
<screen>rr_min_io_rq "1"</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>rr_weight</literal>
      </term>
      <listitem>
       <para>
        指定用于路径的加权方法。
       </para>
       <informaltable>
        <tgroup cols="2">
         <colspec colnum="1" colname="1" colwidth="2642*"/>
         <colspec colnum="2" colname="2" colwidth="7360*"/>
         <thead>
          <row>
           <entry>
            <para>
             值
            </para>
           </entry>
           <entry>
            <para>
             描述
            </para>
           </entry>
          </row>
         </thead>
         <tbody>
          <row>
           <entry>
            <para>
             <literal>uniform</literal>
            </para>
           </entry>
           <entry>
            <para>
             （默认）所有路径具有相同的循环复用权重。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>priorities</literal>
            </para>
           </entry>
           <entry>
            <para>
             每个路径的权重通过路径的优先级乘以 rr_min_io_rq 设置来确定。
            </para>
           </entry>
          </row>
         </tbody>
        </tgroup>
       </informaltable>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>uid_attribute</literal>
      </term>
      <listitem>
       <para>
        提供唯一路径标识符的 udev 属性。默认值为 <literal>ID_SERIAL</literal>。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="sec.multipath.policies_failover.rr">
    <title>配置循环负载平衡</title>
    <para>
     所有路径都是活动的。I/O 被配置为等候数秒或一定的 I/O 事务数，再移到序列中下一个打开的路径。
    </para>
   </sect3>
   <sect3 xml:id="sec.multipath.policies_failover.prio.single">
    <title>配置单路径故障转移</title>
    <para>
     具有最高优先级（设置值为最低）的一个路径是活动的，可以进行通讯。其他路径可用于故障转移，但在发生故障转移前不会使用。
    </para>
   </sect3>
   <sect3 xml:id="sec.multipath.policies_failover.prio.rr_grouping">
    <title>为循环负载平衡将 I/O 路径分组</title>
    <para>
     具有相同优先级的多个路径分在活动的组中。当该组中的所有路径失败时，设备会故障转移到下一个最高优先级的组。该组中的所有路径以循环负载平衡的方式共享通讯负载。
    </para>
   </sect3>
  </sect2>

  <sect2 xml:id="sec.multipath.policies_failover.rtpg">
   <title>报告目标路径组</title>
   <para>
    使用 SCSI 报告目标端口组 (<command>sg_rtpg(8)</command>) 命令。有关信息，请参见 <command>sg_rtpg(8)</command> 的手册页。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.multipath.root">
  <title>为根设备配置多路径 I/O</title>

  <para>
   <filename>SUSE Linux Enterprise Server</filename> 中的 <filename>/boot</filename> 和 <phrase role="productname"><phrase os="sles">/root</phrase></phrase> 可以使用并支持设备映射程序多路径 I/O (DM-MPIO)。此外，YaST 安装程序中的 YaST 分区程序支持在安装时启用多路径。
  </para>

  <sect2 xml:id="sec.multipath.root.install">
   <title>安装时启用多路径 I/O</title>
   <para>
    如果要在多路径设备上安装操作系统，则安装时必须运行多路径软件。<systemitem class="daemon">multipathd</systemitem> 守护程序在系统安装过程中不会自动激活。您可以使用 YaST 分区程序中的<guimenu>配置多路径</guimenu>选项来启动它。
   </para>
   <sect3 xml:id="sec.multipath.root.install.aa_lun">
    <title>安装时在主动/主动多路径储存 LUN 上启用多路径 I/O</title>
    <procedure>
     <step>
      <para>
       安装期间，在<guimenu>建议的分区</guimenu>屏幕上选择<guimenu>专家分区程序</guimenu>。
      </para>
     </step>
     <step>
      <para>
       选择<guimenu>硬盘</guimenu>主图标，单击<guimenu>配置</guimenu>按钮，然后选择<guimenu>配置多路径</guimenu>。
      </para>
     </step>
     <step>
      <para>
       启动多路径。
      </para>
      <para>
       YaST 会开始重扫描磁盘，并显示可用的多路径设备（如 <filename>/dev/disk/by-id/dm-uuid-mpath-3600a0b80000f4593000012ae4ab0ae65</filename>）。它是应做所有进一步处理的设备。
      </para>
     </step>
     <step>
      <para>
       单击<guimenu>下一步</guimenu>继续安装。
      </para>
     </step>
    </procedure>
   </sect3>
   <sect3 xml:id="sec.multipath.root.install.ap_lun">
    <title>安装时在主动/被动多路径储存 LUN 上启用多路径 I/O</title>
    <para>
     <systemitem class="daemon">multipathd</systemitem> 守护程序在系统安装过程中不会自动激活。您可以使用 YaST 分区程序中的<guimenu>配置多路径</guimenu>选项来启动它。
    </para>
    <para>
     在安装时为主动/被动多路径储存 LUN 启用多路径 I/O：
    </para>
    <procedure>
     <step>
      <para>
       安装期间，在<guimenu>建议的分区</guimenu>屏幕上选择<guimenu>专家分区程序</guimenu>。
      </para>
     </step>
     <step>
      <para>
       选择<guimenu>硬盘</guimenu>主图标，单击<guimenu>配置</guimenu>按钮，然后选择<guimenu>配置多路径</guimenu>。
      </para>
     </step>
     <step>
      <para>
       启动多路径。
      </para>
      <para>
       YaST 会开始重扫描磁盘，并显示可用的多路径设备（如 <filename>/dev/disk/by-id/dm-uuid-mpath-3600a0b80000f4593000012ae4ab0ae65</filename>）。它是应做所有进一步处理的设备。记下设备路径和 UUID，您以后会需要这些信息。
      </para>
     </step>
     <step>
      <para>
       单击<guimenu>下一步</guimenu>继续安装。
      </para>
     </step>
     <step>
      <para>
       所有设置都设好且安装完成后，YaST 即会开始写入引导加载程序信息，并显示重启动系统的倒计时。单击<guimenu>停止</guimenu>按钮停止倒计时，然后按 <keycombo><keycap function="control"/><keycap function="alt"/><keycap>F5</keycap></keycombo> 访问控制台。
      </para>
     </step>
     <step>
      <para>
       通过控制台确定是否在 <filename>/boot/grub/device.map</filename> 文件中为 <filename>hd0</filename> 条目输入了不活动路径。
      </para>
      <para>
       这一点是必需的，因为安装时不会区分活动和不活动路径。
      </para>
      <substeps performance="required">
       <step>
        <para role="intro">
         输入以下命令将根设备装入 <filename>/mnt</filename>
        </para>
<screen>mount /dev/disk/by-id/<replaceable>UUID</replaceable>;_part2 /mnt</screen>
        <para>
         例如，输入
        </para>
<screen>mount /dev/disk/by-id/dm-uuid-mpath-3600a0b80000f4593000012ae4ab0ae65_part2 /mnt</screen>
       </step>
       <step>
        <para>
         输入以下命令将引导设备装入 <filename>/mnt/boot</filename>
        </para>
<screen>mount /dev/disk/by-id/<replaceable>UUID</replaceable>_part1 /mnt/boot</screen>
        <para>
         例如，输入
        </para>
<screen>mount /dev/disk/by-id/dm-uuid-mpath-3600a0b80000f4593000012ae4ab0ae65_part2 /mnt/boot</screen>
       </step>
       <step>
        <para>
         在 <filename>/mnt/boot/grub/device.map</filename> 文件中，确定 <filename>hd0</filename> 条目是否指向不活动路径，然后执行下列其中一项操作：
        </para>
        <itemizedlist mark="bullet" spacing="normal">
         <listitem>
          <formalpara>
           <title>活动路径：</title>
           <para>
            不需要执行任何操作。跳过所有剩余的步骤，按 <keycombo><keycap function="control"/><keycap function="alt"/><keycap>F7</keycap></keycombo> 返回 YaST 图形环境，然后继续安装。
           </para>
          </formalpara>
         </listitem>
         <listitem>
          <formalpara>
           <title>不活动路径：</title>
           <para>
            必须更改配置并重新安装引导加载程序。
           </para>
          </formalpara>
         </listitem>
        </itemizedlist>
       </step>
      </substeps>
     </step>
     <step>
      <para role="intro">
       如果 <filename>hd0</filename> 条目指向不活动路径，请更改配置并重新安装引导加载程序：
      </para>
      <substeps performance="required">
       <step>
        <para role="intro">
         在控制台提示符处输入以下命令：
        </para>
<screen>
          mount -o bind /dev /mnt/dev
          mount -o bind /sys /mnt/sys
          mount -o bind /proc /mnt/proc
          chroot /mnt</screen>
       </step>
       <step>
        <para role="intro">
         在控制台中，运行 <command>multipath -ll</command>，然后检查输出以找到活动路径。
        </para>
        <para>
         不活动路径标有 <literal>ghost</literal> 字样。
        </para>
       </step>
       <step>
        <para>
         在 <filename>/boot/grub/device.map</filename> 文件中，将 <literal>hd0</literal> 条目更改为活动路径，保存更改并关闭文件。
        </para>
       </step>
       <step>
        <para>
         输入以下命令重新安装引导加载程序
        </para>
<screen>
          grub-install /dev/disk/by-id/<replaceable>UUID</replaceable>_part1 /mnt/boot</screen>
        <para>
         例如，输入
        </para>
<screen>grub-install /dev/disk/by-id/dm-uuid-mpath-3600a0b80000f4593000012ae4ab0ae65_part2 /mnt/boot</screen>
       </step>
       <step>
        <para>
         输入以下命令：
        </para>
<screen>exit
umount /mnt/*
umount /mnt</screen>
       </step>
      </substeps>
     </step>
     <step>
      <para>
       按 <keycombo><keycap function="control"/><keycap function="alt"/><keycap>F7</keycap></keycombo> 返回 YaST 图形环境。
      </para>
     </step>
     <step>
      <para>
       单击<guimenu>确定</guimenu>继续安装重引导。
      </para>
     </step>
    </procedure>
   </sect3>
  </sect2>

  <sect2 xml:id="sec.multipath.root.enable_existing">
   <title>为现有根设备启用多路径 I/O</title>
   <procedure>
    <step>
     <para>
      将 Linux 安装为仅有一个路径活动，最好是分区程序中列出 <filename>by-id</filename> 符号链接的路径。
     </para>
    </step>
    <step>
     <para>
      使用安装期间使用的 <filename>/dev/disk/by-id</filename> 路径装入设备。
     </para>
    </step>
    <step>
     <para>
      添加下面一行，将 dm-multipath 添加到 <filename>/etc/dracut.conf.d/01-dist.conf</filename> 中：
     </para>
<screen>force_drivers+="dm-multipath"</screen>
    </step>
    <step>
     <para>
      <remark condition="clarity">
       2014-09-05 - fs: Check if the following is still true
      </remark>对于 IBM z Systems，请在运行 <command>dracut</command> 之前先编辑 <filename>/etc/zipl.conf</filename> 文件，以 <filename>/etc/fstab</filename> 中使用的相同 by-id 信息更改 <filename>zipl.conf</filename> 中的 by-path 信息。
     </para>
    </step>
    <step>
     <para>
      运行 <command>dracut </command> <option>-f</option> 更新 <filename>initrd</filename> 映像。
     </para>
    </step>
    <step>
     <para>
      对于 IBM z Systems，请在运行 <command>dracut</command> 之后运行 <command>zipl</command>。
     </para>
    </step>
    <step>
     <para>
      重引导服务器。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.multipath.root.disable">
   <title>禁用根设备上的 I/O 多路径</title>
   <para>
    向内核命令行中添加 <literal>multipath=off</literal>。这可以通过 YaST 引导加载程序模块来完成。打开<menuchoice> <guimenu>引导加载程序安装</guimenu> <guimenu> 内核参数</guimenu>
    </menuchoice>，并将参数添加到两个命令行中。
   </para>
   <para>
    这仅会影响根设备。不会影响所有其他设备。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.multipath.raid">
  <title>为现有软件 RAID 配置多路径 I/O</title>

  <para>
   理想的情况下，应先为设备配置多路径，再将这些设备用作软件 RAID 设备的组件。如果创建任何软件 RAID 设备之后添加多路径，则在重引导时，DM-MPIO 服务可能会比 <command>multipath</command> 服务启动得晚，导致多路径似乎不可用于 RAID。您可以使用本节中的过程使多路径对先前现有的软件 RAID 运行。
  </para>

  <para>
   例如，您可能需要在以下情况中对软件 RAID 中的设备配置多路径：
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     如果在全新安装或升级期间将一个新的软件 RAID 创建为分区设置的一部分。
    </para>
   </listitem>
   <listitem>
    <para>
     如果在软件 RAID 将设备用作成员设备或备用设备之前，没有将这些设备配置为支持多路径。
    </para>
   </listitem>
   <listitem>
    <para>
     如果通过向服务器添加新的 HBA 适配器或扩展 SAN 中的储存子系统而增加了系统规模。
    </para>
   </listitem>
  </itemizedlist>

  <note>
   <title>假设条件</title>
   <para>
    以下说明假定软件 RAID 设备是 <filename>/dev/mapper/mpath0</filename>，这是内核可以识别的设备名。它假设您已按照<xref linkend="sec.multipath.names" xrefstyle="HeadingOnPage"/>所述在 <filename>/etc/multipath.conf</filename> 文件中启用了用户友好的名称。
   </para>
   <para>
    确保按照您软件 RAID 的设备名修改指令。
   </para>
  </note>

  <procedure>
   <step>
    <para role="intro">
     打开一个终端控制台。
    </para>
    <para>
     除非另行说明，请使用此控制台输入以下步骤中的命令。
    </para>
   </step>
   <step>
    <para>
     如果当前已装入或正在运行任何软件 RAID 设备，请对每个设备输入以下命令来卸载并停止设备。
    </para>
<screen>sudo umount /dev/mapper/mpath0
sudo mdadm --misc --stop /dev/mapper/mpath0</screen>
   </step>
   <step>
    <para>
     输入以下命令停止 <command>md</command> 服务
    </para>
<screen>sudo systemctl stop mdmonitor</screen>
   </step>
   <step>
    <para>
     输入以下命令启动 <systemitem class="daemon">multipathd</systemitem> 守护程序：
    </para>
<screen>systemctl start multipathd</screen>
   </step>
   <step>
    <para>
     启动多路径服务之后，校验软件 RAID 的组件设备是否列在 <filename>/dev/disk/by-id</filename> 目录中。执行以下操作之一：
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <formalpara>
       <title>已列出设备：</title>
       <para>
        现在设备名应已具有到其设备映射程序多路径设备名的符号链接，例如 <filename>/dev/dm-1</filename>。
       </para>
      </formalpara>
     </listitem>
     <listitem>
      <formalpara>
       <title>未列出设备：</title>
       <para>
        输入以下命令清理并重新发现设备，强制多路径服务识别它们
       </para>
      </formalpara>
<screen>sudo multipath -F
sudo multipath -v0</screen>
      <para>
       这些设备现在应已在 <filename>/dev/disk/by-id</filename> 中列出，并且有到其设备映射程序多路径设备名的符号链接。例如：
      </para>
<screen>lrwxrwxrwx 1 root root 10 2011-01-06 11:42 dm-uuid-mpath-36006016088d014007e0d0d2213ecdf11 -&gt; ../../dm-1</screen>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     输入以下命令重启动 <filename>mdmonitor</filename> 服务和 RAID 设备
    </para>
<screen>systemctl start mdmonitor</screen>
   </step>
   <step>
    <para>
     通过输入以下命令，检查软件 RAID 的状态
    </para>
<screen>mdadm --detail /dev/mapper/mpath0</screen>
    <para>
     RAID 的组件设备应匹配在 <filename>/dev/disk/by-id</filename> 目录中列为设备符号链接的设备映射程序多路径设备名。
    </para>
   </step>
   <step>
    <para>
     如果根 (<filename>/</filename>) 设备或其任何部分（例如 <filename>/var</filename>、<filename>/etc</filename>、<filename>/log</filename>）位于 SAN 上，并且需要使用多路径引导，请重构建 <systemitem>initrd</systemitem>：
    </para>
    <screen>dracut -f --add-multipath</screen>
   </step>
   <step>
    <para>
     重引导服务器以应用更改。
    </para>
   </step>
   <step>
    <para>
     通过检查 RAID 状态，校验软件 RAID 阵列在多路径设备之上正确工作。输入
    </para>
<screen>mdadm --detail /dev/mapper/mpath0</screen>
    <para>
     例如：
    </para>
    <simplelist>
     <member><literal>Number Major Minor RaidDevice State</literal>
     </member>
     <member><literal>  0 253 0 0 active sync /dev/dm-0</literal>
     </member>
     <member><literal>  1 253 1 1 active sync /dev/dm-1</literal>
     </member>
     <member><literal>  2 253 2 2 active sync /dev/dm-2</literal>
     </member>
    </simplelist>
   </step>
  </procedure>

  <note>
   <title>对多路径设备使用 mdadm</title>
   <para>
    <command>mdadm</command> 工具要求使用 ID 而不是设备节点路径访问设备。有关详细信息，请参见<xref linkend="sec.multipath.mpiotools.mdadm"/>。
   </para>
  </note>
 </sect1>
 <sect1 xml:id="sec.multipath.lvm">
  <title>在多路径设备上使用 LVM2</title>
  <para>LVM 默认配置为忽略多路径设备的组件。虽然这很可能是您期望的行为，但也可在 <filename>/etc/lvm/lvm.conf</filename> 中更改它。如果将 multipath_component_detection 设置为 0，LVM 会扫描多路径组件设备。lvm.conf 中的默认项是：
  </para>
<screen>    # By default, LVM2 will ignore devices used as component paths
    # of device-mapper multipath devices.
    # 1 enables; 0 disables.
    multipath_component_detection = 1</screen>
 </sect1>
 <sect1 xml:id="sec.multipath.best_practice">
  <title>最佳实践</title>

  <para/>

  <sect2 xml:id="sec.multipath.best_practice.scandev">
   <title>在不重引导的情况下扫描新设备</title>
   <para>
    如果系统已针对多路径进行配置并且稍后需要向 SAN 添加更多储存区，则可以使用脚本 <command>rescan-scsi-bus.sh</command> 扫描新设备。默认情况下，此脚本将扫描具有典型 LUN 范围的所有 HBA。该命令的一般语法如下所示：
   </para>
<screen>rescan-scsi-bus.sh [options] [host [host ...]]</screen>
   <para>
    对于大多数储存子系统，此脚本可在无选项的情况下成功运行。不过，在某些特殊情况下，可能需要使用一或多个选项。有关细节，请运行 <command>rescan-scsi-bus.sh --help</command>。
   </para>
   <warning>
    <title>EMC PowerPath 环境</title>
    <para>
     在 EMC PowerPath 环境中，请勿使用操作系统随附的 <filename>rescan-scsi-bus.sh</filename> 实用程序或 HBA 供应商脚本来扫描 SCSI 总线。为了避免可能发生的文件系统损坏，EMC 要求您遵照 EMC PowerPath for Linux 的供应商文档中提供的过程操作。
    </para>
   </warning>
   <para>
    使用以下过程扫描设备并在不重引导系统的情况下使这些设备可用于多路径。
   </para>
   <procedure>
    <step>
     <para>
      在储存子系统上，使用供应商的工具分配设备并更新其访问控制设置，以允许 Linux 系统访问新的储存区。有关细节，请参见供应商的文档。
     </para>
    </step>
    <step>
     <para>
      在所有目标中扫描查找一个主机，使其新设备为 Linux 内核 SCSI 子系统的中间层所知。在终端控制台提示符下，输入
     </para>
<screen>sudo rescan-scsi-bus.sh</screen>
     <para>
      根据您的设置，您可能需要结合可选参数运行 <command>rescan-scsi-bus.sh</command>。有关细节，请参见 <command>rescan-scsi-bus.sh --help</command>。
     </para>
    </step>
    <step>
     <para>
      请在 <systemitem class="daemon">systemd</systemitem> 日记中检查扫描进度（有关细节，请参见<xref linkend="cha.journalctl"/>）。在终端控制台提示符下，输入
     </para>
<screen>sudo journalctl -r</screen>
     <para>
      此命令显示日志的最后 行。例如：
     </para>
<screen><prompt>tux &gt; </prompt>sudo journalctl -r
Feb 14 01:03 kernel: SCSI device sde: 81920000
Feb 14 01:03 kernel: SCSI device sdf: 81920000
Feb 14 01:03 multipathd: sde: path checker registered
Feb 14 01:03 multipathd: sdf: path checker registered
Feb 14 01:03 multipathd: mpath4: event checker started
Feb 14 01:03 multipathd: mpath5: event checker started
Feb 14 01:03:multipathd: mpath4: remaining active paths: 1
Feb 14 01:03 multipathd: mpath5: remaining active paths: 1
[...]</screen>
    </step>
    <step>
     <para>
      重复上述步骤，以添加通过 Linux 系统上连接到新设备的其他 HBA 适配器的路径。
     </para>
    </step>
    <step>
     <para>
      运行 <command>multipath</command> 命令以识别 DM-MPIO 配置的设备。在终端控制台提示符下，输入
     </para>
<screen>sudo multipath</screen>
     <para>
      现在可以为多路径配置新设备了。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.multipath.best_practice.scanpart">
   <title>在不重引导的情况下扫描新的分区设备</title>
   <para>
    使用本节中的示例，在不重引导的情况下检测新添加的多路径 LUN。
   </para>
   <warning>
    <title>EMC PowerPath 环境</title>
    <para>
     在 EMC PowerPath 环境中，请勿使用操作系统随附的 <filename>rescan-scsi-bus.sh</filename> 实用程序或 HBA 供应商脚本来扫描 SCSI 总线。为了避免可能发生的文件系统损坏，EMC 要求您遵照 EMC PowerPath for Linux 的供应商文档中提供的过程操作。
    </para>
   </warning>
   <procedure>
    <step>
     <para>
      打开一个终端控制台。
     </para>
    </step>
    <step>
     <para>
      在所有目标中扫描查找一个主机，使其新设备为 Linux 内核 SCSI 子系统的中间层所知。在终端控制台提示符下，输入
     </para>
<screen>rescan-scsi-bus.sh</screen>
     <para>
      根据您的设置，您可能需要结合可选参数运行 <command>rescan-scsi-bus.sh</command>。有关细节，请参见 <command>rescan-scsi-bus.sh --help</command>。
     </para>
    </step>
    <step>
     <para>
      通过输入以下命令校验该设备是否可见（例如链接是否有一个新的时戳）
     </para>
<screen>ls -lrt /dev/dm-*</screen>
     <para>
      您也可以通过输入以下命令来校验设备存在于 <filename>/dev/disk/by-id</filename> 中
     </para>
<screen>ls -l /dev/disk/by-id/</screen>
    </step>
    <step>
     <para>
      通过输入以下命令，校验新设备是否出现在日志中
     </para>
<screen>sudo journalctl -r</screen>
    </step>
    <step>
     <para>
      使用文本编辑器，在 <filename>/etc/multipath.conf</filename> 文件中为该设备添加新的别名定义，例如 <filename>data_vol3</filename>。
     </para>
     <para>
      例如，如果 UUID 是 <filename>36006016088d014006e98a7a94a85db11</filename>，则进行以下更改：
     </para>
<screen>defaults {
     user_friendly_names   yes
  }
multipaths {
     multipath {
          wwid    36006016088d014006e98a7a94a85db11
          alias  data_vol3
          }
  }</screen>
    </step>
    <step>
     <para>
      通过输入以下命令，为该设备创建分区表
     </para>
<screen>fdisk /dev/disk/by-id/dm-uuid-mpath-&lt;UUID&gt;</screen>
     <para>
      使用设备的 WWID（如 <filename>36006016088d014006e98a7a94a85db11</filename>）替换 UUID。
     </para>
    </step>
    <step>
     <para>
      通过输入以下命令触发 udev
     </para>
<screen>sudo echo 'add' &gt; /sys/block/<replaceable>dm_device</replaceable>/uevent</screen>
     <para>
      例如，要为 <filename>dm-8</filename> 上的分区生成设备映射程序设备，请输入
     </para>
<screen>sudo echo 'add' &gt; /sys/block/dm-8/uevent</screen>
    </step>
    <step>
     <para>
      在设备 <filename>/dev/disk/by-id/dm-uuid-mpath-<replaceable>UUID_partN</replaceable></filename> 上创建文件系统。根据您选择的文件系统，您可以使用以下其中一个命令实现此目的：<command>mkfs.btrfs</command>
      <command> mkfs.ext3</command>、<command>mkfs.ext4</command> 或 <command>mkfs.xfs</command>。有关细节，请参见相应的手册页。用实际的 UUID 和分区编号替换 <filename>UUID_partN</filename>，例如 36006016088d014006e98a7a94a85db11_part1。
     </para>
    </step>
    <step>
     <para>
      输入以下命令为新分区创建标签：
     </para>
<screen>sudo tune2fs -L <replaceable>LABELNAME</replaceable> /dev/disk/by-id/dm-uuid-<replaceable>UUID_partN</replaceable>
</screen>
     <para>
      用实际的 UUID 和分区编号替换 <filename>UUID_partN</filename>，例如 36006016088d014006e98a7a94a85db11_part1。用您选择的标签替换 <replaceable>LABELNAME</replaceable>。
     </para>
    </step>
    <step>
     <para>
      输入以下命令以重配置 DM-MPIO，使其读取别名：
     </para>
<screen>sudo multipathd -k'reconfigure'</screen>
    </step>
    <step>
     <para>
      通过输入以下命令，校验该设备已由 <systemitem class="daemon">multipathd</systemitem> 识别
     </para>
<screen>sudo multipath -ll</screen>
    </step>
    <step>
     <para>
      使用文本编辑器在 <filename>/etc/fstab</filename> 文件中添加新的装入项。
     </para>
     <para>
      此时，您在上一步中创建的别名还不在 <filename>/dev/disk/by-label</filename> 目录中。为 <filename>/dev/dm-9</filename> 路径添加一个装入项，然后在下次重引导到以下项目之前更改该项目
     </para>
<screen>LABEL=<replaceable>LABELNAME</replaceable></screen>
    </step>
    <step>
     <para>
      创建要作为安装点的目录，然后装入设备。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.multipath.best_practice.status">
   <title>查看多路径 I/O 状态</title>
   <para>
    查询多路径 I/O 状态会输出多路径映射的当前状态。
   </para>
   <para>
    <command>multipath -l</command> 选项可显示从上次运行路径检查程序以来的当前路径状态。它不会运行路径检查程序。
   </para>
   <para>
    <command>multipath -ll</command> 选项运行路径检查程序，更新路径信息，然后显示当前状态信息。此命令始终显示关于路径状态的最新信息。
   </para>
<screen><prompt>tux &gt; </prompt>sudo multipath -ll
3600601607cf30e00184589a37a31d911
[size=127 GB][features="0"][hwhandler="1 emc"]

\_ round-robin 0 [active][first]
  \_ 1:0:1:2 sdav 66:240  [ready ][active]
  \_ 0:0:1:2 sdr  65:16   [ready ][active]

\_ round-robin 0 [enabled]
  \_ 1:0:0:2 sdag 66:0    [ready ][active]
  \_ 0:0:0:2 sdc  8:32    [ready ][active]</screen>
   <para>
    对于每个设备，它显示该设备的 ID、大小、功能和硬件处理程序。
   </para>
   <para>
    在设备发现时，通向该设备的路径会自动分组为多个优先级组。一次只有一个优先级组是活动的。对于活动/活动配置，所有路径均在同一组中。对于活动/不活动配置，不活动的路径会放在另外的优先级组中。
   </para>
   <para>
    会针对每个组显示下列信息：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      用于在组内平衡 I/O 的日程安排策略，例如循环
     </para>
    </listitem>
    <listitem>
     <para>
      该组为活动、已禁用还是已启用
     </para>
    </listitem>
    <listitem>
     <para>
      该组是否是第一个（最高优先级）组
     </para>
    </listitem>
    <listitem>
     <para>
      该组内包含的路径
     </para>
    </listitem>
   </itemizedlist>
   <para>
    会针对每个路径显示下列信息：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      物理地址，格式为 <replaceable>host:bus:target:lun</replaceable>，例如 1:0:1:2
     </para>
    </listitem>
    <listitem>
     <para>
      设备节点名，例如 <filename>sda</filename>
     </para>
    </listitem>
    <listitem>
     <para>
      主要:次要编号
     </para>
    </listitem>
    <listitem>
     <para>
      设备的状态
     </para>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="sec.multipath.best_practice.io_error">
   <title>在错误状况下管理 I/O</title>
   <para>
    如果所有路径同时失败，则可能需要通过启用 queue_if_no_path 来配置多路径以使 I/O 排队。否则，I/O 将在通过所有路径后立即失败。在某些情形下，即驱动程序、HBA 或光纤遇到欺骗性错误时，应该将 DM-MPIO 配置为在这些错误导致丢失所有路径时将所有 I/O 排队，并且永不向上散播错误。
   </para>
   <para>
    在群集中使用多路径设备时，可以选择禁用 queue_if_no_path。这会自动使路径失败，而不是使 I/O 排队，并升级 I/O 错误以引发群集资源的故障转移。
   </para>
   <para>
    因为启用 queue_if_no_path 会导致 I/O 无限排队（除非有一个路径恢复），所以请确保 <command>multipathd</command> 正在运行且在您的环境中起作用。否则，可能需要在受影响的多路径设备上永远停止 I/O，直到重引导或手动返回到故障转移而不是排队。
   </para>
   <para>
    测试该情形：
   </para>
   <procedure>
    <step>
     <para>
      打开一个终端控制台。
     </para>
    </step>
    <step>
     <para>
      输入以下命令激活设备 I/O 的排队而非故障转移
     </para>
<screen>sudo dmsetup message <replaceable>device_ID</replaceable> 0 queue_if_no_path</screen>
     <para>
      将<replaceable>设备 ID</replaceable> 替换为您的设备的 ID。值 0 代表扇区，在不需要扇区信息时使用该值。
     </para>
     <para>
      例如，输入：
     </para>
<screen>sudo dmsetup message 3600601607cf30e00184589a37a31d911 0 queue_if_no_path</screen>
    </step>
    <step>
     <para>
      输入以下命令返回到设备 I/O 的故障转移
     </para>
<screen>sudo dmsetup message <replaceable>device_ID</replaceable> 0 fail_if_no_path</screen>
     <para>
      该命令会立即导致所有排队的 I/O 失败。
     </para>
     <para>
      将<replaceable>设备 ID</replaceable> 替换为您的设备的 ID。例如，输入
     </para>
<screen>sudo dmsetup message 3600601607cf30e00184589a37a31d911 0 fail_if_no_path</screen>
    </step>
   </procedure>
   <para>
    在所有路径失败的情形下设置将 I/O 排队：
   </para>
   <procedure>
    <step>
     <para>
      打开一个终端控制台。
     </para>
    </step>
    <step>
     <para>
      在文本编辑器中打开 <filename>/etc/multipath.conf</filename>。
     </para>
    </step>
    <step>
     <para>
      取消注释 defaults 部分及其结尾括号，然后如下所示添加 <literal>default_features</literal> 设置：
     </para>
<screen>defaults {
  default_features "1 queue_if_no_path"
}</screen>
    </step>
    <step>
     <para>
      修改 <filename>/etc/multipath.conf</filename> 文件后，您必须运行 <command>dracut </command> <option>-f</option> 在系统中重新创建 <filename>initrd</filename>，然后重引导以使更改生效。
     </para>
    </step>
    <step>
     <para>
      当您准备好返回到设备 I/O 的故障转移时，请输入
     </para>
<screen>sudo dmsetup message <replaceable>mapname</replaceable> 0 fail_if_no_path</screen>
     <para>
      将 <replaceable>mapname</replaceable> 替换为映射的别名或该设备的设备 ID。值 0 代表扇区，在不需要扇区信息时使用该值。
     </para>
     <para>
      此命令会立即导致所有排队的 I/O 失败，并且将该错误传播到调用的应用程序。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.multipath.best_practice.io_stalled">
   <title>解决停止的 I/O</title>
   <para>
    如果所有路径同时失败，并且 I/O 排队并停止，请执行以下操作：
   </para>
   <procedure>
    <step>
     <para>
      在终端控制台提示符下输入以下命令：
     </para>
<screen>sudo dmsetup message <replaceable>mapname</replaceable> 0 fail_if_no_path</screen>
     <para>
      将<literal><replaceable>映射名称</replaceable></literal>替换为正确的设备 ID 或设备的映射别名。值 0 代表扇区，在不需要扇区信息时使用该值。
     </para>
     <para>
      此命令会立即导致所有排队的 I/O 失败，并且将该错误传播到调用的应用程序。
     </para>
    </step>
    <step>
     <para>
      输入以下命令重新激活排队：
     </para>
<screen>sudo dmsetup message <replaceable>mapname</replaceable> 0 queue_if_no_path</screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.multipath.best_practice.zseries">
   <title>配置 IBM z Systems 设备的默认设置</title>
   <para>
    使用多路径对 IBM z Systems 设备进行的测试表明，应将 <literal>dev_loss_tmo</literal> 参数设置为 90 秒，将 <literal>fast_io_fail_tmo</literal> 参数设置为 5 秒。如果您使用的是 z Systems 设备，请按以下方式修改 <filename>/etc/multipath.conf</filename> 文件来指定这些值：
   </para>
<screen>defaults {
       dev_loss_tmo 90
       fast_io_fail_tmo 5
}</screen>
   <para>
    <literal>dev_loss_tmo</literal> 参数设置将某个多路径链接标记为无效之前需等待的秒数。如果路径失败，则已失败路径上的任何当前 I/O 将失败。默认值根据所使用的设备驱动程序而异。值的有效范围为 0 到 600 秒。要使用驱动程序的内部超时，请将此值设置为零 (0) 或大于 600 的任意值。
   </para>
   <para>
    <literal>fast_io_fail_tmo</literal> 参数设置检测到链接问题时将 I/O 确定为失败之前需等待的时间。到达驱动程序的 I/O 将失败。如果 I/O 排在拥堵的队列中，则未到 <literal>dev_loss_tmo</literal> 时间且队列未疏通之前 I/O 不会失败。
   </para>
   <para>
    如果您修改了 <filename>/etc/multipath.conf</filename> 文件，所做的更改只有在您更新多路径映射或重启动 <systemitem class="daemon">multipathd</systemitem> 守护程序 (<command>systemctl restart multipathd</command>) 后才会应用。
   </para>
  </sect2>

  <sect2 xml:id="sec.multipath.best_practice.netapp">
   <title>使用 NetApp 设备的多路径</title>
   <para>
    使用适用于 NetApp 设备的多路径时，建议在 <filename>/etc/multipath.conf</filename> 文件中进行如下设置：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      为 NetApp 设备全局设置以下参数的默认值：
     </para>
<screen>max_fds max
queue_without_daemon no</screen>
    </listitem>
    <listitem>
     <para>
      在硬件表中为 NetApp 设备的以下参数设置默认值：
     </para>
<screen>dev_loss_tmo infinity
fast_io_fail_tmo 5
features "3 queue_if_no_path pg_init_retries 50"</screen>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="sec.multipath.best_practice.noflush">
   <title>对多路径设备使用 --noflush</title>
   <para>
    在多路径设备上运行时，应始终使用 <option>--noflush</option>选项。
   </para>
   <para>
    例如，在执行重新装载表的脚本中，应继续使用 <literal>--noflush</literal> 选项以确保任何未解决的 I/O 不会被刷新，因为您需要多路径拓扑信息。
   </para>
<screen>load
resume --noflush</screen>
  </sect2>

  <sect2 xml:id="sec.multipath.best_practice.san_timeout">
   <title>根设备为多路径时的 SAN 超时设置</title>

   <para>
    所有路径都已失败并已从系统中去除时，多路径设备上包含根目录 (<filename>/</filename>) 的系统可能会停止，因为系统会收到储存子系统（例如光纤通道储存阵列）发出的 <literal>dev_loss_tmo</literal> 超时通知。
   </para>
   <para>
    如果系统设备配置了多路径，且多路径 <literal>no_path_retry</literal> 设置处于活动状态，则应相应地修改储存子系统的 <literal>dev_loss_tmo</literal> 设置，以确保所有路径都失败时不会删除任何设备。强烈建议您将 <literal>dev_loss_tmo</literal> 值设置为等于或大于多路径的 <literal>no_path_retry</literal> 设置。
   </para>
   <para>
    建议按如下方式设置储存子系统的 <literal>dev_los_tmo</literal>：
   </para>
<screen>&lt;dev_loss_tmo&gt; = &lt;no_path_retry&gt; * &lt;polling_interval&gt;</screen>
   <para>
    以下定义适用于多路径值：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      <literal>no_path_retry</literal> 是将路径视为丢失并停止 IO 排队前多路径 I/O 的重试次数。
     </para>
    </listitem>
    <listitem>
     <para>
      <literal>polling_interval</literal> 是路径检查的间隔时间（以秒为单位）。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    以上多路径值都应该从 <filename>/etc/multipath.conf</filename> 配置文件进行设置。有关信息，请参阅<xref linkend="sec.multipath.conf_file" xrefstyle="SectTitleOnPage"/>。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.multipath.trouble">
  <title>MPIO 查错</title>

  <para>
   本节对 MPIO 的一些已知问题以及可行的解决方案进行了说明。
  </para>

  <sect2 xml:id="sec.multipath.trouble.root">
   <title>启用多路径时系统在引导过程中退出到紧急外壳</title>
   <para>
    在引导过程中，系统退出到紧急外壳，并显示类似如下的讯息：
   </para>
<screen>[  OK  ] Listening on multipathd control socket.
         Starting Device-Mapper Multipath Device Controller...
[  OK  ] Listening on Device-mapper event daemon FIFOs.
         Starting Device-mapper event daemon...
         Expecting device dev-disk-by\x2duuid-34be48b2\x2dc21...32dd9.device...
         Expecting device dev-sda2.device...
[  OK  ] Listening on udev Kernel Socket.
[  OK  ] Listening on udev Control Socket.
         Starting udev Coldplug all Devices...
         Expecting device dev-disk-by\x2duuid-1172afe0\x2d63c...5d0a7.device...
         Expecting device dev-disk-by\x2duuid-c4a3d1de\x2d4dc...ef77d.device...
[  OK  ] Started Create list of required static device nodes ...current kernel.
         Starting Create static device nodes in /dev...
[  OK  ] Started Collect Read-Ahead Data.
[  OK  ] Started Device-mapper event daemon.
[  OK  ] Started udev Coldplug all Devices.
         Starting udev Wait for Complete Device Initialization...
[  OK  ] Started Replay Read-Ahead Data.
         Starting Load Kernel Modules...
         Starting Remount Root and Kernel File Systems...
[  OK  ] Started Create static devices
[   13.682489] floppy0: no floppy controllers found
[*     ] (1 of 4) A start job is running for dev-disk-by\x2du...(7s / 1min 30s)
[*     ] (1 of 4) A start job is running for dev-disk-by\x2du...(7s / 1min 30s)

...

Timed out waiting for device dev-disk-by\x2duuid-c4a...cfef77d.device.
[DEPEND] Dependency failed for /opt.
[DEPEND] Dependency failed for Local File Systems.
[DEPEND] Dependency failed for Postfix Mail Transport Agent.
Welcome to emergency shell
Give root password for maintenance
(or press Control-D to continue):</screen>
   <para>
    在下列情况下，可能会发生此问题：
   </para>
   <itemizedlist>
     <listitem>
      <para>
       在启用多路径的情况下，未将非多路径根文件系统加入黑名单。请参见<xref linkend="pro.multipath.trouble.root.blacklist" xrefstyle="HeadingOnPage"/>
      </para>
     </listitem>
     <listitem>
      <para>
       在具有多路径根文件系统的系统上，启用/禁用了多路径，但未重构建 <filename>initrd</filename>。请参见<xref linkend="pro.multipath.trouble.root.initrd"/>
      </para>
     </listitem>
     <listitem>
      <para>
       在具有网络挂接储存且启用了多路径的系统上，<filename>initrd</filename> 中缺少网络储存的驱动程序
      </para>
     </listitem>
   </itemizedlist>

   <procedure xml:id="pro.multipath.trouble.root.blacklist">
    <title>应急外壳：将文件系统加入黑名单 </title>
    <para>
     如果根文件系统不在多路径上，却启用了多路径，则需要此修复。在此类设置中，多路径会尝试为未加入黑名单的所有设备设置其路径。由于具有根文件系统的设备已装入，它对于多路径而言是无法访问的，因而会导致路径设置失败。您可以在 <filename>/etc/multipath.conf</filename> 中将根设备加入黑名单来正确设置多路径，从而修复此问题。
    </para>
    <step>
     <para>
      在紧急外壳中运行 <command>multipath -v2</command> 并确定根文件系统的设备。产生的输出如下所示：
     </para>
<screen><prompt role="root">root # </prompt>multipath -v2
Dec 18 10:10:03 | 3600508b1001030343841423043300400: ignoring map</screen>
     <para>
      <literal>| </literal> 和 <literal>:</literal> 之间的字符串是加入黑名单所需的 WWID。
     </para>
    </step>
    <step>
     <para>
      打开 <filename>/etc/multipath.conf</filename> 并添加以下内容：
     </para>
<screen>blacklist {
  wwid "<replaceable>WWWID</replaceable>"
}</screen>
     <para>
      用在上一步中获取的 ID 替换 <replaceable>WWWID</replaceable>。有关详细信息，请参见<xref linkend="sec.multipath.blacklist"/>。
     </para>
    </step>
    <step>
     <para>
      按 <keycombo>
      <keycap function="control"/> <keycap>  D</keycap> </keycombo>  退出紧急外壳并重引导服务器。
     </para>
    </step>
   </procedure>

   <procedure xml:id="pro.multipath.trouble.root.initrd">
    <title>应急外壳：重构建 <filename>initrd</filename></title>
    <para>
     如果 <filename>initrd</filename> 与系统之间的多路径状态（已启用或已禁用）不相同，则需要此修复。要修复此问题，请重构建 <filename>initrd</filename>：
    </para>
    <step>
     <para>
      如果已在系统中<emphasis>启用</emphasis>多路径，请通过以下命令重构建支持多路径的 initrd：
     </para>
     <screen>dracut --force --add multipath</screen>
     <para>
      如果已在系统中<emphasis>禁用</emphasis>多路径，请通过以下命令重构建支持多路径的 initrd：
     </para>
     <screen>dracut --force -o multipath</screen>
    </step>
    <step>
     <para>
      按 <keycombo>
      <keycap function="control"/> <keycap>  D</keycap> </keycombo>  退出紧急外壳并重引导服务器。
     </para>
    </step>
   </procedure>

   <procedure xml:id="pro.multipath.trouble.root.drivers">
    <title>应急外壳：重构建 <filename>initrd</filename></title>
    <para>
     如果 initrd 不包含用于访问网络挂接储存的驱动程序，则需要此修复。例如，如果系统是在没有多路径的情况下安装的，或者当添加或更换相应硬件时，就可能需要此修复。
    </para>
    <step>
     <para>
      将所需的驱动程序添加至文件 <filename>/etc/dracut.conf.d/01-dist.conf</filename> 中的变量 <envar>force_drivers</envar>。例如，如果系统包含 <filename>hpsa</filename> 驱动程序访问的 RAID 控制器，且多路径设备连接到由 qla23xx 驱动程序访问的 QLogic 控制器，该项将会如下所示：
     </para>
     <screen>force_drivers+="hpsa qla23xx"</screen>
    </step>
    <step>
     <para>
      使用以下命令重构建 <systemitem>initrd</systemitem>：
     </para>
     <screen>dracut -f --add-multipath</screen>
    </step>
    <step>
     <para>
      为了防止在挂接网络储存失败时系统引导到应急模式，建议将装入选项 <literal>_netdev</literal> 添加到 <filename>/etc/fstab</filename> 中的相应项。
     </para>
    </step>
    <step>
     <para>
      按 <keycombo>
      <keycap function="control"/> <keycap>  D</keycap> </keycombo>  退出紧急外壳并重引导服务器。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.multipath.trouble.prio_fail">
   <title>升级到多路径 0.4.9 或更高版本后单个设备的 PRIO 设置不起作用</title>
   <para>
    从 0.4.9 版开始，多路径工具使用 <filename>/etc/multipath.conf</filename> 文件 <literal>defaults{}</literal> 或 <literal>devices{}</literal> 部分中的 <literal>prio</literal> 设置。当为 <literal>multipaths{}</literal> 部分中的单个 <literal>multipath</literal> 定义指定关键字 <literal>prio</literal> 时，它将被忽略而无反馈。
   </para>
   <para>
    多路径工具 0.4.8 允许 <literal>multipaths{)</literal> 部分单个 <literal>multipath</literal> 定义中的 prio 设置覆盖 <literal>defaults{}</literal> 或 <literal>devices{}</literal> 部分中的 <literal>prio</literal> 设置。
   </para>
  </sect2>

  <sect2 xml:id="sec.multipath.trouble.prio_argument_fail">
   <title>升级到 multipath-tools-0.4.9 或更高版本后带有自变量的 PRIO 设置不起作用</title>
   <para>
    从 <filename>multipath-tools-0.4.8</filename> 升级到 <filename>multipath-tools-0.4.9</filename> 时，若优先级排序程序需要自变量，则 <filename>/etc/multipath.conf</filename> 文件中的 <literal>prio</literal> 设置会损坏。在 multipath-tools-0.4.9 中，使用关键字 <literal>prio</literal> 指定优先级排序程序，使用关键字 <literal>prio_args</literal> 为需要自变量的优先级排序程序指定自变量。而在早前版本中，优先级排序程序及其自变量均在同一个 <literal>prio</literal> 行上指定。
   </para>
   <para>
    例如，在 multipath-tools-0.4.8 中，可使用以下一行命令指定优先级排序程序及其自变量。
   </para>
<screen>prio "weightedpath hbtl [1,3]:.:.+:.+ 260 [0,2]:.:.+:.+ 20"</screen>
   <para>
    升级到 multipath-tools-0.4.9 或更高版本后，该命令会导致错误。出现的消息类似如下所示：
   </para>
<screen>&lt;Month day hh:mm:ss&gt; | Prioritizer 'weightedpath hbtl [1,3]:.:.+:.+ 260
[0,2]:.:.+:.+ 20' not found in /lib64/multipath</screen>
   <para>
    要解决此问题，请使用文本剪辑器修改 <filename>/etc/multipath.conf</filename> 文件中的 <literal>prio</literal> 行。创建两行，其中 <filename>prio</filename> 行指定优先级排序程序，而下方的 <filename>prio_args</filename> 行指定其自变量：
   </para>
<screen>prio "weightedpath"
prio_args "hbtl [1,3]:.:.+:.+ 260 [0,2]:.:.+:.+ 20"</screen>
   <para>
    运行 <command>sudo systemctl restart multipathd</command> 重启动 <systemitem class="daemon">multipathd</systemitem> 守护程序，以使更改生效。
   </para>
  </sect2>

  <sect2 xml:id="sec.multipath.trouble.tids">
   <title>技术信息文档</title>
   <para>
    有关 SUSE Linux Enterprise Server 上多路径 I/O 问题的查错信息，请参见 SUSE 知识库中的下列技术信息文档 (TID)：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      <link xlink:href="http://www.suse.com/support/kb/doc.php?id=3617600"><citetitle>Using LVM on local and SAN attached devices（在本地设备和挂接 SAN 的设备上使用 LVM）</citetitle></link>
     </para>
    </listitem>
    <listitem>
     <para>
      <link xlink:href="http://www.suse.com/support/kb/doc.php?id=7007498"><citetitle>Using LVM on Multipath (DM MPIO) Devices（在多路径 (DM MPIO) 设备上使用 LVM)</citetitle></link>
     </para>
    </listitem>
    <listitem>
     <para>
      <link xlink:href="https://www.suse.com/support/kb/doc.php?id=7009660"><citetitle>HOWTO: Add, Resize and Remove LUN without restarting SLES（操作指南：在不重启动 SLES 的情况下添加、调整大小和去除 LUN）</citetitle></link>
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
 </sect1>
</chapter>
