<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="rmt_migrate_from_smt.xml" version="5.0" xml:id="cha-rmt-migrate">
  
  <info>
    <title>从 SMT 迁移到 RMT</title>
    <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
      <dm:translation>yes</dm:translation>
    </dm:docmanager>
  </info>
  <para>
    本章说明如何从 SLES 11 或 12 上的 SMT 迁移到 SLES 15 上的 RMT。
  </para>
  <sect1 xml:id="sec-rmt-migrate-notes">
    <title>重要注意事项</title>

    <warning>
      <title>请仔细阅读本节内容</title>
      <para>
        请仔细阅读本节内容。其中包含有关迁移过程的重要信息。
      </para>
    </warning>

    <variablelist>
      <varlistentry>
        <term>使用新主机</term>
        <listitem>
          <para>
            我们建议您在新安装的 SLES 15 主机上安装 RMT。RMT 并不能完全取代 SMT。RMT 具有不同于 SMT 的工作流程，仅支持注册 SUSE Linux Enterprise Server 12 及以上版本的系统。
          </para>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>软件源元数据和设置</term>
        <listitem>
          <para>
            将<emphasis>不会</emphasis>从 SMT 导出临时储存库的设置。将导出已标记为要镜像的储存库。
          </para>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>自定义软件源</term>
        <listitem>
          <para>
            只能导出标记为要镜像的软件源。
          </para>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>已失效订阅</term>
        <listitem>
          <para>
            RMT 上将不会提供组织订阅中已不再可用的产品。
          </para>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>客户端信息</term>
        <listitem>
          <para>
            将导出系统及其激活的产品。将不会从 SMT 导出 SMT 客户端作业和补丁状态。
          </para>
        </listitem>
      </varlistentry>
    </variablelist>

    <table xml:id="sec-rmt-migrate-notes-features">
      <title>功能对比</title>
      <tgroup cols="3">
        <colspec colnum="1" colname="1" colwidth="40*"/>
        <colspec colnum="2" colname="2" colwidth="30*"/>
        <colspec colnum="3" colname="3" colwidth="30*"/>
        <thead>
          <row>
            <entry>
              <para>
                功能
              </para>
            </entry>
            <entry>
              <para>
                SMT
              </para>
            </entry>
            <entry>
              <para>
                RMT
              </para>
            </entry>
          </row>
        </thead>
        <tbody>
          <row>
            <entry>
              <para>
                在 SLES 11 上可用
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
            <entry>
              <para>
                否
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                在 SLES 12 上可用
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
            <entry>
              <para>
                否
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                在 SLES 15 上可用
              </para>
            </entry>
            <entry>
              <para>
                否
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                将产品与 SUSE Customer Center 同步
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                从软件源镜像 RPM
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                选择性镜像（指定要镜像的产品）
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                通过 HTTP 提供 RPM
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                SLE 15 系统注册
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                SLE 12 系统注册
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                SLE 11 系统注册
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
            <entry>
              <para>
                否
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                支持从 SLE 12 迁移到 SLE 15
              </para>
            </entry>
            <entry>
              <para>
                是 <superscript>1</superscript>
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                支持从 SLE 15 SPx 迁移到 15 SPx+1
              </para>
            </entry>
            <entry>
              <para>
                是 <superscript>1</superscript>
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                临时软件源
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
            <entry>
              <para>
                否<superscript>2</superscript>
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                离线镜像
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                NTLM 代理支持
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                自定义软件源
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                YaST 安装向导
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                YaST 管理向导
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
            <entry>
              <para>
                否
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                客户端管理
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
            <entry>
              <para>
                否
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                对 Red Hat 7 及更低版本的支持 (<link xlink:href="https://www.suse.com/products/expandedsupport/">Expanded
                Support</link>)
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
            <entry>
              <para>
                否
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                对 Red Hat 8 的支持 (<link xlink:href="https://www.suse.com/products/expandedsupport/">Expanded
                Support</link>)
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                文件去重
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                将数据从 SMT 转移到 RMT
              </para>
            </entry>
            <entry>
              <para>
                无
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                将注册数据传输到 SUSE Customer Center
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                报告
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
            <entry>
              <para>
                否
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                Web 服务器的自定义 TLS 证书
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                清理软件源中不再使用的数据
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                Bash 补全
              </para>
            </entry>
            <entry>
              <para>
                否
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                在 <link xlink:href="https://github.com/SUSE/rmt/blob/master/docs/installation.md#installation-on-opensuse-leap-15">openSUSE
                Leap 15</link> 上提供
              </para>
            </entry>
            <entry>
              <para>
                否
              </para>
            </entry>
            <entry>
              <para>
                是 <superscript>3</superscript>
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                可以选择 <link xlink:href="https://github.com/SUSE/rmt/blob/master/README.md#development-setup---docker-compose">run
                as container</link>
              </para>
            </entry>
            <entry>
              <para>
                否
              </para>
            </entry>
            <entry>
              <para>
                是 <superscript>3</superscript>
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                简易开发设置 + <link xlink:href="https://github.com/SUSE/rmt/blob/master/docs/CONTRIBUTING.md">contribution
                guide</link>
              </para>
            </entry>
            <entry>
              <para>
                否
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                100% 测试 <link xlink:href="https://coveralls.io/github/SUSE/rmt?branch=master">coverage</link>
              </para>
            </entry>
            <entry>
              <para>
                否
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                <link xlink:href="https://github.com/SUSE/rmt/blob/master/docs/PLUGINS.md">Plugin
                functionality</link>
              </para>
            </entry>
            <entry>
              <para>
                否
              </para>
            </entry>
            <entry>
              <para>
                是
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                Web 服务器
              </para>
            </entry>
            <entry>
              <para>
                Apache 2
              </para>
            </entry>
            <entry>
              <para>
                Nginx
              </para>
            </entry>
          </row>
          <row>
            <entry>
              <para>
                平台
              </para>
            </entry>
            <entry>
              <para>
                Perl
              </para>
            </entry>
            <entry>
              <para>
                Ruby
              </para>
            </entry>
          </row>
        </tbody>
      </tgroup>
    </table>

    <orderedlist>
      <listitem>
        <para>
          SMT 仅部分支持将系统迁移到 SLE 15。SLE 15 由多个模块和扩展组成。有些模块只是提供补充性的功能，因此不是必需的。RMT 完全支持迁移到 SLE 15 以及在 SLE 15 内部迁移，因此它只会添加最少量的必需模块。SMT 不完全支持这种迁移，它将在系统上启用所有可用模块。
        </para>
      </listitem>
      <listitem>
        <para>
          功能由 <link xlink:href="https://documentation.suse.com/suma/">SUSE Manager</link> 提供。
        </para>
      </listitem>
      <listitem>
        <para>
          仅通过 <link xlink:href="https://www.suse.com/support/self-support/">self-support</link> 提供。
        </para>
      </listitem>
    </orderedlist>
  </sect1>
  <sect1 xml:id="sec-rmt-migrate-smt-export">
    <title>导出 SMT 数据</title>

    <procedure>
      <title>导出 SMT 数据</title>
      <step>
        <para>
          通过运行 <command>zypper
          up</command> 更新已安装的 SMT 服务器。
        </para>
      </step>
      <step>
        <para>
          要将 SSL 证书连同其余数据一起导出，请运行 <command>smt-data-export</command>。请记得将证书存放在安全位置。
        </para>
        <para>
          如果您不想从 SMT 导出 SSL 证书，请运行 <command>smt-data-export --no-ssl-export</command>。
        </para>
      </step>
      <step>
        <para>
          导出的配置现已保存到 <filename>smt-data-export.<replaceable>TIMESTAMP</replaceable>.tar.gz</filename>。将文件复制到新 RMT 服务器可以访问的位置。
        </para>
      </step>
    </procedure>
  </sect1>
  <sect1 xml:id="sec-rmt-migrate-rmt-import">
    <title>将 SMT 数据导入到 RMT</title>

    <procedure>
      <step>
        <para>
          运行 <command>zypper up</command> 以确保所安装的 RMT 为最新版本。
        </para>
      </step>
      <step>
        <para>
          将导出的 <literal>.tar.gz</literal> 文件复制到某个空目录，并将其解压缩。然后进入新目录：
        </para>
<screen><prompt>&gt; </prompt><command>mkdir <replaceable>EMPTY_DIR</replaceable></command>
<prompt>&gt; </prompt><command>cd <replaceable>EMPTY_DIR</replaceable></command>
<prompt>&gt; </prompt><command>tar xf <replaceable>/PATH/TO/</replaceable>smt-data-export.<replaceable>TIMESTAMP</replaceable>.tar.gz</command>
<prompt>&gt; </prompt><command>cd smt-data-export</command>
</screen>
      </step>
      <step>
        <para>
          如果您之前选择从 SMT 导出 SSL 证书，请将 CA 私用密钥和证书复制到 <filename>/etc/rmt/ssl/</filename> 中：
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>cp ssl/cacert.key /etc/rmt/ssl/rmt-ca.key</command>
<prompt>&gt; </prompt><command>sudo</command> <command>cp ssl/cacert.pem /etc/rmt/ssl/rmt-ca.crt</command></screen>
      </step>
      <step>
        <para>
          按<xref linkend="sec-rmt-installation-yast-configuration"/>中所述运行 YaST RMT 配置模块。如果您已导入 SMT CA 证书，请将 SMT 服务器的域添加到新 SSL 证书的常用名。
        </para>
      </step>
      <step>
        <para>
          运行 RMT 同步功能以从 SUSE Customer Center 获取产品和软件源数据。
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>rmt-cli sync</command></screen>
      </step>
      <step>
        <para>
          导入来自 SMT 服务器的数据。
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>rmt-data-import -d ./</command></screen>
      </step>
      <step>
        <para>
          可选：如果 RMT 服务器的 URL 发生变化，请在 <filename>/etc/SUSEConnect</filename> 中更改客户端的 URL 参数，以指向新的 RMT 服务器。或者更改 DNS 记录以重新指派 RMT 服务器的主机名。
        </para>
      </step>
      <step>
        <para>
          可选：将 SMT 中的镜像储存库数据转移到 RMT，并调整所复制数据的所有权。
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>cp -r /var/www/htdocs/repo/* /usr/share/rmt/public/repo/</command>
<prompt>&gt; </prompt><command>sudo</command> <command>chown -R _rmt:nginx /usr/share/rmt/public/repo</command></screen>
        <tip>
          <para>
            RMT 服务器上自定义软件源数据的储存路径与 SMT 上的储存路径不同。在 RMT 中，源服务器 URL 的目录结构将复制到顶级目录结构中
          </para>
<screen>http://download.opensuse.org/debug/distribution/leap/15.5/repo/oss </screen>
          <para>
            此 URL 在 RMT 服务器上的路径对应于
          </para>
<screen>/usr/share/rmt/public/repo/debug/distribution/leap/15.5/repo/oss</screen>
        </tip>
      </step>
      <step>
        <para>
          SMT 服务器上的自定义软件源默认已禁用。如果您要将其镜像到 RMT，请在镜像之前将其启用。
        </para>
        <substeps>
          <step>
            <para>
              通过运行以下命令检查有无自定义软件源：
            </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>rmt-cli repos custom list</command></screen>
            <para>
              该命令会显示所有自定义储存库的表。第一列包含每个储存库的 <literal>ID</literal>，<literal>Mirror?</literal> 列显示 <literal>false</literal>。
            </para>
          </step>
          <step>
            <para>
              通过运行以下命令启用您要镜像的每个自定义软件源：
            </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>rmt-cli repos custom enable <replaceable>ID</replaceable></command></screen>
          </step>
        </substeps>
      </step>
      <step>
        <para>
          通过启动镜像过程更新软件源中的软件包：
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>rmt-cli mirror</command></screen>
      </step>
    </procedure>
  </sect1>
</chapter>
