<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="deployment_image.xml" version="5.0" role="General" xml:id="cha-deployment-clone-image">
 <title>Clonage d'images de disque</title>
 <info>
  <abstract>
   <para>
    Ce chapitre décrit l'utilisation d'images clonées pour l'installation de <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>. Ce mode de fonctionnement est principalement utilisé dans les environnements virtualisés.
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>oui</dm:translation>
  </dm:docmanager>
 </info>
 <sect1 xml:id="sec-deployment-clone-image-overview">
  <title>Présentation</title>
  <para>
   <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> fournit un script pour nettoyer la configuration qui est unique pour chaque installation. Avec l'introduction de <systemitem class="daemon">systemd</systemitem>, des identificateurs système uniques sont utilisés et définis dans différents fichiers et à divers emplacements. Par conséquent, le clonage n'est plus la méthode recommandée pour créer des images système. Les images peuvent être créées avec KIWI : reportez-vous à l'adresse <link xlink:href="https://doc.suse.com/kiwi/"/>.
  </para>
  <para>
   Pour cloner des disques de machines, reportez-vous à la documentation de votre environnement de virtualisation.
  </para>
 </sect1>
 <sect1 xml:id="sec-deployment-clone-image-clean">
  <title>Nettoyage des identificateurs système uniques</title>
  <warning>
   <title>perte de configuration importante</title>
   <para>
    L'exécution de la procédure suivante supprime définitivement les données de configuration importantes du système. Si le système source pour le clone est utilisé en production, exécutez le script de nettoyage sur l'image clonée.
   </para>
  </warning>
  <para>
   Pour nettoyer tous les identificateurs système uniques, exécutez la procédure suivante avant ou après le clonage d'une image de disque. En cas d'exécution sur le clone, cette procédure doit être exécutée sur chaque clone. Par conséquent, nous vous recommandons de créer une <literal>image de référence</literal> qui n'est pas utilisée en production et sert uniquement de source pour les nouveaux clones. L'image de référence est déjà nettoyée et les clones peuvent être utilisés immédiatement.
  </para>
  <para>
   Par exemple, la commande <command>clone-master-clean-up</command> supprime :
  </para>
  <itemizedlist>
   <listitem>
    <para>Fichiers d'échange</para>
   </listitem>
   <listitem>
    <para>Dépôts Zypper</para>
   </listitem>
   <listitem>
    <para>Clés d'hôte et de client SSH</para>
   </listitem>
   <listitem>
    <para>Répertoires temporaires, tels que <filename>/tmp/*</filename></para>
   </listitem>
   <listitem>
    <para>Données postfix</para>
   </listitem>
   <listitem>
    <para>Script de pare-feu HANA</para>
   </listitem>
   <listitem>
    <para>Journal systemd</para>
   </listitem>
  </itemizedlist>
  <procedure>
   <step>
    <para>
     Utilisez <command>zypper</command> pour installer <package>clone-master-clean-up</package> :
    </para>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>zypper</command> install clone-master-clean-up</screen>
   </step>
   <step>
    <para>
     Configurez le comportement de <command>clone-master-clean-up</command> en modifiant <filename>/etc/sysconfig/clone-master-clean-up</filename>. Ce fichier de configuration définit si les utilisateurs avec un UID supérieur à 1 000, le fichier <filename>/etc/sudoers</filename>, les dépôts de logiciels pour l'installation des paquetages et les instantanés Btrfs doivent être supprimés.
    </para>
   </step>
   <step>
    <para>
     Supprimez la configuration existante et les identificateurs uniques en exécutant le script suivant :
    </para>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>clone-master-clean-up</command></screen>
   </step>
  </procedure>
 </sect1>
</chapter>
