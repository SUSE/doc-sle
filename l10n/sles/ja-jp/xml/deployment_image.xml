<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="deployment_image.xml" version="5.0" role="General" xml:id="cha-deployment-clone-image">
 <title>ディスクイメージのクローニング</title>
 <info>
  <abstract>
   <para>
    この章では、<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>のインストール時にクローニングされたイメージを使用する方法について説明します。このプロセスは仮想化環境で最も多く採用されています。
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <sect1 xml:id="sec-deployment-clone-image-overview">
  <title>概要</title>
  <para>
   <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>には、各インストール環境に固有の設定をクリーンアップするスクリプトが用意されています。<systemitem class="daemon">systemd</systemitem>の導入によって、固有のシステム識別子は別の場所や別のファイルで使用または設定されるようになりました。そのため、クローニングによるシステムイメージの作成は現在推奨されていません。イメージの作成はKIWIで行えます。<link xlink:href="https://doc.suse.com/kiwi/"/>を参照してください。
  </para>
  <para>
   複数のマシンのディスクをクローニングする方法については、ご使用の仮想化環境のドキュメントを参照してください。
  </para>
 </sect1>
 <sect1 xml:id="sec-deployment-clone-image-clean">
  <title>固有のシステム識別子のクリーンアップ</title>
  <warning>
   <title>重大な設定ロス</title>
   <para>
    次の手順を実行すると、重要なシステム設定データが永続的に削除されます。クローン元のシステムが運用されている場合は、クローニングされたイメージに対してクリーンアップスクリプトを実行してください。
   </para>
  </warning>
  <para>
   固有のシステム識別子をすべてクリーンアップするには、ディスクイメージのクローニング前とクローニング後に次の手順を実行します。この手順をクローンに対して実行する場合は、クローンごとに実行する必要があります。したがって、<literal>ゴールデンイメージ</literal>を作成しておくことをお勧めします。これは、新しいクローンのクローン元としてのみ使用される、運用されないイメージです。ゴールデンイメージはすでにクリーンアップされているため、それから作成したクローンはすぐに利用可能になります。
  </para>
  <para>
   たとえば、<command>clone-master-clean-up</command>コマンドを実行すると、次の内容が削除されます。
  </para>
  <itemizedlist>
   <listitem>
    <para>スワップファイル</para>
   </listitem>
   <listitem>
    <para>Zypperリポジトリ</para>
   </listitem>
   <listitem>
    <para>SSHホストとクライアントキー</para>
   </listitem>
   <listitem>
    <para><filename>/tmp/*</filename>などの一時ディレクトリ</para>
   </listitem>
   <listitem>
    <para>Postfixデータ</para>
   </listitem>
   <listitem>
    <para>HANAファイアウォールスクリプト</para>
   </listitem>
   <listitem>
    <para>systemdジャーナル</para>
   </listitem>
  </itemizedlist>
  <procedure>
   <step>
    <para>
     <command>zypper</command>を使用して <package>clone-master-clean-up</package>:
    </para>
    <screen><prompt>&gt; </prompt><command>sudo</command> <command>zypper</command> install clone-master-clean-up</screen>
   </step>
   <step>
    <para>
     <filename>/etc/sysconfig/clone-master-clean-up</filename>を編集し、<command>clone-master-clean-up</command>の動作を設定します。この環境設定ファイルには、1000より大きな数値のUIDを持つユーザ、<filename>/etc/sudoers</filename>ファイル、パッケージインストール用のソフトウェアリポジトリ、およびBtrfsスナップショットを削除するかどうかが定義されています。
    </para>
   </step>
   <step>
    <para>
     次のスクリプトを実行して、既存の設定と固有の識別子を削除します。
    </para>
    <screen><prompt>&gt; </prompt><command>sudo</command> <command>clone-master-clean-up</command></screen>
   </step>
  </procedure>
 </sect1>
</chapter>
