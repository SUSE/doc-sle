<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="vt_clocksettings.xml" version="5.0" xml:id="sec-kvm-managing-clock">
  <title>VM Guest 时钟设置</title>
  <info>
    <abstract>
      <para>
        在 VM Guest 中保持准确的时间是虚拟化的一项较为困难的工作。保持准确的时间对于网络应用程序特别重要，也是进行 VM Guest 实时迁移的先决条件。
      </para>
    </abstract>
    <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
      <dm:bugtracker/>
      <dm:translation>yes</dm:translation>
    </dm:docmanager>
  </info>
  <tip>
    <title>VM 主机服务器上的计时</title>
    <para>
      强烈建议在 VM 主机服务器上也保持准确的时间，例如，通过使用 NTP 来实现（有关详细信息，请参见<xref linkend="cha-ntp"/>）。
    </para>
  </tip>
  <sect1 xml:id="sec-kvm-managing-clock-kvm">
    <title>KVM：使用 <systemitem>kvm_clock</systemitem></title>

    <para>
      KVM 提供通过 <systemitem>kvm_clock</systemitem> 驱动程序支持的半虚拟化时钟。强烈建议使用 <systemitem>kvm_clock</systemitem>。
    </para>

    <para>
      在运行 Linux 的 VM Guest 中使用以下命令来检查是否已装载 <systemitem>kvm_clock</systemitem> 驱动程序：
    </para>

<screen><prompt>&gt; </prompt><command>sudo</command> dmesg | grep kvm-clock
[    0.000000] kvm-clock: cpu 0, msr 0:7d3a81, boot clock
[    0.000000] kvm-clock: cpu 0, msr 0:1206a81, primary cpu clock
[    0.012000] kvm-clock: cpu 1, msr 0:1306a81, secondary cpu clock
[    0.160082] Switching to clocksource kvm-clock</screen>

    <para>
      要检查当前使用了哪个时钟源，请在 VM Guest 中运行以下命令。此命令应输出 <literal>kvm-clock</literal>：
    </para>

<screen><prompt>&gt; </prompt>cat /sys/devices/system/clocksource/clocksource0/current_clocksource</screen>

    <important>
      <title><literal>kvm-clock</literal> 和 NTP</title>
      
      <para>
        使用 <literal>kvm-clock</literal> 时，建议同时在 VM Guest 中使用 NTP，并在 VM 主机服务器上也使用 NTP。
      </para>
    </important>

    <sect2 xml:id="sec-kvm-managing-clock-other">
      <title>其他计时方法</title>
      <para>
        半虚拟化 <literal>kvm-clock</literal> 目前不适用于 Windows* 操作系统。对于 Windows*，请使用 <literal>Windows Time
        Service Tools</literal> 进行时间同步。
      </para>
    </sect2>
  </sect1>
  <sect1 xml:id="sec-xen-guests-suse-time">
    <title>Xen 虚拟机时钟设置</title>

    <para>
      在 Xen 4 中，已去除用于在 Xen 主机与 Guest 之间进行时间同步的独立时钟设置 <filename>/proc/sys/xen/independent_wallclock</filename>。引入了新的配置选项 <option>tsc_mode</option>。此选项指定使用<emphasis>时戳计数器</emphasis>将 Guest 时间与 Xen 服务器同步的方法。其默认值 0 适合大多数硬件和软件环境。
    </para>

    <para>
      有关 <option>tsc_mode</option> 的更多细节，请参见 <literal>xen-tscmode</literal> 手册页 (<command>man 7
      xen-tscmode</command>)。
    </para>
  </sect1>
</chapter>
