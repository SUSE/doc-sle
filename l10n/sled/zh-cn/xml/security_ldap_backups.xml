<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="security_ldap_backups.xml" version="5.0" xml:id="sec-security-ldap-backup">
 <info>
  <title>备份和恢复 389 Directory Server</title>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <para>
  389 Directory Server 支持脱机和联机备份。<command>dsctl</command> 命令可创建脱机数据库备份，而 <command>dsconf</command> 命令可创建联机数据库备份。备份 LDAP 服务器配置目录，以便在发生重大故障时能够完全恢复。
 </para>

 <sect2 xml:id="sec-security-ldap-backup-config">
  <title>备份 LDAP 服务器配置</title>
  <para>
   LDAP 服务器配置位于 <filename>/etc/dirsrv/slapd-<replaceable>INSTANCE_NAME</replaceable></filename> 目录中。此目录包含证书、密钥和 <filename>dse.ldif</filename> 文件。使用 <command>tar</command> 命令创建此目录的压缩备份：
  </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>tar caf \</command>
<command>config_slapd-<replaceable>INSTANCE_NAME</replaceable>-$(date +%Y-%m-%d_%H-%M-%S).tar.gz \</command>
<command>/etc/dirsrv/slapd-<replaceable>INSTANCE_NAME</replaceable>/</command>
    </screen>
  <note role="compact">
   <title>可忽略的 tar 错误消息</title>
   <para>
    运行 <command>tar</command> 时，您可能会看到可忽略的信息性消息 <literal>tar: Removing leading `/' from member names</literal>。
   </para>
  </note>
  <para>
   要恢复以前的配置，请将其解压缩到同一目录：
  </para>
  <procedure>
   <step performance="optional">
    <para>
     要避免重写现有配置，请移动该配置：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>old /etc/dirsrv/slapd-<replaceable>INSTANCE_NAME</replaceable>/</command></screen>
   </step>
   <step>
    <para>
     解压缩备份存档：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>tar -xvzf</command> \
<command>config_slapd-<replaceable>INSTANCE_NAME-DATE</replaceable>.tar.gz</command></screen>
   </step>
   <step>
    <para>
     将其复制到 <filename>/etc/dirsrv/slapd-<replaceable>INSTANCE_NAME</replaceable></filename>：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>cp -r etc/dirsrv/slapd-<replaceable>INSTANCE_NAME</replaceable></command> \
<command>/etc/dirsrv/slapd-<replaceable>INSTANCE_NAME</replaceable></command></screen>
   </step>
  </procedure>
 </sect2>

 <sect2 xml:id="sec-security-ldap-offline-backup">
  <title>创建 LDAP 数据库的脱机备份并从中恢复</title>
  <para>
   <command>dsctl</command> 命令可创建脱机备份。关闭服务器:
  </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>dsctl <replaceable>INSTANCE_NAME</replaceable> stop</command>
Instance "<replaceable>INSTANCE_NAME</replaceable>" has been stopped</screen>
  <para>
   然后使用您的实例名称创建备份。以下示例在 <replaceable>/var/lib/dirsrv/slapd-INSTANCE_NAME/bak/INSTANCE_NAME-DATE</replaceable> 中创建备份存档：
  </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>dsctl <replaceable>INSTANCE_NAME</replaceable> db2bak</command>
db2bak successful</screen>
<para>
  例如，在名为 ldap1 的测试实例上，该命令如下所示：
</para>
<screen>
<filename>/var/lib/dirsrv/slapd-ldap1/bak/ldap1-2021_10_25_13_03_17</filename>
</screen>
  <para>
   从此备份进行恢复，并命名包含备份存档的目录：
  </para>
  <screen><prompt>&gt; </prompt><command>sudo</command> <command>dsctl <replaceable>INSTANCE_NAME</replaceable> bak2db</command> \
<command>/var/lib/dirsrv/slapd-<replaceable>INSTANCE_NAME</replaceable>/bak/<replaceable>INSTANCE_NAME-DATE</replaceable>/</command>
bak2db successful</screen>
  <para>
   然后启动服务器：
  </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>dsctl <replaceable>INSTANCE_NAME</replaceable> start</command>
Instance "INSTANCE_NAME" has been started</screen>
  <para>
   您还可以创建 LDIF 备份：
  </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>dsctl <replaceable>INSTANCE_NAME</replaceable> db2ldif --replication userRoot</command>
ldiffile: /var/lib/dirsrv/slapd-INSTANCE_NAME/ldif/INSTANCE_NAME-userRoot-DATE.ldif
db2ldif successful</screen>
  <para>
   使用存档名称恢复 LDIF 备份，然后启动服务器：
  </para>
  <screen><prompt>&gt; </prompt><command>sudo</command> <command>dsctl ldif2db userRoot</command> \
<command>/var/lib/dirsrv/slapd-<replaceable>INSTANCE_NAME</replaceable>/ldif/<replaceable>INSTANCE_NAME</replaceable>-userRoot-<replaceable>DATE</replaceable>.ldif</command>
<prompt>&gt; </prompt><command>sudo</command> <command>dsctl <replaceable>INSTANCE_NAME</replaceable> start</command></screen>
 </sect2>

 <sect2 xml:id="sec-security-ldap-online-backup">
  <title>创建 LDAP 数据库的联机备份并从中恢复</title>
  <para>
   使用 <command>dsconf</command> 创建 LDAP 数据库的联机备份：
  </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>dsconf <replaceable>INSTANCE_NAME</replaceable> backup create</command>
The backup create task has finished successfully</screen>
  <para>
   此命令会创建 <filename>/var/lib/dirsrv/slapd-<replaceable>INSTANCE_NAME</replaceable>/bak/<replaceable>INSTANCE_NAME-DATE</replaceable></filename>。
  </para>
  <para>
   恢复该数据库：
  </para>
  <screen><prompt>&gt; </prompt><command>sudo</command> <command>dsconf <replaceable>INSTANCE_NAME</replaceable> backup restore</command> \
<command>/var/lib/dirsrv/slapd-<replaceable>INSTANCE_NAME</replaceable>/bak/<replaceable>INSTANCE_NAME-DATE</replaceable></command></screen>
 </sect2>
</sect1>
