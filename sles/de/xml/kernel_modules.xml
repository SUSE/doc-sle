<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="kernel_modules.xml" version="5.0" xml:id="cha.mod">
 <title>Verwalten von Kernelmodulen</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>Ja</dm:translation>
  </dm:docmanager>
 </info>
 <para>
   Linux ist als monolithischer Kernel ausgelegt, kann jedoch mithilfe von Kernelmodulen erweitert werden. Diese besonderen Objekte lassen sich je nach Bedarf in den Kernel einfügen und wieder entfernen. Mit Kernelmodulen können also Treiber und Schnittstellen, die nicht im Kernel selbst enthalten sind, eingefügt und entfernt werden. Linux bietet einige Befehle zum Verwalten der Kernelmodule.
 </para>
 <sect1 xml:id="sec.mod.lsmod">
  <title>Auflisten der geladenen Module mit lsmod und modinfo</title>
  <para>
    Der Befehl <command>lsmod</command> zeigt die derzeit geladenen Kernelmodule. Dieser Befehl liefert beispielsweise die folgende Ausgabe:
  </para>
  <screen><prompt>tux &gt; </prompt> lsmod
Module                  Size  Used by
snd_usb_audio         188416  2 
snd_usbmidi_lib        36864  1 snd_usb_audio
hid_plantronics        16384  0 
snd_rawmidi            36864  1 snd_usbmidi_lib
snd_seq_device         16384  1 snd_rawmidi
fuse                  106496  3 
nfsv3                  45056  1 
nfs_acl                16384  1 nfsv3</screen>
  <para>
    Die Ausgabe ist in drei Spalten gegliedert. Die Spalte <literal>Modul</literal> enthält den Namen der geladenen Module, die Spalte <literal>Größe</literal> entsprechend die Größe der einzelnen Module. Aus der Spalte <literal>Verwendet von</literal> gehen die Anzahl und der Name der verweisenden Module hervor. Diese Liste ist unter Umständen nicht vollständig.
  </para>
  <para>
    Ausführliche Informationen zu einem bestimmten Kernelmodul erhalten Sie mit dem Befehl <command>modinfo <replaceable>MODULNAME</replaceable></command>, wobei <replaceable>MODULNAME</replaceable> für den Namen des gewünschten Kernelmoduls steht. Die <command>modinfo</command>-Binärdatei befindet sich im Verzeichnis <filename>/sbin</filename>, die nicht zur PATH-Umgebungsvariable des Benutzers gehört. Wenn Sie den Befehl <command>modinfo</command> als normaler Benutzer ausführen, müssen Sie daher den vollständigen Pfad zur Binärdatei angeben:
  </para>
  <screen>$ /sbin/modinfo kvm
filename:       /lib/modules/4.4.57-18.3-default/kernel/arch/x86/kvm/kvm.ko
license:        GPL
author:         Qumranet
srcversion:     BDFD8098BEEA517CB75959B
depends:        irqbypass
intree:         Y
vermagic:       4.4.57-18.3-default SMP mod_unload modversions 
signer:         openSUSE Secure Boot Signkey
sig_key:        03:32:FA:9C:BF:0D:88:BF:21:92:4B:0D:E8:2A:09:A5:4D:5D:EF:C8
sig_hashalgo:   sha256
parm:           ignore_msrs:bool
parm:           min_timer_period_us:uint
parm:           kvmclock_periodic_sync:bool
parm:           tsc_tolerance_ppm:uint
parm:           lapic_timer_advance_ns:uint
parm:           halt_poll_ns:uint
parm:           halt_poll_ns_grow:int
parm:           halt_poll_ns_shrink:int</screen>
  </sect1>
  <sect1 xml:id="sec.mod.modprobe">
    <title>Einfügen und Entfernen von Kernelmodulen</title>
    <para>
      Kernelmodule können durchaus mit den Befehlen <systemitem>insmod</systemitem> und <systemitem>rmmod</systemitem> eingefügt und entfernt werden; allerdings wird das Werkzeug<systemitem>modprobe</systemitem> empfohlen. <systemitem>modprobe</systemitem> bietet mehrere wichtige Vorteile, beispielsweise die automatische Auflösung von Abhängigkeiten und Einträge in schwarze Listen.
    </para>
    <para>
      Wenn Sie keine Parameter angeben, wird mit dem Befehl <systemitem>modprobe</systemitem> ein angegebenes Kernelmodul installiert. <systemitem>modprobe</systemitem> muss mit Root-Berechtigungen ausgeführt werden:
    </para>
    <screen><prompt>tux &gt; </prompt>sudo modprobe acpi</screen>
    <para>
      Zum Entfernen eines Kernelmoduls geben Sie den Parameter <command>-r</command> an:
    </para>
    <screen>sudo modprobe -r acpi</screen>
    <sect2 xml:id="sec.mod.modprobe.d">
    <title>Automatisches Laden von Kernelmodulen beim Booten</title>
    <para>
      Statt die Kernelmodule manuell zu laden, können Sie sie mit dem Dienst <systemitem>system-modules-load.service</systemitem> automatisch beim Booten laden lassen. Zum Aktivieren eines Kernelmoduls fügen Sie eine <filename>.conf</filename>-Datei in das Verzeichnis <filename>/etc/modules-load.d/</filename> ein. Die Konfigurationsdatei sollte dabei denselben Namen erhalten wie das Modul selbst, beispielsweise:</para>
    <screen>/etc/modules-load.d/rt2800usb.conf</screen>
    <para>
      Die Konfigurationsdatei muss den Namen des Kernelmoduls enthalten (z. B. <literal>rt2800usb</literal>).
    </para>
    <para>
      Mit dem beschriebenen Verfahren laden Sie Kernelmodule ohne Parameter. Falls Sie ein Kernelmodul mit bestimmten Optionen laden möchten, fügen Sie stattdessen eine Konfigurationsdatei in das Verzeichnis <filename>/etc/modprobe.d/</filename> ein. Die Datei muss die Dateinamenerweiterung <filename>.conf</filename> haben. Für den Dateinamen gilt die folgende Namenskonvention: <literal>priority-modulename.conf</literal>, beispielsweise <filename>50-thinkfan.conf</filename>. Die Konfigurationsdatei muss den Namen des Kernelmoduls und die gewünschten Parameter enthalten. Mit dem folgenden Beispielbefehl erstellen Sie eine Konfigurationsdatei mit dem Namen des Kernelmoduls und den zugehörigen Parametern:</para>
      <screen>echo "options thinkpad_acpi fan_control=1" | sudo tee /etc/modprobe.d/thinkfan.conf</screen>
      
      <note>
	<title>Laden der Kernelmodule</title>
	<para>
	  Die meisten Kernelmodule werden automatisch durch das System geladen, sobald ein Gerät erkannt wird oder ein Userspace bestimmte Funktionen angefordert. Sie müssen die Module daher nur in seltenen Fällen manuell in <filename>/etc/modules-load.d/</filename> aufnehmen.
	 </para>
	</note>
	
    </sect2>
    <sect2 xml:id="sec.mod.modprobe.blacklist">
    <title>Eintragen von Kernelmodulen in schwarze Listen mit modprobe</title>
    <para>
      Wenn ein Kernelmodul in eine schwarze Liste eingetragen wird, kann es beim Booten nicht mehr geladen werden. Dies ist von Nutzen, wenn Sie ein Modul deaktivieren möchten, das vermutlich Probleme auf dem System verursacht. Mit dem Werkzeug <systemitem>insmod</systemitem> oder <systemitem>modprobe</systemitem> können Sie Kernelmodule, die auf einer schwarzen Liste stehen, dennoch manuell laden.
    </para>
    <para>
      Zum Eintragen eines Moduls in eine schwarze Liste tragen Sie die Zeile <literal>blacklist <replaceable>MODULNAME</replaceable></literal> in die Datei <filename>/etc/modprobe.d/50-blacklist.conf</filename> ein. Beispiel:
    </para>
    <screen>blacklist nouveau</screen>
    <para>
      Erzeugen Sie mit dem Befehl <command>mkinitrd</command> (als root) ein neues <systemitem>initrd</systemitem>-Image und booten Sie den Computer neu. Diese Schritte können mit dem folgenden Befehl ausgeführt werden:
    </para>
    <screen>su
echo "blacklist nouveau" &gt;&gt; /etc/modprobe.d/50-blacklist.conf &amp;&amp; mkinitrd &amp;&amp; reboot</screen>
    <para>
      Soll ein Kernelmodul nicht dauerhaft deaktiviert werden, können Sie es direkt beim Booten in eine schwarze Liste eintragen. Drücken Sie hierzu im Bootbildschirm die Taste <keycap>E</keycap>. Sie gelangen zu einem minimalen Editor, in dem Sie die Bootparameter bearbeiten können. Wechseln Sie zur Zeile, die wie folgt aufgebaut ist:
    </para>
    <screen>linux /boot/vmlinuz...splash= silent quiet showopts</screen>
    <para>
      Hängen Sie den Befehl <command>modprobe.blacklist=<replaceable>MODULNAME</replaceable></command> an das Ende der Zeile an. Beispiel:
    </para>
    <screen>linux /boot/vmlinuz...splash= silent quiet showopts modprobe.blacklist=nouveau</screen>
    <para>
      Drücken Sie die Taste <keycap>F10</keycap> oder <keycombo><keycap function="control"/><keycap>X</keycap></keycombo>. Der Computer wird mit der angegebenen Konfiguration gebootet.
    </para>
    <para>
      Soll ein Kernelmodul dauerhaft über GRUB in eine Schwarze Liste eingetragen werden, öffnen Sie die Datei <filename>/etc/default/grub</filename> zum Bearbeiten und hängen Sie die Option <command>modprobe.blacklist=<replaceable>MODULNAME</replaceable></command> an den Befehl <command>GRUB_CMD_LINUX</command> an. Führen Sie dann den Befehl <command>sudo grub2-mkconfig -o /boot/grub2/grub.cfg</command> aus, damit die Änderungen in Kraft treten.
    </para>
    </sect2>
 </sect1>
</chapter>
