<?xml version="1.0" encoding="UTF-8"?>
<appendix xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="gpu_passthru.xml" version="5.0" xml:id="app-gpu-passthru">
  <info>
    <title>为 NVIDIA 卡配置 GPU 直通</title>
    <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
      <dm:translation>yes</dm:translation>
    </dm:docmanager>
  </info>
  <sect1 xml:id="gpu-passthru-intro">
    <title>简介</title>

    <para>
      本文介绍如何将主机计算机上的 NVIDIA GPU 显卡指派给虚拟化 Guest。
    </para>
  </sect1>
  <sect1 xml:id="gpu-passthru-prerequisites">
    <title>先决条件</title>

    <itemizedlist>
      <listitem>
        <para>
          只有 AMD64/Intel 64 体系结构支持 GPU 直通。
        </para>
      </listitem>
      <listitem>
        <para>
          主机操作系统需是 SLES 12 SP3 或更高版本。
        </para>
      </listitem>
      <listitem>
        <para>
          本文的内容涉及一组基于 V100/T1000 NVIDIA 卡的指令，仅与 GPU 计算相关。
        </para>
      </listitem>
      <listitem>
        <para>
          请校验您使用的是否为 NVIDIA Tesla 产品 — Maxwell、Pascal 或 Volta。
        </para>
      </listitem>
      <listitem>
        <para>
          要管理主机系统，您需要在主机上额外安装一块显卡，以便可以在配置 GPU 直通或 SSH 功能环境时使用它。
        </para>
      </listitem>
    </itemizedlist>
  </sect1>
  <sect1 xml:id="gpu-passthru-host">
    <title>配置主机</title>

    <sect2 xml:id="gpu-passthru-verify-host">
      <title>校验主机环境</title>
      <procedure>
        <step>
          <para>
            校验主机操作系统是否为 SLES 12 SP3 或更高版本：
          </para>
<screen>
<prompt>&gt; </prompt>cat /etc/issue
Welcome to SUSE Linux Enterprise Server 15  (x86_64) - Kernel \r (\l).
</screen>
        </step>
        <step>
          <para>
            校验主机是否支持 <xref linkend="gloss-vt-acronym-vtd"/> 技术，并且已在固件设置中启用该技术：
          </para>
<screen>
<prompt>&gt; </prompt>dmesg | grep -e "Directed I/O"
[   12.819760] DMAR: Intel(R) Virtualization Technology for Directed I/O
</screen>
          <para>
            如果未在固件中启用 VT-d，请启用它并重引导主机。
          </para>
        </step>
        <step>
          <para>
            校验主机是否有额外的 GPU 或 VGA 卡：
          </para>
<screen>
<prompt>&gt; </prompt>lspci | grep -i "vga"
07:00.0 VGA compatible controller: Matrox Electronics Systems Ltd. \
  MGA G200e [Pilot] ServerEngines (SEP1) (rev 05)
</screen>
          <para>
            对于 Tesla V100 卡：
          </para>
<screen>
<prompt>&gt; </prompt>lspci | grep -i nvidia
03:00.0 3D controller: NVIDIA Corporation GV100 [Tesla V100 PCIe] (rev a1)
</screen>
          <para>
            对于 T1000 Mobile（可在 Dell 5540 上使用）：
          </para>
<screen>
<prompt>&gt; </prompt>lspci | grep -i nvidia
01:00.0 3D controller: NVIDIA Corporation TU117GLM [Quadro T1000 Mobile] (rev a1)
</screen>
        </step>
      </procedure>
    </sect2>

    <sect2 xml:id="gpu-passthru-enable-iommu">
      <title>启用 <xref linkend="gloss-vt-acronym-iommu"/></title>
      <para>
        默认已禁用 <xref linkend="gloss-vt-acronym-iommu"/>。您需要在系统引导时于 <filename>/etc/default/grub</filename> 配置文件中启用它。
      </para>
      <procedure>
        <step>
          <para>
            对于基于 Intel 的主机：
          </para>
<screen>GRUB_CMDLINE_LINUX="intel_iommu=on iommu=pt rd.driver.pre=vfio-pci"</screen>
          <para>
            对于基于 AMD 的主机：
          </para>
<screen>GRUB_CMDLINE_LINUX="iommu=pt amd_iommu=on rd.driver.pre=vfio-pci"</screen>
        </step>
        <step>
          <para>
            保存修改后的 <filename>/etc/default/grub</filename> 文件时，请重新生成主 GRUB 2 配置文件 <filename>/boot/grub2/grub.cfg</filename>：
          </para>
<screen><prompt>&gt; </prompt><command>sudo</command> grub2-mkconfig -o /boot/grub2/grub.cfg</screen>
        </step>
        <step>
          <para>
            重引导主机并校验是否已启用 <xref linkend="gloss-vt-acronym-iommu"/>：
          </para>
<screen><prompt>&gt; </prompt>dmesg |  grep -e DMAR -e IOMMU</screen>
        </step>
      </procedure>
    </sect2>

    <sect2 xml:id="gpu-passthru-blacklist-nouveau">
      <title>将 Nouveau 驱动程序加入黑名单</title>
      <para>
        要将 NVIDIA 卡指派给 VM Guest，我们需要防止主机操作系统装载 NVIDIA GPU 的内置 <literal>nouveau</literal> 驱动程序。创建包含以下内容的 <filename>/etc/modprobe.d/60-blacklist-nouveau.conf</filename> 文件：
      </para>
<screen>blacklist nouveau</screen>
    </sect2>

    <sect2 xml:id="gpu-passthru-configure-vfio">
      <title>配置 <xref linkend="gloss-vt-acronym-vfio"/> 并隔离用于直通的 GPU</title>
      <procedure>
        <step>
          <para>
            查找卡供应商和型号 ID。使用<xref linkend="gpu-passthru-verify-host"/>中列出的总线编号（例如 <literal>03:00.0</literal>）进行查找：
          </para>
<screen>
<prompt>&gt; </prompt>lspci -nn | grep 03:00.0
03:00.0 3D controller [0302]: NVIDIA Corporation GV100 [Tesla V100 PCIe] [10de:1db4] (rev a1)
</screen>
        </step>
        <step>
          <para>
            创建包含以下内容的 <filename>/etc/modprobe.d/vfio.conf</filename> 文件：
          </para>
<screen>options vfio-pci ids=10de:1db4</screen>
          <note>
            <para>
              校验您的卡是否不需要额外的 <option>ids=</option> 参数。对于某些卡，还必须指定音频设备，因此还必须将该设备的 ID 添加到列表中，否则无法使用该卡。
            </para>
          </note>
        </step>
      </procedure>
    </sect2>

    <sect2 xml:id="gpu-passthru-load-vfio">
      <title>装载 <xref linkend="gloss-vt-acronym-vfio"/> 驱动程序</title>
      <para>
        可通过三种方式装载 <xref linkend="gloss-vt-acronym-vfio"/> 驱动程序。
      </para>
      <sect3 xml:id="gpu-passthru-load-vfio-initrd">
        <title>在 initrd 文件中包含该驱动程序</title>
        <procedure>
          <step>
            <para>
              创建 <filename>/etc/dracut.conf.d/gpu-passthrough.conf</filename> 文件并在其中添加以下内容（请注意前导空格）：
            </para>
<screen>add_drivers+=" vfio vfio_iommu_type1 vfio_pci vfio_virqfd"</screen>
          </step>
          <step>
            <para>
              重新生成 initrd 文件：
            </para>
<screen><prompt>&gt; </prompt><command>sudo</command> dracut --force /boot/initrd $(uname -r)</screen>
          </step>
        </procedure>
      </sect3>
      <sect3 xml:id="gpu-passthru-load-vfio-modules">
        <title>将该驱动程序添加到自动装载的模块的列表</title>
        <para>
          创建 <filename>/etc/modules-load.d/vfio-pci.conf</filename> 文件并在其中添加以下内容：
        </para>
<screen>
vfio
vfio_iommu_type1
vfio_pci
kvm
kvm_intel
</screen>
      </sect3>
      <sect3 xml:id="gpu-passthru-load-vfio-manual">
        <title>手动装载该驱动程序</title>
        <para>
          要在运行时手动装载该驱动程序，请执行以下命令：
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> modprobe vfio-pci</screen>
      </sect3>
    </sect2>

    <sect2 xml:id="gpu-passthru-disable-msr">
      <title>为 Microsoft Windows Guest 禁用 MSR</title>
      <para>
        对于 Microsoft Windows Guest，我们建议禁用 MSR（特定于模型的寄存器），以避免 Guest 崩溃。创建 <filename>/etc/modprobe.d/kvm.conf</filename> 文件并在其中添加以下内容：
      </para>
<screen>options kvm ignore_msrs=1</screen>
    </sect2>

    <sect2 xml:id="gpu-passthru-ovmf">
      <title>安装 UEFI 固件</title>
      <para>
        主机需使用 UEFI 固件进行引导（即，不使用旧式 BIOS 引导序列）才能使 GPU 直通功能正常工作。安装 <package>qemu-ovmf</package> 软件包（如果尚未安装）：
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> zypper install qemu-ovmf</screen>
    </sect2>

    <sect2 xml:id="gpu-passthru-reboot">
      <title>重引导主机计算机</title>
      <para>
        要使上述步骤中的大部分更改生效，需要重引导主机计算机：
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> shutdown -r now</screen>
    </sect2>
  </sect1>
  <sect1 xml:id="gpu-passthru-guest">
    <title>配置 Guest</title>

    <para>
      本节介绍如何配置 Guest 虚拟机，以使其能够使用主机的 NVIDIA GPU。使用虚拟机管理器或 <command>virt-install</command> 安装 Guest VM。有关详细信息，请参见<xref linkend="cha-kvm-inst"/>。
    </para>

    <sect2 xml:id="gpu-passthru-guest-general">
      <title>Guest 配置要求</title>
      <para>
        在安装 Guest VM 期间，选择<guimenu>在安装之前自定义配置</guimenu>并配置以下设备：
      </para>
      <itemizedlist>
        <listitem>
          <para>
            如果可能，请使用 Q35 芯片组。
          </para>
        </listitem>
        <listitem>
          <para>
            使用 UEFI 固件安装 Guest VM。
          </para>
        </listitem>
        <listitem>
          <para>
            添加以下模拟设备：
          </para>
          <para>
            图形：Spice 或 VNC
          </para>
          <para>
            设备：qxl、VGA 或 Virtio
          </para>
          <para>
            有关详细信息，请参见 <xref linkend="sec-libvirt-config-video"/>。
          </para>
        </listitem>
        <listitem>
          <para>
            将主机 PCI 设备（在本示例中为 <literal>03:00.0</literal>）添加到 Guest。有关详细信息，请参见 <xref linkend="sec-libvirt-config-pci"/>。
          </para>
        </listitem>
        <listitem>
          <para>
            为获得最佳性能，我们建议对网卡和存储设备使用 virtio 驱动程序。
          </para>
        </listitem>
      </itemizedlist>
    </sect2>

    <sect2 xml:id="gpu-passthru-guest-driver">
      <title>安装显卡驱动程序</title>
      <sect3 xml:id="gpu-passthru-guest-driver-linux-rpm">
        <title>Linux Guest</title>
        <procedure>
          <title>基于 RPM 的发行套件</title>
          <step>
            <para>
              从 <link xlink:href="http://www.nvidia.com/download/driverResults.aspx/131159/en-us"/> 下载驱动程序 RPM 软件包。
            </para>
          </step>
          <step>
            <para>
              安装下载的 RPM 软件包：
            </para>
<screen><prompt>&gt; </prompt><command>sudo</command> rpm -i nvidia-diag-driver-local-repo-sles123-390.30-1.0-1.x86_64.rpm</screen>
          </step>
          <step>
            <para>
              刷新软件源并安装 <package>cuda-drivers</package>.对于非 SUSE 发行套件，此步骤有所不同：
            </para>
<screen><prompt>&gt; </prompt><command>sudo</command> zypper refresh &amp;&amp; zypper install cuda-drivers</screen>
          </step>
          <step>
            <para>
              重引导 Guest VM：
            </para>
<screen><prompt>&gt; </prompt><command>sudo</command> shutdown -r now</screen>
          </step>
        </procedure>
        <procedure>
          <title>通用安装程序</title>
          <step>
            <para>
              由于安装程序需要编译 NVIDIA 驱动程序模块，因此请安装 <package>gcc-c++</package> 和 <package>kernel-devel</package> 软件包。
            </para>
          </step>
          <step>
            <para>
              在 Guest 上禁用安全引导，因为 NVIDIA 的驱动程序模块未签名。在 SUSE 发行套件上，可以使用 YaST GRUB 2 模块来禁用安全引导。有关详细信息，请参见 <xref linkend="sec-uefi-secboot-sle"/>。
            </para>
          </step>
          <step>
            <para>
              从 <link xlink:href="https://www.nvidia.com/Download/index.aspx?lang=en-us"/> 下载驱动程序安装脚本，将此脚本转换为可执行文件，然后运行此可执行文件以完成驱动程序安装：
            </para>
<screen>
<prompt>&gt; </prompt>chmod +x NVIDIA-Linux-x86_64-460.73.01.run
<prompt>&gt; </prompt><command>sudo</command> ./NVIDIA-Linux-x86_64-460.73.01.run
</screen>
          </step>
          <step>
            <para>
              从 <link xlink:href="https://developer.nvidia.com/cuda-downloads?target_os=Linux&amp;target_arch=x86_64&amp;target_distro=SLES&amp;target_version=15&amp;target_type=rpmlocal"/> 下载 CUDA 驱动程序，并按照屏幕上的说明进行安装。
            </para>
          </step>
        </procedure>
        <note>
          <title>显示器问题</title>
          <para>
            安装 NVIDIA 驱动程序后，虚拟机管理器显示器将与 Guest 操作系统断开连接。要访问 Guest VM，您必须通过 <command>ssh</command> 登录，然后切换到控制台界面，或者在 Guest 中安装专用 VNC 服务器。为避免屏幕闪烁，请停止并禁用显示器管理器：
          </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl stop display-manager &amp;&amp; systemctl disable display-manager</screen>
        </note>
        <procedure>
          <title>测试 Linux 驱动程序安装</title>
          <step>
            <para>
              将目录切换到 CUDA 示例模板：
            </para>
<screen><prompt>&gt; </prompt>cd /usr/local/cuda-9.1/samples/0_Simple/simpleTemplates</screen>
          </step>
          <step>
            <para>
              编译并运行 <literal>simpleTemplates</literal> 文件：
            </para>
<screen>
<prompt>&gt; </prompt>make &amp;&amp; ./simpleTemplates
runTest&lt;float,32&gt;
GPU Device 0: "Tesla V100-PCIE-16GB" with compute capability 7.0
CUDA device [Tesla V100-PCIE-16GB] has 80 Multi-Processors
Processing time: 495.006000 (ms)
Compare OK
runTest&lt;int,64&gt;
GPU Device 0: "Tesla V100-PCIE-16GB" with compute capability 7.0
CUDA device [Tesla V100-PCIE-16GB] has 80 Multi-Processors
Processing time: 0.203000 (ms)
Compare OK
[simpleTemplates] -&gt; Test Results: 0 Failures
</screen>
          </step>
        </procedure>
      </sect3>
      <sect3 xml:id="gpu-passthru-guest-driver-windows">
        <title>Microsoft Windows Guest</title>
        <important>
          <para>
            在安装 NVIDIA 驱动程序之前，需要使用 Guest <systemitem class="library">libvirt</systemitem> 定义中的 <literal>&lt;hidden
            state='on'/&gt;</literal> 指令对驱动程序隐藏超级管理程序，例如：
          </para>
<screen>
&lt;features&gt;
 &lt;acpi/&gt;
 &lt;apic/&gt;
 &lt;kvm&gt;
  &lt;hidden state='on'/&gt;
 &lt;/kvm&gt;
&lt;/features&gt;
</screen>
        </important>
        <procedure>
          <step>
            <para>
              从 <link xlink:href="https://www.nvidia.com/Download/index.aspx"/> 下载并安装 NVIDIA 驱动程序。
            </para>
          </step>
          <step>
            <para>
              从 <link xlink:href="https://developer.nvidia.com/cuda-downloads?target_os=Windows&amp;target_arch=x86_64"/> 下载并安装 CUDA 工具包。
            </para>
          </step>
          <step>
            <para>
              在 Guest 上的 <filename>Program Files\Nvidia GPU Computing
              Toolkit\CUDA\v10.2\extras\demo_suite</filename> 目录中可以找到多个 NVIDIA 演示示例。
            </para>
          </step>
        </procedure>
      </sect3>
    </sect2>
  </sect1>
</appendix>
