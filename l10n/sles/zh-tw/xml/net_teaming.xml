<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_teaming.xml" version="5.1" xml:id="sec-network-iface-teaming">
 <title>設定用於網路組合的組合裝置</title>

 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>

 <remark>toms 2016-06-16: FATE#320468</remark>

 <para>
  <quote>連結彙總</quote>一詞是描述結合 (或聚合) 網路連接以提供邏輯層的一般性詞彙。有時，您會看到<quote>通道組合</quote>、<quote>乙太網路結合</quote>、<quote>連接埠截斷</quote>等詞彙，它們是同義詞，指的是同一個概念。
 </para>

 <para>
  這一概念便是廣為人知的<quote>結合</quote>，並且最初整合於 Linux 核心之內 (請參閱<xref linkend="sec-network-iface-bonding"/>瞭解其原始實作)。<emphasis>網路組合</emphasis>一詞指的是這一概念的新型實作。
 </para>

 <para>
  結合與網路組合的主要不同之處在於，組合提供的是一組小型核心模組，它們負責為 teamd 例項提供介面。其餘所有操作都在使用者空間內處理。這與原始的結合實作不同，原始的結合實作單獨在其核心內包含了其所有功能。如需兩者的比較，請參閱<xref linkend="tab-team-comparison"/>。
 </para>

 <table xml:id="tab-team-comparison">
  <title>結合與組合的功能比較</title>
  <tgroup cols="3">
   <colspec colname="c1"/>
   <colspec colname="c2"/>
   <colspec colname="c3"/>
   <thead>
    <row>
     <entry>特性</entry>
     <entry>結合</entry>
     <entry>組合</entry>
    </row>
   </thead>
   <tbody>
    <row>
     <entry>廣播、輪替 TX 規則</entry>
     <entry>是</entry>
     <entry>是</entry>
    </row>
    <row>
     <entry>使用中備份 TX 規則</entry>
     <entry>是</entry>
     <entry>是</entry>
    </row>
    <row>
     <entry>LACP (802.3ad) 支援</entry>
     <entry>是</entry>
     <entry>是</entry>
    </row>
    <row>
     <entry>以雜湊為基礎的 TX 規則</entry>
     <entry>是</entry>
     <entry>是</entry>
    </row>
    <row>
     <entry>使用者可以設定雜湊函數</entry>
     <entry>否</entry>
     <entry>是</entry>
    </row>
    <row>
     <entry>TX 負載平衡支援 (TLB)</entry>
     <entry>是</entry>
     <entry>是</entry>
    </row>
    <row>
     <entry>針對 LACP 的 TX 負載平衡支援</entry>
     <entry>否</entry>
     <entry>是</entry>
    </row>
    <row>
     <entry>Ethtool 連結監控</entry>
     <entry>是</entry>
     <entry>是</entry>
    </row>
    <row>
     <entry>ARP 連結監控</entry>
     <entry>是</entry>
     <entry>是</entry>
    </row>
    <row>
     <entry>NS/NA (IPV6) 連結監控</entry>
     <entry>否</entry>
     <entry>是</entry>
    </row>
    <row>
     <entry>針對 TX/RX 路徑的 RCU 鎖定</entry>
     <entry>否</entry>
     <entry>是</entry>
    </row>
    <row>
     <entry>連接埠優先程度和粘性</entry>
     <entry>否</entry>
     <entry>是</entry>
    </row>
    <row>
     <entry>單獨的依連接埠連結監控設定</entry>
     <entry>否</entry>
     <entry>是</entry>
    </row>
    <row>
     <entry>多連結監控設定</entry>
     <entry>受限制</entry>
     <entry>是</entry>
    </row>
    <row>
     <entry>VLAN 支援</entry>
     <entry>是</entry>
     <entry>是</entry>
    </row>
    <row>
     <entry>多裝置堆疊</entry>
     <entry>是</entry>
     <entry>是</entry>
    </row>
    <row>
     <entry namest="c1" nameend="c3">來源：<link xlink:href="http://libteam.org/files/teamdev.pp.pdf"/></entry>
    </row>
   </tbody>
  </tgroup>
 </table>

 <para>
  結合與網路組合兩種實作可以同時使用。網路組合是現有結合實作的一個備用方案。它不會取代結合。
 </para>

 <para>
  網路組合可用於多種用途。下文中將介紹兩種最重要的用途，分別是：
 </para>

 <itemizedlist>
  <listitem>
   <para>
    實現不同網路裝置之間的負載平衡。
   </para>
  </listitem>
  <listitem>
   <para>
    當其中一個網路裝置出現故障時，容錯移轉至另一個裝置。
   </para>
  </listitem>
 </itemizedlist>

 <para>
  <remark>toms 2016-06-21: FATE#320947 for Teaming in/with YaST</remark>
  目前還沒有支援建立組合裝置的 YaST 模組。您需要手動設定網路組合。一般程序如下所示，該程序適用於所有網路組合組態：
 </para>

 <procedure xml:id="pro-team-general">
  <title>一般程序</title>
  <step>
   <para>
    確定您已安裝所有必要的套件。安裝 <package>libteam-tools</package>、<package>libteamdctl0</package> 和 <package>python-libteam</package> 套件。
   </para>
  </step>
  <step>
   <para>
    在 <filename>/etc/sysconfig/network/</filename> 下建立組態檔案。通常將是 <filename>ifcfg-team0</filename>。如果需要多部網路組合裝置，請為它們加上數字並依次遞增。
   </para>
   <para>
    此組態檔案包含一些變數，在 man 頁面中有相關說明 (請參閱 <command>man ifcfg</command> 和 <command>man ifcfg-team</command>)。系統內的 <filename>/etc/sysconfig/network/ifcfg.template</filename> 檔案中提供了範例組態。
   </para>
  </step>
  <step>
   <para>
    移除將用於組合裝置的介面的組態檔案 (通常為 <filename>ifcfg-eth0</filename> 和 <filename>ifcfg-eth1</filename>)。
   </para>
   <para>
    建議製做一個備份並移除兩個檔案。Wicked 將重新建立這些組態檔案，並收入適用於組合的必要參數。
   </para>
  </step>
  <step>
   <para>
    (選擇性) 檢查 Wicked 組態檔案中是否已包含所需的一切內容。
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>wicked show-config</command></screen>
  </step>
  <step>
   <para>
    啟動網路組合裝置 <systemitem class="service">team0</systemitem>：
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>wicked ifup all team0</command></screen>
   <para>
    如需其他除錯資訊，請在 <command>all</command> 子指令之後使用 <option>--debug all</option> 選項。
   </para>
  </step>
  <step>
   <para>
    檢查網路組合裝置的狀態。此動作可藉由下列指令來完成：
   </para>
   <itemizedlist>
    <listitem>
     <para>
      從 Wicked 取得 teamd 實例的狀態：
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>wicked ifstatus --verbose team0</command></screen>
    </listitem>
    <listitem>
     <para>
      取得整個實例的狀態：
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>teamdctl team0 state</command></screen>
    </listitem>
    <listitem>
     <para>
      取得 teamd 實例的 systemd 狀態：
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>systemctl status teamd@team0</command></screen>
    </listitem>
   </itemizedlist>
   <para>
    三者顯示的視圖依您的需求而定，略有不同。
   </para>
  </step>
  <step>
   <para>
    如果日後需要變更 <filename>ifcfg-team0</filename> 檔案中的內容，請使用以下指令重新載入其組態：
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>wicked ifreload team0</command></screen>
  </step>
 </procedure>

 <para>
  <emphasis>不要</emphasis>使用 <command>systemctl</command> 來啟動或停止組合裝置！而應使用 <command>wicked</command> 指令，如上所述。
 </para>

 <para>
  若要徹底移除組合裝置，請執行以下程序：
 </para>
 <procedure>
  <title>移除組合裝置</title>
  <step>
   <para>
    停止網路組合裝置 <systemitem class="service">team0</systemitem>：
   </para>
   <screen><prompt>&gt; </prompt><command>sudo</command> <command>wicked ifdown team0</command></screen>
  </step>
  <step>
   <para>
    將檔案 <filename>/etc/sysconfig/network/ifcfg-team0</filename> 重新命名為 <filename>/etc/sysconfig/network/.ifcfg-team0</filename>。在檔案名稱前面插入一個點，以使 wicked<quote>看不到</quote>它。如果您確實不再需要該組態，也可以移除該檔案。
   </para>
  </step>
  <step>
   <para>重新載入組態：</para>
   <screen><prompt>&gt; </prompt><command>sudo</command> <command>wicked ifreload all</command></screen>
  </step>
 </procedure>

 <sect2 xml:id="sec-network-iface-teaming-lb">
  <title>使用案例：網路組合的負載平衡</title>
  <para>
   負載平衡用於提升頻寬。使用下面的組態檔案可建立具有負載平衡能力的網路組合裝置。繼續執行<xref linkend="pro-team-general"/>中的步驟以設定裝置。透過 <command>teamdctl</command> 檢查輸出。
  </para>
  <example xml:id="ex-team-lb">
   <title>網路組合的負載平衡組態</title>
<screen>STARTMODE=auto <co xml:id="co-team-lb-startmode"/>
BOOTPROTO=static <co xml:id="co-team-lb-boot-and-ip"/>
IPADDRESS="192.168.1.1/24" <xref linkend="co-team-lb-boot-and-ip"/>
IPADDR6="fd00:deca:fbad:50::1/64" <xref linkend="co-team-lb-boot-and-ip"/>

TEAM_RUNNER="loadbalance" <co xml:id="co-team-lb-loadbalance"/>
TEAM_LB_TX_HASH="ipv4,ipv6,eth,vlan"
TEAM_LB_TX_BALANCER_NAME="basic"
TEAM_LB_TX_BALANCER_INTERVAL="100"

TEAM_PORT_DEVICE_0="eth0" <co xml:id="co-team-lb-dev"/>
TEAM_PORT_DEVICE_1="eth1" <xref linkend="co-team-lb-dev"/>

TEAM_LW_NAME="ethtool" <co xml:id="co-team-lb-name"/>
TEAM_LW_ETHTOOL_DELAY_UP="10" <co xml:id="co-team-lb-ethtool-delay"/>
TEAM_LW_ETHTOOL_DELAY_DOWN="10" <xref linkend="co-team-lb-ethtool-delay"/></screen>

   <calloutlist>
    <callout arearefs="co-team-lb-startmode">
     <para>
      控制組合裝置的啟動。<literal>auto</literal> 值表示介面會在網路服務可用時設定，並在每次重新開機時自動啟動。
     </para>
     <para>
      如果您需要自行控制裝置 (並防止其自動啟動)，請將 <varname>STARTMODE</varname> 設定為 <literal>manual</literal>。
     </para>
    </callout>
    <callout arearefs="co-team-lb-boot-and-ip">
     <para>
      設定靜態 IP 位址 (此處對於 IPv4 指定 <systemitem class="ipaddress">192.168.1.1</systemitem>，對於 IPv6 指定 <systemitem class="ipaddress">fd00:deca:fbad:50::1</systemitem>)。
     </para>
     <para>
      如果網路組合裝置應該使用動態 IP 位址，請設定 <literal>BOOTPROTO=&quot;dhcp&quot;</literal>，並移除包含 <varname>IPADDRESS</varname> 和 <varname>IPADDR6</varname> 的行或將其設為備註。
     </para>
    </callout>
    <callout arearefs="co-team-lb-loadbalance">
     <para>
      將 <varname>TEAM_RUNNER</varname> 設定為 <literal>loadbalance</literal> 以啟用負載平衡模式。
     </para>
    </callout>
    <callout arearefs="co-team-lb-dev">
     <para>
      指定應聚合以建立網路組合裝置的一或多部裝置。
     </para>
    </callout>
    <callout arearefs="co-team-lb-name">
     <para>
      定義連結監控器以監控從屬裝置的狀態。使用預設值 <literal>ethtool</literal> 只會檢查裝置是否已啟動並可存取，因此檢查速度很快。但它不會檢查裝置是否可以真正地傳送或接收封包。
     </para>
     <para>
      如果您需要進一步確信連接的可用性，請使用 <literal>arp_ping</literal> 選項。這樣會向任意主機傳送 ping (在 <varname>TEAM_LW_ARP_PING_TARGET_HOST</varname> 變數中設定)。僅當接收到回覆時，才會將網路組合裝置視為正常執行。
     </para>
    </callout>
    <callout arearefs="co-team-lb-ethtool-delay">
     <para>
      以毫秒為單位定義連結建立 (或斷開) 與執行器收到通知之間的延遲。
     </para>
    </callout>
   </calloutlist>
  </example>
 </sect2>

 <sect2 xml:id="sec-network-iface-teaming-failover">
  <title>使用案例：使用網路組合實現容錯移轉</title>
  <para>
   容錯移轉引入了一個平行的備份網路裝置，用於確保關鍵網路組合裝置的高可用性。備份網路裝置將全天候執行，並在主要裝置出現故障時接管其工作。
  </para>
  <para>
   使用以下組態檔案可以建立具有容錯移轉功能的網路組合裝置。繼續執行<xref linkend="pro-team-general"/>中的步驟以設定裝置。透過 <command>teamdctl</command> 檢查輸出。
  </para>
  <example xml:id="ex-team-failover">
   <title>DHCP 網路組合裝置的組態</title>
<screen>STARTMODE=auto <co xml:id="co-team-failover-startmode"/>
BOOTPROTO=static <co xml:id="co-team-failover-boot-and-ip"/>
IPADDR="192.168.1.2/24" <xref linkend="co-team-failover-boot-and-ip"/>
IPADDR6="fd00:deca:fbad:50::2/64" <xref linkend="co-team-failover-boot-and-ip"/>

TEAM_RUNNER=activebackup <co xml:id="co-team-failover-activebackup"/>
TEAM_PORT_DEVICE_0="eth0" <co xml:id="co-team-failover-dev"/>
TEAM_PORT_DEVICE_1="eth1" <xref linkend="co-team-failover-dev"/>

TEAM_LW_NAME=ethtool <co xml:id="co-team-failover-name"/>
TEAM_LW_ETHTOOL_DELAY_UP="10" <co xml:id="co-team-failover-ethtool-delay"/>
TEAM_LW_ETHTOOL_DELAY_DOWN="10" <xref linkend="co-team-failover-ethtool-delay"/></screen>
   <calloutlist>
    <callout arearefs="co-team-failover-startmode">
     <para>
      控制組合裝置的啟動。<literal>auto</literal> 一值表示將在網路服務可用時設定介面，並且會在每次重新開機時自動啟動介面。
     </para>
     <para>
      如果您需要自行控制裝置 (並防止其自動啟動)，請將 <varname>STARTMODE</varname> 設定為 <literal>manual</literal>。
     </para>
    </callout>
    <callout arearefs="co-team-failover-boot-and-ip">
     <para>
      設定靜態 IP 位址 (此處對於 IPv4 指定 <systemitem class="ipaddress">192.168.1.2</systemitem>，對於 IPv6 指定 <systemitem class="ipaddress">fd00:deca:fbad:50::2</systemitem>)。
     </para>
     <para>
      如果網路組合裝置應該使用動態 IP 位址，請設定 <literal>BOOTPROTO=&quot;dhcp&quot;</literal>，並移除包含 <varname>IPADDRESS</varname> 和 <varname>IPADDR6</varname> 的行或將其設為備註。
     </para>
    </callout>
    <callout arearefs="co-team-failover-activebackup">
     <para>
      將 <varname>TEAM_RUNNER</varname> 設定為 <literal>activebackup</literal> 以啟用容錯移轉模式。
     </para>
    </callout>
    <callout arearefs="co-team-failover-dev">
     <para>
      指定應聚合以建立網路組合裝置的一或多部裝置。
     </para>
    </callout>
    <callout arearefs="co-team-failover-name">
     <para>
      定義連結監控器以監控從屬裝置的狀態。使用預設值 <literal>ethtool</literal> 只會檢查裝置是否已啟動並可存取，因此檢查速度很快。但它不會檢查裝置是否可以真正地傳送或接收封包。
     </para>
     <para>
      如果您需要進一步確信連接的可用性，請使用 <literal>arp_ping</literal> 選項。這樣會向任意主機傳送 ping (在 <varname>TEAM_LW_ARP_PING_TARGET_HOST</varname> 變數中設定)。只有在收到回覆後，才視為網路組合裝置已啟動。
     </para>
    </callout>
    <callout arearefs="co-team-failover-ethtool-delay">
     <para>
      以毫秒為單位定義連結建立 (或斷開) 與執行器收到通知之間的延遲。
     </para>
    </callout>
   </calloutlist>
  </example>
 </sect2>

 <sect2 xml:id="sec-network-iface-teaming-vlan">
  <title>使用案例：組合裝置上的 VLAN</title>
  
  <para>
   VLAN 是<emphasis>虛擬區域網路</emphasis> (Virtual Local Area Network) 的縮寫。它允許在單個實體乙太網路上執行多個<emphasis>邏輯</emphasis> (虛擬) 乙太網路。會在邏輯上將網路分割成不同的廣播網域，以便封包只可在為同一 VLAN 指定的連接埠之間進行交換。
  </para>
  <para>
   下面的使用案例會在組合裝置的基礎上建立兩個靜態 VLAN：
  </para>
  <itemizedlist>
   <listitem>
     <para><systemitem class="other" otherclass="device">vlan0</systemitem>，結合到 IP 位址 <systemitem class="ipaddress">192.168.10.1</systemitem></para>
   </listitem>
   <listitem>
     <para><systemitem class="other" otherclass="device">vlan1</systemitem>，結合到 IP 位址 <systemitem class="ipaddress">192.168.20.1</systemitem></para>
   </listitem>
  </itemizedlist>

  <para>請執行下列步驟：</para>
  <procedure>
   <step>
    <para>
     在交換器上啟用 VLAN 標記。若要針對組合裝置使用負載平衡，交換器需要支援<emphasis>連結聚合控制通訊協定</emphasis> (LACP) (802.3ad)。如需詳細資料，請參閱硬體手冊。
    </para>
   </step>
   
   <step>
    <para>
     確定是否要針對組合裝置使用負載平衡或容錯移轉。依<xref linkend="sec-network-iface-teaming-lb"/>或<xref linkend="sec-network-iface-teaming-failover"/>所述設定組合裝置。
    </para>
   </step>
   <step>
    <para>
     在 <filename>/etc/sysconfig/network</filename> 中，建立包含以下內容的 <filename>ifcfg-vlan0</filename> 檔案：
    </para>
    <screen>STARTMODE="auto"
BOOTPROTO="static" <co xml:id="co-team-vlan-bootproto"/>
IPADDR='192.168.10.1/24' <co xml:id="co-team-vlan-ipaddr"/>
ETHERDEVICE="team0" <co xml:id="co-team-vlan-etherdevice"/>
VLAN_ID="0" <co xml:id="co-team-vlan-vlan-id"/>
VLAN='yes'</screen>
    <calloutlist>
     <callout arearefs="co-team-vlan-bootproto">
      <para>
       定義固定的 IP 位址 (在 <varname>IPADDR</varname> 中指定)。
      </para>
     </callout>
     <callout arearefs="co-team-vlan-ipaddr">
      <para>
       定義 IP 位址，此處包含其網路遮罩。
      </para>
     </callout>
     <callout arearefs="co-team-vlan-etherdevice">
      <para>
       包含要用於 VLAN 介面的實際介面，此處是我們的組合裝置 (<systemitem>team0</systemitem>)。
      </para>
     </callout>
     <callout arearefs="co-team-vlan-vlan-id">
      <para>
       為 VLAN 指定唯一的 ID。檔案名稱和 <varname>VLAN_ID</varname> 最好與名稱 <filename>ifcfg-vlan<replaceable>VLAN_ID</replaceable></filename> 對應。在本範例中，<varname>VLAN_ID</varname> 為 <literal>0</literal>，因而檔案名稱為 <filename>ifcfg-vlan0</filename>。
      </para>
     </callout>
     
    </calloutlist>
   </step>
   <step>
    <para>
     將 <filename>/etc/sysconfig/network/ifcfg-vlan0</filename> 檔案複製到 <filename>/etc/sysconfig/network/ifcfg-vlan1</filename>，並變更以下值：
    </para>
    <itemizedlist>
     <listitem>
      <para>
       從 <systemitem class="ipaddress">192.168.10.1/24</systemitem> 到 <systemitem class="ipaddress">192.168.20.1/24</systemitem> 的 <varname>IPADDR</varname>。</para>
     </listitem>
     <listitem>
      <para>
       從 <literal>0</literal> 到 <literal>1</literal> 的 <varname>VLAN_ID</varname>。
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     啟動兩個 VLAN：
    </para>
    <screen><prompt role="root"># </prompt><command>wicked</command> ifup vlan0 vlan1</screen>
   </step>
   <step>
    <para>
     檢查 <command>ifconfig</command> 的輸出：
    </para>
    <screen><prompt role="root"># </prompt><command>ifconfig</command> -a
[...]
vlan0     Link encap:Ethernet  HWaddr 08:00:27:DC:43:98
          inet addr:192.168.10.1 Bcast:192.168.10.255 Mask:255.255.255.0
          inet6 addr: fe80::a00:27ff:fedc:4398/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:12 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:0 (0.0 b)  TX bytes:816 (816.0 b)

vlan1     Link encap:Ethernet  HWaddr 08:00:27:DC:43:98
          inet addr:192.168.20.1 Bcast:192.168.20.255 Mask:255.255.255.0
          inet6 addr: fe80::a00:27ff:fedc:4398/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:12 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:0 (0.0 b)  TX bytes:816 (816.0 b)</screen>
   </step>
   
  </procedure>
 </sect2>
</sect1>
