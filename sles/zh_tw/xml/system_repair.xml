<?xml version="1.0" encoding="UTF-8"?>
<sect2 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="system_repair.xml" version="5.0" xml:id="sec.trouble.data.recover.rescue">
 <title>使用救援系統</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info><indexterm>
 <primary>救援系統</primary></indexterm><indexterm>
 <primary>系統</primary>
 <secondary>救援</secondary></indexterm>
 <para>
  系統無法啟動並正常運作的原因可能有幾種。最常見的原因是系統當機後檔案系統損毀、組態檔案損毀，或開機載入程式組態損毀。
 </para>
 <para>
  為了幫助您解決這些狀況，<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 包含可以開機的救援系統。救援系統是一個小型的 Linux 系統，可以載入到 RAM 磁碟上並裝載為根目錄檔案系統，好讓您從外部存取 Linux 分割區。藉由此救援系統，您可以復原或修改任何重要的系統項目。
 </para>
 <itemizedlist mark="bullet" spacing="normal">
  <listitem>
   <para>
    操作任何類型的組態檔案。
   </para>
  </listitem>
  <listitem>
   <para>
    檢查檔案系統有無缺失並啟動自動修復程序。
   </para>
  </listitem>
  <listitem>
   <para>
    在<quote>變更根目錄</quote>環境中存取已安裝的系統.
   </para>
  </listitem>
  <listitem>
   <para>
    檢查、修改和重新安裝開機載入程式組態。
   </para>
  </listitem>
  <listitem>
   <para>
    從錯誤安裝的裝置驅動程式或無法使用的核心復原。
   </para>
  </listitem>
  <listitem>
   <para>
    使用 Parted 指令來調整分割區大小。如需此工具的詳細資訊，請造訪 GNU Parted 網站 <link xlink:href="http://www.gnu.org/software/parted/parted.html"/>。
   </para>
  </listitem>
 </itemizedlist>
 <para>
  救援系統可以從各種來源與位置載入。最簡單的方法就是從原始安裝媒體將救援系統開機。
 </para>
 <note os="sles" arch="zseries">
  <title>在 IBM z Systems 上啟動救援系統</title>
  <para>
   在 IBM z Systems 上，安裝系統可用於救援目的。若要啟動救援系統，請遵照<xref linkend="sec.zseries.rescue"/>中的指示。
  </para>
 </note>
 <procedure><indexterm>
  <primary>救援系統</primary>
  <secondary> 從媒體啟動</secondary></indexterm>
  <step>
   <para>
    將安裝媒體插入 DVD 光碟機。
   </para>
  </step>
  <step>
   <para>
    重新啟動系統。
   </para>
  </step>
  <step>
   <para>
    在開機畫面中按 <keycap>F4</keycap>，然後選擇<guimenu>DVD-ROM</guimenu>。之後從主功能表中選擇<guimenu>救援系統</guimenu>。
   </para>
  </step>
  <step>
   <para>
    在 <literal>Rescue:</literal> 提示輸入 <literal>root</literal>。無須輸入密碼。
   </para>
  </step>
 </procedure>
 <procedure xml:id="proc.trouble.data.recover.rescue.network"><indexterm>
  <primary> 救援系統</primary>
  <secondary> 從網路來源啟動</secondary></indexterm> 
  <para>
   如果硬體設定沒有包含 DVD 光碟機，您可以從網路來源將救援系統開機。以下範例適用於遠端開機案例 — 如果使用其他開機媒體 (例如 DVD)，請相應修改 <filename>info</filename> 檔案，並按照一般安裝方式開機。
  </para>
  <step>
   <para>
    輸入 PXE 開機設定的組態，然後新增下列行︰<literal>install=<replaceable>protocol</replaceable>://<replaceable>instsource</replaceable></literal> 和 <literal>rescue=1</literal>。如果需要啟動系統修復，請使用 <literal>repair=1</literal>。正如一般安裝的情況，<replaceable>protocol</replaceable> 代表任何支援的網路通訊協定 (NFS、HTTP、FTP 等等)，而 <replaceable>instsource</replaceable> 代表網路安裝來源的路徑。
   </para>
  </step>
  <step>
   <para>
    依照<xref linkend="sec.deployment.prep_boot.wol"/> 中的說明，使用<quote>網路喚醒</quote><phrase os="sles;sled">啟動系統。</phrase>
   </para>
  </step>
  <step>
   <para>
    在 <literal>Rescue:</literal> 提示輸入 <literal>root</literal>。無須輸入密碼。
   </para>
  </step>
 </procedure>
 <para>
  一旦進入救援系統後，您可以利用 <keycombo><keycap function="alt"/><keycap>F1</keycap></keycombo> 至 <keycombo><keycap function="alt"/><keycap>F6</keycap></keycombo> 來使用虛擬主控台。
 </para>
 <para>
  <filename>/bin</filename> 目錄中提供外圍程序以及其他許多有用的公用程式，例如 mount 程式。<filename>/sbin</filename> 目錄中包含重要的檔案與網路公用程式，以便檢視及修復檔案系統。此目錄中也有最重要的二進位系統維護程式，例如 <command>fdisk</command>、<command>mkfs</command>、<command>mkswap</command>、<command>mount</command> 和 <command>shutdown</command>，以及維護網路的 <command>ip</command> 和 <command>ss</command>。目錄 <filename>/usr/bin</filename> 包含 vi 編輯器、find、less 和 SSH。
 </para>
 <para>
  若要檢視系統訊息，請使用指令 <command>dmesg</command>，或者使用 <command>journalctl</command> 來檢視系統記錄。
 </para>
 <sect3 xml:id="sec.trouble.data.recover.rescue.file">
  <title>檢查和操作組態檔案</title>
  <para>
   為了舉例說明使用救援系統如何修正組態檔案，請想像系統由於組態檔案損毀而無法正常開機。您可以使用救援系統來解決這個問題。
  </para>
  <procedure>
   <para>
    若要操作組態檔案，請執行下列步驟︰
   </para>
   <step>
    <para>
     使用上述的其中一個方法啟動救援系統。
    </para>
   </step>
   <step>
    <para>
     若要將 <filename>/dev/sda6</filename> 下的開機檔案系統裝載到救援系統，請使用下列指令︰
    </para>
<screen>mount /dev/sda6 /mnt</screen>
    <para>
     系統的所有目錄現在都存放在 <filename>/mnt</filename> 中
    </para>
   </step>
   <step>
    <para>
     將此目錄變更到裝載的開機檔案系統中︰
    </para>
<screen>cd /mnt</screen>
   </step>
   <step>
    <para>
     在 vi 編輯器中開啟有問題的組態檔案。調整並儲存設定。
    </para>
   </step>
   <step>
    <para>
     從救援系統解除裝載開機檔案系統︰
    </para>
<screen>umount /mnt</screen>
   </step>
   <step>
    <para>
     重新開機。
    </para>
   </step>
  </procedure>
 </sect3>
 <sect3 xml:id="sec.trouble.data.recover.rescue.filesystem">
  <title>修復和檢查檔案系統</title><indexterm>
  <primary> 檔案系統</primary>
  <secondary> 修復</secondary></indexterm> 
  <para>
   一般而言，檔案系統無法在執行中的系統上修復。如果發生了嚴重的問題，您可能甚至無法裝載開機檔案，而且系統可能會因為<quote>核心異常</quote>而無法開機。在此情況下，唯一的方法就是從外部修復系統。系統包含的公用程式可檢查和修復 <literal>btrfs</literal>、<literal>ext2</literal>、<literal>ext3</literal>、<literal>ext4</literal>、<literal>reiserfs</literal>、<literal>xfs</literal>、<literal>dosfs</literal> 以及 <literal>vfat</literal> 檔案系統。尋找指令 <command>fsck.</command> <replaceable>檔案系統</replaceable>，例如，如果您需要某個檔案系統，請檢查 <literal>btrfs</literal>，使用 <command>fsck.btrfs</command>。
  </para>

 </sect3>
 <sect3 xml:id="sec.trouble.data.recover.rescue.access">
  <title>存取已安裝的系統</title>
  <para>
   如果需要從救援系統存取已安裝的系統，您需要在<emphasis>變更根目錄</emphasis>環境中執行此操作。例如，若要修改開機載入程式組態或執行硬體組態公用程式。
  </para>
  <para>
   若要根據已安裝的系統設定變更根目錄環境，請執行下列步驟︰
  </para>
  <procedure>
   <step>
    <para>
     執行 <command>lsblk</command> 以檢查哪個節點對應於根分割區。在本例中，該節點為 <filename>/dev/sda2</filename>︰
    </para>
<screen>lsblk
NAME        MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT
sda           8:0    0 149,1G  0 disk
├─sda1        8:1    0     2G  0 part  [SWAP]
├─sda2        8:2    0    20G  0 part  /
└─sda3        8:3    0   127G  0 part
  └─cr_home 254:0    0   127G  0 crypt /home</screen>
   </step>
   <step>
    <para>
     從安裝的系統掛接根分割區︰
    </para>
<screen>mount /dev/sda2 /mnt</screen>
   </step>
   <step>
    <para>
     掛接 <filename>/proc</filename>、<filename>/dev</filename> 和 <filename>/sys</filename> 分割區︰
    </para>
<screen>mount -t proc none /mnt/proc
mount --rbind /dev /mnt/dev
mount --rbind /sys /mnt/sys</screen>
   </step>
   <step>
    <para>
     現在可以<quote>變更根分割區</quote>為新的環境，並保留 <systemitem>bash</systemitem> 外圍程序︰
    </para>
<screen>chroot /mnt /bin/bash</screen>
   </step>
   <step>
    <para>
     最後，從已安裝的系統裝載其餘分割區︰
    </para>
<screen>mount -a</screen>
   </step>
   <step>
    <para>
     現在您可以存取已安裝的系統。重新啟動系統之前，請先使用 <command>umount </command> <option>-a</option> 來解除裝載分割區，並以 <quote>exit</quote> 離開<command>變更根</command>目錄環境。
    </para>
   </step>
  </procedure>
  <warning>
   <title>限制</title>
   <para>
    雖然您可以完全存取已安裝系統的檔案和應用程式，但必須遵守某些限制。執行中的核心是使用救援系統啟動的核心，而不是使用變更根目錄環境啟動的核心。它只支援基本硬體，而且無法從已安裝系統新增核心模組，除非核心版本完全一致。一律使用 <command>uname -r</command> 檢查目前執行的 (救援) 核心，然後確定變更根目錄環境的 <filename>/lib/modules</filename> 目錄中是否有相符的子目錄。如果有，您便可以使用已安裝的模組，否則，需要在其他媒體 (例如快閃磁碟機) 上提供模組的正確版本。多數情況下，救援核心版本與已安裝的版本並不相同，因此，舉例來說，您便不能像平常一樣存取聲卡。您也無法啟動圖形使用者介面。
   </para>
   <para>
    另外請注意，當您使用 <quote>F1</quote> 至 <keycombo><keycap function="alt"/><keycap>F6</keycap></keycombo> 來切換主控台時，將會離開<keycombo><keycap function="alt"/><keycap>變更根</keycap></keycombo>目錄環境。
   </para>
  </warning>
 </sect3>
 <sect3 xml:id="sec.trouble.data.recover.rescue.grub">
  <title>修改和重新安裝開機載入程式</title>
  <para>
   有時候系統無法開機是因為開機載入程式組態已損毀。譬如說，開機載入程式若未執行，啟動常式便無法將實體磁碟機轉譯為 Linux 檔案系統中的實際位置。
  </para>
  <para>
   若要檢查開機載入程式組態和重新安裝開機載入程式，請執行下列步驟︰
  </para>
  <procedure>
   <step>
    <para>
     執行存取已安裝系統所需的必要步驟，如 <xref linkend="sec.trouble.data.recover.rescue.access"/> 所述。
    </para>
   </step>
   <step>
    <para>
     檢查系統上是否已安裝 GRUB 2 開機載入程式。如果未安裝，請安裝 <systemitem>grub2</systemitem> 套件並執行
    </para>
<screen>grub2-install /dev/sda</screen>
   </step>
   <step>
    <para>
     根據<xref linkend="cha.grub2"/>中概述的 GRUB 2 組態原則，檢查下列檔案是否正確設定，並在必要時加以修正。
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       <filename>/etc/default/grub</filename>
      </para>
     </listitem>
     <listitem>
      <para>
       <filename>/boot/grub2/device.map</filename> (選用檔案，手動建立後才存在)
      </para>
     </listitem>
     <listitem>
      <para>
       <filename>/boot/grub2/grub.cfg</filename> (此檔案是產生的，不要編輯)
      </para>
     </listitem>
     <listitem>
      <para>
       <filename>/etc/sysconfig/bootloader</filename>
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     依序使用下列指令來重新安裝開機載入程式︰
    </para>
<screen>grub2-mkconfig -o /boot/grub2/grub.cfg</screen>
   </step>
   <step>
    <para>
     解除裝載分割區，從<quote>變更根目錄</quote>環境登出，並重新啟動系統︰
    </para>
<screen>umount -a
exit
reboot</screen>
   </step>
  </procedure>
 </sect3>
 <sect3 xml:id="sec.trouble.data.recover.rescue.dud">
  <title>修正核心安裝</title>
  <para>
   核心更新可能會帶來新的錯誤，進而會影響系統作業。例如，系統中某個硬體的驅動程式可能有錯誤，致使您無法存取和使用系統。在這種情況下，請復原至上回正常運作的核心 (如果系統中提供的話)，或者從安裝媒體安裝原始核心。
  </para>
  <tip>
   <title>如何在更新後保留之前的核心</title>
   <para>
    為了防止在錯誤的核心更新後無法開機，請使用核心多版本功能，並告知 <systemitem>libzypp</systemitem> 您要在更新後保留哪些核心。
   </para>
   <para>
    例如，若要永遠保留最後兩個核心和目前執行中的核心，請新增
   </para>
<screen>multiversion.kernels = latest,latest-1,running</screen>
   <para>
    至 <filename>/etc/zypp/zypp.conf</filename> 檔案。如需相關資訊，請參閱<xref linkend="cha.tuning.multikernel"/>。
   </para>
  </tip>
  <para>
   另一個類似的情況是，當您需要重新安裝或更新 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 不支援之裝置的已損毀驅動程式時。例如，當硬體廠商使用特定裝置時，比如使用硬體 RAID 控制器，這就要求作業系統能夠識別二進位驅動程式。廠商一般會發行「驅動程式更新磁碟」(DUD)，內含所需驅動程式的修復或更新版本。
  </para>
  <para>
   在這兩種情況下，您都需要以救援模式存取安裝的系統，並修正與核心相關的問題，否則系統可能無法正常開機︰
  </para>
  <procedure>
   <step>
    <para>
     從 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 安裝媒體開機。
    </para>
   </step>
   <step>
    <para>
     如果您要在錯誤的核心更新之後復原，請跳過此步驟。如果需要使用驅動程式更新磁碟 (DUD)，請在開機功能表出現之後按 <keycap>F6</keycap> 以載入驅動程式更新，並選擇驅動程式更新的路徑或 URL，然後按一下<guimenu>是</guimenu>確認。
    </para>
   </step>
   <step>
    <para>
     從開機功能表中選擇<guimenu>救援系統</guimenu>，然後按 <keycap function="enter"/>。如果您之前選擇使用 DUD，系統將會要求您指定儲存驅動程式更新的位置。
    </para>
   </step>
   <step>
    <para>
     在 <literal>Rescue:</literal> 提示輸入 <literal>root</literal>。無須輸入密碼。
    </para>
   </step>
   <step>
    <para>
     手動將目標系統和<quote>變更根目錄</quote>掛接至新環境︰如需詳細資訊，請參閱<xref linkend="sec.trouble.data.recover.rescue.access"/>。
    </para>
   </step>
   <step>
    <para>
     如果使用 DUD，請安裝/重新安裝/更新錯誤的裝置驅動程式套件。請務必確定已安裝的核心版本與要安裝的驅動程式版本完全相符。
    </para>
    <para>
     如果要修正錯誤的核心更新安裝，可以按照以下程序從安裝媒體安裝原始核心。
    </para>
    <substeps performance="required">
     <step>
      <para>
       使用 <command>hwinfo --cdrom</command> 識別 DVD 裝置，並使用 <command>mount /dev/sr0 /mnt</command> 掛接裝置。
      </para>
     </step>
     <step>
      <para>
       導覽到 DVD 上儲存核心檔案的目錄，例如 <command>cd /mnt/suse/x86_64/</command>。
      </para>
     </step>
     <step>
      <para>
       使用 <command>rpm -i</command> 指令安裝您的產品類別所需的 <systemitem>kernel-*</systemitem>、<systemitem>kernel-*-base</systemitem> 以及 <systemitem>kernel-*-extra</systemitem> 套件。
      </para>
     </step>

    </substeps>
   </step>
   <step>
    <para>
     根據需要更新組態檔，然後重新啟動開機載入程式。如需詳細資訊，請參閱<xref linkend="sec.trouble.data.recover.rescue.grub"/>。
    </para>
   </step>
   <step>
    <para>
     從系統磁碟機中取出任何可開機的媒體，然後重新開機。
    </para>
   </step>
  </procedure>
 </sect3>
</sect2>
