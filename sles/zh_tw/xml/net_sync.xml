<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_sync.xml" version="5.0" xml:id="cha.net.sync">
 <title>使用 RSync 複製檔案</title>
 <info>
  <abstract>
   <para>
    現在，許多人都使用多台電腦 — 家裡一台、辦公室一台或數台，出門在外還使用筆記型電腦、平板電腦或智慧型手機。許多檔案都需要各存一份在所有這些電腦上。因此，您必須能夠在所有電腦上工作和修改檔案，以便讓所有電腦都擁有最新版本的資料。
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>

 
 <warning>
  <title>資料遺失的風險</title>
  <para>
   開始使用同步工具之前，應該先熟悉其特性和功能。請務必備份您的重要檔案。
  </para>
 </warning>

 <sect1 xml:id="sec.net.sync.rsync">
  <title>概念綜覽</title>
  <para>
    對於要透過慢速網路連接同步大量資料的情況，Rsync 提供了可靠的方法來僅傳輸檔案中的變更。此方法不僅適用於文字檔案，還適用於二進位檔案。為了偵測檔案之間的差異，Rsync 將檔案分為多個區塊，並計算它們的檢查總數。
   </para>
   <para>
    偵測變更對運算能力有一定的要求。因此，請確認兩端的機器均具有足夠的資源，包括 RAM。
   </para>
  <para>
   當需要定期傳輸大量僅包含微小變更的資料時，Rsync 特別實用。進行備份時就常常用到該工具。Rsync 也非常適合用於鏡像臨時伺服器，此類伺服器將 Web 伺服器的完整目錄樹儲存到 DMZ 內的某部 Web 伺服器中。
  </para>
  <para>
   Rsync 並不是同步工具，雖然它的名字看上去有些像。Rsync 工具一次只能在一個方向複製資料。它不會也不能反向複製資料。如果您需要既能同步來源又能同步目標的雙向工具，請使用 Csync。
  </para>
  
 </sect1>

  <sect1 xml:id="sec.net.sync.rsync.syntax">
   <title>基本語法</title>
   <para>
    Rsync 是一個指令行工具，基本語法如下︰
   </para>
   <screen>rsync [OPTION] SOURCE [SOURCE]... DEST</screen>
   <para>
    您可以在任何本地或遠端機器上使用 Rsync，前提是您擁有相應的存取權限和寫入許可權。可以有多個 <replaceable>SOURCE</replaceable> 項目。<replaceable>SOURCE</replaceable> 和 <replaceable>DEST</replaceable> 預留位置可以是路徑和/或 URL。
   </para>
   <para>
    下面介紹一些最常用的 Rsync 選項︰
   </para>
   <variablelist>
    <varlistentry>
     <term><option>-v</option></term>
     <listitem>
      <para> 輸出較詳細的文字</para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>-a</option></term>
     <listitem>
      <para> 歸檔模式；以遞迴方式複製檔案並保留時間戳記、使用者/群組擁有權、檔案許可權和符號連結。 </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>-z</option></term>
     <listitem>
      <para>壓縮傳輸的資料</para>
     </listitem>
    </varlistentry>
   </variablelist>
   <note>
    <title>結尾斜線計數</title>
    <para>
     使用 Rsync 時，應特別注意結尾斜線。目錄後面的結尾斜線表示目錄的<emphasis>內容</emphasis>。沒有結尾斜線表示<emphasis>目錄自身</emphasis>。
   </para>
   </note>
  </sect1>

  <sect1 xml:id="sec.net.sync.rsync.copy.local.files-and-dirs">
   <title>在本地複製檔案和目錄</title>
   <para>
    下面的描述假設目前的使用者擁有 <filename>/var/backup</filename> 目錄的寫入許可權。若要將單個檔案從機器上的一個目錄複製到另一個路徑，請使用以下指令︰ </para>
   <screen><prompt>tux &gt; </prompt><command>rsync</command> -avz backup.tar.xz /var/backup/</screen>
   <para>檔案 <filename>backup.tar.xz</filename> 會複製到 <filename>/var/backup/</filename>，絕對路徑是 <filename>/var/backup/backup.tar.xz</filename>。</para>
   <para>
    請勿忘記在 <filename>/var/backup/</filename> 目錄後面加上<emphasis>結尾斜線</emphasis>！如果不插入斜線，檔案 <filename>backup.tar.xz</filename> 會複製到 <filename>/var/backup</filename> (檔案) 中，而<emphasis>不是</emphasis> <filename>/var/backup/</filename> 目錄中！
   </para>
   <para>
    複製目錄與複製單個檔案相似。下面的範例將目錄 <filename>tux/</filename> 及其內容複製到 <filename>/var/backup/</filename> 目錄中︰ </para>
    <screen><prompt>tux &gt; </prompt><command>rsync</command> -avz tux /var/backup/</screen>
    <para> 在絕對路徑 <filename>/var/backup/tux/</filename> 中可找到副本。 </para>
  </sect1>

  <sect1 xml:id="sec.net.sync.rsync.copy.remote.files-and-dirs">
   <title>從遠端複製檔案和目錄</title>
   <para>
    兩部機器上都需要有 Rsync 工具。若要從遠端目錄複製檔案或將檔案複製到遠端目錄，需要提供 IP 位址或網域名稱。如果本地機器和遠端機器上目前的使用者名稱相同，則使用者名稱為選用項。
   </para>
   <para> 若要使用相同的使用者 (在本地和遠端主機上) 將檔案 <filename>file.tar.xz</filename> 從本地主機複製到遠端主機 <systemitem class="ipaddress">192.168.1.1</systemitem>，請使用以下指令︰
   </para>
   <screen><prompt>tux &gt; </prompt><command>rsync</command> -avz file.tar.xz  tux@192.168.1.1:</screen>
    <para> 依據您的個人偏好，也可以使用下面的指令，它們的作用相同︰ </para>
   <screen><prompt>tux &gt; </prompt><command>rsync</command> -avz file.tar.xz 192.168.1.1:~
<prompt>tux &gt; </prompt><command>rsync</command> -avz file.tar.xz 192.168.1.1:/home/tux</screen>
    <para> 在所有使用標準組態的情況下，系統會提示您輸入遠端使用者的密碼片語。此指令會將 <filename>file.tar.xz</filename> 複製到使用者 <systemitem class="username">tux</systemitem> 的主目錄 (通常為 <filename>/home/tux</filename>)。
    </para>
   <para>
    從遠端複製目錄與在本地複製目錄相似。下面的範例將目錄 <filename>tux/</filename> 及其內容複製到 <systemitem class="ipaddress">192.168.1.1</systemitem> 主機上的遠端目錄 <filename>/var/backup/</filename>︰
   </para>
   <screen><prompt>tux &gt; </prompt><command>rsync</command> -avz tux 192.168.1.1:/var/backup/</screen>
   <para>
    假設您在主機 <systemitem class="ipaddress">192.168.1.1</systemitem> 上擁有寫入許可權，便可在絕對路徑 <filename>/var/backup/tux</filename> 中找到副本。
   </para>
  </sect1>

  <sect1 xml:id="sec.net.sync.rsync.server">
   <title>設定和使用 Rsync 伺服器</title>
   <para>
    Rsync 可當成在用於內送連接的預設連接埠 873 上列出的精靈 (<systemitem class="daemon">rsyncd</systemitem>) 執行。此精靈可以接收<quote>複製目標</quote>。
   </para>
   <para>
    下面的描述介紹如何在 <systemitem>jupiter</systemitem> 上建立具有<emphasis>備份</emphasis>目標的 Rsync 伺服器。此目標可用於儲存您的備份。若要建立 Rsync 伺服器，請執行以下操作︰
   </para>
   <procedure>
    <title>設定 Rsync 伺服器</title>
    <step xml:id="st.rsync.server.mkdir">
     <para>
      在 jupiter 上，建立用於儲存您所有備份檔案的目錄。在此範例中，我們使用 <filename>/var/backup</filename>︰
     </para>
     <screen><prompt role="root">root # </prompt><command>mkdir</command> /var/backup</screen>
    </step>
    <step>
     <para>指定擁有權。在此範例中，該目錄為<systemitem class="groupname">使用者</systemitem>群組中的使用者 <systemitem class="username">tux</systemitem> 所擁有︰</para>
     <screen><prompt role="root">root # </prompt><command>chown</command> tux.users /var/backup</screen>
    </step>
    <step>
     <para>設定 rsyncd 精靈。</para>
     <para>我們將組態檔案分割成一個主檔案和一些用於存放您的備份目標的<quote>模組</quote>。如此，以後便可更輕鬆地新增其他目標。全域值可以儲存在 <filename>/etc/rsyncd.d/*.inc</filename> 檔案中，而模組放置在 <filename> etc/rsyncd.d/*.conf</filename> 檔案中︰ </para>
     <substeps>
      <step>
       <para>建立目錄 <filename>/etc/rsyncd.d/</filename>︰</para>
       <screen><prompt role="root">root # </prompt><command>mkdir</command> /etc/rsyncd.d/</screen>
      </step>
      <step>
       <para>
        在主組態檔案 <filename>/etc/rsyncd.conf</filename> 中，新增以下幾行︰
       </para>
       <screen># rsyncd.conf main configuration file
log file = /var/log/rsync.log
pid file = /var/lock/rsync.lock

&amp;merge /etc/rsyncd.d <co xml:id="co.rsync.conf.merge"/>
&amp;include /etc/rsyncd.d <co xml:id="co.rsync.conf.include"/></screen>
       <calloutlist>
        <callout arearefs="co.rsync.conf.merge">
         <para> 將 <filename>/etc/rsyncd.d/*.inc</filename> 檔案中的全域值合併到主組態檔案中。 </para>
        </callout>
        <callout arearefs="co.rsync.conf.include">
         <para> 從 <filename>/etc/rsyncd.d/*.conf</filename> 檔案中載入任何模組 (或目標)。這些檔案不應包含任何對全域值的參考。 </para>
        </callout>
       </calloutlist>
      </step>
      <step>
       <para> 在檔案 <filename>/etc/rsyncd.d/backup.conf</filename> 中透過以下幾行建立您的模組 (您的備份目標)︰ </para>
       <screen># backup.conf: backup module
[backup] <co xml:id="co.rsync.conf.target"/>
   uid = tux <co xml:id="co.rsync.conf.uid-gid"/>
   gid = users <xref linkend="co.rsync.conf.uid-gid"/>
   path = /var/backup <co xml:id="co.rsync.conf.path"/>
   auth users = tux  <co xml:id="co.rsync.conf.authusers"/>
   secrets file = /etc/rsyncd.secrets <co xml:id="co.rsync.conf.secretfiles"/>
   comment = Our backup target</screen>
       <calloutlist>
        
        
        <callout arearefs="co.rsync.conf.target">
         <para>
          <emphasis>備份</emphasis>目標。可以使用您喜歡的任何名稱。但最好依照目標的用途來命名，並使用在 <filename>*.conf</filename> 檔案中所用的相同名稱。
         </para>
        </callout>
        <callout arearefs="co.rsync.conf.uid-gid">
         <para>
          指定在進行檔案傳輸時所用的使用者名稱或群組名稱。
         </para>
        </callout>
        <callout arearefs="co.rsync.conf.path">
         <para>
          定義用於儲存備份的路徑 (從<xref linkend="st.rsync.server.mkdir"/> 中)。
         </para>
        </callout>
        <callout arearefs="co.rsync.conf.authusers">
         <para>
          指定所允許使用者的逗號分隔清單。清單以最簡單的方式包含允許連接到此模組的使用者名稱。在我們的範例中，只允許使用者 <systemitem class="username">tux</systemitem>。
         </para>
        </callout>
        <callout arearefs="co.rsync.conf.secretfiles">
         <para>
          指定包含使用者名稱和明文密碼的行所在檔案的路徑。
         </para>
        </callout>
       </calloutlist>
      </step>
      <step>
       <para>
        建立包含以下內容的 <filename>/etc/rsyncd.secrets</filename> 檔案，並取代 <replaceable>PASSPHRASE</replaceable>︰
       </para>
       <screen># user:passwd
tux:<replaceable>PASSPHRASE</replaceable></screen>
      </step>
      <step>
       <para>
        確認該檔案只有 <systemitem class="username">root</systemitem> 使用者可讀取︰
       </para>
       <screen><prompt role="root">root # </prompt><command>chmod</command> 0600 /etc/rsyncd.secrets</screen>
      </step>
     </substeps>

     
    </step>
    <step>
     <para>
      透過以下指令啟動並啟用 rsyncd 精靈︰
     </para>
     <screen><prompt role="root">root # </prompt><command>systemctl</command> enable rsyncd
<prompt role="root">root # </prompt><command>systemctl</command> start rsyncd</screen>
     
    </step>
    <step>
     <para>
      測試是否可存取 Rsync 伺服器︰
     </para>
     <screen><prompt>tux &gt; </prompt><command>rsync</command> jupiter::</screen>
     <para>
      您會看到類似如下的回應︰
     </para>
     <screen>backup          Our backup target</screen>
     <para>若非如此，請檢查您的組態檔案、防火牆和網路設定。</para>
    </step>
   </procedure>
   <para>
    上述步驟建立了 Rsync 伺服器，現在可以使用它來儲存備份。本範例也建立了傾聽所有連接的記錄檔。這個檔案是儲存在 <filename>/var/log/rsyncd.log</filename>。如果您要對傳輸進行除錯，此檔案非常實用。
   </para>
   <para>
    若要列出備份目標的內容，請使用以下指令︰
   </para>
<screen>rsync -avz jupiter::backup</screen>
   <para>
    此指令會列出伺服器上 <filename>/var/backup</filename> 目錄中存在的所有檔案。這個要求也會記錄在 <filename>/var/log/rsyncd.log</filename> 記錄檔中。若要開始實際傳輸，請提供來源目錄。請使用 <literal>. </literal> 來代表目前的目錄。例如，下面的指令會將目前的目錄複製到 Rsync 備份伺服器︰
   </para>
   <screen>rsync -avz . jupiter::backup</screen>
   <para>
    依預設，Rsync 不會在執行時刪除檔案和目錄。若要允許刪除，必須另外指定選項 <option>--delete</option>。若要確保不會刪除較新的檔案，則可以改用 <option>--update</option> 選項。任何產生的衝突都必須手動解決。
   </para>
  </sect1>

 <sect1 xml:id="sec.net.sync.summary">
  <title>更多資訊</title>
  <variablelist>
   <varlistentry>
    <term>CSync</term>
    <listitem>
     <para>雙向檔案同步器，請參閱 <link xlink:href="https://www.csync.org/"/>。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>RSnapshot</term>
    <listitem>
     <para>建立增量備份，請參閱 <link xlink:href="http://rsnapshot.org"/>。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Unison</term>
    <listitem>
     <para>它是一個檔案同步器，與 CSync 類似，但具有圖形介面，請參閱 <link xlink:href="http://www.seas.upenn.edu/~bcpierce/unison/"/>。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Rear</term>
    <listitem>
     <para>一個災難備援架構，請參閱 <link xlink:href="https://www.suse.com/documentation/sle-ha-12/"/> 上 SUSE Linux Enterprise High Availability Extension 的《<citetitle>管理指南</citetitle>》。</para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
</chapter>
