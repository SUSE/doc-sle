<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="storage_multipath.xml" version="5.0" xml:id="cha.multipath" xml:lang="zh-tw">
 <title>管理裝置的多重路徑 I/O</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <para>
  本章描述如何透過使用多重路徑 I/O (MPIO) 管理伺服器和區塊儲存裝置間多重路徑的容錯移轉和路徑負載平衡。
 </para>
 <sect1 xml:id="sec.multipath.intro">
  <title>瞭解多重路徑 I/O</title>

  <para>
   多重路徑是指伺服器與相同實體或邏輯區塊儲存裝置在伺服器中的主機匯流排介面卡與裝置的儲存控制器之間、跨多重實體路徑進行通訊的能力，通常是在光纖通道 (FC) 或 iSCSI SAN 環境中進行。若有多個通道可用，您還可以與直接連接的儲存建立多個連接。
  </para>

  <para>
   Linux 多重路徑提供了連接容錯功能並可在各主動連接之間實現負載平衡。設定並執行多重路徑時，會自動隔離並識別裝置連接失敗，並將 I/O 重新路由至替代連接。
  </para>

  <para>
   常見的連接問題包括介面卡、纜線或控制器錯誤。為裝置設定多重路徑 I/O 後，多重路徑驅動程式將監控裝置間的主動連接。當多重路徑驅動程式偵測到主動路徑的 I/O 錯誤時，會將流量容錯移轉至裝置的指定次要路徑。偏好的路徑復原後，控制將返回至該路徑。
  </para>
 </sect1>
 <sect1 xml:id="sec.multipath.hardware">
  <title>硬體支援</title>

  <para>
   多重路徑驅動程式和工具支援 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 適用的所有架構。它們支援大多數儲存陣列。儲存多重路徑裝置的儲存陣列必須支援多重路徑，這樣才能使用多重路徑驅動程式與工具。一些儲存陣列廠商會提供其自己的多重路徑管理工具。請參閱廠商的硬體文件以決定所需設定。
  </para>

  <sect2 xml:id="sec.multipath.hardware.autodetect">
   <title>為多重路徑自動偵測儲存陣列</title>
   <para>
    <filename>multipath-tools</filename> 套件會自動偵測以下儲存陣列︰
   </para>
   <simplelist>
    <member>3PARdata VV</member>
    <member> AIX NVDISK</member>
    <member> AIX VDASD</member>
    <member> APPLE Xserve RAID</member>
    <member> COMPELNT Compellent Vol</member>
    <member> COMPAQ/HP HSV101、HSV111、HSV200、HSV210、HSV300、HSV400、HSV 450</member>
    <member> COMPAQ/HP MSA、HSV</member>
    <member> COMPAQ/HP MSA VOLUME</member>
    <member> DataCore SANmelody</member>
    <member> DDN SAN DataDirector</member>
    <member> DEC HSG80</member>
    <member> DELL MD3000</member>
    <member> DELL MD3000i</member>
    <member> DELL MD32xx</member>
    <member> DELL MD32xxi</member>
    <member> DGC</member>
    <member> EMC Clariion</member>
    <member> EMC Invista</member>
    <member> EMC SYMMETRIX</member>
    <member> EUROLOGC FC2502</member>
    <member> FSC CentricStor</member>
    <member> FUJITSU ETERNUS_DX、DXL、DX400、DX8000</member>
    <member> HITACHI DF</member>
    <member> HITACHI/HP OPEN</member>
    <member> HP A6189A</member>
    <member> HP HSVX700</member>
    <member> HP LOGICAL VOLUME</member>
    <member> HP MSA2012fc、MSA 2212fc、MSA2012i</member>
    <member> HP MSA2012sa、MSA2312 fc/i/sa、MCA2324 fc/i/sa、MSA2000s VOLUME</member>
    <member> HP P2000 G3 FC|P2000G3 FC/iSCSI|P2000 G3 SAS|P2000 G3 iSCSI</member>
    <member> IBM 1722-600</member>
    <member> IBM 1724</member>
    <member> IBM 1726</member>
    <member> IBM 1742</member>
    <member> IBM 1745、1746</member>
    <member> IBM 1750500</member>
    <member> IBM 1814</member>
    <member> IBM 1815</member>
    <member> IBM 1818</member>
    <member> IBM 1820N00</member>
    <member> IBM 2105800</member>
    <member> IBM 2105F20</member>
    <member> IBM 2107900</member>
    <member> IBM 2145</member>
    <member> IBM 2810XIV</member>
    <member> IBM 3303 NVDISK</member>
    <member> IBM 3526</member>
    <member> IBM 3542</member>
    <member> IBM IPR</member>
    <member> IBM Nseries</member>
    <member> IBM ProFibre 4000R</member>
    <member> IBM S/390 DASD ECKD</member>
    <member> IBM S/390 DASD FBA</member>
    <member> Intel Multi-Flex</member>
    <member> LSI/ENGENIO INF-01-00</member>
    <member> NEC DISK ARRAY</member>
    <member> NETAPP LUN</member>
    <member> NEXENTA COMSTAR</member>
    <member> Pillar Axiom</member>
    <member> PIVOT3 RAIGE VOLUME</member>
    <member> SGI IS</member>
    <member> SGI TP9100、TP 9300</member>
    <member> SGI TP9400、TP9500</member>
    <member> STK FLEXLINE 380</member>
    <member> STK OPENstorage D280</member>
    <member> SUN CSM200_R</member>
    <member> SUN LCSM100_[IEFS]</member>
    <member> SUN STK6580、STK6780</member>
    <member> SUN StorEdge 3510、T4</member>
    <member> SUN SUN_6180</member>
   </simplelist>
   <para>
    一般說來，大多數其他儲存陣列應該都可使用。自動偵測到儲存陣列後，會套用多重路徑的預設設定。如果您需要非預設設定，則必須手動建立並設定 <filename>/etc/multipath.conf</filename> 檔案。這對不能自動偵測到的硬體也適用。如需更多資訊，請參閱<xref linkend="sec.multipath.conf_file" xrefstyle="SectTitleOnPage"/>。
   </para>
   <para>
    請考慮以下警告︰
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      並非所有自動偵測到的儲存陣列都已在 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 上經過測試。另請參閱<xref linkend="sec.multipath.hardware.tested" xrefstyle="HeadingOnPage"/>。
     </para>
    </listitem>
    <listitem>
     <para>
      某些儲存陣列可能需要特定的硬體處理器。硬體處理器是在切換路徑群組與處理 I/O 錯誤時執行硬體特定動作的核心模組。如需更多資訊，請參閱<xref linkend="sec.multipath.hardware.handlers" xrefstyle="HeadingOnPage"/>。
     </para>
    </listitem>
    <listitem>
     <para>
      每次修改 <filename>/etc/multipath.conf</filename> 檔案後，都必須執行 <command>dracut</command> <option>-f</option> 在系統上重新建立 <systemitem>initrd</systemitem>。然後重新開機以使變更生效。
     </para>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="sec.multipath.hardware.tested">
   <title>經測試支援多重路徑的儲存陣列</title>
   <para>
    下列廠商生產的儲存陣列已在 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 上經過測試︰
   </para>
   <simplelist>
    <member>EMC</member>
    <member> Hitachi</member>
    <member> Hewlett-Packard/Compaq</member>
    <member> IBM</member>
    <member> NetApp</member>
    <member> SGI</member>
   </simplelist>
   <para>
    大多數其他廠商提供的儲存陣列應該也可使用。請參閱廠商文件獲取指導原則。如需 <filename>multipath-tools</filename> 套件可辨識的預設儲存陣列清單，請參閱<xref linkend="sec.multipath.hardware.autodetect" xrefstyle="HeadingOnPage"/>。
   </para>
  </sect2>

  <sect2 xml:id="sec.multipath.hardware.handlers">
   <title>需要特定硬體處理器的儲存陣列</title>
   <para>
    從一個路徑到另一個路徑的容錯移轉時需要特殊指令的儲存陣列，或需要特殊非標準錯誤處理的儲存陣列，可能都需要額外的延伸支援。因此，裝置對應程式多重路徑服務已配備用於硬體處理器的插入程式。例如，已針對 EMC CLARiiON CX 陣列系列提供一個此類處理器。
   </para>
   <important>
    <title>更多資訊</title>
    <para>
     請參閱硬體廠商文件，以確定是否必須安裝硬體處理器以用於裝置對應程式多重路徑。
    </para>
   </important>
   <para>
    <command>multipath -t</command> 指令可顯示需要使用特定硬體處理器進行特殊處理之儲存陣列的內部表格。所顯示的清單不是受支援儲存陣列的完整清單。它列出的僅僅是需要特殊處理的陣列，以及 <filename>multipath-tools</filename> 開發人員在開發該工具期間有存取權限的陣列。
   </para>
   <important>
    <title>例外</title>
    <para>
     真正支援主動/主動多重路徑的陣列不需要特殊處理，因此 <command>multipath -t</command> 指令不會列出此類陣列。
    </para>
   </important>
   <para>
    <command>multipath -t</command> 表格中的清單內容並不表示已在該特定硬體上進行 SUSE Linux Enterprise Server 測試。<phrase role="productname"><phrase os="sles"/></phrase>如需經過測試的儲存陣列清單，請參閱<xref linkend="sec.multipath.hardware.tested" xrefstyle="HeadingOnPage"/>。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.multipath.planning">
  <title>規劃多重路徑</title>

  <para>
   使用本節中的準則規劃多重路徑 I/O 解決方案。
  </para>

  <sect2 xml:id="sec.multipath.planning.prereq">
   <title>先決條件</title>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      多重路徑在裝置層級進行管理。
     </para>
    </listitem>
    <listitem>
     <para>
      您用於多重路徑裝置的儲存陣列必須支援多重路徑。如需詳細資訊，請參閱<xref linkend="sec.multipath.hardware" xrefstyle="SectTitleOnPage"/>。
     </para>
    </listitem>
    <listitem>
     <para>
      只有在伺服器中的主機匯流排配接器和區塊儲存裝置的主機匯流排控制器之間存在多重實體路徑時，才需要設定多重路徑。應按伺服器所見為邏輯裝置設定多重路徑。
     </para>
    </listitem>
    <listitem>
     <para>
      對於某些儲存陣列，廠商提供了自己的多重路徑軟體來管理陣列之實體和邏輯裝置的多重路徑。在這種情況下，您應根據廠商的指示設定那些裝置的多重路徑。
     </para>
    </listitem>
    <listitem>
     <para>
      在虛擬化環境中使用多重路徑時，將在主機伺服器環境中控制多重路徑。請先設定裝置的多重路徑，然後才能將其指派給虛擬訪客機器。
     </para>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="sec.multipath.planning.disks">
   <title>磁碟管理任務</title>
   <para>
    請先執行以下磁碟管理任務，再嘗試為具有多路徑的實體或邏輯裝置設定多重路徑︰
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      使用協力廠商工具將實體磁碟分割為數個較小的邏輯磁碟。
     </para>
    </listitem>
    <listitem>
     <para>
      使用協力廠商工具分割實體磁碟或邏輯磁碟。如果您變更正在執行系統中的分割區，則裝置對應程式多重路徑 (DM-MP) 模組將不會自動偵測並反映這些變更。DM-MPIO 必須重新啟始化，這通常需要重新開機。
     </para>
    </listitem>
    <listitem>
     <para>
      使用協力廠商 SAN 陣列管理工具建立並設定硬體 RAID 裝置。
     </para>
    </listitem>
    <listitem>
     <para>
      使用協力廠商 SAN 陣列管理工具建立邏輯裝置，例如 LUN。指定陣列所支援的邏輯裝置類型由陣列廠商決定。
     </para>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="sec.multipath.planning.raid">
   <title>軟體 RAID</title>
   <para>
    Linux 軟體 RAID 管理軟體在多重路徑的最上層執行。對於每個具有多重 I/O 路徑的裝置和要用於軟體 RAID 的裝置來說，您必須先設定多重路徑的裝置，然後才能嘗試建立軟體 RAID 裝置。無法自動探查多重路徑裝置。軟體 RAID 無法知曉多重路徑管理是否於後台執行。
   </para>
   <para>
    如需為現有軟體 RAID 設定多重路徑的相關資訊，請參閱<xref linkend="sec.multipath.raid" xrefstyle="SectTitleOnPage"/>。
   </para>
  </sect2>

  <sect2 xml:id="sec.multipath.planning.ha">
   <title>高可用性解決方案</title>
   <para>
    叢集儲存資源的高可用性解決方案在每個節點上之多重路徑服務的基礎上執行。請確保每個節點上之 <filename>/etc/multipath.conf</filename> 檔案中的組態設定在整個叢集中保持一致。
   </para>
   <para>
    確保多重路徑裝置在所有裝置中的名稱都相同。如需詳細資訊，請參閱<xref linkend="sec.multipath.names.ha"/>。
   </para>
   <para>
    用於 LAN 鏡像複製裝置的分散式複製區塊裝置 (DRBD) 高可用性解決方案在多重路徑的基礎上執行。對於每個具有多重 I/O 路徑的裝置和要用於 DRDB 解決方案的裝置來說，您必須先設定多重路徑的裝置，然後才能設定 DRDB。
   </para>
  </sect2>

  <sect2 xml:id="sec.multipath.planning.initrd">
   <title>
    永遠讓 <filename>initrd</filename> 與系統組態保持同步
   </title>
   <para>
    使用多重路徑時最重要的一項目要求是，需確認在根檔案系統及系統開機所需的所有其他檔案系統方面，<filename>initrd</filename> 與已安裝的系統行為一致。如果在系統中啟用了多重路徑，那麼也需要在 <filename>initrd</filename> 中啟用多重路徑，反之亦然。如需詳細資料，請參閱<xref linkend="sec.multipath.configuration.start"/>。
   </para>
   <para>
    如果 <filename>initrd</filename> 與系統不同步，系統將無法正常開機，啟動程序將產生應急外圍程序。如需如何避免或修復此類情況的說明，請參閱<xref linkend="sec.multipath.trouble.root"/>。
   </para>
  </sect2>

 </sect1>
 <sect1 xml:id="sec.multipath.mpiotools">
  <title>多重路徑管理工具</title>

  <para>
   <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 中的多重路徑支援以 Linux 核心的裝置對應程式多重路徑模組及 <systemitem>multipath-tools</systemitem> 使用者空間套件為基礎。使用多裝置管理 (MDADM，<command>mdadm</command>) 公用程式可以檢視多重路徑裝置的狀態。
  </para>

  <sect2 xml:id="sec.multipath.mpiotools.dm">
   <title>裝置對應程式多重路徑模組</title>
   <para>
    裝置對應程式多重路徑 (DM-MP) 模組為 Linux 提供了多重路徑功能。DM-MPIO 是在 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 中實作多重路徑的較好解決方案。它是該產品提供的唯一一個多重路徑選項，完全受 SUSE 支援。
   </para>
   <para>
    DM-MPIO 可自動設定多重路徑子系統的多種設定。每個裝置最多可設定 8 個路徑。模組支援主動/被動 (一個主動路徑，其他均為被動路徑) 或主動/主動 (所有路徑均為主動路徑，使用輪替式負載平衡) 組態。
   </para>
   <para>
    DM-MPIO 框架可以採用以下兩種方式進行擴充︰
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      使用特定硬體處理器。如需更多資訊，請參閱<xref linkend="sec.multipath.hardware.handlers" xrefstyle="HeadingOnPage"/>。
     </para>
    </listitem>
    <listitem>
     <para>
      使用更精密的負載平衡演算法取代輪替式演算法.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    DM-MPIO 的使用者空間元件會自動探查路徑並進行分組，還會自動重新測試路徑，以便在先前失敗的路徑恢復正常時，能自動重新啟用該路徑。這樣會將管理員對生產環境的關注需求降到最低。
   </para>
   <para>
    DM-MPIO 防範的是裝置路徑中的失敗，而不是裝置本身的失敗。如果其中一個主動路徑遺失 (例如網路卡損壞或光纖纜線被移開)，則 I/O 會重新導向到其餘的路徑。如果組態為主動/被動模式，則路徑會容錯移轉到其中一個被動路徑。如果您使用的是輪替式負載平衡組態，則流量會分流到其餘的正常路徑。如果所有主動路徑都失敗，則必須喚醒非主動的次要路徑，因此需經過大約 30 秒的延遲之後才會開始容錯移轉。
   </para>
   <para>
    如果磁碟陣列有多個儲存處理器，請確保 SAN 交換器已連接到您要存取的 LUN 所屬的儲存處理器。在大多數磁碟陣列中，所有 LUN 都屬於兩個儲存處理器，因此兩個連接都處於主動模式。
   </para>
   <note>
    <title>儲存處理器</title>
    <para>
     在有些磁碟陣列中，儲存陣列透過儲存處理器來管理流量，因此每次只會顯示一個儲存處理器。一個處理器為主動，另外一個為被動，直到發生了失敗。如果您連接到錯誤的儲存處理器 (路徑為被動的處理器)，則可能找不到所需的 LUN，或雖然找到了 LUN，但在嘗試存取時會發生錯誤。
    </para>
   </note>
   <table>
    <title>儲存陣列的多重路徑 I/O 功能</title>
    <tgroup cols="2">
     <colspec colnum="1" colname="1" colwidth="2857*"/>
     <colspec colnum="2" colname="2" colwidth="7144*"/>
     <thead>
      <row>
       <entry>
        <para>
         儲存陣列的功能
        </para>
       </entry>
       <entry>
        <para>
         描述
        </para>
       </entry>
      </row>
     </thead>
     <tbody>
      <row>
       <entry>
        <para>
         主動/被動控制器
        </para>
       </entry>
       <entry>
        <para>
         只有一個控制器處於主動狀態，並服務所有的 LUN。次要控制器處於待命狀態。次要控制器也會將 LUN 提供給多重路徑元件，以便作業系統瞭解備援路徑的情況。如果主要控制器失敗，則由次要控制器接管其工作並服務所有 LUN。
        </para>
        <para>
         在某些陣列中，可將 LUN 指定給不同的控制器。將指定的 LUN 指定給要做為其主動控制器的控制器。每次當一個控制器為任何 LUN 執行磁碟 I/O 時，另一個控制器就為該 LUN 保持待命狀態。另外的那個控制器也會提供路徑，但無法執行磁碟 I/O。使用該 LUN 的伺服器會連接到 LUN 的指定控制器。如果一組 LUN 的主要控制器失敗，則由次要控制器接管其工作並服務所有 LUN。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         主動/主動控制器
        </para>
       </entry>
       <entry>
        <para>
         兩個控制器共享所有 LUN 的負載，可以處理任何 LUN 的磁碟 I/O。如果一個控制器失敗，另一個控制器便會自動處理所有流量。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         載入平衡
        </para>
       </entry>
       <entry>
        <para>
         裝置對應程式多重路徑驅動程式會自動對通過所有主動路徑的流量進行負載平衡控制。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         控制器容錯移轉
        </para>
       </entry>
       <entry>
        <para>
         主動控制器容錯移轉到被動 (或待命) 控制器時，裝置對應程式多重路徑驅動程式會自動啟動主機與待命之間的路徑，使其成為主要路徑。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         開機/根裝置支援
        </para>
       </entry>
       <entry>
        <para>
         SUSE Linux Enterprise Server 10 及更高版本提供對根 (<filename>/</filename>) 裝置的多重路徑支援。<phrase role="productname"><phrase os="sles"/></phrase>主機伺服器必須連接到開機裝置目前的主動控制器與儲存處理器。
        </para>
        <para>
         SUSE Linux Enterprise Server 11 及更高版本提供了對 <filename>/boot</filename> 裝置的多重路徑支援。<phrase role="productname"><phrase os="sles"/></phrase>
        </para>
       </entry>
      </row>
     </tbody>
    </tgroup>
   </table>
   <para>
    裝置對應程式多重路徑會偵測每個路徑，查看有無多重路徑裝置做為獨立的 SCSI 裝置。SCSI 裝置名稱採用的格式為 <filename>/dev/sd<replaceable>N</replaceable></filename>，其中 <filename><replaceable>N</replaceable></filename> 是為裝置自動產生的字母，從 a 開始，並隨著裝置的建立依序發佈，例如 <filename>/dev/sda</filename>、<filename>/dev/sdb</filename>，依此類推。如果裝置數量超過 26 個，則字母將會重複，這樣，<filename>/dev/sdz</filename> 之後的裝置將命名為 <filename>/dev/sdaa</filename>、<filename>/dev/sdab</filename>，依此類推。
   </para>
   <para>
    如果有多個路徑未自動偵測到，則您可以在 <filename>/etc/multipath.conf</filename> 檔案中手動設定。在您建立並設定 <filename>multipath.conf</filename> 檔案之前，該檔案並不存在。如需更多資訊，請參閱<xref linkend="sec.multipath.conf_file" xrefstyle="SectTitleOnPage"/>。
   </para>
  </sect2>

  <sect2 xml:id="sec.multipath.mpiotools.io_management">
   <title>多重路徑 I/O 管理工具</title>
   <para>
    套件 <systemitem class="resource">multipath-tools</systemitem> 和 <systemitem class="resource">kpartx</systemitem> 提供了執行自動路徑探查和分組的工具。它們會週期性地自動測試路徑，這樣，先前失敗的路徑在恢復正常後，便可自動重新啟用。這樣會將管理員對生產環境的關注需求降到最低。
   </para>
   <table>
    <title>multipath-tools 套件中的工具</title>
    <tgroup cols="2">
     <colspec colnum="1" colname="1" colwidth="2857*"/>
     <colspec colnum="2" colname="2" colwidth="7144*"/>
     <thead>
      <row>
       <entry>
        <para>
         工具
        </para>
       </entry>
       <entry>
        <para>
         描述
        </para>
       </entry>
      </row>
     </thead>
     <tbody>
      <row>
       <entry>
        <para>
         <command>multipath</command>
        </para>
       </entry>
       <entry>
        <para>
         對系統進行掃描，找出多重路徑裝置並進行組合。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <command>multipathd</command>
        </para>
       </entry>
       <entry>
        <para>
         等待映射事件，然後執行 <command>multipath</command>。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <command>kpartx</command>
        </para>
       </entry>
       <entry>
        <para>
         將線性 devmaps 映射到多重路徑裝置中的分割區，這樣能夠建立對裝置中各分割區的多重路徑監控。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <command>mpathpersist</command>
        </para>
       </entry>
       <entry>
        <para>
         在裝置對應程式多重路徑 devices.ppc 上管理 SCSI 永久保留
        </para>
       </entry>
      </row>
     </tbody>
    </tgroup>
   </table>
  </sect2>

  <sect2 xml:id="sec.multipath.mpiotools.mdadm">
   <title>對多重路徑裝置使用 MDADM</title>
   <para>
    Udev 是預設的裝置處理器，該系統可透過 Worldwide ID (而不是裝置節點名稱) 自動識別裝置。這解決了 MDADM 與 LVM 的先前版本中組態檔案 (<filename>mdadm.conf</filename> 與 <filename>lvm.conf</filename>) 無法正確辨識多重路徑裝置的問題。
   </para>
   <para>
    與 LVM2 一樣，MDADM 也要求透過 ID 而非裝置節點路徑存取裝置。因此，應使用如下指令設定 <filename>/etc/mdadm.conf</filename> 中的 <systemitem>DEVICE</systemitem> 項目︰
   </para>
<screen>DEVICE /dev/disk/by-id/*</screen>
   <para>
    若您使用的是使用者易記名稱，請按照以下方式指定路徑，以便在設定多重路徑之後僅掃描裝置對應程式名稱︰
   </para>
<screen>DEVICE /dev/disk/by-id/dm-uuid-.*-mpath-.*</screen>
  </sect2>

  <sect2 xml:id="sec.multipath.mpiotools.multipath">
   <title>multipath 指令</title>
   <para>
    使用 Linux <command>multipath(8)</command> 指令可以設定並管理多重路徑裝置。該指令的一般語法如下所示︰
   </para>
<screen>multipath [-v verbosity_level] [-b bindings_file] [-d] [-h|-l|-ll|-f|-F|-B|-c|-q|-r|-w|-W|-t] [-p failover|multibus|group_by_serial|group_by_prio|group_by_node_name] [<replaceable>devicename</replaceable>]</screen>
   <para>
    如需詳細資料，請參閱 <command>man 8 multipath</command>。
   </para>
   <bridgehead>一般範例</bridgehead>
   <variablelist>
    <varlistentry>
     <term>multipath</term>
     <listitem>
      <para>
       設定所有多重路徑裝置。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath <replaceable>裝置名稱</replaceable>
     </term>
     <listitem>
      <para>
       設定特定的多重路徑裝置。
      </para>
      <para>
       使用 <filename>/dev/sdb</filename> (顯示於 udev 的 $DEVNAME 變數中) 等裝置節點名稱取代<replaceable>裝置名稱</replaceable>，或採用 <literal>major:minor</literal> 格式。裝置也可以使用多重路徑對應名稱。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -f</term>
     <listitem>
      <para>
       選擇性隱藏多重路徑映射及其映射裝置的分割區。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -d</term>
     <listitem>
      <para>
       模擬執行。顯示潛在的多重路徑裝置，但不建立任何裝置，也不更新裝置映射。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -v2 -d</term>
     <listitem>
      <para>
       顯示試執行中潛在多重路徑裝置的多重路徑映射資訊。使用 -v2 選項可僅顯示本地磁碟。此詳細層級會列印已建立或已更新的多重路徑名稱，僅用於為 kpartx 等其他工具提供資訊。
      </para>
      <para>
       如果裝置已存在且沒有變更，則不會輸出內容。使用 <command>multipath -ll</command> 可查看已設定多重路徑裝置的狀態。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -v2 <replaceable>裝置名稱</replaceable>
     </term>
     <listitem>
      <para>
       設定特定的潛在多重路徑裝置並顯示其多重路徑映射資訊。此詳細層級僅會列印已建立或已更新的多重路徑名稱，用於為 <command>kpartx</command> 等其他工具提供資訊。
      </para>
      <para>
       如果裝置已存在且沒有變更，則不會輸出內容。使用 <command>multipath -ll</command> 可查看已設定多重路徑裝置的狀態。
      </para>
      <para>
       使用 <filename>/dev/sdb</filename> (顯示於 <command>udev</command> 的 $DEVNAME 變數中) 等裝置節點名稱取代<replaceable>裝置名稱</replaceable>，或採用 <literal>major:minor</literal> 格式。裝置也可以使用多重路徑對應名稱。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -v3</term>
     <listitem>
      <para>
       設定潛在的多重路徑裝置並顯示其多重路徑映射資訊。此詳細層級會列印所有已刪除的路徑、多重路徑和裝置映射。WWID 與 <literal>devnode</literal> 列入黑名單的裝置都會顯示。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -v3 <replaceable>裝置名稱</replaceable>
     </term>
     <listitem>
      <para>
       設定特定的潛在多重路徑裝置並顯示其資訊。使用 -v3 選項會顯示完整路徑清單。此詳細層級會列印所有已刪除的路徑、多重路徑和裝置映射。WWID 與 <literal>devnode</literal> 列入黑名單的裝置都會顯示。
      </para>
      <para>
       使用 <filename>/dev/sdb</filename> (顯示於 <command>udev</command> 的 $DEVNAME 變數中) 等裝置節點名稱取代<replaceable>裝置名稱</replaceable>，或採用 <literal>major:minor</literal> 格式。裝置也可以使用多重路徑對應名稱。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -ll</term>
     <listitem>
      <para>
       顯示所有多重路徑裝置的狀態。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -ll <replaceable>裝置名稱</replaceable>
     </term>
     <listitem>
      <para>
       顯示指定多重路徑裝置的狀態。
      </para>
      <para>
       使用 <filename>/dev/sdb</filename> (顯示於 <command>udev</command> 的 $DEVNAME 變數中) 等裝置節點名稱取代<replaceable>裝置名稱</replaceable>，或採用 <literal>major:minor</literal> 格式。裝置也可以使用多重路徑對應名稱。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -F</term>
     <listitem>
      <para>
       衝洗所有未使用的多重路徑裝置映射。這會取消解析多個路徑，但不會刪除裝置。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -F <replaceable>裝置名稱</replaceable>
     </term>
     <listitem>
      <para>
       衝洗指定多重路徑裝置之未使用的多重路徑裝置映射。這會取消解析多個路徑，但不會刪除該裝置。
      </para>
      <para>
       使用 <filename>/dev/sdb</filename> (顯示於 <command>udev</command> 的 $DEVNAME 變數中) 等裝置節點名稱取代<replaceable>裝置名稱</replaceable>，或採用 <literal>major:minor</literal> 格式。裝置也可以使用多重路徑對應名稱。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -p [ failover | multibus | group_by_serial | group_by_prio | group_by_node_name ]</term>
     <listitem>
      <para>
       透過指定下表中所述的其中一個群組規則選項，來設定群組規則︰
      </para>
      <table>
       <title>multipath -p 指令的群組規則選項</title>
       <tgroup cols="2">
        <colspec colnum="1" colname="1" colwidth="2684*"/>
        <colspec colnum="2" colname="2" colwidth="7319*"/>
        <thead>
         <row>
          <entry>
           <para>
            規則選項
           </para>
          </entry>
          <entry>
           <para>
            描述
           </para>
          </entry>
         </row>
        </thead>
        <tbody>
         <row>
          <entry>
           <para>
            failover
           </para>
          </entry>
          <entry>
           <para>
            (預設) 每個優先程度群組對應一個路徑。每次只能使用一個路徑。
           </para>
          </entry>
         </row>
         <row>
          <entry>
           <para>
            multibus
           </para>
          </entry>
          <entry>
           <para>
            所有路徑都在一個優先程度群組中。
           </para>
          </entry>
         </row>
         <row>
          <entry>
           <para>
            group_by_serial
           </para>
          </entry>
          <entry>
           <para>
            每個偵測到的 SCSI 序號 (控制器節點全球號碼) 對應一個優先程度群組。
           </para>
          </entry>
         </row>
         <row>
          <entry>
           <para>
            group_by_prio
           </para>
          </entry>
          <entry>
           <para>
            每個路徑優先程度值對應一個優先程度群組。優先程度相同的路徑位於同一個優先程度群組中。優先程度由註標程式決定，在 <filename>/etc/multipath.conf</filename> 組態檔案中指定為 global、per-controller 或 per-multipath 選項。
           </para>
          </entry>
         </row>
         <row>
          <entry>
           <para>
            group_by_node_name
           </para>
          </entry>
          <entry>
           <para>
            每個目標節點名稱對應一個優先程度群組。目標節點名稱取自 <filename>/sys/class/fc_transport/target*/node_name</filename> 位置。
           </para>
          </entry>
         </row>
        </tbody>
       </tgroup>
      </table>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipath -t</term>
     <listitem>
      <para>
       顯示內部硬體表和使用中的多重路徑組態。如需組態參數的詳細資料，請參閱 <command>man multipath</command>。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec.multipath.mpiotools.mpathpersist">
   <title>mpathpersist 公用程式</title>
   <para>
    <command>mpathpersist</command> 公用程式可用來管理裝置對應程式多重路徑裝置上的 SCSI 永久保留。該指令的一般語法如下所示︰
   </para>
<screen>mpathpersist [options] [device]</screen>
   <para>
    如需詳細資料，請參閱 <command>man 8 mpathpersist</command>。
   </para>
   <para>
    將此公用程式與 <filename>/etc/multipath.conf</filename> 檔案中的服務動作保留金鑰 (<literal>reservation_key</literal> 屬性) 配合使用，可設定 SCSI 裝置的永久保留。系統預設不會使用該屬性。如果未設定該屬性，<command>multipathd</command> 精靈將不會檢查新探查到的路徑或已重新啟用之路徑的永久保留。
   </para>
<screen>reservation_key &lt;<replaceable>reservation key</replaceable>&gt;</screen>
   <para>
    您可以將該屬性新增至 <literal>defaults</literal> 區段或 <literal>multipaths</literal> 區段。例如︰
   </para>
<screen>multipaths {
  multipath {
    wwid   XXXXXXXXXXXXXXXX
    alias      yellow
    reservation_key  0x123abc
  }
}</screen>
   <para>
    為所有適合永久管理的多重路徑裝置設定 <literal>reservation_key</literal> 參數，然後執行以下指令來重新啟動 <systemitem class="daemon">multipathd</systemitem> 精靈︰
   </para>
<screen>sudo systemctl restart multipathd</screen>
   <para>
    設定它之後，您可以在 <command>mpathpersist</command> 指令中指定保留金鑰。
   </para>
   <bridgehead>範例</bridgehead>
   <variablelist>
    <varlistentry>
     <term>mpathpersist --out --register --param-sark=123abc --prout-type=5 -d /dev/mapper/mpath9</term>
     <listitem>
      <para>
       註冊 <filename>/dev/mapper/mpath9</filename> 裝置的服務動作保留金鑰。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>mpathpersist -i -k -d /dev/mapper/mpath9</term>
     <listitem>
      <para>
       讀取 <filename>/dev/mapper/mpath9</filename> 裝置的服務動作保留金鑰。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>mpathpersist --out --reserve --param-sark=123abc --prout-type=8 -d /dev/mapper/mpath9</term>
     <listitem>
      <para>
       保留 <filename>/dev/mapper/mpath9</filename> 裝置的服務動作保留金鑰。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>mpathpersist -i -s -d /dev/mapper/mpath9</term>
     <listitem>
      <para>
       讀取 <filename>/dev/mapper/mpath9</filename> 裝置的保留狀態。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.multipath.config">
  <title>設定系統以進行多重路徑</title>

  <para/>

  <sect2 xml:id="sec.multipath.configuration.start">
   <title>啟用、停用、啟動和停止多重路徑 I/O 服務</title>
   <para>
    若要允許多重路徑服務在開機時啟動，請執行以下指令︰
   </para>
<screen>sudo systemctl enable multipathd</screen>
   <para>
    若要在執行中系統內手動啟動服務，或是檢查其狀態，請輸入以下其中一個指令︰
   </para>
   <screen>sudo systemctl start multipathd
sudo systemctl status multipathd</screen>
   <para>
    若要在目前的工作階段中停止多重路徑服務，以及停用該服務以便在系統下次開機時不啟動它，請執行以下指令︰
   </para>
   <screen>sudo systemctl stop multipathd
sudo systemctl disable multipathd</screen>

   <important xml:id="ann.multipath.configuration.initrd">
    <title>重建 <systemitem>initrd</systemitem></title>
    <para>
     每次啟用或停用多重路徑服務時，還需要重建 <systemitem>initrd</systemitem>，否則系統可能無法再開機。啟用多重路徑服務時，還需執行以下指令以重建 initrd︰
    </para>
    <screen>dracut --force --add multipath</screen>
    <para>
     停用服務時，則執行以下指令以重建 initrd︰
    </para>
    <screen>dracut --force -o multipath</screen>
    <para>
     (選擇性) 此外，如果您還想確保任何情況下都不會設定多重路徑裝置 (即使手動啟動了多重路徑)，請在重建 initrd 之前，將以下幾行新增到 <filename>/etc/multipath.conf</filename> 的結尾處︰
    </para>
    <screen>blacklist {
    wwid ".*"
}</screen>
   </important>
  </sect2>

  <sect2 xml:id="sec.multipath.configuration.sandevs">
   <title>準備 SAN 裝置以進行多重路徑</title>
   <para>
    在為 SAN 裝置設定多重路徑 I/O 之前，請視需要執行以下步驟準備 SAN 裝置︰
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      使用廠商工具對 SAN 進行設定並分區。
     </para>
    </listitem>
    <listitem>
     <para>
      使用廠商工具設定儲存陣列中主機 LUN 的許可權。
     </para>
    </listitem>
    <listitem>
     <para>
      安裝 Linux HBA 驅動程式模組。安裝模組時，驅動程式會自動掃描 HBA 以探查任何擁有存取主機的許可權的 SAN 裝置。驅動程式會將這些裝置提交至主機以供稍後設定之用。
     </para>
     <note>
      <title>無原生多重路徑</title>
      <para>
       請確保您使用的 HBA 驅動程式沒有啟用本機多重路徑。
      </para>
     </note>
     <para>
      如需更多詳細資料，請參閱廠商的特定指示。
     </para>
    </listitem>
    <listitem>
     <para>
      載入驅動程式模組後，探查指定給特定陣列 LUN 或分割區的裝置節點。
     </para>
    </listitem>
    <listitem>
     <para>
      如果 SAN 裝置將做為伺服器上的根裝置使用，請依<xref linkend="sec.multipath.best_practice.san_timeout" xrefstyle="SectTitleOnPage"/> 中所述修改該裝置的逾時設定。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    如果 HBA 驅動程式無法探查到 LUN，可使用 <command>lsscsi</command> 來檢查作業系統是否能正常探查到 SCSI 裝置。如果 HBA 驅動程式無法探查到 LUN，請檢查 SAN 的分區設定。尤其是要檢查 LUN 遮罩是否處於使用中，且 LUN 是否正確地指定給伺服器。
   </para>
   <para>
    如果 HBA 驅動程式可以探查到 LUN，但不存在相應的區塊裝置，則還需要其他核心參數來變更 SCSI 裝置的掃描行為，如指出 LUN 沒有連續編號。如需相關資訊，請參閱 SUSE 知識庫中的 <citetitle>TID 3955167︰Troubleshooting SCSI (LUN) Scanning Issues</citetitle> (SCSI (LUN) 掃描問題疑難排解)，網址為 <link xlink:href="https://www.suse.com/support/kb/doc.php?id=3955167"/>。
   </para>
  </sect2>

  <sect2 xml:id="sec.multipath.configuration.partitioning">
   <title>分割多重路徑裝置</title>
   <para>
    不建議對含有多個路徑的裝置進行磁碟分割，但這項操作是受支援的。使用 <command>kpartx</command> 工具無需重新開機即可在多重路徑裝置中建立分割區。在嘗試使用 YaST 中的分割程式功能或使用協力廠商分割工具設定多重路徑之前，也可以製做裝置的分割區。
   </para>
   <para>
    多重路徑裝置是裝置對應程式裝置。雖然使用指令行工具 (例如 parted、kpartx 或 fdisk) 可以修改裝置對應程式裝置，但並不一定會產生更新其他層所需的 udev 事件。分割裝置對應程式裝置之後，您應該檢查多重路徑對應，確保已對應裝置對應程式裝置。如果未對應它們，您可以重新對應多重路徑裝置，或將伺服器重新開機，以取得多重路徑對應中的所有新分割區。
   </para>
   <para>
    多重路徑裝置上一個分割區的裝置對應程式裝置不同於一個獨立裝置。使用整個裝置建立 LVM 邏輯磁碟區時，必須指定不包含分割區的裝置。如果您將多重路徑分割區指定為 LVM 邏輯磁碟區的目標裝置，則 LVM 會認為基礎實體裝置已分割，導致建立失敗。如果您需要細分 SAN 裝置，可以拆分 SAN 裝置上的 LUN，並將每個 LUN 做為獨立的多重路徑裝置顯示給伺服器。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.multipath.conf_file">
  <title>建立或修改 /etc/multipath.conf 檔案</title>

  <para>
   在您建立 <filename>/etc/multipath.conf</filename> 檔案之前，該檔案並不存在。<command>multipathd</command> 精靈執行時會自動套用預設多重路徑裝置設定，除非您建立多重路徑組態檔案並進行個人化設定。
  </para>

  <important>
   <title>
    測試及永久性套用 <filename>/etc/multipath.conf</filename> 中的變更
   </title>
   <para>
    每次建立或修改 <filename>/etc/multipath.conf</filename> 檔案時，都不會在儲存檔案後自動套用變更。這樣，您便可以在提交變更之前，先進行試執行以驗證這些變更。若對修改後的設定滿意，便可依照<xref linkend="sec.multipath.conf_file.apply"/>中所述來更新多重路徑對應。
   </para>
  </important>

  <sect2 xml:id="sec.multipath.conf_file.create">
   <title>建立 /etc/multipath.conf 檔案</title>
   <procedure>
    <step>
     <para>
      使用慣用的編輯器建立一個空的 <filename>/etc/multipath.conf</filename> 檔案。
     </para>
    </step>
    <step>
     <para>
      請確保為您的 SAN 新增相應的 <literal>device</literal> 區段。大多數廠商會提供有關正確設定 <command>device</command> 區段的文件。請注意，不同的 SAN 需要單獨的 <literal>device</literal> 區段。
     </para>
     <para>
      若要使用自動偵測到的儲存子系統 (請參閱<xref linkend="sec.multipath.hardware.autodetect" xrefstyle="HeadingOnPage"/>)，則不需要新增 <literal>device</literal>，因為在此情況下將會套用此裝置的預設設定。
     </para>
    </step>
    <step>
     <para>
      建立 <literal>blacklist</literal> 區段，在其中包含機器的所有非多重路徑裝置。如需詳細資訊，請參閱<xref linkend="sec.multipath.blacklist"/>。
     </para>
    </step>
    <step>
     <para>
      如果需要，請新增更多區段至組態檔案。如需簡要介紹，請參閱<xref linkend="sec.multipath.conf_file.sections"/>。執行 <command>man 5 multipath.conf</command> 時會有更多詳細資料可用。
     </para>
    </step>
    <step>
     <para>
      完成後，請儲存 <filename>/etc/multipath.conf</filename> 並依照<xref linkend="sec.multipath.conf_file.verify"/>中所述測試您的設定。
     </para>
    </step>
    <step>
     <para>
      成功驗證組態後，請依照<xref linkend="sec.multipath.conf_file.apply"/>中所述套用組態。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.multipath.conf_file.sections">
   <title><filename>/etc/multipath.conf</filename> 檔案中的區段</title>
   <para>
    <filename>/etc/multipath.conf</filename> 檔案由下列區段構成。如需詳細資料，請參閱 <command>man 5 multipath.conf</command>。
   </para>
   <variablelist>
    <varlistentry>
     <term>預設值</term>
     <listitem>
      <para>
       多重路徑 I/O 的一般預設設定。如果在相應的裝置或多重路徑區段中未提供值，則會使用這些值。如需更多資訊，請參閱<xref linkend="sec.multipath.policies_default" xrefstyle="SectTitleOnPage"/>。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>blacklist</term>
     <listitem>
      <para>
       列出因不是多重路徑候選而要丟棄的裝置名稱。裝置可透過其裝置節點名稱 (<literal>devnode</literal>)、WWID (<literal>wwid</literal>)、廠商或產品字串 (<literal>device</literal>) 來識別。您通常會忽略非多重路徑裝置，例如 hpsa、fd、hd、md、dm、sr、scd、st、ram、raw 和 loop。如需更多資訊和範例，請參閱<xref linkend="sec.multipath.blacklist" xrefstyle="HeadingOnPage"/>。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>blacklist_exceptions</term>
     <listitem>
      <para>
       列出即使不在黑名單上也要被視為多重路徑候選之裝置的裝置名稱。裝置可透過其裝置節點名稱 (<literal>devnode</literal>)、WWID (<literal>wwid</literal>)、廠商或產品字串 (<literal>device</literal>) 來識別。您必須使用黑名單中所用之相同關鍵字來指定排除的裝置。例如，如果在黑名單中將 <literal>devnode</literal> 關鍵字用於裝置，則要使用 <literal>devnode</literal> 關鍵字來排除黑名單例外中的某些裝置。您無法使用 <literal>devnode</literal> 關鍵字將裝置列入黑名單，也無法使用 <literal>wwid</literal> 關鍵字排除其中某些裝置。如需更多資訊和範例，請參閱<xref linkend="sec.multipath.blacklist" xrefstyle="HeadingOnPage"/>。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>multipaths</term>
     <listitem>
      <para>
       指定個別多重路徑裝置的設定。除了不支援個別設定的設定以外，這些值會覆寫組態檔案之 <literal>defaults</literal> 與 <literal>devices</literal> 區段中所指定的內容。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>devices</term>
     <listitem>
      <para>
       指定個別儲存控制器的設定。這些值會覆寫組態檔案之 <filename>defaults</filename> 區段中所指定的值。如果使用預設不支援的儲存陣列，則可以建立 <literal>devices</literal> 子區段來指定其預設設定。如果關鍵字允許，可以用個別多重路徑裝置的設定覆寫這些值。
      </para>
      <para>
       如需資訊，請參閱以下章節︰
      </para>
      <itemizedlist mark="bullet" spacing="normal">
       <listitem>
        <para>
         <xref linkend="sec.multipath.names" xrefstyle="SectTitleOnPage"/>
        </para>
       </listitem>
       <listitem>
        <para>
         <xref linkend="sec.multipath.best_practice.zseries" xrefstyle="SectTitleOnPage"/>
        </para>
       </listitem>
      </itemizedlist>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec.multipath.conf_file.verify">
   <title>驗證 /etc/multipath.conf 檔案中的多重路徑設定</title>
   <para>
    每次建立或修改 <filename>/etc/multipath.conf</filename> 檔案時，都不會在儲存檔案後自動套用變更。您可以在更新多重路徑對應之前，先執行設定的<quote>試執行</quote>來驗證多重路徑設定。
   </para>
   <para>
    在伺服器命令提示字元中輸入
   </para>
<screen>sudo multipath -v2 -d</screen>
   <para>
    此指令會掃描裝置，然後顯示提交變更時設定將產生的效果。假設在您修改 <filename>/etc/multipath.conf</filename> 檔案並進行試執行時，<systemitem class="daemon">multipathd</systemitem> 精靈已使用舊 (或預設) 的多重路徑設定執行。如果變更可接受，請繼續執行下一步。
   </para>
   <para>
    輸出類似下方所列︰
   </para>
<screen>26353900f02796769
[size=127 GB]
[features="0"]
[hwhandler="1    emc"]

\_ round-robin 0 [first]
  \_ 1:0:1:2 sdav 66:240  [ready ]
  \_ 0:0:1:2 sdr  65:16   [ready ]

\_ round-robin 0
  \_ 1:0:0:2 sdag 66:0    [ready ]
  \_ 0:0:0:2 sdc   8:32   [ready ]
</screen>
   <para>
    路徑會分為不同的優先程度群組。每次只有一個優先程度群組處於主動狀態。若要塑造主動/主動組態，所有路徑都必須分在相同的群組。若要塑造主動/被動組態，不應同時處於主動狀態的路徑要放置於幾個不同的優先程度群組中。這通常會在裝置探查時自動進行。
   </para>
   <para>
    輸出會顯示順序、群組中用來平衡 I/O 的排程規則，以及各優先程度群組的路徑。對於每個路徑，會顯示其實體位址 (host:bus:target:lun)、裝置節點名稱、主要和次要的裝置編號和狀態。
   </para>
   <para>
    透過在試執行中使用 -v3 詳細層級，可以查看所有已刪除的路徑、多重路徑和裝置映射。WWID 與裝置節點列入黑名單的裝置都會顯示。
   </para>
   <para>
    下面的範例顯示了有兩個 Qlogic HBA 連接至 Xiotech Magnitude 3000 SAN 之 64 位元 SLES 11 SP2 伺服器上的 -v3 輸出。為精簡範例，省略了一些多重項目。
   </para>
<screen><prompt>tux &gt; </prompt>sudo multipath -v3 d
dm-22: device node name blacklisted
&lt; content omitted &gt;
loop7: device node name blacklisted
&lt; content omitted &gt;
md0: device node name blacklisted
&lt; content omitted &gt;
dm-0: device node name blacklisted
sdf: not found in pathvec
sdf: mask = 0x1f
sdf: dev_t = 8:80
sdf: size = 105005056
sdf: subsystem = scsi
sdf: vendor = XIOtech
sdf: product = Magnitude 3D
sdf: rev = 3.00
sdf: h:b:t:l = 1:0:0:2
sdf: tgt_node_name = 0x202100d0b2028da
sdf: serial = 000028DA0014
sdf: getuid= "/lib/udev/scsi_id --whitelisted --device=/dev/%n" (config file default)
sdf: uid = 200d0b2da28001400 (callout)
sdf: prio = const (config file default)
sdf: const prio = 1
[...]
ram15: device node name blacklisted
[...]
===== paths list =====
uuid              hcil    dev dev_t pri dm_st  chk_st  vend/prod/rev
200d0b2da28001400 1:0:0:2 sdf 8:80  1   [undef][undef] XIOtech,Magnitude 3D
200d0b2da28005400 1:0:0:1 sde 8:64  1   [undef][undef] XIOtech,Magnitude 3D
200d0b2da28004d00 1:0:0:0 sdd 8:48  1   [undef][undef] XIOtech,Magnitude 3D
200d0b2da28001400 0:0:0:2 sdc 8:32  1   [undef][undef] XIOtech,Magnitude 3D
200d0b2da28005400 0:0:0:1 sdb 8:16  1   [undef][undef] XIOtech,Magnitude 3D
200d0b2da28004d00 0:0:0:0 sda 8:0   1   [undef][undef] XIOtech,Magnitude 3D
params = 0 0 2 1 round-robin 0 1 1 8:80 1000 round-robin 0 1 1 8:32 1000
status = 2 0 0 0 2 1 A 0 1 0 8:80 A 0 E 0 1 0 8:32 A 0
sdf: mask = 0x4
sdf: path checker = directio (config file default)
directio: starting new request
directio: async io getevents returns 1 (errno=Success)
directio: io finished 4096/0
sdf: state = 2
[...]</screen>
  </sect2>

  <sect2 xml:id="sec.multipath.conf_file.apply">
   <title>套用 /etc/multipath.conf 檔案變更以更新多重路徑對應</title>
   <para>
    當 <command>multipathd</command> 正在執行時，對 <filename>/etc/multipath.conf</filename> 檔案所做的變更無法生效。在進行變更後，儲存並關閉檔案，然後執行以下操作以套用變更並更新多重路徑對應︰
   </para>
   <procedure>
    <step>
     <para>
      停止 <systemitem class="daemon">multipathd</systemitem> 服務︰
     </para>
<screen>sudo systemctl stop multipathd</screen>
    </step>
    <step>
     <para>
      輸入以下指令清除舊的多重路徑繫結︰
     </para>
<screen>sudo /sbin/multipath -F</screen>
    </step>
    <step>
     <para>
      輸入以下指令建立新的多重路徑繫結︰
     </para>
<screen>sudo /sbin/multipath -v2 -l</screen>
    </step>
    <step>
     <para>
      重新啟動 <systemitem class="daemon">multipathd</systemitem> 服務︰
     </para>
<screen>sudo systemctl start multipathd</screen>
    </step>
    <step>
     <para>
      在系統中執行 <command>dracut -f</command> 重新建立 <filename>initrd</filename> 影像，然後重新開機以使變更生效。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.multipath.conf_file.wwid">
   <title>產生 WWID</title>
   <para>
    為了在不同的路徑上識別裝置，多重路徑使用每部裝置的全球通用識別碼 (WWID)。如果兩個裝置路徑的 WWID 相同，則假定它們代表同一部裝置。除非有絕對的理由，否則建議不要變更產生 WWID 的方法。如需詳細資料，請參閱 <command>man multipath.conf</command>。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.multipath.policies_default">
  <title>設定輪詢、排入佇列和錯誤回復的預設規則</title>

  <para>
   多重路徑 I/O 的目的是在儲存系統與伺服器之間提供連接容錯。需要的預設行為視伺服器是獨立伺服器還是高可用性叢集中的節點而定。
  </para>

  <para>
   如果您為獨立伺服器設定了多重路徑 I/O，<literal>no_path_retry</literal> 設定可使伺服器作業系統在盡可能長的時間內不收到 I/O 錯誤。它將訊息排入佇列，直到多重路徑容錯移轉發生並提供有效的連接為止。
  </para>

  <para>
   為高可用性叢集中的節點設定多重路徑 I/O 時，您希望多重路徑報告 I/O 故障以觸發資源容錯移轉，而不是等待多重路徑容錯移轉得以解決。在叢集環境中，您必須修改 <literal>no_path_retry</literal> 設定，以確保在與儲存系統的連接中斷時，叢集節點會收到與叢集驗證程序相關的 I/O 錯誤 (建議設為 heartbeat 容錯的 50%)。此外，您還希望將多重路徑 I/O 錯誤回復設為手動，以避免因路徑故障而造成資源的乒乓效應。
  </para>

  <para>
   <filename>/etc/multipath.conf</filename> 檔案應包含 <command>defaults</command> 區段，您可在其中指定輪詢、排入佇列和錯誤回復的預設行為。如果 <command>device</command> 區段中沒有指定此欄位，系統會為該 SAN 組態套用預設設定。
  </para>

  <para>
   以下各項是已編譯的預設設定。除非您透過建立並設定個人化的 <filename>/etc/multipath.conf</filename> 檔案來覆寫這些值，否則將會使用它們。
  </para>

<screen>defaults {
  verbosity 2
#  udev_dir is deprecated in SLES 11 SP3
#  udev_dir              /dev
  polling_interval      5
#  path_selector default value is service-time in SLES 11 SP3
#  path_selector         "round-robin 0"
  path selector         "service-time 0"
  path_grouping_policy  failover
#  getuid_callout is deprecated in SLES 11 SP3 and replaced with uid_attribute
#  getuid_callout        "/lib/udev/scsi_id --whitelisted --device=/dev/%n"
#  uid_attribute is new in SLES 11 SP3
  uid_attribute         "ID_SERIAL"
  prio                  "const"
  prio_args             ""
  features              "0"
  path_checker          "tur"
  alias_prefix          "mpath"
  rr_min_io_rq          1
  max_fds               "max"
  rr_weight             "uniform"
  queue_without_daemon  "yes"
  flush_on_last_del     "no"
  user_friendly_names   "no"
  fast_io_fail_tmo      5
  bindings_file         "/etc/multipath/bindings"
  wwids_file            "/etc/multipath/wwids"
  log_checker_err       "always"

  retain_attached_hw_handler  "no"
  detect_prio           "no"
  failback              "manual"
  no_path_retry         "fail"
  }</screen>

  <para>
   如需設定輪詢、排入佇列和錯誤回復規則的相關資訊，請參閱<xref linkend="sec.multipath.policies_failover" xrefstyle="SectTitleOnPage"/> 中的下列參數︰
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     <xref linkend="polling_interval" xrefstyle="HeadingOnPage"/>
    </para>
   </listitem>
   <listitem>
    <para>
     <xref linkend="no_path_retry" xrefstyle="HeadingOnPage"/>
    </para>
   </listitem>
   <listitem>
    <para>
     <xref linkend="failback" xrefstyle="HeadingOnPage"/>
    </para>
   </listitem>
  </itemizedlist>

  <para>
   修改 <filename>/etc/multipath.conf</filename> 檔案後，必須在系統上執行 <command>dracut</command> <option>-f</option> 重新建立 <filename>initrd</filename>，然後重新啟動伺服器，變更才會生效。如需詳細資料，請參閱<xref linkend="sec.multipath.conf_file.apply"/>。
  </para>
 </sect1>
 <sect1 xml:id="sec.multipath.blacklist">
  <title>將非多重路徑裝置列入黑名單</title>

  <para>
   <filename>/etc/multipath.conf</filename> 檔案可能包含 <command>blacklist</command> 區段，其中會列出所有非多重路徑裝置。您可以透過 WWID (<literal>wwid</literal> 關鍵字)、裝置名稱 (<literal>devnode</literal> 關鍵字) 或裝置類型 (<literal>device</literal> 區段) 將裝置列入黑名單。您還可以使用 <literal>blacklist_exceptions</literal> 區段，對透過 <literal>blacklist</literal> 區段中所用的正規表示式列入黑名單的一些裝置啟用多重路徑。
  </para>

  <note>
   <title>
    慣用的加入黑名單方法
   </title>
   <para>
    將裝置加入黑名單的慣用方法是透過 <emphasis>WWID</emphasis> 或透過<emphasis>廠商和產品</emphasis>進行。建議不要透過 <emphasis>devnode</emphasis> 加入黑名單，因為裝置節點可能會發生變化，因此對長久識別裝置無幫助。
   </para>
  </note>

  <warning>
   <title>multipath.conf 中的規則運算式</title>
   <para><filename>/etc/multipath.conf</filename> 中的規則運算式一般情況下<emphasis>不</emphasis>會運作。僅在與通用字串比對時，它們才會運作。不過，多重路徑的標準組態已包含許多裝置和廠商的規則運算式。將這些規則運算式與其他規則運算式比對並不會運作。請務必僅與執行 <command>multipath -t</command> 後所顯示的字串比對。
   </para>
  </warning>

  <para>
   您通常會忽略非多重路徑裝置，例如 hpsa、fd、hd、md、dm、sr、scd、st、ram、raw 和 loop。例如，本地 SATA 硬碟和隨身碟沒有多重路徑。如果您希望 <command>multipath</command> 忽略單路徑裝置，請將它們加入 <command>blacklist</command> 區段中。
  </para>

  <note>
   <title>相容性</title>
   <para>
    關鍵字 <literal>devnode_blacklist</literal> 已被關鍵字 <literal>blacklist</literal> 取代。
   </para>
   <para>
    在 SUSE Linux Enterprise Server 12 中使用 glibc 提供的正規表示式。若要與任意字串相符，現在必須使用<literal>「.*」</literal>，而不是僅使用<literal>「*」</literal>。
   </para>
  </note>

  <para>
   例如，若要將本地裝置與 <filename>hpsa</filename> 驅動程式中的所有陣列列入黑名單，以免受到多重路徑的管理，則 <command>blacklist</command> 區段應為︰
  </para>

<screen>blacklist {
      wwid "26353900f02796769"
      devnode "^(ram|raw|loop|fd|md|dm-|sr|scd|st)[0-9]*"
      devnode "^sd[a-z][0-9]*"
}</screen>

  <para>
   您也可以只將驅動程式中的分割區 (而不是整個陣列) 列入黑名單。例如，您可以使用以下正規表示式，只將 cciss 驅動程式中的分割區而非整個陣列列入黑名單︰
  </para>

<screen>blacklist {
      devnode "^cciss!c[0-9]d[0-9]*[p[0-9]*]"
}</screen>

  <para>
   您可以在 blacklist 中新增 <literal>device</literal> 區段，並使用 <literal>vendor</literal> 和 <literal>product</literal> 關鍵字，按特定裝置類型列入黑名單。
  </para>

<screen>blacklist {
      device {
           vendor  "DELL"
           product ".*"
       }
}</screen>

  <para>
   您可以使用 <literal>blacklist_exceptions</literal> 區段，對透過 <literal>blacklist</literal> 區段中所用的正規表示式列入黑名單的一些裝置啟用多重路徑。您可以透過 WWID (<literal>wwid</literal> 關鍵字)、裝置名稱 (<literal>devnode</literal> 關鍵字) 或裝置類型 (<literal>device</literal> 區段) 新增例外。您必須以將相應裝置列入黑名單的相同方式指定例外。也就是說，<literal>wwid</literal> 例外適用於 <literal>wwid</literal> 黑名單，<literal>devnode</literal> 例外適用於 <literal>devnode</literal> 黑名單，而裝置類型例外適用於裝置類型黑名單。
  </para>

  <para>
   例如，如果您擁有來自不同廠商的裝置類型，可以針對所需的裝置類型啟用多重路徑。在 <literal>blacklist</literal> 區段中將所有廠商的裝置類型列入黑名單，然後在 <literal>blacklist_exceptions</literal> 區段中新增 <literal>device</literal> 區段，針對所需的裝置類型啟用多重路徑。
  </para>

<screen>blacklist {
      devnode "^(ram|raw|loop|fd|md|dm-|sr|scd|st|sda)[0-9]*"
      device {
           vendor  "DELL"
           product ".*"
       }
}

blacklist_exceptions {
      device {
           vendor  "DELL"
           product "MD3220i"
       }
}</screen>

  <para>
   您還可以使用 blacklist_exceptions 僅針對特定裝置啟用多重路徑。例如︰
  </para>

<screen>blacklist {
      wwid ".*"
}

blacklist_exceptions {
        wwid "3600d0230000000000e13955cc3751234"
        wwid "3600d0230000000000e13955cc3751235"
}</screen>


  <para>
   修改 <filename>/etc/multipath.conf</filename> 檔案後，必須在系統上執行 <command>dracut</command> <option>-f</option> 重新建立 <filename>initrd</filename>，然後重新啟動伺服器，變更才會生效。如需詳細資料，請參閱<xref linkend="sec.multipath.conf_file.apply"/>。
  </para>

  <para>
   重新開機之後，當您發出 <command>multipath -ll</command> 指令時，這些本地裝置應不再列於多重路徑映射中。
  </para>

  <note>
   <title>使用 <literal>find_multipaths</literal> 選項</title>
   <para>
    從 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 12 SP2 開始，多重路徑工具支援 <filename>/etc/multipath.conf</filename> 中 <literal>defaults</literal> 區段內的 <literal>find_multipaths</literal> 選項。簡而言之，此選項會阻止多重路徑和 <systemitem class="daemon">multipathd</systemitem> 為只有單個路徑的裝置設定多重路徑映射 (如需詳細資料，請參閱 <command>man 5 multipath.conf</command>)。如此，在某些組態中，管理員就無需為本地 SATA 磁碟等建立黑名單項目。
   </para>
   <para>
    雖然使用 <literal>find_multipaths</literal> 選項看似很方便，但也有其弊端。它使得系統開機複雜化且速度變慢，因為對於發現的每部裝置，開機邏輯都需要等到探查了所有裝置之後才能確定裝置是否存在第二個路徑。此外，當一些路徑已關閉或在開機期間不可視時可能會出現問題 — 可能會錯誤地將裝置偵測為單路徑裝置並啟動，導致以後新增更多路徑的操作失敗。
   </para>
   <para>
    <literal>find_multipaths</literal> 會將 <filename>/etc/multipath/wwids</filename> 中所列的具有相符 WWID 的所有裝置視為多重路徑裝置。在第一次啟用 <literal>find_multipaths</literal> 時，以下這一點非常重要︰除非刪除或編輯了 <filename>/etc/multipath/wwids</filename>，否則啟用此選項沒有任何效果，因為所有先前存在的多重路徑映射 (包括單路徑映射) 都列於該 wwids 檔案中。在具有多重路徑根檔案系統的 SAN-boot 系統中，務必確認 <filename>/etc/multipath/wwids</filename> 在初始 RAM 磁碟與檔案系統之間保持同步。
   </para>
   <para>
    總而言之，使用 <literal>find_multipaths</literal> 在某些使用案例中可能很方便，但是 SUSE 仍建議使用正確設定了黑名單和黑名單例外的預設組態。
   </para>
  </note>

 </sect1>
 <sect1 xml:id="sec.multipath.names">
  <title>設定使用者易記的名稱或別名</title>

  <para>
   多重路徑裝置可透過其 WWID、使用者易記的名稱或您為其指定的別名來識別。<filename>/dev/sdn</filename> 和 <filename>/dev/dm-n</filename> 格式的裝置節點名稱可在重新開機時變更，並且每次可能都會指定給不同的裝置。裝置的 WWID、使用者易記的名稱和別名在重新開機期間始終不變，因此是識別裝置的最好方法。
  </para>

  <important>
   <title>建議使用永久的名稱</title>
   <para>
    由於以 <filename>/dev/sdn</filename> 與 <filename>/dev/dm-n</filename> 形式表示的裝置節點名稱會在系統重新開機時變更，因此最好使用其 WWID 來參考多重路徑裝置。此外，您還可以使用對應至 WWID 的使用者易記名稱或別名，以便在重新開機時唯一識別裝置。
   </para>
  </important>

  <para>
   下表介紹了 <filename>/etc/multipath.conf</filename> 檔案中可用於裝置的裝置名稱類型。如需 <filename>multipath.conf</filename> 設定的範例，請參閱 <filename>/usr/share/doc/packages/multipath-tools/multipath.conf.synthetic</filename> 檔案。
  </para>

  <table>
   <title>多重路徑裝置名稱類型比較</title>
   <tgroup cols="2">
    <colspec colnum="1" colname="1" colwidth="1667*"/>
    <colspec colnum="2" colname="2" colwidth="8334*"/>
    <thead>
     <row>
      <entry>
       <para>
        名稱類型
       </para>
      </entry>
      <entry>
       <para>
        描述
       </para>
      </entry>
     </row>
    </thead>
    <tbody>
     <row>
      <entry>
       <para>
        WWID (預設)
       </para>
      </entry>
      <entry>
       <para>
        序列 WWID (全球識別碼) 是多重路徑裝置的識別碼，保證其全球唯一，永不變更。多重路徑中使用的預設名稱是邏輯單位的 ID，就是 <filename>/dev/disk/by-id</filename> 目錄中存放的 ID。例如，WWID 為 <literal>3600508e0000000009e6baa6f609e7908</literal> 的裝置列為 <filename>/dev/disk/by-id/scsi-3600508e0000000009e6baa6f609e7908</filename>。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        使用者易記
       </para>
      </entry>
      <entry>
       <para>
        <filename>/dev/mapper</filename> 目錄中的「裝置對應程式多重路徑」裝置名稱還參考了邏輯單位的 ID。這些多重路徑裝置名稱是使用者易記名稱，採用的格式為 <filename>/dev/mapper/mpath&lt;<replaceable>n</replaceable></filename>&gt;，例如 <filename>/dev/mapper/mpath0</filename>。這些名稱是唯一且永久的，因為它們使用 <filename>/var/lib/multipath/bindings</filename> 檔案來追蹤 UUID 與易記名稱之間的關聯。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        別名
       </para>
      </entry>
      <entry>
       <para>
        別名是管理員為多重路徑裝置指定的全域唯一名稱。別名會置換 WWID 及使用者易記的 <filename>/dev/mapper/mpath<replaceable>N</replaceable></filename> 名稱。
       </para>
       <para>
        如果您使用的是 user_friendly_names，請不要將別名設為 mpath<replaceable>N</replaceable> 格式。否則可能會與自動指定的使用者易記名稱產生衝突，導致提供的裝置節點名稱不正確。
       </para>
      </entry>
     </row>
    </tbody>
   </tgroup>
  </table>

  <para>
   <filename>/etc/multipath.conf</filename> 檔案中的全域多重路徑 <literal>user_friendly_names</literal> 選項用於啟用或停用對多重路徑裝置使用易記名稱的功能。如果將它設定為 <literal>no</literal> (預設值)，多重路徑會使用 WWID 做為裝置的名稱。如果將它設定為 <literal>yes</literal>，多重路徑會使用 <filename>/var/lib/multipath/bindings</filename> 檔案，以 <filename>/dev/mapper</filename> 目錄中的 <filename>mpath&lt;<replaceable>n</replaceable>&gt;</filename> 格式為裝置指定永久且唯一的名稱。<literal>/etc/multipath.conf</literal> 檔案中的 <literal>bindings file</literal> 選項可用於指定 <filename>bindings</filename> 檔案的替代位置。
  </para>

  <para>
   <filename>/etc/multipath.conf</filename> 檔案中的全域多重路徑 <literal>alias</literal> 選項用於明確地為裝置指定名稱。如果為多重路徑裝置設定了別名，則會使用別名而不是 WWID 或易記名稱。
  </para>

  <para>
   在下列情況下，使用 <literal>user_friendly_names</literal> 選項可能會產生問題︰
  </para>

  <variablelist>
   <varlistentry>
    <term>根裝置正在使用多重路徑︰</term>
    <listitem>
     <para>
      如果系統根裝置正在使用多重路徑，而您使用了 <literal>user_friendly_names</literal> 選項，則會將 <filename>/var/lib/multipath/bindings</filename> 檔案中的使用者易記設定包含在 <filename>initrd</filename> 中。如果您之後變更儲存設定，例如新增或移除裝置，則 <filename>initrd</filename> 中的繫結設定會與 <filename>/var/lib/multipath/bindings</filename> 中的繫結設定不符。
     </para>
     <warning>
      <title>繫結不相符項目</title>
      <para>
       <filename>initrd</filename> 與 <filename>/var/lib/multipath/bindings</filename> 之間的繫結不符會導致將錯誤的掛接點指定給裝置，進而造成檔案系統損毀及資料遺失。
      </para>
     </warning>
     <para>
      為了避免此問題發生，建議您對系統根裝置使用預設 WWID 設定。請勿將別名用於系統根裝置。裝置名稱將會不同，因此使用別名會使您失去透過核心指令行順利關閉多重路徑的功能。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>從另一個分割區掛接 /var︰</term>
    <listitem>
     <para>
      <literal>user_friendly_names</literal> 組態檔案的預設位置是 <filename>/var/lib/multipath/bindings</filename>。如果 <filename>/var</filename> 資料不在系統根裝置上，而是從另一個分割區掛接，則設定多重路徑時無法獲取 <filename>bindings</filename> 檔案。
     </para>
     <para>
      請確定 <filename>/var/lib/multipath/bindings</filename> 檔案位於系統根裝置上，並且多重路徑可以找到它。例如，可以按如下所示操作︰
     </para>
     <orderedlist spacing="normal">
      <listitem>
       <para>
        將 <filename>/var/lib/multipath/bindings</filename> 檔案移至 <filename>/etc/multipath/bindings</filename>。
       </para>
      </listitem>
      <listitem>
       <para>
        將 /<filename>etc/multipath.conf</filename> 之 <literal>defaults</literal> 區段中的 <literal>bindings_file</literal> 選項設定為這個新位置。例如︰
       </para>
<screen>
defaults {
               user_friendly_names yes
               bindings_file "/etc/multipath/bindings"
}
</screen>
      </listitem>
     </orderedlist>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term>initrd 中存在多重路徑︰</term>
    <listitem>
     <para>
      即使系統根裝置不在多重路徑上，<filename>initrd</filename> 中也有可能包含多重路徑。例如，如果系統根裝置位於 LVM 上，便可能會出現這種情況。如果您使用 <literal>user_friendly_names</literal> 選項並且 <filename>initrd</filename> 中存在多重路徑，則應該使用參數 <command>multipath=off</command> 開機，以免發生問題。
     </para>
     <para>
      這會在系統開機期間於 <filename>initrd</filename> 中停用多重路徑。系統開機之後，<filename>boot.multipath</filename> 與 <filename>multipathd</filename> 開機程序檔便能啟用多重路徑。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>HA 叢集中的多重路徑︰</term>
    <listitem>
     <para>
      如需詳細資料，請參閱<xref linkend="sec.multipath.names.ha"/>。
     </para>
    </listitem>
    </varlistentry>
  </variablelist>

  <para>
   若要啟用使用者易記名稱或指定別名︰
  </para>

  <procedure>
   <step>
    <para>
     使用 <systemitem class="username">root</systemitem> 權限在文字編輯器中開啟 <filename>/etc/multipath.conf</filename> 檔案。
    </para>
   </step>
   <step>
    <para>
     (選擇性) 修改 <filename>/var/lib/multipath/bindings</filename> 檔案的位置。
    </para>
    <para>
     替代路徑必須是系統根裝置上可存取的位置，並且多重路徑必須能夠找到它。
    </para>
    <substeps performance="required">
     <step>
      <para>
       將 <filename>/var/lib/multipath/bindings</filename> 檔案移至 <filename>/etc/multipath/bindings</filename>。
      </para>
     </step>
     <step>
      <para>
       將 /<filename>etc/multipath.conf</filename> 之 <literal>defaults</literal> 區段中的 <literal>bindings_file</literal> 選項設定為這個新位置。例如︰
      </para>
<screen>
defaults {
          user_friendly_names yes
          bindings_file "/etc/multipath/bindings"
}
</screen>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     (選擇性，但不建議) 啟用使用者易記的名稱︰
    </para>
    <substeps performance="required">
     <step>
      <para>
       取消 <literal>Defaults</literal> 區段及其結束括號的註解。
      </para>
     </step>
     <step>
      <para>
       取消 <literal>user_friendly_names option</literal> 的註解，然後將「否」值變更為「是」。
      </para>
      <para>
       例如︰
      </para>
<screen>## Use user-friendly names, instead of using WWIDs as names.
defaults {
  user_friendly_names yes
}</screen>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     (選擇性) 在 <command>multipath</command> 區段中使用 <command>alias</command> 選項，為裝置指定您自己的名稱。
    </para>
    <para>
     例如︰
    </para>
<screen>## Use alias names, instead of using WWIDs as names.
multipaths {
       multipath {
               wwid           36006048000028350131253594d303030
               alias             blue1
       }
       multipath {
               wwid           36006048000028350131253594d303041
               alias             blue2
       }
       multipath {
               wwid           36006048000028350131253594d303145
               alias             yellow1
       }
       multipath {
               wwid           36006048000028350131253594d303334
               alias             yellow2
       }
}
</screen>
    <important>
     <title>WWWID 與 WWN 的比較</title>
     <para>
      在 <filename>/etc/multipath.conf</filename> 檔案中定義裝置別名時，請確定使用的是每個裝置的 WWID (例如 <filename>3600508e0000000009e6baa6f609e7908</filename>) 而不是其 WWN，後者會以 <filename>0x</filename> 取代裝置 ID 的第一個字元，例如 <filename>0x600508e0000000009e6baa6f609e7908</filename>。
     </para>
    </important>
   </step>
   <step>
    <para>
     儲存變更，然後關閉檔案。
    </para>
   </step>
   <step>
    <para>
     修改 <filename>/etc/multipath.conf</filename> 檔案後，必須在系統上執行 <command>dracut</command> <option>-f</option> 重新建立 <filename>initrd</filename>，然後重新啟動伺服器，變更才會生效。如需詳細資料，請參閱<xref linkend="sec.multipath.conf_file.apply"/>。
    </para>
   </step>
  </procedure>

  <para>
   如果您要直接使用整個 LUN (例如，若您使用 SAN 功能分割您的儲存區)，可為 <command>mkfs</command>、<command>fstab</command>、您的應用程式等使用 <filename>/dev/disk/by-id/xxx</filename> 名稱。分割的裝置會將 <filename>_part&lt;n&gt;</filename> 附加到裝置名稱中，例如 <filename>/dev/disk/by-id/xxx_part1</filename>。
  </para>

  <para>
   在 <filename>/dev/disk/by-id</filename> 目錄中，多重路徑對應裝置會以裝置的 <filename>dm-uuid*</filename> 名稱或別名 (如果在 <filename>/etc/multipath.conf</filename> 檔案中為它指定了別名) 表示。<filename>scsi-</filename> 與 <filename>wwn-</filename> 裝置名稱表示裝置的實體路徑。
  </para>

  <sect2 xml:id="sec.multipath.names.ha">
   <title>HA 叢集中的多重路徑裝置名稱</title>
   <para>
    請執行下列操作，來確保多重路徑裝置名稱在所有裝置中都相同︰
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      使用 UUID 及別名來確保多重路徑裝置名稱在叢集中的所有節點上都保持一致。別名在所有節點中必須是唯一的。將 <filename>/etc/multipath.conf</filename> 檔案從該節點複製到叢集中所有其他節點的 <filename>/etc/</filename> 目錄下。
     </para>
    </listitem>
    <listitem>
     <para>
      使用多重路徑對應裝置的連結時，請確定在 <filename>/dev/disk/by-id</filename> 目錄中指定 <filename>dm-uuid*</filename> 名稱或別名，而不是裝置的固定路徑例項。如需更多資訊，請參閱<xref linkend="sec.multipath.names" xrefstyle="SectTitleOnPage"/>。
     </para>
    </listitem>
    <listitem>
     <para>
      將 <literal>user_friendly_names</literal> 組態選項設為 <literal>no</literal> 以將其停用。使用者易記的名稱對於某個節點而言是唯一的，但是叢集中的每個節點可能無法為裝置指定相同的使用者易記名稱。
     </para>
    </listitem>
   </itemizedlist>
   <note>
    <title>使用者易記名稱</title>
    <para>
     如果您確實需要使用使用者易記名稱，則可以執行下列操作，強制系統定義的使用者易記名稱在叢集中的所有節點上都保持一致︰
    </para>
    <procedure>
     <step>
      <para>
       在一個節點上的 <filename>/etc/multipath.conf</filename> 檔案中︰
      </para>
      <orderedlist>
       <listitem>
        <para>
         將 <literal>user_friendly_names</literal> 組態選項設為 <literal>yes</literal> 以將其啟用。
        </para>
        <para>
         多重路徑會使用 <filename>/var/lib/multipath/bindings</filename> 檔案為 <filename>/dev/mapper</filename> 目錄中的裝置指定一個永久且唯一的名稱，格式為 <filename>mpath&lt;<replaceable>n</replaceable>&gt;</filename>。
        </para>
       </listitem>
       <listitem>
        <para>
         (選擇性) 設定 <literal>/etc/multipath.conf</literal> 檔案之 <literal>defaults</literal> 區段中的 <literal>bindings_file</literal> 選項，以指定 <filename>bindings</filename> 檔案的替代位置。
        </para>
        <para>
         預設位置為 <filename>/var/lib/multipath/bindings</filename>。
        </para>
       </listitem>
      </orderedlist>
     </step>
     <step>
      <para>
       設定節點上的所有多重路徑裝置。
      </para>
     </step>
     <step>
      <para>
       將 <filename>/etc/multipath.conf</filename> 檔案從該節點複製到叢集中所有其他節點的 <filename>/etc/</filename> 目錄下。
      </para>
     </step>
     <step>
      <para>
       將 <filename>bindings</filename> 檔案從該節點複製到叢集中所有其他節點上的 <filename>bindings_file</filename> 路徑中。
      </para>
     </step>
     <step>
      <para>
       修改 <filename>/etc/multipath.conf</filename> 檔案後，必須在系統上執行 <command>dracut</command> <option>-f</option> 重新建立 <filename>initrd</filename>，然後重新啟動節點，變更才會生效。如需詳細資料，請參閱<xref linkend="sec.multipath.conf_file.apply"/>。這適用於所有受影響的節點。
      </para>
     </step>
    </procedure>
   </note>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.multipath.policies_failover">
  <title>設定路徑容錯移轉規則與優先程度</title>

  <para>
   在 Linux 主機上，若一個儲存控制器有多個路徑，則每個路徑會顯示為獨立的區塊裝置，導致單個 LUN 有多個區塊裝置。裝置對應程式多重路徑服務會偵測到多個路徑具有同一個 LUN ID，然後會使用該 ID 建立新的多重路徑裝置。例如，若主機上有兩個 HBA 透過未分區的光纖通道交換器連接至具有兩個連接埠的某個儲存控制器，則該主機會探查到四個區塊裝置，即 <filename>/dev/sda</filename>、<filename>/dev/sdb</filename>、<filename>/dev/sdc</filename> 與 <filename>/dev/sdd</filename>。裝置對應程式多重路徑服務會建立單個區塊裝置 <filename>/dev/mpath/mpath1</filename>，由它來透過以上 4 個基礎區塊裝置重新路由 I/O。
  </para>

  <para>
   本節說明如何指定容錯移轉的規則及如何設定路徑的優先程度。請注意，修改 <filename>/etc/multipath.conf</filename> 檔案後，必須在系統上執行 <command>dracut</command> <option>-f</option> 重新建立 <filename>initrd</filename>，然後重新啟動伺服器，變更才會生效。如需詳細資料，請參閱<xref linkend="sec.multipath.conf_file.apply"/>。
  </para>

  <sect2 xml:id="sec.multipath.policies_failover.path">
   <title>設定路徑容錯移轉規則</title>
   <para>
    搭配 <option>-p</option> 選項使用 <command>multipath</command> 指令可設定路徑容錯移轉規則︰
   </para>
<screen>sudo multipath <replaceable>devicename</replaceable> -p <replaceable>policy</replaceable></screen>
   <para>
    用以下其中一個規則選項取代 <replaceable>policy</replaceable>︰
   </para>
   <table>
    <title>multipath -p 指令的群組規則選項</title>
    <tgroup cols="2">
     <colspec colnum="1" colname="1" colwidth="2381*"/>
     <colspec colnum="2" colname="2" colwidth="7620*"/>
     <thead>
      <row>
       <entry>
        <para>
         規則選項
        </para>
       </entry>
       <entry>
        <para>
         描述
        </para>
       </entry>
      </row>
     </thead>
     <tbody>
      <row>
       <entry>
        <para>
         failover
        </para>
       </entry>
       <entry>
        <para>
         (預設) 每個優先程度群組對應一個路徑。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         multibus
        </para>
       </entry>
       <entry>
        <para>
         所有路徑都在一個優先程度群組中。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         group_by_serial
        </para>
       </entry>
       <entry>
        <para>
         每個偵測到的序號對應一個優先程度群組。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         group_by_prio
        </para>
       </entry>
       <entry>
        <para>
         每個路徑優先程度值對應一個優先程度群組。優先程度由註標程式決定，在 <filename>/etc/multipath.conf</filename> 組態檔案中指定為 global、per-controller 或 per-multipath 選項。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         group_by_node_name
        </para>
       </entry>
       <entry>
        <para>
         每個目標節點名稱對應一個優先程度群組。目標節點名稱取自 <filename>/sys/class/fc_transport/target*/node_name</filename> 位置。
        </para>
       </entry>
      </row>
     </tbody>
    </tgroup>
   </table>
  </sect2>

  <sect2 xml:id="sec.multipath.policies_failover.prio">
   <title>設定容錯移轉優先程度</title>
   <para>
    您必須在 <filename>/etc/multipath.conf</filename> 檔案中手動輸入裝置的容錯移轉優先程度。<filename>/usr/share/doc/packages/multipath-tools/multipath.conf.annotated</filename> 檔案中提供了所有設定與選項的範例。
   </para>
   <sect3 xml:id="sec.multipath.policies_failover.prio.info">
    <title>瞭解優先程序群組與屬性</title>
    <para>
     <emphasis>優先程度群組</emphasis>是進入相同實體 LUN 的路徑集合。依預設，I/O 以輪替方式發佈到群組的所有路徑。<command>multipath</command> 指令會根據 SAN 的 path_grouping_policy 設定，在該 SAN 中自動為每個 LUN 建立優先程度群組。<literal/><command>multipath</command> 指令會將群組中路徑的數量乘以群組的優先程度，來決定哪個群組為主要群組。計算值最高的群組為主要群組。主要群組中的所有路徑都失敗時，計算值次高的優先程度群組成為主動群組。
    </para>
    <para>
     <emphasis>路徑優先程度</emphasis>是指定給路徑的整數值。值越大，優先程度越高。系統使用了外部程式來指定每個路徑的優先程度。對於指定的裝置，優先程度相同的路徑屬於同一個優先程度群組。
    </para>
    <para>
     <literal>prio</literal> 設定在 <filename>/etc/multipath.conf</filename> 檔案的 <literal>defaults{}</literal> 或 <literal>devices{}</literal> 區段中使用。當為 <literal>multipaths{)</literal> 區段中的個別 <literal>multipath</literal> 定義指定該設定時，系統會靜默地將其忽略。<literal>prio</literal> 行會指定優先程度排序器。如果優先程度排序器需要引數，您可以在另一行上使用 <literal>prio_args</literal> 關鍵字來指定該引數。
    </para>
    <bridgehead>Defaults 或 Devices 區段的 PRIO 設定</bridgehead>
    <variablelist>
     <varlistentry>
      <term>prio</term>
      <listitem>
       <para>
        指定要呼叫以取得路徑優先程度值的優先程度排序程式。系統會將每個路徑群組的權數加總，以判斷發生故障時要使用的下一個路徑群組。
       </para>
       <para>
        如果指定的優先程度排序器需要引數，請使用 <literal>prio_args</literal> 關鍵字進行指定。
       </para>
       <para>
        如果未指定任何 <literal>prio</literal> 關鍵字，則所有路徑的優先程度均相等。預設設定為 <literal>const</literal>，且 <literal>prio_args</literal> 設定沒有值。
       </para>
<screen>prio "const"
prio_args ""</screen>
       <para>
        優先程度排序器範例如下︰
       </para>
       <informaltable>
        <tgroup cols="2">
         <colspec colnum="1" colname="1" colwidth="2907*"/>
         <colspec colnum="2" colname="2" colwidth="7096*"/>
         <thead>
          <row>
           <entry>
            <para>
             優先程度排序程式
            </para>
           </entry>
           <entry>
            <para>
             描述
            </para>
           </entry>
          </row>
         </thead>
         <tbody>
          <row>
           <entry>
            <para>
             <literal>alua</literal>
            </para>
           </entry>
           <entry>
            <para>
             根據 SCSI-3 ALUA 設定產生路徑優先程度。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>const</literal>
            </para>
           </entry>
           <entry>
            <para>
             為所有路徑產生相同的優先程度。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>emc</literal>
            </para>
           </entry>
           <entry>
            <para>
             為 EMC 陣列產生路徑優先程度。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>hdc</literal>
            </para>
           </entry>
           <entry>
            <para>
             為 Hitachi HDS Modular 儲存陣列產生路徑優先程度。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>hp_sw</literal>
            </para>
           </entry>
           <entry>
            <para>
             為主動/待命模式下的 Compaq/HP 控制器產生路徑優先程度。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>ontap</literal>
            </para>
           </entry>
           <entry>
            <para>
             為 NetApp 陣列產生路徑優先程度。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>random</literal>
            </para>
           </entry>
           <entry>
            <para>
             為每個路徑產生隨機優先程度。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>rdac</literal>
            </para>
           </entry>
           <entry>
            <para>
             為 LSI/Engenio RDAC 控制器產生路徑優先程度。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>weightedpath</literal>
            </para>
           </entry>
           <entry>
            <para>
             根據在 <literal>prio_args</literal> 的引數中所指定的權數值，產生路徑優先程度，例如︰
            </para>
<screen>[hbtl|devname] <replaceable>regex1</replaceable> <replaceable>prio1</replaceable> <replaceable>regex2</replaceable> <replaceable>prio2</replaceable>...</screen>
            <para>
             <literal>hbtl regex</literal> 引數格式會使用含有權數值的 SCSI <literal>H:B:T:L</literal> 表示法 (例如 <literal>1:0:.:.</literal> 與 <literal>*:0:0:.</literal>)，其中 H、B、T、L 分別指裝置的主機、匯流排、目標和 LUN ID。例如︰
            </para>
<screen>prio "weightedpath"
prio_args "hbtl 1:.:.:. 2 4:.:.:. 4"</screen>
            <para>
             <literal>devname</literal> 規則運算式引數格式使用每個裝置的裝置節點名稱與權數值。例如︰
            </para>
<screen>prio "weightedpath"
prio_args "devname sda 50 sde 10 sdc 50 sdf 10"</screen>
           </entry>
          </row>
         </tbody>
        </tgroup>
       </informaltable>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>prio_args</literal>
      </term>
      <listitem>
       <para>
        指定需要引數之指定優先程度排序程式的引數。大多數 <literal>prio</literal> 程式都不需要引數。
       </para>
       <para>
        沒有預設值。該值取決於 <literal>prio</literal> 設定以及優先程度排序器是否需要引數。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <bridgehead>多重路徑屬性</bridgehead>
    <para>
     多重路徑屬性用於控制裝置的多重路徑 I/O 行為。您可以將屬性指定為所有多重路徑裝置的預設值。此外，還可以指定僅套用至指定多重路徑裝置的屬性，方法是在多重路徑組態檔案的 <literal>multipaths</literal> 區段中為該裝置建立一個項目。
    </para>
    <variablelist>
     <varlistentry>
      <term><literal>user_friendly_names</literal>
      </term>
      <listitem>
       <para>
        指定是使用全球 ID (WWID) 還是使用 <filename>/var/lib/multipath/bindings</filename> 檔案為多重路徑裝置指定格式為 <filename>/dev/mapper/mpathN</filename>、永久且唯一的別名。
       </para>
       <para>
        此選項可以在 <literal>devices</literal> 區段和 <literal>multipaths</literal> 區段中使用。
       </para>
       <informaltable>
        <tgroup cols="2">
         <colspec colnum="1" colname="1" colwidth="2642*"/>
         <colspec colnum="2" colname="2" colwidth="7360*"/>
         <thead>
          <row>
           <entry>
            <para>
             值
            </para>
           </entry>
           <entry>
            <para>
             描述
            </para>
           </entry>
          </row>
         </thead>
         <tbody>
          <row>
           <entry>
            <para>
             <literal>no</literal>
            </para>
           </entry>
           <entry>
            <para>
             (預設) 使用 <filename>/dev/disk/by-id/</filename> 位置中所顯示的 WWID。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>yes</literal>
            </para>
           </entry>
           <entry>
            <para>
             自動產生易記名稱做為多重路徑裝置的別名來取代實際的 ID。
            </para>
           </entry>
          </row>
         </tbody>
        </tgroup>
       </informaltable>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="failback">
      <term><literal>failback</literal>
      </term>
      <listitem>
       <para>
        指定是否監控失敗路徑的復原狀況，並指出失敗路徑恢復使用後群組進行錯誤回復所花的時間。
       </para>
       <para>
        失敗路徑復原後，系統會依據此設定將該路徑重新新增到啟用了多重路徑的路徑清單中。多重路徑會評估優先程度群組，並在主要路徑的優先程度高於次要群組時，變更主動優先程度群組。
       </para>
       <informaltable>
        <tgroup cols="2">
         <colspec colnum="1" colname="1" colwidth="2642*"/>
         <colspec colnum="2" colname="2" colwidth="7360*"/>
         <thead>
          <row>
           <entry>
            <para>
             值
            </para>
           </entry>
           <entry>
            <para>
             描述
            </para>
           </entry>
          </row>
         </thead>
         <tbody>
          <row>
           <entry>
            <para>
             <literal>manual</literal>
            </para>
           </entry>
           <entry>
            <para>
             (預設) 不監控失敗路徑的復原狀況。管理員會執行 <command>multipath</command> 指令來更新已啟用的路徑與優先程度群組。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>immediate</literal>
            </para>
           </entry>
           <entry>
            <para>
             某路徑復原後，立即啟用該路徑。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal><replaceable>N</replaceable></literal>
            </para>
           </entry>
           <entry>
            <para>
             某路徑復原後，等待 <replaceable>N</replaceable> 秒後再啟用此路徑。指定一個大於 0 的整數值。
            </para>
           </entry>
          </row>
         </tbody>
        </tgroup>
       </informaltable>
       <para>
        對於叢集環境中的多重路徑，建議將錯誤回復設為 <literal>manual</literal>，以防止多重路徑容錯移轉發生乒乓效應。
       </para>
<screen>failback "manual"</screen>
       <important>
        <title>確認</title>
        <para>
         請務必向儲存系統廠商確認錯誤回復設定。不同的儲存系統可能需要不同的設定。
        </para>
       </important>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="no_path_retry">
      <term><literal>no_path_retry</literal>
      </term>
      <listitem>
       <para>
        指定路徑失敗時要採取的行為。
       </para>
       <informaltable>
        <tgroup cols="2">
         <colspec colnum="1" colname="1" colwidth="2642*"/>
         <colspec colnum="2" colname="2" colwidth="7360*"/>
         <thead>
          <row>
           <entry>
            <para>
             值
            </para>
           </entry>
           <entry>
            <para>
             描述
            </para>
           </entry>
          </row>
         </thead>
         <tbody>
          <row>
           <entry>
            <para>
             <literal><replaceable>N</replaceable></literal>
            </para>
           </entry>
           <entry>
            <para>
             指定在 <command>multipath</command> 停止佇列且使路徑失敗之前的重試次數。指定一個大於 0 的整數值。
            </para>
            <para>
             在叢集中，您可以指定值「0」來防止排入佇列，並允許資源進行容錯移轉。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>fail</literal>
            </para>
           </entry>
           <entry>
            <para>
             指定立即失敗 (不排入佇列)。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>queue</literal>
            </para>
           </entry>
           <entry>
            <para>
             永不停止佇列 (在路徑恢復正常之前始終排入佇列)。
            </para>
           </entry>
          </row>
         </tbody>
        </tgroup>
       </informaltable>
       <para>
        在叢集中作業時，建議在 <filename>/etc/multipath.conf</filename> 檔案中將重試設定設為 <literal>fail</literal> 或 <literal>0</literal>。這會導致儲存連接中斷時，讓資源進行容錯移轉。否則，該訊息會排入佇列，而不會發生資源容錯移轉。
       </para>
<screen>no_path_retry "fail"
no_path_retry "0"</screen>
       <important>
        <title>確認</title>
        <para>
         請務必向儲存系統廠商確認重試設定。不同的儲存系統可能需要不同的設定。
        </para>
       </important>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>path_checker</literal>
      </term>
      <listitem>
       <para>
        決定路徑的狀態。
       </para>
       <informaltable>
        <tgroup cols="2">
         <colspec colnum="1" colname="1" colwidth="30%"/>
         <colspec colnum="2" colname="2" colwidth="70%"/>
         <thead>
          <row>
           <entry>
            <para>
             值
            </para>
           </entry>
           <entry>
            <para>
             描述
            </para>
           </entry>
          </row>
         </thead>
         <tbody>
          <row>
           <entry>
            <para>
             <literal>directio</literal>
            </para>
           </entry>
           <entry>
            <para>
             讀取具有直接 I/O 的第一個磁區，這對於 DASD 裝置非常有用。在 <systemitem class="daemon">systemd</systemitem> 記錄中記錄失敗訊息 (請參閱<xref linkend="cha.journalctl"/>)。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>tur</literal>
            </para>
           </entry>
           <entry>
            <para>
             將 SCSI 測試單元就緒指令發送至裝置。這是較佳設定 (若 LUN 支援)。若指令失敗，將不會在 <systemitem class="daemon">systemd</systemitem> 記錄日誌中填入訊息。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <replaceable>自訂廠商值</replaceable>
            </para>
           </entry>
           <entry>
            <para>
             有些 SAN 廠商會提供自訂 path_checker 選項︰
            </para>
            <itemizedlist mark="bullet" spacing="normal">
             <listitem>
              <formalpara>
               <title><literal>cciss_tur</literal>︰</title>
               <para>
                檢查 HP 智慧型儲存陣列的路徑狀態。
               </para>
              </formalpara>
             </listitem>
             <listitem>
              <formalpara>
               <title><literal>emc_clariion</literal>︰</title>
               <para>
                查詢 EMC Clariion EVPD 的 0xC0 頁以決定路徑狀態。
               </para>
              </formalpara>
             </listitem>
             <listitem>
              <formalpara>
               <title><literal>hp_sw</literal>:</title>
               <para>
                檢查包含主動/待命韌體之 HP 儲存陣列的路徑狀態 (Up、Down 或 Ghost)。
               </para>
              </formalpara>
             </listitem>
             <listitem>
              <formalpara>
               <title><literal>rdac</literal>:</title>
               <para>
                檢查 LSI/Engenio RDAC 儲存控制器的路徑狀態。
               </para>
              </formalpara>
             </listitem>
            </itemizedlist>
           </entry>
          </row>
         </tbody>
        </tgroup>
       </informaltable>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>path_grouping_policy</literal>
      </term>
      <listitem>
       <para>
        指定由指定控制器代管之多重路徑裝置的路徑分組規則。
       </para>
       <informaltable>
        <tgroup cols="2">
         <colspec colnum="1" colname="1" colwidth="2642*"/>
         <colspec colnum="2" colname="2" colwidth="7360*"/>
         <thead>
          <row>
           <entry>
            <para>
             值
            </para>
           </entry>
           <entry>
            <para>
             描述
            </para>
           </entry>
          </row>
         </thead>
         <tbody>
          <row>
           <entry>
            <para>
             <literal>failover</literal>
            </para>
           </entry>
           <entry>
            <para>
             (預設) 每個優先程度群組指定一個路徑，以便每次只使用一個路徑。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>multibus</literal>
            </para>
           </entry>
           <entry>
            <para>
             所有有效的路徑均屬於一個優先程度群組。流量透過群組中的所有主動路徑來保持負載平衡。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>group_by_prio</literal>
            </para>
           </entry>
           <entry>
            <para>
             每個路徑優先程度值對應一個優先程度群組。優先程度相同的路徑位於同一個優先程度群組中。優先程度由外部程式指定。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>group_by_serial</literal>
            </para>
           </entry>
           <entry>
            <para>
             路徑根據 SCSI 目標序號 (控制器節點 WWN) 來分組。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>group_by_node_name</literal>
            </para>
           </entry>
           <entry>
            <para>
             每個目標節點名稱指定一個優先程度群組。目標節點名稱取自 <filename> /sys/class/fc_transport/target*/node_name</filename> 中。
            </para>
           </entry>
          </row>
         </tbody>
        </tgroup>
       </informaltable>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>path_selector</literal>
      </term>
      <listitem>
       <para>
        指定用於負載平衡的 path-selector 演算法。
       </para>
       <informaltable>
        <tgroup cols="2">
         <colspec colnum="1" colname="1" colwidth="2642*"/>
         <colspec colnum="2" colname="2" colwidth="7360*"/>
         <thead>
          <row>
           <entry>
            <para>
             值
            </para>
           </entry>
           <entry>
            <para>
             描述
            </para>
           </entry>
          </row>
         </thead>
         <tbody>
          <row>
           <entry>
            <para>
             <literal>round-robin 0</literal>
            </para>
           </entry>
           <entry>
            <para>
             用於平衡優先程度群組中所有主動路徑之間的流量的負載平衡演算法。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>queue-length 0</literal>
            </para>
           </entry>
           <entry>
            <para>
             與 least-pending 選項類似，是一個可平衡多個路徑上進行中的 I/O 數量的動態負載平衡器。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>service-time 0</literal>
            </para>
           </entry>
           <entry>
            <para>
             (預設值) 可根據延遲情況來平衡多個路徑上之 I/O 的服務時間導向型負載平衡器。
            </para>
           </entry>
          </row>
         </tbody>
        </tgroup>
       </informaltable>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>pg_timeout</term>
      <listitem>
       <para>
        指定路徑群組逾時處理。不能指定任何值，已設定了內部預設值。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="polling_interval">
      <term><literal>polling_interval</literal>
      </term>
      <listitem>
       <para>
        指定一個路徑檢查週期結束與下一個路徑檢查週期開始之間的時間 (以秒為單位)。
       </para>
       <para>
        指定一個大於 0 的整數值。預設值為 5。請務必向儲存系統廠商確認 polling_interval 設定。不同的儲存系統可能需要不同的設定。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>rr_min_io_rq</literal>
      </term>
      <listitem>
       <para>
        在切換至目前路徑群組中的下一個路徑之前，使用基於申請的 device-mapper-multipath 指定路由至某個路徑之 I/O 申請的數量。
       </para>
       <para>
        指定一個大於 0 的整數值。預設值為 1。
       </para>
<screen>rr_min_io_rq "1"</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>rr_weight</literal>
      </term>
      <listitem>
       <para>
        指定用於計算路徑權重的方式。
       </para>
       <informaltable>
        <tgroup cols="2">
         <colspec colnum="1" colname="1" colwidth="2642*"/>
         <colspec colnum="2" colname="2" colwidth="7360*"/>
         <thead>
          <row>
           <entry>
            <para>
             值
            </para>
           </entry>
           <entry>
            <para>
             描述
            </para>
           </entry>
          </row>
         </thead>
         <tbody>
          <row>
           <entry>
            <para>
             <literal>uniform</literal>
            </para>
           </entry>
           <entry>
            <para>
             (預設) 所有路徑都擁有相同的輪替權數。
            </para>
           </entry>
          </row>
          <row>
           <entry>
            <para>
             <literal>priorities</literal>
            </para>
           </entry>
           <entry>
            <para>
             每個路徑的權重由路徑的優先程度乘以 rr_min_io_rq 設定來確定。
            </para>
           </entry>
          </row>
         </tbody>
        </tgroup>
       </informaltable>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>uid_attribute</literal>
      </term>
      <listitem>
       <para>
        提供唯一路徑識別碼的 udev 屬性。預設值為 <literal>ID_SERIAL</literal>。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="sec.multipath.policies_failover.rr">
    <title>設定輪替式負載平衡</title>
    <para>
     所有路徑都處於主動狀態。I/O 設定為在移至序列中的下一個開啟路徑之前需經過秒數的時間或數個 I/O 異動。
    </para>
   </sect3>
   <sect3 xml:id="sec.multipath.policies_failover.prio.single">
    <title>設定單一路徑容錯移轉</title>
    <para>
     優先程度最高 (設定值最低) 的單一路徑對流量而言是主動路徑。其他路徑可用於容錯移轉，但只有在發生容錯移轉時才會使用。
    </para>
   </sect3>
   <sect3 xml:id="sec.multipath.policies_failover.prio.rr_grouping">
    <title>將 I/O 路徑分組以使用輪替式負載平衡</title>
    <para>
     具有相同優先程度的多個路徑都歸入主動群組。該群組中的所有路徑都失敗時，裝置會容錯移轉至優先程度次高的群組。群組中的所有路徑以輪替式負載平衡方式共享流量負載。
    </para>
   </sect3>
  </sect2>

  <sect2 xml:id="sec.multipath.policies_failover.rtpg">
   <title>報告目標路徑群組</title>
   <para>
    使用 SCSI 報告目標連接埠群組 (<command>sg_rtpg(8)</command>) 指令。如需資訊，請參閱 <command>sg_rtpg(8)</command> 的線上文件。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.multipath.root">
  <title>設定根裝置的多重路徑 I/O</title>

  <para>
   <filename>SUSE Linux Enterprise Server</filename> 中的 <filename>/boot</filename> 和 <phrase role="productname"><phrase os="sles">/root</phrase></phrase> 可以使用並支援裝置對應程式多重路徑 I/O (DM-MPIO)。此外，YaST 安裝程式中的 YaST 磁碟分割程式支援在安裝期間啟用多重路徑。
  </para>

  <sect2 xml:id="sec.multipath.root.install">
   <title>安裝時啟用多重路徑 I/O</title>
   <para>
    若要在多重路徑裝置上安裝作業系統，則安裝過程中多重路徑軟體必須處於執行中狀態。在系統安裝過程中，<systemitem class="daemon">multipathd</systemitem> 精靈不會自動啟動。您可以使用 YaST 磁碟分割程式中的<guimenu>設定多重路徑</guimenu>選項來啟動。
   </para>
   <sect3 xml:id="sec.multipath.root.install.aa_lun">
    <title>在主動/主動多重路徑儲存 LUN 上安裝時啟用多重路徑 I/O</title>
    <procedure>
     <step>
      <para>
       安裝期間，在<guimenu>建議的分割方式</guimenu>螢幕上選擇<guimenu>進階磁碟分割程式</guimenu>。
      </para>
     </step>
     <step>
      <para>
       選取<guimenu>硬碟</guimenu>主圖示，按一下<guimenu>設定</guimenu>按鈕，然後選取<guimenu>設定多重路徑</guimenu>。
      </para>
     </step>
     <step>
      <para>
       啟動多重路徑。
      </para>
      <para>
       YaST 即會開始重新掃描磁碟，然後顯示可用的多重路徑裝置 (例如 <filename>/dev/disk/by-id/dm-uuid-mpath-3600a0b80000f4593000012ae4ab0ae65</filename>)。之後所有的處理步驟都應使用此裝置。
      </para>
     </step>
     <step>
      <para>
       按<guimenu>下一步</guimenu>繼續安裝。
      </para>
     </step>
    </procedure>
   </sect3>
   <sect3 xml:id="sec.multipath.root.install.ap_lun">
    <title>在主動/被動多重路徑儲存 LUN 上安裝時啟用多重路徑 I/O</title>
    <para>
     在系統安裝過程中，<systemitem class="daemon">multipathd</systemitem> 精靈不會自動啟動。您可以使用 YaST 磁碟分割程式中的<guimenu>設定多重路徑</guimenu>選項來啟動。
    </para>
    <para>
     若要在主動/被動多重路徑儲存 LUN 上安裝時啟用多重路徑 I/O︰
    </para>
    <procedure>
     <step>
      <para>
       安裝期間，在<guimenu>建議的分割方式</guimenu>螢幕上選擇<guimenu>進階磁碟分割程式</guimenu>。
      </para>
     </step>
     <step>
      <para>
       選取<guimenu>硬碟</guimenu>主圖示，按一下<guimenu>設定</guimenu>按鈕，然後選取<guimenu>設定多重路徑</guimenu>。
      </para>
     </step>
     <step>
      <para>
       啟動多重路徑。
      </para>
      <para>
       YaST 即會開始重新掃描磁碟，然後顯示可用的多重路徑裝置 (例如 <filename>/dev/disk/by-id/dm-uuid-mpath-3600a0b80000f4593000012ae4ab0ae65</filename>)。之後所有的處理步驟都應使用此裝置。記下裝置路徑與 UUID，稍後會用到。
      </para>
     </step>
     <step>
      <para>
       按<guimenu>下一步</guimenu>繼續安裝。
      </para>
     </step>
     <step>
      <para>
       所有設定都設好且安裝完成後，YaST 即會開始寫入開機載入程式資訊，並顯示重新啟動系統的倒數計時。請按一下<guimenu>停止</guimenu>按鈕停止倒數計時，然後按 <keycombo><keycap function="control"/><keycap function="alt"/><keycap>F5</keycap></keycombo> 存取主控台。
      </para>
     </step>
     <step>
      <para>
       使用主控台確定是否在 <filename>/boot/grub/device.map</filename> 檔案中為 <filename>hd0</filename> 項目輸入了被動路徑。
      </para>
      <para>
       執行此動作非常必要，因為安裝程序無法區分主動路徑與被動路徑。
      </para>
      <substeps performance="required">
       <step>
        <para role="intro">
         輸入以下指令，將根裝置掛接至 <filename>/mnt</filename>︰
        </para>
<screen>mount /dev/disk/by-id/<replaceable>UUID</replaceable>;_part2 /mnt</screen>
        <para>
         例如，輸入︰
        </para>
<screen>mount /dev/disk/by-id/dm-uuid-mpath-3600a0b80000f4593000012ae4ab0ae65_part2 /mnt</screen>
       </step>
       <step>
        <para>
         輸入以下指令，將開機裝置掛接至 <filename>/mnt/boot</filename>︰
        </para>
<screen>mount /dev/disk/by-id/<replaceable>UUID</replaceable>_part1 /mnt/boot</screen>
        <para>
         例如，輸入︰
        </para>
<screen>mount /dev/disk/by-id/dm-uuid-mpath-3600a0b80000f4593000012ae4ab0ae65_part2 /mnt/boot</screen>
       </step>
       <step>
        <para>
         在 <filename>/mnt/boot/grub/device.map</filename> 檔案中，確定 <filename>hd0</filename> 項目是否指向被動路徑，然後執行下列其中一項動作︰
        </para>
        <itemizedlist mark="bullet" spacing="normal">
         <listitem>
          <formalpara>
           <title>主動路徑︰</title>
           <para>
            不需要執行任何動作。跳過所有剩餘的步驟，按 <keycombo><keycap function="control"/><keycap function="alt"/><keycap>F7</keycap></keycombo> 返回 YaST 圖形環境，然後繼續安裝。
           </para>
          </formalpara>
         </listitem>
         <listitem>
          <formalpara>
           <title>被動路徑︰</title>
           <para>
            必須變更組態並重新安裝開機載入程式。
           </para>
          </formalpara>
         </listitem>
        </itemizedlist>
       </step>
      </substeps>
     </step>
     <step>
      <para role="intro">
       如果 <filename>hd0</filename> 項目指向被動路徑，請變更組態並重新安裝開機載入程式︰
      </para>
      <substeps performance="required">
       <step>
        <para role="intro">
         在主控台提示符處輸入以下指令︰
        </para>
<screen>
          mount -o bind /dev /mnt/dev
          mount -o bind /sys /mnt/sys
          mount -o bind /proc /mnt/proc
          chroot /mnt</screen>
       </step>
       <step>
        <para role="intro">
         在主控台中執行 <command>multipath -ll</command>，然後檢查輸出以尋找主動路徑。
        </para>
        <para>
         被動路徑會有 <literal>ghost</literal> 標記。
        </para>
       </step>
       <step>
        <para>
         在 <filename>/boot/grub/device.map</filename> 檔案中，將 <literal>hd0</literal> 項目變更為主動路徑並儲存變更，然後關閉檔案。
        </para>
       </step>
       <step>
        <para>
         輸入以下指令，重新安裝開機載入程式︰
        </para>
<screen>
          grub-install /dev/disk/by-id/<replaceable>UUID</replaceable>_part1 /mnt/boot</screen>
        <para>
         例如，輸入︰
        </para>
<screen>grub-install /dev/disk/by-id/dm-uuid-mpath-3600a0b80000f4593000012ae4ab0ae65_part2 /mnt/boot</screen>
       </step>
       <step>
        <para>
         輸入下列指令︰
        </para>
<screen>exit
umount /mnt/*
umount /mnt</screen>
       </step>
      </substeps>
     </step>
     <step>
      <para>
       按 <keycombo><keycap function="control"/><keycap function="alt"/><keycap>F7</keycap></keycombo> 返回 YaST 圖形環境。
      </para>
     </step>
     <step>
      <para>
       按一下<guimenu>確定</guimenu>繼續執行安裝的重新開機作業。
      </para>
     </step>
    </procedure>
   </sect3>
  </sect2>

  <sect2 xml:id="sec.multipath.root.enable_existing">
   <title>對現有根裝置啟用多重路徑 I/O</title>
   <procedure>
    <step>
     <para>
      將 Linux 安裝為僅有單個路徑處於主動狀態，最好是磁碟分割程式中列出了 <filename>by-id</filename> 符號連結的路徑。
     </para>
    </step>
    <step>
     <para>
      使用安裝期間所用的 <filename>/dev/disk/by-id</filename> 路徑來掛接裝置。
     </para>
    </step>
    <step>
     <para>
      透過新增下面一行，將 dm-multipath 新增至 <filename>/etc/dracut.conf.d/01-dist.conf</filename>︰
     </para>
<screen>force_drivers+="dm-multipath"</screen>
    </step>
    <step>
     <para>
      <remark condition="clarity">
       2014-09-05 - fs: Check if the following is still true
      </remark>對於 IBM z Systems，請在執行 <command>dracut</command> 之前先編輯 <filename>/etc/zipl.conf</filename> 檔案，以 <filename>/etc/fstab</filename> 中使用的相同 by-id 資訊變更 <filename>zipl.conf</filename> 中的 by-path 資訊。
     </para>
    </step>
    <step>
     <para>
      執行 <command>dracut </command> <option>-f</option> 以更新 <filename>initrd</filename> 影像。
     </para>
    </step>
    <step>
     <para>
      對於 IBM z Systems，請在執行 <command>dracut</command> 之後執行 <command>zipl</command>。
     </para>
    </step>
    <step>
     <para>
      重新載入伺服器。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.multipath.root.disable">
   <title>在根裝置上停用多重路徑 I/O</title>
   <para>
    將 <literal>multipath=off</literal> 新增至核心指令行。這可以透過 YaST 開機載入程式模組來完成。開啟<menuchoice> <guimenu>開機載入程式安裝</guimenu> <guimenu> 核心參數</guimenu>
    </menuchoice>，並將參數新增至兩個指令行。
   </para>
   <para>
    這只會影響根裝置，而不會影響所有其他裝置。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.multipath.raid">
  <title>設定現有軟體 RAID 的多重路徑 I/O</title>

  <para>
   理想狀況下，您應該先設定裝置的多重路徑，然後再將它們當成軟體 RAID 裝置的元件使用。如果您在建立任何軟體 RAID 裝置後再新增多重路徑，則系統重新開機時可能會先啟動 <command>multipath</command> 服務，然後再啟動 DM-MPIO 服務，導致 RAID 可能會無法使用多重路徑。您可以使用本節所述的程序，讓多重路徑針對多先前存在的軟體 RAID 執行。
  </para>

  <para>
   例如，在下列情況中，您可能需要設定軟體 RAID 中裝置的多重路徑︰
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     如果在執行全新安裝或升級期間建立新的軟體 RAID，將其做為磁碟分割設定的一部分。
    </para>
   </listitem>
   <listitem>
    <para>
     如果將軟體 RAID 中的裝置當成成員裝置或備品之前未設定裝置以進行多重路徑。
    </para>
   </listitem>
   <listitem>
    <para>
     如果透過將新的 HBA 配接器新增至伺服器，或擴充 SAN 中的儲存子系統來擴展您的系統。
    </para>
   </listitem>
  </itemizedlist>

  <note>
   <title>假設條件</title>
   <para>
    下列指示假設軟體 RAID 裝置為 <filename>/dev/mapper/mpath0</filename>，這是核心可辨識的裝置名稱。它會假設您已依照<xref linkend="sec.multipath.names" xrefstyle="HeadingOnPage"/>所述在 <filename>/etc/multipath.conf</filename> 檔案中啟用了使用者易記的名稱。
   </para>
   <para>
    請務必修改適用於軟體 RAID 之裝置名稱的指示。
   </para>
  </note>

  <procedure>
   <step>
    <para role="intro">
     開啟終端機主控台。
    </para>
    <para>
     請在下列步驟中使用此主控台輸入指令，除非導向到其他位置。
    </para>
   </step>
   <step>
    <para>
     如果目前已掛接或正在執行任何軟體 RAID 裝置，請對每個裝置輸入以下指令來卸載並停止裝置。
    </para>
<screen>sudo umount /dev/mapper/mpath0
sudo mdadm --misc --stop /dev/mapper/mpath0</screen>
   </step>
   <step>
    <para>
     輸入以下指令停止 <command>md</command> 服務︰
    </para>
<screen>sudo systemctl stop mdmonitor</screen>
   </step>
   <step>
    <para>
     輸入以下指令啟動 <systemitem class="daemon">multipathd</systemitem> 精靈︰
    </para>
<screen>systemctl start multipathd</screen>
   </step>
   <step>
    <para>
     啟動多重路徑服務之後，驗證軟體 RAID 的元件裝置是否列在 <filename>/dev/disk/by-id</filename> 目錄中。請執行下列其中一個步驟︰
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <formalpara>
       <title>裝置已列出︰</title>
       <para>
        裝置名稱現在應該有連至裝置對應程式多重路徑裝置名稱的符號連結，如 <filename>/dev/dm-1</filename>。
       </para>
      </formalpara>
     </listitem>
     <listitem>
      <formalpara>
       <title>裝置未列出︰</title>
       <para>
        輸入以下指令來衝洗和重新探查裝置，強制多重路徑服務辨識裝置︰
       </para>
      </formalpara>
<screen>sudo multipath -F
sudo multipath -v0</screen>
      <para>
       裝置現在應該列於 <filename>/dev/disk/by-id</filename> 中，並擁有連至其裝置對應程式多重路徑裝置名稱的符號連結。例如︰
      </para>
<screen>lrwxrwxrwx 1 root root 10 2011-01-06 11:42 dm-uuid-mpath-36006016088d014007e0d0d2213ecdf11 -&gt; ../../dm-1</screen>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     輸入以下指令重新啟動 <filename>mdmonitor</filename> 服務和 RAID 裝置︰
    </para>
<screen>systemctl start mdmonitor</screen>
   </step>
   <step>
    <para>
     輸入以下指令檢查軟體 RAID 的狀態︰
    </para>
<screen>mdadm --detail /dev/mapper/mpath0</screen>
    <para>
     RAID 的元件裝置應與其裝置對應程式多重路徑裝置名稱相符，這些裝置名稱在 <filename>/dev/disk/by-id</filename> 目錄中列為裝置的符號連結。
    </para>
   </step>
   <step>
    <para>
     如果根 (<filename>/</filename>) 裝置或其任何部分 (例如 <filename>/var</filename>、<filename>/etc</filename>、<filename>/log</filename>) 位於 SAN 上，並且需要使用多重路徑開機，請重建 <systemitem>initrd</systemitem>︰
    </para>
    <screen>dracut -f --add-multipath</screen>
   </step>
   <step>
    <para>
     重新開機伺服器以套用變更。
    </para>
   </step>
   <step>
    <para>
     檢查 RAID 狀態，以驗證軟體 RAID 陣列是否正確地顯示在多重路徑裝置頂部。輸入
    </para>
<screen>mdadm --detail /dev/mapper/mpath0</screen>
    <para>
     例如︰
    </para>
    <simplelist>
     <member><literal>Number Major Minor RaidDevice State</literal>
     </member>
     <member><literal>  0 253 0 0 active sync /dev/dm-0</literal>
     </member>
     <member><literal>  1 253 1 1 active sync /dev/dm-1</literal>
     </member>
     <member><literal>  2 253 2 2 active sync /dev/dm-2</literal>
     </member>
    </simplelist>
   </step>
  </procedure>

  <note>
   <title>將 mdadm 用於多重路徑裝置</title>
   <para>
    <command>mdadm</command> 工具要求以 ID 而非裝置節點路徑存取裝置。如需詳細資訊，請參閱<xref linkend="sec.multipath.mpiotools.mdadm"/>。
   </para>
  </note>
 </sect1>
 <sect1 xml:id="sec.multipath.lvm">
  <title>在多重路徑裝置上使用 LVM2</title>
  <para>LVM 預設設定為忽略多重路徑裝置的元件。雖然這很可能是您期望的行為，但也可在 <filename>/etc/lvm/lvm.conf</filename> 中變更它。如果將 multipath_component_detection 設定為 0，LVM 會掃描多重路徑元件裝置。lvm.conf 中的預設項目是︰
  </para>
<screen>    # By default, LVM2 will ignore devices used as component paths
    # of device-mapper multipath devices.
    # 1 enables; 0 disables.
    multipath_component_detection = 1</screen>
 </sect1>
 <sect1 xml:id="sec.multipath.best_practice">
  <title>最佳實務</title>

  <para/>

  <sect2 xml:id="sec.multipath.best_practice.scandev">
   <title>掃描新裝置而不重新開機</title>
   <para>
    如果您的系統已經設定多重路徑，而您稍後需要將更多儲存體新增到 SAN，則可以使用 <command>rescan-scsi-bus.sh</command> 程序檔掃描新的裝置。依預設，此程序檔會掃描所有 HBA 的一般 LUN 範圍。該指令的一般語法如下所示︰
   </para>
<screen>rescan-scsi-bus.sh [options] [host [host ...]]</screen>
   <para>
    對於大多數儲存子系統，該程序檔都可在不使用任何選項的情況下成功執行。不過，在某些特殊情況下，可能需要使用一或多個選項。如需詳細資料，請執行 <command>rescan-scsi-bus.sh --help</command>。
   </para>
   <warning>
    <title>EMC PowerPath 環境</title>
    <para>
     在 EMC PowerPath 環境中，請勿使用作業系統隨附的 <filename>rescan-scsi-bus.sh</filename> 公用程式或 HBA 廠商程序檔來掃描 SCSI 匯流排。為了避免潛在的檔案系統損毀，EMC 要求您遵循 EMC PowerPath for Linux 的廠商文件中提供的程序來操作。
    </para>
   </warning>
   <para>
    使用以下程序掃描裝置，以便在不將系統重新開機的情況下使這些裝置適用於多重路徑。
   </para>
   <procedure>
    <step>
     <para>
      在儲存子系統中，使用廠商的工具來配置裝置並更新其存取控制設定，以允許 Linux 系統存取新的儲存。如需詳細資料，請參閱廠商提供的文件。
     </para>
    </step>
    <step>
     <para>
      掃描主機的所有目標，以使 Linux 核心的 SCSI 子系統的中間層級可辨識其新裝置。在終端機主控台提示符處輸入
     </para>
<screen>sudo rescan-scsi-bus.sh</screen>
     <para>
      根據您的設定，您可能需要搭配選用參數執行 <command>rescan-scsi-bus.sh</command>。如需詳細資料，請參閱 <command>rescan-scsi-bus.sh --help</command>。
     </para>
    </step>
    <step>
     <para>
      請在 <systemitem class="daemon">systemd</systemitem> 記錄中檢查掃描進度 (如需詳細資料，請參閱<xref linkend="cha.journalctl"/>)。在終端機主控台提示符處輸入︰
     </para>
<screen>sudo journalctl -r</screen>
     <para>
      此指令會顯示記錄的最後幾行。例如︰
     </para>
<screen><prompt>tux &gt; </prompt>sudo journalctl -r
Feb 14 01:03 kernel: SCSI device sde: 81920000
Feb 14 01:03 kernel: SCSI device sdf: 81920000
Feb 14 01:03 multipathd: sde: path checker registered
Feb 14 01:03 multipathd: sdf: path checker registered
Feb 14 01:03 multipathd: mpath4: event checker started
Feb 14 01:03 multipathd: mpath5: event checker started
Feb 14 01:03:multipathd: mpath4: remaining active paths: 1
Feb 14 01:03 multipathd: mpath5: remaining active paths: 1
[...]</screen>
    </step>
    <step>
     <para>
      重複上述步驟，以新增通過 Linux 系統中連接至新裝置的其他 HBA 配接器的路徑。
     </para>
    </step>
    <step>
     <para>
      執行 <command>multipath</command> 指令辨識可設定 DM-MPIO 組態的裝置。在終端機主控台提示符處輸入
     </para>
<screen>sudo multipath</screen>
     <para>
      您現在可以設定新裝置以進行多重路徑了。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.multipath.best_practice.scanpart">
   <title>掃描新分割的裝置而不重新開機</title>
   <para>
    使用本節中的範例，可以在不重新開機的情況下偵測新增的多重路徑 LUN。
   </para>
   <warning>
    <title>EMC PowerPath 環境</title>
    <para>
     在 EMC PowerPath 環境中，請勿使用作業系統隨附的 <filename>rescan-scsi-bus.sh</filename> 公用程式或 HBA 廠商程序檔來掃描 SCSI 匯流排。為了避免潛在的檔案系統損毀，EMC 要求您遵循 EMC PowerPath for Linux 的廠商文件中提供的程序來操作。
    </para>
   </warning>
   <procedure>
    <step>
     <para>
      開啟終端機主控台。
     </para>
    </step>
    <step>
     <para>
      掃描主機的所有目標，以使 Linux 核心的 SCSI 子系統的中間層級可辨識其新裝置。在終端機主控台提示符處輸入
     </para>
<screen>rescan-scsi-bus.sh</screen>
     <para>
      根據您的設定，您可能需要搭配選用參數執行 <command>rescan-scsi-bus.sh</command>。如需詳細資料，請參閱 <command>rescan-scsi-bus.sh --help</command>。
     </para>
    </step>
    <step>
     <para>
      輸入以下指令驗證裝置是否已探查到 (例如連結是否具有一個新的時戳)︰
     </para>
<screen>ls -lrt /dev/dm-*</screen>
     <para>
      也可以輸入以下指令在 <filename>/dev/disk/by-id</filename> 中驗證裝置︰
     </para>
<screen>ls -l /dev/disk/by-id/</screen>
    </step>
    <step>
     <para>
      輸入以下指令驗證新裝置是否顯示在記錄中︰
     </para>
<screen>sudo journalctl -r</screen>
    </step>
    <step>
     <para>
      使用文字編輯器在 <filename>/etc/multipath.conf</filename> 檔案中新增裝置的新別名定義，如 <filename>data_vol3</filename>。
     </para>
     <para>
      例如，如果 UUID 為 <filename>36006016088d014006e98a7a94a85db11</filename>，請進行下列變更︰
     </para>
<screen>defaults {
     user_friendly_names   yes
  }
multipaths {
     multipath {
          wwid    36006016088d014006e98a7a94a85db11
          alias  data_vol3
          }
  }</screen>
    </step>
    <step>
     <para>
      輸入以下指令建立裝置的分割區表︰
     </para>
<screen>fdisk /dev/disk/by-id/dm-uuid-mpath-&lt;UUID&gt;</screen>
     <para>
      以裝置 WWID 取代 UUID，例如 <filename>36006016088d014006e98a7a94a85db11</filename>。
     </para>
    </step>
    <step>
     <para>
      輸入以下指令觸發 udev︰
     </para>
<screen>sudo echo 'add' &gt; /sys/block/<replaceable>dm_device</replaceable>/uevent</screen>
     <para>
      例如，若要為 <filename>dm-8</filename> 上的分割區產生裝置對應程式裝置，請輸入︰
     </para>
<screen>sudo echo 'add' &gt; /sys/block/dm-8/uevent</screen>
    </step>
    <step>
     <para>
      在裝置 <filename>/dev/disk/by-id/dm-uuid-mpath-<replaceable>UUID_partN</replaceable></filename> 上建立檔案系統。根據您選擇的檔案系統，您可以使用下列指令之一實現此目的︰<command>mkfs.btrfs</command>
      <command> mkfs.ext3</command>、<command>mkfs.ext4</command> 或 <command>mkfs.xfs</command>。如需詳細資料，請參閱相應的 man 頁面。以實際 UUID 和分割區編號取代 <filename>UUID_partN</filename>，例如 36006016088d014006e98a7a94a85db11_part1。
     </para>
    </step>
    <step>
     <para>
      輸入以下指令為新分割區建立標籤︰
     </para>
<screen>sudo tune2fs -L <replaceable>LABELNAME</replaceable> /dev/disk/by-id/dm-uuid-<replaceable>UUID_partN</replaceable>
</screen>
     <para>
      以實際 UUID 和分割區編號取代 <filename>UUID_partN</filename>，例如 36006016088d014006e98a7a94a85db11_part1。以您選擇的標籤取代 <replaceable>LABELNAME</replaceable>。
     </para>
    </step>
    <step>
     <para>
      輸入以下指令以重新設定 DM-MPIO，使其讀取別名︰
     </para>
<screen>sudo multipathd -k'reconfigure'</screen>
    </step>
    <step>
     <para>
      輸入以下指令驗證 <systemitem class="daemon">multipathd</systemitem> 是否可辨識裝置︰
     </para>
<screen>sudo multipath -ll</screen>
    </step>
    <step>
     <para>
      使用文字編輯器在 <filename>/etc/fstab</filename> 檔案中新增掛接項目。
     </para>
     <para>
      此時，您在上一步中建立的別名在 <filename>/dev/disk/by-label</filename> 目錄中尚不存在。為 <filename>/dev/dm-9</filename> 路徑新增一個掛接項目，然後在下次重新開機到以下項目之前變更該項目
     </para>
<screen>LABEL=<replaceable>LABELNAME</replaceable></screen>
    </step>
    <step>
     <para>
      建立要做為掛接點的目錄，然後掛接裝置。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.multipath.best_practice.status">
   <title>檢視多重路徑 I/O 狀態</title>
   <para>
    查詢多重路徑 I/O 狀態會輸出多重路徑映射的目前狀態。
   </para>
   <para>
    <command>multipath -l</command> 選項會顯示上次執行路徑檢查程式後目前的路徑狀態。該選項不會執行路徑檢查程式。
   </para>
   <para>
    <command>multipath -ll</command> 選項會執行路徑檢查程式，更新路徑資訊，然後顯示目前的狀態資訊。此指令永遠都會顯示路徑狀態的最新資訊。
   </para>
<screen><prompt>tux &gt; </prompt>sudo multipath -ll
3600601607cf30e00184589a37a31d911
[size=127 GB][features="0"][hwhandler="1 emc"]

\_ round-robin 0 [active][first]
  \_ 1:0:1:2 sdav 66:240  [ready ][active]
  \_ 0:0:1:2 sdr  65:16   [ready ][active]

\_ round-robin 0 [enabled]
  \_ 1:0:0:2 sdag 66:0    [ready ][active]
  \_ 0:0:0:2 sdc  8:32    [ready ][active]</screen>
   <para>
    它會針對每個裝置顯示裝置的 ID、大小、功能和硬體處理器。
   </para>
   <para>
    在探查裝置時，裝置的路徑會自動分到不同的優先程度群組。每次只有一個優先程度群組處於主動狀態。對於主動/主動組態，所有路徑都屬於同一個群組。對於主動/被動組態，被動路徑位於另外的優先程度群組中。
   </para>
   <para>
    指令會顯示每個群組的下列資訊︰
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      用於平衡群組內 I/O 的排程規則，如輪替式
     </para>
    </listitem>
    <listitem>
     <para>
      該群組是處於主動、已停用還是已啟用狀態
     </para>
    </listitem>
    <listitem>
     <para>
      該群組是否為第一個 (優先程度最高) 群組
     </para>
    </listitem>
    <listitem>
     <para>
      群組內包含的路徑
     </para>
    </listitem>
   </itemizedlist>
   <para>
    指令會顯示每個路徑的下列資訊︰
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      實體位址 <replaceable>host:bus:target:lun</replaceable>，如 1:0:1:2
     </para>
    </listitem>
    <listitem>
     <para>
      裝置節點名稱，如 <filename>sda</filename>
     </para>
    </listitem>
    <listitem>
     <para>
      Major:minor 號碼
     </para>
    </listitem>
    <listitem>
     <para>
      裝置的狀態
     </para>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="sec.multipath.best_practice.io_error">
   <title>在出錯狀況下管理 I/O</title>
   <para>
    如果所有路徑同時失敗，您可能需要啟用 queue_if_no_path 設定多重路徑，以將 I/O 排入佇列。如果不啟用，I/O 便會在所有路徑都失敗時立即失敗。在驅動程式、HBA 或光纖出現假性錯誤，且這類錯誤會導致所有路徑遺失的特定情況下，應將 DM-MPIO 設定為將所有 I/O 排入佇列，且永不向上傳播錯誤。
   </para>
   <para>
    在叢集中使用多重路徑裝置時，您可以選擇停用 queue_if_no_path。如此，系統就不會將 I/O 排入佇列，而是自動使路徑失效，並會將 I/O 錯誤升級，產生叢集資源容錯移轉。
   </para>
   <para>
    啟用 queue_if_no_path 會導致 I/O 在有路徑重新啟用之前無限期地排入佇列，因此請確定 <command>multipathd</command> 正在執行，且對您的情況有效。否則，在重新開機或手動返回到容錯移轉以取代佇列之前，I/O 可能會無限期地擱置於受影響的多重路徑裝置中。
   </para>
   <para>
    若要測試案例，請執行下列步驟︰
   </para>
   <procedure>
    <step>
     <para>
      開啟終端機主控台。
     </para>
    </step>
    <step>
     <para>
      輸入以下指令啟動裝置 I/O 的佇列功能而非容錯移轉︰
     </para>
<screen>sudo dmsetup message <replaceable>device_ID</replaceable> 0 queue_if_no_path</screen>
     <para>
      用裝置的 ID 取代 <replaceable>device_ID</replaceable>。0 值代表磁區，當不需要磁區資訊時使用。
     </para>
     <para>
      例如，輸入︰
     </para>
<screen>sudo dmsetup message 3600601607cf30e00184589a37a31d911 0 queue_if_no_path</screen>
    </step>
    <step>
     <para>
      輸入以下指令返回到裝置 I/O 的容錯移轉︰
     </para>
<screen>sudo dmsetup message <replaceable>device_ID</replaceable> 0 fail_if_no_path</screen>
     <para>
      此指令會立即使所有排入佇列的 I/O 失敗。
     </para>
     <para>
      用裝置的 ID 取代 <replaceable>device_ID</replaceable>。例如，輸入︰
     </para>
<screen>sudo dmsetup message 3600601607cf30e00184589a37a31d911 0 fail_if_no_path</screen>
    </step>
   </procedure>
   <para>
    若要對所有路徑都失敗的情況設定佇列 I/O，請執行下列步驟︰
   </para>
   <procedure>
    <step>
     <para>
      開啟終端機主控台。
     </para>
    </step>
    <step>
     <para>
      在文字編輯器中開啟 <filename>/etc/multipath.conf</filename> 檔案。
     </para>
    </step>
    <step>
     <para>
      取消預設區段及其結束括號的註解，然後新增 <literal>default_features</literal> 設定，如下所示︰
     </para>
<screen>defaults {
  default_features "1 queue_if_no_path"
}</screen>
    </step>
    <step>
     <para>
      修改 <filename>/etc/multipath.conf</filename> 檔案後，您必須執行 <command>dracut </command> <option>-f</option> 在系統中重新建立 <filename>initrd</filename>，然後重新開機以使變更生效。
     </para>
    </step>
    <step>
     <para>
      當您準備好返回到裝置 I/O 的容錯移轉時，請輸入︰
     </para>
<screen>sudo dmsetup message <replaceable>mapname</replaceable> 0 fail_if_no_path</screen>
     <para>
      用裝置對應的別名或裝置 ID 取代 <replaceable>mapname</replaceable>。0 值代表磁區，當不需要磁區資訊時使用。
     </para>
     <para>
      此指令會立即使所有排入佇列的 I/O 失敗，並將錯誤傳播到呼叫應用程式。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.multipath.best_practice.io_stalled">
   <title>解決擱置的 I/O</title>
   <para>
    如果所有路徑同時失敗，且 I/O 雖已排入佇列卻被擱置時，請執行下列步驟︰
   </para>
   <procedure>
    <step>
     <para>
      在終端機主控台提示符處輸入以下指令︰
     </para>
<screen>sudo dmsetup message <replaceable>mapname</replaceable> 0 fail_if_no_path</screen>
     <para>
      用裝置的正確裝置 ID 或對應的別名取代 <literal><replaceable>mapname</replaceable></literal>。0 值代表磁區，當不需要磁區資訊時使用。
     </para>
     <para>
      此指令會立即使所有排入佇列的 I/O 失敗，並將錯誤傳播到呼叫應用程式。
     </para>
    </step>
    <step>
     <para>
      輸入下列指令重新啟動佇列︰
     </para>
<screen>sudo dmsetup message <replaceable>mapname</replaceable> 0 queue_if_no_path</screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.multipath.best_practice.zseries">
   <title>設定 IBM z Systems 裝置的預設設定</title>
   <para>
    使用多重路徑對 IBM z Systems 裝置進行的測試表明，應將 <literal>dev_loss_tmo</literal> 參數設定為 90 秒，將 <literal>fast_io_fail_tmo</literal> 參數設定為 5 秒。若您使用的是 z Systems 裝置，請依照以下方式修改 <filename>/etc/multipath.conf</filename> 檔案以指定這些值︰
   </para>
<screen>defaults {
       dev_loss_tmo 90
       fast_io_fail_tmo 5
}</screen>
   <para>
    <literal>dev_loss_tmo</literal> 參數設定將某個多重路徑連結標記為失敗之前需等待的秒數。若該路徑失敗，則目前在該路徑上的所有 I/O 都會失敗。預設值會因所用的裝置驅動程式而有所不同。值的有效範圍為 0 至 600 秒。若要使用驅動程式的內部逾時，請將該值設定為零 (0) 或任何大於 600 的值。
   </para>
   <para>
    <literal>fast_io_fail_tmo</literal> 參數設定偵測到連結問題後將 I/O 確定為失敗之前需等待的時間。到達該驅動程式的 I/O 都會失敗。如果 I/O 排在擁堵的佇列中，則未到 <literal>dev_loss_tmo</literal> 時間且佇列未疏通之前 I/O 不會失敗。
   </para>
   <para>
    如果您修改了 <filename>/etc/multipath.conf</filename> 檔案，只有在您更新多重路徑對應或 <systemitem class="daemon">multipathd</systemitem> 精靈 (<command>systemctl restart multipathd</command>) 重新啟動後，變更才會套用。
   </para>
  </sect2>

  <sect2 xml:id="sec.multipath.best_practice.netapp">
   <title>將多重路徑用於 NetApp 裝置</title>
   <para>
    將多重路徑用於 NetApp 裝置時，建議在 <filename>/etc/multipath.conf</filename> 檔案中進行如下設定︰
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      為 NetApp 裝置全域設定下列參數的預設值︰
     </para>
<screen>max_fds max
queue_without_daemon no</screen>
    </listitem>
    <listitem>
     <para>
      在硬體表中為 NetApp 裝置設定下列參數的預設值︰
     </para>
<screen>dev_loss_tmo infinity
fast_io_fail_tmo 5
features "3 queue_if_no_path pg_init_retries 50"</screen>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="sec.multipath.best_practice.noflush">
   <title>將 --noflush 用於多重路徑裝置</title>
   <para>
    在多重路徑裝置上執行時，應始終使用 <option>--noflush</option> 選項。
   </para>
   <para>
    例如，在執行表格重新載入的程序檔中，應使用 <literal>--noflush</literal> 選項進行恢復，以確保所有重要 I/O 不會被衝洗，因為您需要多重路徑拓樸資訊。
   </para>
<screen>load
resume --noflush</screen>
  </sect2>

  <sect2 xml:id="sec.multipath.best_practice.san_timeout">
   <title>根裝置為多重路徑裝置時的 SAN 逾時設定</title>

   <para>
    所有路徑都已失敗並已從系統移除時，多重路徑裝置上包含根目錄 (<filename>/</filename>) 的系統可能會停止，因為系統會收到儲存子系統 (例如光纖通道儲存陣列) 發出的 <literal>dev_loss_tmo</literal> 逾時通知。
   </para>
   <para>
    如果系統裝置設定了多個路徑，且多重路徑 <literal>no_path_retry</literal> 設定處於啟用狀態，您應相應地修改儲存子系統的 <literal>dev_loss_tmo</literal> 設定，以確保在所有路徑失效的情況下不會移除任何裝置。強烈建議您將 <literal>dev_loss_tmo</literal> 的值設為等於或大於多重路徑中 <literal>no_path_retry</literal> 設定的值。
   </para>
   <para>
    建議按如下方式設定儲存子系統的 <literal>dev_los_tmo</literal>︰
   </para>
<screen>&lt;dev_loss_tmo&gt; = &lt;no_path_retry&gt; * &lt;polling_interval&gt;</screen>
   <para>
    其中，以下定義適用於多重路徑值︰
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      <literal>no_path_retry</literal> 定義多重路徑 I/O 嘗試多少次後路徑視為遺失並停止將 I/O 排入佇列。
     </para>
    </listitem>
    <listitem>
     <para>
      <literal>polling_interval</literal> 是執行路徑檢查的時間間隔 (以秒為單位)。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    每個多重路徑值都應在 <filename>/etc/multipath.conf</filename> 組態檔案中設定。如需更多資訊，請參閱<xref linkend="sec.multipath.conf_file" xrefstyle="SectTitleOnPage"/>。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.multipath.trouble">
  <title>MPIO 疑難排解</title>

  <para>
   本節說明 MPIO 的一些已知問題和可能的解決方案。
  </para>

  <sect2 xml:id="sec.multipath.trouble.root">
   <title>啟用多重路徑時系統在開機過程中退出到緊急外圍程序</title>
   <para>
    在開機過程中，系統退出到緊急外圍程序，並顯示類似如下的訊息︰
   </para>
<screen>[  OK  ] Listening on multipathd control socket.
         Starting Device-Mapper Multipath Device Controller...
[  OK  ] Listening on Device-mapper event daemon FIFOs.
         Starting Device-mapper event daemon...
         Expecting device dev-disk-by\x2duuid-34be48b2\x2dc21...32dd9.device...
         Expecting device dev-sda2.device...
[  OK  ] Listening on udev Kernel Socket.
[  OK  ] Listening on udev Control Socket.
         Starting udev Coldplug all Devices...
         Expecting device dev-disk-by\x2duuid-1172afe0\x2d63c...5d0a7.device...
         Expecting device dev-disk-by\x2duuid-c4a3d1de\x2d4dc...ef77d.device...
[  OK  ] Started Create list of required static device nodes ...current kernel.
         Starting Create static device nodes in /dev...
[  OK  ] Started Collect Read-Ahead Data.
[  OK  ] Started Device-mapper event daemon.
[  OK  ] Started udev Coldplug all Devices.
         Starting udev Wait for Complete Device Initialization...
[  OK  ] Started Replay Read-Ahead Data.
         Starting Load Kernel Modules...
         Starting Remount Root and Kernel File Systems...
[  OK  ] Started Create static devices
[   13.682489] floppy0: no floppy controllers found
[*     ] (1 of 4) A start job is running for dev-disk-by\x2du...(7s / 1min 30s)
[*     ] (1 of 4) A start job is running for dev-disk-by\x2du...(7s / 1min 30s)

...

Timed out waiting for device dev-disk-by\x2duuid-c4a...cfef77d.device.
[DEPEND] Dependency failed for /opt.
[DEPEND] Dependency failed for Local File Systems.
[DEPEND] Dependency failed for Postfix Mail Transport Agent.
Welcome to emergency shell
Give root password for maintenance
(or press Control-D to continue):</screen>
   <para>
    在下列情況下，可能會發生此問題︰
   </para>
   <itemizedlist>
     <listitem>
      <para>
       在啟用多重路徑的情況下，未將非多重路徑根檔案系統加入黑名單。請參閱<xref linkend="pro.multipath.trouble.root.blacklist" xrefstyle="HeadingOnPage"/>
      </para>
     </listitem>
     <listitem>
      <para>
       在具有多重路徑根檔案系統的系統上，啟用/停用了多重路徑，但未重建 <filename>initrd</filename>。請參閱<xref linkend="pro.multipath.trouble.root.initrd"/>
      </para>
     </listitem>
     <listitem>
      <para>
       在具有網路連接儲存且啟用了多重路徑的系統上，<filename>initrd</filename> 中缺少網路儲存的驅動程式
      </para>
     </listitem>
   </itemizedlist>

   <procedure xml:id="pro.multipath.trouble.root.blacklist">
    <title>應急外圍程序︰將檔案系統加入黑名單 </title>
    <para>
     如果根檔案系統不在多重路徑上，卻啟用了多重路徑，則需要此修復。在此類設定中，多重路徑會嘗試為未列入黑名單的所有裝置設定其路徑。由於具有根檔案系統的裝置已掛接，它對於多重路徑而言是無法存取的，因而會導致路徑設定失敗。您可以在 <filename>/etc/multipath.conf</filename> 中將根裝置列入黑名單來正確設定多重路徑，從而修復此問題。
    </para>
    <step>
     <para>
      在緊急外圍程序中執行 <command>multipath -v2</command>，並確定根檔案系統的裝置。指令將產生類似如下的輸出︰
     </para>
<screen><prompt role="root">root # </prompt>multipath -v2
Dec 18 10:10:03 | 3600508b1001030343841423043300400: ignoring map</screen>
     <para>
      <literal>| </literal> 與 <literal>:</literal> 之間的字串是列入黑名單所需的 WWID。
     </para>
    </step>
    <step>
     <para>
      開啟 <filename>/etc/multipath.conf</filename> 並新增以下內容︰
     </para>
<screen>blacklist {
  wwid "<replaceable>WWWID</replaceable>"
}</screen>
     <para>
      以您在上一步中擷取的 ID 取代 <replaceable>WWWID</replaceable>。如需詳細資訊，請參閱<xref linkend="sec.multipath.blacklist"/>。
     </para>
    </step>
    <step>
     <para>
      按 <keycombo>
      <keycap function="control"/> <keycap>  D</keycap> </keycombo>  離開緊急外圍程序並將伺服器重新開機。
     </para>
    </step>
   </procedure>

   <procedure xml:id="pro.multipath.trouble.root.initrd">
    <title>應急外圍程序︰重建 <filename>initrd</filename></title>
    <para>
     如果 <filename>initrd</filename> 與系統之間的多重路徑狀態 (已啟用或已停用) 不相同，則需要此修復。若要修復此問題，請重建 <filename>initrd</filename>︰
    </para>
    <step>
     <para>
      如果已在系統中<emphasis>啟用</emphasis>多重路徑，請透過以下指令重建支援多重路徑的 initrd︰
     </para>
     <screen>dracut --force --add multipath</screen>
     <para>
      如果已在系統中<emphasis>停用</emphasis>多重路徑，請透過以下指令重建支援多重路徑的 initrd︰
     </para>
     <screen>dracut --force -o multipath</screen>
    </step>
    <step>
     <para>
      按 <keycombo>
      <keycap function="control"/> <keycap>  D</keycap> </keycombo>  離開緊急外圍程序並將伺服器重新開機。
     </para>
    </step>
   </procedure>

   <procedure xml:id="pro.multipath.trouble.root.drivers">
    <title>應急外圍程序︰重建 <filename>initrd</filename></title>
    <para>
     如果 initrd 不包含用於存取網路連接儲存的驅動程式，則需要此修復。例如，如果系統是在沒有多重路徑的情況下安裝的，或者當新增或更換相應硬體時，就可能需要此修復。
    </para>
    <step>
     <para>
      將所需的驅動程式新增至檔案 <filename>/etc/dracut.conf.d/01-dist.conf</filename> 中的變數 <envar>force_drivers</envar>。例如，如果系統包含由 <filename>hpsa</filename> 驅動程式存取的 RAID 控制器，且多重路徑裝置連接至 qla23xx 驅動程式所存取的 QLogic 控制器，則此項目應為︰
     </para>
     <screen>force_drivers+="hpsa qla23xx"</screen>
    </step>
    <step>
     <para>
      使用以下指令重建 <systemitem>initrd</systemitem>︰
     </para>
     <screen>dracut -f --add-multipath</screen>
    </step>
    <step>
     <para>
      為了防止在連接網路儲存失敗時系統開機進入應急模式，建議將掛接選項 <literal>_netdev</literal> 新增到 <filename>/etc/fstab</filename> 中的相應項目。
     </para>
    </step>
    <step>
     <para>
      按 <keycombo>
      <keycap function="control"/> <keycap>  D</keycap> </keycombo>  離開緊急外圍程序並將伺服器重新開機。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.multipath.trouble.prio_fail">
   <title>升級到多重路徑 0.4.9 或更高版本後個別裝置的 PRIO 設定失敗</title>
   <para>
    從版本 0.4.9 開始，多重路徑工具使用 <literal>/etc/multipath.conf</literal> 檔案中 <literal>defaults{}</literal> 或 <literal>devices{}</literal> 區段內的 <filename>prio</filename> 設定。當關鍵字 <literal>prio</literal> 是為 <literal>multipaths{)</literal> 區段中的個別 <literal>multipath</literal> 定義而指定時，它會無訊息式地忽略該關鍵字。
   </para>
   <para>
    多重路徑工具 0.4.8 允許 <literal>multipaths{)</literal> 區段內個別 <literal>multipath</literal> 定義中的 prio 設定置換 <literal>defaults{}</literal> 或 <literal>devices{}</literal> 區段內的 <literal>prio</literal> 設定。
   </para>
  </sect2>

  <sect2 xml:id="sec.multipath.trouble.prio_argument_fail">
   <title>升級到 multipath-tools-0.4.9 或更高版本後使用引數的 PRIO 設定失敗</title>
   <para>
    從 <filename>multipath-tools-0.4.8</filename> 升級到 <filename>multipath-tools-0.4.9</filename> 後，<filename>/etc/multipath.conf</filename> 檔案中的 <literal>prio</literal> 設定對於需要引數的優先程度排序器將會損壞。在 multipath-tools-0.4.9 中，<literal>prio</literal> 關鍵字用於指定優先程度排序器，<literal>prio_args</literal> 關鍵字則用於為需要引數的優先程度排序器指定引數。以前，優先程度排序器及其引數都在同一 <literal>prio</literal> 行上指定。
   </para>
   <para>
    例如，在 multipath-tools-0.4.8 中，下行用於指定優先程度排序器，並且在同一行中指定其引數。
   </para>
<screen>prio "weightedpath hbtl [1,3]:.:.+:.+ 260 [0,2]:.:.+:.+ 20"</screen>
   <para>
    升級到 multipath-tools-0.4.9 或更高版本後，該指令會導致錯誤。訊息類似下方所列︰
   </para>
<screen>&lt;Month day hh:mm:ss&gt; | Prioritizer 'weightedpath hbtl [1,3]:.:.+:.+ 260
[0,2]:.:.+:.+ 20' not found in /lib64/multipath</screen>
   <para>
    若要解決此問題，請使用文字編輯器修改 <filename>/etc/multipath.conf</filename> 檔案中的 <literal>prio</literal> 行。建立兩行，在 <filename>prio</filename> 行上指定優先程度排序器，並在其下的 <filename>prio_args</filename> 行上指定優先程度排序器引數︰
   </para>
<screen>prio "weightedpath"
prio_args "hbtl [1,3]:.:.+:.+ 260 [0,2]:.:.+:.+ 20"</screen>
   <para>
    執行 <command>sudo systemctl restart multipathd</command> 重新啟動 <systemitem class="daemon">multipathd</systemitem> 精靈以使變更生效。
   </para>
  </sect2>

  <sect2 xml:id="sec.multipath.trouble.tids">
   <title>技術資訊文件</title>
   <para>
    如需有關在 SUSE Linux Enterprise Server 上對多重路徑 I/O 問題進行疑難排解的資訊，請參閱 SUSE 知識庫中的下列技術資訊文件 (TID)︰
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      <link xlink:href="http://www.suse.com/support/kb/doc.php?id=3617600"><citetitle>在本地裝置和附加到 SAN 的裝置上使用 LVM</citetitle></link>
     </para>
    </listitem>
    <listitem>
     <para>
      <link xlink:href="http://www.suse.com/support/kb/doc.php?id=7007498"><citetitle>Using LVM on Multipath (DM MPIO) Devices (在多重路徑 (DM MPIO) 裝置上使用 LVM)</citetitle></link>
     </para>
    </listitem>
    <listitem>
     <para>
      <link xlink:href="https://www.suse.com/support/kb/doc.php?id=7009660"><citetitle>HOWTO: Add, Resize and Remove LUN without restarting SLES</citetitle></link> (HOWTO︰在不重新啟動 SLES 的情況下新增、調整和移除 LUN)
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
 </sect1>
</chapter>
