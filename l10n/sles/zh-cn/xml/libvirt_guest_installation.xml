<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="libvirt_guest_installation.xml" version="5.0" xml:id="cha-kvm-inst">
  <title>Guest 安装</title>
  <info>
    <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
      <dm:bugtracker/>
      <dm:translation>yes</dm:translation>
    </dm:docmanager>
  </info>
  <para>
    VM Guest 由一个包含操作系统和数据文件的映像以及一个描述 VM Guest 虚拟硬件资源的配置文件构成。VM Guest 托管在 VM 主机服务器上并受其控制。本节提供有关安装 VM Guest 的概括说明。<phrase os="sles;sled">有关支持的 VM Guest 列表，请参见<xref linkend="cha-virt-support"/>。</phrase>
  </para>
  <para>
    与运行操作系统需要满足的要求相比，虚拟机几乎没有什么要求。如果操作系统未根据虚拟机主机环境进行优化，它将只能以全虚拟化模式在<xref linkend="gloss-vt-hwassisted"/>虚拟化计算机硬件上运行，并需要装载特定的设备驱动程序。提供给 VM Guest 的硬件取决于主机的配置。
  </para>
  <para>
    您应该了解与在多个虚拟机上运行单个已许可操作系统副本相关的任何许可问题。有关详细信息，请查阅操作系统许可协议。
  </para>
  <sect1 xml:id="sec-libvirt-inst-vmm">
    <title>基于 GUI 的 Guest 安装</title>

    <tip>
      <title>更改新虚拟机的默认选项</title>
      <para>
        可以更改在创建新虚拟机时要应用的默认值。例如，要将 UEFI 设置为新虚拟机的默认固件类型，请从虚拟机管理器的主菜单中选择<menuchoice><guimenu>编辑</guimenu><guimenu>首选项</guimenu></menuchoice>，单击<guimenu>新建 VM</guimenu>，然后将 <guimenu>UEFI</guimenu> 设置为默认固件。
      </para>
      <figure>
        <title>指定新 VM 的默认选项</title>
        <mediaobject>
          <imageobject role="fo">
            <imagedata fileref="default-vm-options.png" width="50%"/>
          </imageobject>
          <imageobject role="html">
            <imagedata fileref="default-vm-options.png" width="50%"/>
          </imageobject>
        </mediaobject>
      </figure>
    </tip>

    <para>
      <guimenu>新建 VM</guimenu> 向导将帮助您完成创建虚拟机和安装其操作系统所需执行的步骤。要启动该向导，请打开虚拟机管理器并选择<menuchoice><guimenu>文件</guimenu>
      <guimenu>新建虚拟机</guimenu></menuchoice>。或者，启动 YaST 并选择<menuchoice><guimenu>虚拟化</guimenu>
      <guimenu>创建虚拟机</guimenu></menuchoice>。
    </para>

    <procedure>
      <step>
        <para>
          从 YaST 或虚拟机管理器中启动<guimenu>新建 VM</guimenu> 向导。
        </para>
      </step>
      <step>
        <para>
          选择安装源 — 本地可用的媒体或网络安装源。要从现有映像安装 VM Guest，请选择<guimenu>导入现有磁盘映像</guimenu>。
        </para>
        <para>
          在运行 Xen 超级管理程序的 VM 主机服务器上，您可以选择是要安装半虚拟化 Guest 还是全虚拟化 Guest。您可以在<guimenu>体系结构选项</guimenu>下选择相应的选项。根据此项选择，并非所有安装选项均可用。
        </para>
      </step>
      <step>
        <para>
          根据在上一步中所做的选择，您需要提供以下数据：
        </para>
        <variablelist>
          <varlistentry>
            <term><guimenu>本地安装媒体（ISO 映像或 CDROM）</guimenu></term>
            <listitem>
              <para>
                在 VM 主机服务器上指定包含安装数据的 ISO 映像的路径。如果该映像是作为 libvirt 存储池中的卷提供的，您也可以使用<guimenu>浏览</guimenu>来选择。有关更多信息，请参见<xref linkend="cha-libvirt-storage"/>。
              </para>
              <para>
                或者，选择已插入到 VM 主机服务器光驱中的物理 CD-ROM 或 DVD。
              </para>
            </listitem>
          </varlistentry>
          <varlistentry>
            <term><guimenu>网络安装（HTTP、HTTPS 或 FTP）</guimenu></term>
            <listitem>
              <para>
                提供指向安装源的 <guimenu>URL</guimenu>。有效的 URL 前缀包括 <literal>ftp://</literal>、<literal>http://</literal> 和 <literal>https://</literal> 等。
              </para>
              <para>
                在 <guimenu>URL 选项</guimenu>下，提供自动安装文件（例如 AutoYaST 或 Kickstart）的路径以及内核参数。提供 URL 后，应该就会自动正确检测到操作系统。如果情况并非如此，请取消选择<guimenu>基于安装媒体自动检测操作系统</guimenu>，并手动选择<guimenu>操作系统类型</guimenu>和<guimenu>版本</guimenu>。
              </para>
            </listitem>
          </varlistentry>
          
          <varlistentry>
            <term><guimenu>导入现有磁盘映像</guimenu></term>
            <listitem>
              <para>
                要从现有映像安装 VM Guest，您需要在 VM 主机服务器上指定该映像的路径。如果该映像是作为 libvirt 存储池中的卷提供的，您也可以使用<guimenu>浏览</guimenu>来选择。有关更多信息，请参见<xref linkend="cha-libvirt-storage"/>。
              </para>
            </listitem>
          </varlistentry>
          <varlistentry>
            <term><guimenu>手动安装</guimenu></term>
            <listitem>
              <para>
                如果您要创建虚拟机，手动配置其组件并稍后安装其操作系统，则适合使用这种安装方法。要将 VM 调整为特定的产品版本，请开始键入版本名称（例如 <literal>sles</literal>），然后在出现匹配项时选择所需的版本。
              </para>
            </listitem>
          </varlistentry>
        </variablelist>
      </step>
      <step>
        <para>
          选择新虚拟机的内存大小和 CPU 数量。
        </para>
      </step>
      <step>
        <para>
          如果在第一步中选择了<guimenu>导入现有映像</guimenu>，则会省略此步骤。
        </para>
        <para>
          设置 VM Guest 的虚拟硬盘。创建新磁盘映像，或者从存储池中选择一个现有的磁盘映像（有关详细信息，请参见<xref linkend="cha-libvirt-storage"/>）。如果您选择创建磁盘，将会创建一个 <literal>qcow2</literal> 映像，该映像默认存储在 <filename>/var/lib/libvirt/images</filename> 下。
        </para>
        <para>
          设置磁盘是可选操作。例如，如果您正在直接从 CD 或 DVD 运行实时系统，可以通过停用<guimenu>为此虚拟机启用存储</guimenu>来省略此步骤。
        </para>
      </step>
      <step>
        <para>
          在向导的最后一个屏幕上指定虚拟机的名称。如果您希望能够查看和更改虚拟化硬件选择，请激活<guimenu>在安装之前自定义配置</guimenu>。在<guimenu>网络选择</guimenu>下指定网络设备。使用<guimenu>网桥设备</guimenu>时，系统会预先填充主机上的第一个网桥。要使用其他网桥，请在文本框中手动更新为该网桥名称。
        </para>
        <para>
          单击<guimenu>完成</guimenu>。
        </para>
      </step>
      <step performance="optional">
        <para>
          如果您在上一步中保留了默认设置，则会开始安装。如果您选择了<guimenu>在安装之前自定义配置</guimenu>，一个 VM Guest 配置对话框将会打开。有关配置 VM Guest 的详细信息，请参见<xref linkend="cha-libvirt-config-gui"/>。
        </para>
        <para>
          完成配置后，单击<guimenu>开始安装</guimenu>。
        </para>
      </step>
    </procedure>

    <tip xml:id="tip-libvirt-inst-vmm-sticky">
      <title>将组合键传递给虚拟机</title>
      <para>
        安装将在一个虚拟机管理器控制台窗口中开始。某些组合键（例如 <keycombo> <keycap function="control"/>
        <keycap function="alt"/> <keycap>F1</keycap> </keycombo>）会被 VM 主机服务器接受，但不会传递给虚拟机。虚拟机管理器提供<quote>粘滞键</quote>功能来绕过 VM 主机服务器。按 <keycap function="control"/>、<keycap function="alt"/> 或 <keycap function="shift"/> 三次使该键成为粘滞键，然后按组合键中剩余的键便可将组合键传递给虚拟机。
      </para>
      <para>
        例如，要将 <keycombo> <keycap function="control"/>
        <keycap function="alt"/> <keycap>F2</keycap> </keycombo> 传递给 Linux 虚拟机，请按 <keycap function="control"/> 三次，然后按 <keycombo> <keycap function="alt"/> <keycap>F2</keycap>
        </keycombo>。也可以按 <keycap function="alt"/> 三次，然后按 <keycombo> <keycap function="control"/> <keycap>F2</keycap>
        </keycombo>。
      </para>
      <para>
        在安装 VM Guest 期间以及安装之后，都可以在虚拟机管理器中使用粘滞键功能。
      </para>
    </tip>

    <sect2 xml:id="tip-libvirt-inst-vmm-pxe">
      <title>为虚拟机配置 PXE 引导</title>
      <para>
        PXE 引导使虚拟机能够通过网络从安装媒体引导，而无需从物理媒体或安装磁盘映像进行引导。<phrase os="sles">有关设置 PXE 引导环境的更多细节，请参见<xref linkend="cha-deployment-prep-pxe"/>。</phrase>
      </para>
      <para>
        要使您的 VM 从 PXE 服务器引导，请执行以下步骤：
      </para>
      <procedure>
        <step>
          <para>
            按照<xref linkend="sec-libvirt-inst-vmm"/>中所述启动安装向导。
          </para>
        </step>
        <step>
          <para>
            选择<guimenu>手动安装</guimenu>方法。
          </para>
        </step>
        <step>
          <para>
            按照向导操作到最后一步，然后选中<guimenu>在安装之前自定义配置</guimenu>。单击<guimenu>完成</guimenu>确认。
          </para>
        </step>
        <step>
          <para>
            在<guimenu>自定义</guimenu>屏幕上，选择<guimenu>引导选项</guimenu>。
          </para>
        </step>
        <step>
          <para>
            检查<guimenu>引导设备顺序</guimenu>，并选中<guimenu>启用引导菜单</guimenu>旁边的框。
          </para>
        </step>
        <step>
          <para>
            在<guimenu>启用引导菜单</guimenu>下，选中<guimenu>网络 PXE</guimenu> 并单击<guimenu>应用</guimenu>确认。
          </para>
        </step>
        <step>
          <para>
            单击<guimenu>开始安装</guimenu>以开始安装。如果正确配置了 PXE 服务器，PXE 菜单屏幕将会显示。
          </para>
        </step>
      </procedure>
    </sect2>
  </sect1>
  <sect1 xml:id="sec-libvirt-inst-virt-install">
    <title>使用 <command>virt-install</command> 从命令行安装</title>

    <para>
      <command>virt-install</command> 是个命令行工具，可帮助您使用 <systemitem class="library">libvirt</systemitem> 库创建新虚拟机。如果您无法使用图形用户界面，或需要自动化虚拟机创建过程，此工具十分有用。
    </para>

    <para>
      <command>virt-install</command> 是个复杂的脚本，其中包含大量命令行开关。下面是必需的开关。有关详细信息，请参见 <command>virt-install</command> (1) 的手册页。
    </para>

    <variablelist>
      <varlistentry>
        <term>一般选项</term>
        <listitem>
          <itemizedlist mark="bullet" spacing="normal">
            <listitem>
              <para>
                <option>--name
                <replaceable>VM_GUEST_NAME</replaceable></option>：指定新虚拟网络的名称。该名称必须在同一连接上超级管理程序已知的所有 Guest 中保持唯一。该名称用于创建和命名 Guest 的配置文件，您可以通过 <command>virsh</command> 使用该名称来访问 Guest。该名称可以包含字母数字和 <literal>_-.:+</literal> 字符。
              </para>
            </listitem>
            <listitem>
              <para>
                <option>--memory
                <replaceable>REQUIRED_MEMORY</replaceable></option>：以 MB 为单位指定分配给新虚拟机的内存量。
              </para>
            </listitem>
            <listitem>
              <para>
                <option>--vcpus
                <replaceable>NUMBER_OF_CPUS</replaceable></option>：指定虚拟 CPU 数量。要获得最佳性能，虚拟处理器数量应小于或等于物理处理器数量。
              </para>
            </listitem>
          </itemizedlist>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>虚拟化类型</term>
        <listitem>
          <itemizedlist mark="bullet" spacing="normal">
            <listitem>
              <para>
                <option>--paravirt</option>：安装半虚拟化 Guest。如果 VM 主机服务器支持半虚拟化和全虚拟化，这就是默认设置。
              </para>
            </listitem>
            <listitem>
              <para>
                <option>--hvm</option>：安装全虚拟化 Guest。
              </para>
            </listitem>
            <listitem>
              <para>
                <option>--virt-type
                <replaceable>HYPERVISOR</replaceable></option>：指定超级管理程序。支持的值为 <literal>kvm</literal> 或 <literal>xen</literal>。
              </para>
            </listitem>
          </itemizedlist>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>Guest 存储空间</term>
        <listitem>
          <para>
            指定 <option>--disk</option>、<option>--filesystem</option> 或 <option>--nodisks</option> 作为新虚拟机的存储类型。例如，<option>--disk size=10</option> 会在超级管理程序的默认映像位置创建 10 GB 磁盘，并将此磁盘用于 VM Guest。<option>--filesystem
            <replaceable>/export/path/on/vmhost</replaceable></option> 指定 VM 主机服务器上要导出到 Guest 的目录。<option>--nodisks</option> 安装不带本地存储空间的 VM Guest（适合使用实时 CD 的情形）。
          </para>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>安装方法</term>
        <listitem>
          <para>
            使用 <option>--location</option>、<option>--cdrom</option>、<option>--pxe</option>、<option>--import</option> 或 <option>--boot </option> 指定安装方法。
          </para>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>访问安装</term>
        <listitem>
          <para>
            使用 <option>--graphics
            <replaceable>VALUE</replaceable></option> 选项指定如何访问安装。<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 支持值 <literal>vnc</literal> 或 <literal>none</literal>。
          </para>
          <para>
            如果使用 VNC，<command>virt-install</command> 将尝试启动 <command>virt-viewer</command>。如果 virt-viewer 未安装或无法运行，请使用您偏好的查看器手动连接到 VM Guest。要显式阻止 <command>virt-install</command> 启动查看器，请使用 <option>--noautoconsole</option>。要定义用于访问 VNC 会话的口令，请使用以下语法：<option>--graphics
            vnc,password=<replaceable>PASSWORD</replaceable></option>。
          </para>
          <para>
            如果您使用 <option>--graphics none</option>，可以通过操作系统支持的服务（例如 SSH 或 VNC）访问 VM Guest。请参见操作系统安装手册了解如何在安装系统中设置这些服务。
          </para>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>传递内核和 initrd 文件</term>
        <listitem>
          <para>
            可以直接指定安装程序的内核和 Initrd，例如，指定来自网络来源的内核和 Initrd。<phrase os="sles;sled">要设置网络来源，请参见<xref linkend="sec-deployment-instserver-http"/>。</phrase>
          </para>
          <para>
            要传递其他引导参数，请使用 <option>--extra-args</option> 选项。此选项可用于指定网络配置。有关详细信息，请参见<xref os="sles;sled" linkend="cha-boot-parameters"/>。
          </para>
          <example>
            <title>从 HTTP 服务器装载内核和 initrd</title>

<screen os="sles;sled"><prompt role="root"># </prompt><command>virt-install</command> --location "http://example.tld/REPOSITORY/DVD1/" \
--extra-args="textmode=1" --name "SLES15" --memory 2048 --virt-type kvm\
--connect qemu:///system --disk size=10 --graphics vnc \
--network network=vnet_nated</screen>
          </example>
        </listitem>
      </varlistentry>
      <varlistentry arch="x86_64">
        <term>启用控制台</term>
        <listitem>
          <para>
            默认不会对使用 <command>virt-install</command> 安装的新虚拟机启用控制台。要启用控制台，请如以下示例所示使用 <option>--extra-args="console=ttyS0 textmode=1"</option>：
          </para>
<screen><prompt>&gt; </prompt>virt-install --virt-type kvm --name sles12 --memory 1024 \
 --disk /var/lib/libvirt/images/disk1.qcow2 --os-variant sles12
 --extra-args="console=ttyS0 textmode=1" --graphics none</screen>
          <para>
            安装完成后，VM 映像中的 <filename>/etc/default/grub</filename> 文件将会更新，在 <literal>GRUB_CMDLINE_LINUX_DEFAULT</literal> 行中包含 <option>console=ttyS0</option> 选项。
          </para>
        </listitem>
      </varlistentry>
      <varlistentry xml:id="vle-libvirt-inst-virt-install-ovmf">
        <term>使用 UEFI 安全引导</term>
        <listitem>
          <para>
            按照<xref linkend="sec-vt-installation-ovmf"/>中所述安装 OVMF。然后将 <option>--boot uefi</option> 选项添加到 <command>virt-install</command> 命令。
          </para>
          <para>
            使用 OVMF 设置新 VM 时，将自动使用 UEFI 安全引导。要使用特定的固件，请使用 <option>--boot
            loader=<replaceable>PATH_TO_FIRMWARE</replaceable></option>。
          </para>
          <para>
            例如，对于 AArch64 体系结构：
          </para>
<screen>--boot loader=/usr/share/qemu/qemu-uefi-aarch32.bin</screen>
          <para>
            对于 AMD64/Intel 64 体系结构：
          </para>
<screen>--boot loader=/usr/share/qemu/ovmf-x86_64-opensuse.bin</screen>
        </listitem>
      </varlistentry>
    </variablelist>

    <example xml:id="ex-libvirt-inst-virt-install-example">
      <title><command>virt-install</command> 命令行示例</title>
      <para>
        以下命令行示例将创建带有 virtio 加速磁盘和网卡的新 SUSE Linux Enterprise 15 SP2 虚拟机。它将创建新的 10 GB qcow2 磁盘映像作为存储空间，源安装媒体为主机 CD-ROM 驱动器。此命令行使用 VNC 图形，并自动启动图形客户端。
      </para>
      <variablelist>
        <varlistentry>
          <term>KVM</term>
          <listitem>
<screen><prompt>&gt; </prompt>virt-install --connect qemu:///system --virt-type kvm \
--name sle15sp2 --memory 1024 --disk size=10 --cdrom /dev/cdrom --graphics vnc \
--os-variant sle15sp2</screen>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term>Xen</term>
          <listitem>
<screen><prompt>&gt; </prompt>virt-install --connect xen:// --virt-type xen --hvm \
--name sle15sp2 --memory 1024 --disk size=10 --cdrom /dev/cdrom --graphics vnc \
--os-variant sle15sp2</screen>
          </listitem>
        </varlistentry>
      </variablelist>
    </example>
  </sect1>
  <sect1 xml:id="sec-libvirt-inst-advanced">
    <title>高级 Guest 安装方案</title>

    <para>
      本节提供有关超出了正常安装范围的操作（例如使用内存气球和安装附加产品）的说明。
    </para>

    <sect2 xml:id="libvirt-advanced-balloon" os="sles;sled">
      <title>对 Windows Guest 使用内存气球</title>
      <para>
        内存气球是在运行时更改 VM Guest 所用内存量的方法。KVM 和 Xen 超级管理程序都提供此方法，但需要 Guest 也支持此方法。
      </para>
      <para>
        基于 openSUSE 和 SLE 的 Guest 支持内存气球，而 Windows Guest 需要通过 <link xlink:href="https://www.suse.com/products/vmdriverpack/">Virtual
        Machine Driver Pack (VMDP)</link> 来提供气球技术。要使设置的最大内存大于为 Windows Guest 配置的初始内存，请执行以下步骤：
      </para>
      <procedure>
        <step>
          <para>
            安装最大内存等于或小于初始值的 Windows Guest。
          </para>
        </step>
        <step>
          <para>
            在 Windows Guest 中安装虚拟机驱动程序包，以提供所需的驱动程序。
          </para>
        </step>
        <step>
          <para>
            关闭 Windows Guest。
          </para>
        </step>
        <step>
          <para>
            将 Windows Guest 的最大内存重置为所需值。
          </para>
        </step>
        <step>
          <para>
            再次启动 Windows Guest。
          </para>
        </step>
      </procedure>
    </sect2>

    <sect2 xml:id="cha-kvm-inst-virtman-advanced-addons">
      <title>在安装中包含附加产品</title>
      <para>
        某些操作系统（例如 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>）允许在安装过程中包含附加产品。如果附加产品安装源是通过 SUSE Customer Center 提供的，则无需进行特殊的 VM Guest 配置。如果安装源是通过 CD/DVD 或 ISO 映像提供的，则需要向 VM Guest 安装系统提供标准安装媒体映像和附加产品的映像。
      </para>
      <para>
        如果您使用的是基于 GUI 的安装，请在向导的最后一步选择<guimenu>在安装之前自定义配置</guimenu>，并通过<menuchoice><guimenu>添加硬件</guimenu> <guimenu>存储</guimenu></menuchoice>添加附加产品 ISO 映像。指定映像的路径，并将<guimenu>设备类型</guimenu>设置为 <guimenu>CD-ROM</guimenu>。
      </para>
      <para>
        如果您是从命令行安装的，则需要使用 <option>--disk</option> 参数而不是 <option>--cdrom</option> 来设置虚拟 CD/DVD 驱动器。将使用第一个指定的设备进行引导。以下示例将 SUSE Linux Enterprise Server 15 连同 SUSE Enterprise Storage 扩展一起安装：
      </para>
<screen><prompt>&gt; </prompt>virt-install \
 --name sles15+storage \
 --memory 2048 --disk size=10 \
 --disk /path/to/SLE-15-SP5-Full-<replaceable>ARCH</replaceable>-GM-media1.iso-x86_64-GM-DVD1.iso,device=cdrom \
 --disk /path/to/SUSE-Enterprise-Storage-<replaceable>VERSION</replaceable>-DVD-<replaceable>ARCH</replaceable>-Media1.iso,device=cdrom \
 --graphics vnc --os-variant sle15</screen>
    </sect2>
  </sect1>
</chapter>
