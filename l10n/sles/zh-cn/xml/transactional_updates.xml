<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="transactional_updates.xml" version="5.0" xml:id="cha-transactional-updates" xml:lang="zh-cn">
 <title>事务更新</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    事务更新在 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 中以技术预览形式提供，当根文件系统为只读时，可使用技术更新来更新 SLES。事务更新具有原子性（仅当所有更新都成功时，才会应用所有更新），且支持回滚。它不影响正在运行的系统，因为只有在重引导系统后，才会激活更改。由于重引导是中断性的操作，管理员必须确定重引导的开销是否高于中断运行中服务的开销。如果重引导的开销过高，则不要使用事务更新。
   </para>

   <para>
    事务更新由 <command>transactional-update</command> 脚本每天运行。该脚本将检查可用的更新。如果存在任何更新，则它会在后台创建根文件系统的新快照，然后从发布渠道提取更新。完全更新新快照后，该快照将标记为活动快照，并在下一次重引导系统后，成为新的默认根文件系统。当 <command>transactional-update</command> 设置为自动运行（默认行为）时，该脚本还会重引导系统。更新运行时间以及重引导维护时段均可配置。
   </para>

   <para>
    只能更新属于根文件系统快照的软件包。如果软件包中包含不属于该快照的文件，更新可能会失败或中断系统。
   </para>

   <para>
    无法更新需要接受许可证的 RPM。
   </para>
  </abstract>
 </info>
 
 <sect1 xml:id="sec-tu-limitations">
  <title>技术预览的限制</title>

  <para>
   技术预览的功能存在某些限制。<command>transactional-update</command> 对于以下软件包不起作用：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     <package>nginx</package> 的默认 index.html 页可能不可用
    </para>
   </listitem>
   <listitem>
    <para>
     <package>tomcat-webapps</package> 和 <package>tomcat-admin-webapps</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>phpMyAdmin</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>sca-appliance-*</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>mpi-selector</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>emacs</package> 可正常工作（Emacs 游戏除外）
    </para>
   </listitem>
   <listitem>
    <para>
     <package>bind</package> 和 <package>bind-chrootenv</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>docbook*</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>sblim-sfcb*</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>texlive*</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>iso_ent</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>openjade</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>opensp</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>pcp</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>plymouth</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>postgresql-server-10</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>pulseaudio-gdm-hooks</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>smartmontools</package>
    </para>
   </listitem>
  </itemizedlist>

  <para>
   系统安装程序的更新程序组件不适用于只读文件系统，因为此类文件系统不支持事务更新。
  </para>

  <para>
   其他注意事项：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     一般情况下，最好在更新系统之后尽早重引导计算机。
    </para>
   </listitem>
   <listitem>
    <para>
     每次只能应用一项更新。在应用一项更新之后到应用下一项更新之前，请务必重引导。
    </para>
   </listitem>
   <listitem>
    <para>
     在事务更新之后直到将计算机重引导，都不应运行 <command>update-alternatives</command>。
    </para>
   </listitem>
   <listitem>
    <para>
     在事务更新之后直到重引导，都不要创建新的系统用户或系统组。允许创建普通用户和组（UID &gt; 1000，GID &gt; 1000）。
    </para>
   </listitem>
   <listitem>
    <para>
     YaST 尚不能识别事务更新。如果 YaST 模块需要安装额外的软件包，此操作将无法正常执行。而只是修改 <filename>/etc</filename> 中配置文件的常规系统操作可正常进行。
    </para>
   </listitem>
   <listitem>
    <para>
     对于 <package>php7-fastcgi</package>，必须手动创建指向 <filename>/usr/bin/php-cgi</filename> 的符号链接 <filename>/srv/www/cgi-bin/php</filename>。
    </para>
   </listitem>
   <listitem>
    <para>
     <package>ntp</package> 是要从较低 SLES 版本迁移的 Legacy Module 的一部分。新的 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 安装中已不再支持，且已被 <package>chrony</package> 替换。如果您继续使用 <package>ntp</package>，需要进行全新安装才能正常使用事务更新。
    </para>
   </listitem>
   <listitem>
    <para>
     <package>sblim-sfcb</package>：整个 sblim 生态系统都与事务更新不兼容。
    </para>
   </listitem>
   <listitem>
    <para>
     <package>btrfsmaintenance</package> 软件包中的 <command>btrfs-defrag</command> 无法与只读根文件系统搭配使用。
    </para>
   </listitem>
   <listitem>
    <para>
     对于 <command>btrfs-balance</command>，<filename>/etc/sysconfig/btrfsmaintenance</filename> 中的变量 <literal>BTRFS_BALANCE_MOUNTPOINTS</literal> 必须从 <literal>/</literal> 更改为 <literal>/.snapshots</literal>。
    </para>
   </listitem>
   <listitem>
    <para>
     对于 <command>btrfs-scrub</command>，<filename>/etc/sysconfig/btrfsmaintenance</filename> 中的变量 <literal>BTRFS_SCRUB_MOUNTPOINTS</literal> 必须从 <literal>/</literal> 更改为 <literal>/.snapshots</literal>。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec-install-tu">
  <title>启用 <package>transactional-update</package></title>
  <para>
   必须在系统安装期间启用 Transactional Server 模块，然后选择 Transactional Server 系统角色。不支持稍后再于正在运行的系统中从 Transactional Server 模块安装任何软件包，此操作可能会使系统中断。
  </para>
  <para>
      请注意，不支持更改根分区的子卷布局，或者将根分区的子目录或子卷放到其各自的分区中（<filename>/home</filename>、<filename>/var</filename>、<filename>/srv</filename> 和 <filename>/opt</filename> 除外），此类操作很可能会使系统中断。
  </para>
 </sect1>
 
  <sect1 xml:id="sec-tu-disable">
  <title>管理自动更新</title>
  <para>
      自动更新由每天运行一次的 <command>systemd.timer</command> 控制。此操作会应用所有更新，并告知 <command>rebootmgrd</command> 应重引导计算机。您可以调整更新运行时间，具体请参见“systemd.timer(5)”。要调整维护时段（即 <command>rebootmgrd</command> 重引导系统的时间），请参见“rebootmgrd(8)”。
  </para>
  <para>
   您可以使用以下命令禁用自动事务更新：
  </para>

<screen><prompt role="root"># </prompt><command>systemctl --now disable transactional-update.timer</command></screen>
</sect1>
 
 <sect1>
  <title><command>transactional-update</command> 命令</title>
  <para>
   <command>transactional-update</command> 命令会启用更新的原子性安装或去除，即仅当所有更新都可以成功安装时，才会应用这些更新。在应用更新之前，<command>transactional-update</command> 会创建系统的快照，您可以恢复此快照。重引导后，所有更改才会生效。
  </para>

<variablelist>
  <varlistentry>
   <term><literal>--continue</literal></term>
   <listitem>
     <para>
         可使用 <command>--continue</command> 选项对现有快照进行多次更改，而无需重引导。
     </para>
     <para>
         默认的 <command>transactional-update</command> 行为是从当前根文件系统创建新快照。如果您忘记了某项操作，例如，忘记了安装某个新软件包，必须重引导来应用先前的更改，然后再次运行 <command>transactional-update</command> 以安装忘记安装的软件包，并再次重引导。不能在未进行重引导的情况下多次运行 <command>transactional-update</command> 命令来向快照添加更多更改，因为这样做只会创建多个独立的快照，这些快照并不会包含先前快照中的更改。
     </para>
     <para>
         您可使用 <command>--continue</command> 选项在不重引导的情况下，进行任意次数的更改。每次会创建一个独立的快照，且每个快照都包含您在先前快照中进行的所有更改以及新的更改。视需要重复此过程任意次数，当最终快照包含所需的所有更改时，再重引导系统，然后最终快照便会成为新的根文件系统。
     </para>
     <para>
         <command>--continue</command> 选项的另一个有用功能是，可让您选择任一现有快照作为新快照的基础快照。以下示例演示如何运行 <command>transactional-update</command> 在基于快照 13 的某个快照中安装新软件包，然后再次运行该命令来安装另一个软件包：
     </para>
     <screen><prompt role="root"># </prompt><command>transactional-update pkg install <replaceable>package_1</replaceable></command></screen>
    <screen><prompt role="root"># </prompt><command>transactional-update --continue 13 pkg install <replaceable>package_2</replaceable></command></screen>
    <para>
        <command>--continue [num]</command> 选项会调用 <command>snapper create --from</command>，请参见<xref linkend="sec-snapper-manage-create"/>。
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><literal>cleanup</literal></term>
   <listitem>
  <para>
    如果当前根文件系统与活动的根文件系统相同（在重引导之后，<command>transactional-update</command> 创建包含更新的新快照之前），将为没有清理算法的所有旧快照设置一个清理算法。如此可确保 Snapper 会删除旧快照（请参见“snapper(8)”中有关清理算法的章节）。此操作还会去除 <filename>/var/lib/overlay</filename> 中所有未引用的（因此也未使用）<filename>/etc</filename> 覆盖目录：
  </para>
<screen><prompt role="root"># </prompt><command>transactional-update cleanup</command></screen>
    </listitem>
   </varlistentry>  
   <varlistentry>
    <term><literal>pkg in/install</literal></term>
    <listitem>
     <para>
      使用 <command>zypper install</command> 命令从可用渠道安装单个软件包。此命令还可用于安装程序临时修复 (PTF) RPM 文件。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update pkg install <replaceable>package_name</replaceable></command></screen>
     <para>
      或
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update pkg install <replaceable>rpm1 rpm2</replaceable></command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>pkg rm/remove</literal></term>
    <listitem>
     <para>
      使用 <command>zypper remove</command> 命令从活动快照中去除单个软件包。此命令还可用于去除 PTF RPM 文件。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update pkg remove <replaceable>package_name</replaceable></command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>pkg up/update</literal></term>
    <listitem>
     <para>
      使用 <command>zypper update</command> 命令更新活动快照中的单个软件包。只能更新属于基础文件系统快照的软件包。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update pkg remove <replaceable>package_name</replaceable></command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>up/update</literal></term>
    <listitem>
     <para>
      如果有新的可用更新，将会创建一个新快照，并使用 <command>zypper up/update</command> 更新该快照。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update up</command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>dup</literal></term>
    <listitem>
     <para>
      如果有新的可用更新，将会创建一个新快照，并使用 <command>zypper dup –no-allow-vendor-change</command> 更新该快照。然后，该快照将会激活，并在重引导后成为新的根文件系统。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update dup</command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>patch</literal></term>
    <listitem>
     <para>
      如果有新的可用更新，将会创建一个新快照，并使用 <command>zypper patch</command> 更新该快照。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update patch</command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>rollback</literal></term>
    <listitem>
     <para>
      此选项会设置默认子卷。在使用读/写文件系统的系统上可调用 <command>snapper rollback</command>。在只读文件系统上，如果未提供任何参数，当前系统将设置为新的默认根文件系统。如果您指定了编号，则该快照将用作默认的根文件系统。在只读文件系统上，不会创建任何额外快照。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update rollback <replaceable>snapshot_number</replaceable></command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>grub.cfg</literal></term>
    <listitem>
     <para>
      此参数会创建新的 GRUB2 配置。有时需要调整引导配置，例如，添加额外的内核参数。编辑 <replaceable>/etc/default/grub</replaceable>，运行 <command>transactional-update grub.cfg</command>，然后重引导以激活更改。您必须立即重引导，否则，下一次运行 transactional-update 时会使用默认值重写新的 GRUB2 配置。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update grub.cfg</command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>reboot</literal></term>
    <listitem>
     <para>
      此参数在完成操作后会触发重引导。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update <replaceable>dup</replaceable> reboot</command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>--help</literal></term>
    <listitem>
     <para>
      此时会输出包含选项和子命令的帮助屏幕。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update --help</command></screen>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>

 <sect1 xml:id="sec-tu-troubleshooting">
  <title>查错</title>

  <para>
   如果升级失败，请运行 <command>supportconfig</command> 来收集日志数据。将生成的文件（包括 <filename>/var/log/transactional-update.log</filename>）提供给 SUSE 支持人员。
  </para>
 </sect1>
</chapter>
