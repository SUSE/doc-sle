<?xml version="1.0"?>
<!DOCTYPE chapter [
  <!ENTITY % entities SYSTEM "generic-entities.ent">
  %entities;
]>

<chapter xmlns:its="http://www.w3.org/2005/11/its" xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="vm_security.xml" version="5.0" xml:id="cha-vm-security">
  <title>Enhancing virtual machine security with AMD SEV-SNP</title>
  <info>
    <meta name="description" its:translate="yes">Enable AMD Secure Encrypted Virtualization-Secure Nested Paging (SEV-SNP) to enhance security isolation and data protection in virtual machines</meta>
    <abstract>
      <para>
        You can enhance the security of your virtual machines with AMD Secure Encrypted
        Virtualization-Secure Nested Paging (SEV-SNP). The AMD SEV-SNP feature isolates virtual
        machines from the host system and other VMs, protecting the data and code. This feature
        encrypts data and ensures that all changes with the code and data in the VM are detected or
        tracked. Since this isolates VMs, the other VMs or the host machine are not affected by
        threats.
      </para>

      <para>
        This section explains the steps to enable and use AMD SEV-SNP on your AMD EPYC server with
        &productname; &productnumber;.
      </para>
    </abstract>
    <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
      <dm:bugtracker/>
      <dm:translation>yes</dm:translation>
    </dm:docmanager>
  <revhistory xml:id="rh-cha-vm-security">
   <revision>
     <date>2025-06-12</date>
     <revdescription>
       <para/>
     </revdescription>
   </revision>
 </revhistory>
</info>
  <sect1 xml:id="sec-vm-security-hardware-support">
    <title>Supported hardware</title>

    <para>
      A system with an AMD EPYC (3rd Gen or newer) is required to run AMD SEV-SNP virtual machines.
      The BIOS of the AMD machine must provide the necessary options to enable support for
      confidential computing on the platform.
    </para>
  </sect1>
  <sect1 xml:id="sec-vm-security-setup">
    <title>Setting up the base system</title>
    <para>
      The &vmhost; requires minor configuration changes prior to running AMD SEV-SNP enabled &vmguest;s.
      The default IOMMU configuration in SUSE Linux Enterprise Server 15 SP7 is passthrough mode.
      To use the AMD SEV-SNP feature, the IOMMU must be configured in non-passthrough mode.
      This is required to prevent peripheral devices from accessing memory that belongs to an encrypted &vmguest;,
      compromising its data integrity. The MSR kernel module is required to use the optional <command>snphost</command> tool.
    </para>
    <procedure>
       <step>
        <para>
          To automatically load the <literal>msr</literal> module at boot:
        </para>
<screen>&prompt.sudo; <command>echo "msr" > /etc/modules-load.d/msr.conf</command></screen>
      </step>
      <step>
        <para>
          To disable the IOMMU configuration in &productname; &productnumber;, open the
          <filename>/etc/default/grub</filename> file and add <literal>iommu=nopt</literal> to the
          <varname>GRUB_CMDLINE_LINUX_DEFAULT</varname> variable.
        </para>
      </step>
      <step>
        <para>
          To update the bootloader configuration, run the command:
        </para>
<screen>&prompt.sudo;; <command>update-bootloader</command></screen>
      </step>
      <step>
        <para>
          The system is now ready to be restarted with the confidential computing kernel. It is not
          selected as the default kernel in the bootloader, so be sure to select it in the boot
          menu.
        </para>
      </step>
    </procedure>
  </sect1>
  <sect1 xml:id="sec-vm-security-verify">
    <title>Verifying setup</title>

    <para>
      You can verify the installation and configuration of the &vmhost; using dmesg or
      the optional <command>snphost</command> tool.
    </para>
    <procedure>
      <step>
        <para>
          To check the initialization result of the AMD Secure Processor in the kernel log when the
          kernel is running, run the command:
        </para>
<screen>&prompt.sudo; <command>dmesg | grep -i ccp</command>
[ 10.103166] ccp 0000:42:00.1: enabling device (0000 -&gt; 0002)
[ 10.114951] ccp 0000:42:00.1: no command queues available
[ 10.127137] ccp 0000:42:00.1: sev enabled
[ 10.133152] ccp 0000:42:00.1: psp enabled
[ 10.240817] ccp 0000:42:00.1: SEV firmware update successful
[ 11.128307] ccp 0000:42:00.1: SEV API:1.55 build:8
[ 11.135057] ccp 0000:42:00.1: SEV-SNP API:1.55 build:8</screen>
        <para>
          The message about the SEV-SNP API version indicates the successful initialization of the
          AMD Secure Processor. Sometimes it happens that these messages do not appear in the
          kernel log. In this case, the BIOS settings or the IOMMU configuration are often the
          root cause.
        </para>
      </step>
    </procedure>
  </sect1>
  <sect1 xml:id="sec-vm-security-vm-install">
    <title>Installing an AMD SEV-SNP virtual machine</title>

    <para>
      You can create and install AMD SEV-SNP protected virtual machines using the &libvirt;
      framework once the &vmhost; is properly configured and the AMD Secure Processor is
      initialized. The installation methods described in <xref linkend="cha-kvm-inst"/> can
      be used with SEV-SNP protected virtual machines. The only exception is ISO installation
      using a virtual CD-ROM. See the limitations section for more details.
    </para>

    <para>
      In addition to virtual CD-ROMs, &vmhost;-provided TPM devices are not compatible with
      AMD SEV-SNP-protected virtual machines and should be removed from the installation
      configuration. Rebooting SEV-SNP virtual machines is also not supported. The installation
      should ensure SEV-SNP virtual machines are configured to shut down on reboot. See the
      limitations section for more details.
    </para>
    <para>
      <xref linkend="sec-libvirt-inst-vmm"/> describes GUI-based virtual machine installation
      using virt-manager. To enable AMD SEV-SNP, activate <guilabel>Customize configuration before
      install</guilabel> prior to selecting <guilabel>Finish</guilabel> in the New VM wizard. When
      the &vmguest; configuration dialog opens, select <guilabel>Memory</guilabel>, then activate
      the <guilabel>Enable launch security</guilabel> checkbox and select <guilabel>Apply</guilabel>.
      Finally, select <guilabel>Begin Installation</guilabel> to proceed with the installation as
      described in <xref linkend="sec-libvirt-inst-vmm"/>.
    </para>

    <para>
      <xref linkend="sec-libvirt-inst-virt-install"/> describes virtual machine installation
      using <command>virt-install</command>. AMD SEV-SNP can be enabled with the
      <option>--launchSecurity</option> option. Below is a modification of
      <xref linkend="ex-libvirt-inst-virt-install-example"/> that enables AMD SEV-SNP protection:
    </para>
<screen>&prompt.user;virt-install --connect qemu:///system --virt-type kvm \
--name sle15sp7 --memory 4096 --disk size=60 --location /path/to/iso --graphics vnc \
--os-variant sle15sp7 --boot uefi --events on_reboot=destroy --launchSecurity type=sev-snp </screen>
    <para>
      See the <citetitle>Launch Security</citetitle> section of the libvirt
      <citetitle>Domain XML format</citetitle> manual at
      <link xlink:href="https://libvirt.org/formatdomain.html#launch-security"/>
      for more information on the settings supported by <option>--launchSecurity</option>.
    </para>
  </sect1>
  <sect1 xml:id="sec-vm-security-verify-vm">
    <title>Verifying the AMD SEV-SNP virtual machine</title>

    <para>
      From the appearance of the virtual machine, one cannot tell whether it runs in a confidential
      computing environment. But there are several ways to verify that from within the virtual
      machine.
    </para>

    <para>
      The kernel log will contain messages describing the state of AMD memory encryption features
      within the virtual machine. To check the kernel log, run the following command:
    </para>

<screen>&prompt.sudo; <command>dmesg | grep -i sev-snp</command>
[ 1.986186] Memory Encryption Features active: AMD SEV SEV-ES SEV-SNP</screen>

    <para>
      The presence of the SEV-SNP feature in the kernel log, among other active memory encryption
      features, shows that it is active for the virtual machine.
    </para>

    <para>
      You can use the optional <command>snpguest</command> tool to verify if the SEV-SNP
      feature is active in the virtual machine. Similar to <command>snphost</command>, the
      <command>snpguest</command> tool requires the MSR kernel module. The following example
      demonstrates using <command>snpguest</command> to check the status of memory encryption
      features within the virtual machine:
    </para>

<screen>&prompt.sudo; <command>modprobe msr &amp;&amp; snpguest ok</command>
[ PASS ] - SEV: ENABLED
[ PASS ] - SEV-ES: ENABLED
[ PASS ] - SNP: ENABLED
</screen>

    <para>
      There are also cryptographically secure ways to prove the security of the AMD SEV-SNP
      environment.
    </para>
  </sect1>

  <sect1 xml:id="sec-vm-security-snp-attestation">
    <title>Attesting the AMD SEV-SNP Virtual Machine</title>

    <para>
      Once SEV-SNP activation has been verified, the integrity of the confidential VM can be
      established through attestation, which provides cryptographic proof that it runs on
      genuine AMD hardware under a verified firmware and TCB level, backed by a trusted certificate hierarchy.
    </para>

    <para>
      Note that the steps here perform local attestation verification only. It verifies the report signature
      and certificate chain from inside the guest and ensures that the attestation data matches the platform state.
      This workflow does not include remote attestation, where the attestation report is sent to an external verifier
      or service that independently validates the platform trust and enforces access to secrets or workload authorization.
    </para>

    <para>
      The attestation process involves two tools: <command>snpguest</command> and <command>snphost</command>.  
    </para>

    <sect2 xml:id="sec-vm-security-snp-attestation-guest">
      <title>Generating and verifying the attestation report</title>

       <para>
        Inside the guest, the <command>snpguest</command> tool can be used to perform the
        attestation workflow. This process generates an attestation report, fetches the
        corresponding AMD certificate chain, and verifies that the report is cryptographically
        signed by a valid platform key.
       </para>

      <procedure>
        <step>
          <para>
            Generate an attestation report and a corresponding request file. The
            <option>--random</option> flag includes random data for uniqueness:
          </para>
          <screen>&prompt.sudo;<command>snpguest report attestation-report.bin request-file.bin --random</command></screen>
        </step>

        <step>
          <para>
            Fetch the AMD CA and ASK certificates from the Key Distribution Service (KDS) in DER
            format. Replace <literal>genoa</literal> with your processor model if different:
          </para>
        <screen>&prompt.sudo;<command>snpguest fetch ca der genoa ./certs-kds</command></screen>
        </step>

        <step>
          <para>
            Fetch the Versioned Chip Endorsement Key (VCEK) using the generated attestation
            report:
          </para>
          <screen>&prompt.sudo;<command>snpguest fetch vcek der genoa ./certs-kds attestation-report.bin</command></screen>
        </step>

        <step>
          <para>
            Verify the attestation report against the fetched certificates:
          </para>
          <screen>&prompt.sudo;<command>snpguest verify attestation ./certs-kds attestation-report.bin</command>

Reported TCB Boot Loader from certificate matches the attestation report.
Reported TCB TEE from certificate matches the attestation report.
Reported TCB SNP from certificate matches the attestation report.
Reported TCB Microcode from certificate matches the attestation report.
Chip ID from certificate matches the attestation report.
VEK signed the Attestation Report!
          </screen>
        </step>
      </procedure>
    
      <note>
        <para>
          The extended attestation workflow using the
          <command>snpguest certificates</command> command relies on QEMU functionality that is
          not currently available.
        </para>
      </note>
    </sect2>

    <sect2 xml:id="sec-vm-security-snp-attestation-host">
      <title>Validating AMD certificates on the host</title>
    <para>
        The host can optionally fetch and verify the AMD certificate chain used to validate
        guest attestation reports.
    </para>

    <procedure>
        <step>
          <para>
            Fetch the AMD CA and ASK certificates from AMD’s Key Distribution Service (KDS):
          </para>
<screen>&prompt.sudo; snphost fetch ca pem ./certs</screen>
        </step>

        <step>
          <para>
            Fetch the chip endorsement certificate (VCEK or VLEK) for the platform:
          </para>
<screen>&prompt.sudo; snphost fetch vek pem ./certs</screen>
        </step>

        <step>
          <para>
            Verify the integrity of the fetched certificate chain:
          </para>
<screen>&prompt.sudo; <command>snphost verify ./certs</command>
• = self signed, ⬑ = signs, •̷ = invalid self sign, ⬑̸ = invalid signs

ARK •
ARK ⬑ ASK
ASK ⬑ VCEK
          </screen>
        </step>
      </procedure>
    </sect2>      
  </sect1>

  <sect1 xml:id="sec-vm-security-sev-snp-limits">
    <title>Current limitations</title>

    <para>
      The following limitations are placed on SEV-SNP &vmguest;s.
    </para>

    <itemizedlist>
      <listitem>
        <para>
          The guest operating system running inside an SEV-SNP protected VM must
          contain SEV-SNP support. &sls; 15 SP6 and newer releases support SEV-SNP.
        </para>
      </listitem>
      <listitem>
        <para>
          SEV-SNP protected &vmguest;s cannot be installed with <command>virt-install</command>
          via ISO using the <option>--cdrom</option> option. Use the <option>--location</option>
          instead. See the <command>virt-install</command> manual page for more information
          on the <option>--location</option> option.
        </para>
      </listitem>
      <listitem>
        <para>
          SEV-SNP protected &vmguest;s support a maximum of 255 vCPUs.
        </para>
      </listitem>
      <listitem>
        <para>
          SEV-SNP protected &vmguest;s are not compatible with Secure Boot. UEFI firmware
          containing Secure Boot support does not work with SEV-SNP &vmguest;s.
        </para>
      </listitem>
      <listitem>
	<para>
	  SEV-SNP protected &vmguest;s are not compatible with &vmhost;-provided TPM
	  devices. This includes emulated and passthrough TPM devices.
	</para>
      </listitem>
      <listitem>
        <para>
          SEV-SNP protected Direct &vmguest;s do not support pass-through of host devices
	  (PCI passthrough).
        </para>
      </listitem>
      <listitem>
        <para>
          SEV-SNP protected &vmguest;s do not support memory ballooning.
        </para>
      </listitem>
      <listitem>
        <para>
          SEV-SNP protected &vmguest;s do not support memory or vCPU hotplugging.
        </para>
      </listitem>
      <listitem>
        <para>
          Using hugepages within a SEV-SNP protected &vmguest; is not supported.
        </para>
      </listitem>
      <listitem>
        <para>
          SEV-SNP &vmguest;s cannot be rebooted from within using <command>reboot</command>,
	  <command>shutdown -r now</command>, etc. A reboot must be done by shutting down the
	  &vmguest; and starting it again.
        </para>
      </listitem>
      <listitem>
        <para>
          Any operations that involve saving and restoring the memory and state of a
	  &vmguest; are currently not supported. This means that SEV-SNP protected
	  &vmguest;s cannot be resumed from snapshots, saved/restored or live migrated.
	  SEV-SNP protected &vmguest;s can be shut down and restarted on another host.
        </para>
      </listitem>
    </itemizedlist>

    <para>
      These limitations may be removed in the future as the hardware, firmware and specific
      layers of software receive new features.
    </para>
  </sect1>
</chapter>
