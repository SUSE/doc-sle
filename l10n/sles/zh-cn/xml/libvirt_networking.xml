<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="libvirt_networking.xml" version="5.0" xml:id="cha-libvirt-networks">
 <title>管理网络</title>
 <info>
      <abstract>
        <para>
     本章介绍 VM 主机服务器的常用网络配置，包括 VM 主机服务器和 <systemitem class="library">libvirt</systemitem> 本机支持的配置。这些配置对 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 支持的所有超级管理程序（例如 KVM 或 Xen）均有效。
   </para>
      </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:bugtracker/>
        <dm:translation>是</dm:translation>
      </dm:docmanager>
    </info>
    <para>
  有两个常用网络配置可为 VM Guest 提供网络连接：
 </para>
 <itemizedlist>
  <listitem>
   <para>
    充当第 2 层交换机的<emphasis>网桥</emphasis>
   </para>
  </listitem>
  <listitem>
   <para>
    由 <systemitem class="library">libvirt</systemitem> 管理且支持第 3 层转发的<emphasis>虚拟网络</emphasis>
   </para>
  </listitem>
 </itemizedlist>
 <sect1 xml:id="libvirt-networks-bridged">
  <title>网桥</title>

  <para>
   网桥配置为 VM Guest 提供第 2 层交换机，可以基于与端口关联的 MAC 地址在网桥上的端口之间交换第 2 层以太网包。这样 VM Guest 便可通过第 2 层连接访问 VM 主机服务器的网络。此配置类似于将 VM Guest 的虚拟以太网网线连接到与主机以及主机上运行的其他 VM Guest 共享的集线器。该配置通常称为<emphasis>共享物理设备</emphasis>。
  </para>

  <para>
   当 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 配置为 KVM 或 Xen 超级管理程序时，网桥配置是它的默认配置。如果您只想将 VM Guest 连接到 VM 主机服务器的 LAN，则此为首选配置。
  </para>

  <sect2 xml:id="libvirt-networks-bridged-yast">
   <title>使用 YaST 管理网桥</title>
   <para>
    本节包含使用 YaST 添加或去除网桥的过程。
   </para>
   <sect3 xml:id="libvirt-networks-bridged-yast-add">
    <title>添加网桥</title>
    <para>
     要在 VM 主机服务器上添加网桥，请执行以下步骤：
    </para>
    <procedure>
     <step>
      <para>
       启动 <menuchoice><guimenu>YaST</guimenu><guimenu>系统</guimenu><guimenu>网络设置</guimenu></menuchoice>。
      </para>
     </step>
     <step>
      <para>
       激活<guimenu>概述</guimenu>选项卡并单击<guimenu>添加</guimenu>。
      </para>
     </step>
     <step>
      <para>
       从<guimenu>设备类型</guimenu>列表中选择<guimenu>网桥</guimenu>，然后在<guimenu>配置名称</guimenu>项中输入网桥设备接口名称。按<guimenu>下一步</guimenu>按钮继续。
      </para>
     </step>
     <step>
      <para>
       在<guimenu>地址</guimenu>选项卡中指定网络细节，例如 DHCP/静态 IP 地址、子网掩码或主机名。
      </para>
      <para>
       仅当您也将设备指派到与 DHCP 服务器连接的网桥时，<guimenu>动态地址</guimenu>才有作用。
      </para>
      <para>
       如果您打算创建不与实际以太网设备连接的虚拟网桥，请使用<guimenu>静态指派的 IP 地址</guimenu>。在这种情况下，比较好的做法是使用私用 IP 地址范围（例如 <literal>192.168.0.0/16</literal>、<literal>172.16.0.0/12</literal> 或 <literal>10.0.0.0/8</literal>）内的地址。
      </para>
      <para>
       要创建仅在不同 Guest 之间充当连接点，而不连接到主机系统的网桥，请将 IP 地址设置为 <literal>0.0.0.0</literal>，将子网掩码设置为 <literal>255.255.255.255</literal>。网络脚本会将此特殊地址作为未设置的 IP 地址来处理。
      </para>
     </step>
     <step>
      <para>
       激活<guimenu>桥接的设备</guimenu>选项卡，然后激活您要包含在网桥中的网络设备。
      </para>
     </step>
     <step>
      <para>
       单击<guimenu>下一步</guimenu>返回到<guimenu>概述</guimenu>选项卡，然后单击<guimenu>确定</guimenu>以确认。现在，新网桥应在 VM 主机服务器上处于活动状态。
      </para>
     </step>
    </procedure>
   </sect3>
   <sect3 xml:id="libvirt-networks-bridged-yast-rm">
    <title>删除网桥</title>
    <para>
     要删除现有网桥，请执行以下步骤：
    </para>
    <procedure>
     <step>
      <para>
       启动 <menuchoice><guimenu>YaST</guimenu><guimenu>系统</guimenu><guimenu>网络设置</guimenu></menuchoice>。
      </para>
     </step>
     <step>
      <para>
       从<guimenu>概述</guimenu>选项卡上的列表中选择您要删除的网桥设备。
      </para>
     </step>
     <step>
      <para>
       单击<guimenu>删除</guimenu>以删除该网桥，然后单击<guimenu>确定</guimenu>以确认。
      </para>
     </step>
    </procedure>
   </sect3>
  </sect2>

  <sect2 xml:id="libvirt-networks-bridged-add-brctl">
   <title>通过命令行管理网桥</title>
   <para>
    本节包含使用命令行添加或去除网桥的过程。
   </para>
   <sect3 xml:id="libvirt-networks-bridged-add-brctl-add">
    <title>添加网桥</title>
    <para>
     要在 VM 主机服务器上添加新网桥设备，请执行以下步骤：
    </para>
    <procedure>
     <step>
      <para>
       在要创建新网桥的 VM 主机服务器上以 <systemitem class="username">root</systemitem> 身份登录。
      </para>
     </step>
     <step>
      <para>
       为新网桥选择一个名称（在本示例中为 <replaceable>virbr_test</replaceable>），然后运行以下命令
      </para>
<screen><prompt role="root">root # </prompt>ip link add name <replaceable>VIRBR_TEST</replaceable> type bridge</screen>
     </step>
     <step>
      <para>
       检查是否已在 VM 主机服务器上创建了网桥：
      </para>
<screen><prompt role="root">root # </prompt>bridge vlan
[...]
virbr_test  1 PVID Egress Untagged
</screen>
      <para>
       <literal>virbr_test</literal> 存在，但不与任何物理网络接口相关联。
      </para>
     </step>
     <step>
      <para>
       启动该网桥，并在其中添加一个网络接口：
      </para>
<screen>
<prompt role="root">root # </prompt>ip link set virbr_test up
<prompt role="root">root # </prompt>ip link set eth1 master virbr_test
</screen>
      <important>
       <title>网络接口必须未被使用</title>
       <para>
        只能指派尚未被其他网桥使用的网络接口。
       </para>
      </important>
     </step>
     <step>
      <para>
       （可选）启用 STP（请参见<link xlink:href="https://en.wikipedia.org/wiki/Spanning_Tree_Protocol">生成树协议</link>）
      </para>
<screen><prompt role="root">root # </prompt>bridge link set dev virbr_test cost 4</screen>
     </step>
    </procedure>
   </sect3>
   <sect3 xml:id="libvirt-networks-bridged-add-brctl-del">
    <title>删除网桥</title>
    <para>
     要通过命令行删除 VM 主机服务器上的现有网桥设备，请执行以下步骤：
    </para>
    <procedure>
     <step>
      <para>
       在要从中删除现有网桥的 VM 主机服务器上以 <systemitem class="username">root</systemitem> 身份登录。
      </para>
     </step>
     <step>
      <para>
       列出现有网桥，以识别要去除的网桥的名称：
      </para>
<screen><prompt role="root">root # </prompt>bridge vlan
[...]
virbr_test  1 PVID Egress Untagged
</screen>
     </step>
     <step>
      <para>
       删除网桥：
      </para>
<screen><prompt role="root">root # </prompt>ip link delete dev virbr_test</screen>
     </step>
    </procedure>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-xen-net-vlan">
   <title>使用 VLAN 接口</title>
   <para>
    有时需要在两台 VM 主机服务器之间或者 VM Guest 系统之间创建私用连接。例如，要将 VM Guest 迁移到不同网段中的主机，或者创建只有 VM Guest 系统能够连接到的私用网桥（即使这些 VM Guest 在不同的 VM 主机服务器系统上运行）。构建此类连接的简单方法是设置 VLAN 网络。
   </para>
   <para>
    VLAN 接口通常在 VM 主机服务器上设置。它们可以将不同的 VM 主机服务器系统互连，或者可以设置为其他仅限虚拟连接的网桥的物理接口。甚至可以创建一个使用 VLAN 作为物理接口（该接口在 VM 主机服务器中没有 IP 地址）的网桥。这样，Guest 系统就无法通过此网络访问主机。
   </para>
   <para>
    运行 YaST 模块<menuchoice><guimenu>系统</guimenu><guimenu>网络设置</guimenu></menuchoice>。执行以下过程设置 VLAN 设备：
   </para>
   <procedure>
    <title>使用 YaST 设置 VLAN 接口</title>
    <step>
     <para>
      单击<guimenu>添加</guimenu>以创建新网络接口。
     </para>
    </step>
    <step>
     <para>
      在<guimenu>硬件</guimenu>对话框中，选择<guimenu>设备类型</guimenu> <guimenu>VLAN</guimenu>。
     </para>
    </step>
    <step>
     <para>
      将<guimenu>配置名称</guimenu>的值更改为 VLAN 的 ID。请注意，VLAN ID <literal>1</literal> 通常用于管理目的。
     </para>
    </step>
    <step>
     <para>
      单击“下一步”<guimenu>。</guimenu>
     </para>
    </step>
    <step>
     <para>
      将 VLAN 设备应连接到的借口选择为下面的 <guimenu>VLAN 的实际接口</guimenu>。如果所需的接口未显示在列表中，请先在不指定 IP 地址的情况下设置此接口。
     </para>
    </step>
    <step>
     <para>
      选择将 IP 地址指派到 VLAN 设备的所需方法。
     </para>
    </step>
    <step>
     <para>
      单击<guimenu>下一步</guimenu>完成配置。
     </para>
    </step>
   </procedure>
   <para>
    还可将 VLAN 接口用作网桥的物理接口。这样便可以连接多个仅限 VM 主机服务器的网络，以及实时迁移与此类网络连接的 VM Guest 系统。
   </para>
   <para>
    YaST 并非始终允许不设置 IP 地址。但有时可能需要这种功能，尤其是应该连接仅限 VM 主机服务器的网络时。在这种情况下，请使用特殊地址 <literal>0.0.0.0</literal> 和网络掩码 <literal>255.255.255.255</literal>。系统脚本会将此地址当作未设置 IP 地址来处理。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="libvirt-networks-virtual">
  <title>虚拟网络</title>

  <para>
   <systemitem class="library">libvirt</systemitem> 管理的虚拟网络类似于桥接的网络，但通常不与 VM 主机服务器建立第 2 层连接。与 VM 主机服务器物理网络的连接通过第 3 层转发来实现，与第 2 层桥接网络相比，第 3 层转发在 VM 主机服务器上引入了额外的包处理。虚拟网络还为 VM Guest 提供 DHCP 和 DNS 服务。有关 <systemitem class="library">libvirt</systemitem> 虚拟网络的详细信息，请参见 <link xlink:href="https://libvirt.org/formatnetwork.html"/> 上的《<citetitle>Network XML format</citetitle>》（网络 XML 格式）文档。
  </para>

  <para>
   <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 上的标准 <systemitem class="library">libvirt</systemitem> 安装已经随附了名为 <literal>default</literal> 的预定义虚拟网络，该虚拟网络为网络提供 DHCP 和 DNS 服务，并且能够通过网络地址转换 (NAT) 转发模式连接到 VM 主机服务器的物理网络。尽管已预定义了 <literal>default</literal> 虚拟网络，但它必须由管理员显式启用。有关 <systemitem class="library">libvirt</systemitem> 支持的转发模式的详细信息，请参见 <link xlink:href="https://libvirt.org/formatnetwork.html#elementsConnect"/> 上《<citetitle>Network XML format</citetitle>》（网络 XML 格式）文档中的“<citetitle>Connectivity</citetitle>”（连接）一节。
  </para>

  <para>
   <systemitem class="library">libvirt</systemitem> 管理的虚拟网络可用于满足各种用例，但通常是在进行无线连接或动态/零星网络连接的 VM 主机服务器（例如便携式计算机）上使用。虚拟网络也适用于 VM 主机服务器网络的 IP 地址有限的情形，可用来在虚拟网络与 VM 主机服务器的网络之间转发包。不过，大多数服务器用例更适合网桥配置，其中的 VM Guest 会连接到 VM 主机服务器的 LAN。
  </para>

  <warning>
   <title>启用转发模式</title>
   <para>
    在 <systemitem class="library">libvirt</systemitem> 虚拟网络中启用转发模式会通过将 <filename>/proc/sys/net/ipv4/ip_forward</filename> 和 <filename>/proc/sys/net/ipv6/conf/all/forwarding</filename> 设置为 1 在 VM 主机服务器中启用转发，而这本质上是将 VM 主机服务器转变成路由器。重启动 VM 主机服务器的网络可能会重设置值并禁用转发。要避免这种行为，请通过编辑 <filename>/etc/sysctl.conf</filename> 文件并添加以下设置，在 VM 主机服务器中显式启用转发：
   </para>
   <screen>net.ipv4.ip_forward = 1</screen>
   <screen>net.ipv6.conf.all.forwarding = 1</screen>
  </warning>

  <sect2 xml:id="libvirt-networks-virtual-vmm">
   <title>使用虚拟机管理器管理虚拟网络</title>
   <para>
    您可以使用虚拟机管理器定义、配置和操作虚拟网络。
   </para>
   <sect3 xml:id="libvirt-networks-virtual-vmm-define">
    <title>定义虚拟网络</title>
    <procedure>
     <step>
      <para>
       启动虚拟机管理器。在可用连接列表中，右键单击您需要为其配置虚拟网络的连接名称，然后选择<guimenu>细节</guimenu>。
      </para>
     </step>
     <step>
      <para>
       在<guimenu>连接细节</guimenu>窗口中，单击<guimenu>虚拟网络</guimenu>选项卡。您会看到可用于当前连接的所有虚拟网络的列表。右侧会显示选定虚拟网络的细节。
      </para>
      <figure>
       <title>连接细节</title>
       <mediaobject>
        <imageobject role="fo">
         <imagedata fileref="libvirt_vmm_conndetails.png" width="45%"/>
        </imageobject>
        <imageobject role="html">
         <imagedata fileref="libvirt_vmm_conndetails.png" width="45%"/>
        </imageobject>
       </mediaobject>
      </figure>
     </step>
     <step>
      <para>
       要添加新虚拟网络，请单击<guimenu>添加</guimenu>。
      </para>
     </step>
     <step>
      <para>
       指定新虚拟网络的名称，然后单击<guimenu>前进</guimenu>。
      </para>
      <figure>
       <title>创建虚拟网络</title>
       <mediaobject>
        <imageobject role="fo">
         <imagedata fileref="libvirt_vmm_vnet_name.png" width="45%"/>
        </imageobject>
        <imageobject role="html">
         <imagedata fileref="libvirt_vmm_vnet_name.png" width="45%"/>
        </imageobject>
       </mediaobject>
      </figure>
     </step>
     <step>
      <para>
       要指定 IPv4 网络地址空间定义，请激活相关选项，并在<guimenu>网络</guimenu>文本项中键入定义。
      </para>
      <figure>
       <title>创建虚拟网络</title>
       <mediaobject>
        <imageobject role="fo">
         <imagedata fileref="libvirt_vmm_vnet_ipv4.png" width="45%"/>
        </imageobject>
        <imageobject role="html">
         <imagedata fileref="libvirt_vmm_vnet_ipv4.png" width="45%"/>
        </imageobject>
       </mediaobject>
      </figure>
     </step>
     <step>
      <para>
       <systemitem class="library">libvirt</systemitem> 可为虚拟网络提供 DHCP 服务器。如果需要此服务器，请激活<guimenu>启用 DHCPv4</guimenu>，然后键入可指派地址的开始和结束 IP 地址范围。
      </para>
     </step>
     <step>
      <para>
       要为新虚拟网络启用静态路由，请激活相关选项，并键入网络地址和网关地址。
      </para>
     </step>
     <step>
      <para>
       单击<guimenu>前进</guimenu>继续。
      </para>
     </step>
     <step>
      <para>
       要指定 IPv6 相关的选项（网络地址空间、DHCPv6 服务器或静态路由），请激活<guimenu>启用 IPv6 网络地址空间定义</guimenu>，然后激活相关选项并填写相关的框。
      </para>
     </step>
     <step>
      <para>
       单击<guimenu>前进</guimenu>继续。
      </para>
     </step>
     <step>
      <para>
       选择您是要创建隔离的虚拟网络还是转发的虚拟网络。
      </para>
      <figure>
       <title>创建虚拟网络</title>
       <mediaobject>
        <imageobject role="fo">
         <imagedata fileref="libvirt_vmm_vnet_type.png" width="45%"/>
        </imageobject>
        <imageobject role="html">
         <imagedata fileref="libvirt_vmm_vnet_type.png" width="45%"/>
        </imageobject>
       </mediaobject>
      </figure>
      <para>
       如果要创建转发的网络，请指定要将请求转发到的网络接口，以及以下其中一种转发模式：<guimenu>NAT</guimenu>（网络地址转换）模式会重新映射虚拟网络地址空间并允许共享单个 IP 地址，而<guimenu>路由</guimenu>模式则会将包从虚拟网络转发到 VM 主机服务器的物理网络，但不进行转换。
      </para>
     </step>
     <step>
      <para>
       如果您之前未指定 IPv6 网络地址空间定义，可以在虚拟机之间启用 IPv6 内部路由。
      </para>
     </step>
     <step performance="optional">
      <para>
       （可选）更改 DNS 域名。
      </para>
     </step>
     <step>
      <para>
       单击<guimenu>完成</guimenu>以创建新虚拟网络。VM 主机服务器上即会有一个新的虚拟网桥 <literal>virbr<replaceable>X</replaceable></literal>，该网桥对应于新建的虚拟网络。您可以使用 <command>bridge link</command> 进行检查。<systemitem class="library">libvirt</systemitem> 会自动添加 iptables 规则来允许传入/传出挂接到新 <emphasis>virbr<replaceable>X</replaceable></emphasis> 设备的 Guest 的流量。
      </para>
     </step>
    </procedure>
   </sect3>
   <sect3 xml:id="libvirt-networks-virtual-vmm-start">
    <title>启动虚拟网络</title>
    <para>
     要启动某个暂时停止的虚拟网络，请执行以下步骤：
    </para>
    <procedure>
     <step>
      <para>
       启动虚拟机管理器。在可用连接列表中，右键单击您需要为其配置虚拟网络的连接名称，然后选择<guimenu>细节</guimenu>。
      </para>
     </step>
     <step>
      <para>
       在<guimenu>连接细节</guimenu>窗口中，单击<guimenu>虚拟网络</guimenu>选项卡。您会看到可用于当前连接的所有虚拟网络的列表。
      </para>
     </step>
     <step>
      <para>
       要启动虚拟网络，请单击<guimenu>启动</guimenu>。
      </para>
     </step>
    </procedure>
   </sect3>
   <sect3 xml:id="libvirt-networks-virtual-vmm-stop">
    <title>停止虚拟网络</title>
    <para>
     要停止活动的虚拟网络，请执行以下步骤：
    </para>
    <procedure>
     <step>
      <para>
       启动虚拟机管理器。在可用连接列表中，右键单击您需要为其配置虚拟网络的连接名称，然后选择<guimenu>细节</guimenu>。
      </para>
     </step>
     <step>
      <para>
       在<guimenu>连接细节</guimenu>窗口中，单击<guimenu>虚拟网络</guimenu>选项卡。您会看到可用于当前连接的所有虚拟网络的列表。
      </para>
     </step>
     <step>
      <para>
       选择要停止的虚拟网络，然后单击<guimenu>停止</guimenu>。
      </para>
     </step>
    </procedure>
   </sect3>
   <sect3 xml:id="libvirt-networks-virtual-vmm-delete">
    <title>删除虚拟网络</title>
    <para>
     要删除 VM 主机服务器中的虚拟网络，请执行以下步骤：
    </para>
    <procedure>
     <step>
      <para>
       启动虚拟机管理器。在可用连接列表中，右键单击您需要为其配置虚拟网络的连接名称，然后选择<guimenu>细节</guimenu>。
      </para>
     </step>
     <step>
      <para>
       在<guimenu>连接细节</guimenu>窗口中，单击<guimenu>虚拟网络</guimenu>选项卡。您会看到可用于当前连接的所有虚拟网络的列表。
      </para>
     </step>
     <step>
      <para>
       选择要删除的虚拟网络，然后单击<guimenu>删除</guimenu>。
      </para>
     </step>
    </procedure>
   </sect3>
   <sect3 xml:id="libvirt-networks-virtual-vmm-nsswitch">

    <title>使用 <command>nsswitch</command> 获取 NAT 网络的 IP 地址（在 KVM 中）</title>
    <itemizedlist>
     <listitem>
      <para>
       在 VM 主机服务器上，安装用来为 libvirt 提供 NSS 支持的 libvirt-nss：
      </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> zypper in libvirt-nss</screen>
     </listitem>
     <listitem>
      <para>
       将 <literal>libvirt</literal> 添加到 <filename>/etc/nsswitch.conf</filename>：
      </para>
<screen>...
hosts:  files libvirt mdns_minimal [NOTFOUND=return] dns
...</screen>
     </listitem>
     <listitem>
      <para>
       如果 NSCD 正在运行，请将其重启动：
      </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> systemctl restart nscd</screen>
     </listitem>
    </itemizedlist>
    <para>
     现在，您可以从主机按名称访问 Guest 系统了。
    </para>
    <para>
     NSS 模块的功能有限。它会读取 <filename>/var/lib/libvirt/dnsmasq/*.status</filename> 文件，以在描述 <command>dnsmasq</command> 所提供的每个租约的 JSON 记录中查找主机名和对应的 IP 地址。只能使用受 <command>dnsmasq</command> 支持且由 libvirt 管理的桥接网络在这些 VM 主机服务器上执行主机名转换。
    </para>
    <para>
     有关更多信息，请参见<link xlink:href="http://wiki.libvirt.org/page/NSS_module"/>。
    </para>
   </sect3>
  </sect2>

  <sect2 xml:id="libvirt-networks-virtual-virsh">
   <title>使用 <command>virsh</command> 管理虚拟网络</title>
   <para>
    您可以使用 <command>virsh</command> 命令行工具来管理 <systemitem class="library">libvirt</systemitem> 提供的虚拟网络。要查看所有与网络相关的 <command>virsh</command> 命令，请运行以下命令
   </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> virsh help network
Networking (help keyword 'network'):
 net-autostart                  autostart a network
        net-create                     create a network from an XML file
        net-define                     define (but don't start) a network from an XML file
        net-destroy                    destroy (stop) a network
        net-dumpxml                    network information in XML
        net-edit                       edit XML configuration for a network
        net-event                      Network Events
        net-info                       network information
        net-list                       list networks
        net-name                       convert a network UUID to network name
        net-start                      start a (previously defined) inactive network
        net-undefine                   undefine an inactive network
        net-update                     update parts of an existing network's configuration
 net-uuid                       convert a network name to network UUID</screen>
   <para>
    要查看特定 <command>virsh</command> 命令的简要帮助信息，请运行 <command>virsh help <replaceable>VIRSH_COMMAND</replaceable></command>：
   </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> virsh help net-create
  NAME
    net-create - create a network from an XML file

  SYNOPSIS
    net-create &lt;file&gt;

  DESCRIPTION
    Create a network.

  OPTIONS
    [--file] &lt;string&gt;  file containing an XML network description</screen>
   <sect3 xml:id="libvirt-networks-virtual-virsh-create">
    <title>创建网络</title>

    <para>
     要创建新的<emphasis>运行中</emphasis>虚拟网络，请运行以下命令
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> virsh net-create <replaceable>VNET_DEFINITION.xml</replaceable></screen>
    <para>
     <replaceable>VNET_DEFINITION.xml</replaceable> XML 文件包含 <systemitem class="library">libvirt</systemitem> 接受的虚拟网络的定义。
    </para>
    <para>
     要定义新虚拟网络但不激活它，请运行以下命令
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> virsh net-define <replaceable>VNET_DEFINITION.xml</replaceable></screen>
    <para>
     以下示例说明了不同类型的虚拟网络的定义。
    </para>
    <example xml:id="ex-libvirt-net-nat">
     <title>基于 NAT 的网络</title>
     <para>
      下面的配置可在 VM 主机服务器上无法使用传出连接时实现 VM Guest 传出连接。当没有 VM 主机服务器网络时，此配置可让 Guest 互相直接通讯。
     </para>
<screen>
&lt;network&gt;
&lt;name&gt;vnet_nated&lt;/name&gt;<co xml:id="vnet-xml-name"/>
&lt;bridge name="virbr1"/&gt;<co xml:id="vnet-xml-bridge"/>
 &lt;forward mode="nat"/&gt;<co xml:id="vnet-xml-forward"/>
 &lt;ip address="192.168.122.1" netmask="255.255.255.0"&gt;<co xml:id="vnet-xml-ip"/>
  &lt;dhcp&gt;
   &lt;range start="192.168.122.2" end="192.168.122.254"/&gt;<co xml:id="vnet-xml-dhcp"/>
   &lt;host mac="52:54:00:c7:92:da" name="host1.testing.com" \
    ip="192.168.1.23.101"/&gt;<co xml:id="vnet-xml-dhcp-host"/>
   &lt;host mac="52:54:00:c7:92:db" name="host2.testing.com" \
    ip="192.168.1.23.102"/&gt;
   &lt;host mac="52:54:00:c7:92:dc" name="host3.testing.com" \
    ip="192.168.1.23.103"/&gt;
  &lt;/dhcp&gt;
 &lt;/ip&gt;
&lt;/network&gt;
</screen>
     <calloutlist>
      <callout arearefs="vnet-xml-name">
       <para>
        新虚拟网络的名称。
       </para>
      </callout>
      <callout arearefs="vnet-xml-bridge">
       <para>
        用于构造虚拟网络的网桥设备的名称。定义 &lt;forward&gt; 模式为“nat”或“route”的新网络（或者不包含 &lt;forward&gt; 元素的隔离网络）时，<systemitem class="library">libvirt</systemitem> 将自动为网桥设备生成唯一的名称（如果未指定名称）。
       </para>
      </callout>
      <callout arearefs="vnet-xml-forward">
       <para>
        包含 &lt;forward&gt; 元素表示该虚拟网络将连接到物理 LAN。<literal>mode</literal> 属性指定转发方法。最常用的模式为“nat”（默认模式，表示网络地址转换）、“route”（直接转发到物理网络，不执行地址转换）和“bridge”（在 <systemitem class="library">libvirt</systemitem> 外部配置的网桥）。如果不指定 &lt;forward&gt; 元素，虚拟网络将与其他网络相隔离。有关转发模式的完整列表，请参见 <link xlink:href="http://libvirt.org/formatnetwork.html#elementsConnect"/>。
       </para>
      </callout>
      <callout arearefs="vnet-xml-ip">
       <para>
        网桥的 IP 地址和网络掩码。
       </para>
      </callout>
      <callout arearefs="vnet-xml-dhcp">
       <para>
        为虚拟网络启用 DHCP 服务器，并提供从指定的 <literal>start</literal> 到 <literal>end</literal> 属性范围内的 IP 地址。
       </para>
      </callout>
      <callout arearefs="vnet-xml-dhcp-host">
       <para>
        可选的 &lt;host&gt; 元素指定内置 DHCP 服务器要为其分配名称和预定义 IP 地址的主机。任何 IPv4 host 元素都必须指定以下设置：要为其指派给定名称的主机的 MAC 地址、要指派到该主机的 IP，以及 DHCP 服务器要为该主机分配的名称。IPv6 host 元素与 IPv4 略有不同，它没有 <literal>mac</literal> 属性，因为 MAC 地址在 IPv6 中没有明确的含义。IPv6 中使用 <literal>name</literal> 属性来标识要为其指派 IPv6 地址的主机。对于 DHCPv6，<literal>name</literal> 是由客户端发送到服务器的客户端主机的纯文本名称。请注意，您也可以使用这种指派特定 IP 地址的方法来代替 IPv4 中的 <literal>mac</literal> 属性。
       </para>
      </callout>
     </calloutlist>
    </example>
    <example>
     <title>路由网络</title>
     <para>
      下面的配置会在不应用任何 NAT 的情况下将流量从虚拟网络路由到 LAN。必须在 VM 主机服务器网络上的路由器的路由表中预定义 IP 地址范围。
     </para>
<screen>
&lt;network&gt;
 &lt;name&gt;vnet_routed&lt;/name&gt;
 &lt;bridge name="virbr1"/&gt;
 &lt;forward mode="route" dev="eth1"/&gt;<co xml:id="vnet-xml-route"/>
 &lt;ip address="192.168.122.1" netmask="255.255.255.0"&gt;
  &lt;dhcp&gt;
   &lt;range start="192.168.122.2" end="192.168.122.254"/&gt;
  &lt;/dhcp&gt;
 &lt;/ip&gt;
&lt;/network&gt;
</screen>
     <calloutlist>
      <callout arearefs="vnet-xml-route">
       <para>
        Guest 流量只能通过 VM 主机服务器上的 <systemitem>eth1</systemitem> 网络设备传出。
       </para>
      </callout>
     </calloutlist>
    </example>
    <example>
     <title>隔离网络</title>
     <para>
      此配置提供完全隔离的专用网络。Guest 可以相互通讯以及与 VM 主机服务器通讯，但无法访问 LAN 上的任何其他计算机，因为 XML 说明中没有 &lt;forward&gt; 元素。
     </para>
<screen>&lt;network&gt;
 &lt;name&gt;vnet_isolated&lt;/name&gt;
 &lt;bridge name="virbr3"/&gt;
 &lt;ip address="192.168.152.1" netmask="255.255.255.0"&gt;
  &lt;dhcp&gt;
   &lt;range start="192.168.152.2" end="192.168.152.254"/&gt;
  &lt;/dhcp&gt;
 &lt;/ip&gt;
 &lt;/network&gt;
</screen>
    </example>
    <example>
     <title>使用 VM 主机服务器上的现有网桥</title>
     <para>
      此配置说明如何使用 VM 主机服务器的现有网桥 <literal>br0</literal>。VM Guest 直接连接到物理网络。其 IP 地址全部都在物理网络的子网中，并且传入和传出连接不存在任何限制。
     </para>
<screen>&lt;network&gt;
        &lt;name&gt;host-bridge&lt;/name&gt;
        &lt;forward mode="bridge"/&gt;
        &lt;bridge name="br0"/&gt;
&lt;/network&gt;
</screen>
    </example>
   </sect3>
   <sect3 xml:id="libvirt-networks-virtual-virsh-list">
    <title>列出网络</title>
    <para>
     要列出 <systemitem class="library">libvirt</systemitem> 可用的所有虚拟网络，请运行以下命令：
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> virsh net-list --all

 Name                 State      Autostart     Persistent
----------------------------------------------------------
 crowbar              active     yes           yes
 vnet_nated           active     yes           yes
 vnet_routed          active     yes           yes
 vnet_isolated        inactive   yes           yes</screen>

    <para>
     要列出可用域，请运行以下命令：
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> virsh list
 Id    Name                           State
----------------------------------------------------
 1     nated_sles12sp3                running
 ...</screen>
    <para>
     要获取运行中域的接口列表，请运行 <option>domifaddr <replaceable>DOMAIN</replaceable></option>，或选择性地指定接口，以在输出中仅列出此接口。默认情况下，会额外输出接口的 IP 和 MAC 地址：
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> virsh domifaddr nated_sles12sp3 --interface vnet0 --source lease
 Name       MAC address          Protocol     Address
-------------------------------------------------------------------------------
 vnet0      52:54:00:9e:0d:2b    ipv6         fd00:dead:beef:55::140/64
 -          -                    ipv4         192.168.100.168/24</screen>
    <para>
     要列显与指定域关联的所有虚拟接口的简要信息，请运行以下命令：
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> virsh domiflist nated_sles12sp3
Interface  Type       Source       Model       MAC
---------------------------------------------------------
vnet0      network    vnet_nated   virtio      52:54:00:9e:0d:2b</screen>
   </sect3>
   <sect3 xml:id="libvirt-networks-virtual-virsh-info">
    <title>获取有关网络的细节</title>
    <para>
     要获取有关网络的详细信息，请运行以下命令：
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> virsh net-info vnet_routed
Name:           vnet_routed
UUID:           756b48ff-d0c6-4c0a-804c-86c4c832a498
Active:         yes
Persistent:     yes
Autostart:      yes
Bridge:         virbr5</screen>
   </sect3>
   <sect3 xml:id="libvirt-networks-virtual-virsh-start">
    <title>启动网络</title>
    <para>
     要启动某个已定义的非活动网络，请使用以下命令查找其名称（或唯一标识符，即 UUID）：
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> virsh net-list --inactive
 Name                 State      Autostart     Persistent
----------------------------------------------------------
 vnet_isolated        inactive   yes           yes</screen>
    <para>
     然后运行:
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> virsh net-start vnet_isolated
Network vnet_isolated started</screen>
   </sect3>
   <sect3 xml:id="libvirt-networks-virtual-virsh-stop">
    <title>停止网络</title>
    <para>
     要停止某个活动的网络，请使用以下命令查找其名称（或唯一标识符，即 UUID）：
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> virsh net-list --inactive
 Name                 State      Autostart     Persistent
----------------------------------------------------------
 vnet_isolated        active     yes           yes</screen>
    <para>
     然后运行:
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> virsh net-destroy vnet_isolated
Network vnet_isolated destroyed</screen>
   </sect3>
   <sect3 xml:id="libvirt-networks-virtual-virsh-undefine">
    <title>去除网络</title>
    <para>
     要从 VM 主机服务器中永久去除某个非活动网络的定义，请运行以下命令：
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> virsh net-undefine vnet_isolated
Network vnet_isolated has been undefined</screen>
   </sect3>
  </sect2>
 </sect1>
</chapter>
