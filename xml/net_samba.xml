<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter
[
  <!ENTITY % entities SYSTEM "generic-entities.ent">
    %entities;
]>
<!--PM's doc requirements:
*  Server based automounting of home directories
1.Configuration and usage description (m)
2.Firewall configuration for SMB support (m)
3.Kerberos support description (d)
This is related to #300967: Mount Server Home Directory Automatically with
Authentication.  Everything that's being done there to ensure that the users
will be able to access their home directories when hosted on CIFS.
-->
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="cha-samba">
 <title>Samba</title>
 <info>
  <abstract>
   <para>
    Using Samba, a Unix machine can be configured as a file and print server
    for macOS, Windows, and OS/2 machines. Samba has developed into a
    fully-fledged and rather complex product. Configure Samba with &yast;, or
    by editing the configuration file manually.
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker></dm:bugtracker>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <sect1 xml:id="sec-samba-term">
  <title>Terminology</title>

  <para>
   The following are some terms used in Samba documentation and in the &yast;
   module.
  </para>

  <variablelist>
   <varlistentry>
    <term>SMB protocol</term>
    <listitem>
     <para>
      Samba uses the SMB (server message block) protocol, which is based on
      <phrase role="productname">NetBIOS</phrase> services. Microsoft released
      the protocol so that software from other manufacturers could establish
      connections to a servers running Microsoft operating systems. Samba
      implements the SMB protocol on top of the TCP/IP protocol, which means
      that TCP/IP must be installed and enabled on all clients.
     </para>
     <tip arch="zseries" os="sles">
      <title>&zseries;: NetBIOS support</title>
      <para>
       &zseries; merely supports SMB over TCP/IP. NetBIOS support is not
       available on these systems.
      </para>
     </tip>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>CIFS protocol</term>
    <listitem>
     <para>
      The CIFS (Common Internet File System) protocol is an early version of
      the SMB protocol, also known as SMB1. CIFS defines a standard remote file
      system access protocol for use over TCP/IP, enabling groups of users to
      work together and share documents across the Internet.
     </para>
     <para>
      SMB1 was superseded by SMB2, first released as part of Microsoft Windows
      Vista&trade;. This was in turn superseded by SMB3 in Microsoft Windows
      8&trade; and Microsoft Windows Server 2012. In recent versions of Samba,
      SMB1 is disabled by default for security reasons.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NetBIOS</term>
    <listitem>
     <para>
      <phrase role="productname">NetBIOS</phrase> is a software interface (API)
      designed for name resolution and communication between computers on a
      network. It enables machines connected to the network to reserve names
      for themselves. After reservation, these machines can be addressed by
      name. There is no central process that checks names. Any machine on the
      network can reserve as many names as it wants, as long as the names are
      not already in use. NetBIOS can be implemented on top of different
      network protocols. One relatively simple, non-routable implementation is
      called <phrase role="productname">NetBEUI</phrase>. (This is often
      confused with the NetBIOS API.) NetBIOS is also suppported on top of the
      Novell IPX/SPX protocol. Since version 3.2, Samba supports NetBIOS over
      both IPv4 and IPv6.
     </para>
     <para>
      The NetBIOS names sent via TCP/IP have nothing in common with the names
      used in <filename>/etc/hosts</filename> or those defined by DNS. NetBIOS
      uses its own, completely independent naming convention. However, it is
      recommended to use names that correspond to DNS host names, to make
      administration easier, or to use DNS natively. This is the default used
      by Samba.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Samba server</term>
    <listitem>
     <para>
      Samba server provides SMB/CIFS services and NetBIOS over IP naming
      services to clients. For Linux, there are three daemons for the Samba
      server: <literal>smbd</literal> for SMB/CIFS services,
      <literal>nmbd</literal> for naming services, and
      <literal>winbind</literal> for authentication.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Samba client</term>
    <listitem>
     <para>
      The Samba client is a system that uses Samba services from a Samba server
      over the SMB protocol. Common operating systems, such as Windows and
      macOS, support the SMB protocol. The TCP/IP protocol must be installed on
      all computers. Samba provides a client for the different Unix flavors.
      For Linux, there is a kernel module for SMB that allows the integration
      of SMB resources on the Linux system level. You do not need to run any
      daemon for the Samba client.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Shares</term>
    <listitem>
     <para>
      SMB servers provide resources to the clients by means of
      <emphasis>shares</emphasis>. Shares are directories (including their
      subdirectories) and printers on the server. A share is exported by means
      of a <emphasis>share name</emphasis>, and can be accessed by this name.
      The share name can be set to any name&mdash;it does not need to be the
      name of the export directory. Shared printers are also assigned names.
      Clients can access shared directories and printers by their names.
     </para>
     <para>
      By convention, share names ending with a dollar symbol
      (<literal>$</literal>) are hidden; that is, when using a Windows computer
      to browse available shares, they will not be displayed.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>DC</term>
    <listitem>
     <para>
      A domain controller (DC) is a server that handles accounts in a domain.
      For data replication, it is possible to have multiple domain controllers
      in a single domain.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec-samba-server-sled" os="sled">
  <title>Installing a Samba server</title>

  <para>
   Installing a Samba server is not supported on &sled;. For information about
   installing and configuring a Samba server, see &admin; for &sls;.
  </para>
 </sect1>
 <sect1 xml:id="sec-samba-install" os="sles;osuse">
  <title>Installing a Samba server</title>

  <para>
   To install a Samba server, start &yast; and select
   <menuchoice><guimenu>Software</guimenu> <guimenu>Software
   Management</guimenu></menuchoice>. Choose
   <menuchoice><guimenu>View</guimenu> <guimenu>Patterns</guimenu></menuchoice>
   and select <guimenu>File Server</guimenu>. Confirm the installation of the
   required packages to finish the installation process.
  </para>
 </sect1>
 <sect1 xml:id="sec-samba-serv-start" os="sles;osuse">
  <title>Starting and stopping Samba</title>

  <para>
   You can start or stop the Samba server automatically (during boot) or
   manually. The starting and stopping policy is a part of the &yast; Samba
   server configuration described in <xref linkend="sec-samba-yast2-conf"/>.
  </para>

  <para>
   From a command line, stop services required for Samba with
   <command>systemctl stop smb nmb</command> and start them with
   <command>systemctl start nmb smb</command>. The <literal>smb</literal>
   service cares about <literal>winbind</literal> if needed.
  </para>

  <tip>
   <title><systemitem>winbind</systemitem></title>
   <para>
    <systemitem>winbind</systemitem> is an independent service, and as such is
    also offered as an individual <systemitem>samba-winbind</systemitem>
    package.
   </para>
  </tip>
 </sect1>
 <sect1 xml:id="sec-samba-serv-inst" os="sles;osuse">
  <title>Configuring a Samba server</title>

  <para>
   A Samba server in &productnamereg; can be configured in two different ways:
   with &yast; or manually. Manual configuration offers a higher level of
   detail, but lacks the convenience of the &yast; GUI.
  </para>

  <sect2 xml:id="sec-samba-yast2-conf">
   <title>Configuring a Samba server with &yast;</title>
   <para>
    To configure a Samba server, start &yast; and select
    <menuchoice><guimenu>Network Services</guimenu><guimenu>Samba
    Server</guimenu></menuchoice>.
   </para>
   <sect3 xml:id="sec-samba-yast2-conf-inst">
    <title>Initial Samba configuration</title>
    <para>
     When starting the module for the first time, the <guimenu>Samba
     Installation</guimenu> dialog starts, prompting you to make a few basic
     decisions concerning administration of the server. At the end of the
     configuration, it prompts for the Samba administrator password
     (<guimenu>Samba Root Password</guimenu>). For later starts, the
     <guimenu>Samba Configuration</guimenu> dialog appears.
    </para>
    <para>
     The <guimenu>Samba Installation</guimenu> dialog consists of two steps and
     optional detailed settings:
    </para>
    <variablelist>
     <varlistentry>
      <term>Workgroup or domain name</term>
      <listitem>
       <para>
        Select an existing name from <guimenu>Workgroup or Domain
        Name</guimenu> or enter a new one and click <guimenu>Next</guimenu>.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Samba server type</term>
      <listitem>
       <para>
        In the next step, specify whether your server should act as a primary
        domain controller (PDC), backup domain controller (BDC), or not act as
        a domain controller. Continue with <guimenu>Next</guimenu>.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     If you do not want to proceed with a detailed server configuration,
     confirm with <guimenu>OK</guimenu>. Then in the final pop-up box, set the
     <guimenu>Samba root Password</guimenu>.
    </para>
    <para>
     You can change all settings later in the <guimenu>Samba
     Configuration</guimenu> dialog with the <guimenu>Start-Up</guimenu>,
     <guimenu>Shares</guimenu>, <guimenu>Identity</guimenu>, <guimenu>Trusted
     Domains</guimenu>, and <guimenu>LDAP Settings</guimenu> tabs.
    </para>
   </sect3>
   <sect3 xml:id="sec-samba-server-new-protocol">
    <title>Enabling current versions of the SMB protocol on the server</title>
    <para>
     On clients running current versions of &productname; or other recent Linux
     versions, the insecure SMB1/CIFS protocol is disabled by default. However,
     existing instances of Samba may be configured to only serve shares using
     the SMB1/CIFS version of the protocol. To interact with such clients, you
     need to configure Samba to serve shares using at least the SMB 2.1
     protocol.
    </para>
    <para>
     There are setups in which only SMB1 can be used&mdash;for example, because
     they rely on SMB1's/CIFS's Unix extensions. These extensions have not been
     ported to newer protocol versions. If you are in this situation, consider
     changing your setup or see <xref linkend="sec-samba-client-old-server"/>.
    </para>
    <para>
     To do so, in the configuration file
     <filename>/etc/samba/smb.conf</filename>, set the global parameter
     <literal>server max protocol = SMB2_10</literal>. For a list of all
     possible values, see <command>man smb.conf</command>.
    </para>
   </sect3>
   <sect3 xml:id="sec-samba-yast2-conf-adv">
    <title>Advanced Samba configuration</title>
    <para>
     During the first start of the Samba server module, the <guimenu>Samba
     Configuration</guimenu> dialog appears directly after the two initial
     steps described in <xref linkend="sec-samba-yast2-conf-inst"/>. Use it to
     adjust your Samba server configuration.
    </para>
    <para>
     After editing your configuration, click <guimenu>OK</guimenu> to save your
     settings.
    </para>
    <sect4 xml:id="sec-samba-yast2-conf-adv-start">
     <title>Starting the server</title>
     <para>
      In the <guimenu>Start Up</guimenu> tab, configure the start of the Samba
      server. To start the service every time your system boots, select
      <guimenu>During Boot</guimenu>. To activate manual start, choose
      <guimenu>Manually</guimenu>. More information about starting a Samba
      server is provided in <xref linkend="sec-samba-serv-start"/>.
     </para>
     <para>
      In this tab, you can also open ports in your firewall. To do so, select
      <guimenu>Open Port in Firewall</guimenu>. If you have multiple network
      interfaces, select the network interface for Samba services by clicking
      <guimenu>Firewall Details</guimenu>, selecting the interfaces, and
      clicking <guimenu>OK</guimenu>.
     </para>
    </sect4>
    <sect4 xml:id="sec-samba-yast2-conf-adv-shares">
     <title>Shares</title>
     <para>
      In the <guimenu>Shares</guimenu> tab, determine the Samba shares to
      activate. There are some predefined shares, like homes and printers. Use
      <guimenu>Toggle Status</guimenu> to switch between
      <guimenu>Active</guimenu> and <guimenu>Inactive</guimenu>. Click
      <guimenu>Add</guimenu> to add new shares and <guimenu>Delete</guimenu> to
      delete the selected share.
     </para>
     <para>
      <guimenu>Allow Users to Share Their Directories</guimenu> enables members
      of the group in <guimenu>Permitted Group</guimenu> to share directories
      they own with other users. For example, <systemitem>users</systemitem>
      for a local scope or <systemitem>DOMAIN\Users</systemitem> for a domain
      scope. The user also must make sure that the file system permissions
      allow access. With <guimenu>Maximum Number of Shares</guimenu>, limit the
      total amount of shares that may be created. To permit access to user
      shares without authentication, enable <guimenu>Allow Guest
      Access</guimenu>.
     </para>
    </sect4>
    <sect4 xml:id="sec-samba-yast2-conf-adv-identity">
     <title>Identity</title>
     <para>
      In the <guimenu>Identity</guimenu> tab, you can determine the domain with
      which the host is associated (<guimenu>Base Settings</guimenu>) and
      whether to use an alternative host name in the network (<guimenu>NetBIOS
      Hostname</guimenu>).
      <!--
       [x] Retrieve WINS server via DHCP
       [ ] Use WINS for Hostname Resolution
       -->
      It is also possible to use Microsoft Windows Internet Name Service (WINS)
      for name resolution. In this case, activate <guimenu>Use WINS for
      Hostname Resolution</guimenu> and decide whether to <guimenu>Retrieve
      WINS server via DHCP</guimenu>. To set expert global settings or set a
      user authentication source, <phrase os="sles;osuse">for example LDAP
      instead of TDB database, </phrase>click <guimenu>Advanced
      Settings</guimenu>.
     </para>
    </sect4>
    <sect4 xml:id="sec-samba-yast2-conf-adv-trusted">
     <title>Trusted domains</title>
     <para>
      To enable users from other domains to access your domain, make the
      appropriate settings in the <guimenu>Trusted Domains</guimenu> tab. To
      add a new domain, click <guimenu>Add</guimenu>. To remove the selected
      domain, click <guimenu>Delete</guimenu>.
     </para>
    </sect4>
    <sect4 xml:id="sec-samba-yast2-conf-adv-ldap">
     <title>LDAP settings</title>
     <para>
      In the tab <guimenu>LDAP Settings</guimenu>, you can determine the LDAP
      server to use for authentication. To test the connection to your LDAP
      server, click <guimenu>Test Connection</guimenu>. To set expert LDAP
      settings or use default values, click <guimenu>Advanced
      Settings</guimenu>.
     </para>
     <para>
      For more information about LDAP configuration, see
      <xref linkend="cha-security-ldap"/>.
     </para>
    </sect4>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-samba-serv-inst-manual">
   <title>Configuring the server manually</title>
   <para>
    If you intend to use Samba as a server, install
    <systemitem class="resource">samba</systemitem>. The main configuration
    file for Samba is <filename>/etc/samba/smb.conf</filename>. This file can
    be divided into two logical parts. The <literal>[global]</literal> section
    contains the central and global settings. The following default sections
    contain the individual file and printer shares:
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      [homes]
     </para>
    </listitem>
    <listitem>
     <para>
      [profiles]
     </para>
    </listitem>
    <listitem>
     <para>
      [users]
     </para>
    </listitem>
    <listitem>
     <para>
      [groups]
     </para>
    </listitem>
    <listitem>
     <para>
      [printers]
     </para>
    </listitem>
    <listitem>
     <para>
      [print$]
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Using this approach, options of the shares can be set differently or
    globally in the <literal>[global]</literal> section, which makes the
    configuration file easier to understand.
   </para>
   <sect3 xml:id="sec-samba-smb-conf-Erlaeuterung">
    <title>The global section</title>
    <para>
     The following parameters of the <literal>[global]</literal> section should
     be modified to match the requirements of your network setup, so other
     machines can access your Samba server via SMB in a Windows environment.
    </para>
    <remark>ke: Important entries missing?</remark>
    <variablelist>
     <varlistentry>
      <term><literal>workgroup = WORKGROUP</literal></term>
      <listitem>
       <para>
        This line assigns the Samba server to a workgroup. Replace
        <literal>WORKGROUP</literal> with an appropriate workgroup of your
        networking environment. Your Samba server appears under its DNS name
        unless this name has been assigned to some other machine in the
        network. If the DNS name is not available, set the server name using
        <literal>netbiosname=<replaceable>MYNAME</replaceable></literal>. For
        more details about this parameter, see the
        <systemitem>smb.conf</systemitem> man page.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>os level = 20</literal></term>
      <listitem>
       <para>
        This parameter triggers whether your Samba server tries to become LMB
        (local master browser) for its workgroup. Choose a very low value such
        as <literal>2</literal> to spare the existing Windows network from any
        interruptions caused by a misconfigured Samba server. More information
        about this topic can be found in the Network Browsing chapter of the
        Samba 3 Howto; for more information on the Samba 3 Howto, see
        <xref linkend="sec-samba-info"/>.
       </para>
       <para>
        If no other SMB server is in your network (such as a Windows 2000
        server) and you want the Samba server to keep a list of all systems
        present in the local environment, set the <literal>os level</literal>
        to a higher value (for example, <literal>65</literal>). Your Samba
        server is then chosen as LMB for your local network.
       </para>
       <para>
        When changing this setting, consider carefully how this could affect an
        existing Windows network environment. First test the changes in an
        isolated network or at a noncritical time of day.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>wins support</literal> and <literal>wins server</literal></term>
      <listitem>
       <para>
        To integrate your Samba server into an existing Windows network with an
        active WINS server, enable the <option>wins server</option> option and
        set its value to the IP address of that WINS server.
       </para>
       <para>
        If your Windows machines are connected to separate subnets and need to
        still be aware of each other, you need to set up a WINS server. To turn
        a Samba server into such a WINS server, set the option <literal>wins
        support = Yes</literal>. Make sure that only one Samba server of the
        network has this setting enabled. The options <literal>wins
        server</literal> and <literal>wins support</literal> must never be
        enabled at the same time in your <filename>smb.conf</filename> file.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="sec-samba-smb-conf-shares">
    <title>Shares</title>
    <para>
     The following examples illustrate how a CD-ROM drive and the user
     directories (<literal>homes</literal>) are made available to the SMB
     clients.
    </para>
    <variablelist>
     <varlistentry>
      <term>[cdrom]</term>
      <listitem>
       <para>
        To avoid having the CD-ROM drive accidentally made available, these
        lines are deactivated with comment marks (semicolons in this case).
        Remove the semicolons in the first column to share the CD-ROM drive
        with Samba.
       </para>
       <example xml:id="dat-cd-rom">
        <title>A CD-ROM share</title>
<screen>[cdrom]
       comment = Linux CD-ROM
       path = /media/cdrom
       locking = No</screen>
       </example>
       <variablelist>
        <varlistentry>
         <term><option>[cdrom]</option> and <option>comment</option></term>
         <listitem>
          <para>
           The <literal>[cdrom]</literal> section entry is the name of the
           share that can be seen by all SMB clients on the network. An
           additional <literal>comment</literal> can be added to further
           describe the share.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><option>path = /media/cdrom</option></term>
         <listitem>
          <para>
           <option>path</option> exports the directory
           <filename>/media/cdrom</filename>.
          </para>
         </listitem>
        </varlistentry>
       </variablelist>
       <para>
        By means of a very restrictive default configuration, this kind of
        share is only made available to the users present on this system. If
        this share should be made available to everybody, add a line
        <literal>guest ok = yes</literal> to the configuration. This setting
        gives read permissions to anyone on the network. It is recommended to
        handle this parameter with great care. This applies even more to the
        use of this parameter in the <literal>[global]</literal> section.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>[homes]</option></term>
      <listitem>
       <para>
        The <option>[homes]</option> share is of special importance here. If
        the user has a valid account and password for the Linux file server and
        their own home directory, they can be connected to it.
       </para>
       <example xml:id="dat-homes-frei">
        <title>[homes] share</title>
<screen>[homes]
        comment = Home Directories
        valid users = %S
        browseable = No
        read only = No
        inherit acls = Yes</screen>
       </example>
       <variablelist>
        <varlistentry>
         <term>[homes]</term>
         <listitem>
          <para>
           As long as there is no other share using the share name of the user
           connecting to the SMB server, a share is dynamically generated using
           the <literal>[homes]</literal> share directives. The resulting name
           of the share is the user name.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><option>valid users = %S</option></term>
         <listitem>
          <para>
           <literal>%S</literal> is replaced with the concrete name of the
           share when a connection has been successfully established. For a
           <option>[homes]</option> share, this is always the user name. As a
           consequence, access rights to a user's share are restricted
           exclusively to that user.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><option>browseable = No</option></term>
         <listitem>
          <para>
           This setting makes the share invisible in the network environment.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><option>read only = No</option></term>
         <listitem>
          <para>
           By default, Samba prohibits write access to any exported share by
           means of the <literal>read only = Yes</literal> parameter. To make a
           share writable, set the value <literal>read only = No</literal>,
           which is synonymous with <literal>writable = Yes</literal>.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><option>create mask = 0640</option></term>
         <listitem>
          <para>
           Systems that are not based on MS Windows NT do not understand the
           concept of Unix permissions, so they cannot assign permissions when
           creating a file. The parameter <literal>create mask</literal>
           defines the access permissions assigned to newly created files. This
           only applies to writable shares. In effect, this setting means the
           owner has read and write permissions and the members of the owner's
           primary group have read permissions. <option>valid users =
           %S</option> prevents read access even if the group has read
           permissions. For the group to have read or write access, deactivate
           the line <option>valid users = %S</option>.
          </para>
         </listitem>
        </varlistentry>
       </variablelist>
      </listitem>
     </varlistentry>
    </variablelist>
    <warning>
     <title>Do not share <literal>NFS</literal> mounts with Samba</title>
     <para>
      Sharing <literal>NFS</literal> mounts with Samba may result in data loss
      and is not supported. Install Samba directly on the file server or
      consider using alternatives such as <literal>iSCSI</literal>.
     </para>
    </warning>
   </sect3>
   <sect3 xml:id="sec-samba-rechte">
    <title>Security levels</title>
    <para>
     To improve security, each share access can be protected with a password.
     SMB offers the following ways of checking permissions:
    </para>
    <variablelist>
     <varlistentry>
      <term>User level security (<literal>security = user</literal>)</term>
      <listitem>
       <para>
        This variant introduces the concept of the user to SMB. Each user must
        register with the server with their own password. After registration,
        the server can grant access to individual exported shares dependent on
        user names.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>ADS level security (<literal>security = ADS</literal>)</term>
      <listitem>
       <para>
        In this mode, Samba will act as a domain member in an Active Directory
        environment. To operate in this mode, the machine running Samba needs
        Kerberos installed and configured. You must join the machine using
        Samba to the ADS realm. This can be done using the &yast;
        <guimenu>Windows Domain Membership</guimenu> module.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Domain level security (<literal>security = domain</literal>)</term>
      <listitem>
       <para>
        This mode will only work correctly if the machine has been joined to a
        Windows NT domain. Samba will try to validate the user name and
        password by passing it to a Windows Primary or Backup Domain
        Controller, the same way as a Windows Server would do. It expects the
        encrypted passwords parameter to be set to <literal>yes</literal>.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     The selection of share, user, server, or domain level security applies to
     the entire server. It is not possible to offer individual shares of a
     server configuration with share level security and others with user level
     security. However, you can run a separate Samba server for each configured
     IP address on a system.
    </para>
    <para>
     More information about this subject can be found in the Samba 3 HOWTO. For
     multiple servers on one system, pay attention to the options
     <option>interfaces</option> and <option>bind interfaces only</option>.
    </para>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-samba-client-inst">
  <title>Configuring clients</title>

  <para>
   Clients can only access the Samba server via TCP/IP. NetBEUI and NetBIOS via
   IPX cannot be used with Samba.
  </para>

  <sect2 xml:id="sec-samba-client-inst-yast">
   <title>Configuring a Samba client with &yast;</title>
   <para>
    Configure a Samba client to access resources (files or printers) on the
    Samba or Windows server. Enter the Windows or Active Directory domain or
    workgroup in the dialog <menuchoice> <guimenu>Network Services</guimenu>
    <guimenu>Windows Domain Membership</guimenu></menuchoice>. If you activate
    <guimenu>Also Use SMB Information for Linux Authentication</guimenu>, the
    user authentication runs over the Samba, Windows, or Kerberos server.
   </para>
   <para>
    Click <guimenu>Expert Settings</guimenu> for advanced configuration
    options. For example, use the <guimenu>Mount Server Directories</guimenu>
    table to enable mounting server home directory automatically with
    authentication. This way users can access their home directories when
    hosted on CIFS. For details, see the <systemitem>pam_mount</systemitem> man
    page.
   </para>
   <para>
    After completing all settings, confirm the dialog to finish the
    configuration.
   </para>
  </sect2>

  <sect2 xml:id="sec-samba-client-old-server">
   <title>Mounting SMB1/CIFS shares on clients</title>
   <para>
    The first version of the SMB network protocol, SMB1 or CIFS, is an old and
    insecure protocol, which has been deprecated by its originator Microsoft.
    For security reasons, the <command>mount</command> command on &productname;
    will only mount SMB shares using newer protocol versions by default, namely
    SMB 2.1, SMB 3.0, or SMB 3.02.
   </para>
   <para>
    However, this change only affects <command>mount</command> and mounting via
    <filename>/etc/fstab</filename>. SMB1 is still available by explicitly
    requiring it. Use the following:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      The <command>smbclient</command> tool.
     </para>
    </listitem>
    <listitem>
     <para>
      The Samba server software shipped with
      <!-- NB: profiling below is intentional - we don't support using SLED
       as a Samba server. -->
      <phrase os="sles;sled">&sls;</phrase><phrase os="osuse">&opensuse;</phrase>.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    There are setups in which this default setting will lead to connection
    failures, because only SMB1 can be used:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Setups using an SMB server that does not support newer SMB protocol
      versions. Windows has offered SMB 2.1 support since Windows 7 and Windows
      Server 2008.
     </para>
    </listitem>
    <listitem>
     <para>
      Setups that rely on SMB1's/CIFS's Unix extensions. These extensions have
      not been ported to newer protocol versions.
     </para>
    </listitem>
   </itemizedlist>
   <important>
    <title>Decreased system security</title>
    <para>
     Following the instruction below makes it possible to exploit security
     issues. For more information about the issues, see
     <link xlink:href="https://blogs.technet.microsoft.com/filecab/2016/09/16/stop-using-smb1/"/>.
    </para>
    <para>
     As soon as possible, upgrade your server to allow for a more secure SMB
     version.
    </para>
    <para os="sles;osuse">
     For information about enabling suitable protocol versions on
     &productname;, see <xref linkend="sec-samba-server-new-protocol"/>.
    </para>
   </important>
   <para>
    If you need to enable SMB1 shares on the current &productname; kernel, add
    the option <option>vers=1.0</option> to the <command>mount</command>
    command line you use:
   </para>
<screen>&prompt.root;mount -t cifs //<replaceable>HOST</replaceable>/<replaceable>SHARE</replaceable> /<replaceable>MOUNT_POINT</replaceable> –o username=<replaceable>USER_ID</replaceable>,<emphasis role="bold">vers=1.0</emphasis></screen>
   <para>
    Alternatively, you can enable SMB1 shares globally within your
    &productname; installation. To do so, add the following to
    <filename>/etc/samba/smb.conf</filename> under the section
    <literal>[global]</literal>:
   </para>
   <!-- Screen indentation is intentional, to match typical config file
    indentation level. -->
<screen>        client min protocol = CORE</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-samba-anmeld-serv">
  <title>Samba as login server</title>

  <para>
   In business settings, it is often desirable to allow access only to users
   registered on a central instance. In a Windows-based network, this task is
   handled by a primary domain controller (PDC). You can use a Windows Server
   configured as PDC, but this task can also be done with a Samba server. The
   entries that must be made in the <literal>[global]</literal> section of
   <filename>smb.conf</filename> are shown in
   <xref linkend="dat-samba-smb-conf-dom"/>.
  </para>

  <example xml:id="dat-samba-smb-conf-dom">
   <title>Global section in smb.conf</title>
<screen>[global]
    workgroup = WORKGROUP
    domain logons = Yes
    domain master = Yes</screen>
  </example>

  <para>
   It is necessary to prepare user accounts and passwords in an encryption
   format that conforms with Windows. Do this with the command
   <command>smbpasswd</command> <option>-a name</option>. Create the domain
   account for the computers, required by the Windows domain concept, with the
   following commands:
  </para>

<screen>useradd hostname
smbpasswd -a -m hostname</screen>

  <para>
   With the <command>useradd</command> command, a dollar sign is added. The
   command <command>smbpasswd</command> inserts this automatically when the
   parameter <option>-m</option> is used. The commented configuration example
   (<filename>/usr/share/doc/packages/samba/examples/smb.conf.SUSE</filename>)
   contains settings that automate this task.
  </para>

<screen>add machine script = /usr/sbin/useradd -g nogroup -c "NT Machine Account" \
-s /bin/false %m
     </screen>

  <para>
   To make sure that Samba can execute this script correctly, choose a Samba
   user with the required administrator permissions and add it to the
   <systemitem class="groupname">ntadmin</systemitem> group. Then all users
   belonging to this Linux group can be assigned <literal>Domain
   Admin</literal> status with the command:
  </para>

<screen>net groupmap add ntgroup="Domain Admins" unixgroup=ntadmin</screen>
 </sect1>
 <sect1 xml:id="sec-samba-adnet" os="sles;osuse">
  <title>Samba server in the network with Active Directory</title>

  <para>
   If you run Linux servers and Windows servers together, you can build two
   independent authentication systems and networks or connect servers to one
   network with one central authentication system. Because Samba can cooperate
   with an Active Directory domain, you can join your &productname; server with
   an Active Directory (AD) domain.
  </para>

  <para>
   To join an AD domain proceed as follows:
  </para>

  <procedure>
   <step>
    <para>
     Log in as &rootuser; and start &yast;.
    </para>
   </step>
   <step>
    <para>
     Start <menuchoice> <guimenu>Network Services</guimenu> <guimenu>Windows
     Domain Membership</guimenu> </menuchoice>.
    </para>
   </step>
   <step>
    <para>
     Enter the domain to join in the <guimenu>Domain or Workgroup</guimenu>
     field in the <guimenu>Windows Domain Membership</guimenu> screen.
    </para>
    <figure>
     <title>Determining Windows domain membership</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="ad_sambaclient.png" width="75%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="ad_sambaclient.png" format="PNG"/>
      </imageobject>
     </mediaobject>
    </figure>
   </step>
   <step>
    <para>
     Check <guimenu>Also Use SMB Information for Linux Authentication</guimenu>
     to use the SMB source for Linux authentication on your server.
    </para>
   </step>
   <step>
    <para>
     Click <guimenu>OK</guimenu> and confirm the domain join when prompted for
     it.
    </para>
   </step>
   <step>
    <para>
     Provide the password for the Windows Administrator on the AD server and
     click <guimenu>OK</guimenu>.
    </para>
    <para>
     Your server is now set up to pull in all authentication data from the
     Active Directory domain controller.
    </para>
   </step>
  </procedure>

  <tip>
   <title>Identity mapping</title>
   <para>
    In an environment with more than one Samba server, UIDs and GIDs will not
    be created consistently. The UIDs that get assigned to users will be
    dependent on the order in which they first log in, which results in UID
    conflicts across servers. To fix this, you need to use identity mapping.
    See
    <link xlink:href="https://www.samba.org/samba/docs/man/Samba-HOWTO-Collection/idmapper.html"/>
    for more details.
   </para>
  </tip>
 </sect1>
 <sect1 xml:id="sec-samba-advanced">
  <title>Advanced topics</title>

  <para>
   This section introduces more advanced techniques to manage both the client
   and server parts of the Samba suite.
  </para>

  <sect2 xml:id="sec-automount-systemd">
   <title>Automounting CIFS file system using &systemd;</title>
   <para>
    You can use &systemd; to mount CIFS shares on startup. To do so, proceed as
    described further:
   </para>
   <procedure>
    <step>
     <para>
      Create the mount points:
     </para>
<screen>&prompt.user;mkdir -p <replaceable>PATH_SERVER_SHARED_FOLDER</replaceable></screen>
     <para>
      where <replaceable>PATH_SERVER_SHARED_FOLDER</replaceable> is
      <literal>/cifs/shared</literal> in further steps.
     </para>
    </step>
    <step>
     <para>
      Create the &systemd; unit file and generate a file name from the path
      specified in the previous step where "/" are replaced with "-", for
      example:
     </para>
<screen>&prompt.sudo;touch /etc/systemd/system/cifs-shared.mount</screen>
     <para>
      with the following content:
     </para>
<screen>
[Unit]
Description=CIFS share from The-Server

[Mount]
What=//The-Server/Shared-Folder
Where=/cifs/shared
Type=cifs
Options=rw,username=vagrant,password=admin

[Install]
WantedBy=multi-user.target
            </screen>
    </step>
    <step>
     <para>
      Enable the service:
     </para>
<screen>&prompt.sudo;systemctl enable cifs-shared.mount</screen>
    </step>
    <step>
     <para>
      Start the service:
     </para>
<screen>&prompt.sudo;systemctl start cifs-shared.mount</screen>
     <para>
      To verify that the service is running, run the command:
     </para>
<screen>&prompt.sudo;systemctl status cifs-shared.mount</screen>
    </step>
    <step>
     <para>
      To confirm that the CIFS shared path is available, try the following
      command:
     </para>
<screen>&prompt.user; cd /cifs/shared
&prompt.user;ls -l

total 0
-rwxrwxrwx. 1 root    root    0 Oct 24 22:31 hello-world-cifs.txt
drwxrwxrwx. 2 root    root    0 Oct 24 22:31 subfolder
-rw-r--r--. 1 vagrant vagrant 0 Oct 28 21:51 testfile.txt
            </screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec-samba-advanced-compress">
   <title>Transparent file compression on Btrfs</title>
   <para>
    Samba allows clients to remotely manipulate file and directory compression
    flags for shares placed on the Btrfs file system. Windows Explorer provides
    the ability to flag files/directories for transparent compression via the
    <menuchoice><guimenu>File</guimenu><guimenu>Properties</guimenu><guimenu>Advanced</guimenu></menuchoice>
    dialog:
   </para>
   <figure>
    <title>Windows Explorer <guimenu>Advanced Attributes</guimenu> dialog</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="samba_win_expl_advattr.png" width="75%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="samba_win_expl_advattr.png" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    Files flagged for compression are transparently compressed and decompressed
    by the underlying file system when accessed or modified. This normally
    results in storage capacity savings at the expense of extra CPU overhead
    when accessing the file. New files and directories inherit the compression
    flag from the parent directory, unless created with the FILE_NO_COMPRESSION
    option.
   </para>
   <para>
    Windows Explorer presents compressed files and directories visually
    differently to those that are not compressed:
   </para>
   <figure>
    <title>Windows Explorer directory listing with compressed files</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="samba_win_expl_view_compressed.png" width="75%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="samba_win_expl_view_compressed.png" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    You can enable Samba share compression either manually by adding
   </para>
<screen>vfs objects = btrfs</screen>
   <para>
    to the share configuration in <filename>/etc/samba/smb.conf</filename>, or
    using &yast;: <menuchoice><guimenu>Network Services</guimenu><guimenu>Samba
    Server</guimenu><guimenu>Add</guimenu></menuchoice>, and checking
    <guimenu>Utilize Btrfs Features</guimenu>.
   </para>
   <para os="sles">
    A general overview of compression on Btrfs can be found in
    <xref linkend="sec-filesystems-major-btrfs-compress"/>.
   </para>
  </sect2>

  <sect2 xml:id="sec-samba-advanced-snapshots">
   <title>Snapshots</title>
   <para>
    Snapshots, also called Shadow Copies, are copies of the state of a file
    system subvolume at a certain point in time. Snapper is the tool to manage
    these snapshots in Linux. Snapshots are supported on the Btrfs file system
    or thinly provisioned LVM volumes. The Samba suite supports managing remote
    snapshots through the FSRVP protocol on both the server and client side.
   </para>
   <sect3 xml:id="sec-samba-advanced-snapshots-client">
    <title>Previous versions</title>
    <para>
     Snapshots on a Samba server can be exposed to remote Windows clients as
     previous versions of files or directories.
    </para>
    <para>
     To enable snapshots on a Samba server, the following conditions must be
     fulfilled:
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       The SMB network share resides on a Btrfs subvolume.
      </para>
     </listitem>
     <listitem>
      <para>
       The SMB network share path has a related Snapper configuration file. You
       can create the snapper file with
      </para>
<screen>&prompt.sudo;snapper -c &lt;cfg_name&gt; create-config <option>/path/to/share</option></screen>
      <para>
       For more information on Snapper, see <xref linkend="cha-snapper"/>.
      </para>
     </listitem>
     <listitem>
      <para>
       The snapshot directory tree must allow access for relevant users. For
       more information, see the PERMISSIONS section of the vfs_snapper manual
       page (<command>man 8 vfs_snapper</command>).
      </para>
     </listitem>
    </itemizedlist>
    <para>
     To support remote snapshots, you need to modify the
     <filename>/etc/samba/smb.conf</filename> file. You can do this either with
     <menuchoice><guimenu>&yast;</guimenu><guimenu>Network
     Services</guimenu><guimenu>Samba Server</guimenu></menuchoice>, or
     manually by enhancing the relevant share section with
    </para>
<screen>vfs objects = snapper</screen>
    <para>
     Note that you need to restart the Samba service for manual changes to
     <filename>smb.conf</filename> to take effect:
    </para>
<screen>&prompt.sudo;systemctl restart nmb smb</screen>
    <figure xml:id="fig-yast2-samba-snapshot">
     <title>Adding a new Samba share with snapshots enabled</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="yast2_samba_snapshot.png" width="75%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="yast2_samba_snapshot.png" format="PNG"/>
      </imageobject>
     </mediaobject>
    </figure>
    <para>
     After being configured, snapshots created by Snapper for the Samba share
     path can be accessed from Windows Explorer from a file or directory's
     <guimenu>Previous Versions</guimenu> tab.
    </para>
    <figure xml:id="fig-samba-win-explorer">
     <title>The <guimenu>Previous versions</guimenu> tab in Windows explorer</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="samba_winexpl_previous_versions.png" width="75%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="samba_winexpl_previous_versions.png" format="PNG"/>
      </imageobject>
     </mediaobject>
    </figure>
   </sect3>
   <sect3 xml:id="sec-samba-advanced-snapshots-server">
    <title>Remote share snapshots</title>
    <para>
     By default, snapshots can only be created and deleted on the Samba server
     locally, via the Snapper command line utility, or using Snapper's timeline
     feature.
    </para>
    <para>
     Samba can be configured to process share snapshot creation and deletion
     requests from remote hosts using the File Server Remote VSS Protocol
     (FSRVP).
    </para>
    <para>
     In addition to the configuration and prerequisites documented in
     <xref linkend="sec-samba-advanced-snapshots-client"/>, the following
     global configuration is required in
     <filename>/etc/samba/smb.conf</filename>:
    </para>
<screen>[global]
rpc_daemon:fssd = fork
registry shares = yes
include = registry</screen>
    <para>
     FSRVP clients, including Samba's <command>rpcclient</command> and Windows
     Server 2012 <command>DiskShadow.exe</command>, can then instruct Samba to
     create or delete a snapshot for a given share, and expose the snapshot as
     a new share.
    </para>
   </sect3>
   <sect3 xml:id="sec-samba-advanced-snapshots-client-linux">
    <title>Managing snapshots remotely from Linux with <command>rpcclient</command></title>
    <para>
     The <systemitem>samba-client</systemitem> package contains an FSRVP client
     that can remotely request a Windows/Samba server to create and expose a
     snapshot of a given share. You can then use existing tools in
     &productname; to mount the exposed share and back up its files. Requests
     to the server are sent using the <command>rpcclient</command> binary.
    </para>
    <example>
     <title>Using <command>rpcclient</command> to request a Windows server 2012 share snapshot</title>
     <para>
      Connect to <literal>win-server.example.com</literal> server as an
      administrator in an <literal>EXAMPLE</literal> domain:
     </para>
<screen>&prompt.root;rpcclient -U '<replaceable>EXAMPLE</replaceable>\Administrator' ncacn_np:<replaceable>win-server.example.com</replaceable>[ndr64,sign]
Enter EXAMPLE/Administrator's password:</screen>
     <para>
      Check that the SMB share is visible for <command>rpcclient</command>:
     </para>
<screen>&prompt.root;rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)</screen>
     <para>
      Check that the SMB share supports snapshot creation:
     </para>
<screen>&prompt.root;rpcclient $&gt; fss_is_path_sup windows_server_2012_share \
UNC \\WIN-SERVER\windows_server_2012_share\ supports shadow copy requests</screen>
     <para>
      Request the creation of a share snapshot:
     </para>
<screen>&prompt.root;rpcclient $&gt; fss_create_expose backup ro windows_server_2012_share
13fe880e-e232-493d-87e9-402f21019fb6: shadow-copy set created
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
\\WIN-SERVER\windows_server_2012_share\ shadow-copy added to set
13fe880e-e232-493d-87e9-402f21019fb6: prepare completed in 0 secs
13fe880e-e232-493d-87e9-402f21019fb6: commit completed in 1 secs
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
share windows_server_2012_share@{1C26544E-8251-445F-BE89-D1E0A3938777} \
exposed as a snapshot of \\WIN-SERVER\windows_server_2012_share\</screen>
     <para>
      Confirm that the snapshot share is exposed by the server:
     </para>
<screen>&prompt.root;rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)

netname: windows_server_2012_share@{1C26544E-8251-445F-BE89-D1E0A3938777}
remark: (null)
path:   \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy{F6E6507E-F537-11E3-9404-B8AC6F927453}\Shares\windows_server_2012_share\
password:       (null)</screen>
     <para>
      Attempt to delete the snapshot share:
     </para>
<screen>&prompt.root;rpcclient $&gt; fss_delete windows_server_2012_share \
13fe880e-e232-493d-87e9-402f21019fb6 1c26544e-8251-445f-be89-d1e0a3938777
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
\\WIN-SERVER\windows_server_2012_share\ shadow-copy deleted</screen>
     <para>
      Confirm that the snapshot share has been removed by the server:
     </para>
<screen>&prompt.root;rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)</screen>
    </example>
   </sect3>
   <sect3 xml:id="sec-samba-advanced-snapshots-client-winserver">
    <title>Managing snapshots remotely from Windows with <command>DiskShadow.exe</command></title>
    <para>
     You can manage snapshots of SMB shares on the Linux Samba server from
     Windows clients as well. Windows Server 2012 includes the
     <command>DiskShadow.exe</command> utility which can manage remote shares
     similarly to the <command>rpcclient</command> command described in
     <xref linkend="sec-samba-advanced-snapshots-client-linux"/>. Note that you
     need to carefully set up the Samba server first.
    </para>
    <para>
     The following is an example procedure to set up the Samba server so that
     the Windows client can manage its shares' snapshots. Note that
     <replaceable>EXAMPLE</replaceable> is the Active Directory domain used in
     the testing environment, <uri>fsrvp-server.example.com</uri> is the host
     name of the Samba server, and <filename>/srv/smb</filename> is the path to
     the SMB share.
    </para>
    <procedure>
     <title>Detailed Samba server configuration</title>
     <step>
      <para>
       Join Active Directory domain via &yast;.<phrase os="sles;osuse"> For
       more information, see <xref linkend="sec-samba-adnet"/>.</phrase>
      </para>
     </step>
     <step>
      <para>
       Ensure that the Active Directory domain's DNS entry is correct:
      </para>
<screen>fsrvp-server:~ # net -U 'Administrator' ads dns register \
fsrvp-server.example.com &lt;IP address&gt;
Successfully registered hostname with DNS</screen>
     </step>
     <step>
      <para>
       Create Btrfs subvolume at <filename>/srv/smb</filename>
      </para>
<screen>fsrvp-server:~ # btrfs subvolume create /srv/smb</screen>
     </step>
     <step>
      <para>
       Create a Snapper configuration file for the path
       <filename>/srv/smb</filename>:
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; create-config /srv/smb</screen>
     </step>
     <step>
      <para>
       Create a new share with path <filename>/srv/smb</filename>, and the
       &yast; <guimenu>Expose Snapshots</guimenu> check box enabled. Make sure
       to add the following snippets to the global section of
       <filename>/etc/samba/smb.conf</filename>, as mentioned in
       <xref linkend="sec-samba-advanced-snapshots-server"/>:
      </para>
<screen>[global]
 rpc_daemon:fssd = fork
 registry shares = yes
 include = registry</screen>
     </step>
     <step>
      <para>
       Restart Samba with <command>systemctl restart nmb smb</command>
      </para>
     </step>
     <step>
      <para>
       Configure Snapper permissions:
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; set-config \
ALLOW_USERS="EXAMPLE\\\\Administrator EXAMPLE\\\\win-client$"</screen>
      <para>
       Ensure that any instances of <literal>ALLOW_USERS</literal> are also
       permitted access to the <filename>.snapshots</filename> subdirectory.
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; set-config SYNC_ACL=yes</screen>
      <important>
       <title>Path escaping</title>
       <para>
        Be careful about the '\' escapes! Escape twice to ensure that the value
        stored in
        <filename>/etc/snapper/configs/&lt;snapper_config&gt;</filename> is
        escaped once.
       </para>
      </important>
      <para>
       "EXAMPLE\win-client$" corresponds to the Windows client computer
       account. Windows issues initial FSRVP requests while authenticated with
       this account.
      </para>
     </step>
     <step>
      <para>
       Grant Windows client account necessary privileges:
      </para>
<screen>fsrvp-server:~ # net -U 'Administrator' rpc rights grant \
"EXAMPLE\\win-client$" SeBackupPrivilege
Successfully granted rights.</screen>
      <para>
       The previous command is not needed for the "EXAMPLE\Administrator" user,
       which has privileges already granted.
      </para>
     </step>
    </procedure>
    <procedure>
     <title>Windows client setup and <command>DiskShadow.exe</command> in action</title>
     <step>
      <para>
       Boot Windows Server 2012 (example host name WIN-CLIENT).
      </para>
     </step>
     <step>
      <para>
       Join the same Active Directory domain EXAMPLE as with the &productname;.
      </para>
     </step>
     <step>
      <para>
       Reboot.
      </para>
     </step>
     <step>
      <para>
       Open Powershell.
      </para>
     </step>
     <step>
      <para>
       Start <command>DiskShadow.exe</command> and begin the backup procedure:
      </para>
<screen>PS C:\Users\Administrator.EXAMPLE&gt; diskshadow.exe
Microsoft DiskShadow version 1.0
Copyright (C) 2012 Microsoft Corporation
On computer:  WIN-CLIENT,  6/17/2014 3:53:54 PM

DISKSHADOW&gt; begin backup</screen>
     </step>
     <step>
      <para>
       Specify that shadow copies persist across program exits, resets, and
       reboots:
      </para>
<screen>DISKSHADOW&gt; set context PERSISTENT</screen>
     </step>
     <step>
      <para>
       Check whether the specified share supports snapshots, and create one:
      </para>
<screen>DISKSHADOW&gt; add volume \\fsrvp-server\sles_snapper

DISKSHADOW&gt; create
Alias VSS_SHADOW_1 for shadow ID {de4ddca4-4978-4805-8776-cdf82d190a4a} set as \
 environment variable.
Alias VSS_SHADOW_SET for shadow set ID {c58e1452-c554-400e-a266-d11d5c837cb1} \
 set as environment variable.

Querying all shadow copies with the shadow copy set ID \
 {c58e1452-c554-400e-a266-d11d5c837cb1}

 * Shadow copy ID = {de4ddca4-4978-4805-8776-cdf82d190a4a}     %VSS_SHADOW_1%
    - Shadow copy set: {c58e1452-c554-400e-a266-d11d5c837cb1}  %VSS_SHADOW_SET%
    - Original count of shadow copies = 1
    - Original volume name: \\FSRVP-SERVER\SLES_SNAPPER\ \
      [volume not on this machine]
    - Creation time: 6/17/2014 3:54:43 PM
    - Shadow copy device name:
      \\FSRVP-SERVER\SLES_SNAPPER@{31afd84a-44a7-41be-b9b0-751898756faa}
    - Originating machine: FSRVP-SERVER
    - Service machine: win-client.example.com
    - Not exposed
    - Provider ID: {89300202-3cec-4981-9171-19f59559e0f2}
    - Attributes:  No_Auto_Release Persistent FileShare

Number of shadow copies listed: 1</screen>
     </step>
     <step>
      <para>
       Finish the backup procedure:
      </para>
<screen>DISKSHADOW&gt; end backup</screen>
     </step>
     <step>
      <para>
       After the snapshot was created, try to delete it and verify the
       deletion:
      </para>
<screen>DISKSHADOW&gt; delete shadows volume \\FSRVP-SERVER\SLES_SNAPPER\
Deleting shadow copy {de4ddca4-4978-4805-8776-cdf82d190a4a} on volume \
 \\FSRVP-SERVER\SLES_SNAPPER\ from provider \
{89300202-3cec-4981-9171-19f59559e0f2} [Attributes: 0x04000009]...

Number of shadow copies deleted: 1

DISKSHADOW&gt; list shadows all

Querying all shadow copies on the computer ...
No shadow copies found in system.</screen>
     </step>
    </procedure>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-samba-info">
  <title>More information</title>

  <itemizedlist>
   <listitem>
    <formalpara>
     <title>Man pages:</title>
     <para>
      To see a list of all <command>man</command> pages installed with the
      package <package>samba</package>, run <command>apropos samba</command>.
      Open any of the man pages with <command>man
      <replaceable>NAME_OF_MAN_PAGE</replaceable></command>.
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>&suse;-specific README file:</title>
     <para>
      The package <package>samba-client</package> contains the file
      <filename>/usr/share/doc/packages/samba/README.SUSE</filename>.
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>Additional package documentation:</title>
     <para>
      Install the package <systemitem>samba-doc</systemitem> with
      <command>zypper install samba-doc</command>.
     </para>
    </formalpara>
    <para>
     This documentation installs into
     <filename>/usr/share/doc/packages/samba</filename>. It contains an HTML
     version of the man pages and a library of example configurations (such as
     <filename>smb.conf.SUSE</filename>).
    </para>
   </listitem>
   <listitem>
    <formalpara>
     <title>Online documentation:</title>
     <para>
      The Samba wiki contains extensive <citetitle>User
      Documentation</citetitle> at
      <link xlink:href="https://wiki.samba.org/index.php/User_Documentation"/>.
     </para>
    </formalpara>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
