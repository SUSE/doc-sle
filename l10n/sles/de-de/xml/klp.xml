<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="klp.xml" version="5.0" xml:id="cha-klp" xml:lang="de">
 <title>Live-Kernel-Patching mit KLP</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    In diesem Dokument werden die Grundlagen der Kernel Live Patching-Technologie (KLP) erläutert und Sie finden hier Richtlinien für den SLE Live Patching-Dienst.
   </para>
  </abstract>
 </info>
 <para>
  Mit KLP können die neuesten Sicherheitsaktualisierungen ohne Neustart auf Linux-Kernel angewendet werden. So erzielen Sie die maximale Betriebszeit und Verfügbarkeit des Systems, was insbesondere bei unternehmenswichtigen Systemen von Bedeutung ist.
 </para>
 <para>
  Die Angaben in diesem Dokument gelten für die AMD64/Intel 64-, POWER- und IBM Z-Architekturen.
 </para>
 <sect1 xml:id="sec-klp-advantages">
  <title>Vorteile des Kernel Live Patching</title>

  <para>
   KLP bietet mehrere Vorteile.
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Wenn Unternehmen bestimmte Compliance-Zertifizierungen beantragen oder beibehalten möchten, sind sie darauf angewiesen, eine große Anzahl an Servern automatisch auf dem neuesten Stand zu halten. KLP kann dazu beitragen, die Compliance zu erzielen und gleichzeitig den Bedarf an kostspieligen Wartungsfenstern zu senken.
    </para>
   </listitem>
   <listitem>
    <para>
     Unternehmen, die mit SLA-Verträgen arbeiten, müssen eine definierte Verfügbarkeit und Betriebszeit garantieren. Mit Live Patching ist es möglich, Systeme ohne Ausfallzeiten zu patchen.
    </para>
   </listitem>
   <listitem>
    <para>
     KLP ist Teil des standardmäßigen Systemaktualisierungsmechanismus, sodass keine besondere Schulung oder Einführung komplizierter Wartungsroutinen anfällt.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec-klp-overview">
  <title>Überblick über Kernel Live Patching</title>

  <para>
   Kernel-Live-Patches werden in Form von Paketen mit modifiziertem Code bereitgestellt, die vom Kernel-Hauptpaket getrennt sind. Die Live-Patches sind kumulativ; der jeweils neueste Patch enthält also alle Fehlerbehebungen aus den vorhergehenden Patches für das Kernel-Paket. Jedes Kernel-Live-Paket ist an die genaue Kernel-Version gebunden, für die es ausgegeben wird. Die Versionsnummer des Live-Patch-Pakets erhöht sich bei jedem Hinzufügen von Fehlerbehebungen.
  </para>

  <important>
   <title>Live-Patches im Vergleich zu Kernel-Aktualisierungen</title>
   <para>
    Live-Patches enthalten lediglich kritische Fehlerbehebungen und ersetzen nicht die regulären Kernel-Aktualisierungen, für die ein Neustart erforderlich ist. Live-Patches sind quasi vorübergehende Maßnahmen zum Schutz des Kernels, bis eine ordnungsgemäße Kernel-Aktualisierung und ein Neustart durchgeführt werden.
   </para>
  </important>

  <para>
   Das nachfolgende Diagramm zeigt die Beziehungen zwischen Live-Patches und Kernel-Aktualisierungen. Die Liste der CVEs und Fehlerberichte, die im derzeit aktiven Live-Patch behandelt werden, wird mit dem Kommando <command>klp -v patches</command> abgerufen.
  </para>

  <informalfigure>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="klp.png" width="80%"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="klp.png" width="100%"/>
    </imageobject>
   </mediaobject>
  </informalfigure>

  <para>
   Es ist möglich, mehrere Versionen des Kernel-Pakets zusammen mit den jeweiligen Live-Patches zu installieren. Diese Pakete lösen keine Konflikte aus. Sie können aktualisierte Kernel-Paket zusammen mit Live-Patches für den ausgeführten Kernel installieren. In diesem Fall werden Sie möglicherweise aufgefordert, das System neu zu starten. Benutzer mit SLE Live Patching-Abonnements haben Anspruch auf technischen Support, solange Live-Patch-Aktualisierungen für den ausgeführten Kernel vorliegen (siehe <xref linkend="sec-klp-lifecycle"/>).
  </para>

  <para>
   Wenn KLP aktiviert ist, umfasst jede Kernel-Aktualisierung auch ein Live-Patch-Paket. Dieser Live-Patch enthält keine Fehlerbehebungen, sondern dient als Grundlage für künftige Live-Patches für den entsprechenden Kernel. Diese leeren, grundlegenden Patches werden als <literal>ursprüngliche Patches</literal> bezeichnet.
  </para>

  <sect2 xml:id="sec-klp-scope">
   <title>Umfang des Kernel Live Patching</title>
   <para>
    SLE Live Patching umfasst Fehlerbehebungen für Sicherheitsrisiken ab Stufe 7 des SUSE Common Vulnerability Scoring-Systems (CVSS; SUSE CVSS beruht auf dem CVSS-3.0-System) sowie Fehlerkorrekturen im Hinblick auf die Systemstabilität oder auf beschädigte Daten. Es ist jedoch nicht in jedem Fall technisch praktikabel, Live-Patches für alle Fehlerbehebungen in den angegebenen Kategorien zu erstellen. SUSE behält sich daher das Recht vor, Fehlerbehebungen in Situationen zu überspringen, in denen ein Kernel-Live-Patch aus technischen Gründen nicht möglich ist. Derzeit werden mehr als 95 % der geeigneten Fehlerbehebungen als Live-Patches bereitgestellt. Weitere Informationen zum CVSS (der Grundlage für die SUSE-CVSS-Einstufung) finden Sie unter <link xlink:href="https://www.first.org/cvss/">Common Vulnerability Scoring System SIG</link>.
   </para>
  </sect2>

  <sect2 xml:id="sec-klp-limitations">
   <title>Einschränkungen des Kernel Live Patching</title>
   <para>
    Das KLP umfasst den Austausch von Funktionen und die behutsame Ersetzung von Funktionssätzen, die voneinander abhängig sind. Hierbei werden Aufrufe von älterem Code an aktualisierten Code weitergeleitet, der sich an einem anderen Speicherort befindet. Veränderungen in den Datenstrukturen erschweren die Situation, da die Daten am bisherigen Ort verbleiben und nicht erweitert oder neu interpretiert werden können. Es gibt zwar einige Methoden für die indirekte Veränderung von Datenstrukturen, doch einige Fehlerbehebungen können nicht in Live-Patches umgesetzt werden. In dieser Situation ist ein Neustart des Systems die einzige Möglichkeit, die Fehlerbehebungen anzuwenden.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-klp-enable-with-yast2">
  <title>Aktivieren von Kernel Live Patching mit YaST</title>

  <para>
   Für die Aktivierung von Kernel Live Patching benötigen Sie aktive Abonnements für SLES und SLE Live Patching. Prüfen Sie im <link xlink:href="https://scc.suse.com/">SUSE Customer Center</link> den Status Ihrer Abonnements und rufen Sie einen Registrierungscode für das SLE Live Patching-Abonnement ab.
  </para>

  <para>
   So aktivieren Sie Kernel Live Patching auf dem System:
  </para>

  <procedure>
   <step>
    <para>
     Führen Sie das Kommando <command>yast2 registration</command> aus und klicken Sie auf <guimenu>Erweiterungen auswählen</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Wählen Sie in der Liste der verfügbaren Erweiterungen den Eintrag <guimenu>SUSE Linux Enterprise Live Patching 15</guimenu> und klicken Sie auf <guimenu>Weiter</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Bestätigen Sie die Lizenzvereinbarung und klicken Sie auf <guimenu>Weiter</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Geben Sie Ihren Registrierungscode für SLE Live Patching ein und klicken Sie auf <guimenu>Weiter</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Prüfen Sie die <guimenu>Installationszusammenfassung</guimenu> und die ausgewählten <guimenu>Schemata</guimenu>. Die Schemata <systemitem>Live
     Patching</systemitem> und <systemitem>SLE Live Patching Lifecycle
     Data</systemitem> sollten automatisch zur Installation ausgewählt werden, ebenso wie weitere Pakete, die Abhängigkeiten berücksichtigen.
    </para>
   </step>
   <step>
    <para>
     Schließen Sie die Installation mit <guimenu>Akzeptieren</guimenu> ab. Dadurch werden auf Ihrem System die Basiskomponenten von Kernel Live Patching sowie der ursprüngliche Live-Patch und die erforderlichen Abhängigkeiten installiert.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-klp-enable-cli">
  <title>Aktivieren von Kernel Live Patching über die Kommandozeile</title>

  <para>
   Für die Aktivierung von Kernel Live Patching benötigen Sie aktive Abonnements für SLES und SLES Live Patching. Prüfen Sie im <link xlink:href="https://scc.suse.com/">SUSE Customer Center</link> den Status Ihrer Abonnements und rufen Sie einen Registrierungscode für das SLES Live Patching-Abonnement ab.
  </para>

  <procedure>
   <step>
    <para>
     Führen Sie das Kommando <command>sudo SUSEConnect --list-extensions</command> aus. Beachten Sie das genaue Aktivierungskommando für SLES Live Patching. Beispielausgabe des Kommandos (gekürzt):
    </para>
<screen>$ SUSEConnect --list-extensions
...
SUSE Linux Enterprise Live Patching <phrase role="productnumber"><phrase os="sles;sled">15 SP4</phrase></phrase> x86_64
Activate with: SUSEConnect -p sle-module-live-patching/15.4/x86_64 \
  -r ADDITIONAL REGCODE</screen>
   </step>
   <step>
    <para>
     Aktivieren Sie SLES Live Patching mit dem abgerufenen Kommando, gefolgt von <option>-r <replaceable>LIVE_PATCHING_REGISTRIERUNGSCODE</replaceable></option>, beispielsweise:
    </para>
<screen>SUSEConnect -p sle-module-live-patching/15.4/x86_64 \
  -r <replaceable>LIVE_PATCHING_REGISTRATION_CODE</replaceable></screen>
   </step>
   <step>
    <para>
     Installieren Sie die erforderlichen Pakete und Abhängigkeiten mit dem Kommando <command>zypper install -t pattern lp_sles</command>
    </para>
   </step>
  </procedure>

  <para>
   Zu diesem Zeitpunkt sind die Live-Patches für das System bereits angewendet.
  </para>

  <para>
   So läuft der Prozess hinter den Kulissen ab: Wenn das Paketinstallationssystem erkennt, dass ein Live-Patch für einen installierten Kernel angewendet werden kann und dass ein Live-Patch für diesen Kernel im Software-Kanal vorliegt, wählt das System den Live-Patch zur Installation aus. Der Kernel erhält dann die Live-Patch-Fehlerbehebungen <emphasis>als Teil der Paketinstallation</emphasis>. Der Live-Patch für den Kernel wird noch vor Abschluss der Produktinstallation durchgeführt.
  </para>
 </sect1>
 <sect1 xml:id="sec-klp-perform">
  <title>Durchführen von Kernel Live Patching</title>

  <para>
   Kernel-Live-Patches werden im Rahmen von regulären Systemaktualisierungen installiert. Es sind jedoch einige Dinge zu beachten.
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Der Kernel ist live-gepatcht, wenn ein <package>kernel-livepatch-*</package>-Paket für den aktuellen Kernel installiert wurde. Mit dem Kommando <command>zypper se --details kernel-livepatch-*</command> können Sie prüfen, welche Kernel-Live-Patch-Pakete auf Ihrem System installiert sind.
    </para>
   </listitem>
   <listitem>
    <para>
     Wenn das Paket <package>kernel-default</package> installiert ist, fordert der Update-Manager Sie auf, das System neu zu starten. Damit diese Meldung nicht angezeigt wird, können Sie Kernel-Aktualisierungen aus dem Patching-Vorgang herausfiltern. Hierzu können Sie Paketsperren mit Zypper hinzufügen. Mit SUSE Manager ist es auch möglich, Kanalinhalte zu filtern (siehe <link xlink:href="https://documentation.suse.com/external-tree/en-us/suma/4.1/suse-manager/administration/live-patching.html">Live-Patching mit SUSE Manager</link>).
    </para>
   </listitem>
   <listitem>
    <para>
     Sie können den Patching-Status mit dem Kommando <command>klp status</command> prüfen. Zur Untersuchung installierter Patches führen Sie das Kommando <command>klp -v patches</command> aus.
    </para>
   </listitem>
   <listitem>
    <para>
     Denken Sie daran: Es können zwar mehrere Kernel-Pakete auf dem System installiert sein, doch es kann immer nur eines dieser Pakete ausgeführt werden, nicht mehrere Pakete gleichzeitig. Ebenso können mehrere Live-Patch-Pakete installiert sein, doch es wird immer nur ein Live-Patch in den Kernel geladen.
    </para>
   </listitem>
   <listitem>
    <para>
     Der aktive Live-Patch ist in der <literal>initrd</literal> enthalten. Bei einem unvorhergesehenen Neustart fährt das System also mit den angewendeten Live-Patches hoch, sodass Sie das Patching nicht wiederholen müssen.
    </para>
   </listitem>
  </itemizedlist>

  <sect2 xml:id="sec-klp-lifecycle">
   <title>Prüfen des Ablaufdatums des Live-Patches</title>
   <para>
    Stellen Sie sicher, dass das <package>lifecycle-data-sle-module-live-patching</package> installiert ist, und führen Sie dann das Kommando <command>zypper lifecycle</command> aus. Im Abschnitt <literal>Ende des Paket-Supports, falls abweichend vom Produkt</literal> der Ausgabe, werden Angaben zum Ablaufdatum der Live-Patches angezeigt.
   </para>
   <para>
    Jeder Live-Patch wird ein Jahr ab Veröffentlichung des zugrunde liegenden Kernel-Pakets aktualisiert. Auf der Seite <link xlink:href="https://www.suse.com/products/live-patching/current-patches/">Verwaltete Kernels, Patch-Aktualisierungen und Lebenszyklus</link> können Sie das Ablaufdatum anhand der ausgeführten Kernel-Version prüfen, ohne die Produkterweiterung zu installieren.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-klp-troubleshoot">
  <title>Fehlerbehebung bei Kernel Live Patching-Problemen</title>

  <sect2 xml:id="sec-klp-man-patch-downgrade">
   <title>Manuelles Patch-Downgrade</title>
   <para>
    Wenn der neueste Live-Patch Probleme verursacht, können Sie ein Downgrade des aktuell installierten Live-Patches auf die vorhergehende Version durchführen. Es wird empfohlen, das Patch-Downgrade vorzunehmen, bevor das System erste Probleme zeigt. Denken Sie daran, dass ein System mit Kernel-Warnungen oder Kernel-Fehlerspuren im Systemprotokoll unter Umständen nicht für das Patch-Downgrade-Verfahren geeignet ist. Wenn Sie nicht sicher sind, ob das System die Anforderungen für ein Patch-Downgrade erfüllt, fragen Sie den technischen Support von SUSE.
   </para>
   <procedure>
    <title>Manuelles Patch-Downgrade</title>
    <step>
     <para>
      Ermitteln Sie den automatischen Live-Patch mit dem Kommando <command>klp -v patches</command>. Der aktuell ausgeführte Patch befindet sich in der Zeile, die mit <literal>RPM:</literal> beginnt. Beispiel:
     </para>
<screen>RPM: kernel-livepatch-5_3_18-24_29-default-2-2.1.x86_64</screen>
     <para>
      <literal>5_3_18-24_29-default</literal> im Beispiel oben bezeichnet die genaue ausgeführte Kernel-Version.
     </para>
    </step>
    <step>
     <para>
      Suchen Sie mit dem Kommando <command>zypper search -s kernel-livepatch-<replaceable>VERSION_DES_AUSGEFÜHRTEN_KERNELS</replaceable>-default</command>nach früheren Versionen des Patches. Das Kommando gibt eine Liste der verfügbaren Paketversionen zurück. Denken Sie daran, dass die Versionsnummer bei jeder Veröffentlichung eines neuen Live-Patch-Pakets um eins erhöht wird. Wählen Sie die Versionsnummer aus, die um eine Veröffentlichung niedriger ist als die aktuelle Version.
     </para>
    </step>
    <step>
     <para>
      Installieren Sie die gewünschte Version mit dem Kommando <command>zypper in --oldpackage kernel-livepatch-<replaceable>VERSION_DES_AUSGEFÜHRTEN_KERNELS</replaceable>-default=<replaceable>GEWÜNSCHTE_VERSION</replaceable></command>.
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
</chapter>
