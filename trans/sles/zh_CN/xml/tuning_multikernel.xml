<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xml:base="tuning_multikernel.xml" id="cha.tuning.multikernel">
 <title>安装多个内核版本</title>
 <abstract>
  <para>
   <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 支持多个内核版本的平行安装。安装第二个内核时，将自动创建一个引导项和一个 initrd，因此无需做进一步的手动配置。重引导计算机时，新增的内核可用作附加的引导选项。
  </para>

  <para>
   使用此功能，您可以安全测试内核更新，同时，还始终能够回退到已经过验证的前一内核。执行这种操作时，请不要使用更新工具（例如 YaST 联机更新或更新小程序），而应该遵照本章中所述的过程。
  </para>
 </abstract>
 <warning>

  <title>支持权利</title>
  <para>
   请注意，如果您安装自行编译的内核或第三方内核，则会失去所有的支持权利。仅支持 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 随附的内核，以及通过官方更新渠道为 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 提供的内核。
  </para>
 </warning>
 <tip>
  <title>检查引导加载程序配置内核</title>
  <para>
   建议在安装其他内核后检查您的引导加载程序配置，以设置您选择的默认引导项。有关详细信息，请参见<xref linkend="sec.grub2.yast2.config"/>。
  </para>
 </tip>
 <sect1 id="cha.tuning.multikernel.enable">
  <title>启用和配置多版本支持</title>

  
  <para>
   SUSE Linux Enterprise 12 上默认启用软件包的多个版本安装（多版本支持）。要验证此设置，请按如下所示继续：
  </para>

  <procedure>
   <step performance="required">
    <para>
     以 <systemitem class="username">root</systemitem> 身份使用所选的编辑器打开 <filename>/etc/zypp/zypp.conf</filename>。
    </para>
   </step>
   <step performance="required">
    <para>
     搜索字符串 <literal>multiversion</literal>。如果为所有支持此功能的内核包启用多版本，以下行可能会取消注释：
    </para>
<screen>multiversion = provides:multiversion(kernel)</screen>
   </step>
   <step performance="required">
    <para>
     要对特定的内核类型限制多版本支持，请将逗号分隔的包名称列表添加到 <filename>/etc/zypp/zypp.conf</filename> 中的 <literal>multiversion</literal> 选项 — 例如
    </para>
<screen>multiversion = kernel-default,kernel-default-base,kernel-source</screen>
   </step>
   <step performance="required">
    <para>
     保存所做的更改。
    </para>
   </step>
  </procedure>

  <warning>
   <title>内核模块包 (KMP)</title>
   <para>
    确保还为新更新的内核安装了所需的由供应商提供的内核模块（内核模块包）。内核更新过程不会发出有关最终缺少内核模块的警告，因为系统上保留的旧内核仍能满足包要求。
   </para>
  </warning>

  <sect2 id="cha.tuning.multikernel.enable.keep">
   <title>自动删除未使用的内核</title>
   <para>
    如果您经常测试已启用多版本支持的新内核，引导菜单很快就会变得无序。由于 <filename>/boot</filename> 分区的空间通常有限，因此，您还可能会遇到 <filename>/boot</filename> 溢出的问题。您可以使用 YaST 或 Zypper 手动删除未使用的内核版本（如下文所述），也可以将 <systemitem class="library">libzypp</systemitem> 配置为自动删除不再使用的内核。默认情况下不会删除内核。
   </para>
   <procedure>
    <step performance="required">
     <para>
      以 <systemitem class="username">root</systemitem> 身份使用所选的编辑器打开 <filename>/etc/zypp/zypp.conf</filename>。
     </para>
    </step>
    <step performance="required">
     <para>
      搜索字符串 <literal>multiversion.kernels</literal>，并通过取消注释对应的行来激活此选项。此选项将会使用包含以下值的逗号分隔列表：
     </para>
     <formalpara>
      <title><literal><replaceable>3.12.24-7.1</replaceable></literal>：</title>
      <para>
       保留具有指定版本号的内核
      </para>
     </formalpara>
     <formalpara>
      <title><literal>latest</literal>：</title>
      <para>
       保留具有最高版本号的内核
      </para>
     </formalpara>
     <formalpara>
      <title><literal>latest-N</literal>：</title>
      <para>
       保留版本号排在第 N 位的内核
      </para>
     </formalpara>
     <formalpara>
      <title><literal>running</literal>：</title>
      <para>
       保留正在运行的内核
      </para>
     </formalpara>
     <formalpara>
      <title><literal>oldest</literal>：</title>
      <para>
       保留具有最低版本号的内核（最初 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 随附的内核）
      </para>
     </formalpara>
     <formalpara>
      <title><literal>oldest+N</literal></title>
      <para>
       保留版本号排在倒数第 N 位的内核
      </para>
     </formalpara>
     <para>
      以下是一些示例
     </para>
     <variablelist>
      <varlistentry>
       <term><literal>multiversion.kernels = latest,running</literal>
       </term>
       <listitem>
        <para>
         保留最新内核以及当前正在运行的内核。这相当于完全不启用多版本功能，不过，旧内核是在<emphasis>下一次重引导</emphasis>后才去除的，而不是在安装后立即去除。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term><literal>multiversion.kernels = latest,latest-1,running</literal>
       </term>
       <listitem>
        <para>
         保留最新的两个内核，以及当前正在运行的内核。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term><literal> multiversion.kernels = latest,running,<replaceable>3.12.25.rc7-test</replaceable></literal>
       </term>
       <listitem>
        <para>
         保留最新的内核、当前正在运行的内核，以及 <replaceable>3.12.25.rc7-test</replaceable>。
        </para>
       </listitem>
      </varlistentry>
     </variablelist>
     <tip>
      <title>保留<literal>正在运行的</literal>内核</title>
      <para>
       除非使用特殊的设置，否则您可能希望永远保留<literal>正在运行的</literal>内核。如果不保留正在运行的内核，将在内核更新期间将其删除。因此，更新后必须立即重引导系统，因为删除后便不能再装载当前正在运行的核心模块。
      </para>
     </tip>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 id="cha.tuning.multikernel.yast">
  <title>使用 YaST 安装/去除多个内核版本</title>

  <procedure>
   <step performance="required">
    <para>
     启动 YaST，然后通过<menuchoice><guimenu>软件</guimenu> <guimenu>软件管理</guimenu></menuchoice>打开软件管理器。
    </para>
   </step>
   <step performance="required">
    <para>
     选择<menuchoice><guimenu>视图</guimenu> <guimenu>包组</guimenu> <guimenu>多版本包</guimenu></menuchoice>列出能够提供多个版本的所有包。
    </para>
    <figure>
     <title>YaST 软件管理器：多版本视图</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="yast2_sw_multiversion.png" width="90%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="yast2_sw_multiversion.png" width="90%" format="PNG"/>
      </imageobject>
     </mediaobject>
    </figure>
   </step>
   <step performance="required">
    <para>
     在底部窗格的左侧选择一个包并打开其<guimenu>版本</guimenu>选项卡。
    </para>
   </step>
   <step performance="required">
    <para>
     要安装某个包，请单击其对应的复选框。绿色选中标记表示已选择对应的包进行安装。
    </para>
    <para>
     要去除某个已安装的包（带有白色选中标记），请单击其对应的复选框，直到出现红色的 <literal>X</literal>，这表示已选择去除该包。
    </para>
   </step>
   <step performance="required">
    <para>
     单击<guimenu>接受</guimenu>开始安装。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 id="cha.tuning.multikernel.zypper">
  <title>使用 Zypper 安装/去除多个内核版本</title>

  <procedure>
   <step performance="required">
    <para>
     使用命令 <command>zypper se -s 'kernel*'</command> 显示所有可用内核包的列表：
    </para>
<screen><?dbsuse-fo font-size="7pt"?>

S | Name           | Type       | Version         | Arch   | Repository        
--+----------------+------------+-----------------+--------+-------------------
v | kernel-default | package    | 2.6.32.10-0.4.1 | x86_64 | Alternative Kernel
i | kernel-default | package    | 2.6.32.9-0.5.1  | x86_64 | (System Packages) 
  | kernel-default | srcpackage | 2.6.32.10-0.4.1 | noarch | Alternative Kernel
i | kernel-default | package    | 2.6.32.9-0.5.1  | x86_64 | (System Packages)
...</screen>
   </step>
   <step performance="required">
    <para>
     安装时指定确切的版本：
    </para>
<screen>zypper in kernel-default-2.6.32.10-0.4.1</screen>
   </step>
   <step performance="required">
    <para>
     卸装内核时，使用命令 <command>zypper se -si 'kernel*'</command> 可以列出安装的所有内核，使用 <command>zypper rm <replaceable>包名版本</replaceable></command>可以去除该包。
    </para>
   </step>
  </procedure>
 </sect1>
</chapter>
