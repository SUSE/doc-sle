<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_online.xml" version="5.0" xml:id="cha.update.online">
 <title>Actualización con conexión</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>sí</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    SUSE ofrece una herramienta gráfica intuitiva y una de línea de comandos sencilla para actualizar un sistema en ejecución a un nuevo paquete de servicio. Proporcionan asistencia para la <quote>revertir</quote> la actualización de los paquetes de servicios y otros elementos. En este capítulo se explica cómo realizar paso a paso una actualización del paquete de servicio con estas herramientas.
   </para>
  </abstract>
 </info>
 <sect1 xml:id="sec.update.migr.conceptual-overview">
  <title>Descripción conceptual</title>

  <para>
   SUSE publica nuevos paquetes de servicio para la familia de SUSE Linux Enterprise a intervalos regulares. Para facilitar a los clientes la migración a un nuevo paquete de servicio y reducir el tiempo de inactividad, SUSE admite la migración en línea mientras se esté ejecutando el sistema.
  </para>

  <para>
   A partir de SLE 12, YaST Wagon se ha sustituido por la migración de YaST (GUI) y la migración de Zypper (línea de comandos). Se admiten las siguientes funciones:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     El sistema siempre está en un estado definido hasta que se actualiza el primer RPM.
    </para>
   </listitem>
   <listitem>
    <para>
     Es posible cancelar hasta que se actualiza el primer RPM.
    </para>
   </listitem>
   <listitem>
    <para>
     La recuperación es fácil si se produce un error.
    </para>
   </listitem>
   <listitem>
    <para>
     La <quote>reversión</quote> se realiza mediante herramientas del sistema; no es necesario realizar una copia de seguridad y restaurar.
    </para>
   </listitem>
   <listitem>
    <para>
     Se usan todos los repositorios activos.
    </para>
   </listitem>
   <listitem>
    <para>
     Es posible omitir un paquete de servicio.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.workflow">
  <title>Flujo de trabajo de migración del paquete de servicio</title>

  <para>
   Es posible ejecutar una migración del paquete de servicio mediante YaST, <command>zypper</command> o AutoYaST.
  </para>

  <para>
   Antes de que pueda iniciar una migración del paquete de servicio, el sistema debe estar registrado en el Centro de servicio al cliente de SUSE o en un servidor SMT local. También puede utilizarse SUSE Manager.
  </para>

  <para>
   Independientemente del método utilizado, la migración de un paquete de servicio consta de los pasos siguientes:
  </para>

  <orderedlist>
   <listitem>
    <para>
     Buscar posibles destinos de migración en los sistemas registrados.
    </para>
   </listitem>
   <listitem>
    <para>
     Seleccionar un destino de migración.
    </para>
   </listitem>
   <listitem>
    <para>
     Pedir y habilitar nuevos repositorios.
    </para>
   </listitem>
   <listitem>
    <para>
     Ejecutar la migración.
    </para>
   </listitem>
  </orderedlist>



  <para>
   La lista de destinos de migración depende de los productos que haya instalado y registrado. Si tiene una extensión instalada para la que aún no haya disponible un paquete de servicio nuevo, puede que no se le ofrezca ningún destino de migración.
  </para>

  <para>
   La lista de destinos de migración disponibles para el host siempre se recupera desde el Centro de servicios al cliente de SUSE y depende de los productos o extensiones instalados.
  </para>
 </sect1>
 <sect1 xml:id="sec.update.migr.cancel.spm">
  <title>Cancelación de la migración del paquete de servicio</title>

  <para>
   La migración del paquete de servicio solo se puede cancelar en etapas concretas durante el proceso de migración:
  </para>

  <orderedlist>
   <listitem>
    <para>
     Hasta que se inicia la actualización del paquete, solo hay cambios mínimos en el sistema, como en los servicios y repositorios. Restaure <filename>/etc/zypp/repos.d/*</filename> para revertir el sistema al estado anterior.
    </para>
   </listitem>
   <listitem>
    <para>
     Cuando se inicia la actualización del paquete, puede volver al estado anterior mediante una instantánea de Snapper (consulte <xref linkend="cha.snapper"/>).
    </para>
   </listitem>
   <listitem>
    <para>
     Después de seleccionar el destino de migración, el Centro de servicios al cliente de SUSE cambia los datos del repositorio. Para revertir este estado manualmente, utilice <command>SUSEConnect</command> <option>--rollback</option>.
    </para>
   </listitem>
  </orderedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.yast.onlinemigr">
  <title>Actualización con la herramienta de migración en línea (YaST)</title>

  <para>
   Para realizar la migración de un paquete de servicio con YaST, use la herramienta <guimenu>Migración en línea</guimenu>. Por defecto, YaST no instala ningún paquete desde repositorios de otros fabricantes. Si se ha instalado un paquete desde un repositorio de otro fabricante, YaST impide que los paquetes se sustituyan por los mismos paquetes provenientes de SUSE.
  </para>

  <note>
   <title>reducción del tamaño de la instalación</title>
   <para>
    Al realizar la migración del paquete de servicio, YaST instala todos los paquetes recomendados. Especialmente en el caso de las instalaciones mínimas personalizadas, esto puede aumentar el tamaño de instalación del sistema considerablemente.
   </para>
   <para>
    Para cambiar este comportamiento por defecto y permitir solo los paquetes necesarios, ajuste <filename>/etc/zypp/zypp.conf</filename> y defina la variable siguiente:
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   Esto cambia el comportamiento de todas las operaciones del paquete, como la instalación de parches o nuevos paquetes.
  </para>

  <para>
   Para iniciar la migración del paquete de servicio, haga lo siguiente:
  </para>

  <procedure xml:id="pro.update.migr.yast">
   <step>
    <para>
     Desactive todas las extensiones sin usar del servidor de registro para evitar futuros conflictos de dependencias. Si olvida una extensión, YaST detectará posteriormente los repositorios de extensiones no utilizados y los desactivará.
    </para>
   </step>
   <step>
    <para>
     Si ha entrado en una sesión de GNOME que se esté ejecutando en el equipo que va a actualizar, cambie a una consola de texto. No se recomienda ejecutar la actualización desde una sesión de GNOME. Tenga en cuenta que esto no se aplica cuando se entra desde un equipo remoto (a menos que esté ejecutando una sesión de VNC con GNOME).
    </para>
   </step>
   <step>
    <para>
     Si está suscrito a LTSS, asegúrese de que el repositorio de la extensión LTSS está activado.
    </para>
   </step>
   <step>
    <para>
     Ejecute la actualización en línea de YaST para obtener las actualizaciones más recientes del paquete para su sistema.
    </para>
   </step>
   <step>
    <para>
     Instale el paquete
     <package>yast2-migration</package>
     y sus dependencias (en YaST en <menuchoice> <guimenu>Software</guimenu> <guimenu>Gestión de software</guimenu> </menuchoice>).
    </para>
   </step>
   <step>
    <para>
     Reinicie YaST, o el módulo recién instalado no se mostrará en el Centro de control.
    </para>
   </step>
   <step>
    <para>
     Inicie en YaST <menuchoice> <guimenu>Sistema</guimenu> <guimenu>Migración en línea</guimenu> </menuchoice>. YaST muestra los destinos de migración posibles y un resumen. Si hay disponible más de un destino de migración para el sistema, seleccione uno en la lista.
    </para>
   </step>
   <step>
    <para>
     Seleccione un destino de migración de la lista y haga clic en <guimenu>Siguiente</guimenu>.
    </para>
   </step>
   <step>
    <para>
     En caso de que la herramienta de migración ofrezca repositorios de actualización, se recomienda continuar haciendo clic en <guimenu>Sí</guimenu>.
    </para>
   </step>
   <step>
    <para>
     <remark>toms 2015-09-09: FATE#319140</remark> Si la herramienta Migración en línea encuentra repositorios obsoletos provenientes del DVD o de un servidor local, se recomienda encarecidamente inhabilitarlos. Los repositorios obsoletos proceden de un paquete de servicio anterior. Los repositorios antiguos de SCC o SMT se eliminan automáticamente.
    </para>
   </step>
   <step>
    <para>
     Revise el resumen y haga clic en <guimenu>Siguiente</guimenu> para continuar con la migración. Para confirmar, haga clic en <guimenu>Iniciar actualización</guimenu>.
    </para>
    <remark>toms 2016-07-13: What to do in case of problems?</remark>
   </step>
   <step>
    <para>
     Cuando se complete correctamente la migración, reinicie el sistema.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.zypper.onlinemigr">
  <title>Actualización con Zypper</title>

  <para>
   Para realizar la migración de un paquete de servicio con Zypper, use la herramienta de línea de comandos <command>zypper</command> <option>migration</option>.
  </para>

  <note>
   <title>reducción del tamaño de la instalación</title>
   <para>
    Al realizar la migración del paquete de servicio, YaST instala todos los paquetes recomendados. Especialmente en el caso de las instalaciones mínimas personalizadas, esto puede aumentar el tamaño de instalación del sistema considerablemente.
   </para>
   <para>
    Para cambiar este comportamiento por defecto y permitir solo los paquetes necesarios, ajuste <filename>/etc/zypp/zypp.conf</filename> y defina la variable siguiente:
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   Esto cambia el comportamiento de todas las operaciones del paquete, como la instalación de parches o nuevos paquetes. Para cambiar el comportamiento de Zypper para una sola llamada, añada el parámetro <option>--no-recommends</option> en la línea de comandos.
  </para>

  <para>
   Para iniciar la migración del paquete de servicio, haga lo siguiente:
  </para>

  <procedure xml:id="pro.update.migr.zypper">
   <step>
    <para>
     Si ha entrado en una sesión de GNOME que se esté ejecutando en el equipo que va a actualizar, cambie a una consola de texto. No se recomienda ejecutar la actualización desde una sesión de GNOME. Tenga en cuenta que esto no se aplica cuando se entra desde un equipo remoto (a menos que esté ejecutando una sesión de VNC con GNOME).
    </para>
   </step>
   <step>
    <para>
     Si aún no lo ha hecho, registre el equipo en SUSE Linux Enterprise:
    </para>
<screen>sudo <command>SUSEConnect</command> --regcode <replaceable>YOUR_REGISTRATION_CODE</replaceable></screen>
   </step>
   <step>
    <para>
     Si está suscrito a LTSS, asegúrese de que el repositorio de la extensión LTSS está activado.
    </para>
   </step>
   <step>
    <para>
     Instale las actualizaciones más recientes:
    </para>
<screen>sudo <command>zypper</command> patch</screen>
   </step>
   <step>
    <para>
     Instale el paquete <package>zypper-migration-plugin</package> y sus dependencias:
    </para>
<screen>sudo <command>zypper</command> in zypper-migration-plugin</screen>
   </step>
   <step>
    <para>
     Ejecute <command>zypper</command> <option>migration</option>:
    </para>
<screen><prompt>tux &gt; </prompt>sudo <command>zypper</command> migration
Executing 'zypper  patch-check'

Refreshing service 'SUSE_Linux_Enterprise_Server_12_x86_64'.
Loading repository data...
Reading installed packages...
0 patches needed (0 security patches)

Available migrations:

    1 | SUSE Linux Enterprise Server 12 SP1 x86_64
    2 | SUSE Linux Enterprise Server 12 SP2 x86_64</screen>
    <para>
     Notas sobre el proceso de migración:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Si hay disponible más de un destino de migración para el sistema, Zypper permite seleccionar uno en la lista. Esto es lo mismo que omitir uno o varios paquetes de servicio. Tenga en cuenta que la migración en línea de productos base (SLES y SLED) sigue estando disponible solo entre los paquetes de servicio de una versión principal.
      </para>
     </listitem>
     <listitem>
      <para>
       Por defecto, Zypper usa la opción <option>--no-allow-vendor-change</option>, que se pasa a <command>zypper</command> <option>dup</option>. Si se ha instalado un paquete desde un repositorio de otro fabricante, esta opción impide que los paquetes se sustituyan por los mismos paquetes provenientes de SUSE.
      </para>
     </listitem>
     <listitem>
      <para>
       <remark>toms 2015-09-09: FATE#319140</remark> Si Zypper encuentra repositorios obsoletos provenientes del DVD o de un servidor local, se recomienda encarecidamente inhabilitarlos. Los repositorios del SCC o de la SMT antiguos se eliminan automáticamente.
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     Revise todos los cambios, sobre todo los paquetes que se van a eliminar. Para continuar, escriba <literal>y</literal> (el número exacto de paquetes para actualizar puede variar en su sistema):
    </para>
<screen>266 packages to upgrade, 54 to downgrade, 17 new, 8 to reinstall, 5 to remove, 1 to change arch.
Overall download size: 285.1 MiB. Already cached: 0 B  After the operation, additional 139.8 MiB will be used.
Continue? [y/n/? shows all options] (y):</screen>
    <para>
     Use las teclas <keycombo> <keycap function="shift"/> <keycap function="pageup"/> </keycombo> o <keycombo> <keycap function="shift"/> <keycap function="pagedown"/> </keycombo> para desplazarse por la shell.
    </para>
   </step>
   <step>
    <para>
     Cuando se complete correctamente la migración, reinicie el sistema.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.plainzypper.onlinemigr">
  <title>Actualización con Zypper simple</title>

  <para>
   Si no puede utilizar la migración con YaST o la migración con Zypper, aún puede migrar con Zypper normal y alguna interacción manual. Para iniciar una migración del paquete de servicio, haga lo siguiente:
  </para>

  <procedure>
   <step>
    <para>
     Si ha entrado en una sesión de GNOME que se esté ejecutando en el equipo que va a actualizar, cambie a una consola de texto. No se recomienda ejecutar la actualización desde una sesión de GNOME. Tenga en cuenta que esto no se aplica cuando se entra desde un equipo remoto (a menos que esté ejecutando una sesión de VNC con GNOME).
    </para>
   </step>
   <step>
    <para>
     Actualice las herramientas de gestión del paquete con los repositorios de SUSE Linux Enterprise anteriores:
    </para>
<screen>sudo <command>zypper</command> patch --updatestack-only</screen>
   </step>
   <step>
    <para>
     Si el sistema está registrado, debe anular el registro:
    </para>
<screen>sudo <command>SUSEConnect</command> --de-register</screen>
   </step>
   <step>
    <para>
     Elimine los orígenes de instalación y los repositorios antiguos y ajuste los repositorios de otros fabricantes.
    </para>
   </step>
   <step>
    <para>
     Añada los nuevos orígenes de instalación, ya sean locales o remotos (para obtener información sobre el espacio reservado <replaceable>REPOSITORY</replaceable>, consulte la <xref linkend="sec.update.nmm.repositories"/>):
    </para>
<screen>sudo <command>zypper</command> addrepo <replaceable>REPOSITORY</replaceable></screen>
    <para>
     También puede usar el Centro de servicios al cliente de SUSE o la Herramienta de gestión de suscripciones. El comando para SUSE Linux Enterprise 12 SP1 en x86-64 es:
    </para>
<screen>sudo <command>SUSEConnect</command> -p SLES/12.2/x86_64 <replaceable>OPTIONS</replaceable></screen>
    <para>
     Tenga en cuenta, no se admiten actualizaciones de arquitecturas cruzadas.
    </para>
    <para>
     Zypper mostrará un conflicto entre el núcleo antiguo y el nuevo. Elija la solución 1 para continuar.
    </para>
<screen>Problem: product:SLES-12.2-0.x86_64 conflicts with kernel &lt; 4.4 provided by kernel-default-<replaceable>version</replaceable>
 Solution 1: Following actions will be done:
  replacement of kernel-default-<replaceable>version</replaceable> with kernel-default-<replaceable>version</replaceable>
  deinstallation of kernel-default-<replaceable>version</replaceable>
 Solution 2: do not install product:SLES-12.2-0.x86_64
</screen>
   </step>
   <step>
    <para>
     Finalice la migración:
    </para>
<screen>sudo <command>zypper</command> ref -f -s
sudo <command>zypper</command> dup --no-allow-vendor-change --no-recommends</screen>
    <para>
     El primer comando actualiza todos los servicios y repositorios. El segundo comando lleva a cabo una actualización de la distribución. En este caso, las dos últimas opciones son importantes: <option>-no-allow-vendor-change</option> garantiza que los RPM de otros fabricantes no sobrescribirán los RPM del sistema base. La opción <option>--no-recommends</option> garantiza que el paquete deseleccionado durante la instalación inicial no se añadirá de nuevo.
    </para>
   </step>
  </procedure>
 </sect1>



 <sect1 xml:id="sec.update.migr.rollback">
  <title>Reversión de un paquete de servicio</title>

  <para>
   Si un paquete de servicio no funciona, SUSE Linux Enterprise permite revertir el sistema a su estado anterior antes de iniciar la migración. Uno de los requisitos previos es una partición de raíz Btrfs con las instantáneas habilitadas (se trata del ajuste por defecto al instalar SLES 12). Consulte la <xref linkend="cha.snapper"/> para obtener más información.
  </para>

  <procedure xml:id="pro.update.migr.rollback">
   <step>
    <para>
     Obtenga una lista de todas las instantáneas de Snapper:
    </para>
    <screen>sudo snapper list</screen>
    <para>
     Revise el resultado para localizar la instantánea que se creó inmediatamente antes de la migración del paquete de servicios. La columna <guimenu>Descripción</guimenu> contiene la instrucción correspondiente y la instantánea está marcada como <literal>importante</literal> en la columna <guimenu>Información del usuario.</guimenu> Memorice el número de la instantánea de la columna <guimenu>n.º</guimenu> y la fecha de la columna <guimenu>Fecha.</guimenu>
    </para>
   </step>
   <step>
    <para>
     Rearranque el sistema. En el menú de arranque, seleccione <guimenu>Iniciar cargador de arranque desde una instantánea de solo lectura</guimenu> y, a continuación, la instantánea con la fecha y el número que memorizó en el paso anterior. Se carga un segundo menú de arranque (el de la instantánea). Seleccione la entrada que empieza por <literal>SLES 12</literal> y arránquela.
    </para>
   </step>
   <step>
    <para>
     El sistema arranca en el estado anterior con la partición de sistema montada como de solo lectura. Entre como usuario <systemitem class="username">root</systemitem> y compruebe si ha elegido la instantánea correcta. Asegúrese también de que todo funciona como se espera. Tenga en cuenta que, debido a las restricciones derivadas de que el sistema de archivos raíz esté montado como de solo lectura, puede haber restricciones en las funciones disponibles.
    </para>
    <para>
     En caso de problemas o si ha arrancado la instantánea equivocada, vuelva a arrancar y elija otra instantánea de arranque: hasta este momento no se han realizado cambios permanentes. Si la instantánea es correcta y funciona como se espera, haga permanente el cambio ejecutando el comando siguiente:
    </para>
    <screen>snapper rollback</screen>
    <para>
     A continuación, vuelva a arrancar. En la pantalla de arranque, seleccione la entrada de arranque por defecto para arrancar en el sistema restablecido.
    </para>
   </step>
   <step>
    <para>
     Compruebe si la configuración del repositorio se ha restablecido correctamente. Compruebe también que todos los productos estén correctamente registrados. Si alguno de los elementos anteriores no se cumple, podría darse el caso de que no funcione la actualización del sistema a un momento posterior o que el sistema se actualice con los repositorios de paquetes erróneos.
    </para>
    <para>
     Asegúrese de que el sistema tiene acceso a Internet antes de iniciar este procedimiento.
    </para>
    <substeps>
     <step>
      <para>
       Para actualizar los servicios y los repositorios, ejecute:
      </para>
      <screen>sudo zypper ref -fs</screen>
     </step>
     <step>
      <para>
       Para obtener una lista de los repositorios activos, ejecute:
      </para>
      <screen>sudo zypper lr</screen>
      <para>
       Compruebe con atención el resultado de este comando. No debería aparecer ningún servicio ni repositorio que se haya añadido para la actualización. Si, por ejemplo, está deshaciendo una migración de un paquete de servicios de SLES 12 SP1 a SLES 12 SP2, la lista <emphasis>no</emphasis> debe contener los repositorios <literal>SLES12-SP2-Pool</literal> ni <literal>SLES12-SP2-Updates</literal>, sino las versiones <literal>SP1</literal>.
      </para>
      <para>
       En caso de que se muestren repositorios incorrectos, asegúrese de suprimirlos y, si fuera necesario, sustitúyalos con las versiones que coinciden con su versión de producto o de paquete de servicios. Para obtener una lista de los repositorios para las vías de migración admitidas, consulte la <xref linkend="sec.update.nmm.repositories"/>.
      </para>
     </step>
     <step>
      <para>
       Por último, para comprobar el estado de registro de todos los productos instalados, ejecute:
      </para>
      <screen>SUSEConnect --status</screen>
      <para>
       Todos los productos deben mostrarse como <literal>registrados</literal>. Si no fuera el caso, para reparar el registro ejecute:
      </para>
      <screen>SUSEConnect --rollback</screen>
     </step>
    </substeps>
   </step>
  </procedure>
  <para>
   Ya ha revertido correctamente el sistema al estado que se capturó inmediatamente antes de que se iniciara la migración del paquete de servicios.
  </para>
 </sect1>
</chapter>
