<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="chrony.xml" version="5.0" xml:id="cha-ntp">



 <title>使用 NTP 同步時間</title>
 <info>
  <abstract>
   <para>
    NTP (網路時間協定) 機制是一種協定，用於同步化網路上的系統時間。首先，機器可以從提供可靠時間來源的伺服器取得時間。其次，機器本身在網路中可以做為其他電腦的時間來源。這個目標是雙重的 — 即維護絕對正確的時間，並同步化網路內所有機器的系統時間。
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <para>
  維謢精準的系統時間對於許多情況都非重要。內建的硬體時鐘通常無法符合資料庫或叢集等應用程式的要求。手動校正系統時間有可能會造成嚴重的問題，因為，例如時間倒退將可能造成重要應用程式無法正常運作。在網路中，通常需要同步所有機器中的系統時間，而手動調整時間的做法並不可取。NTP 提供了一種用於解決這些問題的機制。NTP 服務會依據網路中可靠的時間伺服器持續調整系統時間。它可以進一步管理本地參考的時鐘，例如收音機控制的時鐘。
 </para>
 <para>
  自 <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 15 起，採用 <systemitem class="resource">chrony</systemitem> 做為 NTP 的預設實作。<systemitem class="resource">chrony</systemitem> 包含兩個部分：<systemitem class="daemon">chronyd</systemitem> 精靈可在開機時啟動，<command>chronyc</command> 指令行介面程式用於監控 <systemitem class="daemon">chronyd</systemitem> 的效能，以及在執行時期變更各種操作參數。
 </para>
 <para>
  從 <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 15.2 開始，如果不是設定為以精靈的形式執行，適用於 NTP 用戶端組態的 YaST 模組會設定 systemd-timer 而不是 cron 精靈來執行 <systemitem class="resource">chrony</systemitem>。
 </para>
 <note os="sled;osuse">
  <para>
   若要透過 Active Directory 啟用時間同步，請遵照 <xref linkend="proc-ad-join"/> 中的說明。
  </para>
 </note>
 <sect1 xml:id="sec-ntp-yast">
  <title>使用 YaST 設定 NTP 用戶端</title>

  <para>
   <systemitem>chrony</systemitem> 套件中隨附的 NTP 精靈 (<systemitem class="daemon">chronyd</systemitem>) 預先設定為使用本地電腦硬體時鐘做為時間參考。硬體時鐘的精確度極大程度上取決於它的時間來源。例如，原子鐘或 GPS 接收器是非常精確的時間來源，而通用的 RTC 晶片則不是可靠的時間來源。YaST 簡化了 NTP 用戶端的組態。
  </para>

  <para>
   在 YaST NTP 用戶端組態 (<menuchoice><guimenu>網路服務</guimenu> <guimenu>NTP 組態</guimenu></menuchoice>) 視窗中，您可以指定啟動 NTP 精靈的時間、組態來源的類型，以及新增自訂的時間伺服器。
  </para>

  <figure>
   <title>NTP 組態視窗</title>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="ntp_client.png" width="70%" format="PNG"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="ntp_client.png" width="70%" format="PNG"/>
    </imageobject>
   </mediaobject>
  </figure>

  <sect2>
   <title>NTP 精靈啟動</title>
   <para>
    您可以從下面三個選項中選擇啟動 NTP 精靈的時間：
   </para>
   <variablelist>
    <varlistentry>
     <term><guimenu>僅手動</guimenu>
     </term>
     <listitem>
      <para>
       如果您想手動啟動 <systemitem class="resource">chrony</systemitem> 精靈，請選取<guimenu>僅手動</guimenu>。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><guimenu>同步但不啟動精靈</guimenu>
     </term>
     <listitem>
      <para>
       選取<guimenu>同步但不啟動精靈</guimenu>可定期設定系統時間，而不會永久執行 <systemitem class="resource">chrony</systemitem>。您可以設定<guimenu>同步時間間隔(分鐘)</guimenu>。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><guimenu>現在和開機時</guimenu>
     </term>
     <listitem>
      <para>
       選取<guimenu>現在和開機時</guimenu>可在系統開機時自動啟動 <systemitem class="daemon">chronyd</systemitem>￼。建議您使用此設定。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2>
   <title>組態來源的類型</title>
   <para>
    在<guimenu>組態來源</guimenu>下拉式方塊中，選取<guimenu>動態</guimenu>或<guimenu>靜態</guimenu>。如果伺服器只使用固定的一組 (公用) NTP 伺服器，請設定<guimenu>靜態</guimenu>；如果您的內部網路透過 DHCP 提供 NTP 伺服器，則使用<guimenu>靜態</guimenu>更合適。
   </para>
  </sect2>

  <sect2 xml:id="sec-net-ntp-yast-new-sync">
   <title>設定時間伺服器</title>
   <para>
    供用戶端查詢的時間伺服器列在 <guimenu>NTP 組態</guimenu>視窗的下半部分。修改清單時，可依需要使用<guimenu>新增</guimenu>、<guimenu>編輯</guimenu>以及<guimenu>刪除</guimenu>。
   </para>
   <para>
    按一下<guimenu>新增</guimenu>可新增新的時間伺服器：
   </para>
   <figure>
    <title>新增時間伺服器</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="ntp_client_serveradd.png" width="70%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="ntp_client_serveradd.png" width="70%" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <procedure>
    <step>
     <para>
      在<guimenu>位址</guimenu>欄位中，輸入要與機器時間同步的時間伺服器或時間伺服器池的 URL。填寫好 URL 後，按一下<guimenu>測試</guimenu>以驗證該 URL 是否指向有效的時間來源。
     </para>
    </step>
    <step>
     <para>
      啟用<guimenu>快速初始同步</guimenu>，以便在 <systemitem class="daemon">chronyd</systemitem> 精靈啟動時透過傳送更多要求來加速時間同步。
     </para>
    </step>
    <step>
     <para>
      啟用<guimenu>離線啟動</guimenu>，以使自動啟動 <systemitem class="daemon">chronyd</systemitem> 精靈且開機時可能沒有網際網路連接的系統加快開機速度。例如，對於由 NetworkManager 管理網路連接的筆記型機器，此選項非常實用。
     </para>
    </step>
    <step>
     <para>
      按一下<guimenu>確定</guimenu>加以確認。
     </para>
    </step>
   </procedure>
  </sect2>


 </sect1>



 <sect1 xml:id="sec-net-xntp-netconf">
  <title>手動設定網路中的 NTP</title>

  <para>
   <systemitem class="resource">chrony</systemitem> 從 <filename>/etc/chrony.conf</filename> 檔案讀取其組態。若要讓電腦時鐘保持同步，您需要告訴 <systemitem class="resource">chrony</systemitem> 使用什麼時間伺服器。您可以使用特定的伺服器名稱或 IP 位址，例如：
  </para>

<screen>server 0.europe.pool.ntp.org
server 1.europe.pool.ntp.org
server 2.europe.pool.ntp.org</screen>

  <para>
   還可以指定<emphasis>池</emphasis>名稱。池名稱會解析為數個 IP 位址：
  </para>

<screen>pool pool.ntp.org</screen>

  <tip>
   <title>同一網路中的多部電腦</title>
   <para>
    若要同步同一網路中多部電腦的時間，建議不要透過一部外部伺服器來同步所有電腦。比較好的做法是將其中一部電腦做為時間伺服器 (它與外部時間伺服器同步)，其他電腦做為它的用戶端。將 <literal>local</literal> 指令新增至伺服器的 <filename>/etc/chrony.conf</filename>，以將其與權威時間伺服器區分開：
   </para>
<screen>local stratum 10</screen>
  </tip>

  <para>
   若要啟動 <systemitem class="resource">chrony</systemitem>，請執行：
  </para>

<screen>systemctl start chronyd.service</screen>

  <para>
   啟始化 <systemitem class="daemon">chronyd</systemitem> 後，系統需要花費一些時間來穩定時間，以及建立用於校正本地電腦時鐘的偏移檔案。使用漂移檔案，可以在電腦開機時計算硬體時鐘的系統錯誤。它會立即使用校正，使系統時間具有更高的穩定性。
  </para>

  <para>
   若要啟用 <systemitem class="resource">chrony</systemitem>，以便該服務在開機時自動啟動，請執行：
  </para>

<screen>systemctl enable chronyd.service</screen>
 </sect1>
 <sect1 xml:id="ntp-chronyc">
  <title>在執行時期使用 <command>chronyc</command> 設定 <systemitem class="daemon">chronyd</systemitem></title>

  <para>
   在執行時期，您可以使用 <command>chronyc</command> 來變更 <systemitem class="daemon">chronyd</systemitem> 的行為。它會產生有關 <systemitem class="daemon">chronyd</systemitem> 操作的狀態報告。
  </para>

  <para>
   您可以採用互動模式或非互動模式執行 <command>chronyc</command>。若要採用互動模式執行 <command>chronyc</command>，請在指令行上輸入 <command>chronyc</command>。如此會顯示提示符並等待您輸入指令。例如，若要檢查有多少 NTP 來源在線上或離線，請執行：
  </para>

<screen><prompt role="root"># </prompt><command>chronyc</command>
chronyc&gt; activity
200 OK
4 sources online
2 sources offline
1 sources doing burst (return to online)
1 sources doing burst (return to offline)
0 sources with unknown address</screen>

  <para>
   若要結束 <command>chronyc</command> 的提示符，請輸入 <command>quit</command> 或 <command>exit</command>。
  </para>

  <para>
   如果您不需要使用互動式提示符，請直接輸入指令：
  </para>

<screen><prompt role="root"># </prompt><command>chronyc</command> activity</screen>

  <note>
   <title>暫時的變更</title>
   <para>
    使用 <command>chronyc</command> 進行的變更不是永久性的。當 <systemitem class="daemon">chronyd</systemitem> 下次重新啟動時，它們將會遺失。若要進行永久變更，請修改 <filename>/etc/chrony.conf</filename>。
   </para>
  </note>

  <para>
   如需 <command>chronyc</command> 指令的完整清單，請參閱它的手冊頁 (<command>man 1 chronyc</command>)。
  </para>
 </sect1>
 <sect1 xml:id="sec-net-xntp-dynamic">
  <title>執行時期的動態時間同步</title>



  <para>
  儘管 <systemitem class="daemon">chronyd</systemitem> 通常在開機時沒有網路連接的系統上啟動，但該工具無法解析組態檔案中所指定時間伺服器的 DNS 名稱。
  </para>

  <para>
   <systemitem class="daemon">chronyd</systemitem> 會依遞增的時間間隔，不斷嘗試解析由 <option>server</option>、<option>pool</option> 和 <option>peer</option> 指令指定的時間伺服器名稱，直到成功為止。
  </para>

  <para>
   如果啟動 <systemitem class="daemon">chronyd</systemitem> 時將無法存取時間伺服器，您可以指定 <option>offline</option> 選項：
  </para>

<screen>server <replaceable>server_address</replaceable> offline</screen>

  <para>
   如此，<systemitem class="daemon">chronyd</systemitem> 將不會嘗試輪詢該伺服器，除非使用以下指令啟用它：
  </para>

<screen><prompt role="root"># </prompt>chronyc online <replaceable>server_address</replaceable></screen>

  <para>
   設定 <option>auto_offline</option> 選項後，如果向時間伺服器傳送了兩個要求，但未接收到任何回應，<systemitem class="daemon">chronyd</systemitem> 會假設時間伺服器已離線。此選項使 <command>chronyc</command> 在網路連結斷開時，無需執行「離線」指令。
  </para>
 </sect1>



 <sect1 xml:id="sec-net-xntp-normal">
  <title>設定本地參考時鐘</title>

  <para>
   套裝軟體 <systemitem class="resource">chrony</systemitem> 依賴於其他程式 (例如 <systemitem>gpsd</systemitem>) 來透過 SHM 或 SOCK 驅動程式存取計時資料。在 <filename>/etc/chrony.conf</filename> 中使用 <option>refclock</option> 指令可指定要當成時間來源使用的硬體參考時鐘。它有兩個強制參數：驅動程式名稱和驅動程式特定的參數。這兩個參數後面跟著零或多個 <option>refclock</option> 選項。<systemitem class="daemon">chronyd</systemitem> 包含以下驅動程式：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     PPS：核心「pulse per second」API 的驅動程式。例如：
    </para>
<screen>refclock PPS /dev/pps0 lock NMEA refid GPS</screen>
   </listitem>
   <listitem>
    <para>
     SHM：NTP 共用記憶體驅動程式。例如：
    </para>
<screen>refclock SHM 0 poll 3 refid GPS1
refclock SHM 1:perm=0644 refid GPS2</screen>
   </listitem>
   <listitem>
    <para>
     SOCK：Unix 網域通訊端驅動程式。例如：
    </para>
<screen>refclock SOCK /var/run/chrony.ttyS0.sock</screen>
   </listitem>
   <listitem>
    <para>
     PHC：PTP 硬體時鐘驅動程式。例如：
    </para>
<screen>refclock PHC /dev/ptp0 poll 0 dpoll -2 offset -37
refclock PHC /dev/ptp1:nocrossts poll 3 pps</screen>
   </listitem>
  </itemizedlist>

  <para>
   如需各驅動程式的選項的詳細資訊，請參閱 <command>man 8 chrony.conf</command>。
  </para>
 </sect1>
 <sect1 xml:id="sec-net-xntp-etr" arch="zseries">
  <title>與外部時間參考 (ETR) 的時鐘同步</title>



  <para>
   支援將時鐘與外部時間參考 (ETR) 同步。外部時間參考每 2**20 (2 的 20 次方) 微秒傳送一次振盪器訊號與同步訊號，以將所有連結伺服器的 TOD 時鐘保持同步。
  </para>

  <para>
   為了便利，兩個 ETR 裝置可連接到一個機器。如果時鐘偏差超出同步檢查容錯，將會對所有 CPU 執行一次機器檢查，這表示時鐘未同步。如果出現這種狀況，則所有啟用了 DASD I/O 到 XRC 的裝置就會停止運作，直到時鐘重新同步。
  </para>

  <para>
   ETR 支援透過兩個 <literal>sysfs</literal> 屬性啟動；請以 <systemitem class="username">root</systemitem> 身分執行下列指令：
  </para>

<screen>echo 1 &gt; /sys/devices/system/etr/etr0/online
echo 1 &gt; /sys/devices/system/etr/etr1/online
</screen>
 </sect1>
</chapter>
