<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="hardware_nvdimm.xml" version="5.0" xml:id="cha-nvdimm">
 <title>永続的なメモリ</title>
 <info>
  <abstract>
   <para>
    この章では、1つ以上のNVDIMMで構成される「永続的なメモリ」とも呼ばれる不揮発性メインメモリと<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>の使用に関する追加情報を記載します。
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <sect1 xml:id="sec-nvdimm-intro">
  <title>はじめに</title>

  <para>
   永続的なメモリとは、新しいタイプのコンピュータストレージで、標準の動的RAM (DRAM)に近い速度を発揮し、RAMのバイト単位のアドレス指定、およびソリッドステートディスク(SSD)のパフォーマンスを併せ持ちます。
  </para>

  <para>
   従来のRAMと同様に、マザーボードのメモリスロットに直接設置されます。そのため、RAM、DIMMと同じ物理フォームファクタで提供されます。これらは、NVDIMM、不揮発性デュアルインラインメモリモジュールとして知られています。
  </para>

  <para>
   ただし、永続的なメモリはいくつかの点においてRAMとは異なり、フラッシュベースのSSDに類似しています。これらは両方ともソリッドステートメモリ回路の形態に基づいていますが、それにもかかわらず、両方とも不揮発性ストレージを提供し、システムの電源がオフにされたり、再起動されてもそのコンテンツは保持されます。両方の形態のメディアについて、データの書き込みは読み取りよりも低速で、両方とも限定された回数のリライトサイクルをサポートしています。また、SSDと同様に、特定の用途でより適している場合には、永続的なメモリへのセクタレベルのアクセスが可能です。
  </para>


  <para>
   モデルごとに、Intel 3D XPointや、NANDフラッシュとDRAMを組み合わせるなど、さまざまな形態の電子ストレージメディアを使用します。新たな形態の不揮発性RAMも開発中です。つまり、NVDIMMのさまざまなベンダーおよびモデルで、さまざまなパフォーマンスや耐久性特性が提供されることを意味しています。
  </para>
  
  <para>
   含まれるストレージテクノロジーは開発の初期段階であるため、さまざまなベンダーのハードウェアに異なった制限が与えられる場合があります。この一般的な内容は次のとおりです。
  </para>
  
  <para>
   永続的なメモリはDRAMより最大10倍低速ですが、フラッシュストレージより約1000倍高速です。フラッシュメモリの全セクタの消去およびリライトプロセスではなく、バイト単位でリライト可能です。つまり、リライトサイクルは限定されていますが、ほとんどの形態の永続的なメモリが、フラッシュストレージの数千サイクルと比較すると、何百万サイクルのリライトを処理することができます。
  </para>

  <para>
   ただし、この結果次の2つの制約を受けます。
  </para>

  <itemizedlist>
   <listitem>
    <para>
     現在のテクノロジーでは、永続的なメモリのみを使用してシステムを実行し、不揮発性メインメモリを完全に得ることはできません。従来のRAMとNVDIMM両方の混在したものを使用する必要があります。オペレーティングシステムおよびアプリケーションは、非常に高速な追加のストレージを提供するNVDIMMとともに、従来のRAMで実行されます。
    </para>
   </listitem>
   <listitem>
    <para>
     さまざまなベンダーの永続的なメモリのパフォーマンス特性は、使われているNVDIMM数、および装着に適したメモリスロットなど、特定のサーバのNVDIMMのハードウェア仕様をプログラマが認識している必要があるということを示しています。これは、ハイパーバイザーの使用、異なるホストマシン間のソフトウェアのマイグレーションなどに明白に影響します。
    </para>
   </listitem>
  </itemizedlist>
  
  <para>
   この新しいストレージサブシステムはACPI標準のバージョン6で定義されています。ただし、<filename>libnvdimm</filename>はプレ標準のNVDIMMをサポートし、同様に使用することができます。
  </para>
  
 </sect1>
 <sect1 xml:id="sec-nvdimm-terms">
  <title>用語</title>

  <variablelist>
   <varlistentry>
    <term>領域</term>
    <listitem>
     <para>
      「領域」とは1つ以上の「ネームスペース」に分けることが可能な永続的なメモリのブロックです。領域の永続的なメモリにアクセスするには、まず、その領域をネームスペースに割り当てる必要があります。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>ネームスペース</term>
    <listitem>
     <para>
      NVM Express SSDネームスペース、またはSCSI論理ユニット番号(LUN)と比較可能な、不揮発性ストレージの単一の連続アドレス指定範囲。ネームスペースはサーバの<filename>/dev</filename>ディレクトリに個別のブロックデバイスとして表示されます。要求されるアクセス方法に従って、ネームスペースは複数のNVDIMMから大きなボリュームにストレージを混合したり、より小さなボリュームにパーティショニングしたりできます。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>モード</term>
    <listitem>
     <para>
      各ネームスペースには、そのネームスペースに対して有効化されるNVDIMM機能を定義する「モード」があります。同じ親領域の兄弟ネームスペースは常に同じタイプですが、異なるモードに設定することもできます。ネームスペースのモードは次のとおりです。
     </para>
     <variablelist>
      <varlistentry>
       <term>raw</term>
       <listitem>
        <para>
         メモリディスク。DAXをサポートしません。他のオペレーティングシステムと互換性があります。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>sector</term>
       <listitem>
        <para>
         メタデータのチェックサムを実行しないレガシーファイルシステム用。小さなブートボリュームに適しています。他のオペレーティングシステムと互換性があります。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>fsdax</term>
       <listitem>
        <para>
         File system-DAXモード。他のモードが指定されない場合のデフォルトです。ブロックデバイス(<filename>/dev/pmem<replaceable>X</replaceable> [.<replaceable>Y</replaceable>]</filename>)を作成します。これは<literal>ext4</literal>または<literal>XFS</literal>用のDAXをサポートします。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>devdax</term>
       <listitem>
        <para>
         Device-DAXモード。単一文字のデバイスファイルを作成します(<filename> /dev/dax<replaceable>X</replaceable>.<replaceable>Y</replaceable>
         </filename>)。ファイルシステムの作成は必要「ありません」。
        </para>
       </listitem>
      </varlistentry>
     </variablelist>
    </listitem>
   </varlistentry>
   
   <varlistentry>
    <term>タイプ</term>
    <listitem>
     <para>
      各ネームスペースおよび領域には、そのネームスペースまたは領域に関連付けられた永続的なメモリへのアクセス方法を定義する「タイプ」があります。ネームスペースは常に親領域と同じタイプを持ちます。2つの異なるタイプ(永続的なメモリとブロックモード)があります。
     </para>
     <variablelist>
      <varlistentry>
       <term>永続的なメモリ(PMEM)</term>
       <listitem>
        <para>
         PMEMストレージはRAMのようにバイトレベルのアクセスを提供します。これにより、カーネルのページキャッシュを迂回して、メディアに直接移動するメモリにアクセスすることを意味する、直接アクセス(DAX)が有効になります。さらに、PMEMを使用すると、単一ネームスペースに複数のインターリーブされたNVDIMMを含めることができ、すべてに単一デバイスとしてアクセスできます。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>ブロックモード(BLK)</term>
       <listitem>
        <para>
         BLKアクセスは、定義されているアクセスウィンドウ「aperture」を介し、通常512バイトのセクタ内です。この動作はむしろ従来のディスクドライブのようです。これは、読み取りと書き込みの両方がカーネルによってキャッシュされることも意味します。BLKアクセスでは、各NVDIMMに別個のネームスペースとしてアクセスできます。
        </para>
       </listitem>
      </varlistentry>
     </variablelist>
     <para>
      一部のデバイスでは、PMEMとBLKモードの両方をサポートしています。また、一部のデバイスではストレージを別個のネームスペースに分割することができるため、一部はPMEM、BLKをそれぞれ使用してアクセスできます。
     </para>
     <para>
      <literal>devdax</literal>ネームスペースは別として、他のすべてのタイプは、従来のドライブと同様に、<literal>ext2</literal>、<literal>ext4</literal>、<literal>XFS</literal>などのファイルシステムでフォーマットされる必要があります。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>直接アクセス(DAX)</term>
    <listitem>
     <para>
      DAXでは、たとえば<literal>mmap</literal>システムコールを使用して、永続的なメモリをプロセスのアドレススペースに直接マップすることができます。これは、追加のRAMを使用することなく大容量のPMEMに直接アクセスしたり、RDMA用のPMEMのブロックを登録したり、それを仮想マシンに直接割り当てたりすることに適しています。 
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>DIMM物理アドレス(DPA)</term>
    <listitem>
     <para>
      単一DIMMメモリへのオフセットとしてのメモリアドレス。つまりそのDIMM上で最も小さいアドレス指定可能なバイトとして0から開始します。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>ラベル</term>
    <listitem>
     <para>
      ネームスペース定義など、NVDIMMに保存されるメタデータ。これにはDSMを使用してアクセスできます。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>デバイス固有のメソッド(DSM)</term>
    <listitem>
     <para>
      NVDIMM上のファームウェアにアクセスするためのACPIメソッド。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 
 <sect1 xml:id="sec-nvdimm-uses">
  <title>使用例</title>
  <sect2 xml:id="sec-nvdimm-uses-pmem">
   <title>DAXを使用したPMEM</title>
   <para>
    この形態のメモリアクセスはトランザクションが「可能ではない」ことに注意することが重要です。電源異常などのシステム障害が発生する場合には、データがストレージに完全に書き込まれない場合があります。PMEMストレージはアプリケーションが部分的に書き込まれたデータの状態を処理できる場合にのみ適しています。
   </para>
   <sect3>
    <title>
     バイトアドレス指定可能なストレージの大容量を活用するアプリケーション。
    </title> 
    <para>
     サーバがバイト単位の大容量高速ストレージを直接使用可能なアプリケーションをホストする場合、プログラマは<literal>mmap</literal>システムコールを使用して、追加のシステムRAMを使用せずに、永続的なメモリのブロックをアプリケーションのアドレススペースに直接配置することができます。 
    </para>
   </sect3>
   <sect3>
    <title>カーネルページキャッシュの使用を避ける</title>
    <para>
     ページキャッシュ用のRAMの使用を節約し、代わりにそれを使用するアプリケーションに指定したい場合。たとえば、不揮発性メモリを仮想マシン(VM)イメージの保持専用にすることができます。これらはキャッシュされませんが、ホスト上のキャッシュ使用率を削減し、ホストごとのVMを増やすことができます。
    </para>
   </sect3>
  </sect2>
  <sect2>
   <title>BTTを使用したPMEM</title>
   <para>
    高速ストレージのディスクのようなプールとしてNVDIMMのセットに永続的なメモリを使用したい場合に役立ちます。
   </para>
   <para>
    アプリケーションに対して、このようなデバイスは高速SSDとして認識され、他のストレージデバイスのように使用できます。たとえば、LVMは不揮発性ストレージの上部に階層化することができ、通常のように動作します。
   </para>
   <para>
    BTTの利点は、セクタ書き込みの原子性が保証されるため、データ整合性に依存する高度なアプリケーションでも機能し続けるという点です。メディアエラーレポートは標準のエラーレポーティングチャネルを介して機能します。
   </para>
  </sect2>
  <sect2>
   <title>BLKストレージ</title>
   <para>
    単一のデバイスの障害に対してより堅牢ですが、各NVDIMMが別個のデバイスとして表示されるため、追加の管理が必要です。したがって、BTTを使用したPMEMが一般的に推奨されます。
   </para>
   <note>
    <para>
     BLKストレージは非推奨であり、<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>の最新バージョンではサポートされていません。
    </para>
   </note>
  </sect2>
 </sect1>
 
 <sect1 xml:id="sec-nvdimm-tools">
  <title>永続的なメモリを管理するためのツール</title>

  <para>
   永続的なメモリを管理するには、<literal>ndctl</literal>パッケージをインストールする必要があります。これをインストールすることにより、NVDIMMを設定するためのユーザスペースライブラリのセットを提供する<filename>libndctl</filename>パッケージもインストールされます。
  </para>

  <para>
   これらのツールは、3タイプのNVDIMMをサポートする、<filename>libnvdimm</filename>ライブラリを介して機能します。
  </para>

  <itemizedlist>
   <listitem>
    <para>
     PMEM
    </para>
   </listitem>
   <listitem>
    <para>
     BLK
    </para>
   </listitem>
   <listitem>
    <para>
     同時のPMEMとBLK
    </para>
   </listitem>
  </itemizedlist>

  <para>
   <command>ndctl</command>ユーティリティには、次のコマンドを使用してアクセス可能な、便利な<command>man</command>ページセットがあります。
  </para>

<screen><command>ndctl help <replaceable>subcommand</replaceable></command></screen>

  <para>
   使用可能なサブコマンドのリストを表示するには、次を使用します。
  </para>

<screen><command>ndctl --list-cmds</command></screen>

  <para>
   使用可能なサブコマンドには次のものがあります。
  </para>

  <variablelist>
   <varlistentry>
    <term>version</term>
    <listitem>
     <para>
      NVDIMMサポートツールの現在のバージョンを表示します。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>enable-namespace</term>
    <listitem>
     <para>
      指定されたネームスペースを使用できるようにします。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>disable-namespace</term>
    <listitem>
     <para>
      指定されたネームスペースが使用されないようにします。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>create-namespace</term>
    <listitem>
     <para>
      指定されたストレージデバイスから新しいネームスペースを作成します。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>destroy-namespace</term>
    <listitem>
     <para>
      指定されたネームスペースを削除します。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>enable-region</term>
    <listitem>
     <para>
      指定された領域を使用できるようにします。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>disable-region</term>
    <listitem>
     <para>
      指定された領域が使用されないようにします。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>zero-labels</term>
    <listitem>
     <para>
      デバイスからメタデータを消去します。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>read-labels</term>
    <listitem>
     <para>
      指定されたデバイスのメタデータを取得します。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>list</term>
    <listitem>
     <para>
      使用可能なデバイスを表示します。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>help</term>
    <listitem>
     <para>
      ツールの使用に関する情報を表示します。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec-nvdimm-setup">
  <title>永続的なメモリのセットアップ</title>

  <sect2 xml:id="sec-nvdimm-setup-view">
   <title>使用可能なNVDIMMストレージの表示</title>
   <para>
    <command>ndctl</command> <literal>list</literal>コマンドを使用して、システム内で使用可能なすべてのNVDIMMを一覧表示できます。
   </para>
   <para>
    次の例では、システムにトリプルチャネルでインターリーブされた単一セットの3個のNVDIMMがあります。
   </para>
<screen><prompt role="root">root # </prompt><command>ndctl list --dimms</command>

[
 {
  "dev":"nmem2",
  "id":"8089-00-0000-12325476"
 },
 {
  "dev":"nmem1",
  "id":"8089-00-0000-11325476"
 },
 {
  "dev":"nmem0",
  "id":"8089-00-0000-10325476"
 }
]</screen>
   <para>
    別のパラメータ、<command>ndctl</command>
    <literal>list</literal>を使用して、使用可能な領域を一覧表示することもできます。
   </para>
   <note>
    <para>
     領域は番号順に表示されない場合があります。
    </para>
   </note>
   <para>
    3つのNVDIMMしかありませんが、4つの領域として表示されることに注意してください。
   </para>
<screen><prompt role="root">root # </prompt><command>ndctl list --regions</command>

[
 {
  "dev":"region1",
  "size":68182605824,
  "available_size":68182605824,
  "type":"blk"
 },
 {
  "dev":"region3",
  "size":202937204736,
  "available_size":202937204736,
  "type":"pmem",
  "iset_id":5903239628671731251
  },
  {
   "dev":"region0",
   "size":68182605824,
   "available_size":68182605824,
   "type":"blk"
  },
  {
   "dev":"region2",
   "size":68182605824,
   "available_size":68182605824,
   "type":"blk"
  }
]</screen>
   <para>
    スペースは次の2つの異なる形態で利用できます: BLKタイプの3つの個別の64GB領域として、または3つがインターリーブされたNVDIMM上にすべてのスペースを提供するPMEMタイプの1つに結合された189GB領域を単一のボリュームとして。
   </para>
   <para>
    <literal>available_size</literal>に表示される値は、<literal>size</literal>の値と同じであることに注意してください。これは、スペースのどれもまだ割り当てられていないということを意味します。
   </para>
  </sect2>

  <sect2 xml:id="sec-nvdimm-setup-dax">
   <title>DAXを使用した単一のPMEMネームスペースとしてストレージを設定する</title>
   <para>
    最初の例として、直接アクセス(DAX)を使用した単一のPMEMネームスペースに3つのNVDIMMを設定します。
   </para>
   <para>
    最初のステップは、新しいネームスペースを作成することです。
   </para>
   
<screen><prompt role="root">root # </prompt><command>ndctl create-namespace --type=<replaceable>pmem</replaceable> --mode=<replaceable>fsdax</replaceable> --map=<replaceable>memory</replaceable></command>
{
 "dev":"namespace3.0",
 "mode":"memory",
 "size":199764213760,
 "uuid":"dc8ebb84-c564-4248-9e8d-e18543c39b69",
 "blockdev":"pmem3"
}</screen>
   <para>
    これにより、DAXをサポートする、ブロックデバイス<filename>/dev/pmem3</filename>が作成されます。デバイス名の<literal>3</literal> (この場合は<filename>region3</filename>)は、親地域番号から継承されます。
   </para>
   <para>
    <option>--map=memory</option>オプションにより、NVDIMM上にPMEMストレージスペースの一部が置かれ、これは<literal>struct pages</literal>と呼ばれる内部カーネルデータ構造を割り当てるために使用できます。これにより、新しいPMEMネームスペースが<literal>O_DIRECT I/O</literal>や<literal>RDMA</literal>などの機能で使用できるようになります。
   </para>
   <para>
    カーネルデータ構造用に一部の永続的なメモリを予約するのは、生成されるPMEMネームスペースの容量がPMEM親領域よりも小さいためです。
   </para>
   <para>
    次に、新しいブロックデバイスがオペレーティングシステムで利用可能であることを確認します。
   </para>
<screen><prompt role="root">root # </prompt><command>fdisk -l /dev/<replaceable>pmem3</replaceable></command>
Disk /dev/pmem3: 186 GiB, 199764213760 bytes, 390164480 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 4096 bytes
I/O size (minimum/optimal): 4096 bytes / 4096 bytes</screen>
   <para>
    使用する前に、他のドライブのように、フォーマットする必要があります。この例では、XFSを使用してフォーマットします。
   </para>
<screen><prompt role="root">root # </prompt><command>mkfs.xfs /dev/<replaceable>pmem3</replaceable></command>
meta-data=/dev/pmem3      isize=256    agcount=4, agsize=12192640 blks
         =                sectsz=4096  attr=2, projid32bit=1
         =                crc=0        finobt=0, sparse=0
data     =                bsize=4096   blocks=48770560, imaxpct=25
         =                sunit=0      swidth=0 blks
naming   =version 2       bsize=4096   ascii-ci=0 ftype=1
log      =internal log    bsize=4096   blocks=23813, version=2
         =                sectsz=4096  sunit=1 blks, lazy-count=1
realtime =none            extsz=4096   blocks=0, rtextents=0</screen>
   <para>
    次に、新しいドライブを特定のディレクトリにマウントできます。
   </para>
<screen><prompt role="root">root # </prompt><command>mount -o dax /dev/<replaceable>pmem3</replaceable> /mnt/<replaceable>pmem3</replaceable></command></screen>
   <para>
    ここで、DAX対応デバイスがあることを確認できます。
   </para>
<screen><prompt role="root">root # </prompt><command>mount | grep dax</command>
/dev/pmem3 on /mnt/pmem3 type xfs (rw,relatime,attr2,dax,inode64,noquota)</screen>
   <para>
    これで、XFSファイルシステムでフォーマットされ、DAXでマウントされたPMEMネームスペースが設定されます。
   </para>
   <para>
    <literal>mmap()</literal>は、ファイルに呼び出しを行い、ファイルシステムはNVDIMM上の永続的なメモリに直接マップする仮想アドレスを返し、ページキャッシュを完全にバイパスします。
   </para>
   <para>
    そのファイルシステム内のファイルに対する<literal>fsync</literal>または<literal>msync</literal>呼び出しが行われても、変更されたデータは完全にNVDIMMに書き込まれています。これらの呼び出しは<literal>mmap</literal>マッピングを介してユーザスペースで変更されているページに関連付けられているプロセッサキャッシュラインをフラッシュします。
   </para>
   <sect3 xml:id="sec-nvdimm-setup-deldax">
    <title>ネームスペースの削除</title>
    <para>
     同じストレージを使用する他のボリュームタイプを作成する前に、このPMEMボリュームをアンマウントしてから削除する必要があります。
    </para>
    <para>
     まず、このボリュームをアンマウントします。
    </para>
<screen><prompt role="root">root # </prompt><command>umount /mnt/<replaceable>pmem3</replaceable></command></screen>
    <para>
     次にネームスペースを無効にします。
    </para>
<screen><prompt role="root">root # </prompt><command>ndctl disable-namespace <replaceable>namespace3.0</replaceable></command>
disabled 1 namespace</screen>
    <para>
     そして削除します。
    </para>
<screen><prompt role="root">root # </prompt><command>ndctl destroy-namespace <replaceable>namespace3.0</replaceable></command>
destroyed 1 namespace</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-nvdimm-setup-btt">
   <title>BTTを使用したPMEMネームスペースの作成</title>
   <para>
    次の例では、BTTを使用するPMEMネームスペースを作成します。
   </para>
<screen><prompt role="root">root # </prompt><command>ndctl create-namespace --type=<replaceable>pmem</replaceable> --mode=<replaceable>sector</replaceable></command>
{
 "dev":"namespace3.0",
 "mode":"sector",
 "uuid":"51ab652d-7f20-44ea-b51d-5670454f8b9b",
 "sector_size":4096,
 "blockdev":"pmem3s"
}</screen>
   <para>
    次に、新しいデバイスが存在することを確認します。
   </para>
<screen><prompt role="root">root # </prompt><command>fdisk -l /dev/<replaceable>pmem3s</replaceable></command>
Disk /dev/pmem3s: 188.8 GiB, 202738135040 bytes, 49496615 sectors
Units: sectors of 1 * 4096 = 4096 bytes
Sector size (logical/physical): 4096 bytes / 4096 bytes
I/O size (minimum/optimal): 4096 bytes / 4096 bytes</screen>
   <para>
    以前に設定したDAX対応PMEMネームスペースと同様に、このBTT対応PMEMネームスペースはNVDIMM上で使用可能なすべてのストレージを消費します。
   </para>
   <note>
    <para>
     デバイス名の最後の<literal>s</literal> (<filename>/dev/<replaceable>pmem3s</replaceable></filename>)は、<literal>sector</literal>を表し、BTTを使用するように設定されるPMEMとBLKネームスペースを簡単に区別するために使用されます。
    </para>
   </note>
   <para>
    ボリュームは前の例と同様に、フォーマットし、マウントできます。
   </para>
   <para>
    ここに表示されるPMEMネームスペースはDAXを使用することはできません。その代わりに、BTTを使用して、「セクタ書き込みの原子性」を提供します。PMEMブロックドライバからのセクタ書き込みが行われるたびに、BTTは新しいセクタを割り当てて新しいデータを受け取ります。BTT原子性により、新しいデータが完全に書き込まれた後で、その内部マッピング構造をアップデートし、新しく書き込まれたデータがアプリケーションで利用できるようにします。このプロセス中に任意のポイントで電源障害が発生した場合、書き込みは完全に消失しますが、アプリケーションはまだ存在する古いデータにアクセスできます。これにより、「tornセクタ」と呼ばれる状況が回避されます。
   </para>
   <para>
    このBTT対応PMEMネームスペースは他の標準ブロックデバイスのようにファイルシステムでフォーマットして使用できます。DAXと併用することはできません。ただし、このブロックデバイス上のファイルの<literal>mmap</literal>マッピングはページキャッシュを使用します。
   </para>
   <note>
    <para>
     これらの両方の例で、すべてのNVDIMMからのスペースは単一ボリュームに結合されます。非冗長ディスクアレイと同様に、これは個々のNVDIMMでエラーが発生した場合に、ボリューム全体のコンテンツが失われる可能性があることを意味します。NVDIMMがボリューム内に含まれれば含まれるほど、このようなエラーの機会は多くなります。
    </para>
   </note>
   <sect3 xml:id="sec-nvdimm-setup-delbtt">
    <title>PMEMボリュームの削除</title>
    <para>
     前の例と同様ですが、スペースを再割り当てする前に、まずボリュームとネームスペースを削除する必要があります。
    </para>
<screen><prompt role="root">root # </prompt><command>ndctl disable-namespace <replaceable>namespace3.0</replaceable></command>
disabled 1 namespace

<prompt role="root">root # </prompt><command>ndctl destroy-namespace <replaceable>namespace3.0</replaceable></command>
destroyed 1 namespace</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-nvdimm-setup-blk">
   <title>BLKネームスペースの作成</title>
   <para>
    この例では、3つの個別のBLKデバイスをNVDIMMごとに1つ作成します。
   </para>
   <para>
    このアプローチの1つのメリットは、個々のNVDIMMで障害が発生した場合に、他のボリュームに影響しないということです。
   </para>
   <note>
    <para>
     ネームスペースごとにコマンドを繰り返す必要があります。
    </para>
   </note>
<screen><prompt role="root">root # </prompt><command>ndctl create-namespace --type=<replaceable>blk</replaceable> --mode=<replaceable>sector</replaceable></command>
{
 "dev":"namespace1.0",
 "mode":"sector",
 "uuid":"fed466bd-90f6-460b-ac81-ad1f08716602",
 "sector_size":4096,
 "blockdev":"ndblk1.0s"
}
   
<prompt role="root">root # </prompt>ndctl create-namespace --type=blk --mode=sector
{
 "dev":"namespace0.0",
 "mode":"sector",
 "uuid":"12a29b6f-b951-4d08-8dbc-8dea1a2bb32d",
 "sector_size":4096,
 "blockdev":"ndblk0.0s"
}
    
<prompt role="root">root # </prompt><command>ndctl create-namespace --type=<replaceable>blk</replaceable> --mode=<replaceable>sector</replaceable></command>
{
 "dev":"namespace2.0",
 "mode":"sector",
 "uuid":"7c84dab5-cc08-452a-b18d-53e430bf8833",
 "sector_size":4096,
 "blockdev":"ndblk2.0s"
}
   </screen>
   <para>
    次に、新しいデバイスが存在していることを確認することができます。
   </para>
<screen><prompt role="root">root # </prompt>fdisk -l /dev/<replaceable>ndblk*</replaceable>
Disk /dev/ndblk0.0s: 63.4 GiB, 68115001344 bytes, 16629639 sectors
Units: sectors of 1 * 4096 = 4096 bytes
Sector size (logical/physical): 4096 bytes / 4096 bytes
I/O size (minimum/optimal): 4096 bytes / 4096 bytes

Disk /dev/ndblk1.0s: 63.4 GiB, 68115001344 bytes, 16629639 sectors
Units: sectors of 1 * 4096 = 4096 bytes
Sector size (logical/physical): 4096 bytes / 4096 bytes
I/O size (minimum/optimal): 4096 bytes / 4096 bytes

Disk /dev/ndblk2.0s: 63.4 GiB, 68115001344 bytes, 16629639 sectors
Units: sectors of 1 * 4096 = 4096 bytes
Sector size (logical/physical): 4096 bytes / 4096 bytes
I/O size (minimum/optimal): 4096 bytes / 4096 bytes</screen>
   <para>
    BLKネームスペース用に生成されたブロックデバイスは、<filename>/dev/ndblk<replaceable>X</replaceable>.<replaceable>Y</replaceable></filename>という名前が付けられます。ここで、<replaceable>X</replaceable>は親領域番号で、<replaceable>Y</replaceable>はその領域内の固有のネームスペース番号です。したがって、<filename>/dev/ndblk2.0s</filename>は領域2の子ネームスペース番号0です。
   </para>
   <para>
    前の例と同様に、末尾の<literal>s</literal>はこのネームスペースが(セクタベースのアクセス用に) BTTを使用するように設定されていることを意味します。<literal>block window</literal>を介してアクセスされるため、プログラムはDAXを使用できないが、アクセスはキャッシュされます。
   </para>
   <para>
    以前と同様に、これらのデバイスはすべてフォーマットされ、マウントされてから、使用する必要があります。
   </para>
  </sect2>
 </sect1>
 
 <sect1 xml:id="sec-nvdimm-troubleshoot">
  <title>トラブルシューティング</title>
  
  <para>
   永続的なメモリはSSDストレージよりも耐久性に優れているが、摩耗する可能性があります。NVDIMMで障害が発生した場合、故障した個々のモジュールを孤立させる必要があるため、残りのデータは回復され、ハードウェアを交換することができます。次の3つの情報を検出する必要があります。
  </para>
  <orderedlist>
   <listitem>
    <para>
     どのNVDIMMモジュールで障害が発生したか: 故障モジュールの物理的な場所。
    </para>
   </listitem>
   <listitem>
    <para>
     どのネームスペース(<filename>/dev/pmem<replaceable>X</replaceable></filename>)に現在不良ブロックが含まれているか。  
    </para>
   </listitem>
   <listitem>
    <para>
     他のどのネームスペースまたは領域でその物理モジュールを使用するか。
    </para>
   </listitem>
  </orderedlist>

  <para>
   故障モジュールとともに、それを使用するネームスペースおよび領域が決定された後で、他の影響を受けないネームスペースのデータはバックアップすることができ、サーバをシャットダウンして、NVDMMを交換することができます。 
  </para>
  <sect2>
   <title>故障モジュールの検索</title>
   <para>
    NVDIMMのセットはサーバのマザーボード上のDIMMスロットで検索されます。
   </para>
   <para>
    結果のスペースで、オペレーティングシステムによって<filename>region0</filename>などの1つ以上のネームスペースが作成されます。   
   </para>
   <para>
    次に、これらの領域内で、特定のネームスペース(例: <filename>/dev/pmem1</filename>や<filename>/dev/dax0</filename>)が定義されます。
   </para>
   <para>
    たとえば、3つのネームスペースとして設定されている3つのNVDIMMのスペースで構成される1つの領域があるとします。 
   </para>
   <informaltable>
    <tgroup cols="4">
    <colspec colname="col1"/>
    <colspec colname="col2"/>
    <colspec colname="col3"/>
    <colspec colname="col4"/>
     
     <tbody>
     <row>
      <entry>
       <para>
        NVDIMM 0
       </para>
      </entry>
      <entry>
       <para>
        region0
       </para>
      </entry>
      <entry>
       <para>
        /dev/pmem1
       </para>
      </entry>
      <entry/>
     </row>
     
     <row>
      <entry>
       <para>
        NVDIMM 1
       </para>
      </entry>
      <entry>
       <para>
        <emphasis>[X]</emphasis>
       </para>
      </entry>
      <entry>
       <para>
        /dev/pmem2s
       </para>
      </entry>
      <entry/>
     </row>
     
     <row>
      <entry>
       <para>
        NVDIMM 2
       </para>
      </entry>
      <entry>
       <para>
        /dev/dax0
       </para>
      </entry>
      <entry namest="col3" nameend="col4"/>
     </row>
     
    </tbody>
    </tgroup>
   </informaltable>
   
   <para>
    この例では、[X]とラベル付けされた<filename>region0</filename>の部分が破損しているか、故障しています。
   </para>
   <para>
    次の作業が必要です。
   </para>
   <orderedlist>
    <listitem>
     <para>
      影響を受ける領域を含むNVDIMMモジュールを特定します。
     </para>
     <para>
      その領域が複数のNVDIMM間でインターリーブされている場合にはこれは特に重要です。
     </para>
    </listitem>
    
    <listitem>
     <para>
      影響を受けるNVDIMM上の他のネームスペースのコンテンツをバックアップします。
     </para>
     <para>
      この例では、<filename>/dev/pmem2s</filename>のコンテンツをバックアップする必要があります。
     </para>
    </listitem>
    
    <listitem>
     <para>
      NVDIMMのネームスペースと(マザーボードのメモリスロットが配置されている)物理的な位置との関係を特定します。
     </para>
     <para>
      サーバをシャットダウンし、そのカバーを取り外し、欠陥モジュールを検出、取り外し、交換する必要があります。
     </para>
    </listitem>
   </orderedlist>
  </sect2>
  <sect2 xml:id="sec-nvdimm-testing">
   <title>永続的なメモリのテスト</title>
   <note>
    <title>欠陥検出の前提条件</title>
    <para>
     テストする場合は、<filename>nfit_test</filename>カーネルモジュールが必要です。
    </para>
   </note> 
   <para>
    テストの手順は、GitHub pageの<command>ndctl</command>コマンドにある「<literal>Unit test</literal>」セクションのステップ1～4に詳しく説明されています。この章の最後の<xref linkend="sec-nvdimm-moreinfo"/>を参照してください。
   </para>
   <procedure>
    <title>
     テスト手順
    </title>
    <step>
     <para>
      パラメータ<command>list -RM</command>を指定して<command>ndctl</command>コマンドを実行します。
     </para>
     <para>
      これは不良ブロックのリストを示しています。
     </para>
     <screen> <prompt>tux &gt; </prompt><command>sudo</command> ndctl list -RM 
  :
  :
 { 
   "dev":"region5", 
   "size":33554432, 
   "available_size":33554432, 
   "type":"pmem", 
   "iset_id":4676476994879183020, 
   "badblock_count":8, 
   "badblocks":[ 
     { 
       "offset":32768, 
       "length":8, 
       "dimms":[ 
          "nmem1" <co xml:id="sec-nvdimm-co1"/>  
       ] 
     } 
   ] 
 }, 
 :</screen>
     <calloutlist>
      <callout arearefs="sec-nvdimm-co1">
       <para>
        特定のNVDIMMがここで特定されています。
       </para>
      </callout>
     </calloutlist>
    </step>
    
    <step>
     <para>
      パラメータ<command>list -Du</command>を指定して<command>ndctl</command>コマンドを実行します。
     </para>
     <para>
      これはDIMMの「処理」を示しています。
     </para>
     <screen>  <prompt>tux &gt; </prompt><command>sudo</command> ndctl list -Du
  { 
     "dev":"nmem1", 
     "id":"cdab-0a-07e0-feffffff", 
     "handle":"0x1", <co xml:id="sec-nvdimm-co2"/> 
     "phys_id":"0x1"     
  }, 
   : 
   :</screen>
     <calloutlist>
      <callout arearefs="sec-nvdimm-co2">
       <para>
        これはNVDIMMの処理です。
       </para>
      </callout>
     </calloutlist>
    </step>

    <step>
     <para>
      パラメータ<command>list --d <replaceable>DIMMM名</replaceable></command>を指定して、<command>ndctl</command>コマンドを実行します。
     </para>
     <screen> <prompt>tux &gt; </prompt><command>sudo</command> ndctl list -R -d nmem1 
 [ 
   { 
     "dev":"region5", 
     "size":33554432, 
     "available_size":33554432, 
     "type":"pmem", 
     "iset_id":4676476994879183020, 
     "badblock_count":8 
    }, 
   : 
   :
     </screen>
    </step>
   </procedure>
  </sect2>
  
   
 </sect1>
 
 <sect1 xml:id="sec-nvdimm-moreinfo">
  <title>その他の情報</title>

  <para>
   このトピックの詳細については、次のリストを参照してください。
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     <link xlink:href="https://nvdimm.wiki.kernel.org/">永続的なメモリのWiki</link>
    </para>
    <para>
     NVDIMMシステムを構成するための手順、テストに関する情報、およびNVDIMMの有効化に関連する仕様へのリンクが記載されています。LinuxのNVDIMMサポートは現在開発中のため、このサイトも構築中です。
    </para>
   </listitem>
   <listitem>
    <para>
     <link xlink:href="http://pmem.io/">永続的なメモリのプログラミング</link>
    </para>
    <para>
     Linuxおよび他のオペレーティングシステムの下で、不揮発性メモリを搭載したシステムを設定、使用、およびプログラミングする方法に関する情報。ユーザスペースの永続的なメモリをプログラミングするために役立つAPIを提供することを目的とした、NVMライブラリ(NVML)について説明しています。
    </para>
   </listitem>
   <listitem>
    <para>
     <link xlink:href="https://www.kernel.org/doc/Documentation/nvdimm/nvdimm.txt">LIBNVDIMM: 不揮発性デバイス</link>
    </para>
    <para>
     これは、カーネル開発者を対象としており、現在のLinuxカーネルツリーのドキュメントフォルダの一部です。NVDIMM有効化に含まれている異なるカーネルモジュール、カーネル実装のテクニカル詳細、<command>ndctl</command>ツールによって使用されるカーネルへの<filename>sysfs</filename>インタフェースについて説明しています。
    </para>
   </listitem>
   <listitem>
    <para>
     <link xlink:href="https://github.com/pmem/ndctl">GitHub: pmem/ndctl</link>
    </para>
    <para>
     Linuxカーネルの<command>libnvdimm</command>サブシステムを管理するためのユーティリティライブラリ。ユーザスペースライブラリ、ユニットテスト、およびマニュアルも含まれます。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
