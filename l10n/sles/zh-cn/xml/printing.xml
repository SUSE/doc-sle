<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="printing.xml" version="5.0" xml:id="cha-print">
 <title>打印机操作</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <para>
  <phrase role="productname"><phrase os="sles">SUSE® Linux Enterprise Server</phrase></phrase> 支持使用多种类型的打印机进行打印，其中包括远程网络打印机。可以手动或使用 YaST 配置打印机。有关配置描述，请参见<xref linkend="sec-yast-hw-print"/>。启动和管理打印任务时既可以使用图形实用程序，也可以使用命令行实用程序。如果打印机未能按预期正常工作，请参见<xref linkend="sec-print-prob"/>。
 </para>
 <para>
  CUPS（通用 Unix 打印系统）是 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 中的标准打印系统。
 </para>
 <para>
  可以根据接口（例如 USB 或网络）以及打印机语言对打印机进行区分。购买打印机时，确保打印机配有支持的接口（USB、以太网或 Wi-Fi）和合适的打印机语言。可以按照以下三类打印机语言对打印机进行分类：
 </para>
 <variablelist>
  <varlistentry>
   <term>PostScript 打印机</term>
   <listitem>
    <para>
     Linux 和 Unix 中的内部打印系统使用 PostScript 这种打印机语言生成并处理大部分打印任务。如果打印机可以直接处理 PostScript 文档而不需要在打印系统中通过附加步骤转换这些文档，则可以降低可能出现的错误的数目。
    </para>
    <para>
     PDF 正在逐渐取代 PostScript，成为标准打印作业格式。可直接打印 PDF（而不仅仅是 PostScript）的 PostScript+PDF 打印机已经面世。传统的 PostScript 打印机需要在打印工作流程中将 PDF 转换为 PostScript。
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term>标准打印机（PCL 和 ESC/P 等语言）</term>
   <listitem>
    <para>
     对于已知的打印机语言，打印系统可以借助 Ghostscript 将 PostScript 作业转换为相应的打印机语言。此处理阶段称为解释。最有名的语言有 PCL（主要是 HP 打印机及其克隆产品使用）和 ESC/P（Epson 打印机使用）。这些打印机语言通常受 Linux 支持，可以生成令人满意的打印效果。Linux 可能无法使用某些特殊打印机功能。除了 HP 和 Epson 之外，当前尚没有其他打印机制造商开发 Linux 驱动程序，并通过开放源代码许可证将这些驱动程序提供给 Linux 发行套件供应商。
    </para>
   </listitem>
  </varlistentry>
  <varlistentry xml:id="sec-print-prep-gdi">
   <term>专有打印机（也称为 GDI 打印机）</term>
   <listitem>
    <para>
     这些打印机不支持任何常见的打印机语言。这些打印机使用自己的无文档记录打印机语言，该语言在发布新版本时可能发生变化。通常只有 Windows 驱动程序供这些打印机使用。有关更多信息，请参见<xref linkend="sec-print-gdi"/>。
    </para>
   </listitem>
  </varlistentry>
 </variablelist>
 <para>
  在您购买新打印机之前，请参考以下资源以了解您要购买的打印机的支持情况：
 </para>
 <variablelist>
  <varlistentry>
   <term><link xlink:href="http://www.openprinting.org/printers"/>
   </term>
   <listitem>
    <para>
     包含打印机数据库的 OpenPrinting 主页。数据库显示最新的 Linux 支持状态。但是，Linux 分发只能集成生产时可用的驱动程序。因此，当前标为<quote>完全支持</quote>的打印机在最新的 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 版本发布后，不一定还具有此状态。这样，数据库不一定可以指出正确的状态，只是提供大致估计而已。
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><link xlink:href="http://pages.cs.wisc.edu/~ghost/"/>
   </term>
   <listitem>
    <para>
     Ghostscript 网页
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><filename>/usr/share/doc/packages/ghostscript/catalog.devices</filename>
   </term>
   <listitem>
    <para>
     内置 Ghostscript 驱动程序列表。
    </para>
   </listitem>
  </varlistentry>
 </variablelist>
 <sect1 xml:id="sec-print-workflow">
  <title>CUPS 工作流程</title>

  <para>
   用户创建一个打印任务。打印作业由要打印的数据和有关假脱机程序的信息组成。其中包括打印机的名称或打印队列的名称，还有可能包括有关过滤器（例如特定于打印机的选项）的信息。
  </para>

  <para>
   每台打印机至少有一个专用打印队列。假脱机程序储存着队列中的打印任务，直到所需打印机已做好接收数据的准备。打印机准备就绪后，假脱机程序通过过滤器和后端将数据发送到打印机。
  </para>

  <para>
   过滤器会将正在执行打印的应用程序生成的数据（通常为 PostScript 或 PDF，也可能为 ASCII、JPEG 等）转换为特定于打印机的数据（PostScript、PCL、ESC/P 等）。PPD 文件中描述了打印机的功能。PPD 文件包含打印机特定的选项以及在打印机上启用这些选项所需的参数。过滤器系统用于确保用户选择的选项被启用。
  </para>

  <para>
   如果使用的是 PostScript 打印机，则过滤器系统将数据转换为打印机特定的 PostScript。这样做不需要打印机驱动程序。如果使用的是非 PostScript 打印机，则过滤器系统将数据转换为打印机专用的数据。这样做需要一个适合您的打印机的 打印机驱动程序。后端从过滤器接收打印机特定的数据，然后将其传递到打印机。
  </para>
 </sect1>
 <sect1 xml:id="sec-print-method">
  <title>连接打印机的方法和协议</title>

  <para>
   可以通过多种方法将打印机连接到系统。CUPS 的配置不能区分本地打印机和通过网络连接到系统的打印机。有关打印机连接的更多信息，请阅读 <link xlink:href="https://en.opensuse.org/SDB:CUPS_in_a_Nutshell"/> 上的文章 <emphasis>CUPS in a Nutshell</emphasis>（CUPS 概述）。
  </para>

  <para arch="zseries" os="sles">
   CUPS 不支持 z/VM 所提供且本地连接到 IBM Z 大型机的打印机和类似设备。在这些平台上，只能通过网络进行打印。必须根据打印机制造商的描述安装网络打印机的电缆。
  </para>

  <warning>
   <title>更改正在运行的系统中的电缆连接</title>
   <para>
    当将打印机连接到计算机时，一定不要忘记操作期间只能插入或拔下 USB 设备。为防止损坏系统或打印机，请在更改任何非 USB 连接前先关闭系统。
   </para>
  </warning>
 </sect1>
 <sect1 xml:id="sec-print-software">
  <title>安装软件</title>

  <para>
   PPD（PostScript 打印机描述）是描述属性（例如，分辨率）和选项（例如，双面打印单位的可用性）的计算机语言。这些描述对于使用 CUPS 中的各个打印机选项是必需的。如果没有 PPD 文件，打印数据将被以<quote>原始</quote>状态转发到打印机，通常这不是希望出现的情况。
  </para>

  <para>
   要配置 PostScript 打印机，最佳的方法是获得一个合适的 PPD 文件。<systemitem>manufacturer-PPDs</systemitem> 和 <systemitem>OpenPrintingPPDs-postscript</systemitem> 软件包中提供了许多 PPD 文件。请参见<xref linkend="sec-print-special-ppd"/>和<xref linkend="sec-print-prob-ppd"/>。
  </para>

  <para>
   新的 PPD 文件可以储存在目录 <filename>/usr/share/cups/model/</filename> 中，或如<xref linkend="sec-yast-hw-print-local-get-ppd"/>中所述使用 YaST 添加到打印系统中。随后，可以在打印机设置过程中选择 PPD 文件。
  </para>

  <para>
   如果打印机制造商希望您安装整个软件包，请务必小心。这种安装类型可能导致 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 提供的支持失效。另外，打印命令可能会以不同的方式工作，并且系统可能不再能够对其他制造商的设备寻址。出于此原因，不建议安装制造商软件。
  </para>
 </sect1>
 <sect1 xml:id="sec-print-net">
  <title>网络打印机</title>

  <para>
   网络打印机可以支持多种协议，有些甚至支持并发打印不同协议。尽管大部分支持的协议都已标准化，但某些制造商可能修改了标准。他们仅提供适用于少数操作系统的驱动程序。不过很少提供 Linux 驱动程序。当前的情况是您在执行操作时不能假定每个协议都可以在 Linux 中正常工作。因此，您可能需要试验不同的选项以找出起作用的配置。
  </para>



  <para>
   CUPS 支持 <systemitem>socket</systemitem>、<systemitem>LPD</systemitem>、<systemitem>IPP</systemitem> 和 <systemitem>smb</systemitem> 协议。
  </para>

  <variablelist>
   <varlistentry>
    <term>socket</term>
    <listitem>
     <para>
      <emphasis>套接字</emphasis>是指将纯文本打印数据直接发送到 TCP 套接字的连接。一些常用的套接字端口号包括 <option>9100</option> 或 <option>35</option>。设备 URI（统一资源标识符）的语法为 socket://<replaceable>IP.OF.THE.PRINTER</replaceable>:<replaceable>PORT</replaceable>，例如：<systemitem>socket://192.168.2.202:9100/</systemitem>。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>LPD（行式打印机守护程序）</term>
    <listitem>
     <para>
      LPD 协议如 RFC 1179 中所述。使用此协议，打印队列 ID 等作业相关数据将先于实际打印数据发送。因此，配置 LPD 协议时必须指定打印队列。各打印机制造商的实施非常灵活，可以接受为打印队列指定任何名称。如果需要，打印机手册应该指出要使用的名称。通常使用 LPT、LPT1、LP1 或类似的名称。LPD 服务的端口号是 <option>515</option>。设备 URI 示例：<systemitem>lpd://192.168.2.202/LPT1</systemitem>。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>IPP（互联网打印协议）</term>
    <listitem>
     <para>
      IPP 基于 HTTP 协议。使用 IPP，所传送的与任务有关的数据比其他协议要多一些。CUPS 使用 IPP 进行内部数据传送。要正确配置 IPP，必须提供打印队列的名称。IPP 的端口号是 <literal>631</literal>。设备 URI 示例：<systemitem>ipp://192.168.2.202/ps</systemitem> 和 <systemitem>ipp://192.168.2.202/printers/ps</systemitem>。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>SMB（Windows 共享）</term>
    <listitem>
     <para>
      CUPS 还支持在连接到 Windows 共享的打印机上进行打印。用于此目的的协议是 SMB。SMB 使用端口号 <option>137</option>、<option>138</option> 和 <option>139</option>。设备 URI 示例：<systemitem>smb://user:password@workgroup/smb.example.com/printer</systemitem>、<systemitem>smb://user:password@smb.example.com/printer</systemitem> 和 <systemitem>smb://smb.example.com/printer</systemitem>。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   必须在配置之前确定打印机支持的协议。如果制造商未提供所需的信息，则可以使用命令 <command>nmap</command>（随 <systemitem>nmap</systemitem> 软件包提供）来确定协议。<command>nmap</command> 检查主机端口是否打开。例如：
  </para>

<screen><prompt>&gt; </prompt>nmap -p 35,137-139,515,631,9100-10000 <replaceable>IP.OF.THE.PRINTER</replaceable></screen>
 </sect1>
 <sect1 xml:id="sec-print-net-config-cmdl">
  <title>使用命令行工具配置 CUPS</title>

  <para>
   CUPS 可使用 <command>lpinfo</command>、<command>lpadmin</command> 和 <command>lpoptions</command> 之类的命令行工具配置。您需要一个包含一个后端（例如 USB）和多个参数的设备 URI。要确定系统上的有效设备 URI，请使用命令 <command>lpinfo -v | grep &quot;:/&quot;</command>：
  </para>

<screen><prompt>&gt; </prompt><command>sudo</command> lpinfo -v | grep ":/"
direct usb://ACME/FunPrinter%20XL
network socket://192.168.2.253</screen>

  <para>
   使用 <command>lpadmin</command>，CUPS 服务器管理员可以添加、删除或管理打印队列。要添加打印队列，请使用以下语法：
  </para>

<screen><prompt>&gt; </prompt><command>sudo</command> lpadmin -p <replaceable>QUEUE</replaceable> -v <replaceable>DEVICE-URI</replaceable> -P <replaceable>PPD-FILE</replaceable> -E</screen>

  <para>
   设备 (<option>-v</option>) 便会用作 <replaceable>QUEUE</replaceable> (<option>-p</option>)，并使用指定的 PPD 文件 (<option>-P</option>)。这意味着如果要手动配置打印机，则必须了解 PPD 文件和设备 URI。
  </para>

  <para>
   不要使用 <option>-E</option> 作为第一个选项。对于所有 CUPS 命令，将 <option>-E</option> 用作第一个参数设置使用加密连接。要启用打印机，必须使用 <option>-E</option>，如下面的示例所示：
  </para>

<screen><prompt>&gt; </prompt><command>sudo</command> lpadmin -p ps -v usb://ACME/FunPrinter%20XL -P \
/usr/share/cups/model/Postscript.ppd.gz -E</screen>

  <para>
   以下示例配置了网络打印机：
  </para>

<screen><prompt>&gt; </prompt><command>sudo</command> lpadmin -p ps -v socket://192.168.2.202:9100/ -P \
/usr/share/cups/model/Postscript-level1.ppd.gz -E</screen>

  <para>
   有关 <command>lpadmin</command> 的更多选项，请参考 <systemitem>lpadmin(8)</systemitem> 的手册页。
  </para>

  <para>
   在系统安装期间，某些选项被设置为默认值。可以为每个打印任务修改这些选项（根据所使用的打印工具）。也可以使用 YaST 来更改这些默认选项。使用命令行工具设置默认选项，如下所示：
  </para>

  <procedure>
   <step>
    <para>
     首先，列出所有选项：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> lpoptions -p <replaceable>QUEUE</replaceable> -l</screen>
    <para>
     示例：
    </para>
<screen>Resolution/Output Resolution: 150dpi *300dpi 600dpi</screen>
    <para>
     激活的默认选项通过加星号前缀 (<literal>*</literal>) 进行标识。
    </para>
   </step>
   <step>
    <para>
     使用 <command>lpadmin</command> 更改选项：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> lpadmin -p <replaceable>QUEUE</replaceable> -o Resolution=600dpi</screen>
   </step>
   <step>
    <para>
     检查新设置：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> lpoptions -p <replaceable>QUEUE</replaceable> -l

Resolution/Output Resolution: 150dpi 300dpi *600dpi</screen>
   </step>
  </procedure>

  <para>
   普通用户运行 <command>lpoptions</command> 时，设置将写到 <filename>~/.cups/lpoptions</filename>。但是，<systemitem class="username">root</systemitem> 设置将写入 <filename>/etc/cups/lpoptions</filename>。
  </para>
 </sect1>
 <sect1 xml:id="sec-print-appl-commandline">
  <title>从命令行打印</title>

  <para>
   要从命令行打印，请输入 <command>lp -d</command>
   <replaceable>QUEUENAME</replaceable> <replaceable>FILENAME</replaceable>，并用相应的名称替换 <replaceable>QUEUENAME</replaceable> 和 <replaceable>FILENAME</replaceable>。
  </para>

  <para>
   有些应用程序依赖于 <command>lp</command> 命令来进行打印。在这种情况下，请在应用程序的打印对话框中输入正确的命令（通常无需指定 <replaceable>FILENAME</replaceable>），例如 <command>lp -d </command> <replaceable>QUEUENAME</replaceable>。
  </para>
 </sect1>
 <sect1 xml:id="sec-print-special">
  <title><phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 中的特殊功能</title>

  <para>
   某些 CUPS 功能已针对 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 做出调整。这里将介绍一些最重要的更改。
  </para>

  <sect2 xml:id="sec-print-special-cupsfire">
   <title>CUPS 和防火墙</title>
   <para>
    完成 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 的默认安装后，<systemitem class="daemon">firewalld</systemitem> 将处于活动状态，并且网络接口配置为位于 <literal>public</literal> 区域中，这会阻止传入通讯。 
</para>
   <para>
       当 <systemitem class="daemon">firewalld</systemitem> 处于活动状态时，您可能需要将 firewalld 配置为允许客户端浏览网络打印机，方法是允许 <literal>mdns</literal> 和 <literal>ipp</literal> 通过内部网络区域。公共区域应该永不公开打印机队列。 
   </para>
   <para>
    （<xref linkend="sec-security-firewall-firewalld"/>中和 <link xlink:href="https://en.opensuse.org/SDB:CUPS_and_SANE_Firewall_settings"/> 上提供了有关 <systemitem class="daemon">firewalld</systemitem> 配置的详细信息。）
   </para>
   <sect3 xml:id="sec-print-special-cupsfire-client">
    <title>CUPS 客户端</title>
    <para>
     通常 CUPS 客户端在使用防火墙的可信网络环境中的常规工作站上运行。在这种情况下，建议将网络接口配置为在<literal>内部区域</literal>中，这样可以从网络内部访问工作站。
    </para>
   </sect3>
   <sect3 xml:id="sec-print-special-cupsfire-server">
    <title>CUPS 服务器</title>
    <para>
     如果 CUPS 服务器在受防火墙保护的可信网络环境中，则应将网络接口配置为在防火墙的<literal>内部区域</literal>中。建议不要在不可信网络环境中安装 CUPS 服务器，除非您确定该服务器受到特殊防火墙规则和 CUPS 配置中的安全设置的保护。
    </para>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-print-special-browsing">
   <title>浏览网络打印机</title>
   <para>
    CUPS 服务器会定期在网络上公告共享打印机的可用性及状态信息。客户端可以访问此信息，以便在打印对话框中显示可用打印机列表。此过程称为<quote>浏览</quote>。
   </para>
   <para>
    CUPS 服务器通过传统的 CUPS 浏览协议或 Bonjour/DNS-SD 在网络上通告它们的打印队列。为了能够浏览网络打印队列，需要在通过 CUPS 服务器打印的所有客户端上运行 <systemitem class="daemon">cups-browsed</systemitem> 服务。默认情况下，<systemitem class="daemon">cups-browsed</systemitem> 不会启动。要为活动会话启动它，请使用 <command>sudo systemctl start cups-browsed</command>。要确保它在系统引导后自动启动，请在所有客户端上使用 <command>sudo systemctl enable cups-browsed</command> 启用它。
   </para>
   <para>
    如果在启动 <systemitem class="daemon">cups-browsed</systemitem> 之后浏览不起作用，则表明 CUPS 服务器可能是通过 Bonjour/DNS-SD 通告网络打印队列的。在此情况下，您需要另外安装 <systemitem class="resource">avahi</systemitem> 软件包，并在所有客户端上使用 <command>sudo systemctl start avahi-daemon</command> 启动关联的服务。
   </para>
   <para>
       有关如何通过 <systemitem class="daemon">firewalld</systemitem> 允许浏览打印机的信息，请参见<xref linkend="sec-print-special-cupsfire"/>。
   </para>
  </sect2>

  <sect2 xml:id="sec-print-special-ppd">
   <title>各个软件包中的 PPD 文件</title>
   <para>
    YaST 打印机配置使用 <filename>/usr/share/cups/model</filename> 中安装的 PPD 文件为 CUPS 设置队列。为查找适用于打印机型号的 PPD 文件，YaST 将对照硬件检测过程中确定的供应商和型号比较所有 PPD 文件中的供应商和型号。为此，YaST 打印机配置根据从 PPD 文件抽取的供应商和型号信息生成一个数据库。
   </para>
   <para>
    仅使用 PPD 文件而不使用其他信息源的配置的优点在于可以随意修改 <filename>/usr/share/cups/model/</filename> 中的 PPD 文件。例如，如果您有 PostScript 打印机，可直接将 PPD 文件复制到 <filename>/usr/share/cups/model</filename>（如果这些文件尚不存在于 <systemitem>manufacturer-PPDs</systemitem> 或 <systemitem>OpenPrintingPPDs-postscript</systemitem> 软件包中），以实现打印机最佳配置。
   </para>
   <para>
    其他 PPD 文件由下列软件包提供：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      <systemitem>gutenprint</systemitem>：Gutenprint 驱动程序及其匹配的 PPD
     </para>
    </listitem>
    <listitem>
     <para>
      <systemitem>splix</systemitem>：SpliX 驱动程序及其匹配的 PPD
     </para>
    </listitem>
    <listitem>
     <para>
      <systemitem>OpenPrintingPPDs-ghostscript</systemitem>：Ghostscript 内置驱动程序的 PPD
     </para>
    </listitem>
    <listitem>
     <para>
      <systemitem>OpenPrintingPPDs-hpijs</systemitem>：适用于非 HP 打印机的 HPIJS 驱动程序的 PPD
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-print-prob">
  <title>查错</title>

  <para>
   下面几节介绍一些最常遇到的打印机硬件和软件问题以及解决或避免这些问题的方法。讨论的主题有 GDI 打印机、PPD 文件和端口配置。另外还讨论常见网络打印机问题、打印件问题以及队列处理。
  </para>

  <sect2 xml:id="sec-print-gdi">
   <title>不支持标准打印机语言的打印机</title>
   <para>
    这些打印机不支持任何常见的打印机语言，只能使用专门的专有控制系列来进行寻址。因此这些打印机只能用于制造商提供了驱动程序的操作系统版本。GDI 是 Microsoft* 为图形设备开发的编程接口。通常制造商只提供 Windows 的驱动程序，而因为 Windows 驱动程序使用 GDI 界面，所以这些打印机也称作 <emphasis>GDI 打印机</emphasis>。问题实际并不是出在编程接口上，而是因这些打印机只能通过相应打印机型号的专用打印机语言来寻址所造成。
   </para>
   <para>
    某些 GDI 打印机可切换成以 GDI 方式或一种标准打印机语言进行操作。请参见打印机手册以了解这是否可行。有些型号需要有专门的 Windows 软件来进行切换（注：Windows 打印机驱动程序在通过 Windows 进行打印时可能总是将打印机切换回 GDI 模式）。对于其他 GDI 打印机，还有针对标准打印机语言的扩展模块。
   </para>
   <para>
    某些制造商为他们的打印机提供专有驱动程序。专有打印机驱动程序的缺点在于不能保证这些驱动程序可用于已安装的打印系统，也不能保证它们适合各种硬件平台。相反，支持标准打印机语言的打印机不依赖于特殊的打印系统版本或特殊的硬件平台。
   </para>
   <para>
    与其花时间尝试使专有 Linux 驱动程序运行，购买支持标准打印机语言（最好是 PostScript）的打印机可能更经济高效。这可以一次性彻底解决驱动程序问题，您不再需要安装并配置特殊驱动程序软件，以及获取由于打印系统中开发的新功能而必须安装的驱动程序更新。
   </para>
  </sect2>

  <sect2 xml:id="sec-print-prob-ppd">
   <title>没有合适的 PPD 文件可用于 PostScript 打印机</title>
   <para>
    如果 <systemitem>manufacturer-PPDs</systemitem> 或<systemitem>OpenPrintingPPDs-postscript</systemitem> 软件包不包含适用于 PostScript 打印机的 PPD 文件，则可以使用打印机制造商提供的驱动程序 CD 上的 PPD 文件，或从打印机制造商网页下载合适的 PPD 文件。
   </para>
   <para>
    如果以 zip 存档 (.zip) 或自解压缩 zip 存档 (<filename>.exe</filename>) 的形式提供 PPD 文件，则用 <command>unzip</command> 命令将其解包。首先，查看 PPD 文件的许可证协议条款。然后使用 <command>cupstestppd</command> 实用程序来确认 PPD 文件是否与<quote> Adobe PostScript 打印机描述文件格式规范 V4.3</quote> 相符合，如果实用程序返回 <quote>FAIL，</quote>则描述 PPD 文件中的错误很严重，可能导致重大问题。应该解决 <command>cupstestppd</command> 报告的问题点。如果需要，询问打印机制造商是否提供合适的 PPD 文件。
   </para>
  </sect2>

  <sect2 xml:id="sec-print-prob-netconnect">
   <title>网络打印机连接</title>
   <para/>
   <variablelist>
    <varlistentry>
     <term>确定网络问题</term>
     <listitem>
      <para>
       将打印机直接连接到计算机。出于测试目的，将该打印机配置为本地打印机。如果打印机可以工作，则问题与网络有关。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>检查 TCP/IP 网络</term>
     <listitem>
      <para>
       TCP/IP 网络和名称解析必须可以正常工作。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>检查远程 <command>lpd</command>
     </term>
     <listitem>
      <para>
       使用以下命令测试是否可以与 <replaceable>Host</replaceable> 上的 <literal>lpd</literal>（端口 <command>515</command>）建立 TCP 连接：
      </para>
<screen><prompt>&gt; </prompt>netcat -z <replaceable>HOST</replaceable> 515 &amp;&amp; echo ok || echo failed</screen>
      <para>
       如果不能建立与 <command>lpd</command> 的连接，则 <command>lpd</command> 可能不处于活动状态或可能存在基本网络问题。
      </para>
      <para>
       如果相应的 <command>lpd</command> 处于活动状态并且主机接受查询，请以 <systemitem class="username">root</systemitem> 身份运行以下命令，以查询远程 <replaceable>HOST</replaceable> 上 <replaceable>QUEUE</replaceable> 的状态报告：
      </para>
<screen><prompt role="root"># </prompt>echo -e "\004queue" \
| netcat -w 2 -p 722 <replaceable>HOST</replaceable> 515</screen>
      <para>
       如果 <command>lpd</command> 不响应，则它可能不处于活动状态或可能存在基本网络问题。如果 <command>lpd</command> 响应，响应应该描述为什么在<literal>主机</literal>的<literal>队列</literal> 上不能进行打印。如果您接收到类似<xref linkend="aus-d-lpd"/> 中的响应，则问题是由远程 <command>lpd</command> 引起的。
      </para>
      <example xml:id="aus-d-lpd">
       <title>来自 <command>lpd</command> 的错误消息</title>
<screen>lpd: your host does not have line printer access
lpd: queue does not exist
printer: spooling disabled
printer: printing disabled</screen>
      </example>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>检查远程 <command>cupsd</command>
     </term>
     <listitem>
      <para>
       CUPS 网络服务器可以在 UDP 端口 <literal>631</literal> 上广播其队列，默认每 30 秒广播一次。因此，以下命令可用于测试网络中是否存在广播 CUPS 网络服务器。执行此命令之前，务必停止本地 CUPS 守护程序。
      </para>
<screen><prompt>&gt; </prompt>netcat -u -l -p 631 &amp; PID=$! ; sleep 40 ; kill $PID</screen>
      <para>
       如果广播 CUPS 网络服务器存在，则输出如<xref linkend="aus-d-bcast"/> 所示。
      </para>
      <example xml:id="aus-d-bcast">
       <title>来自 CUPS 网络服务器的广播</title>
<screen>ipp://192.168.2.202:631/printers/queue</screen>
      </example>
      <para arch="zseries" os="sles">
       请注意，IBM Z 以太网设备默认不接收广播。
      </para>
      <para>
       以下命令可用于测试是否可以与 <replaceable>HOST</replaceable> 上的 <command>cupsd</command>（端口 <literal>631</literal>）建立 TCP 连接：
      </para>
<screen><prompt>&gt; </prompt>netcat -z <replaceable>HOST</replaceable> 631 &amp;&amp; echo ok || echo failed</screen>
      <para>
       如果不能建立与 <command>cupsd</command> 的连接，则 <command>cupsd</command> 可能不处于活动状态或可能存在基本网络问题。<command>lpstat -h</command> <replaceable>HOST</replaceable> -l -t 会返回 <replaceable>HOST</replaceable> 上所有队列的状态报告（可能非常长），前提是相应的 <command>cupsd</command> 处于活动状态并且主机接受查询。
      </para>
      <para>
       下面的命令可用于测试 <replaceable>HOST</replaceable> 上的 <replaceable>QUEUE</replaceable> 是否接受由单个回车字符组成的打印作业。不应打印任何内容。可能会弹出一页空白纸。
      </para>
<screen><prompt>&gt; </prompt>echo -en "\r" \
| lp -d queue -h <replaceable>HOST</replaceable></screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>
      对网络打印机或打印服务器计算机进行查错
     </term>
     <listitem>
      <para>
       有时，当在打印服务器计算机中运行的假脱机程序需要处理多个打印作业时会产生问题。这是打印服务器计算机中的假脱机程序导致的，目前尚无解决此问题的方法。变通方法是，直接通过 TCP 套接字对连接到打印服务器计算机的打印机进行寻址，来绕过打印服务器计算机中的假脱机程序。请参见<xref linkend="sec-print-net"/>。
      </para>
      <para>
       这样，打印服务器计算机仅充当各种不同数据传送方式之间（TCP/IP 网络和本地打印机连接）的转换器。要使用此方法，您需要知道打印服务器计算机上的 TCP 端口。如果打印机连接到打印服务器计算机并且已启动，则通常可以在打开打印服务器计算机电源一段时间后使用 <command>nmap</command> 软件包中的 <systemitem>nmap</systemitem> 实用程序确定此 TCP 端口。例如，<command>nmap </command> <replaceable> IP-address</replaceable> 可能会返回打印服务器计算机的以下输出：
      </para>
<screen>Port       State       Service
23/tcp     open        telnet
80/tcp     open        http
515/tcp    open        printer
631/tcp    open        cups
9100/tcp   open        jetdirect</screen>
      <para>
       此输出指出可以在端口 <literal>9100</literal> 上通过 TCP 套接字对连接到打印服务器计算机的打印机寻址。默认情况下，<command>nmap</command> 只检查在 <filename>/usr/share/nmap/nmap-services</filename> 中列出的一些常见的端口。要检查所有可能的端口，请使用命令 <command>nmap -p </command>
       <replaceable>FROM_PORT</replaceable>-<replaceable>TO_PORT</replaceable> <replaceable>IP_ADDRESS</replaceable>。这可能要花一些时间。有关详细信息，请参见 <command>nmap</command> 的手册页。
      </para>
      <para>
       输入如下命令
      </para>
<screen><prompt>&gt; </prompt>echo -en "\rHello\r\f" | netcat -w 1 IP-address port
cat file | netcat -w 1 IP-address port</screen>
      <para>
       将字符串或文件直接发送到相应的端口以测试是否可以在该端口上对打印机进行寻址。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec-print-prob-defective-printouts">
   <title>打印输出有缺陷但不显示错误消息</title>
   <para>
    对于打印系统，打印任务完成的标志是 CUPS 后端完成到接收方（打印机）的数据传送。如果在接收方的进一步处理失败（例如，如果打印机无法打印特定于打印机的数据），则打印系统不会对此进行通知。如果打印机无法打印特定于打印机的数据，请选择一个更适合该打印机的 PPD 文件。
   </para>
  </sect2>

  <sect2 xml:id="sec-print-prob-disabled-queues">
   <title>禁用的队列</title>
   <para>
    如果向接收方传送数据在多次尝试后都失败，则 CUPS 后端（例如 <literal>USB</literal> 或 <literal>socket</literal>）向打印系统（向 <command>cupsd</command>）报告一个错误。后端用于确定在将数据传送报告为不可行前应执行的失败尝试次数。由于继续尝试可能也是徒劳，<command>cupsd</command> 将禁用相应队列的打印。在消除了问题的起因后，系统管理员必须使用 <command>cupsenable</command> 命令重新启用打印。
   </para>
  </sect2>

  <sect2 xml:id="sec-print-prob-deleting-jobs">
   <title>CUPS 浏览：删除打印作业</title>
   <para>
    如果 CUPS 网络服务器通过浏览向客户端主机广播其队列并且客户端主机上合适的本地 <command>cupsd</command> 处于活动状态，则客户端 <command>cupsd</command> 接受来自应用程序的打印任务并将它们转发到服务器上的 <command>cupsd</command>。当服务器上的 <command>cupsd</command> 接受打印任务后，会为该任务指派一个新的任务号。因此，客户端主机上的任务号与服务器上的任务号不同。因为打印作业通常都会立即转发出去，所以不能用客户端主机上的作业号将其删除，原因是当打印作业已转发到服务器 <command>cupsd</command> 后，客户端 <command>cupsd</command> 会将打印作业视为已完成。
   </para>
   <para>
    要删除服务器上的打印作业，请使用 <command>lpstat -h cups.example.com -o</command> 之类的命令来确定服务器上的作业编号。此情况假设服务器尚未完成该打印作业（即尚未完全将它发送到打印机）。按如下方式使用获得的作业编号来删除服务器上的打印作业：
   </para>
<screen><prompt>&gt; </prompt>cancel -h cups.example.com <replaceable>QUEUE-JOBNUMBER</replaceable></screen>
  </sect2>

  <sect2 xml:id="sec-print-prob-brokenjobs">
   <title>有问题的打印作业和数据传输错误</title>
   <para>
    如果在打印过程中关闭打印机或计算机，则打印任务将保留在队列中。再次打开计算机（或打印机）后，打印将继续。必须使用 <command>cancel</command> 从队列中删除有问题的打印任务。
   </para>
   <para>
    如果打印作业损坏，或主机与打印机之间的通讯出现错误，打印机将无法正确处理数据，并会打印出很多张有乱码的纸。要修复该问题，请执行以下步骤：
   </para>
   <procedure>
    <step>
     <para>
      要停止打印，请将所有纸张从喷墨打印机中取出或打开激光打印机的纸盒。高质量的打印机具有一个用于取消当前打印件的按钮。
     </para>
    </step>
    <step>
     <para>
      打印任务可能仍在队列中，因为只有在将任务完全发送到打印机后才会将它们删除。使用 <command>lpstat -o</command> 或 <command>lpstat -h cups.example.com -o</command> 检查哪个队列当前正在打印。使用 <command>cancel</command>
      <replaceable>QUEUE</replaceable>-<replaceable>JOBNUMBER</replaceable> 或 <command>cancel -h cups.example.com</command>
      <replaceable>QUEUE</replaceable>-<replaceable>JOBNUMBER</replaceable> 删除打印作业。
     </para>
    </step>
    <step>
     <para>
      即使已将打印任务从队列中删除，某些数据仍会被传送到打印机。检查 CUPS 后端进程是否仍在为相应的队列运行并将其终止。
     </para>
    </step>
    <step>
     <para>
      通过关闭打印机一段时间完全重设置打印机。然后插入纸张并打开打印机。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec-print-prob-debugging">
   <title>调试 CUPS</title>
   <para>
    使用以下通用过程确定 CUPS 中的问题：
   </para>
   <procedure>
    <step>
     <para>
      在 <filename>/etc/cups/cupsd.conf</filename> 中设置 <command>LogLevel debug</command>。
     </para>
    </step>
    <step>
     <para>
      停止 <command>cupsd</command>。
     </para>
    </step>
    <step>
     <para>
      删除 <filename>/var/log/cups/error_log*</filename> 从而无需搜索非常长的日志文件。
     </para>
    </step>
    <step>
     <para>
      启动 <command>cupsd</command>。
     </para>
    </step>
    <step>
     <para>
      重复导致问题的操作。
     </para>
    </step>
    <step>
     <para>
      检查 <filename>/var/log/cups/error_log*</filename> 中的消息以确定问题的原因。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec-print-prob-more-information">
   <title>更多信息</title>
   <para>
    有关在 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 上执行打印操作的详细信息，请参见 openSUSE 支持数据库，网址为 <link xlink:href="https://en.opensuse.org/Portal:Printing"/>。<phrase os="sles;sled">SUSE 知识库 (<link xlink:href="https://www.suse.com/support/"/>) 中提供了对许多特定问题的解决方案。搜索 <literal>CUPS</literal> 文本找到相关文章。</phrase>
   </para>
  </sect2>
 </sect1>
</chapter>
