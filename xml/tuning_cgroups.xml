<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter
[
  <!ENTITY % entities SYSTEM "entity-decl.ent">
  %entities;
]>

<chapter xmlns="http://docbook.org/ns/docbook"
         xmlns:xi="http://www.w3.org/2001/XInclude"
         xmlns:xlink="http://www.w3.org/1999/xlink"
         version="5.0" xml:id="cha.tuning.cgroups">

 <title>Kernel Control Groups</title>
 <info>
  <abstract>
   <para>
    Kernel Control Groups (abbreviated known as <quote>cgroups</quote>) are
    a kernel feature that allows aggregating or partitioning tasks
    (processes) and all their children into hierarchical organized groups.
    These hierarchical groups can be configured to show a specialized
    behavior that helps with tuning the system to make best use of available
    hardware and network resources.
   </para>
   <para>
    In the following sections, we often reference kernel documentation
    such as <filename>/usr/src/linux/Documentation/cgroups/</filename>.
    These files are part of the <systemitem>kernel-source</systemitem>
    package.
   </para>
   <para>
    This chapter is an overview.  To use cgroups properly and to
    avoid performance implications, you must study the provided
    references.
   </para>
   <para>
    <remark>
     taroth 2017-12-14: for the sake of using the prompt entities
     (&prompt.user; or &prompt.root;) consistently in our docs:
     please do not mix several example commands within one screen
     and do not use '#' to refer to an example command - this makes
     it impossible to mark the individual commands with a proper
     prompt
    </remark>
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker>
   </dm:bugtracker>
  </dm:docmanager>
 </info>

 <sect1 xml:id="sec.tuning.cgroups.overview">
  <title>Technical Overview and Definitions</title>
  <para>
   The following terms are used in this chapter:
  </para>
  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     <quote>cgroup</quote> is another name for Control Groups.
    </para>
   </listitem>
   <listitem>
    <para>
     In a cgroup there is a set of tasks (processes) associated with a set
     of subsystems that act as parameters constituting an environment for
     the tasks.
    </para>
   </listitem>
   <listitem>
    <para>
     Subsystems provide the parameters that can be assigned and define CPU
     sets, freezer, or&mdash;more general&mdash;<quote>resource
     controllers</quote> for memory, disk I/O, network traffic, etc.
    </para>
   </listitem>
   <listitem>
    <para>
     cgroups are organized in a tree-structured hierarchy. There can be more
     than one hierarchy in the system. You use a different or alternate
     hierarchy to cope with specific situations.
    </para>
   </listitem>
   <listitem>
    <para>
     Every task running in the system is in exactly one of the cgroups in
     the hierarchy.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>

 <sect1 xml:id="sec.tuning.cgroups.usage">
  <title>Using Controller Groups</title>

  <para>
   Limitations to <literal>cgroups</literal> can be set with the
   <command>systemctl set-property</command> command. The syntax is:
  </para>
  <screen>&prompt.root;<command>systemctl set-property [--runtime] <replaceable>NAME</replaceable> <replaceable>PROPERTY1</replaceable>=<replaceable>VALUE</replaceable> [<replaceable>PROPERTY2</replaceable>=<replaceable>VALUE</replaceable>]</command></screen>
  <para>
   Optionally, use the <option>--runtime</option> option. With this
   option, limits are not persisting after the next reboot.
  </para>
  <para>
   Replace <replaceable>NAME</replaceable> with a &systemd; service
   slice, scope, socket, mount, or swap name. Replace properties with
   one or more of the following:
  </para>
  <variablelist>
   <varlistentry>
    <term><literal>CPUAccounting=</literal><option>[yes|no]</option></term>
    <listitem>
     <para>
      Turns on CPU usage accounting. This property takes
      <literal>yes</literal> and <literal>no</literal> as arguments.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>CPUQuota=</literal><replaceable>PERCENTAGE</replaceable></term>
    <listitem>
     <para>
      Assigns a CPU time to processes. The value is a percentage
      followed by a <literal>%</literal> as suffix. This requires
      <literal>CPUAccounting=yes</literal>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>MemoryAccounting=</literal><option>[yes|no]</option></term>
    <listitem>
     <para>
      Turns on memory usage accounting. This property takes
      <literal>yes</literal> and <literal>no</literal> as arguments.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>MemoryLow=</literal><replaceable>BYTES</replaceable></term>
    <listitem>
     <para>
      This requires
      <literal>MemoryAccounting=yes</literal>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>MemoryHigh=</literal><replaceable>BYTES</replaceable></term>
    <listitem>
     <para>
      If more memory above this limit is used, memory is aggressively
      taken away from the processes. This requires
      <literal>MemoryAccounting=yes</literal>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>MemoryMax=</literal><replaceable>BYTES</replaceable></term>
    <listitem>
     <para>
      Set a maximum limit for used memory. Processes will be killed if
      they use more memory than allowed. This requires
      <literal>MemoryAccounting=yes</literal>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>DeviceAllow=</literal></term>
    <listitem>
     <para>
      
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>DevicePolicy</literal></term>
    <listitem>
     <para>
      
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <para>
   For more details, see <command>man systemd.resource-control</command>.
  </para>
 </sect1>
 <sect1 xml:id="sec.tuning.cgroups.info">
  <title>For More Information</title>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     Kernel documentation (package <systemitem>kernel-source</systemitem>):
     files in <filename>/usr/src/linux/Documentation/cgroups</filename>.
    </para>
   </listitem>
   <listitem>
    <para>
     <link xlink:href="http://lwn.net/Articles/604609/"/>&mdash;Brown,
     Neil: Control Groups Series (2014, 7 parts).
    </para>
   </listitem>
   <listitem>
    <para>
     <link xlink:href="http://lwn.net/Articles/243795/"/>&mdash;Corbet,
     Jonathan: Controlling memory use in containers (2007).
    </para>
   </listitem>
   <listitem>
    <para>
     <link xlink:href="http://lwn.net/Articles/236038/"/>&mdash;Corbet,
     Jonathan: Process containers (2007).
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
