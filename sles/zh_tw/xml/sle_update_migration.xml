<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_migration.xml" version="5.0" xml:id="cha.update.spmigration">
 <title>Service Pack 移轉</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    SUSE 提供圖形與指令行工具以升級新的 Service Pack。新工具都是簡易的指令行工具，擁有直觀的圖形使用者介面，支援 Service Pack <quote>復原</quote>，而且還具備其他更多功能。本章介紹使用這些工具進行 Service Pack 移轉的逐步指南。
   </para>
  </abstract>
 </info>
 <sect1 xml:id="sec.update.migr.conceptual-overview">
  <title>概念綜覽</title>

  <para>
   SUSE 會定期發佈 SUSE Linux Enterprise 系列的新 Service Pack。為便於客戶移轉至新的 Service Pack 並最大限度減少停機時間，SUSE 支援在系統執行時進行線上移轉。
  </para>

  <para>
   從 SLE 12 SP2 開始，YaST Wagon 已被 YaST 移轉 (GUI) 與 Zypper 移轉 (指令行) 所取代。系統支援以下功能︰
  </para>

  <itemizedlist>
   <listitem>
    <para>
     在首個 RPM 更新之前，系統始終處於已定義狀態
    </para>
   </listitem>
   <listitem>
    <para>
     在首個 RPM 更新之前，可以取消操作
    </para>
   </listitem>
   <listitem>
    <para>
     若有錯誤，可以透過簡單的方式進行復原
    </para>
   </listitem>
   <listitem>
    <para>
     透過系統工具進行<quote>復原</quote>；無須備份/還原
    </para>
   </listitem>
   <listitem>
    <para>
     使用所有有效儲存庫
    </para>
   </listitem>
   <listitem>
    <para>
     能夠跳過 Service Pack
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.supported-scenarios-and-versions">
  <title>受支援軟體方案和產品版本</title>

  <para>
   SUSE 支援以下案例 (不論是線上還是離線)：
  </para>

  <variablelist>
   <varlistentry>
    <term>線上</term>
    <listitem>
     <para>
      SUSE Customer Center (SCC)、訂閱管理工具 (SMT)、SUSE Manager
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>離線</term>
    <listitem>
     <para>
      將 DVD、快閃式磁碟、ISO 影像、AutoYaST、<quote>純 RPM</quote>和協力廠商工具開機
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   支援從以下版本進行移轉︰
  </para>

  <variablelist>
   <varlistentry>
    <term>線上</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 12
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>離線</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 11 SP3/SP4、SUSE Linux Enterprise 12
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>手動/協力廠商</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 12
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec.update.migr.workflow">
  <title>Service Pack 移轉工作流程</title>

  <para>
   Service Pack 移轉可透過 YaST、<command>zypper</command> 或 AutoYaST 執行。
  </para>

  <para>
   在啟動 Service Pack 移轉之前，必須在 SUSE Customer Center 中註冊您的系統。無法使用來自 DVD 的自我建置儲存庫執行移轉。
  </para>

  <para>
   不論使用哪種方式，Service Pack 移轉都包含以下步驟：
  </para>

  <orderedlist>
   <listitem>
    <para>
     在您的註冊系統上尋找可能的移轉目標。
    </para>
   </listitem>
   <listitem>
    <para>
     選取一個移轉目標。
    </para>
   </listitem>
   <listitem>
    <para>
     申請並啟用新的儲存庫。
    </para>
   </listitem>
   <listitem>
    <para>
     執行移轉。
    </para>
   </listitem>
  </orderedlist>



  <para>
   移轉目標清單取決於您已安裝和註冊的產品。如果您安裝的延伸沒有新的 SP 可用，則無法向您提供移轉目標。
  </para>

  <para>
   您的主機可用的移轉目標清單將始終可從 SUSE Customer Center 取回，並取決於所安裝的產品或延伸。
  </para>
 </sect1>
 <sect1 xml:id="sec.update.migr.cancel.spm">
  <title>取消 Service Pack 移轉</title>

  <para>
   只能在移轉過程中的特定階段取消 Service Pack 移轉︰
  </para>

  <orderedlist>
   <listitem>
    <para>
     在套件升級開始之前，僅對系統進行極少量的變更，例如針對服務和儲存庫的變更。還原 <filename>/etc/zypp/repos.d/*</filename> 以回復到先前的狀態。
    </para>
   </listitem>
   <listitem>
    <para>
     套件升級開始後，您可以透過使用 Snapper 快照回復到先前的狀態 (請參閱<xref linkend="cha.snapper"/>)。
    </para>
   </listitem>
   <listitem>
    <para>
     選取移轉目標後，SUSE Customer Center 會變更儲存庫資料。若要手動回復此狀態，請使用 <command>SUSEConnect</command> <option>--rollback</option>。
    </para>
   </listitem>
  </orderedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.yast.onlinemigr">
  <title>使用線上移轉工具 (YaST) 進行移轉</title>

  <para>
   若要透過 Yast 執行 Service Pack 移轉，請使用<guimenu>線上移轉</guimenu>工具。依預設，YaST 不會從協力廠商儲存庫安裝任何套件。如果某套件是從協力廠商儲存庫安裝的，YaST 會阻止該套件取代為來自 SUSE 的相同套件。
  </para>

  <note>
   <title>減少安裝大小</title>
   <para>
    執行 SP 移轉時，YaST 會安裝所有建議的套件。特別是在自訂精簡安裝的情況下，這樣會顯著增加系統的安裝大小。
   </para>
   <para>
    若要變更此預設行為並且僅允許安裝所需套件，請調整 <filename>/etc/zypp/zypp.conf</filename> 並設定以下變數︰
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   這會變更所有套件操作的行為，例如安裝修補程式或新套件。
  </para>

  <para>
   若要啟動 Service Pack 移轉，請執行以下操作︰
  </para>

  <procedure xml:id="pro.update.migr.yast">
   <step>
    <para>
     執行 YaST 線上更新以取得系統的最新套件更新。
    </para>
   </step>
   <step>
    <para>
     安裝套件 
     <package>yast2-migration</package>
     及其相依項 (位於 YaST 中的<menuchoice><guimenu>軟體</guimenu> <guimenu>軟體管理</guimenu></menuchoice>下面)。
    </para>
   </step>
   <step>
    <para>
     重新啟動 YaST；如果不重新啟動，新安裝的模組將不會顯示在控制中心中。
    </para>
   </step>
   <step>
    <para>
     在 YaST <menuchoice><guimenu>系統</guimenu> <guimenu>線上移轉</guimenu></menuchoice>中啟動。YaST 將顯示可能的移轉目標和摘要。如果您的系統有多個可用的移轉目標，請從清單中選取一個。
    </para>
   </step>
   <step>
    <para>
     從清單中選取一個移轉目標，然後按一下<guimenu>下一步</guimenu>繼續操作。
    </para>
   </step>
   <step>
    <para>
     若移轉工具提供更新儲存庫，則建議您按一下<guimenu>是</guimenu>繼續操作。
    </para>
   </step>
   <step>
    <para>
     <remark>toms 2015-09-09: FATE#319140</remark>如果「線上移轉」工具找到來自 DVD 或本地伺服器的過時儲存庫，強烈建議您將其停用。過時的儲存庫來自先前的 SP。任何來自 SCC 或 SMT 的舊儲存庫會自動移除。
    </para>
   </step>
   <step>
    <para>
     按<guimenu>下一步</guimenu>，查看摘要並繼續移轉過程。確認<guimenu>開始更新</guimenu>。
    </para>
    <remark>toms 2016-07-13: What to do in case of problems?</remark>
   </step>
   <step>
    <para>
     成功移轉後，請重新啟動系統。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.zypper.onlinemigr">
  <title>使用 Zypper 移轉</title>

  <para>
   若要使用 Zypper 執行 Service Pack 移轉，請使用指令行工具 <command>zypper</command> <option>migration</option>。
  </para>

  <note>
   <title>減少安裝大小</title>
   <para>
    執行 SP 移轉時，YaST 會安裝所有建議的套件。特別是在自訂精簡安裝的情況下，這樣會顯著增加系統的安裝大小。
   </para>
   <para>
    若要變更此預設行為並且僅允許安裝所需套件，請調整 <filename>/etc/zypp/zypp.conf</filename> 並設定以下變數︰
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   這會變更所有套件操作的行為，例如安裝修補程式或新套件。若要變更一次調用的 Zypper 行為，請將 <option>--no-recommends</option> 參數新增至指令行。
  </para>

  <para>
   若要啟動 Service Pack 移轉，請執行以下操作︰
  </para>

  <procedure xml:id="pro.update.migr.zypper">
   <step>
    <para>
     若尚未註冊 SUSE Linux Enterprise 機器，請先進行註冊︰
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --regcode <replaceable>YOUR_REGISTRATION_CODE</replaceable></screen>
   </step>
   <step>
    <para>
     安裝最新的更新︰
    </para>
<screen><prompt>root # </prompt><command>zypper</command> patch</screen>
   </step>
   <step>
    <para>
     安裝套件
     <package>zypper-migration-plugin</package>
     及其相依項︰
    </para>
<screen><prompt>root # </prompt><command>zypper</command> migration</screen>
   </step>
   <step>
    <para>
     執行 <command>zypper</command> <option>migration</option>︰
    </para>
<screen><prompt>root # </prompt><command>zypper</command> migration
Executing 'zypper  patch-check'

Refreshing service 'SUSE_Linux_Enterprise_Server_12_x86_64'.
Loading repository data...
Reading installed packages...
0 patches needed (0 security patches)

Available migrations:

    1 | SUSE Linux Enterprise Server 12 SP1 x86_64
    2 | SUSE Linux Enterprise Server 12 SP2 x86_64</screen>
    <para>
     有關移除過程的一些說明︰
    </para>
    <itemizedlist>
     <listitem>
      <para>
       如果您的系統有多個可用的移轉目標，Zypper 允許您從清單中選取一個 SP。這與跳過一個或多個 SP 相同。請記住，基本產品 (SLES、SLED) 的線上移轉僅在主要版本的 SP 之間才仍然可用。
      </para>
     </listitem>
     <listitem>
      <para>
       依預設，Zypper 會使用 <option>--no-allow-vendor-change</option> 選項，以傳送到 <command>zypper</command> <option>dup</option>。如果某套件是從協力廠商儲存庫安裝的，此選項會阻止該套件取代為來自 SUSE 的相同套件。
      </para>
     </listitem>
     <listitem>
      <para>
       <remark>toms 2015-09-09: FATE#319140</remark>如果 Zypper 找到來自 DVD 或本地伺服器的過時儲存庫，強烈建議您將其停用。舊的 SCC 或 SMT 儲存庫會自動移除。
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     檢閱所有變更，特別是即將移除的套件。輸入 <literal>y</literal> (要升級之套件的確切數量因系統而異) 繼續：
    </para>
<screen>266 packages to upgrade, 54 to downgrade, 17 new, 8 to reinstall, 5 to remove, 1 to change arch.
Overall download size: 285.1 MiB. Already cached: 0 B  After the operation, additional 139.8 MiB will be used.
Continue? [y/n/? shows all options] (y):</screen>
    <para>
     使用 <keycombo> <keycap function="shift"/> <keycap function="pageup"/> </keycombo> 或 <keycombo> <keycap function="shift"/> <keycap function="pagedown"/> </keycombo> 鍵在外圍程序中捲動。
    </para>
   </step>
   <step>
    <para>
     成功移轉後，請重新啟動系統。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.plainzypper.onlinemigr">
  <title>使用純 Zypper 進行移轉</title>

  <para>
   若您無法使用 YaST 移轉或 Zypper 移轉，仍然可以藉由純 Zypper 和一些手動互動進行移轉。若要啟動 Service Pack 移轉，請執行以下操作︰
  </para>

  <procedure>
   <step>
    <para>
     更新套件管理工具和 SUSE Linux Enterprise 舊儲存庫︰
    </para>
<screen><prompt>root # </prompt><command>zypper</command> patch--updatestack-only</screen>
   </step>
   <step>
    <para>
     若系統已註冊，則需要取消註冊︰
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --de-register</screen>
   </step>
   <step>
    <para>
     移除舊的安裝來源和儲存庫，並對協力廠商儲存庫進行調整。
    </para>
   </step>
   <step>
    <para>
     新增新的安裝來源 (本地或遠端來源均可，如需預留位置<replaceable>儲存庫</replaceable>的資訊，請參閱<xref linkend="tab.update.nmm.repositories.sp2"/>)︰
    </para>
<screen><prompt>root # </prompt><command>zypper</command> addrepo <replaceable>REPOSITORY</replaceable></screen>
    <para>
     您也可以使用 SUSE Customer Center 或訂閱管理工具。適用於 x86-64 上的 SUSE Linux Enterprise 12 SP1 的指令為︰
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> -p SLES/12.2/x86_64 <replaceable>OPTIONS</replaceable></screen>
    <para>
     請注意，系統不支援跨架構升級。
    </para>
   </step>
   <step>
    <para>
     完成移轉︰
    </para>
<screen><prompt>root # </prompt><command>zypper</command> ref -f -s
<prompt>root # </prompt><command>zypper</command> dup --no-allow-vendor-change --no-recommends</screen>
    <para>
     第一個指令將更新所有服務和儲存庫。第二個指令將執行套裝作業系統更新。此處的最後兩個選項十分重要︰<option>-no-allow-vendor-change</option> 可確保協力廠商 RPM 將不會覆寫基礎系統中的 RPM。<option>--no-recommends</option> 選項可確保在起始安裝期間取消選取的套件不會再次新增。
    </para>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec.update.migr.ownscripts.onlinemigr">
  <title>手動移轉</title>
  <remark>toms 2016-07-13: Is this supported?</remark>
  <para>
   手動移轉或使用自己的程序檔需要更深入地瞭解您的系統元件。因此，以下程序僅推薦給專家。
  </para>

  <para>
   若要手動移轉系統，請執行以下操作︰
  </para>

  <procedure>
   <step>
    <para>
     準備系統：
    </para>
    <substeps>
     <step>
      <para>
       從 SCC 取消註冊目前的系統︰
      </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --de-register</screen>
     </step>
     <step>
      <para>
       停用來自 DVD 的舊安裝來源。例如，檢查 <filename>/etc/zypp/repos.d/SLES12-12-0.repo</filename>。
      </para>
     </step>
     <step>
      <para>
       尋找任何協力廠商儲存庫並調整 URL。
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     決定是要新增本地儲存庫還是透過 SUSE Customer Center 新增遠端儲存庫︰
    </para>
    <variablelist>
     <varlistentry>
      <term>透過 SCC 的遠端安裝來源</term>
      <listitem>
       <para>
        透過線上通道新增新的安裝來源︰
       </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> -p SLES/12.2/x86_64 -r <replaceable>CODE</replaceable> -e <replaceable>EMAIL</replaceable></screen>
       <para>
        檢查系統是否已正確註冊︰
       </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --status</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>本地安裝來源</term>
      <listitem>
       <para>
        新增本地安裝來源:
       </para>
<screen><prompt>root # </prompt><command>zypper</command> ar -f http://example.com/media/SLES12SP2/
<prompt>root # </prompt><command>zypper</command> ar dvd:///?devices=/dev/sr0 SLES12SP2</screen>
      </listitem>
     </varlistentry>
    </variablelist>
   </step>
   <step>
    <para>
     重新整理所有儲存庫︰
    </para>
<screen><prompt>root # </prompt><command>zypper</command> --releasever 12.2 ref -f -s</screen>
   </step>
   <step>
    <para>
     使用 <command>zypper dup</command> 執行套裝作業系統升級︰
    </para>
<screen><prompt>root # </prompt><command>zypper</command> --releasever 12.2 dup --no-allow-vendor-change --recommends</screen>
   </step>
   <step>
    <para>
     若尚未註冊系統，請先進行註冊。
    </para>
   </step>
   <step>
    <para>
     檢查系統是否已正確註冊︰
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --status</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.rollback">
  <title>復原 Service Pack</title>

  <para>
   若 Service Pack 不適用於您，SUSE Linux Enterprise 支援在啟動 Service Pack 移轉之前將其回復到先前的狀態。
  </para>

  <procedure xml:id="pro.update.migr.rollback">
   <step>
    <para>
     取得所有 Snapper 快照的清單︰
    </para>
    <screen><prompt>root # </prompt><command>snapper</command> list</screen>
    <para>
     檢閱其輸出，並為下一步操作選擇一個數字。如需有關 Snapper 的詳細資料，請參閱<xref linkend="cha.snapper"/>。
    </para>
   </step>
   <step>
    <para>
     選取要復原的 Snapper 快照。提供上一步的數字︰
    </para>
<screen><prompt>root # </prompt><command>snapper</command> rollback <replaceable>NUMBER</replaceable></screen>
   </step>
   <step>
    <para>
     還原開機載入程式 (如需詳細資料，請參閱<xref linkend="cha.grub2"/>)︰
    </para>
<screen><prompt>root # </prompt><command>grub2</command> boot menu</screen>
    <para>
     在開機期間，會自動重設註冊。
    </para>
   </step>
   <step>
    <para>
     檢查系統是否已正確註冊 (另請參閱<xref linkend="sec.update.registersystem"/>，以瞭解其他資訊)︰
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --status</screen>
   </step>
   <step>
    <para>
     修復註冊 (如果需要)︰
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --rollback</screen>
   </step>
  </procedure>
 </sect1>
</chapter>
