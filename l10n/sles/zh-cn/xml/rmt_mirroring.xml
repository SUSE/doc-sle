<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="rmt_mirroring.xml" version="5.0" xml:id="cha-rmt-mirroring">

 <title>在 RMT 服务器上镜像软件源</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <para>
  您可以在 RMT 服务器上镜像安装和更新软件源。这样便无需在每台计算机上下载更新，从而节省时间和带宽。
 </para>
 <para>
  在使用默认配置的情况下，RMT 每晚会自动镜像已启用的产品软件源一次。
 </para>
 <para>
  镜像的软件源默认储存于 <filename>/var/lib/rmt/public/repo</filename> 中。
 </para>
 <note>
  <title>更改镜像软件源的默认位置</title>
  <para>
   要更改镜像软件源的默认位置，请将 <filename>/usr/share/rmt/public/repo</filename> 符号链接指向所需的目录。这可以使用   命令来执行。
  </para>
  <para>
   <command>ln -sfn <replaceable>TARGET</replaceable> /usr/share/rmt/public/repo</command>
  </para>
  <para>
   （请将 <literal>TARGET</literal> 替换为所需的目标）。确保该目标具有 <literal>rmt</literal> 用户和 <literal>nginx</literal> 组的读写权限。
  </para>
 </note>
 <para>
  当启用的软件源完全镜像后，您可以通过在客户端计算机上运行 <command>SUSEConnect --url https://<replaceable>RMT_HOSTNAME</replaceable></command> 来向 RMT 注册您的客户端系统。成功注册后，客户端计算机上的 Zypper 将使用来自 RMT 服务器的软件源。
 </para>
 <important>
  <title>SUSE Linux Enterprise Server 11 客户端</title>
  <para>
   RMT 不支持使用 SUSE Linux Enterprise Server 11 及以下版本的客户端。
  </para>
 </important>
 <sect1 xml:id="sec-rmt-mirroring-credentials">
  <title>镜像身份凭证</title>

  <para>
   在创建 SUSE Linux Enterprise 软件源的本地镜像之前，您需要具有相应的组织身份凭证。您可以从 SUSE Customer Center 获取身份凭证。
  </para>

  <para>
   要从 SUSE Customer Center 获取身份凭证，请执行以下步骤：
  </para>

  <procedure>
   <step>
    <para>
     访问 SUSE Customer Center (<link xlink:href="http://scc.suse.com"/>) 并登录。
    </para>
   </step>
   <step>
    <para>
     如果您是多个组织的成员，请从左侧边栏中选择要使用的组织。
    </para>
   </step>
   <step>
    <para>
     从顶部菜单中选择<guimenu>代理</guimenu>。
    </para>
   </step>
   <step>
    <para>
     右上角即会显示身份凭证。
    </para>
   </step>
   <step>
    <para>
     要查看该口令，请单击 <inlinemediaobject>
     <textobject role="description"><phrase>眼睛图标</phrase>
     </textobject>
     <imageobject role="fo">
      <imagedata fileref="scc_eye_icon.png" width="0.8em" format="SVG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="scc_eye_icon.png" width="1em" format="PNG"/>
     </imageobject>
     </inlinemediaobject> 图标。
    </para>
   </step>
  </procedure>

  <para>
   应当使用 YaST RMT 服务器配置模块对获取的身份凭证进行设置，或将其直接添加到 <filename>/etc/rmt.conf</filename> 文件中。有关 <filename>/etc/rmt.conf</filename> 文件的详细信息，请参见<xref linkend="sec-rmt-config-rmtconf"/>。
  </para>
 </sect1>
 <sect1 xml:id="sec-rmt-mirroring-synchronization">
  <title>同步软件源元数据</title>

  <para>
   需要使用从 SUSE Customer Center 下载的信息定期更新本地 RMT 数据库。其中包括有关可用产品和软件源的信息。
  </para>

  <para>
   同步通过 <systemitem class="daemon">systemd</systemitem> 计时器 <literal>rmt-server-sync.timer</literal> 来完成。要查看状态（例如下次运行时间），请使用 <command>systemctl status</command>：
  </para>

<screen><prompt role="root"># </prompt><command>systemctl status rmt-server-sync.timer</command>
● rmt-server-sync.timer - RMT Sync timer
   Loaded: loaded (/usr/lib/systemd/system/rmt-server-sync.timer; enabled; vendor preset: disabled)
   Active: active (waiting) since Fri 2018-06-22 04:22:34 EDT; 2h 34min ago
  Trigger: Sat 2018-06-23 03:53:00 EDT; 20h left

Jun 22 04:22:34 d31 systemd[1]: Started RMT Sync timer.</screen>

  <para>
   要手动更新 RMT 数据库，请使用 <command>rmt-cli sync</command> 命令。有关详细信息，请参见<xref linkend="sec-rmt-tools-rmt-cli-sync"/>。
  </para>
 </sect1>
 <sect1 xml:id="sec-rmt-mirroring-mirroring">
  <title>镜像软件包</title>

  <para>
   RMT 服务器上会镜像所启用的软件源的软件包。系统会每天定期下载一次软件包。不过，您也可以随时手动触发下载。
  </para>

  <para>
   定期镜像由 <systemitem class="daemon">systemd</systemitem> 计时器 <literal>rmt-server-mirror.timer</literal> 执行。要显示状态（例如下次运行时间），请使用 <command>systemctl status</command>：
  </para>

<screen><prompt role="root"># </prompt><command>systemctl status rmt-server-mirror.timer</command>
● rmt-server-mirror.timer - RMT Mirror timer
   Loaded: loaded (/usr/lib/systemd/system/rmt-server-mirror.timer; enabled; vendor preset: disabled)
   Active: active (waiting) since Fri 2018-06-22 04:22:34 EDT; 2h 34min ago
  Trigger: Sat 2018-06-23 02:17:57 EDT; 19h left

Jun 22 04:22:34 d31 systemd[1]: Started RMT Mirror timer.</screen>

  <para>
   要手动更新镜像的软件包，请使用 <command>rmt-cli mirror</command> 命令。有关详细信息，请参见<xref linkend="sec-rmt-tools-rmt-cli-mirror"/>。
  </para>
 </sect1>
 <sect1 xml:id="sec-rmt-mirroring-enable-disable">
  <title>启用和禁用软件源镜像</title>

  <para>
   可以单独启用或禁用软件源镜像，也可以按产品来启用或禁用。一次可以指定一个或多个软件源或产品。如果软件源处于启用状态，系统会在镜像过程中下载并更新其软件包。要启用或禁用软件源镜像，您需要提供产品字符串或 ID 或者软件源名称或 ID。一般情况下，您会想要启用或禁用产品，因为这样会自动启用或禁用与产品关联的所有软件源。
  </para>

  <sect2 xml:id="sec-rmt-mirroring-enable-disable-product">
   <title>使用产品</title>
   <para>
    要启用或禁用某个产品的所有软件源，请使用 <command>rmt-cli products enable <replaceable>ID</replaceable></command> 和 <command>rmt-cli products disable <replaceable>ID</replaceable></command> 命令。要检索已启用产品的 ID，请使用 <command>rmt-cli products list</command> 命令。要检索已禁用但可用的产品的 ID，请使用 <command>rmt-cli products list --all</command> 命令。
   </para>
   <para>
    示例：
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>rmt-cli products list --all</command>
+------+----------------------+---------+--------+--------------+---------------
| ID   | Product              | Version | Arch   | Mirror?      | Last mirrored
+------+----------------------+---------+--------+--------------+---------------
[...]
| 1743 | SUSE Package Hub     | 15      | x86_64 | Don't Mirror |
|      | PackageHub/15/x86_64 |         |        |              |
[...]

<prompt>&gt; </prompt><command>sudo</command> <command>rmt-cli products enable 1743</command>
Found product by target 1743: SUSE Package Hub 15 x86_64.
Enabling SUSE Package Hub 15 x86_64:
  SUSE Package Hub 15 x86_64:
    Enabled repository SLE-Module-Packagehub-Subpackages15-Pool.
    Enabled repository SLE-Module-Packagehub-Subpackages15-Updates.
    Enabled repository SUSE-PackageHub-15-Pool.
    Enabled repository SUSE-PackageHub-15-Standard-Pool..

<prompt>&gt; </prompt><command>sudo</command> <command>rmt-cli products disable 1743</command>
Found product by target 1743: SUSE Package Hub 15 x86_64.
Disabling SUSE Package Hub 15 x86_64:
  SUSE Package Hub 15 x86_64:
    Disabled repository SLE-Module-Packagehub-Subpackages15-Pool.
    Disabled repository SLE-Module-Packagehub-Subpackages15-Updates.
    Disabled repository SUSE-PackageHub-15-Pool.
    Disabled repository SUSE-PackageHub-15-Standard-Pool.

 To clean up downloaded files, run 'rmt-cli repos clean'</screen>
   <tip>
    <title>一次启用和禁用多个产品</title>
    <para>
     要一次启用或禁用多个产品，请指定产品 ID 或字符串的空格分隔列表，例如：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>rmt-cli products enable 1743 SLES/15/x86_64 SLES/12</command>
Found product by target 1743: SUSE Package Hub 15 x86_64.
Enabling SUSE Package Hub 15 x86_64:
  SUSE Package Hub 15 x86_64:
    Enabled repository SLE-Module-Packagehub-Subpackages15-Pool.
    Enabled repository SLE-Module-Packagehub-Subpackages15-Updates.
    Enabled repository SUSE-PackageHub-15-Pool.
    Enabled repository SUSE-PackageHub-15-Standard-Pool.
Found product by target SLES/15/x86_64: SUSE Linux Enterprise Server 15 x86_64.
Enabling SUSE Linux Enterprise Server 15 x86_64:
  SUSE Linux Enterprise Server 15 x86_64:
    Enabled repository SLE-Product-SLES15-Pool.
    Enabled repository SLE-Product-SLES15-Updates.
    Enabled repository SLE15-Installer-Updates.
  Basesystem Module 15 x86_64:
    Enabled repository SLE-Module-Basesystem15-Pool.
    Enabled repository SLE-Module-Basesystem15-Updates.
  Server Applications Module 15 x86_64:
    Enabled repository SLE-Module-Server-Applications15-Pool.
    Enabled repository SLE-Module-Server-Applications15-Updates.
Found product by target SLES/12: SUSE Linux Enterprise Server 12 x86_64.
Enabling SUSE Linux Enterprise Server 12 x86_64:
  SUSE Linux Enterprise Server 12 x86_64:
    Enabled repository SLES12-Pool.
    Enabled repository SLES12-Updates.</screen>
   </tip>
  </sect2>

  <sect2 xml:id="sec-rmt-mirroring-enable-disable-repository">
   <title>使用软件源</title>
   <para>
    要启用或禁用特定软件源的镜像，请使用 <command>rmt-cli repos enable <replaceable>ID</replaceable></command> 和 <command>rmt-cli repos disable <replaceable>ID</replaceable></command> 命令。要检索已启用的软件源的 ID，请使用 <command>rmt-cli repos list</command> 命令。要检索已禁用但可用的软件源的 ID，请使用 <command>rmt-cli repos list --all</command> 命令。
   </para>
   <para>
    示例：
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>rmt-cli repos list --all</command>
+--------+-------------------------+-------------------------------------------+
| ID     | Name                    | Description                               |
+--------+-------------------------+-------------------------------------------+
[...]
| 3061   | SUSE-PackageHub-15-Pool | SUSE-PackageHub-15-Pool for sle-15-x86_64 |
[...]
+--------+-------------------------+-------------------------------------------+

<prompt>&gt; </prompt><command>sudo</command> <command>rmt-cli repos enable 3061</command>
Repository by ID 3061 successfully enabled.

<prompt>&gt; </prompt><command>sudo</command> <command>rmt-cli repos disable 3061</command>
Repository by ID 3061 successfully disabled.

To clean up downloaded files, please run 'rmt-cli repos clean'
</screen>
   <tip>
    <title>一次启用和禁用多个软件源</title>
    <para>
     要一次启用或禁用多个软件源，请指定软件源 ID 的空格分隔列表，例如：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>rmt-cli repos enable 2526 3263</command>
Repository by ID 2526 successfully enabled.
Repository by ID 3263 successfully enabled.

<prompt>&gt; </prompt><command>sudo</command> <command>rmt-cli repos disable 2526 3263</command>
Repository by ID 2526 successfully disabled.
Repository by ID 3263 successfully disabled.

To clean up downloaded files, run 'rmt-cli repos clean'
</screen>
   </tip>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-rmt-mirroring-delete">
  <title>删除镜像数据</title>

  <para>
   按<xref linkend="sec-rmt-mirroring-enable-disable"/>中所述禁用软件源或产品镜像后，已镜像的数据仍保留在本地硬盘上。其中包括镜像的 RPM 软件包。
  </para>

  <para>
   要删除已禁用的软件源数据，请使用 <command>rmt-cli repos clean</command> 命令。使用此命令时，RMT 将校验是否仅镜像了已启用的软件源，并提供删除无效数据的途径。
  </para>

  <para>
   在去除任何数据之前，该命令将列出受影响的软件源，并要求用户输入 <literal>yes</literal> 以继续。
  </para>

<screen><prompt>&gt; </prompt><command>sudo</command> <command>rmt-cli repos clean</command>
RMT found locally mirrored files from the following repositories which are not marked to be mirrored:

SLE-Product-SLES15-Updates for sle-15-x86_64
SLE-Product-SLES15-Pool for sle-15-x86_64
SLE15-Installer-Updates for sle-15-x86_64

Would you like to continue and remove the locally mirrored files of these repositories?
Only 'yes' will be accepted.

Enter a value:  yes

Deleted locally mirrored files from repository 'SLE-Product-SLES15-Updates for sle-15-x86_64'.
Deleted locally mirrored files from repository 'SLE-Product-SLES15-Pool for sle-15-x86_64'.
Deleted locally mirrored files from repository 'SLE15-Installer-Updates for sle-15-x86_64'.

Clean finished. An estimated 157 MB were removed.
   </screen>

  <tip>
   <title>手动去除软件源数据</title>
   <para>
    要删除已禁用的软件源数据，请手动去除其对应的目录：
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>rm -r /usr/share/rmt/public/repo/SUSE/Products/<replaceable>PRODUCT</replaceable>/<replaceable>VERSION</replaceable>/<replaceable>ARCHITECTURE</replaceable>/</command></screen>
  </tip>
 </sect1>
 <sect1 xml:id="sec-rmt-mirroring-custom-repository">
  <title>添加自定义软件源</title>

  <para>
   您可以使用 RMT 服务器镜像自定义软件源。这些软件源不是 SUSE Customer Center 提供的。它们可能是第三方供应商（例如 Open Build Service）提供的，也可能是使用 <command>createrepo</command> 创建的。
  </para>

  <para>
   自定义软件源可以作为独立软件源使用，也可以关联到产品。这样，您便可以在已注册到 RMT 服务器的客户端上使用一个命令连接多个软件源。
  </para>

  <para>
   下面的示例过程演示了镜像第三方软件源的过程。
  </para>

  <procedure>
   <step>
    <para>
     将远程软件源添加到 RMT 服务器。将 <replaceable>URL</replaceable> 替换为软件源的 URL。将 <replaceable>NAME</replaceable> 替换为您为软件源所选择的名称。
    </para>
<screen><prompt role="root"># </prompt><command>rmt-cli repos custom add <replaceable>URL</replaceable> <replaceable>NAME</replaceable></command></screen>
   </step>
   <step>
    <para>
     列出所有自定义软件源以获取新软件源的 ID。
    </para>
<screen><prompt role="root"># </prompt><command>rmt-cli repos custom list</command></screen>
   </step>
   <step>
    <para>
     （可选）将新的自定义软件源关联到某个产品。例如，如果所有桌面客户端都需要这个新的自定义软件源，则可将其关联到 <literal>SUSE Linux Enterprise Desktop</literal> 产品。
    </para>
<screen><prompt role="root"># </prompt><command>rmt-cli repos custom attach <replaceable>REPOSITORY_ID</replaceable> <replaceable>PRODUCT_ID</replaceable></command></screen>
    <para>
     将 <replaceable>REPOSITORY_ID</replaceable> 替换为新自定义软件源的 ID。将 <replaceable>PRODUCT_ID</replaceable> 替换为要将软件源关联到的产品的 ID。如果您需要检索 <replaceable>PRODUCT_ID</replaceable>，请使用命令 <command>rmt-cli products list --all</command>。
    </para>
    <important>
     <para>
      当自定义软件源与某个产品相关联时，在该产品中注册的客户端将会发现它们处于禁用状态。要启用该软件源，请使用 <command>zypper lr</command> 命令确定其 ID，然后运行：
     </para>
<screen><prompt role="root"># </prompt>zypper mr -e <replaceable>REPO_ID</replaceable></screen>
    </important>
   </step>
   <step>
    <para>
     启用新自定义软件源的镜像。
    </para>
<screen><prompt role="root"># </prompt><command>rmt-cli repos custom enable <replaceable>REPOSITORY_ID</replaceable></command></screen>
   </step>
  </procedure>

  <para>
   要获取所有可用自定义软件源命令的列表，请参见<xref linkend="sec-rmt-tools-rmt-cli-repos"/>。
  </para>
 </sect1>
 <sect1 xml:id="sec-rmt-mirroring-export-import">
  <title>导出和导入软件源</title>

  <para>
   RMT 具有可导入和导出有关可用软件源和镜像软件包的数据的内置函数。例如，可以通过在本地复制已镜像的 RPM 软件包来加快新 RMT 服务器的设置。
  </para>

  <para>
   另一个用例是<emphasis>脱机模式</emphasis>。通过脱机模式，可以将数据传输到断开连接的 RMT 服务器，从而实现为气隙网络中的计算机提供更新等目的。
  </para>

  <para>
   下面的过程说明了如何使用 USB 驱动器在两台 RMT 服务器之间传输数据及镜像的 RPM。服务器 <literal>sun</literal> 与 SUSE Customer Center 相连，而服务器 <literal>sirius</literal> 则位于气隙网络中。
  </para>

  <procedure>
   <step>
    <para>
     登录服务器 <literal>sun</literal>。
    </para>
<screen><prompt role="root">root@sun # </prompt><command>rmt-cli sync</command>
<prompt role="root">root@sun # </prompt><command>rmt-cli mirror</command></screen>
   </step>
   <step>
    <para>
     连接一个 USB 驱动器（假设为 <filename>/dev/sdb</filename>），并将其挂载到所需位置（例如 <filename>/mnt/external</filename>）。
    </para>
<screen><prompt role="root">root@sun # </prompt><command>mount /dev/sdb1 /mnt/external</command></screen>
   </step>
   <step>
    <substeps>
     <step>
      <para>
       导出有关可用软件源和产品的数据。
      </para>
<screen><prompt role="root">root@sun # </prompt><command>rmt-cli export data /mnt/external/</command></screen>
     </step>
     <step>
      <para>
       导出已启用软件源的列表。在下一步导出软件源时需要使用该导出文件。
      </para>
<screen><prompt role="root">root@sun # </prompt><command>rmt-cli export settings /mnt/external/</command></screen>
     </step>
     <step>
      <para>
       导出镜像的 RPM 软件包。此过程可能需要较长时间，具体视镜像软件源的大小而定。
      </para>
<screen><prompt role="root">root@sun # </prompt><command>rmt-cli export repos /mnt/external/</command></screen>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     从 <literal>sun</literal> 卸载并拔出磁盘，然后转到 <literal>sirius</literal>。
    </para>
<screen><prompt role="root">root@sun # </prompt><command>umount /mnt/external</command></screen>
   </step>
   <step>
    <para>
     通过运行 <command>yast2 rmt</command> 在 <literal>sirius</literal> 上设置 RMT（如果尚未执行该操作）。如果进行的是脱机 RMT 设置，请在<guimenu>组织身份凭证</guimenu>屏幕上选择<guimenu>跳过</guimenu>。
    </para>
   </step>
   <step>
    <para>
     将 USB 驱动器连接到 <literal>sirius</literal>，并将其挂载到 <filename>/mnt/external</filename> 中。
    </para>
<screen><prompt role="root">root@sirius # </prompt><command>mount /dev/sdb1 /mnt/external</command></screen>
   </step>
   <step>
    <substeps>
     <step>
      <para>
       导入有关可用软件源和产品的元数据。
      </para>
<screen><prompt role="root">root@sirius # </prompt><command>rmt-cli import data /mnt/external/</command></screen>
     </step>
     <step>
      <para>
       导入镜像的 RPM 软件包。此过程可能需要较长时间，具体视镜像软件源的大小而定。
      </para>
<screen><prompt role="root">root@sirius # </prompt><command>rmt-cli import repos /mnt/external/</command></screen>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     在 <literal>sirius</literal> 上根据需要启用软件源。有关详细信息，请参见<xref linkend="sec-rmt-mirroring-enable-disable"/>。
    </para>
   </step>
  </procedure>

  <note>
   <title>从气隙服务器导出启用的设置</title>
   <para>
    如果您的气隙服务器 (<literal>sirius</literal>) 具有许多启用的软件源，或者启用的软件源经常更改，我们建议从此服务器中导出软件源设置。
   </para>
   <para>
    然后可将导出的设置导入到与 SUSE Customer Center 相连的服务器 (<literal>sun</literal>) 中。这样便能确保 <literal>sun</literal> 下载了 <literal>sirius</literal> 所需的所有数据。
   </para>
  </note>
 </sect1>
</chapter>
