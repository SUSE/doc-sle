<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_xntp.xml" version="5.0" xml:id="cha.netz.xntp">









 <title>使用 NTP 進行時間同步化</title>
 <info>
      <abstract>
        <para>
    NTP (網路時間協定) 機制是一種協定，用於同步化網路上的系統時間。首先，機器可以從提供可靠時間來源的伺服器取得時間。其次，機器本身在網路中可以做為其他電腦的時間來源。這個目標是雙重的 — 即維護絕對正確的時間，並同步化網路內所有機器的系統時間。
   </para>
      </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:bugtracker>
          </dm:bugtracker>
        <dm:translation>yes</dm:translation>
      </dm:docmanager>
    </info>
    <para>
  維謢精準的系統時間對於許多情況都非重要。內建的硬體時鐘通常無法符合資料庫或叢集等應用程式的要求。手動校正系統時間有可能會造成嚴重的問題，因為，例如時間倒退將可能造成重要應用程式無法正常運作。在網路中，通常需要同步所有機器中的系統時間，而手動調整時間的做法並不可取。NTP 提供了一種用於解決這些問題的機制。NTP 服務會透過網路中可靠的時間伺服器來持續調整系統時間。它可以進一步管理本地參考的時鐘，例如收音機控制的時鐘。
 </para>

 <sect1 xml:id="sec.netz.xntp.yast">
  <title>使用 YaST 設定 NTP 用戶端</title>

  <para>
   <systemitem>ntp</systemitem> 套件隨附的 NTP 精靈 (<systemitem class="daemon">ntpd</systemitem>) 預先設定為使用本地電腦時鐘做為時間參考。不過，硬體時鐘僅供在沒有更精確的時間來源時備用。YaST 簡化了 NTP 用戶端的組態。
  </para>

  <sect2 xml:id="sec.net.ntp.yast.basic">
   <title>基本組態</title>
   <para>
    YaST NTP 用戶端組態 (<menuchoice><guimenu>網路服務</guimenu> <guimenu>NTP 組態</guimenu></menuchoice>) 包含數個索引標籤。在<guimenu>一般設定</guimenu>索引標籤上設定 <systemitem class="daemon">ntpd</systemitem> 的啟動模式和要查詢的伺服器。
   </para>
   <variablelist>
    <varlistentry>
     <term><guimenu>僅手動</guimenu>
     </term>
     <listitem>
      <para>
       如果要手動啟動 <systemitem class="daemon">ntpd</systemitem> 精靈，請選取<guimenu>僅手動</guimenu>。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><guimenu>現在和開機時</guimenu>
     </term>
     <listitem>
      <para>
       選取<guimenu>現在和開機時</guimenu>，以便在系統開機時自動啟動 <systemitem class="daemon">ntpd</systemitem>。強烈建議您使用此設定。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>



  <sect2 xml:id="sec.net.ntp.yast.new_sync">
   <title>變更基本組態</title>
   <para>
    用戶端要查詢的伺服器以及其他時間來源會列在<guimenu>一般設定</guimenu>索引標籤的下半部。修改清單時，可依需要使用<guimenu>新增</guimenu>、<guimenu>編輯</guimenu>以及<guimenu>刪除</guimenu>。<guimenu>顯示記錄</guimenu>可用來檢視用戶端的記錄檔。
   </para>
   <para>
    按一下<guimenu>新增</guimenu>以新增時間資訊的新來源。在下列對話方塊中，選取進行時間同步化的來源類型。可用的選項如下：
   </para>
   <figure xml:id="fig.yast.ntp.selserv">
    <title>YaST：NTP 伺服器</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata width="75%" fileref="yast_ntp_selserv.png" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata width="75%" fileref="yast_ntp_selserv.png" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <variablelist>
    <varlistentry>
     <term>伺服器</term>
     <listitem>
      <para>
       在<guimenu>選取</guimenu>下拉式選單 (請參閱<xref linkend="fig.yast.ntp.selserv"/>) 中，指定是使用區域網路中的時間伺服器 (<guimenu>本地 NTP 伺服器</guimenu>)，還是使用可以處理您時區的網際網路時間伺服器 (<guimenu>公用 NTP 伺服器</guimenu>) 來設定時間同步化。若需本地時間伺服器，請按一下<guimenu>查詢</guimenu>，開始 SLP 查詢，在網路中尋找可用的時間伺服器。從搜尋結果清單中選取最合適的時間伺服器，並按一下<guimenu>確定</guimenu>，結束對話方塊。若需公用時間伺服器，請選取您的國家 (時區) 並從<guimenu>公用 NTP 伺服器</guimenu>下的清單選取適當的伺服器，然後按一下<guimenu>確定</guimenu>，結束對話方塊。在主對話方塊中，使用<guimenu>測試</guimenu>來測試所選取伺服器的可用性。<guimenu>選項</guimenu>可讓您為 <systemitem class="daemon">ntpd</systemitem> 指定其他選項。
      </para>
      <para>
       使用<guimenu>存取控制選項</guimenu>，您可以限制遠端電腦可以使用電腦上執行的精靈來執行的動作。當核取<guimenu>安全性設定</guimenu>索引標籤 (請參閱<xref linkend="fig.yast.ntp.adv.sec"/>) 中的<guimenu>將 NTP 服務限制為僅限已設定的伺服器</guimenu>後，此欄位才處於啟用狀態。這些選項對應於 <filename>/etc/ntp.conf</filename> 中的 <literal>restrict</literal> 子句。例如，<literal>nomodify notrap noquery</literal> 不允許伺服器修改電腦的 NTP 設定，並且不允許使用 NTP 精靈的設陷裝置 (遠端事件登入功能)。建議對超出您控制範圍 (例如在網際網路上) 的伺服器使用這些限制。
      </para>
      <para>
       如需詳細資訊，請參閱 <filename>/usr/share/doc/packages/ntp-doc</filename> (<systemitem>ntp-doc</systemitem> 套件的一部份)。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>點</term>
     <listitem>
      <para>
       點 (peer)，是指一台建立了對稱關係的機器：它可同時做為時間伺服器與用戶端。若要在相同的網路中使用點而非伺服器，請輸入系統的位址。其餘的對話方塊與<guimenu>伺服器</guimenu>對話方塊相同。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>收音機時鐘</term>
     <listitem>
      <para>
       若要在系統中使用收音機時鐘來進行時間同步化，請在此對話方塊中輸入時鐘類型、單位編號、裝置名稱以及其他選項。按一下<guimenu>驅動程式校正</guimenu>，即可微調驅動程式。<filename>/usr/share/doc/packages/ntp-doc/refclock.html</filename> 中提供了關於本地無線電時鐘作業的詳細資訊。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>外寄廣播</term>
     <listitem>
      <para>
       時間資訊與查詢也可以透過網路中的廣播傳輸。請在此對話方塊中輸入廣播所應傳送至的位址。除非您已經有類似收音機控制時鐘的可靠時間來源，否則請勿啟用廣播。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>內送廣播</term>
     <listitem>
      <para>
       如果您想要讓用戶端透過廣播接收其資訊，請在這些欄位中輸入應該接受的個別封包位址。

      </para>
     </listitem>
    </varlistentry>
   </variablelist>



   <figure xml:id="fig.yast.ntp.adv.sec">
    <title>進階 NTP 組態︰安全性設定</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata width="75%" fileref="yast2_xntp_adv_sec.png" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata width="75%" fileref="yast2_xntp_adv_sec.png" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    在<guimenu>安全性設定</guimenu>索引標籤 (請參閱<xref linkend="fig.yast.ntp.adv.sec"/>) 中，指定 <systemitem class="daemon">ntpd</systemitem> 是否應於 chroot jail 中啟動。依照預設，會啟用<guimenu>在 Chroot Jail 中執行 NTP 精靈</guimenu>。由於此選項可以防止攻擊者損毀整個系統，因此在 <systemitem class="daemon">ntpd</systemitem> 遭受攻擊時，會有較高的安全性。
   </para>
   <para>
    <guimenu>將 NTP 服務限制為僅限已設定的伺服器</guimenu>可增加系統安全性，方法是禁止遠端電腦檢視並修改電腦的 NTP 設定，並且禁止使用用於遠端事件登入的設陷裝置。啟用此選項後，這些限制會套用至所有遠端電腦，除非您覆寫<guimenu>一般設定</guimenu>索引標籤的時間來源清單中個別電腦的存取控制選項。對於所有其他遠端電腦，僅允許查詢本地時間。
   </para>
   <para>
    如果 SuSEfirewall2 在作用中 (預設情況下)，請啟用<guimenu>在防火牆中開啟埠</guimenu>。如果您讓連接埠保持為關閉，就不可能對時間伺服器建立連接。
   </para>
  </sect2>
 </sect1>



 <sect1 xml:id="sec.netz.xntp.netconf">
  <title>手動設定網路中的 NTP</title>

  <para>

   在網路上使用時間伺服器的最簡單方式就是設定伺服器參數。例如，如果可以從網路存取名為 <systemitem>ntp.example.com</systemitem> 的時間伺服器，那麼，請新增以下行，將此伺服器的名稱新增到 <filename>/etc/ntp.conf</filename> 檔案：
  </para>

<screen>server ntp.example.com</screen>

  <para>
   若要新增更多時間伺服器，請以關鍵字<literal>伺服器</literal>插入其他行。在使用 <systemitem class="daemon">systemctl start ntp</systemitem> 指令啟始化 <command>ntpd</command> 後，大約需要一個小時來穩定時間以及建立漂移檔案以校正本地電腦時鐘。使用累積記錄檔案，就可以在電腦一開機後立即計算硬體時鐘的系統錯誤。它會立即使用校正，使系統時間具有更高的穩定性。
  </para>

  <para>
   有兩種方法可以將 NTP 機制做為用戶端：首先，用戶端可固定在每段間隔時間後向已知伺服器查詢時間。隨著用戶端的增加，此方法可能造成伺服器的高負載。其次，用戶端可以等待網路中的廣播時間伺服器所送出的 NTP 廣播。此方法具有伺服器品質未知的缺點，而且伺服器送出錯誤的資訊可能造成嚴重的問題。
  </para>

  <para>
   如果時間是經由廣播取得，就不需要伺服器名稱。在這樣的情形下，請在 <literal>/etc/ntp.conf</literal> 組態檔中輸入 <filename>broadcastclient</filename>。若要完全使用一或多個已知的時間伺服器，請輸入以 <literal>servers</literal> 開頭的名稱。
  </para>


 </sect1>



 <sect1 xml:id="sec.netz.xntp.dynamic">
  <title>執行時期的動態時間同步</title>



  <para>
   若系統開機後並無網路連接，<systemitem class="daemon">ntpd</systemitem> 仍會啟動，但無法解析組態檔案中設定之時間伺服器的 DNS 名稱。在加密的 Wi-Fi 中使用 NetworkManager 時，可能會發生這種情況。
  </para>

  <para>
   如果您希望 <systemitem class="daemon">ntpd</systemitem> 在執行時期解析 DNS 名稱，必須設定 <systemitem>dynamic</systemitem> 選項。這樣一來，當開機一段時間後連接網路時，<systemitem class="daemon">ntpd</systemitem> 便會再次查詢名稱，並連接時間伺服器以獲取時間。
  </para>

  <para>
   手動編輯 <filename>/etc/ntp.conf</filename>，並將 <systemitem>dynamic</systemitem> 新增至一或多個 <systemitem>server</systemitem> 項目︰
  </para>

<screen>server ntp.example.com dynamic</screen>

  <para>
   您也可以使用 YaST 並按以下步驟操作︰
  </para>

  <procedure>
   <step>
    <para>
     在 YaST 中，按一下<menuchoice><guimenu>網路服務</guimenu> <guimenu>NTP 組態</guimenu></menuchoice>。
    </para>
   </step>
   <step>
    <para>
     選取要設定的伺服器。然後按一下<guimenu>編輯</guimenu>。
    </para>
   </step>
   <step>
    <para>
     啟動<guimenu>選項</guimenu>欄位，並新增 <literal>dynamic</literal>。如果已經輸入了其他選項，請使用空格分隔。
    </para>
   </step>
   <step>
    <para>
     按一下<guimenu>確定</guimenu>關閉編輯對話方塊。重複上述步驟以變更所有要變更的伺服器。
    </para>
   </step>
   <step>
    <para>
     最後按一下<guimenu>確定</guimenu>儲存設定。
    </para>
   </step>
  </procedure>
 </sect1>



 <sect1 xml:id="sec.netz.xntp.normal">
  <title>設定本地參考時鐘</title>

  <para>
   軟體套件 <systemitem class="daemon">ntpd</systemitem> 包含與本機參照時鐘連接的驅動程式。<filename>ntp-doc</filename> 套件的 <systemitem class="resource">/usr/share/doc/packages/ntp-doc/refclock.html</systemitem> 檔案中提供了受支援時鐘的清單。每個驅動程式都與數字關聯。在 NTP 中，實際組態工作是透過虛擬 IP 位址來執行。把時鐘當成在網路中一樣，將它輸入 <filename>/etc/ntp.conf</filename> 檔案中。因此，會指定特殊的 IP 位址，<literal>127.127.<replaceable>t</replaceable>.<replaceable>u</replaceable></literal> 給它們。在此，<replaceable>t</replaceable> 代表時鐘的類型並可決定使用哪一個驅動程式，而 <replaceable>u</replaceable> 是代表單位，可決定使用哪一個介面。

  </para>

  <para>
   一般而言，個別裝置都具有描述組態細節的特殊參數。檔案 <filename>/usr/share/doc/packages/ntp-doc/drivers/driver<replaceable>NN</replaceable>.html</filename> (其中的 <replaceable>NN</replaceable> 為驅動程式的編號) 提供了關於特定類型之時鐘的資訊。例如，<quote>type 8</quote> 時鐘 (透過序列介面的收音機時鐘) 需要其他可以更精確地指定時鐘的模式。例如，Conrad DCF77 接收器模組具有模式 5。若要使用此時鐘做為偏好的參考，請指定 <literal>prefer</literal> 關鍵字。Conrad DCF77 接收器模組的完整 <literal>server</literal> 行如下所示：
  </para>

<screen>server 127.127.8.0 mode 5 prefer</screen>

  <para>
   其他的時鐘也使用相同的模式。安裝 <systemitem class="resource">ntp-doc</systemitem> 套件後，便可在 <filename>/usr/share/doc/packages/ntp-doc</filename> 目錄中找到 NTP 的文件。檔案 <filename>/usr/share/doc/packages/ntp-doc/refclock.html</filename> 提供了指向描述驅動程式參數之驅動程式頁面的連結。
  </para>
 </sect1>
 <sect1 xml:id="sec.netz.xntp.etr" arch="zseries">
  <title>將時鐘與外部時間參考 (ETR) 同步</title>



  <para>
   支援將時鐘與外部時間參考 (ETR) 同步。外部時間參考每 2**2 百萬分之一秒 (2 的 20 次方) 傳送一次振盪器訊號與同步訊號，以將所有連結伺服器的 TOD 時鐘保持同步。
  </para>

  <para>
   為了便利，兩個 ETR 裝置可連接到一個機器。如果時鐘偏差超出同步檢查容錯，則所有 CPU 都會收到一個機器記號，指出時鐘不同步。如果出現這種狀況，則所有啟用了 DASD I/O 到 XRC 的裝置就會停止運作，直到時鐘重新同步。
  </para>

  <para>
   ETR 支援透過兩個 <literal>sysfs</literal> 屬性啟動；請以 <systemitem class="username">root</systemitem> 身分執行下列指令：
  </para>

<screen>echo 1 &gt; /sys/devices/system/etr/etr0/online
echo 1 &gt; /sys/devices/system/etr/etr1/online
</screen>
 </sect1>
</chapter>
