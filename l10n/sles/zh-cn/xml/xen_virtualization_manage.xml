<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="xen_virtualization_manage.xml" version="5.0" xml:id="cha-xen-manage">
 <title>管理虚拟化环境</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:bugtracker>
        </dm:bugtracker>
	<dm:translation>yes</dm:translation>
      </dm:docmanager>
    </info>
    <para>
  除了使用建议的 <systemitem class="library">libvirt</systemitem> 库（<xref linkend="part-virt-libvirt"/>）以外，您还可以在命令行中使用 <command>xl</command> 工具来管理 Xen Guest 域。
 </para>
 <sect1 xml:id="sec-xen-manage-xl">
  <title>XL — Xen 管理工具</title>

  <para>
   <command>xl</command> 程序是用于管理 Xen Guest 域的工具。它包含在 <package>xen-tools</package> 软件包中。<command>xl</command> 基于 LibXenlight 库，可用于执行一般的域管理工作，例如创建、监听、暂停或关闭域。通常只有 <systemitem class="username">root</systemitem> 用户才能执行 <command>xl</command> 命令。
  </para>

  <note>
   <para>
    <command>xl</command> 只能管理域配置文件指定的运行中 Guest 域。如果某个 Guest 域未运行，则您无法使用 <command>xl</command> 来管理它。
   </para>
  </note>

  <tip>
   <para>
    为了允许用户继续像使用已过时的 <command>xm</command> 命令那样来使用受管 Guest 域，目前我们建议使用 <systemitem class="library">libvirt</systemitem> 的 <command>virsh</command> 和 <command>virt-manager</command> 工具。有关详细信息，请参见 <xref linkend="part-virt-libvirt"/>。
   </para>
  </tip>

  <para>
   <command>xl</command> 操作依赖于 <systemitem>xenstored</systemitem> 和 <systemitem>xenconsoled</systemitem> 服务。请确保在引导时启动
  </para>

<screen><prompt>&gt; </prompt>systemctl start xencommons</screen>

  <para>
   以初始化 <command>xl</command> 所需的所有守护程序。
  </para>

  <tip>
   <title>在主机域中设置 <literal>xenbr0</literal> 网桥</title>
   <para>
    在最常用的网络配置中，需在主机域中设置一个名为 <literal>xenbr0</literal> 的网桥，以便为 Guest 域提供正常工作的网络。
   </para>
  </tip>

  <para>
   每个 <command>xl</command> 命令的基本结构如下：
  </para>

<screen>xl &lt;subcommand&gt; [options] domain_id</screen>

  <para>
   其中，&lt;subcommand&gt; 是要运行的 xl 命令，domain_id 是指派给域的 ID 编号或虚拟机的名称，<command>OPTIONS</command> 表示特定于子命令的选项。
  </para>

  <para>
   如需可用 <command>xl</command> 子命令的完整列表，请运行 <command>xl help</command>。对于每个命令，都可以使用附加参数 <systemitem>--help</systemitem> 获取更详细的帮助。<command>xl</command> 的手册页中提供了有关相应子命令的详细信息。
  </para>

  <para>
   例如，<command>xl list --help</command> 会显示 list 命令可用的所有选项。举例来说，<command>xl list</command> 命令可显示所有虚拟机的状态。
  </para>

<screen>
<prompt>&gt; </prompt><command>sudo</command> xl list
Name                                 ID    Mem VCPUs        State   Time(s)
Domain-0                              0    457     2       r-----   2712.9
sles12                                7    512     1       -b----     16.3
opensuse                                   512     1                  12.9
</screen>

  <para>
   <guimenu>State</guimenu> 信息指示某个计算机是否正在运行，以及处于哪种状态。最常用的标志为 <literal>r</literal>（正在运行）和 <literal>b</literal>（受阻），其中“受阻”的意思是该计算机正在等待 IO，或者由于无需执行任何操作而处于休眠状态。有关状态标志的更多细节，请参见 <command>man 1 xl</command>。
  </para>

  <para>
   其他有用的 <command>xl</command> 命令包括：
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     <command>xl create</command>，可基于给定的配置文件创建虚拟机。
    </para>
   </listitem>
   <listitem>
    <para>
     <command>xl reboot</command>，可重引导虚拟机。
    </para>
   </listitem>
   <listitem>
    <para>
     <command>xl destroy</command>，可立即终止虚拟机。
    </para>
   </listitem>
   <listitem>
    <para>
     <command>xl block-list</command>，可显示挂接到虚拟机的所有虚拟块设备。
    </para>
   </listitem>
  </itemizedlist>

  <sect2 xml:id="sec-xen-manage-xl-cfg-file">
   <title>Guest 域配置文件</title>
   <para>
    使用 <command>xl</command> 操作域时，每个域都需有相应的域配置文件。用于储存此类配置文件的默认目录为 <filename>/etc/xen/</filename>。
   </para>
   <para>
    域配置文件是一个纯文本文件。它包含多个“<replaceable>键</replaceable>=<replaceable>值</replaceable>”对。有些键是必需的，有些键是通用的且适用于任何 Guest，还有些键只适用于特定的 Guest 类型（半虚拟化或全虚拟化）。值可以是括在单引号或双引号中的字符串（<literal>&quot;string&quot;</literal> 形式）、数字、布尔值，或者括在方括号中的多个值的列表（<literal>[ value1, value2, ... ]</literal> 形式）。
   </para>
   <example>
    <title>SLED 12 的 Guest 域配置文件：<filename>/etc/xen/sled12.cfg</filename></title>
<screen>name= "sled12"
builder = "hvm"
vncviewer = 1
memory = 512
disk = [ '/var/lib/xen/images/sled12.raw,,hda', '/dev/cdrom,,hdc,cdrom' ]
vif = [ 'mac=00:16:3e:5f:48:e4,model=rtl8139,bridge=br0' ]
boot = "n"</screen>
   </example>
   <para>
    要启动此类域，请运行 <command>xl create /etc/xen/sled12.cfg</command>。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-xen-manage-autostart">
  <title>自动启动 Guest 域</title>

  <para>
   要使 Guest 域在主机系统引导后自动启动，请执行以下步骤：
  </para>

  <procedure>
   <step>
    <para>
     创建域配置文件（如果不存在）并将其保存到 <filename>/etc/xen/</filename> 目录，例如 <filename>/etc/xen/domain_name.cfg</filename>。
    </para>
   </step>
   <step>
    <para>
     在 <filename>auto/</filename> 子目录中创建 Guest 域配置文件的符号链接。
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> ln -s /etc/xen/domain_name.cfg /etc/xen/auto/domain_name.cfg</screen>
   </step>
   <step>
    <para>
     系统下次引导时，<filename>domain_name.cfg</filename> 中定义的 Guest 域将会启动。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-xen-manage-events">
  <title>事件操作</title>

  <para>
   在 Guest 域配置文件中，您可以定义在发生一组预定义的事件时要执行的操作。例如，要告知域在其关机后自行重启动，请在其配置文件中包含下面一行：
  </para>

<screen>on_poweroff="restart"</screen>

  <para>
   下面是 Guest 域的预定义事件列表：
  </para>

  <variablelist>
   <title>事件列表</title>
   <varlistentry>
    <term>on_poweroff</term>
    <listitem>
     <para>
      指定在域自行关机后应执行什么操作。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>on_reboot</term>
    <listitem>
     <para>
      当域关机并提供了请求重引导的原因代码时要执行的操作。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>on_watchdog</term>
    <listitem>
     <para>
      当域由于 Xen 看门狗超时而关机时要执行的操作。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>on_crash</term>
    <listitem>
     <para>
      当域崩溃时要执行的操作。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   对于这些事件，可以定义以下操作之一：
  </para>

  <variablelist>
   <title>相关操作列表</title>
   <varlistentry>
    <term>destroy</term>
    <listitem>
     <para>
      销毁域。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>restart</term>
    <listitem>
     <para>
      销毁域，并立即采用相同的配置创建新域。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>rename-restart</term>
    <listitem>
     <para>
      重命名已终止的域，然后立即采用与原始域相同的配置创建新域。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>preserve</term>
    <listitem>
     <para>
      保留域。可以检查该域，以后再使用 <command>xl destroy</command> 将它销毁。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>coredump-destroy</term>
    <listitem>
     <para>
      将域的核心转储写入 <filename>/var/xen/dump/NAME</filename>，然后销毁该域。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>coredump-restart</term>
    <listitem>
     <para>
      将域的核心转储写入 <filename>/var/xen/dump/NAME</filename>，然后重启动该域。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>

 <sect1 xml:id="sec-xen-manage-tsc">
  <title>时戳计数器</title>
  <para>
   您可以为 Guest 域配置文件中的每个域指定时戳计数器 (TSC)（有关详细信息，请参见<xref linkend="sec-xen-manage-xl-cfg-file"/>）。
  </para>
  <para>
   使用 <literal>tsc_mode</literal> 设置可以指定是要<quote>本机</quote>执行 rdtsc 指令（速度较快，但 TSC 敏感型应用程序有时无法正常运行），还是模拟这些指令（始终可正常运行，但性能可能受到影响）。
  </para>
  <variablelist>
   <varlistentry>
    <term><literal>tsc_mode=0</literal>（默认设置）</term>
    <listitem>
     <para>
      使用此设置可确保正常运行，同时提供可以实现的最佳性能 — 有关详细信息，请参见 <link xlink:href="https://xenbits.xen.org/docs/4.3-testing/misc/tscmode.txt"/>。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>tsc_mode=1</literal>（始终模拟）</term>
    <listitem>
     <para>
      如果 TSC 敏感型应用程序正在运行，并且已知且可接受最坏情况下的性能下降，请使用此设置。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>tsc_mode=2</literal>（永不模拟）</term>
    <listitem>
     <para>
      如果此 VM 中运行的所有应用程序都能够灵活适应 TSC 并且需要最高性能，请使用此设置。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>tsc_mode=3</literal> (PVRDTSCP)</term>
    <listitem>
     <para>
      可以半虚拟化（修改）高 TSC 频率应用程序，以同时兼顾正常运行和最高性能 — 任何未经修改的应用程序都必须能够灵活适应 TSC。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <para>
   有关背景信息，请参见 <link xlink:href="https://xenbits.xen.org/docs/4.3-testing/misc/tscmode.txt"/>。
  </para>
 </sect1>

 <sect1 xml:id="sec-xen-config-suspend">
  <title>保存虚拟机</title>

  <procedure>
   <title>保存虚拟机的当前状态</title>
   <step>
    <para>
     确保要保存的虚拟机正在运行。
    </para>
   </step>
   <step>
    <para>
     在主机环境中输入
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> xl save <replaceable>ID</replaceable> <replaceable>STATE-FILE</replaceable></screen>
    <para>
     其中，<replaceable>ID</replaceable> 是要保存的虚拟机 ID，<replaceable>STATE-FILE</replaceable> 是您为内存状态文件指定的名称。默认情况下，当您创建域的快照后，该域将不再运行。使用 <option>-c</option> 可使域保持运行状态，即使在您创建快照后也是如此。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-xen-config-restore">
  <title>恢复虚拟机</title>

  <procedure>
   <title>恢复虚拟机的当前状态</title>
   <step>
    <para>
     确保要恢复的虚拟机自您运行保存操作后始终未启动。
    </para>
   </step>
   <step>
    <para>
     在主机环境中输入
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> xl restore <replaceable>STATE-FILE</replaceable></screen>
    <para>
     其中，<replaceable>STATE-FILE</replaceable> 是先前保存的内存状态文件。域在恢复后默认将处于运行状态。要在恢复后暂停域，请使用 <option>-p</option>。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-xen-config-state">
  <title>虚拟机状态</title>

  <para>
   可以通过查看 <command>xl list</command> 命令的结果来显示虚拟机的状态，结果中以单字符缩写形式显示状态。
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     <command>r</command> - 正在运行 - 虚拟机当前正在运行，并在消耗分配的资源。
    </para>
   </listitem>
   <listitem>
    <para>
     <command>b</command> - 受阻 - 虚拟机的处理器未运行，且无法运行。虚拟机正在等待 I/O 或已停止工作。
    </para>
   </listitem>
   <listitem>
    <para>
     <command>p</command> - 已暂停 - 虚拟机已暂停。虚拟机不会与超级管理程序交互，但仍保有为其分配的资源，例如内存。
    </para>
   </listitem>
   <listitem>
    <para>
     <command>s</command> - 已关闭 - Guest 操作系统正在关闭、已重引导或已挂起，并且虚拟机正在停止。
    </para>
   </listitem>
   <listitem>
    <para>
     <command>c</command> - 已崩溃 - 虚拟机已崩溃，未在运行。
    </para>
   </listitem>
   <listitem>
    <para>
     <command>d</command> - 即将死机 - 虚拟机正在关机或崩溃。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
