<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="transactional_updates.xml" version="5.0" xml:id="cha-transactional-updates" xml:lang="ja">
 <title>トランザクション更新</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    トランザクション更新は、ルートファイルシステムが読み込み専用のときにSLESを更新するためのテクノロジープレビューとして、<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>で利用できます。トランザクション更新はアトミックであり(すべての更新が成功した場合にのみすべての更新が適用されます)、ロールバックをサポートします。システムが再起動されるまで変更は有効にならないため、実行中のシステムには影響しません。再起動は中断を伴うので、管理者は、再起動の方が実行中のサービスを妨害するよりもコストがかかるかどうかを判断する必要があります。再起動でコストがかかりすぎる場合は、トランザクション更新を使用しないでください。
   </para>

   <para>
    トランザクションの更新は、<command>transactional-update</command>スクリプトによって、毎日実行されます。スクリプトは使用可能な更新をチェックします。更新がある場合は、ルートファイルシステムの新しいスナップショットをバックグラウンドで作成し、リリースチャネルから更新をフェッチします。新しいスナップショットが完全に更新された後で、アクティブとマークされ、システムの次の再起動後に新しいデフォルトのルートファイルシステムになります。<command>transactional-update</command>が自動的に実行するように設定されている場合(これはデフォルトの動作です)、システムも再起動します。更新を実行する時刻と再起動の保守時間枠の両方が設定可能です。
   </para>

   <para>
    ルートファイルシステムのスナップショットの一部であるパッケージのみを更新できます。パッケージにスナップショットの一部ではないファイルが含まれている場合、更新は失敗するか、システムが破損する可能性があります。
   </para>

   <para>
    ライセンスを受諾する必要があるRPMは更新できません。
   </para>
  </abstract>
 </info>
 
 <sect1 xml:id="sec-tu-limitations">
  <title>テクノロジープレビューの制限</title>

  <para>
   テクノロジープレビューとして、機能には特定の制限があります。次のパッケージは、<command>transactional-update</command>では機能しません。
  </para>

  <itemizedlist>
   <listitem>
    <para>
     <package>nginx</package>のデフォルトのindex.htmlページは使用できない場合があります
    </para>
   </listitem>
   <listitem>
    <para>
     <package>tomcat-webapps</package> および <package>tomcat-admin-webapps</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>phpMyAdmin</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>sca-appliance-*</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>mpi-selector</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>emacs</package>はEmacsゲームを除いて機能します
    </para>
   </listitem>
   <listitem>
    <para>
     <package>bind</package> および <package>bind-chrootenv</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>docbook*</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>sblim-sfcb*</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>texlive*</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>iso_ent</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>openjade</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>opensp</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>pcp</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>plymouth</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>postgresql-server-10</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>pulseaudio-gdm-hooks</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>smartmontools</package>
    </para>
   </listitem>
  </itemizedlist>

  <para>
   システムインストーラのアップデータコンポーネントは、トランザクションの更新をサポートしていないため、読み込み専用ファイルシステムでは動作しません。
  </para>

  <para>
   その他の考慮事項:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     一般的に、システムを更新してから、マシンを再起動するまでの時間を最小限に抑えることをお勧めします。
    </para>
   </listitem>
   <listitem>
    <para>
     1つの更新のみを一度に適用できます。更新後、および次の更新が適用される前に必ず再起動してください。
    </para>
   </listitem>
   <listitem>
    <para>
     <command>update-alternatives</command>は、トランザクション更新後、マシンが再起動されるまで、実行しないでください。
    </para>
   </listitem>
   <listitem>
    <para>
     トランザクション更新後、再起動後まで新しいシステムユーザまたはシステムグループを作成しないでください。通常のユーザおよびグループを作成することは許容されます (UID &gt; 1000、GID &gt; 1000)。
    </para>
   </listitem>
   <listitem>
    <para>
     YaSTはまだトランザクション更新を認識していません。YaSTモジュールで追加のパッケージをインストールする必要がある場合、これは機能しません。<filename>/etc</filename>の設定ファイルのみを変更する通常のシステム操作は機能します。
    </para>
   </listitem>
   <listitem>
    <para>
     <package>php7-fastcgi</package>の場合、<filename>/usr/bin/php-cgi</filename>を示すシンボリックリンク<filename>/srv/www/cgi-bin/php</filename>を手動で作成する必要があります。
    </para>
   </listitem>
   <listitem>
    <para>
     <package>ntp</package>は、古いSLESバージョンのレガシモジュールの一部です。ntpは新しい<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>インストールでサポートされておらず、<package>chrony</package>に置き換えられています。<package>ntp</package>を引き続き使用する場合は、トランザクション更新で正しく機能させるために、新規インストールが必要です。
    </para>
   </listitem>
   <listitem>
    <para>
     <package>sblim-sfcb</package>: エコシステム全体がトランザクション更新と互換性がありません。
    </para>
   </listitem>
   <listitem>
    <para>
     <command>パッケージの</command>btrfs-defrag<package>btrfsmaintenance</package>は、読み込み専用ルートファイルシステムでは機能しません。
    </para>
   </listitem>
   <listitem>
    <para>
     <command>btrfs-balance</command>の場合、<filename>/etc/sysconfig/btrfsmaintenance</filename>の変数<literal>BTRFS_BALANCE_MOUNTPOINTS</literal>を<literal>/</literal>から<literal>/.snapshots</literal>に変更する必要があります。
    </para>
   </listitem>
   <listitem>
    <para>
     <command>btrfs-scrub</command>の場合、<filename>/etc/sysconfig/btrfsmaintenance</filename>の変数<literal>BTRFS_SCRUB_MOUNTPOINTS</literal>を<literal>/</literal>から<literal>/.snapshots</literal>に変更する必要があります。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec-install-tu">
  <title>有効化 <package>transactional-update</package></title>
  <para>
   システムのインストール時にトランザクショナルサーバモジュールを有効にし、トランザクショナルサーバシステム役割を選択する必要があります。実行しているシステムで後でトランザクショナルサーバモジュールからパッケージをインストールすることはサポートされておらず、システムが破損する可能性があります。
  </para>
  <para>
      ルートパーティションのサブボリュームレイアウトの変更または独自のパーティションへのルートパーティションのサブディレクトリまたはサブボリュームの配置(<filename>/home</filename>、<filename>/var</filename>、<filename>/srv</filename>、および<filename>/opt</filename>を除く)はサポートされておらず、システムが破損する可能性が高いことに注意してください。
  </para>
 </sect1>
 
  <sect1 xml:id="sec-tu-disable">
  <title>自動更新の管理</title>
  <para>
      自動更新は、1日1回実行する<command>systemd.timer</command>によって制御されます。これは、すべての更新に適用され、マシンが再起動する必要があることを<command>rebootmgrd</command>に知らせます。更新が実行される時刻を調整できます。systemd.timer(5)を参照してください。<command>rebootmgrd</command>がシステムを再起動するときのメンテナンス期間を調整するには、rebootmgrd(8)を参照してください。
  </para>
  <para>
   次のコマンドで自動トランザクション更新を無効にできます。
  </para>

<screen><prompt role="root"># </prompt><command>systemctl --now disable transactional-update.timer</command></screen>
</sect1>
 
 <sect1>
  <title><command>transactional-update</command>コマンド</title>
  <para>
   <command>transactional-update</command>コマンドは、更新のアトミックインストールまたは削除を有効にします。更新は、そのすべてが正常にインストールされた場合にのみ適用されます。<command>transactional-update</command>は、更新が適用される前にシステムのスナップショットを作成し、このスナップショットを復元できます。再起動後にのみ、すべての変更がアクティブになります。
  </para>

<variablelist>
  <varlistentry>
   <term><literal>--continue</literal></term>
   <listitem>
     <para>
         <command>--continue</command>オプションは、再起動せずに既存のスナップショットに複数の変更を行うためのものです。
     </para>
     <para>
         デフォルトの<command>transactional-update</command>動作は、現在のルートファイルシステムから新しいスナップショット作成することです。新しいパッケージのインストールなど、何かを忘れた場合は、再起動して以前の変更を適用し、<command>transactional-update</command>を再度実行して忘れたパッケージをインストールしてから再起動する必要があります。再起動せずに、スナップショットにさらに変更を追加するために<command>transactal-update</command>コマンドを複数回実行できません。これは、以前のスナップショットからの変更を含まない独立したスナップショットが作成されるためです。
     </para>
     <para>
         <command>--continue</command>オプションを使用して、再起動せずに必要なだけ変更を行います。別個のスナップショットが毎回作成され、各スナップショットには、以前のスナップショットで作成されたすべての変更、および新しい変更が含まれます。このプロセスを必要な回数だけ繰り返します。最終スナップショットに必要なものがすべて含まれている場合は、システムを再起動すると、最終スナップショットが新しいルートファイルシステムになります。
     </para>
     <para>
         <command>--continue</command>オプションのもう1つの便利な機能は、既存のスナップショットを新しいスナップショットのベースとして選択できることです。次の例では、<command>transactional-update</command>を実行して、スナップショット13に基づいてスナップショットに新しいパッケージをインストールしてから、もう一度実行して別のパッケージをインストールする方法を示しています。
     </para>
     <screen><prompt role="root"># </prompt><command>transactional-update pkg install <replaceable>package_1</replaceable></command></screen>
    <screen><prompt role="root"># </prompt><command>transactional-update --continue 13 pkg install <replaceable>package_2</replaceable></command></screen>
    <para>
        <command>--continue [num]</command>オプションは<command>snapper create --from</command>を呼び出します。<xref linkend="sec-snapper-manage-create"/>を参照してください。
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><literal>cleanup</literal></term>
   <listitem>
  <para>
    現在のルートファイルシステムがアクティブなルートファイルシステムと同一である場合(再起動後、<command>transactional-update</command>が更新を含む新しいスナップショットを作成する前)、クリーンアップアルゴリズムのないすべての古いスナップショットはクリーンアップアルゴリズムセットを取得します。これにより、古いスナップショットがSnapperによって確実に削除されます。(snapper(8)のクリーンアップアルゴリズムに関するセクションを参照してください。)これにより、<filename>/var/lib/overlay</filename>内の参照されていない(したがって未使用の)<filename>/etc</filename>オーバーレイディレクトリもすべて削除されます。
  </para>
<screen><prompt role="root"># </prompt><command>transactional-update cleanup</command></screen>
    </listitem>
   </varlistentry>  
   <varlistentry>
    <term><literal>pkg in/install</literal></term>
    <listitem>
     <para>
      <command>zypper install</command>コマンドを使用して、使用可能なチャネルから個々のパッケージをインストールします。このコマンドは、Program Temporary Fix (PTF) RPMファイルをインストールするために使用することもできます。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update pkg install <replaceable>package_name</replaceable></command></screen>
     <para>
      あるいは、
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update pkg install <replaceable>rpm1 rpm2</replaceable></command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>pkg rm/remove</literal></term>
    <listitem>
     <para>
      <command>zypper remove</command>コマンドを使用してアクティブなスナップショットから個々のパッケージを削除します。このコマンドは、PTF RPMファイルを削除するために使用することもできます。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update pkg remove <replaceable>package_name</replaceable></command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>pkg up/update</literal></term>
    <listitem>
     <para>
      <command>zypper update</command>コマンドを使用してアクティブなスナップショットから個々のパッケージを更新します。ベースファイルシステムのスナップショットの一部であるパッケージのみを更新できます。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update pkg remove <replaceable>package_name</replaceable></command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>up/update</literal></term>
    <listitem>
     <para>
      使用可能な新しい更新がある場合、新しいスナップショットが作成され、<command>zypper up/update</command>がスナップショットを更新します。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update up</command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>dup</literal></term>
    <listitem>
     <para>
      使用可能な新しい更新がある場合、新しいスナップショットが作成され、<command>zypper dup –no-allow-vendor-change</command>がスナップショットを更新します。スナップショットは後で有効にされ、再起動後に新しいルートファイルシステムになります。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update dup</command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>patch</literal></term>
    <listitem>
     <para>
      使用可能な新しい更新がある場合、新しいスナップショットが作成され、<command>zypper patch</command>がスナップショットを更新します。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update patch</command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>rollback</literal></term>
    <listitem>
     <para>
      これはデフォルトのサブボリュームを設定します。読み書き可能なファイルシステムを備えたシステムでは、<command>snapper rollback</command>が呼び出されます。読み込み専用ファイルシステムで引数を指定しない場合、現在のシステムは新しいデフォルトのルートファイルシステムに設定されます。数値を指定する場合、スナップショットがデフォルトのルートファイルシステムとして使用されます。読み込み専用ファイルシステムでは、追加のスナップショットは作成されません。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update rollback <replaceable>snapshot_number</replaceable></command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>grub.cfg</literal></term>
    <listitem>
     <para>
      これは、新しいGRUB2設定を作成します。カーネルパラメータの追加など、ブート設定の調整が必要になる場合があります。<replaceable>/etc/default/grub</replaceable>を編集し、<command>transactional-update grub.cfg</command>を実行して、再起動して変更を有効にします。直接再起動する必要があります。そうしないと、新しいGRUB2設定が次のトランザクション更新によってデフォルトで上書きされます。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update grub.cfg</command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>reboot</literal></term>
    <listitem>
     <para>
      このパラメータは、アクションが完了した後に再起動をトリガーします。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update <replaceable>dup</replaceable> reboot</command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>--help</literal></term>
    <listitem>
     <para>
      これにより、オプションとサブコマンドを含むヘルプ画面が印刷されます。
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update --help</command></screen>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>

 <sect1 xml:id="sec-tu-troubleshooting">
  <title>トラブルシューティング</title>

  <para>
   アップグレードが失敗する場合は、<command>supportconfig</command>を実行して、ログデータを収集します。<filename>/var/log/transactional-update.log</filename>を含む結果のファイルをSUSEサポートに提供します。
  </para>
 </sect1>
</chapter>
