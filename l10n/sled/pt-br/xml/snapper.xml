<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="snapper.xml" version="5.0" xml:id="cha-snapper"> <title>Recuperação de sistema e gerenciamento de instantâneos com o Snapper</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:bugtracker/>
        <dm:translation>yes</dm:translation>
      </dm:docmanager>
      <abstract>
        <para>
    O Snapper permite criar e gerenciar instantâneos de sistema de arquivos. Os instantâneos de sistema de arquivos permitem manter uma cópia do estado de um sistema de arquivos em um determinado momento. A configuração padrão do Snapper foi projetada para permitir voltar modificações feitas no sistema. No entanto, você pode usá-la também para criar backups em disco dos dados dos usuários. Como base para essa funcionalidade, o Snapper usa o sistema de arquivos Btrfs ou os volumes LVM com aprovisionamento dinâmico com um sistema de arquivos XFS ou Ext4.
   </para>
      </abstract>
    </info>
    <para>
  O Snapper tem uma interface de linha de comando e uma interface do YaST. O Snapper permite criar e gerenciar instantâneos nos seguintes tipos de sistema de arquivos:
 </para>
 <itemizedlist>
  <listitem>
   <para>
    Btrfs, um sistema de arquivos de cópia em gravação para Linux que suporta de forma nativa os instantâneos de sistema de arquivos de subvolumes. (Os subvolumes são sistemas de arquivos que podem ser montados separadamente em uma partição física.)
   </para>
   <para>
    Também é possível inicializar por meio de instantâneos do <literal>Btrfs</literal>. Para obter mais informações, consulte a <xref linkend="sec-snapper-snapshot-boot"/>. 
   </para>
  </listitem>
  <listitem>
   <para>
    Volumes LVM com aprovisionamento dinâmico formatados com XFS ou Ext4.
   </para>
  </listitem>
 </itemizedlist>
 <para>
  Usando o Snapper, é possível executar as seguintes tarefas:
 </para>
 <itemizedlist mark="bullet" spacing="normal">
  <listitem>
   <para>
    Desfazer mudanças no sistema feitas pelo <command>zypper</command> e pelo YaST. Consulte a <xref linkend="sec-snapper-undo"/> para obter os detalhes. 
   </para>
  </listitem>
  <listitem>
   <para>
    Restaurar arquivos de instantâneos anteriores. Consulte a <xref linkend="sec-snapper-undo-delete-file"/> para obter os detalhes. 
   </para>
  </listitem>
  <listitem>
   <para>
    Fazer rollback do sistema inicializando de um instantâneo. Consulte a <xref linkend="sec-snapper-snapshot-boot"/> para obter os detalhes. 
   </para>
  </listitem>
  <listitem>
   <para>
    Criar e gerenciar instantâneos manualmente, no sistema em execução. Consulte a <xref linkend="sec-snapper-manage"/> para obter os detalhes.
   </para>
  </listitem>
 </itemizedlist>

 <sect1 xml:id="sec-snapper-setup">
  <title>Configuração padrão</title>

  <para>
   O Snapper no <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> foi configurado como uma ferramenta para desfazer e recuperar mudanças no sistema. Por padrão, a partição raiz (<filename>/</filename>) do <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> está formatada com <literal>Btrfs</literal>. A captura de instantâneos será automaticamente habilitada se a partição raiz (<filename>/</filename>) for grande o suficiente (mais do que aproximadamente 16 GB). Por padrão, os instantâneos estão desabilitados em partições que não são <filename>/</filename>.
  </para>

  <tip>
   <title>Habilitando o Snapper no sistema instalado</title>
   <para>
    Se você desabilitou o Snapper durante a instalação, pode habilitá-lo a qualquer momento no futuro. Para fazer isso, crie uma configuração padrão do Snapper para o sistema de arquivos raiz executando:
   </para>
   <screen><prompt>tux &gt; </prompt><command>sudo</command> snapper -c root create-config /</screen>
   <para>
    Em seguida, habilite os tipos diferentes de instantâneo conforme descrito na <xref linkend="sec-snapper-setup-customize-auto-snapshots"/>.
   </para>
   <para>
    Em um sistema de arquivos raiz Btrfs, observe que os instantâneos exigem um sistema de arquivos com subvolumes configurados conforme proposto pelo instalador e uma partição de pelo menos 16 GB.
   </para>
  </tip>

  <para>
   Quando um instantâneo é criado, tanto o instantâneo quanto o original apontam para os mesmos blocos no sistema de arquivos. Por isso, o instantâneo inicialmente não ocupa espaço adicional no disco. Se os dados do sistema de arquivos original forem modificados, os blocos dos dados modificados serão copiados, enquanto os blocos dos dados antigos serão mantidos no instantâneo. Portanto, o instantâneo ocupa a mesma quantidade de espaço que os dados modificados. Ao longo do tempo, a quantidade de espaço alocada por um instantâneo cresce constantemente. Como consequência, a exclusão de arquivos do sistema de arquivos <literal>Btrfs</literal> que contém instantâneos pode <emphasis>não</emphasis> liberar espaço em disco!
  </para>

  <note>
   <title>Local do instantâneo</title>
   <para>
    Os instantâneos residem sempre na mesma partição ou subvolume no qual foram criados. Não é possível armazenar os instantâneos em uma partição ou um subvolume diferente.
   </para>
  </note>

  <para>
   Como resultado, as partições com instantâneos precisam ser maiores do que as partições sem instantâneos. A quantidade exata depende bastante do número de instantâneos mantidos e do volume de modificações de dados. Como uma regra geral, atribua às partições o dobro de espaço do que o de costume. Para evitar que os discos fiquem sem espaço, os instantâneos antigos são limpos automaticamente. Consulte o <xref linkend="sec-snapper-setup-customize-archiving"/> para obter os detalhes.
  </para>

  <sect2 xml:id="snapper-default-settings">
   <title>Configurações padrão</title>
   <variablelist>
    <varlistentry>
     <term>Discos com mais de 16 GB</term>
     <listitem>
      <itemizedlist>
       <listitem><para>Arquivo de configuração: <filename>/etc/snapper/configs/root</filename></para></listitem>
       <listitem><para><literal>USE_SNAPPER=yes</literal></para></listitem>
       <listitem><para><literal>TIMELINE_CREATE=no</literal></para></listitem>
      </itemizedlist>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Discos com menos de 16 GB</term>
     <listitem>
      <itemizedlist>
       <listitem><para>Arquivo de configuração: não criado</para></listitem>
       <listitem><para><literal>USE_SNAPPER=no</literal></para></listitem>
       <listitem><para><literal>TIMELINE_CREATE=yes</literal></para></listitem>
      </itemizedlist>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="snapper-snapshot-type">
   <title>Tipos de instantâneos</title>
   <para>
    Embora os próprios instantâneos não se diferenciem no sentido técnico, nós os distinguimos entre três tipos, com base nos eventos em que foram acionados:
   </para>
   <variablelist>
    <varlistentry>
     <term>Instantâneos de linha do tempo</term>
     <listitem>
      <para>
       Um único instantâneo é criado a cada hora. Instantâneos antigos são apagados automaticamente. Por padrão, o primeiro instantâneo dos últimos dez dias, meses e anos são mantidos. Por padrão, os instantâneos de linha do tempo são habilitados.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Instantâneos de instalação</term>
     <listitem>
      <para>
       Sempre que um ou mais pacotes são instalados com o YaST ou o Zypper, um par de instantâneos é criado: um antes do início da instalação (<quote>Pré</quote>) e outro após o término da instalação (<quote>Pós</quote>). Se um componente importante do sistema, como o kernel, for instalado, o par de instantâneos será marcado como importante (<literal>important=yes</literal>). Instantâneos antigos são apagados automaticamente. Por padrão, os dez últimos instantâneos importantes e os dez últimos instantâneos <quote>regulares</quote> (incluindo os instantâneos de administração) são mantidos. Instantâneos de instalação são habilitados, por padrão.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Instantâneos de administração</term>
     <listitem>
      <para>
       Sempre que você administra o sistema com o YaST, um par de instantâneos é criado: um quando algum módulo do YaST é iniciado (<quote>Pré</quote>) e outro quando o módulo é fechado (<quote>Pós</quote>). Instantâneos antigos são apagados automaticamente. Por padrão, os dez últimos instantâneos importantes e os dez últimos instantâneos <quote>regulares</quote> (incluindo os instantâneos de instalação) são mantidos. Instantâneos de administração são habilitados, por padrão.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="snapper-dir-excludes">
   <title>Diretórios que são excluídos dos instantâneos</title>
   <para>
    Alguns diretórios precisam ser excluídos dos instantâneos por diversos motivos. A seguinte lista mostra todos os diretórios que são excluídos:
   </para>
   <xi:include href="snapshot_excludes_i.xml"/>
  </sect2>

  <sect2 xml:id="sec-snapper-setup-customize">
   <title>Personalizando a configuração</title>
   <para>
    O <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> vem com uma configuração padrão lógica, que deve ser suficiente na maioria dos casos de uso. No entanto, todos os aspectos da criação automática e da manutenção de instantâneos podem ser configurados de acordo com as suas necessidades.
   </para>
   <sect3 xml:id="sec-snapper-setup-customize-auto-snapshots">
    <title>Desabilitando/Habilitando instantâneos</title>
    <para>
     Cada um dos três tipos de instantâneos (linha do tempo, instalação, administração) pode ser habilitado ou desabilitado de forma independente.
    </para>
    <variablelist>
     <varlistentry>
      <term>Desabilitando/Habilitando instantâneos de linha do tempo</term>
      <listitem>
       <formalpara>
        <title>Habilitar</title>
        <para>
         <command>snapper -c root set-config "TIMELINE_CREATE=yes"</command>
        </para>
       </formalpara>
       <formalpara>
        <title>Desabilitar</title>
        <para>
         <command>snapper -c root set-config "TIMELINE_CREATE=no"</command>
        </para>
       </formalpara>
       <para>
        Os instantâneos de linha do tempo estão habilitados por padrão, exceto para a partição raiz.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Desabilitando/Habilitando instantâneos de instalação</term>
      <listitem>
       <formalpara>
        <title>Habilitar:</title>
        <para>
         Instale o pacote <systemitem class="resource">snapper-zypp-plugin</systemitem>
        </para>
       </formalpara>
       <formalpara>
        <title>Desabilitar:</title>
        <para>
         Desinstale o pacote <systemitem class="resource">snapper-zypp-plugin</systemitem>
        </para>
       </formalpara>
       <para>
        Instantâneos de instalação são habilitados, por padrão.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Desabilitando/Habilitando instantâneos de administração</term>
      <listitem>
       <formalpara>
        <title>Habilitar:</title>
        <para>
         Defina <envar>USE_SNAPPER</envar> como <literal>yes</literal> em <filename>/etc/sysconfig/yast2</filename>.
        </para>
       </formalpara>
       <formalpara>
        <title>Desabilitar:</title>
        <para>
         Defina <envar>USE_SNAPPER</envar> como <literal>no</literal> em <filename>/etc/sysconfig/yast2</filename>.
        </para>
       </formalpara>
       <para>
        Instantâneos de administração são habilitados, por padrão.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="sec-snapper-setup-customize-inst-snapshots">
    <title>Controlando instantâneos de instalação</title>
    <para>
     A criação de pares de instantâneos ao instalar pacotes com o YaST ou o Zypper é administrada pelo <systemitem class="resource">snapper-zypp-plugin</systemitem>. O arquivo de configuração XML <filename>/etc/snapper/zypp-plugin.conf</filename> define quando criar instantâneos. Por padrão, o arquivo é parecido com o seguinte:
    </para>
<screen> 1 &lt;?xml version="1.0" encoding="utf-8"?&gt;
 2 &lt;snapper-zypp-plugin-conf&gt;
 3  &lt;solvables&gt;
 4   &lt;solvable match="w"<co xml:id="zypp-conf-match"/> important="true"<co xml:id="zypp-conf-important"/>&gt;kernel-*<co xml:id="zypp-conf-kernel"/>&lt;/solvable&gt;
 5   &lt;solvable match="w" important="true"&gt;dracut&lt;/solvable&gt;
 6   &lt;solvable match="w" important="true"&gt;glibc&lt;/solvable&gt;
 7   &lt;solvable match="w" important="true"&gt;systemd*&lt;/solvable&gt;
 8   &lt;solvable match="w" important="true"&gt;udev&lt;/solvable&gt;
 9   &lt;solvable match="w"&gt;*&lt;/solvable&gt;<co xml:id="zypp-conf-packages"/>
10  &lt;/solvables&gt;
11 &lt;/snapper-zypp-plugin-conf&gt;</screen>
    <calloutlist>
     <callout arearefs="zypp-conf-match">
      <para>
       O atributo de correspondência define se o padrão é um curinga no estilo shell do Unix (<literal>w</literal>) ou uma expressão regular Python (<literal>re</literal>).
      </para>
     </callout>
     <callout arearefs="zypp-conf-important">
      <para>
       Se houver correspondência do padrão especificado e o pacote correspondente estiver marcado como importante (por exemplo, pacotes do kernel), o instantâneo também será marcado como importante.
      </para>
     </callout>
     <callout arearefs="zypp-conf-kernel">
      <para>
       Padrão de correspondência com o nome de um pacote. Com base na configuração do atributo <literal>match</literal>, caracteres especiais são interpretados como curingas do shell ou expressões regulares. Este padrão corresponde todos os nomes de pacotes que começam com <literal>kernel-</literal>.
      </para>
     </callout>
     <callout arearefs="zypp-conf-packages">
      <para>
       Esta linha corresponde todos os pacotes incondicionalmente.
      </para>
     </callout>
    </calloutlist>
    <para>
     Com este instantâneo de configuração, os pares são criados sempre que um pacote é instalado (linha 9). Quando são instalados pacotes do kernel, dracut, glibc, systemd ou udev marcados como importantes, o par de instantâneos também é marcado como importante (linhas 4 a 8). Todas as regras são avaliadas.
    </para>
    <para>
     Para desabilitar uma regra, apague-a ou desative-a usando comentários XML. Para impedir que o sistema crie pares de instantâneos para cada pacote de instalação, por exemplo, comente na linha 9:
    </para>
<screen> 1 &lt;?xml version="1.0" encoding="utf-8"?&gt;
 2 &lt;snapper-zypp-plugin-conf&gt;
 3  &lt;solvables&gt;
 4   &lt;solvable match="w" important="true"&gt;kernel-*&lt;/solvable&gt;
 5   &lt;solvable match="w" important="true"&gt;dracut&lt;/solvable&gt;
 6   &lt;solvable match="w" important="true"&gt;glibc&lt;/solvable&gt;
 7   &lt;solvable match="w" important="true"&gt;systemd*&lt;/solvable&gt;
 8   &lt;solvable match="w" important="true"&gt;udev&lt;/solvable&gt;
 9   &lt;!-- &lt;solvable match="w"&gt;*&lt;/solvable&gt; --&gt;
10  &lt;/solvables&gt;
11 &lt;/snapper-zypp-plugin-conf&gt;</screen>
   </sect3>
   <sect3 xml:id="sec-snapper-setup-customizing-new-subvolume">
    <title>Criando e montando novos subvolumes</title>
    <para>
     A criação de um novo subvolume abaixo da hierarquia <filename>/</filename> e sua montagem permanente são suportadas. Esse tipo de subvolume será excluído dos instantâneos. Não o crie dentro de um instantâneo existente, pois você não poderá mais apagar os instantâneos após um rollback.
    </para>
    <para>
     O <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> está configurado com o subvolume <filename>/@/</filename>, que serve como uma raiz independente para subvolumes permanentes, como <filename>/opt</filename>, <filename>/srv</filename>, <filename>/home</filename>, etc. Qualquer subvolume novo que você cria e monta permanentemente precisa ser criado nesse sistema de arquivos raiz inicial.
    </para>
    <para>
     Para isso, execute os comandos a seguir. Neste exemplo, um novo subvolume <filename>/usr/important</filename> é criado do <filename>/dev/sda2</filename>.
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> mount /dev/sda2 -o subvol=@ /mnt
<prompt>tux &gt; </prompt><command>sudo</command> btrfs subvolume create /mnt/usr/important
<prompt>tux &gt; </prompt><command>sudo</command> umount /mnt</screen>
    <para>
     A entrada correspondente em <filename>/etc/fstab</filename> precisa ter a seguinte aparência:
    </para>
    <screen>/dev/sda2 /usr/important btrfs subvol=@/usr/important 0 0</screen>

    <tip>
     <title>Desabilitar Cópia em Gravação (COW, Copy-On-Write)</title>
     <para>
      Um subvolume pode conter arquivos que mudam constantemente, como imagens de disco virtualizado, arquivos de banco de dados ou arquivos de registro. Se este for o caso, considere desabilitar o recurso de cópia em gravação para este volume a fim de evitar a duplicação de blocos de disco. Use a opção de montagem <option>nodatacow</option> em <filename>/etc/fstab</filename> para fazer isso:
     </para>
     <screen>/dev/sda2 /usr/important btrfs nodatacow,subvol=@/usr/important 0 0</screen>
     <para>
      Como alternativa, para desabilitar a cópia em gravação para arquivos ou diretórios separados, use o comando <command>chattr +C <replaceable>CAMINHO</replaceable></command>.
     </para>
    </tip>

   </sect3>
   <sect3 xml:id="sec-snapper-setup-customize-archiving">
    <title>Controlando o armazenamento de instantâneos</title>
    <para>
     Instantâneos ocupam espaço no disco. Para evitar que os discos fiquem sem espaço e, por essa razão, provoquem interrupções no sistema, os instantâneos antigos são apagados automaticamente. Por padrão, no máximo dez instantâneos de instalação e administração importantes e dez regulares são mantidos. Se esses instantâneos ocuparem mais do que 50% do tamanho do sistema de arquivos raiz, os instantâneos adicionais serão apagados. Sempre é mantido um mínimo de quatro instantâneos importantes e dois regulares.
    </para>
    <para>
     Consulte a <xref linkend="sec-snapper-config-modify"/> para ver instruções sobre como mudar os valores.
    </para>
   </sect3>
   <sect3 xml:id="sec-snapper-lvm">
    <title>Usando o Snapper em volumes LVM com aprovisionamento dinâmico</title>
    <para>
     Além dos instantâneos nos sistemas de arquivos <literal>Btrfs</literal>, o Snapper também suporta criação de instantâneos em volumes LVM com aprovisionamento dinâmico (instantâneos em volumes LVM regulares <emphasis>não</emphasis> são suportados) formatados com XFS, Ext4 ou Ext3. Para obter mais informações e instruções de configuração de volumes LVM, consulte a <xref linkend="sec-yast-system-lvm"/>.
    </para>
    <para>
     Para usar o Snapper em um volume LVM com aprovisionamento dinâmico, você precisa criar para ele uma configuração do Snapper. No LVM, é necessário especificar o sistema de arquivos com <option>--fstype=lvm(<replaceable>SISTEMADEARQUIVOS</replaceable>)</option>. <literal>ext3</literal>, <literal>etx4</literal> ou <literal>xfs</literal> são valores válidos para <replaceable>SISTEMADEARQUIVOS</replaceable>. Exemplo:
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper -c lvm create-config --fstype="lvm(xfs)" /thin_lvm</screen>
    <para>
     É possível ajustar essa configuração de acordo com as suas necessidades conforme descrito na <xref linkend="sec-snapper-config-modify"/>.
    </para>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-snapper-undo">
  <title>Usando o Snapper para desfazer mudanças</title>

  <para>
   O Snapper no <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> é pré-configurado para atuar como uma ferramenta capaz de desfazer as mudanças feitas pelo <command>zypper</command> e pelo YaST. Para esta finalidade, o Snapper é configurado para criar um par de instantâneos antes e depois de cada execução do <command>zypper</command> e do YaST. O Snapper permite também restaurar arquivos do sistema que foram acidentalmente apagados ou modificados. Os instantâneos de linha do tempo da partição raiz precisam ser habilitados para essa finalidade. Consulte a <xref linkend="sec-snapper-setup-customize-auto-snapshots"/> para obter detalhes.
  </para>

  <para>
   Por padrão, os instantâneos automáticos, conforme descrito anteriormente, são configurados para a partição raiz e seus subvolumes. Para disponibilizar os instantâneos para outras partições, como <filename>/home</filename>, é possível criar configurações personalizadas.
  </para>

  <important>
   <title>Comparação entre desfazer mudanças e rollback</title>
   <para>
    Ao trabalhar com instantâneos para restaurar dados, é importante saber que há dois cenários fundamentalmente distintos nos quais o Snapper pode atuar:
   </para>
   <variablelist>
    <varlistentry>
     <term>Desfazendo mudanças</term>
     <listitem>
      <para>
       Ao desfazer mudanças conforme descrito a seguir, dois instantâneos são comparados, e as mudanças entre eles são desfeitas. O uso deste método também permite selecionar explicitamente os arquivos que devem ser restaurados.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Rollback</term>
     <listitem>
      <para>
       Ao fazer rollbacks conforme descrito na <xref linkend="sec-snapper-snapshot-boot"/>, o sistema é redefinido para o estado do momento em que o instantâneo foi criado.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <para>
    Ao desfazer mudanças, é possível também comparar um instantâneo com o sistema atual. Ao restaurar <emphasis>todos</emphasis> os arquivos com base nesta comparação, o resultado será igual a fazer rollback. No entanto, o uso do método descrito na <xref linkend="sec-snapper-snapshot-boot"/> para rollbacks deve ser preferencial, pois é mais rápido e permite revisar o sistema antes de fazer rollback.
   </para>
  </important>

  <warning>
   <title>Consistência de dados</title>
   <para>
    Não existe nenhum mecanismo que assegure a consistência dos dados ao criar um instantâneo. Sempre que um arquivo (por exemplo, um banco de dados) for gravado enquanto o instantâneo estiver sendo criado, o resultado será um arquivo corrompido ou parcialmente gravado. A restauração desse arquivo causa problemas. Além disso, alguns arquivos do sistema, como <filename>/etc/mtab</filename>, nunca devem ser restaurados. Portanto, é altamente recomendável <emphasis>sempre</emphasis> revisar com cuidado a lista de arquivos modificados e suas diffs. Restaure apenas arquivos realmente relevantes à ação que deseja reverter.
   </para>
  </warning>

  <sect2 xml:id="sec-snapper-undo-yast">
   <title>Desfazendo mudanças do YaST e do Zypper</title>
   <para>
    Se você configurar a partição raiz com o <literal>Btrfs</literal> durante a instalação, o Snapper (pré-configurado para fazer rollback das mudanças do YaST ou do Zypper) será instalado automaticamente. Sempre que você iniciar um módulo do YaST ou uma transação do Zypper, serão criados dois instantâneos: um <quote>pré-instantâneo</quote>, que captura o estado do sistema de arquivos antes do início do módulo, e um <quote>pós-instantâneo</quote> após o término do módulo.
   </para>
   <para>
    Usando o módulo Snapper do YaST ou a ferramenta de linha de comando <command>snapper</command>, é possível desfazer as mudanças feitas pelo YaST/Zypper restaurando os arquivos do <quote>pré-instantâneo</quote>. Pela comparação dos dois instantâneos, as ferramentas permitem ver quais arquivos foram modificados. É possível também exibir as diferenças entre as duas versões de um arquivo (diff).
   </para>
   <procedure xml:id="proc-snapper-undo-yast">
    <title>Desfazendo mudanças usando o módulo <guimenu>Snapper</guimenu> do YaST</title>
    <step>
     <para>
      Inicie o módulo <guimenu>Snapper</guimenu> pela seção <guimenu>Diversos</guimenu> no YaST ou digitando <command>yast2 snapper</command>.
     </para>
    </step>
    <step>
     <para>
      Confirme se a <guimenu>Configuração Atual</guimenu> está definida como <guimenu>root</guimenu>. Esse é sempre o caso, a não ser que você tenha adicionado manualmente configurações personalizadas do Snapper.
     </para>
    </step>
    <step>
     <para>
      Escolha o par de pré e pós-instantâneos na lista. Ambos os pares de instantâneos do YaST e do Zypper são do tipo <guimenu>Pré e Pós</guimenu>. Os instantâneos do YaST são denominados <literal>zypp(y2base)</literal> na <guimenu>coluna Descrição</guimenu>; os instantâneos do Zypper são denominados <literal>zypp(zypper)</literal>.
     </para>
     <informalfigure>
      <mediaobject>
       <imageobject role="fo">
        <imagedata fileref="snapper_yast2_list.png" width="75%" format="PNG"/>
       </imageobject>
       <imageobject role="html">
        <imagedata fileref="snapper_yast2_list.png" width="75%" format="PNG"/>
       </imageobject>
      </mediaobject>
     </informalfigure>
    </step>
    <step>
     <para>
      Clique em <guimenu>Mostrar Mudanças</guimenu> para abrir a lista de arquivos que são diferentes entre os dois instantâneos.
     </para>
     <informalfigure>
      <mediaobject>
       <imageobject role="fo">
        <imagedata fileref="snapper_yast2_changes.png" width="75%" format="PNG"/>
       </imageobject>
       <imageobject role="html">
        <imagedata fileref="snapper_yast2_changes.png" width="75%" format="PNG"/>
       </imageobject>
      </mediaobject>
     </informalfigure>
    </step>
    <step>
     <para>
      Revise a lista de arquivos. Para exibir a diferença (<quote>diff</quote>) entre a versão pré e pós de um arquivo, selecione-o na lista.
     </para>
     <informalfigure>
      <mediaobject>
       <imageobject role="fo">
        <imagedata fileref="snapper_yast2_diff.png" width="65%" format="PNG"/>
       </imageobject>
       <imageobject role="html">
        <imagedata fileref="snapper_yast2_diff.png" width="75%" format="PNG"/>
       </imageobject>
      </mediaobject>
     </informalfigure>
    </step>
    <step>
     <para>
      Para restaurar um ou mais arquivos, selecione os arquivos ou diretórios relevantes marcando a respectiva caixa de seleção. Clique em <guimenu>Restaurar Selecionados</guimenu> e clique em <guimenu>Sim</guimenu> para confirmar a ação.
     </para>
     <informalfigure>
      <mediaobject>
       <imageobject role="fo">
        <imagedata fileref="snapper_yast2_restore.png" width="75%" format="PNG"/>
       </imageobject>
       <imageobject role="html">
        <imagedata fileref="snapper_yast2_restore.png" width="75%" format="PNG"/>
       </imageobject>
      </mediaobject>
     </informalfigure>
     <para>
      Para restaurar um único arquivo, ative sua tela de comparação clicando em seu nome. Clique em <guimenu>Restaurar a partir do Primeiro</guimenu> e clique em <guimenu>Sim</guimenu> para confirmar sua seleção.
     </para>
    </step>
   </procedure>
   <procedure xml:id="proc-snapper-yast-cmdline">
    <title>Desfazendo mudanças usando o comando <command>snapper</command></title>
    <step>
     <para>
      Obtenha uma lista dos instantâneos do YaST e do Zypper executando o comando <command>snapper list -t pre-post</command>. Os instantâneos do YaST são denominados <literal>yast <replaceable>NOME_DO_MÓDULO</replaceable></literal> na <guimenu>coluna Descrição</guimenu>. Os instantâneos do Zypper são denominados <literal>zypp(zypper)</literal>.
     </para>
<screen><?dbsuse-fo font-size="0.60em"?>

<prompt>tux &gt; </prompt><command>sudo</command> snapper list -t pre-post
Pre # | Post # | Pre Date                      | Post Date                     | Description
------+--------+-------------------------------+-------------------------------+--------------
311   | 312    | Tue 06 May 2018 14:05:46 CEST | Tue 06 May 2018 14:05:52 CEST | zypp(y2base)
340   | 341    | Wed 07 May 2018 16:15:10 CEST | Wed 07 May 2018 16:15:16 CEST | zypp(zypper)
342   | 343    | Wed 07 May 2018 16:20:38 CEST | Wed 07 May 2018 16:20:42 CEST | zypp(y2base)
344   | 345    | Wed 07 May 2018 16:21:23 CEST | Wed 07 May 2018 16:21:24 CEST | zypp(zypper)
346   | 347    | Wed 07 May 2018 16:41:06 CEST | Wed 07 May 2018 16:41:10 CEST | zypp(y2base)
348   | 349    | Wed 07 May 2018 16:44:50 CEST | Wed 07 May 2018 16:44:53 CEST | zypp(y2base)
350   | 351    | Wed 07 May 2018 16:46:27 CEST | Wed 07 May 2018 16:46:38 CEST | zypp(y2base) </screen>
    </step>
    <step>
     <para>
      Obtenha uma lista dos arquivos modificados de um par de instantâneos com <command>snapper status </command>
      <replaceable>PRÉ</replaceable>..<replaceable>PÓS</replaceable>. Os arquivos com mudanças de conteúdo são marcados com <guimenu>c</guimenu>, os arquivos que foram adicionados são marcados com <guimenu>+</guimenu> e os arquivos apagados são marcados com <guimenu>-</guimenu>.
     </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper status 350..351
+..... /usr/share/doc/packages/mikachan-fonts
+..... /usr/share/doc/packages/mikachan-fonts/COPYING
+..... /usr/share/doc/packages/mikachan-fonts/dl.html
c..... /usr/share/fonts/truetype/fonts.dir
c..... /usr/share/fonts/truetype/fonts.scale
+..... /usr/share/fonts/truetype/みかちゃん-p.ttf
+..... /usr/share/fonts/truetype/みかちゃん-pb.ttf
+..... /usr/share/fonts/truetype/みかちゃん-ps.ttf
+..... /usr/share/fonts/truetype/みかちゃん.ttf
c..... /var/cache/fontconfig/7ef2298fde41cc6eeb7af42e48b7d293-x86_64.cache-4
c..... /var/lib/rpm/Basenames
c..... /var/lib/rpm/Dirnames
c..... /var/lib/rpm/Group
c..... /var/lib/rpm/Installtid
c..... /var/lib/rpm/Name
c..... /var/lib/rpm/Packages
c..... /var/lib/rpm/Providename
c..... /var/lib/rpm/Requirename
c..... /var/lib/rpm/Sha1header
c..... /var/lib/rpm/Sigmd5</screen>
    </step>
    <step>
     <para>
      Para exibir a diff de determinado arquivo, execute <command>snapper diff</command>
      <replaceable>PRÉ</replaceable>..<replaceable>PÓS</replaceable>
      <replaceable>NOMEDOARQUIVO</replaceable>. Se você não especificar <replaceable>NOMEDOARQUIVO</replaceable>, será exibida a diff de todos os arquivos.
     </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper diff 350..351 /usr/share/fonts/truetype/fonts.scale
--- /.snapshots/350/snapshot/usr/share/fonts/truetype/fonts.scale       2014-04-23 15:58:57.000000000 +0200
+++ /.snapshots/351/snapshot/usr/share/fonts/truetype/fonts.scale       2014-05-07 16:46:31.000000000 +0200
@@ -1,4 +1,4 @@
-1174
+1486
 ds=y:ai=0.2:luximr.ttf -b&amp;h-luxi mono-bold-i-normal--0-0-0-0-c-0-iso10646-1
 ds=y:ai=0.2:luximr.ttf -b&amp;h-luxi mono-bold-i-normal--0-0-0-0-c-0-iso8859-1
[...]</screen>
    </step>
    <step>
     <para>
      Para restaurar um ou mais arquivos, execute <command>snapper -v undochange</command>
      <replaceable>PRÉ</replaceable>..<replaceable>PÓS</replaceable>
      <replaceable>NOMESDOSARQUIVOS</replaceable>. Se você não especificar os <replaceable>NOMESDOSARQUIVOS</replaceable>, todos os arquivos serão restaurados.
     </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper -v undochange 350..351
     create:0 modify:13 delete:7
     undoing change...
     deleting /usr/share/doc/packages/mikachan-fonts
     deleting /usr/share/doc/packages/mikachan-fonts/COPYING
     deleting /usr/share/doc/packages/mikachan-fonts/dl.html
     deleting /usr/share/fonts/truetype/みかちゃん-p.ttf
     deleting /usr/share/fonts/truetype/みかちゃん-pb.ttf
     deleting /usr/share/fonts/truetype/みかちゃん-ps.ttf
     deleting /usr/share/fonts/truetype/みかちゃん.ttf
     modifying /usr/share/fonts/truetype/fonts.dir
     modifying /usr/share/fonts/truetype/fonts.scale
     modifying /var/cache/fontconfig/7ef2298fde41cc6eeb7af42e48b7d293-x86_64.cache-4
     modifying /var/lib/rpm/Basenames
     modifying /var/lib/rpm/Dirnames
     modifying /var/lib/rpm/Group
     modifying /var/lib/rpm/Installtid
     modifying /var/lib/rpm/Name
     modifying /var/lib/rpm/Packages
     modifying /var/lib/rpm/Providename
     modifying /var/lib/rpm/Requirename
     modifying /var/lib/rpm/Sha1header
     modifying /var/lib/rpm/Sigmd5
     undoing change done</screen>
    </step>
   </procedure>
   <warning>
    <title>Revertendo adições de usuário</title>
    <para>
     Não é recomendado reverter adições de usuário desfazendo mudanças com o Snapper. Como alguns diretórios são excluídos dos instantâneos, os arquivos pertencentes a estes usuários permanecerão no sistema de arquivos. Se for criado um usuário com o mesmo ID de usuário daquele que foi apagado, ele herdará os arquivos. Portanto, é altamente recomendável usar a ferramenta <guimenu>Gerenciamento de Usuários e Grupos</guimenu> do YaST para remover usuários.
    </para>
   </warning>
  </sect2>

  <sect2 xml:id="sec-snapper-undo-delete-file">
   <title>Usando o Snapper para restaurar arquivos</title>
   <para>
    Além dos instantâneos de instalação e administração, o Snapper cria instantâneos de linha do tempo. É possível usar os instantâneos de backup para restaurar arquivos que foram apagados acidentalmente ou para restaurar a versão anterior de um arquivo. Usando o recurso diff do Snapper, é possível também descobrir quais modificações foram feitas em um período específico.
   </para>
   <para>
    A capacidade de restaurar arquivos é interessante principalmente no que diz respeito a dados, que podem residir em subvolumes ou partições dos quais os instantâneos não são criados por padrão. Para restaurar arquivos de diretórios pessoais, por exemplo, crie uma configuração separada do Snapper para <filename>/home</filename> para criar instantâneos de linha do tempo automáticos. Consulte a <xref linkend="sec-snapper-config"/> para obter instruções.
   </para>
   <warning>
    <title>Comparação entre restaurar arquivos e rollback</title>
    <para>
     Os instantâneos criados do sistema de arquivos raiz (definido pela configuração raiz do Snapper) podem ser usados para fazer rollback do sistema. A forma recomendada de fazer o rollback é inicializar do instantâneo e depois fazer o rollback. Consulte a <xref linkend="sec-snapper-snapshot-boot"/> para obter os detalhes. 
    </para>
    <para>
     É possível também fazer rollback restaurando todos os arquivos de um instantâneo do sistema de arquivos raiz, conforme descrito a seguir. No entanto, isso não é recomendado. É possível restaurar arquivos únicos, por exemplo, um arquivo de configuração do diretório <systemitem>/etc</systemitem>, mas não a lista completa de arquivos do instantâneo.
    </para>
    <para>
     Esta restrição afeta apenas os instantâneos criados do sistema de arquivos raiz!
    </para>
   </warning>
   <procedure xml:id="proc-snapper-restore-yast">
    <title>Restaurando arquivos usando o módulo <guimenu>Snapper</guimenu> do YaST</title>
    <step>
     <para>
      Inicie o módulo <guimenu>Snapper</guimenu> pela seção <guimenu>Diversos</guimenu> no YaST ou digitando <command>yast2 snapper</command>.
     </para>
    </step>
    <step>
     <para>
      Selecione a <guimenu>Configuração Atual</guimenu> da qual escolher o instantâneo.
     </para>
    </step>
    <step>
     <para>
      Selecione o instantâneo de linha do tempo do qual restaurar o arquivo e escolha <guimenu>Mostrar Mudanças</guimenu>. Os instantâneos de linha do tempo são do tipo <guimenu>Único</guimenu>, com um valor descritivo de <guimenu>linha do tempo</guimenu>.
     </para>
    </step>
    <step>
     <para>
      Selecione um arquivo na caixa de texto clicando no nome dele. A diferença entre a versão do instantâneo e o sistema atual é exibida. Marque a caixa de seleção para escolher o arquivo para restauração. Faça isso para todos os arquivos que deseja restaurar.
     </para>
    </step>
    <step>
     <para>
      Clique em <guimenu>Restaurar Selecionados</guimenu> e clique em <guimenu>Sim</guimenu> para confirmar a ação.
     </para>
    </step>
   </procedure>
   <procedure xml:id="proc-snapper-restore-cmdl">
    <title>Restaurando arquivos usando o comando <command>snapper</command></title>
    <step>
     <para>
      Obtenha a lista de instantâneos de linha do tempo para determinada configuração executando o seguinte comando:
     </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper -c <replaceable>CONFIG</replaceable> list -t single | grep timeline</screen>
     <para>
      <replaceable>CONFIG</replaceable> precisa ser substituído pela configuração existente do Snapper. Use <command>snapper list-configs</command> para exibir uma lista.
     </para>
    </step>
    <step>
     <para>
      Obtenha a lista de arquivos modificados de determinado instantâneo executando o seguinte comando:
     </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper -c <replaceable>CONFIG</replaceable> status <replaceable>SNAPSHOT_ID</replaceable>..0</screen>
     <para>
      Substitua <replaceable>ID_DO_INSTANTÂNEO</replaceable> pelo ID do instantâneo do qual deseja restaurar o(s) arquivo(s).
     </para>
    </step>
    <step>
     <para>
      Se preferir, liste as diferenças entre a versão do arquivo atual e a versão do instantâneo executando
     </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper -c <replaceable>CONFIG</replaceable> diff <replaceable>SNAPSHOT_ID</replaceable>..0 <replaceable>FILE NAME</replaceable></screen>
     <para>
      Se você não especificar <replaceable>&lt;NOME DE ARQUIVO&gt;</replaceable>, será mostrada a diferença de todos os arquivos.
     </para>
    </step>
    <step>
     <para>
      Para restaurar um ou mais arquivos, execute
     </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper -c <replaceable>CONFIG</replaceable> -v undochange <replaceable>SNAPSHOT_ID</replaceable>..0 <replaceable>FILENAME1</replaceable> <replaceable>FILENAME2</replaceable></screen>
     <para>
      Se você não especificar nomes de arquivos, todos os arquivos mudados serão restaurados.
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-snapper-snapshot-boot">
  <title>Rollback do sistema por inicialização de instantâneos</title>

  <para>
   A versão GRUB 2 incluída no <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> pode inicializar de instantâneos Btrfs. Juntamente com o recurso de rollback do Snapper, ela permite recuperar um sistema mal configurado. Apenas os instantâneos criados com a configuração padrão do Snapper (<literal>root</literal>) são inicializáveis.
  </para>

  <important>
   <title>Configuração suportada</title>
   <para>

    A partir do <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> <phrase role="productnumber"><phrase os="sles;sled"> 15 SP3</phrase></phrase>, os rollbacks de sistema apenas serão suportados se a configuração de subvolume padrão da partição raiz não tiver sido mudada.
   </para>
  </important>

  <para>
   Ao inicializar um instantâneo, as partes do sistema de arquivos incluídas no instantâneo são montadas como apenas leitura; todos os outros sistemas de arquivos e partes excluídos dos instantâneos são montados como leitura-gravação e podem ser modificados.
  </para>

  <important>
   <title>Comparação entre desfazer mudanças e rollback</title>
   <para>
    Ao trabalhar com instantâneos para restaurar dados, é importante saber que há dois cenários fundamentalmente distintos nos quais o Snapper pode atuar:
   </para>
   <variablelist>
    <varlistentry>
     <term>Desfazendo mudanças</term>
     <listitem>
      <para>
       Ao desfazer mudanças conforme descrito na <xref linkend="sec-snapper-undo"/>, dois instantâneos são comparados e as mudanças entre eles são revertidas. O uso deste método também permite excluir explicitamente os arquivos selecionados para não serem restaurados.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Rollback</term>
     <listitem>
      <para>
       Ao fazer rollbacks conforme descrito a seguir, o sistema é redefinido para o estado do momento em que o instantâneo foi criado.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </important>

  <para>
   Para fazer rollback de um instantâneo inicializável, os seguintes requisitos devem ser atendidos. Em uma instalação padrão, o sistema é configurado apropriadamente.
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <title>Requisitos para rollback de um instantâneo inicializável</title>
   <listitem>
    <para>
     O sistema de arquivos raiz precisa ser o Btrfs. A inicialização de instantâneos de volume LVM não é suportada.
    </para>
   </listitem>
   <listitem>
    <para>
     O sistema de arquivos raiz precisa estar em um único dispositivo, uma única partição e um único subvolume. Os diretórios excluídos dos instantâneos, como <filename>/srv</filename> (consulte <xref linkend="snapper-dir-excludes"/> para ver a lista completa) podem residir em partições separadas.
    </para>
   </listitem>
   <listitem>
    <para>
     O sistema precisa ser inicializável pelo carregador de boot instalado.
    </para>
   </listitem>
  </itemizedlist>

  <para>
   Para fazer rollback de um instantâneo inicializável, faça o seguinte:
  </para>

  <procedure>
   <step>
    <para>
     Inicialize o sistema. No menu de boot, escolha <guimenu>Bootable snapshots</guimenu> (Instantâneos inicializáveis) e selecione o instantâneo que deseja inicializar. A lista de instantâneos é classificada por data: o instantâneo mais recente é listado primeiro.
    </para>
   </step>
   <step>
    <para>
     Efetue login no sistema. Verifique com atenção se tudo funciona conforme esperado. Observe que você não pode gravar em nenhum diretório que faça parte do instantâneo. Os dados gravados em outros diretórios <emphasis>não</emphasis> serão perdidos, independentemente do que você faça a seguir.
    </para>
   </step>
   <step>
    <para>
     Dependendo se você deseja ou não fazer rollback, escolha a próxima etapa:
    </para>
    <substeps performance="required">
     <step>
      <para>
       Se o sistema está em um estado no qual você não deseja fazer rollback, reinicialize-o para inicializá-lo no estado atual do sistema. Em seguida, você pode escolher um instantâneo diferente ou iniciar o sistema de recuperação.
      </para>
     </step>
     <step>
      <para>
       Para fazer o rollback, execute
      </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper rollback</screen>
      <para>
       e reinicialize posteriormente. Na tela de boot, escolha a entrada de boot padrão para reinicializar no sistema restaurado. É criado um instantâneo do status do sistema de arquivos antes do rollback. O subvolume padrão da raiz será substituído por um novo instantâneo de leitura-gravação. Para obter os detalhes, consulte a <xref linkend="sec-snapper-snapshot-boot-rollback"/>.
       </para>
       <para>
        Isso é útil para adicionar uma descrição sobre o instantâneo com a opção <option>-d</option>. Por exemplo:
       </para>
      <screen>New file system root since rollback on <replaceable>DATE</replaceable> <replaceable>TIME</replaceable></screen>
     </step>
    </substeps>
   </step>
  </procedure>
  <tip>
   <title>Voltando para um estado da instalação específico</title>
   <para>
    Se os instantâneos não forem desabilitados durante a instalação, um instantâneo inicializável inicial será criado ao término da instalação do sistema inicial. É possível voltar para esse estado a qualquer momento inicializando o instantâneo. É possível identificar o instantâneo pela descrição <literal>após instalação</literal>.
   </para>
   <para>
    Um instantâneo inicializável também é criado ao iniciar o upgrade do sistema para um service pack ou uma nova versão principal (desde que os instantâneos não estejam desabilitados).
   </para>
  </tip>
  <sect2 xml:id="sec-snapper-snapshot-boot-rollback">
   <title>Instantâneos após rollback</title>
   <para>
    Antes da execução de um rollback, é criado um instantâneo do sistema de arquivos em execução. A descrição faz referência ao ID do instantâneo que foi restaurado no rollback.
   </para>
   <para>
    Os instantâneos criados por rollbacks recebem o valor <literal>number</literal> para o atributo <literal>Cleanup</literal>. Portanto, os instantâneos de rollback são automaticamente apagados quando o número definido de instantâneos é atingido. Consulte o <xref linkend="sec-snapper-clean-up"/> para obter os detalhes. Se o instantâneo contém dados importantes, extraia os dados dele antes que ele seja removido.
   </para>
   <sect3 xml:id="sec-snapper-snapshot-boot-rollback-example">
    <title>Exemplo de instantâneo de rollback</title>
    <para>
     Por exemplo, após uma nova instalação, os seguintes instantâneos estarão disponíveis no sistema:
    </para>
<screen>
<prompt role="root">root # </prompt><command>snapper</command> --iso list
Type   | # |     | Cleanup | Description           | Userdata
-------+---+ ... +---------+-----------------------+--------------
single | 0 |     |         | current               |
single | 1 |     |         | first root filesystem |
single | 2 |     | number  | after installation    | important=yes
</screen>
    <para>
     Após a execução do comando <command>sudo snapper rollback</command>, o instantâneo <literal>3</literal> será criado com o estado do sistema antes da execução do rollback. O instantâneo <literal>4</literal> é o novo subvolume Btrfs padrão e, portanto, o sistema após uma reinicialização.
    </para>
<screen>
<prompt role="root">root # </prompt><command>snapper</command> --iso list
Type   | # |     | Cleanup | Description           | Userdata
-------+---+ ... +---------+-----------------------+--------------
single | 0 |     |         | current               |
single | 1 |     | number  | first root filesystem |
single | 2 |     | number  | after installation    | important=yes
single | 3 |     | number  | rollback backup of #1 | important=yes
single | 4 |     |         |                       |
</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-snapper-snapshot-boot-identify">
   <title>Acessando e identificando entradas de boot de instantâneos</title>
   <para>
    Para inicializar de um instantâneo, reinicialize a máquina e escolha <guimenu>Start Bootloader from a read-only snapshot</guimenu> (Iniciar Carregador de Boot de instantâneo apenas leitura). Aparece uma tela com todos os instantâneos inicializáveis. O instantâneo mais recente é listado primeiro, o mais antigo por último. Use as teclas <keycap function="down"/> e <keycap function="up"/> para navegar e pressione <keycap function="enter"/> para ativar o instantâneo selecionado. A ativação de um instantâneo pelo menu de boot não reinicializa a máquina imediatamente; mas, em vez disso, abre o carregador de boot do instantâneo selecionado.
   </para>
   <figure xml:id="fig-snapper-snapshot-boot-identify">
    <title>Carregador de boot: instantâneos</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="boot_snapshots.png" width="75%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="boot_snapshots.png" width="75%" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    Cada entrada de instantâneo no carregador de boot segue um esquema de nomeação que torna possível identificá-lo facilmente:
   </para>
<screen>[*]<co xml:id="snapper-boot-important"/><replaceable>OS</replaceable><co xml:id="snapper-boot-os"/> (<replaceable>KERNEL</replaceable><co xml:id="snapper-boot-kernel"/>,<replaceable>DATE</replaceable><co xml:id="snapper-boot-date"/>T<replaceable>TIME</replaceable><co xml:id="snapper-boot-time"/>,<replaceable>DESCRIPTION</replaceable><co xml:id="snapper-boot-description"/>)</screen>
   <calloutlist>
    <callout arearefs="snapper-boot-important">
     <para>
      Se o instantâneo foi marcado como <literal>importante</literal>, a entrada é marcada com um <literal>*</literal>.
     </para>
    </callout>
    <callout arearefs="snapper-boot-os">
     <para>
      Rótulo do sistema operacional.
     </para>
    </callout>
    <callout arearefs="snapper-boot-date">
     <para>
      Data no formato <literal>AAAA-MM-DD</literal>.
     </para>
    </callout>
    <callout arearefs="snapper-boot-time">
     <para>
      Horário no formato <literal>HH:MM</literal>.
     </para>
    </callout>
    <callout arearefs="snapper-boot-description">
     <para>
      Esse campo mostra a descrição do instantâneo. No caso de um instantâneo criado manualmente, trata-se da string criada com a opção <option>--description</option> ou de uma string personalizada (consulte a <xref linkend="tip-snapper-snapshot-boot-custom-descr"/>). No caso de um instantâneo criado automaticamente, trata-se da ferramenta que foi chamada, por exemplo <literal>zypp(zypper)</literal> ou <literal>yast_sw_single</literal>. Descrições extensas podem ser truncadas, dependendo do tamanho da tela de boot.
     </para>
    </callout>
   </calloutlist>
   <tip xml:id="tip-snapper-snapshot-boot-custom-descr">
    <title>Definindo uma descrição personalizada para as entradas de instantâneos do carregador de boot</title>
    <para>
     É possível substituir a string padrão no campo da descrição de um instantâneo por uma string personalizada. Isso é útil, por exemplo, quando uma descrição criada automaticamente não é suficiente, ou quando uma descrição inserida pelo usuário é muito longa. Para definir uma string personalizada <replaceable>STRING</replaceable> para o instantâneo <replaceable>NÚMERO</replaceable>, use o seguinte comando:
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper modify --userdata "bootloader=<replaceable>STRING</replaceable>" <replaceable>NUMBER</replaceable></screen>
    <para>
     A descrição deve ter no máximo 25 caracteres, tudo o que ultrapassar esse tamanho não poderá ser lido na tela de boot.
    </para>
   </tip>
  </sect2>

  <sect2 xml:id="sec-snapper-snapshot-boot-limits">
   <title>Limitações</title>
   <para>
    O rollback do sistema <emphasis>completo</emphasis>, restauração do sistema completo para o estado idêntico ao que ele estava quando o instantâneo foi capturado, não é possível.
   </para>
   <sect3 xml:id="sec-snapper-limits-snapshot-boot-excludes">
    <title>Diretórios excluídos dos instantâneos</title>
    <para>
     Os instantâneos do sistema de arquivos raiz não contêm todos os diretórios. Consulte <xref linkend="snapper-dir-excludes"/> para ver os detalhes e motivos. Como consequência geral, os dados desses diretórios não são restaurados, resultando nas seguintes limitações.
    </para>
    <variablelist>
     <varlistentry>
      <term>
       Complementos e software de terceiros podem se tornar inutilizáveis após um rollback
      </term>
      <listitem>
       <para>
        Os aplicativos e complementos que instalam dados em subvolumes excluídos do instantâneo, como <filename>/opt</filename>, poderão não funcionar após o rollback, se outras partes dos dados dos aplicativos também forem instaladas em subvolumes incluídos no instantâneo. Reinstale o aplicativo ou complemento para resolver o problema.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Problemas de acesso a arquivos</term>
      <listitem>
       <para>
        Se um aplicativo mudar as permissões e/ou a propriedade do arquivo no meio tempo entre o instantâneo e o sistema atual, o aplicativo talvez não consiga acessar o arquivo. Redefina as permissões e/ou a propriedade dos arquivos afetados após o rollback.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Formatos de dados incompatíveis</term>
      <listitem>
       <para>
        Se um serviço ou aplicativo estabelecer um novo formato de dados no meio tempo entre o instantâneo e o sistema atual, o aplicativo talvez não consiga ler os arquivos de dados afetados após o rollback.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Subvolumes com mistura de códigos e dados</term>
      <listitem>
       <para>
        Subvolumes como <filename>/srv</filename> podem incluir uma mistura de códigos e dados. O rollback pode resultar em código não funcional. A instalação de uma versão PHP menos eficiente, por exemplo, pode resultar em scripts PHP com defeito no servidor Web.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Dados do usuário</term>
      <listitem>
       <para>
        Se o rollback remover usuários do sistema, os dados de propriedade desses usuários nos diretórios excluídos do instantâneo serão removidos. Se for criado um usuário com o mesmo ID de usuário, ele herdará os arquivos. Use uma ferramenta como <command>find</command> para localizar e remover arquivos órfãos.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="sec-snapper-limits-snapshot-boot-grub">
    <title>Nenhum rollback dos dados do carregador de boot</title>
    <para>
     Não é possível fazer rollback do carregador de boot, pois todas as <quote>fases</quote> do carregador de boot devem se ajustar. Isso não é garantido no caso de rollbacks de <filename>/boot</filename>.
    </para>
   </sect3>
  </sect2>
 </sect1>
 
 <sect1 xml:id="sec-snapper-homedirs">
     <title>Habilitando o Snapper em diretórios pessoais dos usuários</title>
     
     <para>
         É possível habilitar instantâneos para os diretórios <filename>/home</filename> dos usuários, o que suporta vários casos de uso:
     </para>
     <itemizedlist>
          <listitem>
              <para>
                 Usuários individuais podem gerenciar seus próprios instantâneos e rollbacks.
             </para>
         </listitem>
         <listitem>
             <para>
                 Usuários do sistema, por exemplo, administradores de banco de dados, sistema e rede, que desejam monitorar cópias de arquivos de configuração, documentação, etc.
             </para>
         </listitem>    
         <listitem>
             <para>
                 Compartilhamentos do Samba com diretórios pessoais e back end btrfs.
             </para>
         </listitem>
     </itemizedlist>
     <para>
         O diretório de cada usuário é um subvolume Btrfs de <filename>/home</filename>. É possível configurar isso manualmente (consulte a <xref linkend="sec-snapper-manual-home-config"/>). Entretanto, o modo mais prático é usar o <literal>pam_snapper</literal>. O pacote <literal>pam_snapper</literal> instala o módulo <literal>pam_snapper.so</literal> e os scripts ajudantes, o que automatiza a criação de usuário e a configuração do Snapper. 
     </para>
     <para>
         O <literal>pam_snapper</literal> permite a integração com o comando <command>useradd</command>, os PAMs (Pluggable Authentication Modules – Módulos de Autenticação Conectáveis) e o Snapper. Por padrão, ele cria instantâneos no login e logout do usuário e também cria instantâneos com base no tempo, pois alguns usuários permanecem conectados por longos períodos. Você pode mudar os padrões usando os comandos e arquivos de configuração normais do Snapper.
     </para>

     <sect2 xml:id="sec-snapper-install-pam-snapper">
         <title>Instalando o pam_snapper e criando usuários</title>
         
         <para>
             A maneira mais fácil é começar com um novo diretório <filename>/home</filename> formatado com Btrfs e nenhum usuário existente. Instale o <literal>pam_snapper</literal>:
         </para>
         <screen><prompt role="root">root # </prompt>zypper in pam_snapper</screen>
         <para>
             Adicione esta linha a <filename>/etc/pam.d/common-session</filename>:
         </para>
         <screen>session optional pam_snapper.so</screen>
         <para>
             Use o script <command>/usr/lib/pam_snapper/pam_snapper_useradd.sh</command> para criar um novo usuário e um diretório pessoal. Por padrão, o script executa um dry run. Edite o script para mudar <literal>DRYRUN=1</literal> para <literal>DRYRUN=0</literal>. Agora você pode criar um novo usuário:
         </para>
         <screen><prompt role="root">root # </prompt>/usr/lib/pam_snapper/pam_snapper_useradd.sh \
<replaceable>username</replaceable> <replaceable>group</replaceable> passwd=<replaceable>password</replaceable>
Create subvolume '/home/username'
useradd: warning: the home directory already exists.
Not copying any file from skel directory into it.
</screen>
         <para>
             Os arquivos de <filename>/etc/skel</filename> serão copiados para o diretório pessoal do usuário na primeira vez que ele efetuar login. Liste suas configurações do Snapper para verificar se a configuração do usuário foi criada:
         </para>
         <screen><prompt role="root">root # </prompt>snapper list --all
Config: home_username, subvolume: /home/username
Type   | # | Pre # | Date | User | Cleanup | Description | Userdata
-------+---+-------+------+------+---------+-------------+---------
single | 0 |       |      | root |         | current     |
</screen>
        <para>
            Ao longo do tempo, essa saída será preenchida com uma lista de instantâneos, que o usuário poderá gerenciar com os comandos padrão do Snapper.
        </para>
     </sect2>

     <sect2 xml:id="sec-snapper-remove-user">
         <title>Removendo usuários</title>
         <para>
             Remova usuários com o script <command>/usr/lib/pam_snapper/pam_snapper_userdel.sh</command>. Por padrão, ele executa um dry run, portanto edite-o para mudar <literal>DRYRUN=1</literal> para <literal>DRYRUN=0</literal>. Isso remove o usuário, o subvolume pessoal do usuário, a configuração do Snapper e apaga todos os instantâneos.
         </para>
         <screen><prompt role="root">root # </prompt>/usr/lib/pam_snapper/pam_snapper_userdel.sh username</screen>
     </sect2>

     <sect2 xml:id="sec-snapper-manual-home-config">
         <title>Habilitando manualmente os instantâneos em diretórios pessoais</title>
         
         <para>
            Estas são as etapas para a configuração manual dos diretórios pessoais dos usuários com o Snapper. O <filename>/home</filename> deve ser formatado com Btrfs, e os usuários ainda não devem ser criados.
        </para>
        <screen><prompt role="root">root # </prompt>btrfs subvol create /home/<replaceable>username</replaceable>
<prompt role="root">root # </prompt>snapper -c home_<replaceable>username</replaceable> create-config /home/<replaceable>username</replaceable>
<prompt role="root">root # </prompt>sed -i -e "s/ALLOW_USERS=\"\"/ALLOW_USERS=\"<replaceable>username</replaceable>\"/g" \
/etc/snapper/configs/home_<replaceable>username</replaceable>
<prompt role="root">root # </prompt>yast users add username=<replaceable>username</replaceable> home=/home/<replaceable>username</replaceable> password=<replaceable>password</replaceable>
<prompt role="root">root # </prompt>chown <replaceable>username</replaceable>.<replaceable>group</replaceable> /home/<replaceable>username</replaceable>
<prompt role="root">root # </prompt>chmod 755 /home/<replaceable>username</replaceable>/.snapshots
</screen>
</sect2>
 </sect1>
 
 <sect1 xml:id="sec-snapper-config">
  <title>Criando e modificando as configurações do Snapper</title>

  <para>
   O modo como o Snapper se comporta é definido em um arquivo de configuração específico a cada partição ou subvolume <literal>Btrfs</literal>. Esses arquivos de configuração residem em <filename>/etc/snapper/configs/</filename>.
  </para>

  <para>
   Caso o sistema de arquivos raiz seja grande o suficiente (aproximadamente 12 GB), os instantâneos serão habilitados automaticamente no sistema de arquivos raiz <filename>/</filename> na instalação. A configuração padrão correspondente é denominada <filename>raiz</filename>. Ela cria e gerencia os instantâneos do YaST e do Zypper. Consulte a <xref linkend="sec-snapper-config-modify-values"/> para obter uma lista dos valores padrão.
  </para>


  <note>
   <title>Tamanho mínimo do sistema de arquivos raiz para habilitar instantâneos</title>
   <para>
    Conforme explicado na <xref linkend="sec-snapper-setup"/>, a habilitação de instantâneos requer espaço livre adicional no sistema de arquivos raiz. A quantidade depende do número de pacotes instalados e de mudanças feitas no volume que está incluído nos instantâneos. A frequência e o número de instantâneos que são armazenados também são considerados.
   </para>
   <para>
    Há um tamanho mínimo de sistema de arquivos raiz que é necessário para habilitar instantâneos automaticamente durante a instalação. Atualmente, esse tamanho está por volta de 12 GB. Esse valor pode mudar no futuro, dependendo da arquitetura e do tamanho do sistema básico. Ele depende dos valores para as seguintes tags no arquivo <filename>/control.xml</filename> da mídia de instalação:
   </para>
   <screen>&lt;root_base_size&gt;
&lt;btrfs_increase_percentage&gt;</screen>
   <para>
    Ele é calculado com a seguinte fórmula: <replaceable>TAMANHO_BASE_RAIZ</replaceable> * (1 + <replaceable>PORCENTAGEM_AUMENTO_BTRFS</replaceable>/100)
   </para>
   <para>
    Lembre-se de que esse valor é um tamanho mínimo. Considere usar mais espaço para o sistema de arquivos raiz. Como regra geral, dobre o tamanho que você usa quando não tem instantâneos habilitados.
   </para>
  </note>

  <para>
   É possível criar suas próprias configurações para outras partições formatadas com <literal>Btrfs</literal> ou subvolumes existentes em uma partição <literal>Btrfs</literal>. No exemplo a seguir, nós definimos uma configuração do Snapper para backup dos dados do servidor Web que residem em uma partição separada formatada por <literal>Btrfs</literal> montada em <filename>/srv/www</filename>.
  </para>

  <para>
   Após a criação de uma configuração, é possível usar o próprio <command>snapper</command> ou o módulo <guimenu>Snapper</guimenu> do YaST para restaurar arquivos desses instantâneos. No YaST, você precisa selecionar a <guimenu>Configuração Atual</guimenu> e especificar a configuração do <command>snapper</command> com o switch global <option>-c</option> (por exemplo, <command>snapper -c myconfig list</command>).
  </para>

  <para>
   Para criar uma nova configuração do Snapper, execute <command>snapper create-config</command>:
  </para>

<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper -c www-data<co xml:id="snapper-create-name"/> create-config /srv/www<co xml:id="snapper-create-volume"/></screen>

  <calloutlist>
   <callout arearefs="snapper-create-name">
    <para>
     Nome do arquivo de configuração.
    </para>
   </callout>
   <callout arearefs="snapper-create-volume">
    <para>
     Ponto de montagem da partição ou subvolume <literal>Btrfs</literal> no qual criar instantâneos.
    </para>
   </callout>
  </calloutlist>

  <para>
   Este comando cria um novo arquivo de configuração <filename>/etc/snapper/configs/www-data</filename> com valores padrão lógicos (obtidos de <filename>/etc/snapper/config-templates/default</filename>). Consulte a <xref linkend="sec-snapper-config-modify"/> para obter instruções de como ajustar os padrões.
  </para>

  <tip>
   <title>Padrões de configuração</title>
   <para>
    Os valores padrão para uma nova configuração são obtidos de <filename>/etc/snapper/config-templates/default</filename>. Para usar seu próprio conjunto de padrões, crie uma cópia desse arquivo no mesmo diretório e ajuste-o de acordo com as suas necessidades. Para usá-lo, especifique a opção <option>-t</option> com o comando create-config:
   </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper -c www-data create-config -t <replaceable>MY_DEFAULTS</replaceable> /srv/www</screen>
  </tip>

  <sect2 xml:id="sec-snapper-config-modify">
   <title>Gerenciando configurações existentes</title>
   <para>
    O comando <command>snapper</command> oferece vários subcomandos para gerenciar as configurações existentes. É possível listar, mostrar, apagar e modificá-las:
   </para>
   <variablelist>
    <varlistentry>
     <term>Listando configurações</term>
     <listitem>
      <para>
       Use o subcomando <command>snapper list-configs</command> para obter todas as configurações existentes:
      </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper list-configs
Config | Subvolume
-------+----------
root   | /
usr    | /usr
local  | /local</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Mostrando uma configuração</term>
     <listitem>
      <para>
       Use o subcomando <command>snapper -c <replaceable>CONFIG</replaceable> get-config</command> para exibir a configuração especificada. Substitua <replaceable>CONFIG</replaceable> por um dos nomes de configuração mostrados pelo <command>snapper list-configs</command>. Para obter mais informações sobre as opções de configuração, consulte <xref linkend="sec-snapper-config-modify-values"/>.
      </para>
      <para>
       Para exibir a configuração padrão, execute:
      </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper -c root get-config</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Modificando uma configuração</term>
     <listitem>
      <para>
       Use o subcomando <command>snapper -c <replaceable>CONFIG</replaceable> set-config <replaceable>OPÇÃO</replaceable>=<replaceable>VALOR</replaceable></command> para modificar uma opção na configuração especificada. Substitua <replaceable>CONFIG</replaceable> por um dos nomes de configuração mostrados pelo <command>snapper list-configs</command>. Os valores possíveis para <replaceable>OPÇÃO</replaceable> e <replaceable>VALOR</replaceable> estão listados na <xref linkend="sec-snapper-config-modify-values"/>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Apagando uma configuração</term>
     <listitem>
      <para>
       Use o subcomando <command>snapper -c <replaceable>CONFIG</replaceable> delete-config</command> para apagar uma configuração. Substitua <replaceable>CONFIG</replaceable> por um dos nomes de configuração mostrados pelo <command>snapper list-configs</command>.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <sect3 xml:id="sec-snapper-config-modify-values">
    <title>Dados de configuração</title>
    <para>
     Cada configuração possui uma lista das opções que podem ser modificadas por linha de comando. A seguinte lista mostra os detalhes de cada opção. Para mudar um valor, execute <command>snapper -c <replaceable>CONFIG</replaceable> set-config "<replaceable>CHAVE</replaceable>=<replaceable>VALOR</replaceable>"</command>.
    </para>
    <variablelist>
     <varlistentry>
      <term><literal>ALLOW_GROUPS</literal>, <literal>ALLOW_USERS</literal>
      </term>
      <listitem>
       <para>
        Conceder permissões para usar instantâneos a usuários regulares. Consulte a <xref linkend="sec-snapper-config-user"/> para obter mais informações.
       </para>
       <para>
        O valor padrão é <literal>""</literal>.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>BACKGROUND_COMPARISON</literal>
      </term>
      <listitem>
       <para>
        Define se os instantâneos pré e pós devem ser comparados em segundo plano após a criação.
       </para>
       <para>
        O valor padrão é <literal>"yes"</literal> (sim).
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>EMPTY_*</literal>
      </term>
      <listitem>
       <para>
        Define o algoritmo de limpeza de pares de instantâneos com instantâneos pré e pós idênticos. Consulte a <xref linkend="sec-snapper-clean-up-empty"/> para obter os detalhes. 
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>FSTYPE</literal>
      </term>
      <listitem>
       <para>
        Tipo de sistema de arquivos da partição. Não alterar.
       </para>
       <para>
        O valor padrão é <literal>"btrfs"</literal>.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>NÚMERO_*</literal></term>
      <listitem>
       <para>
        Define o algoritmo de limpeza de instantâneos de instalação e admin. Consulte a <xref linkend="sec-snapper-clean-up-number"/> para obter os detalhes. 
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>QGROUP</literal> / <literal>SPACE_LIMIT</literal>
      </term>
      <listitem>
       <para>
        Adiciona suporte a cotas aos algoritmos de limpeza. Consulte a <xref linkend="sec-snapper-clean-up-quota"/> para obter os detalhes. 
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>SUBVOLUME</literal>
      </term>
      <listitem>
       <para>
        Ponto de montagem da partição ou do subvolume para o instantâneo. Não alterar.
       </para>
       <para>
        O valor padrão é <literal>"/"</literal>.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>SYNC_ACL</literal>
      </term>
      <listitem>
       <para>
        Se o Snapper for utilizado por usuários regulares (consulte a <xref linkend="sec-snapper-config-user"/>), eles deverão ter acesso e ler os arquivos dos diretórios <filename>.snapshot</filename>. Se SYNC_ACL estiver definido como <literal>yes</literal>, o Snapper os tornará acessíveis automaticamente usando ACLs para usuários e grupos das entradas ALLOW_USERS ou ALLOW_GROUPS.
       </para>
       <para>
        O valor padrão é <literal>"no"</literal>.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>TIMELINE_CREATE</literal>
      </term>
      <listitem>
       <para>
        Se definido como <literal>yes</literal>, serão criados instantâneos por hora. Valores válidos: <literal>yes</literal>, <literal>no</literal>.
       </para>
       <para>
        O valor padrão é <literal>"no"</literal>.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>TIMELINE_CLEANUP</literal> / <literal>TIMELINE_LIMIT_*</literal>
      </term>
      <listitem>
       <para>
        Define o algoritmo de limpeza de instantâneos de linha do tempo. Consulte a <xref linkend="sec-snapper-clean-up-timeline"/> para obter os detalhes. 
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="sec-snapper-config-user">
    <title>Usando o Snapper como usuário comum</title>
    <para>
     Por padrão, o Snapper só pode ser usado pelo <systemitem class="username">root</systemitem>. No entanto, há casos em que determinados grupos ou usuários precisam criar instantâneos ou desfazer mudanças revertendo um instantâneo:
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       administradores de site na Web que desejam criar instantâneos de <filename>/srv/www</filename>
      </para>
     </listitem>
     <listitem>
      <para>
       Usuários que desejam capturar um instantâneo de seu diretório pessoal
      </para>
     </listitem>
    </itemizedlist>
    <para>
     Para essas finalidades, você pode criar configurações do Snapper que concedam permissões a usuários e/ou grupos. Os usuários especificados devem conseguir ler e acessar o diretório <filename>.snapshots</filename> correspondente. A maneira mais fácil de fazer isso é definir a opção SYNC_ACL como <literal>yes</literal>.
    </para>
    <procedure>
     <title>Habilitando usuários comuns a usar o Snapper</title>
     <para>
      Observe que todas as etapas deste procedimento devem ser executadas pelo <systemitem class="username">root</systemitem>.
     </para>
     <step>
      <para>
       Se ainda não existir uma configuração do Snapper, crie uma para a partição ou o subvolume em que o usuário poderá usar o Snapper. Consulte a <xref linkend="sec-snapper-config"/> para obter instruções. Exemplo:
      </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper --config web_data create /srv/www</screen>
     </step>
     <step>
      <para>
       O arquivo de configuração é criado em <filename>/etc/snapper/configs/<replaceable>CONFIG</replaceable></filename>, em que CONFIG é o valor que você especificou com <option>-c/--config</option> na etapa anterior (por exemplo, <filename>/etc/snapper/configs/web_data</filename>). Ajuste-o de acordo com as suas necessidades. Para obter mais informações, consulte a <xref linkend="sec-snapper-config-modify"/>. 
      </para>
     </step>
     <step>
      <para>
       Defina os valores de <envar>ALLOW_USERS</envar> e <envar>ALLOW_GROUPS</envar> para conceder permissões a usuários e grupos, respectivamente. Separe várias entradas com <keycap function="space"/>. Para conceder permissões ao usuário <systemitem class="username">www_admin</systemitem>, por exemplo, execute:
      </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper -c web_data set-config "ALLOW_USERS=www_admin" SYNC_ACL="yes"</screen>
     </step>
     <step>
      <para>
       Agora o(s) usuário(s) e grupo(s) pode(m) utilizar a configuração especificada do Snapper. É possível testá-la com o comando <literal>list</literal>, por exemplo:
      </para>
<screen><prompt>www_admin:~ &gt; </prompt>snapper -c web_data list</screen>
     </step>
    </procedure>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-snapper-manage">
  <title>Criando e gerenciando instantâneos manualmente</title>

  <para>
   Não é possível apenas criar e gerenciar os instantâneos automaticamente pela configuração do Snapper, você também pode criar pares de instantâneos (<quote>antes e após</quote>) ou instantâneos únicos manualmente usando a ferramenta de linha de comando ou o módulo do YaST.
  </para>

  <para>
   Todas as operações do Snapper são executadas de acordo com uma configuração existente (consulte a <xref linkend="sec-snapper-config"/> para obter os detalhes). Você só pode criar instantâneos de partições ou volumes em que exista uma configuração. Por padrão, a configuração do sistema (<literal>root</literal>) é usada. Para criar ou gerenciar instantâneos com sua própria configuração, selecione-a de maneira clara. Use a caixa suspensa <guimenu>Configuração Atual</guimenu> no YaST ou especifique <option>-c</option> na linha de comando (<command>snapper -c<replaceable> MINHACONFIG</replaceable>
   <replaceable> COMANDO</replaceable></command>).
  </para>

  <sect2 xml:id="sec-snapper-manage-metadata">
   <title>Metadados de instantâneos</title>
   <para>
    Cada instantâneo consiste no próprio instantâneo e em alguns metadados. Ao criar um instantâneo, você também precisa especificar os metadados. A modificação de um instantâneo também altera seus metadados; não é possível modificar seu conteúdo. Use <command>snapper list</command> para mostrar os instantâneos existentes e seus metadados:
   </para>
   <variablelist>
    <varlistentry>
     <term><command>snapper --config home list</command>
     </term>
     <listitem>
      <para>
       Lista os instantâneos da configuração <literal>home</literal>. Para listar os instantâneos da configuração padrão (raiz), use <command>snapper -c root list</command> ou <command>snapper list</command>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>snapper list -a</command>
     </term>
     <listitem>
      <para>
       Lista os instantâneos de todas as configurações existentes.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>snapper list -t pre-post</command>
     </term>
     <listitem>
      <para>
       Lista todos os pares de instantâneos pré e pós da configuração padrão (<literal>raiz</literal>).
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>snapper list -t single</command>
     </term>
     <listitem>
      <para>
       Lista todos os instantâneos do tipo <literal>único</literal> da configuração padrão (<literal>raiz</literal>).
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <para>
    Os seguintes metadados estão disponíveis para cada instantâneo:
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      <emphasis role="bold">Tipo</emphasis>: Tipo do instantâneo, consulte a <xref linkend="sec-snapper-manage-metadata-type"/> para obter os detalhes. Esses dados não podem ser mudados.
     </para>
    </listitem>
    <listitem>
     <para>
      <emphasis role="bold">Número</emphasis>: Número exclusivo do instantâneo. Esses dados não podem ser mudados.
     </para>
    </listitem>
    <listitem>
     <para>
      <emphasis role="bold">Número do Pré</emphasis>: Especifica o número do pré-instantâneo correspondente. Apenas para instantâneos do tipo pós. Esses dados não podem ser mudados.
     </para>
    </listitem>
    <listitem>
     <para>
      <emphasis role="bold">Descrição</emphasis>: A descrição do instantâneo.
     </para>
    </listitem>
    <listitem>
     <para>
      <emphasis role="bold">Dados de usuário</emphasis>: Uma descrição estendida que especifica os dados personalizados no formato de uma lista de chave=valor separada por vírgula: <literal>reason=testing, project=foo</literal>. Este campo também é usado para marcar um instantâneo como importante (<literal>important=yes</literal>) e listar o usuário que criou o instantâneo (user=tux).
     </para>
    </listitem>
    <listitem>
     <para>
      <emphasis role="bold">Algoritmo de Limpeza</emphasis>: Algoritmo de limpeza do instantâneo. Consulte a <xref linkend="sec-snapper-clean-up"/> para obter os detalhes.
     </para>
    </listitem>
   </itemizedlist>
   <sect3 xml:id="sec-snapper-manage-metadata-type">
    <title>Tipos de instantâneos</title>
    <para>
     O Snapper reconhece três tipos diferentes de instantâneos: pre (pré), post (pós) e single (único). Eles são iguais fisicamente, mas o Snapper trabalha com eles de forma diferente.
    </para>
    <variablelist>
     <varlistentry>
      <term><literal>pre</literal>
      </term>
      <listitem>
       <para>
        Instantâneo de um sistema de arquivos <emphasis>antes</emphasis> da modificação. Cada instantâneo <literal>pre</literal> corresponde a um instantâneo <literal>post</literal>. Por exemplo, ele é usado para instantâneos automáticos do YaST/Zypper.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>post</literal>
      </term>
      <listitem>
       <para>
        Instantâneo de um sistema de arquivos <emphasis>após</emphasis> a modificação. Cada instantâneo <literal>post</literal> corresponde a um instantâneo <literal>pre</literal>. Por exemplo, ele é usado para instantâneos automáticos do YaST/Zypper.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>single</literal>
      </term>
      <listitem>
       <para>
        Instantâneo independente. Por exemplo, ele é usado para os instantâneos automáticos por hora. Esse é o tipo padrão quando se cria instantâneos.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="sec-snapper-manage-metadata-cleanup">
    <title>Algoritmos de limpeza</title>
    <para>
     O Snapper oferece três algoritmos para limpeza de instantâneos antigos. Os algoritmos são executados em uma tarefa <systemitem class="daemon">cron</systemitem> diária. É possível definir o número de tipos diferentes de instantâneos para serem mantidos na configuração do Snapper (consulte a <xref linkend="sec-snapper-config-modify"/> para obter detalhes).
    </para>
    <variablelist>
     <varlistentry>
      <term>number</term>
      <listitem>
       <para>
        Apaga instantâneos antigos quando determinado número de instantâneos é atingido.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>timeline</term>
      <listitem>
       <para>
        Apaga os instantâneos antigos que passaram de uma determinada duração, mas mantém vários instantâneos por hora, dia, mês e ano.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>empty-pre-post</term>
      <listitem>
       <para>
        Apaga os pares de pré/pós-instantâneos com diffs vazias.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-snapper-manage-create">
   <title>Criando instantâneos</title>
   <para>
    Para criar um instantâneo, execute o <command>snapper create</command> ou clique em <guimenu>Criar</guimenu> no módulo <guimenu>Snapper</guimenu> do YaST. Os exemplos a seguir explicam como criar instantâneos da linha de comando. A interface do YaST para o Snapper não está especificamente descrita aqui, mas oferece uma funcionalidade equivalente.
   </para>
   <tip>
    <title>Descrição do instantâneo</title>
    <para>
     Especifique sempre uma descrição significativa para, no futuro, conseguir identificar sua finalidade. Você também pode especificar mais informações pela opção <option>--userdata</option>.
    </para>
   </tip>
   <para/>
   <variablelist>
    <varlistentry>
     <term><command>snapper create --from <replaceable>17</replaceable> --description "with package2"</command>
     </term>
     <listitem>
      <para>
       Cria um instantâneo independente (tipo único) com base em um instantâneo existente, que é especificado pelo número do instantâneo de <command>snapper list</command>. (Isso se aplica a partir da versão 0.8.4 do Snapper.)
      </para>
     </listitem>
    </varlistentry> 
    <varlistentry>
     <term><command>snapper create --description "Instantâneo da 2ª semana de 2014"</command>
     </term>
     <listitem>
      <para>
       Cria um instantâneo independente (tipo único) na configuração padrão (<literal>root</literal>) com uma descrição. Como nenhum algoritmo de limpeza foi especificado, o instantâneo nunca será apagado automaticamente.
      </para>
     </listitem>
    </varlistentry>
     <varlistentry>
     <term><command>snapper --config home create --description "Limpeza no ~tux"</command>
     </term>
     <listitem>
      <para>
       Cria um instantâneo independente (tipo único) em uma configuração personalizada chamada <literal>home</literal> com uma descrição. Como nenhum algoritmo de limpeza foi especificado, o instantâneo nunca será apagado automaticamente.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>snapper --config home create --description "Backup de dados diário" --cleanup-algorithm timeline</command>&gt;
     </term>
     <listitem>
      <para>
       Cria um instantâneo independente (tipo único) em uma configuração personalizada chamada <literal>home</literal> com uma descrição. O instantâneo é apagado automaticamente quando atende aos critérios especificados para o algoritmo de limpeza de linha do tempo na configuração.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>snapper create --type pre --print-number --description "Antes da limpeza de config. do Apache" --userdata "important=yes"</command>
     </term>
     <listitem>
      <para>
       Cria um instantâneo do tipo <literal>pre</literal> e imprime o número do instantâneo. Primeiro comando necessário para criar um par de instantâneos usado para gravar o estado <quote>antes</quote> e <quote>após. </quote> O instantâneo é marcado como importante.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>snapper create --type post --pre-number 30 --description "Após a limpeza de config. do Apache" --userdata "important=yes"</command>
     </term>
     <listitem>
      <para>
       Cria um instantâneo do tipo <literal>post</literal> ligado a seu par <literal>pre</literal> de número <literal>30</literal>. Segundo comando necessário para criar um par de instantâneos usado para gravar o estado <quote>antes</quote> e <quote>após. </quote> O instantâneo é marcado como importante.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>snapper create --command <replaceable>COMANDO</replaceable> --description "Antes e depois do COMANDO"</command>
     </term>
     <listitem>
      <para>
       Cria automaticamente um par de instantâneos antes e após a execução do <replaceable>COMANDO</replaceable>. Essa opção só está disponível ao usar o snapper na linha de comando.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec-snapper-manage-modify">
   <title>Modificando os metadados do instantâneo</title>
   <para>
    O Snapper permite modificar a descrição, o algoritmo de limpeza e os dados do usuário de um instantâneo. Todos os outros metadados não podem ser mudados. Os exemplos a seguir explicam como modificar instantâneos da linha de comando. Eles são fáceis de adotar ao usar a interface do YaST.
   </para>
   <para>
    Para modificar um instantâneo na linha de comando, você precisa saber o número dele. Use <command>snapper list</command> para exibir todos os instantâneos e seus números.
   </para>
   <para>
    O módulo <guimenu>Snapper</guimenu> do YaST já lista todos os instantâneos. Escolha um na lista e clique em <guimenu>Modificar</guimenu>.
   </para>
   <variablelist>
    <varlistentry>
     <term><command>snapper modify --cleanup-algorithm "timeline"</command> 10
     </term>
     <listitem>
      <para>
       Modifica os metadados do instantâneo 10 na configuração padrão (<literal>root</literal>). O algoritmo de limpeza é definido como <literal>timeline</literal>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>snapper --config home modify --description "backup diário" -cleanup-algorithm "timeline" 120</command>
     </term>
     <listitem>
      <para>
       Modifica os metadados do instantâneo 120 na configuração personalizada chamada <literal>home</literal>. Uma nova descrição é definida e o algoritmo de limpeza fica indefinido.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec-snapper-manage-delete">
   <title>Apagando instantâneos</title>
   <para>
    Para apagar um instantâneo com o módulo <guimenu>Snapper</guimenu> do YaST, escolha-o na lista e clique em <guimenu>Apagar</guimenu>.
   </para>
   <para>
    Para apagar um instantâneo com a ferramenta de linha de comando, você precisa saber o número dele. Para saber, execute <command>snapper list</command>. Para apagar um instantâneo, execute <command>snapper delete</command>
    <replaceable> NÚMERO</replaceable>.
   </para>
   <para>
    Não é permitido apagar o instantâneo do subvolume padrão atual.
   </para>
   <para>
    Ao apagar instantâneos com o Snapper, o espaço liberado é requerido pelo processo do Btrfs que está sendo executado em segundo plano. Portanto, há um atraso na visibilidade e disponibilidade do espaço livre. Se você precisar que o espaço liberado após apagar um instantâneo fique disponível imediatamente, use a opção <option>--sync</option> com o comando de exclusão.
   </para>
   <tip>
    <title>Apagando pares de instantâneos</title>
    <para>
     Ao apagar um instantâneo <literal>pre</literal>, sempre apague seu <literal>post</literal> correspondente (e vice-versa).
    </para>
   </tip>
   <variablelist>
    <varlistentry>
     <term><command>snapper delete 65</command>
     </term>
     <listitem>
      <para>
       Apaga o instantâneo 65 na configuração padrão (<literal>root</literal>).
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>snapper -c home delete 89 90</command>
     </term>
     <listitem>
      <para>
       Apaga os instantâneos 89 e 90 na configuração personalizada chamada <literal>home</literal>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>snapper delete --sync 23</command></term>
     <listitem>
      <para>
       Apaga o instantâneo 23 da configuração padrão (<literal>root</literal>) e torna o espaço liberado disponível imediatamente.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <tip>
    <title>Apagar instantâneos não referenciados</title>
    <para>
     Às vezes, o instantâneo do Btrfs está presente, mas o arquivo XML que contém os metadados do Snapper está ausente. Nesse caso, o instantâneo não fica visível para o Snapper e precisa se apagado manualmente:
    </para>
<screen>btrfs subvolume delete /.snapshots/<replaceable>SNAPSHOTNUMBER</replaceable>/snapshot
rm -rf /.snapshots/SNAPSHOTNUMBER</screen>
   </tip>
   <tip>
    <title>Instantâneos antigos ocupam mais espaço em disco</title>
    <para>
     Se você apagar instantâneos para liberar espaço no disco rígido, apague primeiro os instantâneos antigos. Quanto mais antigo for o instantâneo, mais espaço em disco ele ocupa.
    </para>
   </tip>
   <para>
    Os instantâneos também são automaticamente apagados por uma tarefa cron diária. Consulte o <xref linkend="sec-snapper-manage-metadata-cleanup"/> para obter os detalhes.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-snapper-clean-up">
  <title>Limpeza automática de instantâneos</title>

  <para>
   Os instantâneos ocupam espaço em disco e, ao longo do tempo, a quantidade de espaço em disco ocupado pelos instantâneos pode ficar grande. Para evitar que os discos fiquem sem espaço, o Snapper oferece algoritmos para apagar automaticamente os instantâneos antigos. Esses algoritmos diferenciam entre instantâneos de linha do tempo e numerados (pares de instantâneos de administração e instalação). Você pode especificar quantos instantâneos de cada tipo devem ser mantidos.
  </para>

  <para>
   Além disso, você pode especificar uma cota de espaço em disco definindo a quantidade máxima de espaço em disco que os instantâneos podem ocupar. Também é possível apagar automaticamente pares de instantâneos pré e pós que não são diferentes.
  </para>

  <para>
   Um algoritmo de limpeza está sempre associado a uma única configuração do Snapper, portanto, talvez seja necessário definir algoritmos para cada configuração. Para impedir que determinados instantâneos sejam automaticamente apagados, consulte <xref linkend="faq-snapper-permanent"/>.
  </para>

  <para>
   A configuração padrão (<literal>raiz</literal>) é definida para limpar instantâneos numerados e esvaziar pares de instantâneos pré e pós. O suporte a cotas está habilitado, os instantâneos não podem ocupar mais do que 50% do espaço em disco disponível da partição raiz. Por padrão, os instantâneos de linha do tempo estão desabilitados, portanto, o algoritmo de limpeza de linha do tempo também está desabilitado.
  </para>

  <sect2 xml:id="sec-snapper-clean-up-number">
   <title>Limpando instantâneos numerados</title>
   <para>
    A limpeza de instantâneos numerados, pares de instantâneos de administração e de instalação, é controlada pelos seguintes parâmetros de uma configuração do Snapper.
   </para>
   <variablelist>
    <varlistentry>
     <term><literal>NUMBER_CLEANUP</literal>
     </term>
     <listitem>
      <para>
       Habilita ou desabilita a limpeza de pares de instantâneos de instalação e admin. Se habilitado, os pares de instantâneos são apagados quando o número total de instantâneos exceder o número especificado com <literal>NUMBER_LIMIT</literal> e/ou <literal>NUMBER_LIMIT_IMPORTANT</literal> <emphasis> e</emphasis> uma duração especificada com <literal>NUMBER_MIN_AGE</literal>. Valores válidos: <literal>yes</literal> (habilitar), <literal>no</literal> (desabilitar).
      </para>
      <para>
       O valor padrão é <literal>"yes"</literal> (sim).
      </para>
      <para>
       Exemplo de comando para mudar ou definir:
      </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper -c <replaceable>CONFIG</replaceable> set-config "NUMBER_CLEANUP=no"</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><literal>NUMBER_LIMIT</literal> / <literal>NUMBER_LIMIT_IMPORTANT</literal>
     </term>
     <listitem>
      <para>
       Define quantos pares de instantâneos de instalação e administração regulares e/ou importantes devem ser mantidos. Ignorado se <literal>NUMBER_CLEANUP</literal> for definido como <literal>"no"</literal>.
      </para>
      <para>
       O valor padrão é <literal>"2-10"</literal> para <literal>NUMBER_LIMIT</literal> e <literal>"4-10"</literal> para <literal>NUMBER_LIMIT_IMPORTANT</literal>. Os algoritmos de limpeza apagam os instantâneos acima do valor máximo especificado, sem levar em consideração o espaço do instantâneo e do sistema de arquivos. Os algoritmos também apagam os instantâneos acima do valor mínimo até que os limites do instantâneo e do sistema de arquivos sejam atingidos.
      </para>
      <para>
       Exemplo de comando para mudar ou definir:
      </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper -c <replaceable>CONFIG</replaceable> set-config "NUMBER_LIMIT=10"</screen>
      <important>
       <title>Comparação entre valores de faixa e constantes</title>
       <para>
        Se o suporte a cotas estiver habilitado (consulte a <xref linkend="sec-snapper-clean-up-quota"/>), o limite deverá ser especificado como uma faixa de mínimo-máximo, por exemplo, <literal>2-10</literal>. Se o suporte a cotas estiver desabilitado, um valor constante, como <literal>10</literal>, deverá ser informado; do contrário, haverá falha na limpeza com um erro.
       </para>
      </important>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><literal>NUMBER_MIN_AGE</literal>
     </term>
     <listitem>
      <para>
       Define a duração mínima em segundos do instantâneo antes de ser automaticamente apagado. Os instantâneos mais novos do que o valor especificado aqui não serão apagados, independentemente de quantos existirem.
      </para>
      <para>
       O valor padrão é <literal>"1800"</literal>.
      </para>
      <para>
       Exemplo de comando para mudar ou definir:
      </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper -c <replaceable>CONFIG</replaceable> set-config "NUMBER_MIN_AGE=864000"</screen>
     </listitem>
    </varlistentry>
   </variablelist>
   <note>
    <title>Limite e duração</title>
    <para>
     <literal>NUMBER_LIMIT</literal>, <literal>NUMBER_LIMIT_IMPORTANT</literal> e <literal>NUMBER_MIN_AGE</literal> são sempre avaliados. Os instantâneos são apagados apenas quando ocorrem <emphasis>todas</emphasis> as condições.
    </para>
    <para>
     Se você deseja sempre manter o número de instantâneos definido com <literal>NUMBER_LIMIT*</literal>, independentemente da duração deles, defina <literal>NUMBER_MIN_AGE</literal> como <literal>0</literal>.
    </para>
    <para>
     O exemplo a seguir mostra uma configuração para manter os 10 últimos instantâneos importantes e regulares, independentemente da data em que foram criados:
    </para>
<screen>NUMBER_CLEANUP=yes
NUMBER_LIMIT_IMPORTANT=10
NUMBER_LIMIT=10
NUMBER_MIN_AGE=0</screen>
    <para>
     Por outro lado, se você não deseja manter os instantâneos que passarem de uma determinada duração, defina <literal>NUMBER_LIMIT*</literal> como <literal>0</literal> e informe a duração usando <literal>NUMBER_MIN_AGE</literal>.
    </para>
    <para>
     O exemplo a seguir mostra uma configuração para manter apenas instantâneos com menos de dez dias:
    </para>
<screen>NUMBER_CLEANUP=yes
NUMBER_LIMIT_IMPORTANT=0
NUMBER_LIMIT=0
NUMBER_MIN_AGE=864000</screen>
   </note>
  </sect2>

  <sect2 xml:id="sec-snapper-clean-up-timeline">
   <title>Limpando instantâneos de linha do tempo</title>
   <para>
    A limpeza de instantâneos de linha do tempo é controlada pelos seguintes parâmetros de uma configuração do Snapper.
   </para>
   <variablelist>
    <varlistentry>
     <term><literal>TIMELINE_CLEANUP</literal>
     </term>
     <listitem>
      <para>
       Habilita ou desabilita a limpeza de instantâneos de linha do tempo. Se habilitado, os instantâneos são apagados quando o número total excede o número especificado com <literal>TIMELINE_LIMIT_*</literal>
       <emphasis> e</emphasis> a duração especificada com <literal>TIMELINE_MIN_AGE</literal>. Valores válidos: <literal>yes</literal>, <literal>no</literal>.
      </para>
      <para>
       O valor padrão é <literal>"yes"</literal> (sim).
      </para>
      <para>
       Exemplo de comando para mudar ou definir:
      </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper -c <replaceable>CONFIG</replaceable> set-config "TIMELINE_CLEANUP=yes"</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><literal>TIMELINE_LIMIT_DAILY</literal>, <literal>TIMELINE_LIMIT_HOURLY</literal>, <literal>TIMELINE_LIMIT_MONTHLY</literal>, <literal>TIMELINE_LIMIT_WEEKLY</literal>, <literal>TIMELINE_LIMIT_YEARLY</literal>
     </term>
     <listitem>
      <para>
       Número de instantâneos para manter por hora, dia, mês, semana e ano.
      </para>
      <para>
       O valor padrão de cada entrada é <literal>"10"</literal>, exceto para <literal>TIMELINE_LIMIT_WEEKLY</literal>, que, por padrão, é definido como <literal>"0"</literal>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><literal>TIMELINE_MIN_AGE</literal>
     </term>
     <listitem>
      <para>
       Define a duração mínima em segundos do instantâneo antes de ser automaticamente apagado.
      </para>
      <para>
       O valor padrão é <literal>"1800"</literal>.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <example xml:id="ex-snapper-config-timeline">
    <title>Exemplo de configuração de linha do tempo</title>
<screen>TIMELINE_CLEANUP="yes"
TIMELINE_CREATE="yes"
TIMELINE_LIMIT_DAILY="7"
TIMELINE_LIMIT_HOURLY="24"
TIMELINE_LIMIT_MONTHLY="12"
TIMELINE_LIMIT_WEEKLY="4"
TIMELINE_LIMIT_YEARLY="2"
TIMELINE_MIN_AGE="1800"</screen>
    <para>
     Este exemplo de configuração habilita os instantâneos por hora, que são limpos automaticamente. <literal>TIMELINE_MIN_AGE</literal> e <literal>TIMELINE_LIMIT_*</literal> são sempre avaliados juntos. Neste exemplo, a duração mínima de um instantâneo, antes de ser apagado, está definida como 30 minutos (1800 segundos). Como nós criamos instantâneos por hora, isso garante que apenas os instantâneos mais recentes sejam mantidos. Se <literal>TIMELINE_LIMIT_DAILY</literal> não estiver definido como zero, significa que o primeiro instantâneo do dia também será mantido.
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <title>Instantâneos que devem ser mantidos</title>
     <listitem>
      <para>
       De hora em hora: Os últimos 24 instantâneos que foram capturados.
      </para>
     </listitem>
     <listitem>
      <para>
       Diariamente: O primeiro instantâneo diário que foi capturado é mantido para os últimos sete dias.
      </para>
     </listitem>
     <listitem>
      <para>
       Mensalmente: O primeiro instantâneo capturado no último dia do mês é mantido para os últimos 20 meses.
      </para>
     </listitem>
     <listitem>
      <para>
       Semanalmente: O primeiro instantâneo capturado no último dia da semana é mantido para as últimas quatro semanas.
      </para>
     </listitem>
     <listitem>
      <para>
       Anualmente: O primeiro instantâneo capturado no último dia do ano é mantido para os últimos dois anos.
      </para>
     </listitem>
    </itemizedlist>
   </example>
  </sect2>

  <sect2 xml:id="sec-snapper-clean-up-empty">
   <title>Limpando pares de instantâneos que não são diferentes</title>
   <para>
    Conforme explicado em <xref linkend="snapper-snapshot-type"/>, sempre que você executar um módulo do YaST ou o Zypper, um pré-instantâneo é criado na inicialização, e um pós-instantâneo é criado durante o encerramento. Se você não fez nenhuma mudança, não haverá diferença entre os instantâneos pré e pós. Esses tipos de pares de instantâneos <quote>vazios</quote> podem ser automaticamente apagados ao definir os seguintes parâmetros em uma configuração do Snapper:
   </para>
   <variablelist>
    <varlistentry>
     <term><literal>EMPTY_PRE_POST_CLEANUP</literal>
     </term>
     <listitem>
      <para>
       Se definido como <literal>yes</literal> (sim), os pares de instantâneos pré e pós que forem iguais serão apagados.
      </para>
      <para>
       O valor padrão é <literal>"yes"</literal> (sim).
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><literal>EMPTY_PRE_POST_MIN_AGE</literal>
     </term>
     <listitem>
      <para>
       Define a duração mínima, em segundos, do par de instantâneos pré e pós iguais antes de ser automaticamente apagado.
      </para>
      <para>
       O valor padrão é <literal>"1800"</literal>.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec-snapper-clean-up-manual">
   <title>Limpando instantâneos criados manualmente</title>
   <para>
    O Snapper não oferece algoritmos de limpeza personalizados para instantâneos criados manualmente. No entanto, você pode atribuir o algoritmo de limpeza de número ou linha do tempo a um instantâneo criado manualmente. Se você fizer isso, o instantâneo ingressará na <quote>fila de limpeza</quote> do algoritmo especificado. Você pode especificar um algoritmo de limpeza ao criar um instantâneo ou modificar um instantâneo existente:
   </para>
   <variablelist>
    <varlistentry>
     <term><command>snapper create --description "Teste" --cleanup-algorithm number</command>
     </term>
     <listitem>
      <para>
       Cria um instantâneo independente (tipo único) para a configuração padrão (raiz) e atribui o algoritmo de limpeza de <literal>número</literal>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>snapper modify --cleanup-algorithm "timeline" 25</command>
     </term>
     <listitem>
      <para>
       Modifica o instantâneo com o número 25 e atribui o algoritmo de limpeza de <literal>linha do tempo</literal>.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec-snapper-clean-up-quota">
   <title>Adicionando suporte a cotas de disco</title>
   <para>
    Além dos algoritmos de limpeza de número e/ou linha do tempo descritos anteriormente, o Snapper suporta cotas. Você pode definir a porcentagem de espaço disponível que os instantâneos podem ocupar. Esse valor percentual é sempre aplicado ao subvolume Btrfs definido na respectiva configuração do Snapper.
   </para>
   <para> 
       As cotas do Btrfs são aplicadas aos subvolumes, e não aos usuários. Você pode aplicar as cotas de espaço em disco a usuários e grupos (por exemplo, com o comando <command>quota</command>), além de usar as cotas do Btrfs.
   </para>
   <para>
    Se o Snapper foi habilitado durante a instalação, o suporte a cotas é automaticamente habilitado. Se você habilitar manualmente o Snapper em algum momento futuro, poderá habilitar o suporte a cotas executando <command>snapper setup-quota</command>. Isso exige uma configuração válida (consulte a <xref linkend="sec-snapper-config"/> para obter mais informações).
   </para>
   <para>
    O suporte a cotas é controlado pelos seguintes parâmetros de uma configuração do Snapper.
   </para>
   <variablelist>
    <varlistentry>
     <term><literal>QGROUP</literal>
     </term>
     <listitem>
      <para>
       O grupo de cotas Btrfs usado pelo Snapper. Se não foi definido, execute <command>snapper setup-quota</command>. Se já foi definido, apenas mude se você estiver familiarizado com <command>man 8 btrfs-qgroup</command>. Esse valor é definido com <command>snapper setup-quota</command> e não deve ser mudado.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><literal>SPACE_LIMIT</literal>
     </term>
     <listitem>
      <para>
       Limite de espaço que os instantâneos podem ocupar em frações de 1 (100%). Os valores válidos são de 0 a 1 (0,1 = 10%, 0,2 = 20%, etc.).
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <para>
    As seguintes diretrizes e limitações são aplicadas:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      As cotas apenas são ativadas <emphasis>adicionalmente</emphasis> a um algoritmo de limpeza de número e/ou linha do tempo existente. Se nenhum algoritmo de limpeza estiver ativo, as restrições de cotas não serão aplicadas.
     </para>
    </listitem>
    <listitem>
     <para>
      Com o suporte a cotas habilitado, o Snapper executa duas limpezas, se necessário. A primeira execução aplica-se às regras especificadas para os instantâneos de número e linha do tempo. Apenas se a cota for excedida após essa execução, as regras específicas da cota serão aplicadas em uma segunda execução.
     </para>
    </listitem>
    <listitem>
     <para>
      Mesmo se o suporte a cotas estiver habilitado, o Snapper sempre manterá o número de instantâneos especificado com os valores <literal>NUMBER_LIMIT*</literal> e <literal>TIMELINE_LIMIT*</literal>, até quando a cota for excedida. Portanto, é recomendável especificar valores de faixa (<literal><replaceable>MÍN</replaceable>-<replaceable>MÁX</replaceable></literal>) para <literal>NUMBER_LIMIT*</literal> e <literal>TIMELINE_LIMIT*</literal> para garantir que a cota seja aplicada.
     </para>
     <para>
      Por exemplo, se for definido <literal>NUMBER_LIMIT=5-20</literal>, o Snapper executará uma primeira limpeza e reduzirá o número de instantâneos numerados regulares para 20. Se esses 20 instantâneos excederem a cota, o Snapper apagará os mais antigos em uma segunda execução até que a cota seja atendida. Um mínimo de cinco instantâneos é sempre mantido, independentemente da quantidade de espaço que ocupam.
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
</sect1>
 
  <sect1>
      <title>Mostrando o espaço em disco exclusivo usado pelos instantâneos</title>
     <para>
      Os instantâneos compartilham dados para uso eficiente do espaço de armazenamento, portanto, o uso de comandos comuns como <command>du</command> e <command>df</command> não medirá o espaço em disco usado com precisão. Para liberar espaço em disco no Btrfs com as cotas habilitadas, você precisa saber quanto espaço em disco exclusivo é usado por cada instantâneo, em vez do espaço compartilhado. A partir do Snapper 0.6, o espaço em disco usado é relatado para cada instantâneo na coluna <literal>Used Space</literal>:
</para>
<screen><prompt role="root">root # </prompt>snapper--iso list
  # | Type   | Pre # | Date                | User | Used Space | Cleanup | Description           | Userdata     
----+--------+-------+---------------------+------+------------+---------+-----------------------+--------------
 0  | single |       |                     | root |            |         | current               |              
 1* | single |       | 2019-07-22 13:08:38 | root |  16.00 KiB |         | first root filesystem |              
 2  | single |       | 2019-07-22 14:21:05 | root |  14.23 MiB | number  | after installation    | important=yes
 3  | pre    |       | 2019-07-22 14:26:03 | root | 144.00 KiB | number  | zypp(zypper)          | important=no 
 4  | post   |     3 | 2019-07-22 14:26:04 | root | 112.00 KiB | number  |                       | important=no 
 5  | pre    |       | 2019-07-23 08:19:36 | root | 128.00 KiB | number  | zypp(zypper)          | important=no 
 6  | post   |     5 | 2019-07-23 08:19:43 | root |  80.00 KiB | number  |                       | important=no 
 7  | pre    |       | 2019-07-23 08:20:50 | root | 256.00 KiB | number  | yast sw_single        |              
 8  | pre    |       | 2019-07-23 08:23:22 | root | 112.00 KiB | number  | zypp(ruby.ruby2.5)    | important=no 
 9  | post   |     8 | 2019-07-23 08:23:35 | root |  64.00 KiB | number  |                       | important=no 
10  | post   |     7 | 2019-07-23 08:24:05 | root |  16.00 KiB | number  |                       |              
</screen>
<para>
    O comando <command>btrfs</command> apresenta outra exibição do espaço usado pelos instantâneos:
</para>
<screen>
<prompt role="root">root # </prompt>btrfs qgroup show -p /
qgroupid         rfer         excl parent  
--------         ----         ---- ------  
0/5          16.00KiB     16.00KiB ---     
[...]    
0/272         3.09GiB     14.23MiB 1/0     
0/273         3.11GiB    144.00KiB 1/0     
0/274         3.11GiB    112.00KiB 1/0     
0/275         3.11GiB    128.00KiB 1/0     
0/276         3.11GiB     80.00KiB 1/0     
0/277         3.11GiB    256.00KiB 1/0     
0/278         3.11GiB    112.00KiB 1/0     
0/279         3.12GiB     64.00KiB 1/0     
0/280         3.12GiB     16.00KiB 1/0     
1/0           3.33GiB    222.95MiB --- 
</screen>
<para>
    A coluna <literal>qgroupid</literal> exibe o número de identificação de cada subvolume, atribuindo uma combinação de nível/ID do qgroup.
</para> 
<para>
    A coluna <literal>rfer</literal> exibe o volume total de dados mencionados no subvolume.
</para>
<para>
    A coluna <literal>excl</literal> exibe os dados exclusivos em cada subvolume. 
</para>
<para>
    A coluna <literal>parent</literal> mostra o qgroup pai dos subvolumes.
</para>
<para>    
    O item final <literal>1/0</literal> mostra os totais para o qgroup pai. No exemplo acima, 222,95 MiB serão liberados se todos os subvolumes forem removidos. Execute o comando a seguir para ver os instantâneos que estão associados a cada subvolume:
</para>
<screen><prompt role="root">root # </prompt>btrfs subvolume list -st /
ID	gen	top level	path	
--	---	---------	----	
267	298	266		@/.snapshots/1/snapshot
272	159	266		@/.snapshots/2/snapshot
273	170	266		@/.snapshots/3/snapshot
274	171	266		@/.snapshots/4/snapshot
275	287	266		@/.snapshots/5/snapshot
276	288	266		@/.snapshots/6/snapshot
277	292	266		@/.snapshots/7/snapshot
278	296	266		@/.snapshots/8/snapshot
279	297	266		@/.snapshots/9/snapshot
280	298	266		@/.snapshots/10/snapshot
</screen>
     <para>
      Um upgrade de um pacote de serviço para outro resulta em instantâneos que ocupam muito espaço em disco nos subvolumes do sistema. É recomendada a exclusão manual dos instantâneos quando eles não são mais necessários. Consulte a <xref linkend="sec-snapper-manage-delete"/> para obter os detalhes. 
     </para>
 </sect1>

 <sect1 xml:id="sec-snapper-faqs">
  <title>Perguntas freqÃ¼entes</title>

  <qandaset defaultlabel="qanda">
   <qandaentry>
    <question>
     <para>
      Por que o Snapper nunca mostra as mudanças em <filename>/var/log</filename>, <filename>/tmp</filename> e outros diretórios?
     </para>
    </question>
    <answer>
     <para>
      Para alguns diretórios, nós decidimos excluí-los dos instantâneos. Consulte a <xref linkend="snapper-dir-excludes"/> para ver a lista e os motivos. Para excluir um caminho dos instantâneos, nós criamos um subvolume para esse caminho.
     </para>
    </answer>
   </qandaentry>
   <qandaentry>
    <question>
     <para>
      Posso inicializar um instantâneo do carregador de boot?
     </para>
    </question>
    <answer>
     <para>
      Sim, veja os detalhes na <xref linkend="sec-snapper-snapshot-boot"/>.
     </para>
    </answer>
   </qandaentry>
   <qandaentry xml:id="faq-snapper-permanent">
    <question>
     <para>
      Um instantâneo pode ser protegido contra exclusão?
     </para>
    </question>
    <answer>
     <para>
      Atualmente, o Snapper não oferece meios para evitar que um instantâneo seja apagado manualmente. No entanto, você pode impedir que os instantâneos sejam automaticamente apagados por algoritmos de limpeza. Os instantâneos criados manualmente (consulte a <xref linkend="sec-snapper-manage-create"/>) não têm algoritmo de limpeza atribuído, a menos que você especifique um com <option>--cleanup-algorithm</option>. Os instantâneos criados automaticamente sempre têm o algoritmo de <literal>número</literal> ou de <literal>linha do tempo</literal> atribuído. Para remover esse tipo de atribuição de um ou mais instantâneos, faça o seguinte:
     </para>
     <procedure>
      <step>
       <para>
        Liste todos os instantâneos disponíveis:
       </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper list -a</screen>
      </step>
      <step>
       <para>
        Memorize o número de instantâneos cuja exclusão deve ser evitada.
       </para>
      </step>
      <step>
       <para>
        Execute o seguinte comando e substitua os marcadores de número pelos números que você memorizou:
       </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper modify --cleanup-algorithm "" <replaceable>#1</replaceable> <replaceable>#2</replaceable> <replaceable>#n</replaceable></screen>
      </step>
      <step>
       <para>
        Verifique o resultado executando <command>snapper list -a</command> novamente. Agora, a entrada na coluna <literal>Limpeza</literal> deve estar vazio para os instantâneos que você modificou.
       </para>
      </step>
     </procedure>
    </answer>
   </qandaentry>
   <qandaentry>
    <question>
     <para>
      Onde encontro mais informações sobre o Snapper?
     </para>
    </question>
    <answer>
     <para>
      Consulte a home page do Snapper em <link xlink:href="http://snapper.io/"/>.
     </para>
    </answer>
   </qandaentry>
  </qandaset>
 </sect1>
</chapter>
