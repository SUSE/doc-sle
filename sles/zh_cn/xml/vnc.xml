<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="vnc.xml" version="5.0" xml:id="cha.vnc">
 <title>使用 VNC 远程访问</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    利用虚拟网络计算（Virtual Network Computing，VNC）可以通过图形桌面控制远程计算机（与远程外壳访问相对）。VNC 是独立于平台的并允许您从任何操作系统访问远程计算机。
   </para>

   <para>
    <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 支持两种不同种类的 VNC 会话：自客户端启动起在 VNC 连接期间<quote>在线</quote>的一次性会话和始终<quote>在线</quote>直到被明确终止的永久会话。
   </para>
  </abstract>
 </info>
 <note>
  <title>会话类型</title>
  <para>
   一台计算机可在不同端口上同时提供两种会话，但当会话打开后不能从一种类型转换为另一种类型。
  </para>
 </note>
 
 <sect1 xml:id="sec.vnc.viewer">
  <title><command>vncviewer</command> 客户端</title>

  <para>
   要连接到服务器提供的 VNC 服务，需要使用客户端。<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 中的默认客户端是 <command>tigervnc</command> 包提供的 <systemitem class="resource">vncviewer</systemitem>。
  </para>

  <sect2 xml:id="sec.vnc.viewer.connectcli">
   <title>使用 vncviewer CLI 进行连接</title>
   <para>
    要启动 VNC 查看器并发起与服务器的会话，请使用以下命令：
   </para>
<screen>vncviewer jupiter.example.com:1</screen>
   <para>
    若不使用 VNC 显示器编号，您也可以指定带两个冒号的端口号：
   </para>
<screen>vncviewer jupiter.example.com::5901</screen>
   <note>
    <title>注意：显示号和端口号</title>
    <para>
     您在 VNC 客户端中指定的实际显示号或端口号必须与在目标计算机上通过 <command>vncserver</command> 命令提取的显示号或端口号相同。有关更多信息，请参见<xref linkend="sec.vnc.persistent"/>。
    </para>
   </note>
  </sect2>

  <sect2 xml:id="sec.vnc.viewer.connectgui">
   <title>使用 vncviewer GUI 进行连接</title>
   <para>
    在不指定 <command>--listen</command> 或要连接的主机的情况下运行 <command>vncviewer</command> 会显示一个窗口，要求您输入连接细节。按<xref linkend="sec.vnc.viewer.connectcli"/>中所述在 <guimenu>VNC 服务器</guimenu>字段中输入主机，然后单击<guimenu>连接</guimenu>。
   </para>
   <figure xml:id="fig.vnc.viewer.connectgui">
    <title>vncviewer</title>
    <mediaobject>
     <textobject role="description"><phrase>vncviewer 要求输入连接细节</phrase>
     </textobject>
     <imageobject role="html">
      <imagedata fileref="vnc_connect.png" format="PNG"/>
     </imageobject>
     <imageobject role="fo">
      <imagedata fileref="vnc_connect.png" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
  </sect2>

  <sect2 xml:id="sec.vnc.viewer.encrypt">
   <title>未加密连接通知</title>
   <para>
    VNC 协议支持不同类型的加密连接，请不要将这些连接与口令身份验证相混淆。如果某个连接未使用 TLS，VNC 查看器的窗口标题中可能会出现<quote>（连接未加密！）</quote>文本。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.vnc.one-time">
  <title>一次性 VNC 会话</title>

  <para>
   一次性会话由远程客户端启动。它在服务器上启动图形登录屏幕。这样您可以选择启动会话的用户，并且如果登录管理器支持，还可以选择桌面环境。终止与此类 VNC 会话的客户端连接时，此会话中启动的所有应用程序也将终止。一次性 VNC 会话不能共享，但可以在一台主机上同时存在多个会话。
  </para>

  <procedure xml:id="pro.vnc.one-time.activate">
   <title>启用一次性 VNC 会话</title>
   <step>
    <para>
     启动 <menuchoice> <guimenu>YaST</guimenu> <guimenu> 网络服务</guimenu> <guimenu> 远程管理 (VNC)</guimenu>
     </menuchoice>。
    </para>
   </step>
   <step>
    <para>
     选中<guimenu>允许远程管理</guimenu>。
    </para>
   </step>
   <step>
    <para>
     如果需要，还可以选中<guimenu>打开防火墙中的端口</guimenu>（例如，当网络接口配置为在外部区域中时）。如果有多个网络接口，请通过<guimenu>防火墙细节</guimenu>将打开防火墙端口限制为特定的接口。
    </para>
   </step>
   <step>
    <para>
     单击<guimenu>完成</guimenu>确认您的设置。
    </para>
   </step>
   <step>
    <para>
     如果不是所有需要的包都可使用，则需要批准安装缺少的包。
    </para>
   </step>
  </procedure>

  <sect2 xml:id="sec.vnc.one-time.configs">
   <title>可用配置</title>
   <para>
    <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 上的默认配置对会话使用 1024x768 像素（颜色深度 16 位）。会话在端口 <systemitem class="resource">5901</systemitem>（对于<quote>普通</quote>VNC 查看器，等同于 VNC 显示器 <literal>1</literal>）和端口 <systemitem class="resource">5801</systemitem> 上可用（对于 Web 浏览器）。
   </para>
   <para>
    其他配置可在不同端口上使用<phrase os="sles;osuse">，请参见<xref linkend="sec.vnc.one-time.config"/></phrase>。
   </para>
   <para>
    VNC 显示器编号和 X 显示器编号是独立于一次性会话的。VNC 显示器编号手动指派给服务器支持的每个配置（如上例中的 :1）。只要 VNC 会话启动时带任一配置，就会自动获取可用 X 显示器编号。
   </para>
   <para>
    默认情况下，VNC 客户端与服务器将尝试通过安装后生成的自我签名 SSL 证书安全通讯。您可以使用默认的证书，也可以将它替换为您自己的证书。使用自我签名证书时，需要在首次连接之前，在 VNC 查看器和 Web 浏览器中确认证书的签名。Java 客户端是使用与 VNC 相同的证书通过 HTTPS 提供的。
   </para>
  </sect2>

  <sect2 xml:id="sec.vnc.one-time.connect">
   <title>启动一次性 VNC 会话</title>
   <para>
    要连接永久的 VNC 会话，必须安装 VNC 查看器。另请参见<xref linkend="sec.vnc.viewer"/>。或者通过在支持 Java 的 Web 浏览器中输入以下 URL 查看 VNC 会话：<literal>http://jupiter.example.com:5801</literal>
   </para>
  </sect2>

  <sect2 xml:id="sec.vnc.one-time.config">
   <title>配置一次性 VNC 会话</title>
   <para>
    如果不需要或想修改默认配置，则可以跳过此部分。
   </para>
   <para>
    一次性 VNC 会话通过 <systemitem class="daemon">xinetd</systemitem> 守护程序启动。配置文件位于 <filename>/etc/xinetd.d/vnc</filename>。默认情况下提供六个配置块：三个用于 VNC 查看器（<literal>vnc1</literal> 到 <literal>vnc3</literal>），另外三个用于 Java 小程序（<literal>vnchttpd1</literal> 到 <literal>vnchttpd3</literal>）。默认情况下，只有 <literal>vnc1</literal> 和 <literal>vnchttpd1</literal> 是活动的。
   </para>
   <para>
    要激活配置，请在第一列用 <literal>#</literal> 字符注释掉 <literal>disable = yes</literal> 行，或者完全删除该行。要停用配置，请取消注释或添加该行。
   </para>
   <para>
    <command>Xvnc</command> 服务器可以通过 <literal>server_args</literal> 选项来配置；有关选项列表，请参见 <command>Xnvc --help</command>。
   </para>
   <para>
    当添加自定义配置时，请确保它们未使用已由其他配置、其他服务或同一主机上的现有永久 VNC 会话使用的端口。
   </para>
   <para>
    通过输入以下命令激活配置更改：
   </para>
<screen>sudo systemctl reload xinetd</screen>
   <important>
    <title>防火墙和 VNC 端口</title>
    <para>
     按照<xref linkend="pro.vnc.one-time.activate"/> 中的描述激活远程管理时，端口 <systemitem class="resource">5801</systemitem> 和 <systemitem class="resource">5901</systemitem> 将在防火墙中打开。如果用于 VNC 会话的网络接口受防火墙保护，则为 VNC 会话激活更多端口时，需要手动打开各个端口。有关指导，请参见<xref linkend="cha.security.firewall"/>。
    </para>
   </important>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.vnc.persistent">
  <title>持续 VNC 会话</title>

  <para>
   永久 VNC 会话在服务器上启动。该会话和其上启动的所有应用程序运行时不考虑客户端连接，直到会话被终止。
  </para>

  <para>
   可以从多个客户端同时访问持续 会话。为了便于演示，我们选择一个较为理想的配置，一个客户端具有完全访问权限，所有其他客户端只具有查看访问权限。另一个用例是教员可能需要访问学员桌面的培训。但是，大多数时间，您可能不希望共享您的 VNC 会话。
  </para>

  <para>
   与启动显示管理器的一次性会话不同，永久会话启动的是一个随时可运行的桌面，该桌面以启动 VNC 会话的用户身份运行。对持续会话的访问受口令的保护。
  </para>

  <para>
   永久会话访问受到两种可用口令类型的保护：
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     授予完全访问权限的普通口令或
    </para>
   </listitem>
   <listitem>
    <para>
     可选仅查看口令，授予非交互（仅查看）访问权限。
    </para>
   </listitem>
  </itemizedlist>

  <para>
   一个会话可一次具有两种类型的多个客户端连接。
  </para>

  <procedure xml:id="pro.vnc.persistent.activate">
   <title>启动持续 VNC 会话</title>
   <step>
    <para>
     打开外壳，确保以拥有 VNC 会话的用户身份登录。

    </para>
   </step>
   <step>
    <para>
     如果用于 VNC 会话的网络接口受防火墙保护，则需要手动打开防火墙中您的会话所使用的端口。如果启动多个会话，还可以选择打开一个端口范围。有关如何配置防火墙的细节，请参见<xref linkend="cha.security.firewall"/>。
    </para>
    <para>
     <command>vncserver</command> 对显示器 <literal>:1</literal> 使用端口 <systemitem class="resource">5901</systemitem>，对显示器 <literal>:2</literal> 使用端口 <systemitem class="resource">5902</systemitem>，依次类推。对于永久会话，VNC 显示器和 X 显示器通常具有相同编号。
    </para>
   </step>
   <step>
    <para>
     要其他具有 1024x769 像素和颜色深度为 16 的会话，请输入以下命令：
    </para>
<screen>vncserver -geometry 1024x768 -depth 16</screen>
    <para>
     <command>vncserver</command> 命令会在您未指定时选取一个未使用的显示编号，并打印输出它的选择。有关更多选项，请参见 <command>man 1 vncserver</command>。
    </para>
   </step>
  </procedure>

  <para>
   当您首次运行 <command>vncserver</command> 时，它会要求您输入一个口令，以获取会话的完全访问权限。如果需要，还可以提供口令用于会话的仅查看访问。
  </para>

  <para>
   这里提供的口令还用作同一用户将来启动会话的口令。这些口令可以用 <command>vncpasswd</command> 命令更改。
  </para>

  <important>
   <title>安全考虑因素</title>
   <para>
    确保使用长度够长的高强度口令（八个或更多字符）。不要共享这些口令。
   </para>
  </important>

  <para>
   要终止会话，请从 VNC 查看器中关闭运行于 VNC 会话内的桌面环境，像您关闭普通本地 X 会话那样关闭它。
  </para>

  <para>
   如果希望手动终止会话，请在 VNC 服务器上打开外壳并确保您已作为拥有要终止的 VNC 会话的用户登录。运行以下命令来终止在显示器 <literal>:1</literal> 上运行的会话：<command>vncserver -kill :1</command>
  </para>

  <sect2 xml:id="sec.vnc.persistent.connect">
   <title>连接持续 VNC 会话</title>
   <para>
    要连接永久的 VNC 会话，必须安装 VNC 查看器。另请参见<xref linkend="sec.vnc.viewer"/>。或者通过在支持 Java 的 Web 浏览器中输入以下 URL 查看 VNC 会话：<literal>http://jupiter.example.com:5801</literal>
   </para>
  </sect2>

  <sect2 xml:id="sec.vnc.persistent.configure">
   <title>配置持续 VNC 会话</title>
   <para>
    通过编辑 <filename>$HOME/.vnc/xstartup</filename> 可以配置持续 VNC 会话。默认情况下，此外壳脚本会启动它启动时所处的同一个 GUI/窗口管理器。在 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 中，此 GUI/窗口管理器为 GNOME 或 IceWM。如果要使用您选择的窗口管理器启动会话，请设置变量 <envar>WINDOWMANAGER</envar>：
   </para>
<screen>WINDOWMANAGER=gnome vncserver -geometry 1024x768
WINDOWMANAGER=icewm vncserver -geometry 1024x768</screen>
   <note>
    <title>每个用户一种配置</title>
    <para>
     持续 VNC 会话在单个按用户配置中进行配置。由同一个用户启动的多个会话都使用相同的启动文件和口令文件。
    </para>
   </note>
  </sect2>
 </sect1>
 <sect1 xml:id="vnc.encrypted">
  <title>加密 VNC 通讯</title>

  <para>
   如果 VNC 服务器设置正确，则 VNC 服务器与客户端之间的所有通讯都会被加密。这包括开始时的身份验证及后来的所有数据传输。
  </para>

  <para>
   无论您要启动哪类 VNC 会话（一次性或持久性），都可通过 <literal>server_args</literal> 行中 <command>/usr/bin/Xvnc</command> 命令的 <option>-securitytypes</option> 参数配置安全性选项。<option>-securitytypes</option> 参数会选择身份验证方法和加密。它的选项如下：
  </para>

  <variablelist>
   <title>身份验证</title>
   <varlistentry>
    <term>None、TLSNone、X509None</term>
    <listitem>
     <para>
      无身份验证。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>VncAuth、TLSVnc、X509Vnc</term>
    <listitem>
     <para>
      身份验证使用自定义口令。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Plain、TLSPlain、X509Plain</term>
    <listitem>
     <para>
      身份验证使用 PAM 来验证用户的口令。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <variablelist>
   <title>加密</title>
   <varlistentry>
    <term>None、VncAuth、Plain</term>
    <listitem>
     <para>
      不加密。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>TLSNone、TLSVnc、TLSPlain</term>
    <listitem>
     <para>
      匿名 TLS 加密。对所有内容加密，但不校验远程主机。因此，您可以防护被动攻击者，但不能防御中间人攻击者。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>X509None、X509Vnc、X509Plain</term>
    <listitem>
     <para>
      使用证书进行 TLS 加密。如果使用自我签名证书，则在第一次连接时，系统将要求您校验证书。在以后的连接中，仅当证书有变动时，系统才会向您发出警告。因此，在第一次连接时，您可以防御中间人攻击之外的所有其他攻击（类似于使用典型的 SSH）。如果使用由证书颁发机构签名且与计算机名称匹配的证书，将可获得完整的安全性（类似于使用典型的 HTTPS）。
     </para>
     <tip>
      <title>证书和密钥的路径</title>
      <para>
       对于基于 X509 的加密，需要通过 <option>-X509Cert</option> 和 <option>-X509Key</option> 选项指定 X509 证书和密钥的路径。
      </para>
     </tip>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   如果您选择多种安全性类型（用逗号分隔），将会使用客户端和服务器都支持且允许的第一种安全性。如此，您便可在服务器上配置随机加密。如果您需要支持不支持加密的 VNC 客户端，此功能将十分有用。
  </para>

  <para>
   在客户端上，您也可以指定允许的安全性类型，以防在您连接到已知启用了加密的服务器时遭到降级攻击（虽然在该情况下，我们的 vncviewer 会发出“连接未加密！”讯息来警告您）。
  </para>
 </sect1>
</chapter>
