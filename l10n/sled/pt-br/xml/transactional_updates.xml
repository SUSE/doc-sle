<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="transactional_updates.xml" version="5.0" xml:id="cha-transactional-updates" xml:lang="pt-br">
 <title>Atualizações transacionais</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    As atualizações transacionais estão disponíveis no <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> como prévia de tecnologia para atualizar o SLES quando o sistema de arquivos raiz é apenas leitura. As atualizações transacionais são atômicas (todas as atualizações serão aplicadas apenas se todas forem bem-sucedidas) e suportam rollbacks. Isso não afeta o sistema em execução, já que as mudanças não são ativadas até o sistema ser reinicializado. Como as reinicializações são interruptivas, o administrador deve decidir se a reinicialização é mais onerosa do que a desestabilização dos serviços em execução. Se as reinicializações forem muito onerosas, não use as atualizações transacionais.
   </para>

   <para>
    As atualizações transacionais são executadas diariamente pelo script <command>transactional-update</command>. O script verifica as atualizações que estão disponíveis. Se houver quaisquer atualizações, ele criará um novo instantâneo do sistema de arquivos raiz em segundo plano e, em seguida, buscará as atualizações dos canais de versão. Depois que o novo instantâneo for totalmente atualizado, ele será marcado como ativo e será o novo sistema de arquivos raiz padrão após a próxima reinicialização do sistema. Quando o <command>transactional-update</command> está definido para ser executado automaticamente (que é o comportamento padrão), ele também reinicializa o sistema. O tempo de execução da atualização e a janela de manutenção da reinicialização são configuráveis.
   </para>

   <para>
    Apenas os pacotes que fazem parte do instantâneo do sistema de arquivos raiz podem ser atualizados. Se os pacotes contiverem arquivos que não fazem parte do instantâneo, a atualização poderá falhar ou danificar o sistema.
   </para>

   <para>
    Os RPMs que requerem a aceitação de uma licença não podem ser atualizados.
   </para>
  </abstract>
 </info>
 
 <sect1 xml:id="sec-tu-limitations">
  <title>Limitações da prévia de tecnologia</title>

  <para>
   Como uma prévia de tecnologia, há algumas limitações de funcionalidade. Os seguintes pacotes não funcionarão com o <command>transactional-update</command>:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     A página index.html padrão de <package>nginx</package> talvez não esteja disponível
    </para>
   </listitem>
   <listitem>
    <para>
     <package>tomcat-webapps</package> e <package>tomcat-admin-webapps</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>phpMyAdmin</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>sca-appliance-*</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>mpi-selector</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>emacs</package> funciona exceto para jogos do Emacs
    </para>
   </listitem>
   <listitem>
    <para>
     <package>bind</package> e <package>bind-chrootenv</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>docbook*</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>sblim-sfcb*</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>texlive*</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>iso_ent</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>openjade</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>opensp</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>pcp</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>plymouth</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>postgresql-server-10</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>pulseaudio-gdm-hooks</package>
    </para>
   </listitem>
   <listitem>
    <para>
     <package>smartmontools</package>
    </para>
   </listitem>
  </itemizedlist>

  <para>
   O componente atualizador do instalador do sistema não funciona com um sistema de arquivos apenas leitura porque ele não tem suporte para atualizações transacionais.
  </para>

  <para>
   Outras considerações:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Em geral, convém minimizar o tempo entre a atualização do sistema e a reinicialização da máquina.
    </para>
   </listitem>
   <listitem>
    <para>
     É possível aplicar apenas uma atualização de cada vez. Certifique-se de reinicializar após uma atualização e antes que a próxima atualização seja aplicada.
    </para>
   </listitem>
   <listitem>
    <para>
     <command>update-alternatives</command> apenas deve ser executado após uma atualização transacional depois que a máquina for reinicializada.
    </para>
   </listitem>
   <listitem>
    <para>
     Somente crie novos usuários ou grupos de sistema após uma atualização transacional depois da reinicialização. É aceitável criar usuários e grupos normais (UID &gt; 1000, GID &gt; 1000).
    </para>
   </listitem>
   <listitem>
    <para>
     O YaST ainda não reconhece as atualizações transacionais. Se um módulo do YaST precisar instalar mais pacotes, esse procedimento não funcionará. Operações de sistema normais que apenas modificam os arquivos de configuração em <filename>/etc</filename> funcionarão.
    </para>
   </listitem>
   <listitem>
    <para>
     Para <package>php7-fastcgi</package>, você deve criar um link simbólico manualmente, <filename>/srv/www/cgi-bin/php</filename>, que aponta para <filename>/usr/bin/php-cgi</filename>.
    </para>
   </listitem>
   <listitem>
    <para>
     <package>ntp</package>faz parte do Módulo Legacy para migração de versões mais antigas do SLES. Ele não é suportado em uma nova instalação do <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> e foi substituído pelo <package>chrony</package>. Se você continuar usando o <package>ntp</package>, uma nova instalação será necessária para funcionar corretamente com as atualizações transacionais.
    </para>
   </listitem>
   <listitem>
    <para>
     <package>sblim-sfcb</package>: Todo o ecossistema do sblim é incompatível com a atualização transacional.
    </para>
   </listitem>
   <listitem>
    <para>
     O <command>btrfs-defrag</command> do pacote <package>btrfsmaintenance</package> não funciona com um sistema de arquivos raiz apenas leitura.
    </para>
   </listitem>
   <listitem>
    <para>
     Para <command>btrfs-balance</command>, a variável <literal>BTRFS_BALANCE_MOUNTPOINTS</literal> em <filename>/etc/sysconfig/btrfsmaintenance</filename> deve ser mudada de <literal>/</literal> para <literal>/.snapshots</literal>.
    </para>
   </listitem>
   <listitem>
    <para>
     Para <command>btrfs-scrub</command>, a variável <literal>BTRFS_SCRUB_MOUNTPOINTS</literal> em <filename>/etc/sysconfig/btrfsmaintenance</filename> deve ser mudada de <literal>/</literal> para <literal>/.snapshots</literal>.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec-install-tu">
  <title>Habilitar <package>transactional-update</package></title>
  <para>
   Você deve habilitar o Módulo Servidor Transacional durante a instalação do sistema e, em seguida, selecionar a Função do Sistema Servidor Transacional. NÃO há suporte para a instalação de qualquer pacote a partir do Módulo Servidor Transacional em um sistema em execução, e isso pode danificar o sistema.
  </para>
  <para>
      Observe que não é suportado mudar o layout do subvolume da partição raiz nem colocar subdiretórios ou subvolumes da partição raiz em suas próprias partições (exceto <filename>/home</filename>, <filename>/var</filename>, <filename>/srv</filename> e <filename>/opt</filename>), e isso muito provavelmente danificará o sistema.
  </para>
 </sect1>
 
  <sect1 xml:id="sec-tu-disable">
  <title>Gerenciando as atualizações automáticas</title>
  <para>
      As atualizações automáticas são controladas por um <command>systemd.timer</command> que é executado uma vez por dia. Ele é aplicado a todas as atualizações e informa o <command>rebootmgrd</command> de que a máquina deve ser reinicializada. Você pode ajustar o horário de execução da atualização. Consulte systemd.timer(5). Para ajustar a janela de manutenção, que é quando o <command>rebootmgrd</command> reinicializa o sistema, consulte rebootmgrd(8).
  </para>
  <para>
   Você pode desabilitar as atualizações transacionais automáticas com este comando:
  </para>

<screen><prompt role="root"># </prompt><command>systemctl --now disable transactional-update.timer</command></screen>
</sect1>
 
 <sect1>
  <title>Comando <command>transactional-update</command></title>
  <para>
   O comando <command>transactional-update</command> habilita a instalação atômica ou a remoção de atualizações. As atualizações serão aplicadas apenas se todas elas puderem ser instaladas com êxito. O <command>transactional-update</command> cria um instantâneo do seu sistema antes de aplicar a atualização, e você pode restaurar esse instantâneo. Todas as mudanças se tornarão ativas apenas após a reinicialização.
  </para>

<variablelist>
  <varlistentry>
   <term><literal>--continue</literal></term>
   <listitem>
     <para>
         A opção <command>--continue</command> é usada para fazer várias mudanças em um instantâneo existente sem reinicialização.
     </para>
     <para>
         O comportamento padrão do <command>transactional-update</command> é criar um novo instantâneo do sistema de arquivos raiz atual. Se você se esquecer de alguma coisa, como de instalar um novo pacote, terá de reinicializar para aplicar as mudanças anteriores, executar o <command>transactional-update</command> novamente para instalar o pacote que ficou faltando e reinicializar outra vez. Não é possível executar o comando <command>transactional-update</command> várias vezes sem reinicialização para adicionar outras mudanças ao instantâneo, pois isso cria instantâneos independentes separados que não incluem as mudanças dos instantâneos anteriores.
     </para>
     <para>
         Use a opção <command>--continue</command> para fazer quantas mudanças desejar sem reinicialização. Um instantâneo separado é gerada toda vez, e cada instantâneo contém todas as mudanças efetuadas nos instantâneos anteriores, além das novas mudanças. Repita esse processo quantas vezes desejar e, quando o instantâneo final incluir tudo o que você quer, reinicialize o sistema para que o instantâneo final se torne o novo sistema de arquivos raiz.
     </para>
     <para>
         Outro recurso útil da opção <command>--continue</command> é que você pode selecionar uma instantâneo existente como base para seu novo instantâneo. O seguinte exemplo demonstra a execução do <command>transactional-update</command> para instalar um novo pacote em um instantâneo com base no instantâneo 13 e, em seguida, uma nova execução para instalar outro pacote:
     </para>
     <screen><prompt role="root"># </prompt><command>transactional-update pkg install <replaceable>package_1</replaceable></command></screen>
    <screen><prompt role="root"># </prompt><command>transactional-update --continue 13 pkg install <replaceable>package_2</replaceable></command></screen>
    <para>
        A opção <command>--continue [num]</command> chama <command>snapper create --from</command>. Consulte a <xref linkend="sec-snapper-manage-create"/>.
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><literal>cleanup</literal></term>
   <listitem>
  <para>
    Se o sistema de arquivos raiz atual for idêntico ao sistema de arquivos raiz ativo (após uma reinicialização, antes que <command>transactional-update</command> crie um novo instantâneo com as atualizações), todos os instantâneos antigos sem um algoritmo de limpeza terão esse algoritmo definido. Isso garante que o Snapper apague os instantâneos antigos. (Consulte a seção sobre algoritmos de limpeza em snapper(8).) Isso também remove todos os diretórios sobrepostos <filename>/etc</filename> não referenciados (e, portanto, não utilizados) em <filename>/var/lib/overlay</filename>:
  </para>
<screen><prompt role="root"># </prompt><command>transactional-update cleanup</command></screen>
    </listitem>
   </varlistentry>  
   <varlistentry>
    <term><literal>pkg in/install</literal></term>
    <listitem>
     <para>
      Instala pacotes individuais dos canais disponíveis usando o comando <command>zypper install</command>. Também é possível usar esse comando para instalar arquivos RPM de Correção Temporária do Programa (PTF, Program Temporary Fix).
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update pkg install <replaceable>package_name</replaceable></command></screen>
     <para>
      ou
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update pkg install <replaceable>rpm1 rpm2</replaceable></command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>pkg rm/remove</literal></term>
    <listitem>
     <para>
      Remove pacotes individuais do instantâneo ativo usando o comando <command>zypper remove</command>. Também é possível usar esse comando para remover arquivos RPM de PTF.
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update pkg remove <replaceable>package_name</replaceable></command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>pkg up/update</literal></term>
    <listitem>
     <para>
      Atualiza pacotes individuais do instantâneo ativo usando o comando <command>zypper update</command>. Apenas os pacotes que fazem parte do instantâneo do sistema de arquivos base podem ser atualizados.
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update pkg remove <replaceable>package_name</replaceable></command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>up/update</literal></term>
    <listitem>
     <para>
      Se houver novas atualizações disponíveis, um novo instantâneo será criado, e o <command>zypper up/update</command> atualizará o instantâneo.
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update up</command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>dup</literal></term>
    <listitem>
     <para>
      Se houver novas atualizações disponíveis, um novo instantâneo será criado, e o <command>zypper dup –no-allow-vendor-change</command> atualizará o instantâneo. Na sequência, o instantâneo será ativado e se tornará o novo sistema de arquivos raiz após a reinicialização.
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update dup</command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>patch</literal></term>
    <listitem>
     <para>
      Se houver novas atualizações disponíveis, um novo instantâneo será criado, e o <command>zypper patch</command> atualizará o instantâneo.
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update patch</command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>rollback</literal></term>
    <listitem>
     <para>
      Ele define o subvolume padrão. Em sistemas com um sistema de arquivos apenas leitura, <command>snapper rollback</command> é chamado. Em um sistema de arquivos apenas leitura e sem argumentos, o sistema atual é definido como um novo sistema de arquivos raiz padrão. Se você especificar um número, esse instantâneo será usado como o sistema de arquivos raiz padrão. Em um sistema de arquivos apenas leitura, ele não cria nenhum instantâneo adicional.
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update rollback <replaceable>snapshot_number</replaceable></command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>grub.cfg</literal></term>
    <listitem>
     <para>
      Ele cria uma nova configuração do GRUB2. Às vezes, é necessário ajustar a configuração de boot, por exemplo, adicionando outros parâmetros do kernel. Edite <replaceable>/etc/default/grub</replaceable>, execute <command>transactional-update grub.cfg</command> e, em seguida, reinicialize para ativar a mudança. Você deve reinicializar imediatamente, ou a nova configuração do GRUB2 será sobregravada pelo padrão na próxima execução do transactional-update.
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update grub.cfg</command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>reboot</literal></term>
    <listitem>
     <para>
      Esse parâmetro aciona uma reinicialização depois que a ação é concluída.
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update <replaceable>dup</replaceable> reboot</command></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>--help</literal></term>
    <listitem>
     <para>
      Ele imprime uma tela de Ajuda com as opções e os subcomandos.
     </para>
<screen><prompt role="root"># </prompt><command>transactional-update --help</command></screen>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>

 <sect1 xml:id="sec-tu-troubleshooting">
  <title>Solução de problemas</title>

  <para>
   Em caso de falha no upgrade, execute <command>supportconfig</command> para coletar os dados de registro. Envie os arquivos resultantes, incluindo o <filename>/var/log/transactional-update.log</filename>, ao Suporte da SUSE.
  </para>
 </sect1>
</chapter>
