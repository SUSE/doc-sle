<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_sync.xml" version="5.0" xml:id="cha.net.sync">
 <title>Kopieren von Dateien mit RSync</title>
 <info>
  <abstract>
   <para>
    Viele Menschen benutzen heutzutage mehrere Computer: einen Computer zu Hause, einen oder mehrere Computer am Arbeitsplatz und eventuell ein Notebook, ein Tablet oder ein Smartphone unterwegs. Viele Dateien werden auf allen diesen Computern benötigt. Sie sollten Ihre Dateien auf allen Computern bearbeiten können, damit die Daten auf allen Computern auf dem aktuellen Stand sind.
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>Ja</dm:translation>
  </dm:docmanager>
 </info>

 
 <warning>
  <title>Risiko des Datenverlusts</title>
  <para>
   Bevor Sie ein Synchronisierungstool starten, machen Sie sich mit dessen Funktionen und Optionen vertraut. Sichern Sie in jedem Fall wichtige Dateien.
  </para>
 </warning>

 <sect1 xml:id="sec.net.sync.rsync">
  <title>Konzeptüberblick</title>
  <para>
    Sollen große Datenmengen über eine langsame Netzwerkverbindung synchronisiert werden, bietet Rsync eine zuverlässige Methode, mit der ausschließlich die Änderungen in den Dateien übermittelt werden. Dies betrifft nicht nur Textdateien, sondern auch binäre Dateien. Um die Unterschiede zwischen Dateien zu erkennen, teilt rsync die Dateien in Blöcke auf und berechnet Prüfsummen zu diesen Blöcken.
   </para>
   <para>
    Zum Erkennen der Änderungen ist eine gewisse Rechenleistung erforderlich. Die Computer auf beiden Seiten müssen daher ausreichende Ressourcen aufweisen (auch ausreichend RAM).
   </para>
  <para>
   Rsync ist insbesondere dann von Nutzen, wenn große Datenmengen mit kleinen Änderungen in regelmäßigen Abständen übermittelt werden sollen. Dies ist häufig bei Sicherungskopien der Fall. Rsync eignet sich auch zum Spiegeln von Staging-Servern, mit denen komplette Verzeichnisbaumstrukturen von Webservern auf einem Webserver in einer DMZ gespeichert werden.
  </para>
  <para>
   Trotz seines Namens ist Rsync kein Synchronisierungswerkzeug. Rsync ist ein Werkzeug, das Daten jeweils nur in eine einzige Richtung kopiert, nicht in beide Richtungen. Etwas anderes ist damit nicht möglich. Wenn Sie ein bidirektionales Werkzeug benötigen, mit dem Quelle und Ziel synchronisiert werden, verwenden Sie Csync.
  </para>
  
 </sect1>

  <sect1 xml:id="sec.net.sync.rsync.syntax">
   <title>Einfache Syntax</title>
   <para>
    Für das Befehlszeilenwerkzeug Rsync gilt die folgende grundlegende Syntax:
   </para>
   <screen>rsync [OPTION] SOURCE [SOURCE]... DEST</screen>
   <para>
    Sie können Rsync auf jedem lokalen Computer oder Remote-Computer verwenden, sofern Sie die erforderlichen Zugriffs- und Schreibrechte besitzen. Es können mehrere <replaceable>SOURCE</replaceable>-Einträge vorliegen. Die Platzhalter <replaceable>SOURCE</replaceable> und <replaceable>DEST</replaceable> können durch Pfade und/oder durch URLs ersetzt werden.
   </para>
   <para>
    Die folgenden Rsync-Optionen werden am häufigsten verwendet:
   </para>
   <variablelist>
    <varlistentry>
     <term><option>-v</option></term>
     <listitem>
      <para> Gibt einen ausführlicheren Text zurück</para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>-a</option></term>
     <listitem>
      <para> Archivmodus; kopiert Dateien rekursiv und behält die Zeitstempel, das Benutzer-/Gruppeneigentum, die Dateiberechtigungen und die symbolischen Links bei. </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>-z</option></term>
     <listitem>
      <para>Komprimiert die übermittelten Daten.</para>
     </listitem>
    </varlistentry>
   </variablelist>
   <note>
    <title>Anzahl der nachgestellten Schrägstriche</title>
    <para>
     Beim Arbeiten mit Rsync sind die nachgestellten Schrägstriche besonders zu beachten. Ein nachgestellter Schrägstrich nach dem Verzeichnis bezeichnet den <emphasis>Inhalt</emphasis> des Verzeichnisses. Die Angabe ohne nachgestellten Schrägstrich bezeichnet das <emphasis>Verzeichnis selbst</emphasis>.
   </para>
   </note>
  </sect1>

  <sect1 xml:id="sec.net.sync.rsync.copy.local.files-and-dirs">
   <title>Lokales Kopieren von Dateien und Verzeichnissen</title>
   <para>
    In der nachfolgenden Beschreibung wird vorausgesetzt, dass der aktuelle Benutzer Schreibrechte für das Verzeichnis <filename>/var/backup</filename> besitzt. Mit dem folgenden Befehl kopieren Sie eine einzelne Datei aus einem Verzeichnis auf dem Computer in einen anderen Pfad: </para>
   <screen><prompt>tux &gt; </prompt><command>rsync</command> -avz backup.tar.xz /var/backup/</screen>
   <para>Die Datei <filename>backup.tar.xz</filename> wird in das Verzeichnis <filename>/var/backup/</filename> kopiert; der absolute Pfad lautet <filename>/var/backup/backup.tar.xz</filename>.</para>
   <para>
    Denken Sie daran, den <emphasis>nachgestellten Schrägstrich</emphasis> nach dem Verzeichnis <filename>/var/backup/</filename> anzugeben! Wenn Sie den Schrägstrich nicht einfügen, wird die Datei <filename>backup.tar.xz</filename> in <filename>/var/backup</filename> kopiert (also in eine Datei), <emphasis>nicht</emphasis> in das Verzeichnis <filename>/var/backup/</filename>!
   </para>
   <para>
    Verzeichnisse werden auf ähnliche Weise kopiert wie einzelne Dateien. Im folgenden Beispiel wird das Verzeichnis <filename>tux/</filename> mit dessen Inhalt in das Verzeichnis <filename>/var/backup/</filename> kopiert: </para>
    <screen><prompt>tux &gt; </prompt><command>rsync</command> -avz tux /var/backup/</screen>
    <para> Die Kopie befindet sich im absoluten Pfad <filename>/var/backup/tux/</filename>. </para>
  </sect1>

  <sect1 xml:id="sec.net.sync.rsync.copy.remote.files-and-dirs">
   <title>Remote-Kopieren von Dateien und Verzeichnissen</title>
   <para>
    Das Rsync-Werkzeug muss auf beiden Computern vorhanden sein. Zum Kopieren von Dateien aus Remote-Verzeichnissen oder in diese benötigen Sie eine IP-Adresse oder einen Domänennamen. Ein Benutzername ist optional, wenn die aktuellen Benutzernamen auf dem lokalen Computer und dem Remote-Computer identisch sind.
   </para>
   <para> Mit dem folgenden Befehl kopieren Sie die Datei <filename>file.tar.xz</filename> vom lokalen Host auf den Remote-Host <systemitem class="ipaddress">192.168.1.1</systemitem> mit identischen Benutzern (lokal und remote):
   </para>
   <screen><prompt>tux &gt; </prompt><command>rsync</command> -avz file.tar.xz  tux@192.168.1.1:</screen>
    <para> Alternativ sind auch die folgenden Befehle möglich und äquivalent: </para>
   <screen><prompt>tux &gt; </prompt><command>rsync</command> -avz file.tar.xz 192.168.1.1:~
<prompt>tux &gt; </prompt><command>rsync</command> -avz file.tar.xz 192.168.1.1:/home/tux</screen>
    <para> In allen Fällen mit Standardkonfiguration werden Sie aufgefordert, den Passwortsatz des Remote-Benutzers einzugeben. Mit diesem Befehl wird <filename>file.tar.xz</filename> in das Benutzerverzeichnis des Benutzers <systemitem class="username">tux</systemitem> kopiert (in der Regel <filename>/home/tux</filename>).
    </para>
   <para>
    Verzeichnisse werden im Remote-Verfahren auf ähnliche Weise kopiert wie lokal. Im folgenden Beispiel wird das Verzeichnis <filename>tux/</filename> mit dessen Inhalt in das Remote-Verzeichnis <filename>/var/backup/</filename> auf dem Host <systemitem class="ipaddress">192.168.1.1</systemitem> kopiert:
   </para>
   <screen><prompt>tux &gt; </prompt><command>rsync</command> -avz tux 192.168.1.1:/var/backup/</screen>
   <para>
    Unter der Voraussetzung, dass Sie Schreibrechte auf dem Host <systemitem class="ipaddress">192.168.1.1</systemitem> besitzen, befindet sich die Kopie im absoluten Pfad <filename>/var/backup/tux</filename>.
   </para>
  </sect1>

  <sect1 xml:id="sec.net.sync.rsync.server">
   <title>Konfigurieren und Verwenden eines Rsync-Servers</title>
   <para>
    Rsync kann als Daemon (<systemitem class="daemon">rsyncd</systemitem>) ausgeführt werden, der den Standardport 873 auf eingehende Verbindungen überwacht. Dieser Daemon kann <quote>Kopierziele</quote> empfangen.
   </para>
   <para>
    Mit den nachfolgenden Anweisungen erstellen Sie einen Rsync-Server auf <systemitem>jupiter</systemitem> mit einem <emphasis>backup</emphasis>-Ziel. In diesem Ziel können Sie Ihre Sicherungskopien speichern. So erstellen Sie einen Rsync-Server:
   </para>
   <procedure>
    <title>Einrichten eines Rsync-Servers</title>
    <step xml:id="st.rsync.server.mkdir">
     <para>
      Erstellen Sie auf jupiter ein Verzeichnis, in dem alle Sicherungskopien gespeichert werden sollen. In diesem Beispiel wird das Verzeichnis <filename>/var/backup</filename> verwendet:
     </para>
     <screen><prompt role="root">root # </prompt><command>mkdir</command> /var/backup</screen>
    </step>
    <step>
     <para>Legen Sie das Eigentum fest. In diesem Fall ist der Benutzer <systemitem class="username">tux</systemitem> in der Gruppe <systemitem class="groupname">users</systemitem> der  Eigentümer des Verzeichnisses:</para>
     <screen><prompt role="root">root # </prompt><command>chown</command> tux.users /var/backup</screen>
    </step>
    <step>
     <para>Konfigurieren Sie den rsyncd-Daemon.</para>
     <para>Die Konfigurationsdatei wird in eine Hauptdatei und einige <quote>Module</quote> aufgeteilt, in denen sich das Sicherungsziel befindet. So können zusätzliche Module später einfacher eingefügt werden. Die globalen Werte können in den Dateien <filename>/etc/rsyncd.d/*.inc</filename> gespeichert werden, die Module dagegen in den Dateien <filename>/etc/rsyncd.d/*.conf</filename>: </para>
     <substeps>
      <step>
       <para>Erstellen Sie das Verzeichnis <filename>/etc/rsyncd.d/</filename>:</para>
       <screen><prompt role="root">root # </prompt><command>mkdir</command> /etc/rsyncd.d/</screen>
      </step>
      <step>
       <para>
        Tragen Sie die folgenden Zeilen in die Hauptkonfigurationsdatei <filename>/etc/rsyncd.conf</filename> ein:
       </para>
       <screen># rsyncd.conf main configuration file
log file = /var/log/rsync.log
pid file = /var/lock/rsync.lock

&amp;merge /etc/rsyncd.d <co xml:id="co.rsync.conf.merge"/>
&amp;include /etc/rsyncd.d <co xml:id="co.rsync.conf.include"/></screen>
       <calloutlist>
        <callout arearefs="co.rsync.conf.merge">
         <para> Führen Sie die globalen Werte aus den Dateien <filename>/etc/rsyncd.d/*.inc</filename> in der Hauptkonfigurationsdatei zusammen. </para>
        </callout>
        <callout arearefs="co.rsync.conf.include">
         <para> Lädt die Module (oder Ziele) aus den Dateien<filename>/etc/rsyncd.d/*.conf</filename>. Diese Dateien dürfen keine Verweise auf die globalen Werte enthalten. </para>
        </callout>
       </calloutlist>
      </step>
      <step>
       <para> Legen Sie das Modul (das Sicherungsziel) mit den folgenden Zeilen in der Datei<filename>/etc/rsyncd.d/backup.conf</filename> an: </para>
       <screen># backup.conf: backup module
[backup] <co xml:id="co.rsync.conf.target"/>
   uid = tux <co xml:id="co.rsync.conf.uid-gid"/>
   gid = users <xref linkend="co.rsync.conf.uid-gid"/>
   path = /var/backup <co xml:id="co.rsync.conf.path"/>
   auth users = tux  <co xml:id="co.rsync.conf.authusers"/>
   secrets file = /etc/rsyncd.secrets <co xml:id="co.rsync.conf.secretfiles"/>
   comment = Our backup target</screen>
       <calloutlist>
        
        
        <callout arearefs="co.rsync.conf.target">
         <para>
          Das <emphasis>backup</emphasis>-Ziel. Geben Sie einen beliebigen Namen ein. Benennen Sie das Ziel nach Möglichkeit entsprechend seinem Zweck und verwenden Sie denselben Namen in der <filename>*.conf</filename>-Datei.
         </para>
        </callout>
        <callout arearefs="co.rsync.conf.uid-gid">
         <para>
          Gibt den Benutzer- oder Gruppennamen an, der für die Dateiübertragung herangezogen werden soll.
         </para>
        </callout>
        <callout arearefs="co.rsync.conf.path">
         <para>
          Definiert den Pfad, in dem die Sicherungskopien gespeichert werden sollen (aus <xref linkend="st.rsync.server.mkdir"/>).
         </para>
        </callout>
        <callout arearefs="co.rsync.conf.authusers">
         <para>
          Gibt eine durch Komma getrennte Liste der zulässigen Benutzer an. In der einfachsten Form enthält diese Liste die Namen der Benutzer, die berechtigt sind, eine Verbindung zu diesem Modul herzustellen. In diesem Fall ist lediglich der Benutzer <systemitem class="username">tux</systemitem> zulässig.
         </para>
        </callout>
        <callout arearefs="co.rsync.conf.secretfiles">
         <para>
          Gibt den Pfad einer Datei an, die Zeilen mit Benutzernamen und einfachen Passwörtern enthält.
         </para>
        </callout>
       </calloutlist>
      </step>
      <step>
       <para>
        Erstellen Sie die Datei <filename>/etc/rsyncd.secrets</filename> mit dem folgenden Inhalt und ersetzen Sie <replaceable>PASSPHRASE</replaceable>:
       </para>
       <screen># user:passwd
tux:<replaceable>PASSPHRASE</replaceable></screen>
      </step>
      <step>
       <para>
        Die Datei darf nur von <systemitem class="username">root</systemitem> gelesen werden können:
       </para>
       <screen><prompt role="root">root # </prompt><command>chmod</command> 0600 /etc/rsyncd.secrets</screen>
      </step>
     </substeps>

     
    </step>
    <step>
     <para>
      Starten und aktivieren Sie den rsyncd-Daemon:
     </para>
     <screen><prompt role="root">root # </prompt><command>systemctl</command> enable rsyncd
<prompt role="root">root # </prompt><command>systemctl</command> start rsyncd</screen>
     
    </step>
    <step>
     <para>
      Testen Sie den Zugriff auf den Rsync-Server:
     </para>
     <screen><prompt>tux &gt; </prompt><command>rsync</command> jupiter::</screen>
     <para>
      Beispiel für eine Antwort:
     </para>
     <screen>backup          Our backup target</screen>
     <para>Ansonsten prüfen Sie die Konfigurationsdatei-, Firewall- und Netzwerkeinstellungen.</para>
    </step>
   </procedure>
   <para>
    Mit den obigen Schritten wird ein Rsync-Server erstellt, auf dem Sie nun Sicherungskopien speichern können. Im obigen Beispiel wird auch eine Protokolldatei über alle Verbindungen angelegt. Diese Datei wird unter <filename>/var/log/rsyncd.log</filename> abgelegt. Diese Funktion ist besonders beim Debuggen der Datenübertragungen hilfreich.
   </para>
   <para>
    Mit dem folgenden Befehl listen Sie den Inhalt des Sicherungsziels auf:
   </para>
<screen>rsync -avz jupiter::backup</screen>
   <para>
    Dieser Befehl listet alle Dateien auf, die auf dem Server im Verzeichnis <filename>/var/backup</filename> liegen. Diese Anfrage wird auch in der Protokolldatei unter <filename>/var/log/rsyncd.log</filename> aufgezeichnet. Um die Übertragung tatsächlich zu starten, geben Sie ein Quellverzeichnis an. Verwenden Sie <literal>.</literal> für das aktuelle Verzeichnis. Mit dem folgenden Befehl wird beispielsweise das aktuelle Verzeichnis auf den Rsync-Sicherungsserver kopiert:
   </para>
   <screen>rsync -avz . jupiter::backup</screen>
   <para>
    Standardmäßig werden beim Ausführen von Rsync keine Dateien und Verzeichnisse gelöscht. Soll die Löschung aktiviert werden, müssen Sie die zusätzliche Option <option>--delete</option> angeben. Um sicherzustellen, dass keine neueren Dateien überschrieben werden, kann stattdessen die Option <option>--update</option> angegeben werden. Dadurch entstehende Konflikte müssen manuell aufgelöst werden.
   </para>
  </sect1>

 <sect1 xml:id="sec.net.sync.summary">
  <title>Weiterführende Informationen</title>
  <variablelist>
   <varlistentry>
    <term>CSync</term>
    <listitem>
     <para>Bidirektionales Dateisynchronisierungswerkzeug, siehe <link xlink:href="https://www.csync.org/"/>.</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>RSnapshot</term>
    <listitem>
     <para>Erstellt inkrementelle Sicherungskopien, siehe <link xlink:href="http://rsnapshot.org"/>.</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Unison</term>
    <listitem>
     <para>Bidirektionales Dateisynchronisierungswerkzeug – ähnlich wie CSync, jedoch mit grafischer Benutzeroberfläche, siehe <link xlink:href="http://www.seas.upenn.edu/~bcpierce/unison/"/>.</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Rear</term>
    <listitem>
     <para>Disaster Recovery-Framework, siehe <citetitle>Administrationshandbuch</citetitle> für die SUSE Linux Enterprise-Hochverfügbarkeitserweiterung <link xlink:href="https://www.suse.com/documentation/sle-ha-12/"/>.</para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
</chapter>
