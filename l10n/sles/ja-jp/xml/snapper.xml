<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="snapper.xml" version="5.0" xml:id="cha-snapper">
 <title>Snapperを使用したシステムの回復とスナップショット管理</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    Snapperにより、ファイルシステムスナップショットを作成および管理できます。ファイルシステムスナップショットは特定の時点でのファイルシステムの状態のコピーを保持できます。Snapperの標準セットアップは、システムの変更のロールバックを許可するように設計されています。ただし、これを使用して、ユーザデータのオンディスクバックアップを作成することもできます。この機能のベースとして、SnapperはBtrfsファイルシステム、またはXFSあるいはExt4ファイルシステムでシンプロビジョニングされたLVMボリュームを使用します。
   </para>
  </abstract>
 </info>

 <para>
  SnapperにはコマンドラインインタフェースとYaSTインタフェースがあります。Snapperでは、次のタイプのファイルシステムでファイルシステムスナップショットを作成および管理できます。
 </para>
 <itemizedlist>
  <listitem>
   <para>
    Btrfs。サブボリュームのファイルシステムスナップショットをネイティブにサポートするLinux用のコピーオンライトファイルシステム。(サブボリュームは物理パーティション内で別個にマウント可能なファイルシステムです。)
   </para>
   <para>
    <literal>Btrfs</literal>スナップショットから起動することもできます。詳細については、<xref linkend="sec-snapper-snapshot-boot"/>を参照してください。
   </para>
  </listitem>
  <listitem>
   <para>
    XFSまたはExt4でフォーマットされたシンプロビジョニングLVMボリューム。
   </para>
  </listitem>
 </itemizedlist>
 <para>
  Snapperを使用して、次のタスクを実行できます。
 </para>
 <itemizedlist mark="bullet" spacing="normal">
  <listitem>
   <para>
    <command>zypper</command>やYaSTで行ったシステムの変更を元に戻す。詳細については<xref linkend="sec-snapper-undo"/>を参照してください。
   </para>
  </listitem>
  <listitem>
   <para>
    古いスナップショットからファイルを復元する。詳細については<xref linkend="sec-snapper-undo-delete-file"/>を参照してください。
   </para>
  </listitem>
  <listitem>
   <para>
    スナップショットからブートすることによってシステムをロールバックする。詳細については<xref linkend="sec-snapper-snapshot-boot"/>を参照してください。
   </para>
  </listitem>
  <listitem>
   <para>
    実行中のシステム内で、スナップショットを手動で作成および管理する。詳細については<xref linkend="sec-snapper-manage"/>を参照してください。
   </para>
  </listitem>
 </itemizedlist>

 <sect1 xml:id="sec-snapper-setup">
  <title>デフォルト設定</title>

  <para>
   <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>上のSnapperは、システム変更の「取り消しおよび回復ツール」として設定されています。デフォルトでは、<filename>SUSE Linux Enterprise Server</filename>のルートパーティション(<phrase role="productname"><phrase os="sles">/</phrase></phrase>)は<literal>Btrfs</literal>でフォーマットされています。ルートパーティション(<filename>/</filename>)に十分な容量(約16GB以上)がある場合、スナップショットの作成が自動的に有効になります。デフォルトでは、スナップショットは<filename>/</filename>以外のパーティションでは無効になっています。
  </para>

  <tip>
   <title>インストール済みシステムでのSnapperの有効化</title>
   <para>
    インストール中にSnapperを無効にした場合、後からいつでも有効にできます。そのためには、次のコマンドを実行して、ルートファイルシステムのデフォルトのSnapper設定を作成します。
   </para>
   <screen><prompt>&gt; </prompt><command>sudo</command> snapper -c root create-config /</screen>
   <para>
    その後、<xref linkend="sec-snapper-setup-customize-auto-snapshots"/>の説明に従って、別のスナップショットタイプを有効にします。
   </para>
   <para>
    Btrfsルートファイルシステムでは、スナップショットには、インストーラが提案するように設定されたサブボリュームと、少なくとも16GBのパーティションサイズを持つファイルシステムが必要です。
   </para>
  </tip>

  <para>
   スナップショットを作成すると、スナップショットとスナップショット元のファイルは、 いずれもファイルシステム内の同じブロックを指します。そのため、最初は、スナップショットが余分にディスク容量を占めることはありません。元のファイルシステムのデータが変更されると、変更されたデータブロックがコピーされ、古いデータブロックはスナップショットのように保持されます。このため、スナップショットは、変更されたデータと同じ容量を占めます。こうして、時間が経過するにつれて、スナップショットの領域は大きくなっていきます。その結果、スナップショットを含む<literal>Btrfs</literal>ファイルシステムからファイルを削除しても、ディスクの空き容量が<emphasis>増えない</emphasis>ことがあります。
  </para>

  <note>
   <title>スナップショットの場所</title>
   <para>
    スナップショットは常に、スナップショット作成元と同じパーティションまたはサブボリュームに保存されます。別のパーティションまたはサブボリュームにスナップショットを保存することはできません。
   </para>
  </note>

  <para>
   結果として、スナップショットを含むパーティションは、スナップショットを含まないパーティションよりも大きくする必要があります。具体的な容量は、保持するスナップショット数やデータの変更頻度によって大きく異なります。経験則として、パーティションには通常の2倍の容量を割り当てます。ディスク容量が不足しないようにするために、古いスナップショットは自動的にクリーンアップされます。詳細については、<xref linkend="sec-snapper-setup-customize-archiving"/>を参照してください。
  </para>

  <sect2 xml:id="snapper-default-settings">
   <title>デフォルト設定</title>
   <variablelist>
    <varlistentry>
     <term>16 GBより大きいディスク</term>
     <listitem>
      <itemizedlist>
       <listitem><para>設定ファイル: <filename>/etc/snapper/configs/root</filename></para></listitem>
       <listitem><para><literal>USE_SNAPPER=yes</literal></para></listitem>
       <listitem><para><literal>TIMELINE_CREATE=no</literal></para></listitem>
      </itemizedlist>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>16 GB未満のディスク</term>
     <listitem>
      <itemizedlist>
       <listitem><para>設定ファイル: 作成されない</para></listitem>
       <listitem><para><literal>USE_SNAPPER=no</literal></para></listitem>
       <listitem><para><literal>TIMELINE_CREATE=yes</literal></para></listitem>
      </itemizedlist>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="snapper-snapshot-type">
   <title>スナップショットのタイプ</title>
   <para>
    スナップショット自体は技術的な意味では同じですが、トリガするイベントに基づいて、次の3種類のスナップショットを区別しています。
   </para>
   <variablelist>
    <varlistentry>
     <term>タイムラインスナップショット</term>
     <listitem>
      <para>
       1時間ごとに1つのスナップショットが作成されます。古いスナップショットは自動的に削除されます。デフォルトで、最近10日間、10カ月間、10年間の最初のスナップショットが保持されます。YaST OSのインストール方法(デフォルト)を使用すると、ルートファイルシステムを除いてタイムラインスナップショットが有効になります。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>インストールスナップショット</term>
     <listitem>
      <para>
       YaSTまたはZypperで1つ以上のパッケージをインストールする場合、常にスナップショットのペアが作成されます。インストール開始前のスナップショット(<quote>事前</quote>)と、インストール完了後のスナップショット(<quote>事後</quote>)です。カーネルなどの重要なコンポーネントがインストールされた場合、スナップショットのペアは重要とマークされます(<literal>important=yes</literal>)。古いスナップショットは自動的に削除されます。デフォルトでは、最新の10個の重要なスナップショット、および最新の10個の<quote>通常</quote>のスナップショット(管理スナップショットを含む)が保持されます。インストールスナップショットはデフォルトで有効になっています。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>管理スナップショット</term>
     <listitem>
      <para>
       システムをYaSTで管理する場合、常にスナップショットのペアが作成されます。YaSTモジュール開始時のスナップショット(<quote>事前</quote>)と、モジュール終了時のスナップショット(<quote>事後</quote>)です。古いスナップショットは自動的に削除されます。デフォルトでは、最新の10個の重要なスナップショットと最新の10個の<quote>通常</quote>のスナップショット(インストールスナップショットを含む)が保持されます。管理スナップショットはデフォルトで有効になっています。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="snapper-dir-excludes">
   <title>スナップショットから除外されるディレクトリ</title>
   <para>
    一部のディレクトリは、さまざまな理由により、スナップショットから除外する必要があります。次のリストは、除外されるすべてのディレクトリを示しています。
   </para>
   <xi:include href="snapshot_excludes_i.xml"/>
  </sect2>

  <sect2 xml:id="sec-snapper-setup-customize">
   <title>設定のカスタマイズ</title>
   <para>
    <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>には、適切なデフォルト設定が付属していて、ほとんどの使用事例ではこのままで十分です。ただし、スナップショットの自動作成およびスナップショットの維持管理のあらゆる側面をニーズに合わせて設定できます。
   </para>
   <sect3 xml:id="sec-snapper-setup-customize-auto-snapshots">
    <title>スナップショットの有効化/無効化</title>
    <para>
     3つのスナップショットの種類(タイムライン、インストール、および管理)はそれぞれ独立して有効化または無効化することができます。
    </para>
    <variablelist>
     <varlistentry>
      <term>タイムラインスナップショットの有効化/無効化</term>
      <listitem>
       <formalpara>
        <title>有効化</title>
        <para>
         <command>snapper -c root set-config &quot;TIMELINE_CREATE=yes&quot;</command>
        </para>
       </formalpara>
       <formalpara>
        <title>無効化</title>
        <para>
         <command>snapper -c root set-config &quot;TIMELINE_CREATE=no&quot;</command>
        </para>
       </formalpara>
       <para>
        YaST OSのインストール方法(デフォルト)を使用すると、ルートファイルシステムを除いてタイムラインスナップショットが有効になります。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>インストールスナップショットの有効化/無効化</term>
      <listitem>
       <formalpara>
        <title>有効化:</title>
        <para>
         パッケージ <systemitem class="resource">snapper-zypp-plugin</systemitem>
        </para>
       </formalpara>
       <formalpara>
        <title>無効化</title>
        <para>
         <systemitem class="resource">snapper-zypp-plugin</systemitem>パッケージをアンインストールします。
        </para>
       </formalpara>
       <para>
        インストールスナップショットはデフォルトで有効になっています。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>管理スナップショットの有効化/無効化</term>
      <listitem>
       <formalpara>
        <title>有効化:</title>
        <para>
         <filename>/etc/sysconfig/yast2</filename>で<envar>USE_SNAPPER</envar>を<literal>yes (はい)</literal>に設定します。
        </para>
       </formalpara>
       <formalpara>
        <title>無効化</title>
        <para>
         <filename>/etc/sysconfig/yast2</filename>で<envar>USE_SNAPPER</envar>を<literal>no (いいえ)</literal>に設定します。
        </para>
       </formalpara>
       <para>
        管理スナップショットはデフォルトで有効になっています。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="sec-snapper-setup-customize-inst-snapshots">
    <title>インストールスナップショットの制御</title>
    <para>
     YaSTまたはZypperでパッケージをインストールする際にスナップショットペアを作成する処理は、<systemitem class="resource">snapper-zypp-plugin</systemitem>が扱います。XML環境設定ファイル<filename>/etc/snapper/zypp-plugin.conf</filename>で、スナップショットを作成するタイミングを定義します。デフォルトでは、ファイルは次のようになっています。
    </para>
<screen> 1 &lt;?xml version="1.0" encoding="utf-8"?&gt;
 2 &lt;snapper-zypp-plugin-conf&gt;
 3  &lt;solvables&gt;
 4   &lt;solvable match="w"<co xml:id="zypp-conf-match"/> important="true"<co xml:id="zypp-conf-important"/>&gt;kernel-*<co xml:id="zypp-conf-kernel"/>&lt;/solvable&gt;
 5   &lt;solvable match="w" important="true"&gt;dracut&lt;/solvable&gt;
 6   &lt;solvable match="w" important="true"&gt;glibc&lt;/solvable&gt;
 7   &lt;solvable match="w" important="true"&gt;systemd*&lt;/solvable&gt;
 8   &lt;solvable match="w" important="true"&gt;udev&lt;/solvable&gt;
 9   &lt;solvable match="w"&gt;*&lt;/solvable&gt;<co xml:id="zypp-conf-packages"/>
10  &lt;/solvables&gt;
11 &lt;/snapper-zypp-plugin-conf&gt;</screen>
    <calloutlist>
     <callout arearefs="zypp-conf-match">
      <para>
       match属性は、パターンがUnixシェルと同様のワイルドカードであるか(<literal>w</literal>)、それともPython正規表現であるか(<literal>re</literal>)を定義します。
      </para>
     </callout>
     <callout arearefs="zypp-conf-important">
      <para>
       指定されたパターンが一致し、対応するパッケージに重要のマークが付いている場合(カーネルパッケージなど)、そのスナップショットにも重要のマークが付きます。
      </para>
     </callout>
     <callout arearefs="zypp-conf-kernel">
      <para>
       パッケージ名に一致するパターン。特殊文字は、<literal>match</literal>属性の設定に基づいて、シェル風のワイルドカードまたは正規表現のいずれかとして解釈されます。このパターンは、<literal>kernel-</literal>で始まるすべてのパッケージ名に一致します。
      </para>
     </callout>
     <callout arearefs="zypp-conf-packages">
      <para>
       この行は、無条件にすべてのパッケージに一致します。
      </para>
     </callout>
    </calloutlist>
    <para>
     この設定スナップショットでは、パッケージのインストール時に常にペアが作成されます(9行目)。重要のマークが付いたkernel、dracut、glibc、systemd、またはudevパッケージがインストールされると、そのスナップショットペアにも重要のマークが付きます(4～8行目)。すべてのルールが評価されます。
    </para>
    <para>
     ルールを無効にするには、削除するか、XMLコメントを使用して無効にします。パッケージがインストールされるたびにスナップショットペアが作成されないようにするには、次のようにします。たとえば、9行目のコメント行のように指定します。
    </para>
<screen> 1 &lt;?xml version="1.0" encoding="utf-8"?&gt;
 2 &lt;snapper-zypp-plugin-conf&gt;
 3  &lt;solvables&gt;
 4   &lt;solvable match="w" important="true"&gt;kernel-*&lt;/solvable&gt;
 5   &lt;solvable match="w" important="true"&gt;dracut&lt;/solvable&gt;
 6   &lt;solvable match="w" important="true"&gt;glibc&lt;/solvable&gt;
 7   &lt;solvable match="w" important="true"&gt;systemd*&lt;/solvable&gt;
 8   &lt;solvable match="w" important="true"&gt;udev&lt;/solvable&gt;
 9   &lt;!-- &lt;solvable match="w"&gt;*&lt;/solvable&gt; --&gt;
10  &lt;/solvables&gt;
11 &lt;/snapper-zypp-plugin-conf&gt;</screen>
   </sect3>
   <sect3 xml:id="sec-snapper-setup-customizing-new-subvolume">
    <title>新規サブボリュームの作成とマウント</title>
    <para>
     <filename>/</filename>階層下に新規のサブボリュームを作成し、永続的にマウントすることができます。このようなサブボリュームはスナップショットから除外されます。既存のスナップショット内に作成してはいけません。ロールバック後にスナップショットを削除できなくなるためです。
    </para>
    <para>
     <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>は、<filename>/@/</filename>サブボリュームが設定されており、このサブボリュームは、<filename>/opt</filename>、<filename>/srv</filename>、<filename>/home</filename>、その他の永続サブボリュームの独立したルートとしての役割を果たします。作成し、永続的にマウントする新規のサブボリュームは、この初期のルートファイルシステムに作成しなければなりません。
    </para>
    <para>
     そのように設定するには、次のコマンドを実行します。この例では、新規サブボリューム、<filename>/usr/important</filename>は<filename>/dev/sda2</filename>から作成されます。
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> mount /dev/sda2 -o subvol=@ /mnt
<prompt>&gt; </prompt><command>sudo</command> btrfs subvolume create /mnt/usr/important
<prompt>&gt; </prompt><command>sudo</command> umount /mnt</screen>
    <para>
     <filename>/etc/fstab</filename>の該当エントリは、次のようになります。
    </para>
    <screen>/dev/sda2 /usr/important btrfs subvol=@/usr/important 0 0</screen>

    <tip>
     <title>コピーオンライト(cow)の無効化</title>
     <para>
      サブボリュームには、仮想化ディスクイメージ、データベースファイル、ログファイルなど、頻繁に変更されるファイルが含まれている場合があります。その場合、ディスクブロックの重複を避けるため、このボリュームのコピーオンライト機能を無効にすることを検討します。そのためには、<filename>/etc/fstab</filename>で<option>nodatacow</option>マウントオプションを使用します。
     </para>
     <screen>/dev/sda2 /usr/important btrfs nodatacow,subvol=@/usr/important 0 0</screen>
     <para>
      1つのファイルまたはディレクトリに対してコピーオンライトを無効にするには、コマンド<command>chattr +C <replaceable>PATH</replaceable></command>を使用します。
     </para>
    </tip>

   </sect3>
   <sect3 xml:id="sec-snapper-setup-customize-archiving">
    <title>スナップショットのアーカイブの制御</title>
    <para>
     スナップショットはディスク容量を占有します。ディスク容量が不足してシステムが停止しないようにするために、古いスナップショットは自動的に削除されます。デフォルトでは、最大10個の重要なインストールスナップショットと管理スナップショット、および最大10個の標準のインストールスナップショットと管理スナップショットが保持されます。これらのスナップショットがルートファイルシステムのサイズの50%超を占有する場合、追加のスナップショットは削除されます。最低でも、4つの重要なスナップショットと2つの標準スナップショットは常に保持されます。
    </para>
    <para>
     これらの値の変更方法については、<xref linkend="sec-snapper-config-modify"/>を参照してください。
    </para>
   </sect3>
   <sect3 xml:id="sec-snapper-lvm">
    <title>シンプロビジョニングされたLVMボリュームでのSnapperの使用</title>
    <para>
     Snapperは、<literal>Btrfs</literal>ファイルシステムのスナップショット作成だけでなく、XFS、Ext4、またはExt3でフォーマットされたシンプロビジョニングLVMボリュームのスナップショット作成にも対応しています(通常のLVMボリュームのスナップショットには「対応していません」<emphasis></emphasis>)。LVMボリュームに関する詳細および設定の手順については、<xref linkend="sec-yast-system-lvm"/>を参照してください。
    </para>
    <para>
     シンプロビジョニングLVMボリュームでSnapperを使用するには、そのようにSnapperの設定を作成する必要があります。LVMで、<option>--fstype=lvm(<replaceable>FILESYSTEM</replaceable>)</option>を使用してファイルシステムを指定する必要があります。<literal>ext3</literal>、<literal>etx4</literal>、または<literal>xfs</literal>は、<replaceable>FILESYSTEM</replaceable>の有効な値です。例:
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> snapper -c lvm create-config --fstype="lvm(xfs)" /thin_lvm</screen>
    <para>
     <xref linkend="sec-snapper-config-modify"/>で説明したように、必要に応じてこの設定を調整できます。
    </para>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-snapper-undo">
  <title>Snapperを使用した変更の取り消し</title>

  <para>
   <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>のSnapperは、<command>zypper</command>やYaSTで行った変更を取り消すことができるツールとしてあらかじめ設定されています。このために、Snapperは、<command>zypper</command>およびYaSTの実行前後にスナップショットのペアを作成します。また、Snapperを使用して、誤って削除または変更したシステムファイルを復元することもできます。このためには、ルートパーティションのタイムラインスナップショットを有効にする必要があります。詳細については、<xref linkend="sec-snapper-setup-customize-auto-snapshots"/>を参照してください。
  </para>

  <para>
   上記の自動スナップショットは、デフォルトでルートパーティションとそのサブボリュームに対して設定されます。カスタム設定を作成すれば、<filename>/home</filename>など、他のパーティションに対してスナップショット機能を使用できます。
  </para>

  <important>
   <title>変更の取り消しとロールバックの比較</title>
   <para>
    スナップショットを操作してデータを復元する場合、Snapperが処理可能なシナリオとして、根本的に異なる次の2つのシナリオがあることを理解することが重要です。
   </para>
   <variablelist>
    <varlistentry>
     <term>変更の取り消し</term>
     <listitem>
      <para>
       次に説明されているように、変更を取り消す際には、2つのスナップショットが比較され、これらの2つのスナップショット間の変更が取り消されます。この方法を使用して、復元する必要があるファイルを明示的に選択できます。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>ロールバック</term>
     <listitem>
      <para>
       <xref linkend="sec-snapper-snapshot-boot"/>で説明されているように、ロールバックを実行すると、システムはスナップショットが作成された状態にリセットされます。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <para>
    変更を取り消す場合は、現在のシステムとスナップショットを比較することもできます。このような比較から<emphasis></emphasis>「すべての」ファイルを復元すると、ロールバックを実行した場合と同じ結果になります。ただし、ロールバックについては、<xref linkend="sec-snapper-snapshot-boot"/>で説明されている方法を使用することをお勧めします。この方法はより高速で、ロールバック実行前にシステムを確認できるためです。
   </para>
  </important>

  <warning>
   <title>データの整合性</title>
   <para>
    スナップショットを作成する際に、データの整合性を確保するメカニズムがありません。スナップショットを作成するのと同時にファイルが書き込まれると(データベースなど)、ファイルが破損したり、ファイルへの書き込みが部分的になったりします。このようなファイルを復元すると、問題が発生することがあります。また、<filename>/etc/mtab</filename>などの一部のシステムファイルは復元しないでください。このため、<emphasis></emphasis>「必ず」、変更されたファイルとその差分をよく確認してください。どうしても元に戻すことが必要なファイルのみ復元してください。
   </para>
  </warning>

  <sect2 xml:id="sec-snapper-undo-yast">
   <title>YaSTおよびZypperによる変更の取り消し</title>
   <para>
    インストール時にルートパーティションを<literal>Btrfs</literal>で設定すると、Snapper(YaSTまたはZypperによる変更のロールバックがあらかじめ設定されている)が自動的にインストールされます。YaSTモジュールまたはZypperトランザクションを開始するたびに、2つのスナップショットが作成されます。モジュール開始前のファイルシステムの状態をキャプチャした<quote>事前スナップショット</quote>と、モジュール完了後の状態をキャプチャした<quote>事後スナップショット</quote>です。
   </para>
   <para>
    YaSTのSnapperモジュールまたは<command>snapper</command>コマンドラインツールを使用して、<quote>事前スナップショット</quote>からファイルを復元し、YaST/Zypperによる変更を元に戻すことができます。また、2つのスナップショットを比較して、どのファイルが変更されているか調べることができます。2つのバージョンのファイルの違いを表示することもできます(diff)。
   </para>
   <procedure xml:id="proc-snapper-undo-yast">
    <title>YaSTの<guimenu>Snapper</guimenu>モジュールによる変更の取り消し</title>
    <step>
     <para>
      YaSTの<guimenu>その他</guimenu>セクションにある<guimenu>Snapper</guimenu>モジュールを起動するか、「<command>yast2 snapper</command>」と入力します。
     </para>
    </step>
    <step>
     <para>
      <guimenu>現在の設定</guimenu>が<guimenu>root</guimenu>になっていることを確認します。独自のSnapper設定を手動で追加していない限り、常にそのようになっています。
     </para>
    </step>
    <step>
     <para>
      リストから事前スナップショットと事後スナップショットのペアを選択します。YaSTのスナップショットペアもZypperのスナップショットペアも、種類は<guimenu>事前および事後</guimenu>です。YaSTのスナップショットの場合は<guimenu>説明</guimenu>に「<literal>zypp(y2base)</literal>」と表示され、Zypperのスナップショットの場合は「<literal>zypp(zypper)</literal>」と表示されます。
     </para>
     <informalfigure>
      <mediaobject>
       <imageobject role="fo">
        <imagedata fileref="snapper_yast2_list.png" width="75%"/>
       </imageobject>
       <imageobject role="html">
        <imagedata fileref="snapper_yast2_list.png" width="75%"/>
       </imageobject>
      </mediaobject>
     </informalfigure>
    </step>
    <step>
     <para>
      <guimenu>変更点の表示</guimenu>をクリックすると、2つのスナップショット間の内容に差異のあるファイルのリストが表示されます。
     </para>
     <informalfigure>
      <mediaobject>
       <imageobject role="fo">
        <imagedata fileref="snapper_yast2_changes.png" width="75%"/>
       </imageobject>
       <imageobject role="html">
        <imagedata fileref="snapper_yast2_changes.png" width="75%"/>
       </imageobject>
      </mediaobject>
     </informalfigure>
    </step>
    <step>
     <para>
      ファイルのリストを確認します。事前および事後のファイル間の<quote>差異</quote>を表示するには、リストからファイルを選択します。
     </para>
     <informalfigure>
      <mediaobject>
       <imageobject role="fo">
        <imagedata fileref="snapper_yast2_diff.png" width="65%"/>
       </imageobject>
       <imageobject role="html">
        <imagedata fileref="snapper_yast2_diff.png" width="75%"/>
       </imageobject>
      </mediaobject>
     </informalfigure>
    </step>
    <step>
     <para>
      1つまたは複数のファイルを復元するには、該当するチェックボックスをオンにして、関連するファイルまたはディレクトリを選択します。<guimenu>選択したものを復元</guimenu>をクリックし、<guimenu>はい</guimenu>をクリックして操作を確認します。
     </para>
     <informalfigure>
      <mediaobject>
       <imageobject role="fo">
        <imagedata fileref="snapper_yast2_restore.png" width="75%"/>
       </imageobject>
       <imageobject role="html">
        <imagedata fileref="snapper_yast2_restore.png" width="75%"/>
       </imageobject>
      </mediaobject>
     </informalfigure>
     <para>
      単一のファイルを復元する場合は、ファイル名をクリックして差分を表示します。<guimenu>最初から復元する</guimenu>をクリックし、<guimenu>はい</guimenu>をクリックして選択内容を確認します。
     </para>
    </step>
   </procedure>
   <procedure xml:id="proc-snapper-yast-cmdline">
    <title><command>snapper</command>コマンドによる変更の取り消し</title>
    <step>
     <para>
      <command>snapper list -t pre-post</command>を実行すると、YaSTおよびZypperのスナップショットリストが表示されます。YaSTのスナップショットの場合は<guimenu>説明</guimenu>に「<literal>yast <replaceable>MODULE_NAME</replaceable></literal>」と表示され、Zypperのスナップショットの場合は「<literal>zypp(zypper)</literal>」と表示されます。
     </para>
<screen><?dbsuse-fo font-size="0.60em"?>
<prompt>&gt; </prompt><command>sudo</command> snapper list -t pre-post
Pre # | Post # | Pre Date                      | Post Date                     | Description
------+--------+-------------------------------+-------------------------------+--------------
311   | 312    | Tue 06 May 2018 14:05:46 CEST | Tue 06 May 2018 14:05:52 CEST | zypp(y2base)
340   | 341    | Wed 07 May 2018 16:15:10 CEST | Wed 07 May 2018 16:15:16 CEST | zypp(zypper)
342   | 343    | Wed 07 May 2018 16:20:38 CEST | Wed 07 May 2018 16:20:42 CEST | zypp(y2base)
344   | 345    | Wed 07 May 2018 16:21:23 CEST | Wed 07 May 2018 16:21:24 CEST | zypp(zypper)
346   | 347    | Wed 07 May 2018 16:41:06 CEST | Wed 07 May 2018 16:41:10 CEST | zypp(y2base)
348   | 349    | Wed 07 May 2018 16:44:50 CEST | Wed 07 May 2018 16:44:53 CEST | zypp(y2base)
350   | 351    | Wed 07 May 2018 16:46:27 CEST | Wed 07 May 2018 16:46:38 CEST | zypp(y2base) </screen>
    </step>
    <step>
     <para>
      スナップショットのペア間で変更されたファイルのリストを取得するには、以下を実行します。<command>snapper status </command>
      <replaceable>PRE</replaceable><replaceable>POST</replaceable>.内容が変更されたファイルには<guimenu>c</guimenu>のマーク、追加されたファイルには<guimenu>+</guimenu>のマーク、削除されたファイルには<guimenu>-</guimenu>のマークが付いています。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> snapper status 350..351
+..... /usr/share/doc/packages/mikachan-fonts
+..... /usr/share/doc/packages/mikachan-fonts/COPYING
+..... /usr/share/doc/packages/mikachan-fonts/dl.html
c..... /usr/share/fonts/truetype/fonts.dir
c..... /usr/share/fonts/truetype/fonts.scale
+..... /usr/share/fonts/truetype/みかちゃん-p.ttf
+..... /usr/share/fonts/truetype/みかちゃん-pb.ttf
+..... /usr/share/fonts/truetype/みかちゃん-ps.ttf
+..... /usr/share/fonts/truetype/みかちゃん.ttf
c..... /var/cache/fontconfig/7ef2298fde41cc6eeb7af42e48b7d293-x86_64.cache-4
c..... /var/lib/rpm/Basenames
c..... /var/lib/rpm/Dirnames
c..... /var/lib/rpm/Group
c..... /var/lib/rpm/Installtid
c..... /var/lib/rpm/Name
c..... /var/lib/rpm/Packages
c..... /var/lib/rpm/Providename
c..... /var/lib/rpm/Requirename
c..... /var/lib/rpm/Sha1header
c..... /var/lib/rpm/Sigmd5</screen>
    </step>
    <step>
     <para>
      特定のファイルの差異を表示するには、以下を実行します。<command>snapper diff </command>
      <replaceable>PRE</replaceable>..<replaceable>POST</replaceable>
      <replaceable>ファイル名</replaceable><replaceable>ファイル名</replaceable>を指定しない場合は、すべてのファイルの差異が表示されます。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> snapper diff 350..351 /usr/share/fonts/truetype/fonts.scale
--- /.snapshots/350/snapshot/usr/share/fonts/truetype/fonts.scale       2014-04-23 15:58:57.000000000 +0200
+++ /.snapshots/351/snapshot/usr/share/fonts/truetype/fonts.scale       2014-05-07 16:46:31.000000000 +0200
@@ -1,4 +1,4 @@
-1174
+1486
 ds=y:ai=0.2:luximr.ttf -b&amp;h-luxi mono-bold-i-normal--0-0-0-0-c-0-iso10646-1
 ds=y:ai=0.2:luximr.ttf -b&amp;h-luxi mono-bold-i-normal--0-0-0-0-c-0-iso8859-1
[...]</screen>
    </step>
    <step>
     <para>
      1つまたは複数のファイルを復元するには、以下を実行します。<command>snapper -v undochange </command>
      <replaceable>PRE</replaceable>..<replaceable>POST</replaceable>
      <replaceable>ファイル名</replaceable>。<replaceable>ファイル名</replaceable>を指定しない場合は、変更されたすべてのファイルが復元されます。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> snapper -v undochange 350..351
     create:0 modify:13 delete:7
     undoing change...
     deleting /usr/share/doc/packages/mikachan-fonts
     deleting /usr/share/doc/packages/mikachan-fonts/COPYING
     deleting /usr/share/doc/packages/mikachan-fonts/dl.html
     deleting /usr/share/fonts/truetype/みかちゃん-p.ttf
     deleting /usr/share/fonts/truetype/みかちゃん-pb.ttf
     deleting /usr/share/fonts/truetype/みかちゃん-ps.ttf
     deleting /usr/share/fonts/truetype/みかちゃん.ttf
     modifying /usr/share/fonts/truetype/fonts.dir
     modifying /usr/share/fonts/truetype/fonts.scale
     modifying /var/cache/fontconfig/7ef2298fde41cc6eeb7af42e48b7d293-x86_64.cache-4
     modifying /var/lib/rpm/Basenames
     modifying /var/lib/rpm/Dirnames
     modifying /var/lib/rpm/Group
     modifying /var/lib/rpm/Installtid
     modifying /var/lib/rpm/Name
     modifying /var/lib/rpm/Packages
     modifying /var/lib/rpm/Providename
     modifying /var/lib/rpm/Requirename
     modifying /var/lib/rpm/Sha1header
     modifying /var/lib/rpm/Sigmd5
     undoing change done</screen>
    </step>
   </procedure>
   <warning>
    <title>ユーザ追加の取り消し</title>
    <para>
     ユーザの追加を取り消す場合、Snapperで変更を取り消す方法はお勧めしません。特定のディレクトリはスナップショットから除外されているため、これらのユーザに属するファイルはファイルシステムに残ったままになります。削除済みユーザと同じユーザIDを持つユーザを作成した場合、このユーザはこれらのファイルを継承します。したがって、YaSTの<guimenu>ユーザおよびグループ管理</guimenu>ツールを使用して、ユーザを削除することを強くお勧めします。
    </para>
   </warning>
  </sect2>

  <sect2 xml:id="sec-snapper-undo-delete-file">
   <title>Snapperを使用したファイルの復元</title>
   <para>
    インストールスナップショットおよび管理スナップショットとは別に、Snapperはタイムラインスナップショットを作成します。このバックアップ用スナップショットを使用して、誤って削除したファイルを復元したり、ファイルの以前のバージョンを復元したりできます。Snapperの差分抽出機能を使用して、特定の時点でどのような変更が加えられたのかを調べることもできます。
   </para>
   <para>
    ファイルの復元機能は、特に、デフォルトではスナップショットが作成されないサブボリュームまたはパーティションに存在するデータにとって重要です。ホームディレクトリからファイルを復元できるようにするには、たとえば、<filename>/home</filename>用に、自動的にタイムラインスナップショットを作成する別個のSnapper設定を作成します。手順については、<xref linkend="sec-snapper-config"/>を参照してください。
   </para>
   <warning>
    <title>ファイルの復元とロールバックの比較</title>
    <para>
     ルートファイルシステムから作成されたスナップショット(Snapperのルート設定で定義されています)を使用して、システムロールバックを実行できます。このようなロールバックを実行する場合にお勧めする方法は、そのスナップショットからブートしてからロールバックを実行する方法です。詳細については<xref linkend="sec-snapper-snapshot-boot"/>を参照してください。
    </para>
    <para>
     次に説明するように、ルートファイルシステムスナップショットからすべてのファイルを復元することによってロールバックを実行することもできます。ただし、これはお勧めできません。たとえば、<systemitem>/etc</systemitem>ディレクトリから環境設定ファイルなど単一のファイルを復元できますが、スナップショットからファイルの完全なリストを復元することはできません。
    </para>
    <para>
     この制限は、ルートファイルシステムから作成されたスナップショットにのみ影響します。
    </para>
   </warning>
   <procedure xml:id="proc-snapper-restore-yast">
    <title>YaST <guimenu>Snapper</guimenu>モジュールを使用したファイルの復元</title>
    <step>
     <para>
      YaSTの<guimenu>その他</guimenu>セクションから、または「<command>yast2 snapper</command>」と入力して<guimenu>Snapper</guimenu>モジュールを起します。
     </para>
    </step>
    <step>
     <para>
      スナップショットを選択するための<guimenu>現在の設定</guimenu>を選択します。
     </para>
    </step>
    <step>
     <para>
      ファイルを復元するためのタイムラインスナップショットを選択し<guimenu>変更点の表示</guimenu>を選択します。タイムラインスナップショットは、タイプが<guimenu>単一</guimenu>で、説明の値が<guimenu>timeline (タイムライン)</guimenu>であるスナップショットです。
     </para>
    </step>
    <step>
     <para>
      ファイル名をクリックしてテキストボックスからファイルを選択します。スナップショットバージョンと現在のシステムとの差分が表示されます。復元対象ファイルを選択するチェックボックスをオンにします。復元するすべてのファイルに対してこれを行います。
     </para>
    </step>
    <step>
     <para>
      <guimenu>選択したものを復元</guimenu>をクリックし、<guimenu>はい</guimenu>をクリックして操作を確認します。
     </para>
    </step>
   </procedure>
   <procedure xml:id="proc-snapper-restore-cmdl">
    <title><command>snapper</command>コマンドを使用したファイルの復元</title>
    <step>
     <para>
      次のコマンドを実行して、特定の設定のタイムラインスナップショットのリストを取得します。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> snapper -c <replaceable>CONFIG</replaceable> list -t single | grep timeline</screen>
     <para>
      <replaceable>CONFIG</replaceable>は、既存のSnapper設定に置き換える必要があります。<command>snapper list-configs</command>を使用してリストを表示します。
     </para>
    </step>
    <step>
     <para>
      次のコマンドを実行して、指定のスナップショットの変更ファイルのリストを取得します。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> snapper -c <replaceable>CONFIG</replaceable> status <replaceable>SNAPSHOT_ID</replaceable>..0</screen>
     <para>
      <replaceable>SNAPSHOT_ID</replaceable>をファイルの復元元のスナップショットIDで置き換えます。
     </para>
    </step>
    <step>
     <para>
      オプションで、次のコマンドを実行して、現在のファイルバージョンとスナップショットからのバージョンとの差分を一覧にします。
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> snapper -c <replaceable>CONFIG</replaceable> diff <replaceable>SNAPSHOT_ID</replaceable>..0 <replaceable>FILE NAME</replaceable></screen>
     <para>
      <replaceable>&lt;FILE NAME&gt;</replaceable>を指定しない場合は、すべてのファイルの差分が表示されます。
     </para>
    </step>
    <step>
     <para>
      1つ以上のファイルを復元するには、以下を実行します
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> snapper -c <replaceable>CONFIG</replaceable> -v undochange <replaceable>SNAPSHOT_ID</replaceable>..0 <replaceable>FILENAME1</replaceable> <replaceable>FILENAME2</replaceable></screen>
     <para>
      ファイル名を指定しない場合は、変更されたすべてのファイルが復元されます。
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-snapper-snapshot-boot">
  <title>スナップショットからのブートによるシステムロールバック</title>

  <para>
   <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>に含まれているGRUB 2バージョンは、Btrfsスナップショットからブートできます。Snapperのロールバック機能と併用することで、誤設定されたシステムを回復できます。デフォルトのSnapper設定(<literal>root</literal>)で作成されたスナップショットのみがブート可能です。
  </para>

  <important>
   <title>サポートされる設定</title>
   <para>

    <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> <phrase role="productnumber"><phrase os="sles;sled"> 15 SP4</phrase></phrase>の時点では、システムのロールバックは、ルートパーティションのデフォルトのサブボリューム設定が変更されていない場合にのみサポートされます。
   </para>
  </important>

  <para>
   スナップショットをブートする場合、スナップショットに含まれているファイルシステムの該当部分が読み込み専用でマウントされます。スナップショットから除外されている他のすべてのファイルシステムと該当部分は読み書き可能でマウントされ、変更できます。
  </para>

  <important>
   <title>変更の取り消しとロールバックの比較</title>
   <para>
    スナップショットを操作してデータを復元する場合、Snapperが処理可能なシナリオとして、根本的に異なる次の2つのシナリオがあることを理解することが重要です。
   </para>
   <variablelist>
    <varlistentry>
     <term>変更の取り消し</term>
     <listitem>
      <para>
       <xref linkend="sec-snapper-undo"/>で説明されているように、変更を取り消す場合は、2つのスナップショットが比較され、これらの2つのスナップショット間の変更が元に戻されます。この方法を使用すると、選択したファイルを復元から明示的に除外することもできます。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>ロールバック</term>
     <listitem>
      <para>
       次に説明する方法でロールバックを実行すると、システムはスナップショットが作成された状態にリセットされます。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </important>

  <para>
   ブート可能なスナップショットからロールバックを行うには、次の要件を満たす必要があります。デフォルトインストールを行った場合、システムはそのように設定されます。
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <title>ブート可能なスナップショットからのロールバックの要件</title>
   <listitem>
    <para>
     ルートファイルシステムは、Btrfsである必要があります。LVMボリュームスナップショットからのブートはサポートされていません。
    </para>
   </listitem>
   <listitem>
    <para>
     ルートファイルシステムは、単一のデバイス、単一のパーティション、および単一のサブボリューム上にある必要があります。<filename>/srv</filename>などスナップショットから除外されるディレクトリ(完全なリストについては、<xref linkend="snapper-dir-excludes"/>を参照)は、別のパーティション上に存在していても構いません。
    </para>
   </listitem>
   <listitem>
    <para>
     システムは、インストールされたブートローダを介してブート可能である必要があります。
    </para>
   </listitem>
  </itemizedlist>

  <para>
   ブート可能なスナップショットからのロールバックを実行するには、次の手順に従います。
  </para>

  <procedure>
   <step>
    <para>
     システムをブートします。ブートメニューから、<guimenu>Bootable snapshots(ブート可能なスナップショット)</guimenu>を選択して、ブートするスナップショットを選択します。スナップショットのリストが日別に一覧にされます。最新のスナップショットが先頭に表示されます。
    </para>
   </step>
   <step>
    <para>
     システムにログインします。すべてが予期したとおりに動作しているかどうかを注意深く確認します。スナップショットの一部であるディレクトリに書き込むことはできないので注意してください。他のディレクトリに書き込むデータは、次に行う操作にかかわらず、失われることは「ありません」<emphasis></emphasis>。
    </para>
   </step>
   <step>
    <para>
     ロールバックを実行するかどうかに応じて、次のステップを選択します。
    </para>
    <substeps performance="required">
     <step>
      <para>
       システムが、ロールバックを実行したくない状態になっている場合は、再起動して現在のシステム状態にブートします。その後、別のスナップショットを選択するか、レスキューシステムを開始することができます。
      </para>
     </step>
     <step>
      <para>
       ロールバックを実行するには、次のコマンドを実行し
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> snapper rollback</screen>
      <para>
       その後、再起動します。ブート画面で、デフォルトのブートエントリを選択して、復元されたシステムで再起動します。ロールバック前のファイルシステムの状態のスナップショットが作成されます。rootのデフォルトのサブボリュームは、新しい読み書きスナップショットに置き換えられます。詳細については、<xref linkend="sec-snapper-snapshot-boot-rollback"/>を参照してください。
       </para>
       <para>
        <option>-d</option>オプションを使用してスナップショットの説明を追加すると役に立ちます。例:
       </para>
      <screen>New file system root since rollback on <replaceable>DATE</replaceable> <replaceable>TIME</replaceable></screen>
     </step>
    </substeps>
   </step>
  </procedure>
  <tip>
   <title>特定のインストール状態へのロールバック</title>
   <para>
    スナップショットがインストール時に無効になっていない場合、最初のシステムインストールの最後に初期のブート可能スナップショットが作成されます。このスナップショットをブートすることで、いつでもその状態に戻ることができます。スナップショットは、<literal>インストール後</literal>、説明で識別できます。
   </para>
   <para>
    ブート可能スナップショットは、サービスパックや新しいメジャーリリースへのシステムアップグレードの開始時にも作成されます(スナップショットが無効になっていない場合のみ)。
   </para>
  </tip>
  <sect2 xml:id="sec-snapper-snapshot-boot-rollback">
   <title>ロールバック後のスナップショット</title>
   <para>
    ロールバックの実行前に、動作中のファイルシステムのスナップショットが作成されます。この説明では、ロールバックで復元されたスナップショットのIDを参照します。
   </para>
   <para>
    ロールバックで作成されたスナップショットは、<literal>Cleanup</literal>属性に値<literal>number</literal>が付きます。したがって、設定されているスナップショット数に達すると、ロールバックスナップショットは自動的に削除されます。詳細については、<xref linkend="sec-snapper-clean-up"/>を参照してください。スナップショットに重要なデータが含まれている場合は、スナップショットが削除される前にデータを抽出してください。
   </para>
   <sect3 xml:id="sec-snapper-snapshot-boot-rollback-example">
    <title>ロールバックスナップショットの例</title>
    <para>
     たとえば、新規インストール後に、システムで次のスナップショットが使用可能であるとします。
    </para>
<screen>
<prompt role="root"># </prompt><command>snapper</command> --iso list
Type   | # |     | Cleanup | Description           | Userdata
-------+---+ ... +---------+-----------------------+--------------
single | 0 |     |         | current               |
single | 1 |     |         | first root filesystem |
single | 2 |     | number  | after installation    | important=yes
</screen>
    <para>
     <command>sudo snapper rollback</command>を実行すると、スナップショット<literal>3</literal>が作成され、ロールバック実行前のシステムの状態が格納されます。スナップショット<literal>4</literal>は新しいデフォルトのBtrfsサブボリュームであるため、再起動後にシステムになります。
    </para>
<screen>
<prompt role="root"># </prompt><command>snapper</command> --iso list
Type   | # |     | Cleanup | Description           | Userdata
-------+---+ ... +---------+-----------------------+--------------
single | 0 |     |         | current               |
single | 1 |     | number  | first root filesystem |
single | 2 |     | number  | after installation    | important=yes
single | 3 |     | number  | rollback backup of #1 | important=yes
single | 4 |     |         |                       |
</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-snapper-snapshot-boot-identify">
   <title>スナップショットブートエントリのアクセスと識別</title>
   <para>
    スナップショットからブートするには、マシンを再起動して、<guimenu>Start Bootloader from a read-only snapshot(読み取り専用スナップショットからBootloaderを始動)</guimenu>を選択します。ブート可能なすべてのスナップショットをリストした画面が開きます。最も新しいスナップショットが先頭に表示され、最も古いものは最後に表示されます。<keycap function="down"/>キーおよび<keycap function="up"/>キーを使用して移動し、<keycap function="enter"/>キーを押して、選択したスナップショットを有効にします。ブートメニューからスナップショットを有効にしても、マシンは即座に再起動されません。選択したスナップショットのブートローダが開くだけです。
   </para>
   <figure xml:id="fig-snapper-snapshot-boot-identify">
    <title>ブートローダ: スナップショット</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="boot_snapshots.png" width="75%"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="boot_snapshots.png" width="75%"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    ブートローダの各スナップショットエントリの名前は、命名規則に従っているため、容易に識別できます。
   </para>
<screen>[*]<co xml:id="snapper-boot-important"/><replaceable>OS</replaceable><co xml:id="snapper-boot-os"/> (<replaceable>KERNEL</replaceable><co xml:id="snapper-boot-kernel"/>,<replaceable>DATE</replaceable><co xml:id="snapper-boot-date"/>T<replaceable>TIME</replaceable><co xml:id="snapper-boot-time"/>,<replaceable>DESCRIPTION</replaceable><co xml:id="snapper-boot-description"/>)</screen>
   <calloutlist>
    <callout arearefs="snapper-boot-important">
     <para>
      <literal>重要</literal>なスナップショットとしてとマークが付いている場合、そのエントリには<literal>*</literal>が付きます。
     </para>
    </callout>
    <callout arearefs="snapper-boot-os">
     <para>
      オペレーティングシステムラベル。
     </para>
    </callout>
    <callout arearefs="snapper-boot-date">
     <para>
      日付フォーマット(<literal>YYYY-MM-DD</literal>)。
     </para>
    </callout>
    <callout arearefs="snapper-boot-time">
     <para>
      時刻フォーマット(<literal>HH:MM</literal>)。
     </para>
    </callout>
    <callout arearefs="snapper-boot-description">
     <para>
      このフィールドには、スナップショットの説明が入ります。手動で作成されたスナップショットの場合、この説明は<option>--description</option>オプションで作成された文字列、またはカスタム文字列です(<xref linkend="tip-snapper-snapshot-boot-custom-descr"/>を参照)。自動で作成されたスナップショットの場合、<literal>zypp(zypper)</literal>や<literal>yast_sw_single</literal>など、呼びだされたツールです。長い説明は、ブート画面のサイズに応じて、切り捨てて表示されます。
     </para>
    </callout>
   </calloutlist>
   <tip xml:id="tip-snapper-snapshot-boot-custom-descr">
    <title>ブートローダスナップショットエントリのカスタム説明の設定</title>
    <para>
     スナップショットの説明フィールドのデフォルトの文字列をカスタム文字列に置き換えることができます。この機能は、自動的に作成された説明が不十分な場合や、ユーザが入力した説明が長すぎる場合などに役立ちます。カスタム文字列、<replaceable>STRING</replaceable>をスナップショット、<replaceable>NUMBER</replaceable>に設定するには、次のコマンドを使用します。
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> snapper modify --userdata "bootloader=<replaceable>STRING</replaceable>" <replaceable>NUMBER</replaceable></screen>
    <para>
     説明は25文字未満にしてください。このサイズを超える部分はブート画面では一切読めません。
    </para>
   </tip>
  </sect2>

  <sect2 xml:id="sec-snapper-snapshot-boot-limits">
   <title>制限</title>
   <para>
    システム全体をスナップショット作成時と同一の状態に復元する、システムの「完全な」<emphasis></emphasis>ロールバックは不可能です。
   </para>
   <sect3 xml:id="sec-snapper-limits-snapshot-boot-excludes">
    <title>スナップショットから除外されるディレクトリ</title>
    <para>
     ルートファイルシステムのスナップショットには、すべてのディレクトリが含まれるわけではありません。詳細および理由については、<xref linkend="snapper-dir-excludes"/>を参照してください。そのため、一般的にこれらのディレクトリのデータは復元されないため、次の制限が生じます。
    </para>
    <variablelist>
     <varlistentry>
      <term>
       ロールバック後、アドオンおよびサードバーティソフトウェアを使用できない場合がある
      </term>
      <listitem>
       <para>
        スナップショットから除外されるサブボリューム(<filename>/opt</filename>など)にデータをインストールするアプリケーションやアドオンは、アプリケーションデータの他の部分がスナップショットに含まれるサブボリュームにもインストールされている場合、ロールバック後に動作しない場合があります。この問題を解決するには、アプリケーションまたはアドオンを再インストールします。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>ファイルアクセスの問題</term>
      <listitem>
       <para>
        スナップショットと現在のシステムでファイルのパーミッションまたは所有権、あるいはその両方がアプリケーションによって変更されている場合、そのアプリケーションは該当するファイルにアクセスできない場合があります。ロールバック後、影響を受けるファイルのパーミッションまたは所有権、あるいはその両方をリセットします。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>互換性のないデータ形式</term>
      <listitem>
       <para>
        サービスまたはアプリケーションがスナップショットと現在のシステムとの間に新しいデータ形式を設定した場合、ロールバック後、そのアプリケーションは影響を受けたデータファイルを読み込めない場合があります。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>コードとデータが混在するサブボリューム</term>
      <listitem>
       <para>
        <filename>/srv</filename>のようなサブボリュームには、コードとデータが混在する場合があります。ロールバックの結果、コードが機能しなくなる場合があります。たとえば、PHPのバージョンがダウングレードされ、WebサーバのPHPスクリプトが壊れる場合があります。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>ユーザーデータ量</term>
      <listitem>
       <para>
        ロールバックによりシステムからユーザが削除された場合、これらのユーザが、スナップショットから除外されているディレクトリ内で所有していたデータは削除されません。同じユーザIDを持つユーザが作成された場合、そのユーザは該当ファイルを継承します。<command>find</command>のようなツールを使用して、孤立したファイルを検索して削除します。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="sec-snapper-limits-snapshot-boot-grub">
    <title>ブートローダのデータはロールバックできない</title>
    <para>
     ブートローダはロールバックできません。これは、ブートローダのすべての<quote>ステージ</quote>が整合している必要があるためです。これは、<filename>/boot</filename>のロールバックを実行する際には保証できません。
    </para>
   </sect3>
  </sect2>
 </sect1>
 
 <sect1 xml:id="sec-snapper-homedirs">
     <title>ユーザホームディレクトリでのSnapperの有効化</title>
     
     <para>
         多数のユースケースをサポートする、ユーザの<filename>/home</filename>ディレクトリのスナップショットを有効にできます。
     </para>
     <itemizedlist>
          <listitem>
              <para>
                 個々のユーザは独自のスナップショットおよびロールバックを管理できます。
             </para>
         </listitem>
         <listitem>
             <para>
                 システムユーザ、たとえば、設定ファイル、ドキュメントなどのコピーを追跡したいデータベース、システム、およびネットワーク管理者。
             </para>
         </listitem>    
         <listitem>
             <para>
                 SambaはホームディレクトリおよびBtrfsバックエンドと共有します。
             </para>
         </listitem>
     </itemizedlist>
     <para>
         各ユーザのディレクトリは<filename>/home</filename>のBtrfsサブボリュームです。これを手動で設定できます(<xref linkend="sec-snapper-manual-home-config"/>を参照)。ただし、<literal>pam_snapper</literal>を使用する方がより便利です。<literal>pam_snapper</literal>パッケージでは、<literal>pam_snapper.so</literal>モジュールおよびヘルパースクリプトがインストールされ、ユーザの作成およびSnapper設定が自動化されます。 
     </para>
     <para>
         <literal>pam_snapper</literal>では、<command>useradd</command>コマンド、プラグ可能認証モジュール(PAM)、およびSnapperとの統合が提供されます。デフォルトでは、ユーザログイン時およびログアウト時にスナップショットが作成され、一部のユーザは延長された期間にログインしたままであるため、タイムベースのスナップショットも作成されます。通常のSnapperコマンドと設定ファイルを使用して、デフォルトを変更できます。
     </para>

     <sect2 xml:id="sec-snapper-install-pam-snapper">
         <title>pam_snapperのインストールとユーザの作成</title>
         
         <para>
             最も簡単な方法は、Btrfsでフォーマットされた新しい<filename>/home</filename>ディレクトリで既存のユーザなしで開始する方法です。<literal>pam_snapper</literal>をインストールします。
         </para>
         <screen><prompt role="root"># </prompt>zypper in pam_snapper</screen>
         <para>
             <filename>/etc/pam.d/common-session</filename>に次の行を追加します。
         </para>
         <screen>session optional pam_snapper.so</screen>
         <para>
             <command>/usr/lib/pam_snapper/pam_snapper_useradd.sh</command>スクリプトを使用して、新しいユーザとホームディレクトリを作成します。デフォルトで、スクリプトはドライランを実行します。スクリプトを編集し、<literal>DRYRUN=1</literal>を<literal>DRYRUN=0</literal>に変更します。これで、新しいユーザを作成できます。
         </para>
         <screen><prompt role="root"># </prompt>/usr/lib/pam_snapper/pam_snapper_useradd.sh \
<replaceable>username</replaceable> <replaceable>group</replaceable> passwd=<replaceable>password</replaceable>
Create subvolume '/home/username'
useradd: warning: the home directory already exists.
Not copying any file from skel directory into it.
</screen>
         <para>
             <filename>/etc/skel</filename>からのファイルは最初のログイン時にユーザのホームディレクトリにコピーされます。ユーザの設定がSnapper設定を一覧表示して作成されていることを確認します。
         </para>
         <screen><prompt role="root"># </prompt>snapper list --all
Config: home_username, subvolume: /home/username
Type   | # | Pre # | Date | User | Cleanup | Description | Userdata
-------+---+-------+------+------+---------+-------------+---------
single | 0 |       |      | root |         | current     |
</screen>
        <para>
            時間が経過するにつれて、この出力にはスナップショットのリストが取り込まれ、ユーザは標準のSnapperコマンドを管理できます。
        </para>
     </sect2>

     <sect2 xml:id="sec-snapper-remove-user">
         <title>ユーザを削除する</title>
         <para>
             <command>/usr/lib/pam_snapper/pam_snapper_userdel.sh</command>スクリプトでユーザを削除します。デフォルトでは、ドライランを実行し、それを編集して、<literal>DRYRUN=1</literal>を<literal>DRYRUN=0</literal>に変更します。ユーザ、ユーザのホームサブボリューム、Snapper設定が削除され、すべてのスナップショットが削除されます。
         </para>
         <screen><prompt role="root"># </prompt>/usr/lib/pam_snapper/pam_snapper_userdel.sh username</screen>
     </sect2>

     <sect2 xml:id="sec-snapper-manual-home-config">
         <title>ホームディレクトリでのスナップショットの手動有効化</title>
         
         <para>
            Snapperを使用してユーザのホームディレクトリを手動で設定するためのステップがあります。<filename>/home</filename>は、Btrfsでフォーマットされる必要があり、ユーザはまだ作成されていません。
        </para>
        <screen><prompt role="root"># </prompt>btrfs subvol create /home/<replaceable>username</replaceable>
<prompt role="root"># </prompt>snapper -c home_<replaceable>username</replaceable> create-config /home/<replaceable>username</replaceable>
<prompt role="root"># </prompt>sed -i -e "s/ALLOW_USERS=\"\"/ALLOW_USERS=\"<replaceable>username</replaceable>\"/g" \
/etc/snapper/configs/home_<replaceable>username</replaceable>
<prompt role="root"># </prompt>yast users add username=<replaceable>username</replaceable> home=/home/<replaceable>username</replaceable> password=<replaceable>password</replaceable>
<prompt role="root"># </prompt>chown <replaceable>username</replaceable>.<replaceable>group</replaceable> /home/<replaceable>username</replaceable>
<prompt role="root"># </prompt>chmod 755 /home/<replaceable>username</replaceable>/.snapshots
</screen>
</sect2>
 </sect1>
 
 <sect1 xml:id="sec-snapper-config">
  <title>Snapper設定の作成と変更</title>

  <para>
   Snapperの動作は、各パーティションまたは<literal>Btrfs</literal>サブボリュームに固有の設定ファイルで定義できます。これらの設定ファイルは、<filename>/etc/snapper/configs/</filename>に保存されます。
  </para>

  <para>
   ルートファイルシステムに十分な容量(約12GB)がある場合、ルートファイルシステム(<filename>/</filename>)のスナップショットはインストール時に自動的に有効になります。対応するデフォルト設定は<filename>root</filename>という名前です。これにより、YaSTおよびZypperのスナップショットが作成および管理されます。デフォルト値のリストについては、<xref linkend="sec-snapper-config-modify-values"/>を参照してください。
  </para>


  <note>
   <title>スナップショットを有効にするための最小ルートファイルシステム</title>
   <para>
    <xref linkend="sec-snapper-setup"/>で説明されているように、スナップショットを有効にするには、ルートファイルシステムに追加の空き容量が必要です。この容量は、インストールされているパッケージの量と、スナップショットに含まれるボリュームに加えられた変更の量によって異なります。スナップショットの頻度と、アーカイブされるスナップショットの数も重要です。
   </para>
   <para>
    インストール時にスナップショットを自動的に有効にするには、最小サイズのルートファイルシステムが必要です。現在、このサイズは約12GBです。この値は今後、基本システムのアーキテクチャとサイズに応じて変わる可能性があります。これは、インストールメディアにあるファイル<filename>/control.xml</filename>の次のタグの値に依存します。
   </para>
   <screen>&lt;root_base_size&gt;
&lt;btrfs_increase_percentage&gt;</screen>
   <para>
    これは、<replaceable>ROOT_BASE_SIZE</replaceable> * (1 + <replaceable>BTRFS_INCREASE_PERCENTAGE</replaceable>/100)という式で計算されます。
   </para>
   <para>
    この値は最小サイズであることに注意してください。ルートファイルシステム用に、これよりも多くの容量を使用することを検討します。一般的には、スナップショットが有効でない場合に使用するサイズの2倍にします。
   </para>
  </note>

  <para>
   <literal>Btrfs</literal>でフォーマットされたその他のパーティションや<literal>Btrfs</literal>パーティション上の既存のサブボリュームに対して、独自の設定ファイルを作成できます。以下の例では、<literal>/srv/www</literal>にマウントされた<filename>Btrfs</filename>フォーマットのパーティションに保存されたWebサーバデータをバックアップするSnapper設定を作成します。
  </para>

  <para>
   設定が作成された後で、<command>snapper</command>自体またはYaSTの<guimenu>Snapper</guimenu>モジュールを使用して、これらのスナップショットからファイルを復元できます。YaSTの場合は<guimenu>現在の設定</guimenu>を選択する必要があります。<command>snapper</command>の場合は、グローバルスイッチ<option>-c</option>を使用して設定を指定する必要があります(例: <command>snapper -c myconfig list</command>)。
  </para>

  <para>
   新しいSnapper設定を作成するには、<command>snapper create-config</command>を実行します。
  </para>

<screen><prompt>&gt; </prompt><command>sudo</command> snapper -c www-data<co xml:id="snapper-create-name"/> create-config /srv/www<co xml:id="snapper-create-volume"/></screen>

  <calloutlist>
   <callout arearefs="snapper-create-name">
    <para>
     設定ファイルの名前。
    </para>
   </callout>
   <callout arearefs="snapper-create-volume">
    <para>
     スナップショットを作成するパーティションまたは<literal>Btrfs</literal>サブボリュームのマウントポイント。
    </para>
   </callout>
  </calloutlist>

  <para>
   このコマンドにより、新しい設定ファイル<filename>/etc/snapper/configs/www-data</filename>が作成され、<filename>/etc/snapper/config-templates/default</filename>から取得されたデフォルト値が使用されます。これらのデフォルトの調整方法については、<xref linkend="sec-snapper-config-modify"/>を参照してください。
  </para>

  <tip>
   <title>設定のデフォルト値</title>
   <para>
    新しい設定ファイルのデフォルト値は<filename>/etc/snapper/config-templates/default</filename>から取得されます。独自のデフォルトセットを使用する場合は、同じディレクトリ内にこのファイルのコピーを作成し、必要に応じて調整してください。作成したファイルを使用するには、create-configコマンドで<option>-t</option>オプションを指定します。
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> snapper -c www-data create-config -t <replaceable>MY_DEFAULTS</replaceable> /srv/www</screen>
  </tip>

  <sect2 xml:id="sec-snapper-config-modify">
   <title>既存の設定の管理</title>
   <para>
    <command>snapper</command>コマンドは、既存の設定を管理するためのサブコマンドを備えています。これらの設定を一覧、表示、削除、および変更することができます。
   </para>
   <variablelist>
    <varlistentry>
     <term>設定の一覧表示</term>
     <listitem>
      <para>
       既存の設定をすべて取得するには、<command>snapper list-configs</command>サブコマンドを使用します。
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> snapper list-configs
Config | Subvolume
-------+----------
root   | /
usr    | /usr
local  | /local</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>設定の表示</term>
     <listitem>
      <para>
       指定した設定を表示するには、<command>snapper -c <replaceable>CONFIG</replaceable> get-config</command> サブコマンドを使用します。<replaceable>CONFIG</replaceable>を<command>snapper list-configs</command>で示される設定名のいずれかに置き換えます。環境設定オプションの詳細については、<xref linkend="sec-snapper-config-modify-values"/>を参照してください。
      </para>
      <para>
       デフォルトの設定を表示するには、次のコマンドを実行します。
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> snapper -c root get-config</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>設定の変更</term>
     <listitem>
      <para>
       指定した設定のオプションを変更するには、<command>snapper -c <replaceable>CONFIG</replaceable> set-config <replaceable>OPTION</replaceable>=<replaceable>VALUE</replaceable></command>サブコマンドを使用します。<replaceable>CONFIG</replaceable>を<command>snapper list-configs</command>で示される設定名のいずれかに置き換えます。<replaceable>OPTION</replaceable>および<replaceable>VALUE</replaceable>に指定可能な値は、<xref linkend="sec-snapper-config-modify-values"/>に一覧にされています。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>設定の削除</term>
     <listitem>
      <para>
       設定を削除するには、<command>snapper -c <replaceable>CONFIG</replaceable> delete-config</command> サブコマンドを使用します。<replaceable>CONFIG</replaceable>を<command>snapper list-configs</command>で示される設定名のいずれかに置き換えます。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <sect3 xml:id="sec-snapper-config-modify-values">
    <title>環境設定データ</title>
    <para>
     各設定には、コマンドラインから変更可能なオプションのリストが含まれています。次に、各オプションの詳細を示します。値を変更するには、<command>snapper -c <replaceable>CONFIG</replaceable> set-config &quot;<replaceable>KEY</replaceable>=<replaceable>VALUE</replaceable>&quot;</command>を実行します。
    </para>
    <variablelist>
     <varlistentry>
      <term><literal>ALLOW_GROUPS</literal>、<literal>ALLOW_USERS</literal>
      </term>
      <listitem>
       <para>
        通常のユーザにスナップショットを使用するパーミッションを付与します。詳細については、<xref linkend="sec-snapper-config-user"/>を参照してください。
       </para>
       <para>
        デフォルト値は<literal>&quot;&quot;</literal>です。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>BACKGROUND_COMPARISON</literal>
      </term>
      <listitem>
       <para>
        事前および事後スナップショットを、作成後にバックグラウンドで比較するかどうかを定義します。
       </para>
       <para>
        デフォルト値は<literal>yes (はい)</literal>です。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>なし_*</literal>
      </term>
      <listitem>
       <para>
        同一の事前および事後スナップショットを持つスナップショットペアのクリーンアップアルゴリズムを定義します。詳細については<xref linkend="sec-snapper-clean-up-empty"/>を参照してください。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>FSTYPE</literal>
      </term>
      <listitem>
       <para>
        パーティションのファイルシステムタイプ。変更しません。
       </para>
       <para>
        デフォルト値は<literal>btrfs</literal>です。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>NUMBER_*</literal></term>
      <listitem>
       <para>
        インストールおよび管理スナップショットのクリーンアップアルゴリズムを定義します。詳細については<xref linkend="sec-snapper-clean-up-number"/>を参照してください。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>QGROUP</literal> / <literal>SPACE_LIMIT</literal>
      </term>
      <listitem>
       <para>
        クリーンアップアルゴリズムにクォータサポートを追加します。詳細については<xref linkend="sec-snapper-clean-up-quota"/>を参照してください。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>SUBVOLUME</literal>
      </term>
      <listitem>
       <para>
        スナップショットを作成するパーティションまたはサブボリュームのマウントポイント。変更しません。
       </para>
       <para>
        デフォルト値は<literal>「/」</literal>です。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>SYNC_ACL</literal>
      </term>
      <listitem>
       <para>
        Snapperが通常ユーザによって使用される場合(<xref linkend="sec-snapper-config-user"/>を参照)、ユーザは<filename>.snapshot</filename>ディレクトリにアクセスして、そのディレクトリ内のファイルを読み取ることができる必要があります。SYNC_ACLを<literal>yes (はい)</literal>に設定した場合、Snapperは自動的に、ALLOW_USERSまたはALLOW_GROUPSエントリからACLを使用してユーザとグループがファイルにアクセスできるようにします。
       </para>
       <para>
        デフォルト値は<literal>no (いいえ)</literal>です。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>TIMELINE_CREATE</literal>
      </term>
      <listitem>
       <para>
        <literal>yes (はい)</literal>に設定されている場合は、毎時スナップショットが作成されます。有効な値: <literal>yes(はい)</literal>、<literal>no(いいえ)</literal>。
       </para>
       <para>
        デフォルト値は<literal>no (いいえ)</literal>です。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>TIMELINE_CLEANUP</literal> / <literal>TIMELINE_LIMIT_*</literal>
      </term>
      <listitem>
       <para>
        タイムラインスナップショットのクリーンアップアルゴリズムを定義します。詳細については<xref linkend="sec-snapper-clean-up-timeline"/>を参照してください。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="sec-snapper-config-user">
    <title>通常ユーザとしてのSnapperの使用</title>
    <para>
     デフォルトでは、<systemitem class="username">root</systemitem>しかSnapperを使用できません。しかし、以下のような場合、特定のグループまたはユーザがスナップショットを作成したり、スナップショットを使って変更を取り消したりできる必要があります。
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       Webサイト管理者が<filename>/srv/www</filename>のスナップショットを作成したい場合
      </para>
     </listitem>
     <listitem>
      <para>
       ユーザが自身のホームディレクトリのスナップショットを作成したい場合
      </para>
     </listitem>
    </itemizedlist>
    <para>
     このような目的のために、ユーザまたは/およびグループに許可を付与するSnapper設定を作成できます。対応する<filename>.snapshots</filename>ディレクトリは、指定されたユーザによって読み込みおよびアクセス可能である必要があります。このための最も簡単な方法は、SYNC_ACLオプションを<literal>yes (はい)</literal>に設定することです。
    </para>
    <procedure>
     <title>通常ユーザによるSnapper使用の有効化</title>
     <para>
      次のすべての手順は<systemitem class="username">root</systemitem>として実行する必要があります。
     </para>
     <step>
      <para>
       Snapper設定がまだ存在しない場合は、ユーザがSnapperを使用できるようにする必要のあるパーティションまたはサブボリュームに対してSnapper設定を作成します。手順については、<xref linkend="sec-snapper-config"/>を参照してください。例:
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> snapper --config web_data create /srv/www</screen>
     </step>
     <step>
      <para>
       <filename>/etc/snapper/configs/<replaceable>CONFIG</replaceable></filename>に設定ファイルを作成します。CONFIGは、前の手順で<option>-c/--config</option>を使用して指定される値です(<filename>/etc/snapper/configs/web_data</filename>など)。必要に応じて調整します。詳細については、<xref linkend="sec-snapper-config-modify"/>を参照してください。
      </para>
     </step>
     <step>
      <para>
       <envar>ALLOW_USERS</envar>と<envar>ALLOW_GROUPS</envar>、またはその一方の値を設定し、ユーザやグループにパーミッションを与えます。複数のエントリは<keycap function="space"/>で区切ってください。たとえば、ユーザ<systemitem class="username">www_admin</systemitem>にパーミッションを与えるには、次のように入力します。
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> snapper -c web_data set-config "ALLOW_USERS=www_admin" SYNC_ACL="yes"</screen>
     </step>
     <step>
      <para>
       これで、指定されたユーザやグループが特定のSnapper設定を使用できます。以下のように<literal>list</literal>コマンドを使ってテストできます。
      </para>
<screen><prompt>www_admin:~ &gt; </prompt>snapper -c web_data list</screen>
     </step>
    </procedure>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-snapper-manage">
  <title>スナップショットの手動での作成と管理</title>

  <para>
   Snapperは設定によって自動的にスナップショットを作成および管理するだけのものではありません。コマンドラインツールまたはYaSTモジュールを使用して、手動でスナップショットのペア(<quote>事前および事後</quote>)や単一のスナップショットを作成することもできます。
  </para>

  <para>
   Snapperのすべての操作は既存の設定に対して実行されます(詳細は<xref linkend="sec-snapper-config"/>を参照)。スナップショットを作成するには、対象のパーティションまたはボリュームに対して設定が存在する必要があります。デフォルトで、システム設定(<literal>root</literal>)が使用されます。独自の設定に対してスナップショットを作成または管理するには、明示的にその設定を選択する必要があります。YaSTの<guimenu>現在の設定</guimenu>ドロップダウンボックスを使用するか、コマンドラインで<option>-c</option>を指定します(<command>snapper -c<replaceable> MYCONFIG</replaceable>
   <replaceable> COMMAND</replaceable></command>)。
  </para>

  <sect2 xml:id="sec-snapper-manage-metadata">
   <title>スナップショットのメタデータ</title>
   <para>
    各スナップショットには、スナップショット自体とメタデータが含まれています。スナップショットを作成する場合は、メタデータも指定する必要があります。スナップショットを修正すると、メタデータが変更されます。コンテンツを修正することはできません。既存のスナップショットとそのメタデータを表示するには、<command>snapper list</command>を使用します。
   </para>
   <variablelist>
    <varlistentry>
     <term><command>snapper --config home list</command>
     </term>
     <listitem>
      <para>
       設定<literal>home</literal>のスナップショットの一覧を示します。デフォルト設定(root)のスナップショットの一覧が示されるようにするには、<command>snapper -c root list</command>または<command>snapper list</command>を使用します。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>snapper list -a</command>
     </term>
     <listitem>
      <para>
       すべての既存設定の一覧を示します。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>snapper list -t pre-post</command>
     </term>
     <listitem>
      <para>
       デフォルト(<literal>root</literal>)設定の事前および事後スナップショットの全ペアの一覧を示します。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>snapper list -t single</command>
     </term>
     <listitem>
      <para>
       デフォルト(<literal>root</literal>)設定について、<literal>single</literal>タイプの全スナップショットの一覧を示します。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <para>
    各スナップショットについて、以下のメタデータを利用できます。
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      <emphasis role="bold">Type(種類)</emphasis>:スナップショットの種類です。詳細は<xref linkend="sec-snapper-manage-metadata-type"/>を参照してください。このデータは変更できません。
     </para>
    </listitem>
    <listitem>
     <para>
      <emphasis role="bold">Number(番号)</emphasis>:スナップショットの一意の番号。このデータは変更できません。
     </para>
    </listitem>
    <listitem>
     <para>
      <emphasis role="bold">Pre Number(前番号)</emphasis>:対応する事前スナップショットの番号を指定します。事後スナップショットにのみ適用されます。このデータは変更できません。
     </para>
    </listitem>
    <listitem>
     <para>
      <emphasis role="bold">Description(説明)</emphasis>:スナップショットの説明です。
     </para>
    </listitem>
    <listitem>
     <para>
      <emphasis role="bold">Userdata (ユーザデータ)</emphasis>: カンマ区切りの「キー=値」のリスト形式でカスタムデータを指定できる、拡張用の項目です。(例:<literal>reason=testing, project=foo</literal>)。このフィールドは、スナップショットに重要のマークを付ける場合(<literal>important=yes</literal>)や、スナップショットを作成したユーザを一覧にする場合(user=tux)にも使用されます。
     </para>
    </listitem>
    <listitem>
     <para>
      <emphasis role="bold">Cleanup-Algorithm(クリーンアップアルゴリズム)</emphasis>:スナップショットのクリーンアップアルゴリズムです。詳細は<xref linkend="sec-snapper-clean-up"/>を参照してください。
     </para>
    </listitem>
   </itemizedlist>
   <sect3 xml:id="sec-snapper-manage-metadata-type">
    <title>スナップショットの種類</title>
    <para>
     Snapperには、事前(pre)、事後(post)、および単一(single)の3種類のスナップショットがあります。これらは物理的には同じものですが、Snapperでは別のものとして扱われます。
    </para>
    <variablelist>
     <varlistentry>
      <term><literal>pre</literal>(事前)
      </term>
      <listitem>
       <para>
        変更<emphasis>前</emphasis>のファイルシステムのスナップショットです。各<literal>pre</literal>スナップショットは<literal>post</literal>スナップショットに対応しています。たとえば、これはYaST/Zypperの自動スナップショットに使用されます。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>post</literal>(事後)
      </term>
      <listitem>
       <para>
        変更<emphasis>後</emphasis>のファイルシステムのスナップショットです。各<literal>post</literal>スナップショットは<literal>pre</literal>スナップショットに対応しています。たとえば、これはYaST/Zypperの自動スナップショットに使用されます。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>single</literal>(単一)
      </term>
      <listitem>
       <para>
        スタンドアロンのスナップショットです。たとえば、これは1時間ごとの自動スナップショットに使用されます。これは、スナップショットを作成する際のデフォルトの種類です。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="sec-snapper-manage-metadata-cleanup">
    <title>クリーンアップアルゴリズム</title>
    <para>
     Snapperには、古いスナップショットのクリーンアップアルゴリズムが3種類あります。このアルゴリズムは、日次の<systemitem class="daemon">cron</systemitem>ジョブとして実行されます。保持するさまざまなタイプのスナップショットの数を、Snapper設定で定義することができます(詳細は<xref linkend="sec-snapper-config-modify"/>を参照)。
    </para>
    <variablelist>
     <varlistentry>
      <term>number(番号)</term>
      <listitem>
       <para>
        スナップショットが特定の数に達すると、古いスナップショットを削除します。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>timeline (タイムライン)</term>
      <listitem>
       <para>
        特定の期間が経過した古いスナップショットは削除しますが、毎時、毎日、毎月、および毎年のスナップショットを複数保持します。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>empty-pre-post(事前事後の差分なし)</term>
      <listitem>
       <para>
        事前と事後のスナップショットに差分がない場合、そのペアを削除します。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-snapper-manage-create">
   <title>スナップショットの作成</title>
   <para>
    スナップショットを作成するには、<command>snapper create</command>を実行するか、YaSTモジュール<guimenu>Snapper</guimenu>の<guimenu>作成</guimenu>をクリックします。以下は、コマンドラインを使ってスナップショットを作成する場合の例です。Snapper用のYaSTインタフェースはここでは明示的に説明されていませんが、等価な機能を提供しています。
   </para>
   <tip>
    <title>スナップショットの説明</title>
    <para>
     後で識別しやすくするため、わかりやすい説明を指定しておいてください。オプション<option>--userdata</option>を介して追加情報を指定することもできます。
    </para>
   </tip>
   <para/>
   <variablelist>
    <varlistentry>
     <term><command>snapper create --from <replaceable>17</replaceable> --description &quot;with package2&quot;</command>
     </term>
     <listitem>
      <para>
       既存のスナップショットからスタンドアロンスナップショット(シングルタイプ)を作成します。これは、<command>snapper list</command>からのスナップショットの番号で指定されます。(これはSnapperバージョン0.8.4以降に適用されます。)
      </para>
     </listitem>
    </varlistentry> 
    <varlistentry>
     <term><command>snapper create --description &quot;Snapshot for week 2 2014&quot;</command>
     </term>
     <listitem>
      <para>
       説明付きのスタンドアロンのスナップショット(種類はsingle）を、デフォルト(<literal>root</literal>)設定で作成します。クリーンアップアルゴリズムは指定されていないので、自動的にスナップショットが削除されることはありません。
      </para>
     </listitem>
    </varlistentry>
     <varlistentry>
     <term><command>snapper --config home create --description &quot;Cleanup in ~tux&quot;</command>
     </term>
     <listitem>
      <para>
       説明付きのスタンドアロンのスナップショット(種類はsingle)を、カスタム設定<literal>home</literal>で作成します。クリーンアップアルゴリズムは指定されていないので、自動的にスナップショットが削除されることはありません。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>snapper --config home create --description &quot;Daily data backup&quot; --cleanup-algorithm timeline</command>&gt;
     </term>
     <listitem>
      <para>
       説明付きのスタンドアロンのスナップショット(種類はsingle)を、カスタム設定<literal>home</literal>で作成します。設定のタイムライン(timeline)クリーンアップアルゴリズムで指定された条件が満たされると、スナップショットが自動的に削除されます。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>snapper create --type pre--print-number--description &quot;Before the Apache config cleanup&quot;--userdata &quot;important=yes&quot;</command>
     </term>
     <listitem>
      <para>
       種類が<literal>pre</literal>のスナップショットを作成し、スナップショット番号を出力します。<quote>事前</quote>と<quote></quote>「事後」の状態を保存するために使用されるスナップショットペアを作成するために必要な、最初のコマンドです。スナップショットには重要のマークが付きます。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>snapper create --type post--pre-number 30--description &quot;After the Apache config cleanup&quot;--userdata &quot;important=yes&quot;</command>
     </term>
     <listitem>
      <para>
       番号<literal>30</literal>の<literal>pre</literal>スナップショットとペアになる<literal>post</literal>スナップショットを作成します。<quote>事前</quote>と<quote>事後</quote>の状態を保存するために使用されるスナップショットペアを作成するために必要な、2番目のコマンドです。スナップショットには重要のマークが付きます。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>snapper create --command <replaceable>COMMAND</replaceable>--description &quot;Before and after COMMAND&quot;</command>
     </term>
     <listitem>
      <para>
       <replaceable>COMMAND</replaceable>の実行前後に自動的にスナップショットを作成します。このオプションを使用できるのは、コマンドラインでsnapperを使用する場合のみです。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec-snapper-manage-modify">
   <title>スナップショットのメタデータ修正</title>
   <para>
    Snapperでは、スナップショットの説明、クリーンアップアルゴリズム、およびユーザデータを修正できます。それ以外のメタデータは変更できません。以下は、コマンドラインを使ってスナップショットを修正する場合の例です。YaSTインタフェースを使用している場合、これらの例は簡単に採用できます。
   </para>
   <para>
    コマンドラインでスナップショットを修正するには、スナップショットの番号がわかっている必要があります。<command>snapperlist</command>コマンドを実行すると、すべてのスナップショットとその番号が表示されます。
   </para>
   <para>
    YaSTの<guimenu>Snapper</guimenu>モジュールでは、すでにすべてのスナップショットのリストが表示されています。リストからスナップショットを選択し、<guimenu>Modify</guimenu>をクリックします。
   </para>
   <variablelist>
    <varlistentry>
     <term><command>snapper modify --cleanup-algorithm &quot;timeline&quot;</command> 10
     </term>
     <listitem>
      <para>
       デフォルト(<literal>root</literal>)設定のスナップショット10番のメタデータを修正します。クリーンアップアルゴリズムが<literal>timeline</literal>に設定されます。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>snapper --config home modify --description &quot;daily backup&quot; -cleanup-algorithm &quot;timeline&quot;120</command>
     </term>
     <listitem>
      <para>
       カスタム設定<literal>home</literal>のスナップショット120番のメタデータを修正します。新しい説明が設定され、クリーンアップアルゴリズムを無しに設定します。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec-snapper-manage-delete">
   <title>スナップショットの削除</title>
   <para>
    YaSTの<guimenu>Snapper</guimenu>モジュールを使用してスナップショットを削除するには、リストからスナップショットを選択して<guimenu>Delete (削除)</guimenu>をクリックします。
   </para>
   <para>
    コマンドラインツールを使ってスナップショットを削除するには、スナップショットの番号が分かっている必要があります。<command>snapper list</command>を実行して番号を調べます。スナップショットを削除するには、<command>snapper delete </command>
    <replaceable>NUMBER</replaceable>コマンドを実行します。
   </para>
   <para>
    現在のデフォルトのサブボリュームスナップショットの削除は許可されません。
   </para>
   <para>
    Snapperでスナップショットを削除すると、空いたスペースはバックグラウンドで実行されているBtrfsプロセスによって要求されます。つまり、空きスペースが見えるように、あるいは使用できるようになるまでに遅れが生じます。スナップショットの削除で空いたスペースをすぐに使用したい場合は、deleteコマンドで<option>--sync</option>オプションを指定します。
   </para>
   <tip>
    <title>スナップショットペアの削除</title>
    <para>
     <literal>pre</literal>スナップショットを削除する場合は、必ず、対応する<literal>post</literal>スナップショットを削除する必要があります(逆も同様です)。
    </para>
   </tip>
   <variablelist>
    <varlistentry>
     <term><command>snapper delete 65</command>
     </term>
     <listitem>
      <para>
       デフォルト(<literal>root</literal>)設定のスナップショット65番を削除します。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>snapper -c home delete 89 90</command>
     </term>
     <listitem>
      <para>
       カスタム設定<literal>home</literal>のスナップショット89番および90番を削除します。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>snapper delete --sync 23</command></term>
     <listitem>
      <para>
       デフォルト設定(<literal>root</literal>) のスナップショット23を削除し、空いたスペースをすぐに使用できるようにします。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <tip>
    <title>参照されていないスナップショットの削除</title>
    <para>
     Btrfsスナップショットが存在するのに、Snapper用のメタデータを含むXMLファイルが欠落している場合があります。この場合、スナップショットがSnapperには見えないため、手動で削除する必要があります。
    </para>
<screen>btrfs subvolume delete /.snapshots/<replaceable>SNAPSHOTNUMBER</replaceable>/snapshot
rm -rf /.snapshots/SNAPSHOTNUMBER</screen>
   </tip>
   <tip>
    <title>古いスナップショットほどディスク容量を使用</title>
    <para>
     ハードディスクの容量を空けるためにスナップショットを削除する場合は、古いスナップショットから削除するようにします。古いスナップショットほど、多くの容量を使用します。
    </para>
   </tip>
   <para>
    スナップショットは、日次のcronジョブでも自動的に削除されます。詳細については、<xref linkend="sec-snapper-manage-metadata-cleanup"/>を参照してください。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-snapper-clean-up">
  <title>スナップショットの自動クリーンアップ</title>

  <para>
   スナップショットはディスク容量を占有し、時間が経つにつれて、スナップショットが占有するディスク容量が増える可能性があります。ディスク容量が不足しないようにするために、Snapperは、古いスナップショットを自動的に削除するためのアルゴリズムを備えています。これらのアルゴリズムは、タイムラインスナップショットと番号付きスナップショット(管理スナップショットとインストールスナップショットのペア)を区別します。各タイプに対して、保持するスナップショットの数を指定できます。
  </para>

  <para>
   そのほかに、オプションでディスク容量クォータを指定し、スナップショットが占有可能な最大ディスク容量を定義することもできます。また、事前スナップショットと事後スナップショットのペアに違いがない場合、それらのペアを自動的に削除することもできます。
  </para>

  <para>
   クリーンアップアルゴリズムは常に1つのSnapper設定にバインドされるため、各設定に対してアルゴリズムを設定する必要があります。特定のスナップショットが自動的に削除されないようにするには、<xref linkend="faq-snapper-permanent"/>を参照してください。
  </para>

  <para>
   デフォルトのセットアップ(<literal>root</literal>)は、番号付きスナップショットと、空の事前/事後スナップショットのペアのクリーンアップを実行するように設定されています。クォータサポートが有効になっている場合、スナップショットは、ルートパーティションの使用可能なディスク容量を50%までしか占有できません。タイムラインスナップショットはデフォルトで無効になっているため、タイムラインのクリーンアップアルゴリズムも無効になっています。
  </para>

  <sect2 xml:id="sec-snapper-clean-up-number">
   <title>番号付きスナップショットのクリーンアップ</title>
   <para>
    番号付きスナップショット(管理スナップショットとインストールスナップショットのペア)のクリーンアップは、Snapper設定の次のパラメータで制御します。
   </para>
   <variablelist>
    <varlistentry>
     <term><literal>NUMBER_CLEANUP</literal>
     </term>
     <listitem>
      <para>
       インストールスナップショットと管理スナップショットのペアのクリーンアップを有効または無効にします。有効にすると、スナップショットのペアは、スナップショットの合計数が<literal>NUMBER_LIMIT</literal>または<literal>NUMBER_LIMIT_IMPORTANT</literal> <emphasis></emphasis>、あるいはその両方で指定された数を超え、「かつ」<literal>NUMBER_MIN_AGE</literal>で指定された保存期間を超えた場合に削除されます。有効な値: <literal>yes(はい)</literal> (有効)、<literal>no(いいえ)</literal> (無効)。
      </para>
      <para>
       デフォルト値は<literal>yes (はい)</literal>です。
      </para>
      <para>
       変更または設定を行うコマンドの例:
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> snapper -c <replaceable>CONFIG</replaceable> set-config "NUMBER_CLEANUP=no"</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><literal>NUMBER_LIMIT</literal> / <literal>NUMBER_LIMIT_IMPORTANT</literal>
     </term>
     <listitem>
      <para>
       保持する通常のインストール/管理スナップショットのペア、または重要なインストール/管理スナップショットのペア、あるいはその両方の数を定義します。<literal>NUMBER_CLEANUP</literal>が<literal>「no(いいえ)」</literal>に設定されている場合、無視されます。
      </para>
      <para>
       デフォルト値は、<literal>NUMBER_LIMIT</literal>では<literal>「2-10」</literal>、<literal>NUMBER_LIMIT_IMPORTANT</literal>では<literal>「4-10」</literal>です。クリーニングアルゴリズムは、スナップショットとファイルシステムのスペースを考慮せずに、指定された最大値を超えるスナップショットを削除します。また、スナップショットとファイルシステムの制限に達するまで、最小値を超えるスナップショットも削除します。
      </para>
      <para>
       変更または設定を行うコマンドの例:
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> snapper -c <replaceable>CONFIG</replaceable> set-config "NUMBER_LIMIT=10"</screen>
      <important>
       <title>範囲値と定数値の比較</title>
       <para>
        クォータサポートが有効な場合は(<xref linkend="sec-snapper-clean-up-quota"/>を参照)、制限を「最小値-最大値」の範囲として指定する必要があります。たとえば、<literal>2-10</literal>のように指定します。クォータサポートが無効な場合は、定数値(たとえば<literal>10</literal>)を指定する必要があります。そうしないと、エラーが発生してクリーンアップに失敗します。
       </para>
      </important>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><literal>NUMBER_MIN_AGE</literal>
     </term>
     <listitem>
      <para>
       スナップショットが自動削除の対象となるまでの最短期間を秒単位で定義します。ここで指定した期間に達していなければ、スナップショットはいくつ存在していても削除されません。
      </para>
      <para>
       デフォルト値は<literal>1800</literal>です。
      </para>
      <para>
       変更または設定を行うコマンドの例:
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> snapper -c <replaceable>CONFIG</replaceable> set-config "NUMBER_MIN_AGE=864000"</screen>
     </listitem>
    </varlistentry>
   </variablelist>
   <note>
    <title>制限と保存期間</title>
    <para>
     <literal>NUMBER_LIMIT</literal>、<literal>NUMBER_LIMIT_IMPORTANT</literal>、および<literal>NUMBER_MIN_AGE</literal>は常に評価されます。スナップショットが削除されるのは、<emphasis></emphasis>「すべての」条件を満たしている場合のみです。
    </para>
    <para>
     保存期間に関係なく、<literal>NUMBER_LIMIT*</literal>で定義された数のスナップショットを常に保持する場合は、<literal>NUMBER_MIN_AGE</literal>を<literal>0</literal>に設定します。
    </para>
    <para>
     次の例は、保存期間に関係なく最新の10個の重要なスナップショットと通常のスナップショットを保持するための設定を示しています。
    </para>
<screen>NUMBER_CLEANUP=yes
NUMBER_LIMIT_IMPORTANT=10
NUMBER_LIMIT=10
NUMBER_MIN_AGE=0</screen>
    <para>
     一方、一定の保存期間を超えたスナップショットを保持しない場合は、<literal>NUMBER_LIMIT*</literal>を<literal>0</literal>に設定し、<literal>NUMBER_MIN_AGE</literal>で保存期間を指定します。
    </para>
    <para>
     次の例は、10日経っていないスナップショットのみを保持するための設定を示しています。
    </para>
<screen>NUMBER_CLEANUP=yes
NUMBER_LIMIT_IMPORTANT=0
NUMBER_LIMIT=0
NUMBER_MIN_AGE=864000</screen>
   </note>
  </sect2>

  <sect2 xml:id="sec-snapper-clean-up-timeline">
   <title>タイムラインスナップショットのクリーンアップ</title>
   <para>
    タイムラインスナップショットのクリーンアップは、Snapper設定の次のパラメータで制御します。
   </para>
   <variablelist>
    <varlistentry>
     <term><literal>TIMELINE_CLEANUP</literal>
     </term>
     <listitem>
      <para>
       タイムラインスナップショットのクリーンアップを有効または無効にします。有効にすると、スナップショットは、スナップショットの合計数が<literal>TIMELINE_LIMIT_*</literal>
       <emphasis></emphasis>で指定された数を超え、「かつ」<literal>TIMELINE_MIN_AGE</literal>で指定された保存期間を超える場合に削除されます。有効な値: <literal>yes(はい)</literal>、<literal>no(いいえ)</literal>。
      </para>
      <para>
       デフォルト値は<literal>yes (はい)</literal>です。
      </para>
      <para>
       変更または設定を行うコマンドの例:
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> snapper -c <replaceable>CONFIG</replaceable> set-config "TIMELINE_CLEANUP=yes"</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><literal>TIMELINE_LIMIT_DAILY</literal>、<literal>TIMELINE_LIMIT_HOURLY</literal>、<literal>TIMELINE_LIMIT_MONTHLY</literal>、
<literal>TIMELINE_LIMIT_WEEKLY</literal>、<literal>TIMELINE_LIMIT_YEARLY</literal>
     </term>
     <listitem>
      <para>
       1時間、1日、1週間、1カ月間、および1年間に保持するスナップショット数です。
      </para>
      <para>
       各エントリのデフォルト値は<literal>「10」</literal>です。ただし、<literal>TIMELINE_LIMIT_WEEKLY</literal>は例外であり、デフォルトで<literal>「0」</literal>に設定されています。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><literal>TIMELINE_MIN_AGE</literal>
     </term>
     <listitem>
      <para>
       スナップショットが自動削除の対象となるまでの最短期間を秒単位で定義します。
      </para>
      <para>
       デフォルト値は<literal>1800</literal>です。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <example xml:id="ex-snapper-config-timeline">
    <title>タイムライン設定の例</title>
<screen>TIMELINE_CLEANUP="yes"
TIMELINE_CREATE="yes"
TIMELINE_LIMIT_DAILY="7"
TIMELINE_LIMIT_HOURLY="24"
TIMELINE_LIMIT_MONTHLY="12"
TIMELINE_LIMIT_WEEKLY="4"
TIMELINE_LIMIT_YEARLY="2"
TIMELINE_MIN_AGE="1800"</screen>
    <para>
     この設定例では、毎時スナップショットが自動的に削除されます。<literal>TIMELINE_MIN_AGE</literal>と<literal>TIMELINE_LIMIT_*</literal>は常に両方が評価されます。この例では、スナップショットが削除対象となるまでの最短保存期間が30分(1800秒)に設定されています。毎時のスナップショットを作成するので、最新のスナップショットだけが保持されることになります。<literal>TIMELINE_LIMIT_DAILY</literal>をゼロ以外に設定すると、1日の最初のスナップショットが保持されることになります。
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <title>保持されるスナップショット</title>
     <listitem>
      <para>
       1時間ごと: 最新の24個のスナップショットが保持されます。
      </para>
     </listitem>
     <listitem>
      <para>
       1日ごと: 各日の最初に作成されたスナップショットが、直近の7日分保持されます。
      </para>
     </listitem>
     <listitem>
      <para>
       1カ月ごと: 各月の最後の日に作成された最初のスナップショットが、直近の12カ月分保持されます。
      </para>
     </listitem>
     <listitem>
      <para>
       1週ごと: 各週の最後の日に作成された最初のスナップショットが、直近の4週分保持されます。
      </para>
     </listitem>
     <listitem>
      <para>
       1年ごと: 各年の最後の日に作成された最初のスナップショットが、直近の2年分保持されます。
      </para>
     </listitem>
    </itemizedlist>
   </example>
  </sect2>

  <sect2 xml:id="sec-snapper-clean-up-empty">
   <title>違いがないスナップショットのペアのクリーンアップ</title>
   <para>
    <xref linkend="snapper-snapshot-type"/>で説明したように、YaSTモジュールまたはZypperを実行すると、起動時に事前スナップショットが作成され、終了時に事後スナップショットが作成されます。変更を何も加えていない場合、事前スナップショットと事後スナップショットには違いがありません。Snapper設定で次のパラメータを設定することで、そのような<quote>空の</quote>スナップショットのペアを自動的に削除できます。
   </para>
   <variablelist>
    <varlistentry>
     <term><literal>EMPTY_PRE_POST_CLEANUP</literal>
     </term>
     <listitem>
      <para>
       <literal>yes (はい)</literal>に設定した場合、違いがない事前および事後スナップショットのペアは削除されます。
      </para>
      <para>
       デフォルト値は<literal>yes (はい)</literal>です。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><literal>EMPTY_PRE_POST_MIN_AGE</literal>
     </term>
     <listitem>
      <para>
       違いがない事前および事後スナップショットのペアが自動削除の対象となるまでの最短期間を秒単位で定義します。
      </para>
      <para>
       デフォルト値は<literal>1800</literal>です。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec-snapper-clean-up-manual">
   <title>手動で作成されたスナップショットのクリーンアップ</title>
   <para>
    Snapperは、手動で作成されたスナップショットに対するカスタムクリーンアップアルゴリズムを備えていません。ただし、手動で作成されたスナップショットに、numberクリーンアップアルゴリズムまたはtimelineクリーンアップアルゴリズムを割り当てることができます。その場合、スナップショットは、指定されたアルゴリズムの<quote>クリーンアップキュー</quote>に入ります。クリーンアップアルゴリズムは、スナップショットの作成時に指定することも、既存のスナップショットを変更して指定することもできます。
   </para>
   <variablelist>
    <varlistentry>
     <term><command>snapper create --description &quot;Test&quot; --cleanup-algorithm number</command>
     </term>
     <listitem>
      <para>
       デフォルト(ルート)設定のスタンドアロンスナップショット(singleタイプ)を作成して、<literal>number</literal>クリーンアップアルゴリズムを割り当てます。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>snapper modify --cleanup-algorithm &quot;timeline&quot; 25</command>
     </term>
     <listitem>
      <para>
       番号が25のスナップショットを変更して、クリーンアップアルゴリズム<literal>timeline</literal>を割り当てます。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec-snapper-clean-up-quota">
   <title>ディスククォータサポートの追加</title>
   <para>
    上で説明したnumberクリーンアップアルゴリズムまたはtimelineクリーンアップアルゴリズム、あるいはその両方のほかに、Snapperはクォータもサポートします。スナップショットが占有できる使用可能な容量の割合を定義できます。この割合の値は常に、各Snapper設定で定義されたBtrfsサブボリュームに適用されます。
   </para>
   <para> 
       Btrfsクォータはユーザにではなく、サブボリュームに適用されます。Btrfsクォータを使用するだけでなく、ディスクスペースクォータをユーザやグループに適用することもできます(たとえば、<command>quota</command>コマンドを使用)。
   </para>
   <para>
    インストール時にSnapperを有効にした場合、クォータサポートは自動的に有効になっています。後から手動でSnapperを有効にする場合は、<command>snapper setup-quota</command>を実行することでクォータサポートを有効にできます。そのためには有効な設定が必要です(詳細については、<xref linkend="sec-snapper-config"/>を参照してください)。
   </para>
   <para>
    クォータサポートは、Snapper設定の次のパラメータで制御します。
   </para>
   <variablelist>
    <varlistentry>
     <term><literal>QGROUP</literal>
     </term>
     <listitem>
      <para>
       Snapperによって使用されるBtrfsクォータグループです。設定されていない場合は、<command>snapper setup-quota</command>を実行します。すでに設定されている場合は、<command>man 8 btrfs-qgroup</command>について十分理解している場合にのみ変更してください。この値は<command>snapper setup-quota</command>で設定されます。値を変更しないでください。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><literal>SPACE_LIMIT</literal>
     </term>
     <listitem>
      <para>
       スナップショットが使用できる容量の制限を、1を100%とする小数で指定します。値の範囲は0～1(0.1 = 10%、0.2 = 20%、...)です。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <para>
    次の制限とガイドラインが適用されます。
   </para>
   <itemizedlist>
    <listitem>
     <para>
      クォータは、既存のnumberクリーンアップアルゴリズムまたはtimelineクリーンアップアルゴリズム、あるいはその両方に「追加」<emphasis></emphasis>する形でのみアクティブ化されます。クリーンアップアルゴリズムがアクティブになっていない場合、クォータ制約は適用されません。
     </para>
    </listitem>
    <listitem>
     <para>
      クォータサポートが有効な場合、Snapperは必要に応じてクリーンアップを2回実行します。最初の実行では、number スナップショットおよびtimelineスナップショットに対して指定されているルールを適用します。この実行後にクォータを超えた場合にのみ、2回目の実行でクォータ固有のルールが適用されます。
     </para>
    </listitem>
    <listitem>
     <para>
      クォータサポートが有効になっていて、クォータを超えた場合でも、Snapperは常に、<literal>NUMBER_LIMIT*</literal>および<literal>TIMELINE_LIMIT*</literal>の値で指定された数のスナップショットを保持します。したがって、<literal>NUMBER_LIMIT*</literal>および<literal>TIMELINE_LIMIT*</literal>に対する値の範囲(<literal><replaceable>MIN</replaceable>-<replaceable>MAX</replaceable></literal>)を指定して、クォータを確実に適用できるようにすることをお勧めします。
     </para>
     <para>
      たとえば、<literal>NUMBER_LIMIT=5-20</literal>が設定されている場合、Snapperは、最初のクリーンアップを実行して、標準の番号付きスナップショットの数を20に減らします。これら20個のスナップショットがクォータを超えると、Snapperは、2回目の実行時に、クォータが満たされるまで最も古いスナップショットから順番に削除します。スナップショットが占有する容量にかかわらず、少なくとも5つのスナップショットは常に保持されます。
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
</sect1>
 
  <sect1>
      <title>スナップショットが使用する排他的なディスク容量の表示</title>
     <para>
      スナップショットはデータを共有してストレージ容量を効率的に使用できるため、<command>du</command>や<command>df</command>などの通常のコマンドを使用しても、使用済みディスク容量は正確に測定されません。クォータを有効にしてBtrfsのディスク容量を解放する場合は、共有領域ではなく、各スナップショットで使用されている排他的なディスク容量を把握する必要があります。Snapper 0.6以降では、各スナップショットの使用済みディスク容量が<literal>Used Space</literal>列に報告されます。
</para>
<screen><prompt role="root"># </prompt>snapper--iso list
  # | Type   | Pre # | Date                | User | Used Space | Cleanup | Description           | Userdata     
----+--------+-------+---------------------+------+------------+---------+-----------------------+--------------
 0  | single |       |                     | root |            |         | current               |              
 1* | single |       | 2019-07-22 13:08:38 | root |  16.00 KiB |         | first root filesystem |              
 2  | single |       | 2019-07-22 14:21:05 | root |  14.23 MiB | number  | after installation    | important=yes
 3  | pre    |       | 2019-07-22 14:26:03 | root | 144.00 KiB | number  | zypp(zypper)          | important=no 
 4  | post   |     3 | 2019-07-22 14:26:04 | root | 112.00 KiB | number  |                       | important=no 
 5  | pre    |       | 2019-07-23 08:19:36 | root | 128.00 KiB | number  | zypp(zypper)          | important=no 
 6  | post   |     5 | 2019-07-23 08:19:43 | root |  80.00 KiB | number  |                       | important=no 
 7  | pre    |       | 2019-07-23 08:20:50 | root | 256.00 KiB | number  | yast sw_single        |              
 8  | pre    |       | 2019-07-23 08:23:22 | root | 112.00 KiB | number  | zypp(ruby.ruby2.5)    | important=no 
 9  | post   |     8 | 2019-07-23 08:23:35 | root |  64.00 KiB | number  |                       | important=no 
10  | post   |     7 | 2019-07-23 08:24:05 | root |  16.00 KiB | number  |                       |              
</screen>
<para>
    <command>btrfs</command>コマンドは、スナップショットが使用するスペースの別のビューを提供します。
</para>
<screen>
<prompt role="root"># </prompt>btrfs qgroup show -p /
qgroupid         rfer         excl parent  
--------         ----         ---- ------  
0/5          16.00KiB     16.00KiB ---     
[...]    
0/272         3.09GiB     14.23MiB 1/0     
0/273         3.11GiB    144.00KiB 1/0     
0/274         3.11GiB    112.00KiB 1/0     
0/275         3.11GiB    128.00KiB 1/0     
0/276         3.11GiB     80.00KiB 1/0     
0/277         3.11GiB    256.00KiB 1/0     
0/278         3.11GiB    112.00KiB 1/0     
0/279         3.12GiB     64.00KiB 1/0     
0/280         3.12GiB     16.00KiB 1/0     
1/0           3.33GiB    222.95MiB --- 
</screen>
<para>
    <literal>qgroupid</literal>列には、各サブボリュームの識別番号が表示され、qgroupレベルとIDの組み合わせが割り当てられます。
</para> 
<para>
    <literal>rfer</literal>列には、サブボリュームに参照されるデータ合計数が表示されます。
</para>
<para>
    <literal>excl</literal>列には、各サブボリュームの排他的なデータが表示されます。 
</para>
<para>
    <literal>parent</literal>列には、サブボリュームの親qgroupが表示されます。
</para>
<para>    
    最後の項目、<literal>1/0</literal>、は親qgroupの合計が表示されます。上記の例では、サブボリュームのすべてが削除される場合、222.95MiBが解放されます。次のコマンドを実行して、各サブボリュームに関連するスナップショットが確認されます。
</para>
<screen><prompt role="root"># </prompt>btrfs subvolume list -st /
ID	gen	top level	path	
--	---	---------	----	
267	298	266		@/.snapshots/1/snapshot
272	159	266		@/.snapshots/2/snapshot
273	170	266		@/.snapshots/3/snapshot
274	171	266		@/.snapshots/4/snapshot
275	287	266		@/.snapshots/5/snapshot
276	288	266		@/.snapshots/6/snapshot
277	292	266		@/.snapshots/7/snapshot
278	296	266		@/.snapshots/8/snapshot
279	297	266		@/.snapshots/9/snapshot
280	298	266		@/.snapshots/10/snapshot
</screen>
     <para>
      あるサービスパックから別のサービスパックにアップグレードすると、スナップショットがシステムサブボリュームの多くのディスク領域を占有することになります。これらのスナップショットが不要になった場合は、手動で削除することをお勧めします。詳細については<xref linkend="sec-snapper-manage-delete"/>を参照してください。
     </para>
 </sect1>

 <sect1 xml:id="sec-snapper-faqs">
  <title>ホットスポットに関する一般的な質問とその回答 (FAQ)</title>

  <qandaset defaultlabel="qanda">
   <qandaentry>
    <question>
     <para>
      Snapperでは<filename>/var/log</filename>、<filename>/tmp</filename>などのディレクトリの変更が表示されませんが、なぜですか?
     </para>
    </question>
    <answer>
     <para>
      一部のディレクトリについては、スナップショットから除外することに決定しました。リストと理由については、<xref linkend="snapper-dir-excludes"/>を参照してください。スナップショットからパスを除外するため、これらのパス用にサブボリュームを作成しています。
     </para>
    </answer>
   </qandaentry>
   <qandaentry>
    <question>
     <para>
      ブートローダからスナップショットをブートできますか?
     </para>
    </question>
    <answer>
     <para>
      はい。詳細については、<xref linkend="sec-snapper-snapshot-boot"/>を参照してください。
     </para>
    </answer>
   </qandaentry>
   <qandaentry xml:id="faq-snapper-permanent">
    <question>
     <para>
      スナップショットを削除から保護することができますか?
     </para>
    </question>
    <answer>
     <para>
      現在のところ、Snapperでは、スナップショットが手動で削除されるのを防ぐ方法はありません。ただし、スナップショットがクリーンアップアルゴリズムによって自動的に削除されるのを防ぐことはできます。手動で作成されたスナップショット(<xref linkend="sec-snapper-manage-create"/>を参照)には、<option>--cleanup-algorithm</option>でクリーンアップアルゴリズムを指定しない限り、クリーンアップアルゴリズムは割り当てられていません。自動的に作成されたスナップショットには、常に<literal>number</literal>アルゴリズムまたは<literal>timeline</literal>アルゴリズムが割り当てられています。1つ以上のスナップショットからそのような割り当てを削除するには、次の手順に従います。
     </para>
     <procedure>
      <step>
       <para>
        使用可能なすべてのスナップショットの一覧を表示します。
       </para>
<screen><prompt>&gt; </prompt><command>sudo</command> snapper list -a</screen>
      </step>
      <step>
       <para>
        削除されないようにするスナップショットの数を記憶します。
       </para>
      </step>
      <step>
       <para>
        次のコマンドを実行します。数字のプレースホルダを、記憶した数に置き換えます。
       </para>
<screen><prompt>&gt; </prompt><command>sudo</command> snapper modify --cleanup-algorithm "" <replaceable>#1</replaceable> <replaceable>#2</replaceable> <replaceable>#n</replaceable></screen>
      </step>
      <step>
       <para>
        もう一度<command>snapper list -a</command>を実行して、結果を確認します。変更したスナップショットの列<literal>Cleanup</literal>のエントリが空になります。
       </para>
      </step>
     </procedure>
    </answer>
   </qandaentry>
   <qandaentry>
    <question>
     <para>
      Snapperに関する詳細情報はどこで入手できますか?
     </para>
    </question>
    <answer>
     <para>
      Snapperのホームページ(<link xlink:href="http://snapper.io/"/>)を参照してください。
     </para>
    </answer>
   </qandaentry>
  </qandaset>
 </sect1>
</chapter>
