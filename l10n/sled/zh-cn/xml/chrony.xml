<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="chrony.xml" version="5.0" xml:id="cha-ntp">


 <title>使用 NTP 同步时间</title>
 <info>
      <abstract>
        <para>
    NTP（网络时间协议）机制是用于同步网络上的系统时间的协议。首先，计算机从作为可靠时间源的服务器获得时间。然后将此计算机用作网络中其他计算机的时间源。这样做有双重目的，既可维护绝对时间，又可保持网络中所有计算机系统时间的同步。
   </para>
      </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:bugtracker/>
        <dm:translation>yes</dm:translation>
      </dm:docmanager>
    </info>
    <para>
  维护确切的系统时间在许多情况下都非常重要。内置硬件时钟往往不能满足数据库或群集这样的应用程序的要求。手动更正系统时间可能会导致许多严重问题，例如向后调整时间将使关键应用程序出现故障。在网络中，通常需要同步所有计算机上的系统时间，但是手动调整时间是一种不好的方法。NTP 提供了解决这些问题的机制。NTP 服务通过网络中的可靠时间服务器持续调整系统时间。它还支持对本地参考时钟（如无线电控制的时钟）进行管理。
 </para>
 <para>
  自 <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 15 起，采用 <systemitem class="resource">chrony</systemitem> 作为 NTP 的默认实施。<systemitem class="resource">chrony</systemitem> 包含两个部分：<systemitem class="daemon">chronyd</systemitem> 守护程序可在引导时启动，<command>chronyc</command> 命令行界面程序用于监视 <systemitem class="daemon">chronyd</systemitem> 的性能，以及在运行时更改各种操作参数。
 </para>
 <para>
  从 <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 15.2 开始，如果不是配置为以守护程序的形式运行，适用于 NTP 客户端配置的 YaST 模块将配置 systemd-timer 而不是 cron 守护程序来执行 <systemitem class="resource">chrony</systemitem>。
 </para>
 <note os="sled;osuse">
  <para>
   要通过 Active Directory 启用时间同步，请遵循<xref linkend="proc-ad-join"/>中的描述。
  </para>
 </note>
 <sect1 xml:id="sec-ntp-yast">
  <title>使用 YaST 配置 NTP 客户端</title>

  <para>
   <systemitem>chrony</systemitem> 软件包中附带的 NTP 守护程序 (<systemitem class="daemon">chronyd</systemitem>) 预先设置为使用本地计算机硬件时钟作为时间参考。硬件时钟的精确度极大程度上取决于它的时间源。例如，原子时钟或 GPS 接收器是非常精确的时间源，而一般 RTC 芯片则不是可靠的时间源。YaST 简化了 NTP 客户端的配置。
  </para>

  <para>
   在 YaST NTP 客户端配置（<menuchoice><guimenu>网络服务</guimenu> <guimenu>NTP 配置</guimenu></menuchoice>）窗口中，您可以指定启动 NTP 守护程序的时间、配置源的类型，以及添加自定义的时间服务器。
  </para>

  <figure>
   <title>NTP 配置窗口</title>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="ntp_client.png" width="70%" format="PNG"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="ntp_client.png" width="70%" format="PNG"/>
    </imageobject>
   </mediaobject>
  </figure>

  <sect2>
   <title>NTP 守护程序启动</title>
   <para>
    您可以从下面三个选项中选择启动 NTP 守护程序的时间：
   </para>
   <variablelist>
    <varlistentry>
     <term><guimenu>仅手动</guimenu>
     </term>
     <listitem>
      <para>
       如果您想手动启动 <systemitem class="resource">chrony</systemitem> 守护程序，请选择<guimenu>仅手动</guimenu>。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><guimenu>不用守护进程同步</guimenu>
     </term>
     <listitem>
      <para>
       选择<guimenu>不用守护进程同步</guimenu>可定期设置系统时间，而不用永久运行 <systemitem class="resource">chrony</systemitem>。您可以设置<guimenu>同步间隔（以分钟计）</guimenu>。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><guimenu>立即和在引导时</guimenu>
     </term>
     <listitem>
      <para>
       选择<guimenu>立即和在引导时</guimenu>可在引导系统时自动启动 <systemitem class="daemon">chronyd</systemitem>￼。建议使用此设置。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2>
   <title>配置源的类型</title>
   <para>
    在<guimenu>配置源</guimenu>下拉框中，选择<guimenu>动态</guimenu>或<guimenu>静态</guimenu>。如果服务器只使用固定的一组（公共）NTP 服务器，请设置<guimenu>静态</guimenu>；如果您的内部网络通过 DHCP 提供 NTP 服务器，则使用<guimenu>静态</guimenu>更合适。
   </para>
  </sect2>

  <sect2 xml:id="sec-net-ntp-yast-new-sync">
   <title>配置时间服务器</title>
   <para>
    供客户端查询的时间服务器列在 <guimenu>NTP 配置</guimenu>窗口的下半部分。使用<guimenu>添加</guimenu>、<guimenu>编辑</guimenu>和<guimenu>删除</guimenu>可按需修改此列表。
   </para>
   <para>
    单击<guimenu>添加</guimenu>可添加新的时间服务器：
   </para>
   <figure>
    <title>添加时间服务器</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="ntp_client_serveradd.png" width="70%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="ntp_client_serveradd.png" width="70%" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <procedure>
    <step>
     <para>
      在<guimenu>地址</guimenu>字段中，键入要与计算机时间同步的时间服务器或时间服务器池的 URL。填写好 URL 后，单击<guimenu>测试</guimenu>以校验该 URL 是否指向有效的时间源。
     </para>
    </step>
    <step>
     <para>
      激活<guimenu>快速初始同步</guimenu>，以便在 <systemitem class="daemon">chronyd</systemitem> 守护程序启动时通过发送更多请求来加速时间同步。
     </para>
    </step>
    <step>
     <para>
      激活<guimenu>离线启动</guimenu>，以使自动启动 <systemitem class="daemon">chronyd</systemitem> 守护程序且引导时可能没有互联网连接的系统加快引导速度。例如，对于由 NetworkManager 管理网络连接的笔记本电脑，此选项非常实用。
     </para>
    </step>
    <step>
     <para>
      单击<guimenu>确定</guimenu>进行确认。
     </para>
    </step>
   </procedure>
  </sect2>


 </sect1>



 <sect1 xml:id="sec-netz-xntp-netconf">
  <title>手动配置网络中的 NTP</title>

  <para>
   <systemitem class="resource">chrony</systemitem> 从 <filename>/etc/chrony.conf</filename> 文件读取其配置。要让计算机时钟保持同步，您需要告诉 <systemitem class="resource">chrony</systemitem> 使用什么时间服务器。您可以使用特定的服务器名称或 IP 地址，例如：
  </para>

<screen>server 0.europe.pool.ntp.org
server 1.europe.pool.ntp.org
server 2.europe.pool.ntp.org</screen>

  <para>
   还可以指定<emphasis>池</emphasis>名称。池名称会解析为若干个 IP 地址：
  </para>

<screen>pool pool.ntp.org</screen>

  <tip>
   <title>同一网络中的多台计算机</title>
   <para>
    要同步同一网络中的多台计算机的时间，建议不要通过一台外部服务器同步所有计算机。比较好的做法是将其中一台计算机作为时间服务器（它与外部时间服务器同步），其他计算机作为它的客户端。将 <literal>local</literal> 指令添加至服务器的 <filename>/etc/chrony.conf</filename>，以将其与权威时间服务器区分开：
   </para>
<screen>local stratum 10</screen>
  </tip>

  <para>
   要启动 <systemitem class="resource">chrony</systemitem>，请运行：
  </para>

<screen>systemctl start chronyd.service</screen>

  <para>
   初始化 <systemitem class="daemon">chronyd</systemitem> 后，系统需要花费一些时间来稳定时间，以及创建用于纠正本地计算机时钟的偏移文件。利用偏移文件，当计算机启动时，可以计算出硬件时钟的系统误差。可以立即使用更正功能，使系统时间保持较高的稳定性。
  </para>

  <para>
   要启用 <systemitem class="resource">chrony</systemitem> 以便该服务在引导时自动启动，请运行：
  </para>

<screen>systemctl enable chronyd.service</screen>
 </sect1>
 <sect1 xml:id="ntp-chronyc">
  <title>在运行时使用 <command>chronyc</command> 配置 <systemitem class="daemon">chronyd</systemitem></title>

  <para>
   在运行时，您可以使用 <command>chronyc</command> 来更改 <systemitem class="daemon">chronyd</systemitem> 的行为。它会生成有关 <systemitem class="daemon">chronyd</systemitem> 的操作的状态报告。
  </para>

  <para>
   您可以采用交互模式或非交互模式运行 <command>chronyc</command>。要采用交互模式运行 <command>chronyc</command>，请在命令行上输入 <command>chronyc</command>。如此会显示提示符并等待您输入命令。例如，要检查有多少个 NTP 源联机或脱机，请运行：
  </para>

<screen><prompt role="root">root # </prompt><command>chronyc</command>
chronyc&gt; activity
200 OK
4 sources online
2 sources offline
1 sources doing burst (return to online)
1 sources doing burst (return to offline)
0 sources with unknown address</screen>

  <para>
   要退出 <command>chronyc</command> 的提示符，请输入 <command>quit</command> 或 <command>exit</command>。
  </para>

  <para>
   如果您不需要使用交互提示符，请直接输入命令：
  </para>

<screen><prompt role="root">root # </prompt><command>chronyc</command> activity</screen>

  <note>
   <title>临时更改</title>
   <para>
    使用 <command>chronyc</command> 进行的更改不是永久性的。当 <systemitem class="daemon">chronyd</systemitem> 下次重启动时，它们将会丢失。要进行永久更改，请修改 <filename>/etc/chrony.conf</filename>。
   </para>
  </note>

  <para>
   有关 <command>chronyc</command> 命令的完整列表，请参见它的手册页 (<command>man 1 chronyc</command>)。
  </para>
 </sect1>
 <sect1 xml:id="sec-netz-xntp-dynamic">
  <title>运行时的动态时间同步</title>



  <para>
  尽管 <systemitem class="daemon">chronyd</systemitem> 通常在引导时没有网络连接的系统上启动，但该工具无法解析配置文件中指定的时间服务器的 DNS 名称。
  </para>

  <para>
   <systemitem class="daemon">chronyd</systemitem> 会按递增的时间间隔不断尝试解析由 <option>server</option>、<option>pool</option> 和 <option>peer</option> 指令指定的时间服务器名称，直到成功为止。
  </para>

  <para>
   如果启动 <systemitem class="daemon">chronyd</systemitem> 时将无法访问时间服务器，您可以指定 <option>offline</option> 选项：
  </para>

<screen>server <replaceable>server_address</replaceable> offline</screen>

  <para>
   如此，<systemitem class="daemon">chronyd</systemitem> 将不会尝试轮询服务器，除非使用以下命令启用它：
  </para>

<screen><prompt role="root">root # </prompt>chronyc online <replaceable>server_address</replaceable></screen>

  <para>
   如果设置了 <option>auto_offline</option> 选项，在向时间服务器发送了两个请求，但未接收到任何响应时，<systemitem class="daemon">chronyd</systemitem> 会假设时间服务器已脱机。此选项使 <command>chronyc</command> 在网络链路断开时，无需运行“脱机”命令。
  </para>
 </sect1>



 <sect1 xml:id="sec-netz-xntp-normal">
  <title>设置本地参考时钟</title>

  <para>
   软件包 <systemitem class="resource">chrony</systemitem> 依赖于其他程序（例如 <systemitem>gpsd</systemitem>）来通过 SHM 或 SOCK 驱动程序访问计时数据。在 <filename>/etc/chrony.conf</filename> 中使用 <option>refclock</option> 指令可指定要用作时间源的硬件参考时钟。它有两个必填参数：驱动程序名称和驱动程序特定的参数。这两个参数后面跟着零个或多个 <option>refclock</option> 选项。<systemitem class="daemon">chronyd</systemitem> 包含以下驱动程序：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     PPS：内核“pulse per second”API 的驱动程序。例如：
    </para>
<screen>refclock PPS /dev/pps0 lock NMEA refid GPS</screen>
   </listitem>
   <listitem>
    <para>
     SHM：NTP 共享内存驱动程序。例如：
    </para>
<screen>refclock SHM 0 poll 3 refid GPS1
refclock SHM 1:perm=0644 refid GPS2</screen>
   </listitem>
   <listitem>
    <para>
     SOCK：Unix 域套接字驱动程序。例如：
    </para>
<screen>refclock SOCK /var/run/chrony.ttyS0.sock</screen>
   </listitem>
   <listitem>
    <para>
     PHC：PTP 硬件时钟驱动程序。例如：
    </para>
<screen>refclock PHC /dev/ptp0 poll 0 dpoll -2 offset -37
refclock PHC /dev/ptp1:nocrossts poll 3 pps</screen>
   </listitem>
  </itemizedlist>

  <para>
   有关各个驱动程序的选项的详细信息，请参见 <command>man 8 chrony.conf</command>。
  </para>
 </sect1>
 <sect1 xml:id="sec-netz-xntp-etr" arch="zseries">
  <title>与外部时间参考 (ETR) 的时钟同步</title>



  <para>
   支持与外部时间参考 (ETR) 时钟同步。外部时间参照每 2**20（2 的 20 次幂）微秒发出一次振荡器信号和同步信号，以将连接的所有服务器的 TOD 时钟保持同步。
  </para>

  <para>
   两个 ETR 计算机可以连接到一台计算机。如果时钟偏差超过同步检查容差，将会对所有 CPU 执行一次计算机检查，这表示时钟未同步。如果发生这种情况，在该时钟再次同步前，所有与支持 XRC 的设备进行的 DASD I/O 都将停止。
  </para>

  <para>
   可通过两个 <literal>sysfs</literal> 属性激活 ETR 支持；请以 <systemitem class="username">root</systemitem> 身份运行以下命令：
  </para>

<screen>echo 1 &gt; /sys/devices/system/etr/etr0/online
echo 1 &gt; /sys/devices/system/etr/etr1/online
</screen>
 </sect1>
</chapter>
