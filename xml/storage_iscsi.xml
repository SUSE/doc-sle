<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter
[
  <!ENTITY % entities SYSTEM "entity-decl.ent">
    %entities;
]>
<!-- Converted by suse-upgrade version 1.1 -->
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="cha.iscsi" xml:lang="en">
 <title>Mass Storage over IP Networks: iSCSI</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:bugtracker>
          </dm:bugtracker>
      </dm:docmanager>
    </info>
    <para>
  One of the central tasks in computer centers and when operating servers is
  providing hard disk capacity for server systems. Fibre Channel is often
  used for this purpose. iSCSI (Internet SCSI) solutions provide a
  lower-cost alternative to Fibre Channel that can leverage commodity
  servers and Ethernet networking equipment. Linux iSCSI provides iSCSI
  initiator and iSCSI LIO target software for connecting Linux servers to
  central storage systems.
 </para>
 <figure>
  <title>iSCSI SAN with an iSNS Server</title>
  <mediaobject>
   <imageobject role="fo">
    <imagedata fileref="iscsi_san_a.png" width="80%" format="SVG"/>
   </imageobject>
   <imageobject role="html">
    <imagedata fileref="iscsi_san_a.png" width="100%" format="PNG"/>
   </imageobject>
  </mediaobject>
 </figure>
 <note>
  <title>LIO</title>
  <para>
   LIO (<link xlink:href="http://linux-iscsi.org"/>) is the standard open-source multiprotocol SCSI
   target for Linux. LIO replaced the STGT (SCSI Target) framework as the
   standard unified storage target in Linux with Linux kernel version 2.6.38
   and later. In &productname; 12 the iSCSI LIO Target Server replaces
   the iSCSI Target Server from previous versions.
  </para>
 </note>
 <para>
  iSCSI is a storage networking protocol that facilitates data transfers of
  SCSI packets over TCP/IP networks between block storage devices and
  servers. iSCSI target software runs on the target server and defines the
  logical units as iSCSI target devices. iSCSI initiator software runs on
  different servers and connects to the target devices to make the storage
  devices available on that server.
 </para>
 <para>
  The iSCSI LIO target server and iSCSI initiator servers communicate by
  sending SCSI packets at the IP level in your LAN. When an application
  running on the initiator server starts an inquiry for an iSCSI LIO target
  device, the operating system produces the necessary SCSI commands. The
  SCSI commands are then embedded in IP packets and encrypted as necessary
  by software that is commonly known as the <emphasis>iSCSI
  initiator</emphasis>. The packets are transferred across the internal IP
  network to the corresponding iSCSI remote station, called the
  <emphasis>iSCSI LIO target server</emphasis>, or just the <emphasis>iSCSI
  target</emphasis>.
 </para>
 <para>
  Many storage solutions provide access over iSCSI, but it is also possible
  to run a Linux server that provides an iSCSI target. In this case, it is
  important to set up a Linux server that is optimized for file system
  services. The iSCSI target accesses block devices in Linux. Therefore, it
  is possible to use RAID solutions to increase disk space as well as a lot
  of memory to improve data caching. For more information about RAID, also
  see <xref linkend="cha.raid" xrefstyle="ChapTitleOnPage"/>.
 </para>
 <sect1 xml:id="sec.iscsi.install">
  <title>Installing the iSCSI LIO Target Server and iSCSI Initiator</title>

  <para>
   While the iSCSI initiator is installed by default (packages
   <systemitem class="resource">open-iscsi</systemitem> and
   <systemitem class="resource">yast2-iscsi-client</systemitem>), the iSCSI
   LIO target packages need to be installed manually.
  </para>

  <important>
   <title>Initiator and Target may not Run on the Same Server</title>
   <para>
    It is not supported to run iSCSI target software and iSCSI initiator
    software on the same server in a production environment.
   </para>
  </important>

  <para>
   To install the iSCSI LIO Target Server,SI LIO Target Server, run the following command in a
   terminal console:
  </para>

<screen>sudo zypper in yast2-iscsi-lio-server</screen>

  <para>
   In case you need to install the iSCSI initiator or any of its
   dependencies, run the command <command>sudo zypper in
   yast2-iscsi-client</command>.
  </para>

  <para>
   Alternatively, use the &yast; Software Management module for
   installation.
  </para>

  <para>
   Any packages required in addition to the ones mentioned above will either
   be automatically pulled in by the installer, or be installed when you
   first run the respective &yast; module.
  </para>
 </sect1>
 <sect1 xml:id="sec.iscsi.target">
  <title>Setting Up an iSCSI LIO Target Server</title>

  <para>
   This section describes how to use &yast; to configure an iSCSI LIO
   Target Server and set up iSCSI LIO target devices. You can use any iSCSI
   initiator software to access the target devices.
  </para>

  <sect2 xml:id="sec.iscsi.target.start">
   <title>iSCSI LIO Target Service Start-up and Firewall Settings</title>
   <para>
    The iSCSI LIO Target service is by default configured to be started
    manually. You can configure the service to start automatically at boot
    time. If you use a firewall on the server and you want the iSCSI LIO
    targets to be available to other computers, you must open a port in the
    firewall for each adapter that you want to use for target access. TCP
    port 3260 is the port number for the iSCSI protocol, as defined by IANA
    (Internet Assigned Numbers Authority).
   </para>
   <procedure>
    <step>
     <para>
      Start &yast; and launch <menuchoice> <guimenu>Network
      Services</guimenu> <guimenu>iSCSI LIO Target</guimenu> </menuchoice>.
     </para>
    </step>
    <step>
     <para>
      Switch to the <guimenu>Service</guimenu> tab.
     </para>
     <informalfigure>
      <mediaobject>
       <imageobject role="fo">
        <imagedata fileref="lio_service_a.png" width="80%" format="PNG"/>
       </imageobject>
       <imageobject role="html">
        <imagedata fileref="lio_service_a.png" width="100%" format="PNG"/>
       </imageobject>
      </mediaobject>
     </informalfigure>
    </step>
    <step>
     <para>
      Under <guimenu>Service Start</guimenu>, specify how you want the iSCSI
      LIO target service to be started:
     </para>
     <itemizedlist mark="bullet" spacing="normal">
      <listitem>
       <formalpara>
        <title>When Booting:</title>
        <para>
         The service starts automatically on server restart.
        </para>
       </formalpara>
      </listitem>
      <listitem>
       <formalpara>
        <title>Manually:</title>
        <para>
         (Default) You must start the service manually after a server
         restart by running <command>sudo systemctl start
         target</command>. The target devices are not available
         until you start the service.
        </para>
       </formalpara>
      </listitem>
     </itemizedlist>
    </step>
    <step>
     <para>
      If you use a firewall on the server and you want the iSCSI LIO targets
      to be available to other computers, open port 3260 in the firewall for
      each adapter interface that you want to use for target access. If the
      port is closed for all of the network interfaces, the iSCSI LIO
      targets are not available to other computers.
     </para>
     <para>
      If you do not use a firewall on the server, the firewall settings are
      disabled. In this case skip the following steps and leave the
      configuration dialog with <guimenu>Finish</guimenu> or switch to
      another tab to continue with the configuration.
     </para>
     <substeps performance="required">
      <step>
       <para>
        On the <guimenu>Services</guimenu> tab, select the <guimenu>Open
        Port in Firewall</guimenu> check box to enable the firewall
        settings.
       </para>
      </step>
      <step>
       <para>
        Click <guimenu>Firewall Details</guimenu> to view or configure the
        network interfaces to use. All available network interfaces are
        listed, and all are selected by default. Deselect all interfaces on
        which the port should <emphasis>not</emphasis> be opened. Save your
        settings with <guimenu>OK</guimenu>.
       </para>
      </step>
     </substeps>
    </step>
    <step>
     <para>
      Click <guimenu>Finish</guimenu> to save and apply the iSCSI LIO Target
      service settings.
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.iscsi.target.authenticate">
   <title>Configuring Authentication for Discovery of iSCSI LIO Targets and Clients</title>
   <para>
    The iSCSI LIO Target Server software supports the PPP-CHAP
    (Point-to-Point Protocol Challenge Handshake Authentication Protocol), a
    three-way authentication method defined in the <citetitle>Internet
    Engineering Task Force (IETF) RFC 1994</citetitle>
    (<link xlink:href="http://www.ietf.org/rfc/rfc1994.txt"/>). The server
    uses this authentication method for the discovery of iSCSI LIO targets
    and clients, not for accessing files on the targets. If you do not want
    to restrict the access to the discovery, use <guimenu>No
    Authentication</guimenu>. The <guimenu>No Authentication</guimenu>
    option is enabled by default. Without requiring authentication all iSCSI
    LIO targets on this server can be discovered by any iSCSI initiator
    client on the same network. This server can discover any iSCSI initiator
    client on the same network that does not require authentication for
    discovery.
   </para>
   <para>
    If authentication is needed for a more secure configuration, you can use
    incoming authentication, outgoing authentication, or both.
    <guimenu>Incoming Authentication</guimenu> requires an iSCSI initiator
    to prove that it has the permissions to run a discovery on the iSCSI LIO
    target. The initiator must provide the incoming user name and password.
    <guimenu>Outgoing Authentication</guimenu> requires the iSCSI LIO target
    to prove to the initiator that it is the expected target. The iSCSI LIO
    target must provide the outgoing user name and password to the iSCSI
    initiator. The user name and password pair can be different for incoming
    and outgoing discovery. If authentication for discovery is enabled, its
    settings apply to all iSCSI LIO target groups.
   </para>
   <important>
    <title>Security</title>
    <para>
     We recommend that you use authentication for target and client
     discovery in production environments for security reasons.
    </para>
   </important>
   <para>
    To configure authentication preferences for iSCSI LIO targets:
   </para>
   <procedure>
    <step>
     <para>
      Start &yast; and launch <menuchoice> <guimenu>Network
      Services</guimenu> <guimenu>iSCSI LIO Target</guimenu> </menuchoice>.
     </para>
    </step>
    <step>
     <para>
      Switch to the <guimenu>Global</guimenu> tab.
     </para>
     <informalfigure>
      <mediaobject>
       <imageobject role="fo">
        <imagedata fileref="lio_global_noauth_a.png" width="80%" format="PNG"/>
       </imageobject>
       <imageobject role="html">
        <imagedata fileref="lio_global_noauth_a.png" width="100%" format="PNG"/>
       </imageobject>
      </mediaobject>
     </informalfigure>
    </step>
    <step>
     <para>
      By default, authentication is disabled (<guimenu>No
      Authentication</guimenu>). To enable Authentication, select
      <guimenu>Incoming Authentication</guimenu>, <guimenu>Outgoing
      Authentication</guimenu> or both.
     </para>
    </step>
    <step>
     <para>
      Provide credentials for the selected authentication method(s). The
      user name and password pair can be different for incoming and outgoing
      discovery.
     </para>
    </step>
    <step>
     <para>
      Click <guimenu>Finish</guimenu> to save and apply the settings.
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.iscsi.target.storage">
   <title>Preparing the Storage Space</title>
   <para>
    The iSCSI LIO target configuration exports existing block devices to
    iSCSI initiators. You must prepare the storage space you want to use in
    the target devices by setting up unformatted partitions or devices by
    using the Partitioner in &yast;, or by partitioning the devices from
    the command line with parted. iSCSI LIO targets can use unformatted
    partitions with Linux, Linux LVM, or Linux RAID file system IDs. Refer
    to <xref linkend="sec.yast2.i_y2_part_expert"/> for details.
   </para>
   <important>
    <title>Do Not Mount iSCSI Target Devices</title>
    <para>
     After you set up a device or partition for use as an iSCSI target, you
     never access it directly via its local path. Do not specify a mount
     point for it when you create it.
    </para>
   </important>
   <sect3 xml:id="sec.iscsi.target.storage.vm">
    <title>Partitioning Devices in a Virtual Environment</title>
    <para>
     You can use a virtual machine guest server as an iSCSI LIO Target
     Server. This section describes how to assign partitions to a &xen;
     virtual machine. You can also use other virtual environments that are
     supported by &productname;.
    </para>
    <para>
     In a &xen; virtual environment, you must assign the storage space
     you want to use for the iSCSI LIO target devices to the guest virtual
     machine, then access the space as virtual disks within the guest
     environment. Each virtual disk can be a physical block device, such as
     an entire disk, partition, or volume, or it can be a file-backed disk
     image where the virtual disk is a single image file on a larger
     physical disk on the &xen; host server. For the best performance,
     create each virtual disk from a physical disk or a partition. After you
     set up the virtual disks for the guest virtual machine, start the guest
     server, then configure the new blank virtual disks as iSCSI target
     devices by following the same process as for a physical server.
    </para>
    <para>
     File-backed disk images are created on the &xen; host server, then
     assigned to the &xen; guest server. By default, &xen; stores
     file-backed disk images in the
     <filename>/var/lib/xen/images/<replaceable>vm_name</replaceable></filename>
     directory, where
     <filename><replaceable>vm_name</replaceable></filename> is the name of
     the virtual machine.
    </para>
   </sect3>
  </sect2>

  <sect2 xml:id="sec.iscsi.target.target_group">
   <title>Setting Up an iSCSI LIO Target Group</title>
   <para>
    You can use &yast; to configure iSCSI LIO target devices. &yast;
    uses APIs provided by the <command>lio-utils</command> software. iSCSI
    LIO targets can use unformatted partitions with Linux, Linux LVM, or
    Linux RAID file system IDs.
   </para>
   <important>
    <para>
     Before you begin, create the unformatted partitions that you want to
     use as iSCSI LIO targets as described in
     <xref linkend="sec.iscsi.target.storage" xrefstyle="SectTitleOnPage"/>.
    </para>
   </important>
   <procedure>
    <step>
     <para>
      Start &yast; and launch <menuchoice> <guimenu>Network
      Services</guimenu> <guimenu>iSCSI LIO Target</guimenu> </menuchoice>.
     </para>
    </step>
    <step>
     <para>
      Switch to the <guimenu>Targets</guimenu> tab.
     </para>
     <informalfigure>
      <mediaobject>
       <imageobject role="fo">
        <imagedata fileref="lio_targets_a.png" width="80%" format="PNG"/>
       </imageobject>
       <imageobject role="html">
        <imagedata fileref="lio_targets_a.png" width="100%" format="PNG"/>
       </imageobject>
      </mediaobject>
     </informalfigure>
    </step>
    <step>
     <para>
      Click <guimenu>Add</guimenu>, then define a new iSCSI LIO target group
      and devices:
     </para>
     <para>
      The iSCSI LIO Target software automatically completes the
      <guimenu>Target</guimenu>, <guimenu>Identifier</guimenu>,
      <guimenu>Portal Group</guimenu>, <guimenu>IP Address</guimenu>, and
      <guimenu>Port Number</guimenu> fields. <guimenu>Use
      Authentication</guimenu> is selected by default.
     </para>
     <substeps performance="required">
      <step>
       <para>
        If you have multiple network interfaces, use the IP address
        drop-down list to select the IP address of the network interface to
        use for this target group. To make the server accessible under all
        addresses, choose <guimenu>Bind All IP Addresses</guimenu>.
       </para>
      </step>
      <step>
       <para>
        Deselect <guimenu>Use Authentication</guimenu> if you do not want to
        require client authentication for this target group (not
        recommended).
       </para>
      </step>
      <step>
       <para>
        Click <guimenu>Add</guimenu>. Enter the path of the device or
        partition or <guimenu>Browse</guimenu> to add it. Optionally specify
        a name, then click <guimenu>OK</guimenu>. The LUN number is
        automatically generated, beginning with 0. A name is automatically
        generated if you leave the field empty.
       </para>
      </step>
      <step>
       <para>
        (Optional) Repeat the previous steps to add more targets to this
        target group.
       </para>
      </step>
      <step>
       <para>
        After all desired targets have been added to the group, click
        <guimenu>Next</guimenu>.
       </para>
      </step>
     </substeps>
    </step>
    <step>
     <para>
      On the <guimenu>Modify iSCSI Target Client Setup</guimenu> page,
      configure information for the clients that are permitted to access
      LUNs in the target group:
     </para>
     <informalfigure>
      <mediaobject>
       <imageobject role="fo">
        <imagedata fileref="lio_target_client_a.png" width="80%" format="PNG"/>
       </imageobject>
       <imageobject role="html">
        <imagedata fileref="lio_target_client_a.png" width="100%" format="PNG"/>
       </imageobject>
      </mediaobject>
     </informalfigure>
     <para>
      After you specify at least one client for the target group, the
      <guimenu>Edit LUN</guimenu>, <guimenu>Edit Auth</guimenu>,
      <guimenu>Delete</guimenu>, and <guimenu>Copy</guimenu> buttons are
      enabled. You can use <guimenu>Add</guimenu> or <guimenu>Copy</guimenu>
      to add more clients for the target group:
     </para>
     <itemizedlist xml:id="il.iscsi.target.target_group.options" mark="bullet" spacing="normal">
      <title>Modify iSCSI Target: Options</title>
      <listitem>
       <formalpara>
        <title>Add:</title>
        <para>
         Add a new client entry for the selected iSCSI LIO target group.
        </para>
       </formalpara>
      </listitem>
      <listitem>
       <formalpara>
        <title>Edit LUN:</title>
        <para>
         Configure which LUNs in the iSCSI LIO target group to map to a
         selected client. You can map each of the allocated targets to a
         preferred client LUN.
        </para>
       </formalpara>
      </listitem>
      <listitem>
       <formalpara>
        <title>Edit Auth:</title>
        <para>
         Configure the preferred authentication method for a selected
         client. You can specify no authentication, or you can configure
         incoming authentication, outgoing authentication, or both.
        </para>
       </formalpara>
      </listitem>
      <listitem>
       <formalpara>
        <title>Delete:</title>
        <para>
         Remove a selected client entry from the list of clients allocated
         to the target group.
        </para>
       </formalpara>
      </listitem>
      <listitem>
       <formalpara>
        <title>Copy:</title>
        <para>
         Add a new client entry with the same LUN mappings and
         authentication settings as a selected client entry. This allows you
         to easily allocate the same shared LUNs, in turn, to each node in a
         cluster.
        </para>
       </formalpara>
      </listitem>
     </itemizedlist>
     <substeps performance="required">
      <step>
       <para>
        Click <guimenu>Add</guimenu>, specify the client name, select or
        deselect the <guimenu>Import LUNs from TPG</guimenu> check box, then
        click <guimenu>OK</guimenu> to save the settings.
       </para>
      </step>
      <step>
       <para>
        Select a client entry, click <guimenu>Edit LUN</guimenu>, modify the
        LUN mappings to specify which LUNs in the iSCSI LIO target group to
        allocate to the selected client, then click <guimenu>OK</guimenu> to
        save the changes.
       </para>
       <para>
        If the iSCSI LIO target group consists of multiple LUNs, you can
        allocate one or multiple LUNs to the selected client. By default,
        each of the available LUNs in the group are assigned to a client
        LUN.
       </para>
       <para>
        To modify the LUN allocation, perform one or more of the following
        actions:
       </para>
       <itemizedlist mark="bullet" spacing="normal">
        <listitem>
         <formalpara>
          <title>Add:</title>
          <para>
           Click <guimenu>Add</guimenu> to create a new <guimenu>Client
           LUN</guimenu> entry, then use the <guimenu>Change</guimenu>
           drop-down list to map a target LUN to it.
          </para>
         </formalpara>
        </listitem>
        <listitem>
         <formalpara>
          <title>Delete:</title>
          <para>
           Select the <guimenu>Client LUN</guimenu> entry, then click
           <guimenu>Delete</guimenu> to remove a target LUN mapping.
          </para>
         </formalpara>
        </listitem>
        <listitem>
         <formalpara>
          <title>Change:</title>
          <para>
           Select the <guimenu>Client LUN</guimenu> entry, then use the
           <guimenu>Change</guimenu> drop-down list to select which Target
           LUN to map to it.
          </para>
         </formalpara>
        </listitem>
       </itemizedlist>
       <para>
        Typical allocation plans include the following:
       </para>
       <itemizedlist mark="bullet" spacing="normal">
        <listitem>
         <para>
          A single server is listed as a client. All of the LUNs in the
          target group are allocated to it.
         </para>
         <para>
          You can use this grouping strategy to logically group the iSCSI
          SAN storage for a given server.
         </para>
        </listitem>
        <listitem>
         <para>
          Multiple independent servers are listed as clients. One or
          multiple target LUNs are allocated to each server. Each LUN is
          allocated to only one server.
         </para>
         <para>
          You can use this grouping strategy to logically group the iSCSI
          SAN storage for a given department or service category in the data
          center.
         </para>
        </listitem>
        <listitem>
         <para>
          Each node of a cluster is listed as a client. All of the shared
          target LUNs are allocated to each node. All nodes are attached to
          the devices, but for most file systems, the cluster software locks
          a device for access and mounts it on only one node at a time.
          Shared file systems (such as OCFS2) make it possible for multiple
          nodes to concurrently mount the same file structure and to open
          the same files with read and write access.
         </para>
         <para>
          You can use this grouping strategy to logically group the iSCSI
          SAN storage for a given server cluster.
         </para>
        </listitem>
       </itemizedlist>
      </step>
      <step>
       <para>
        Select a client entry, click <guimenu>Edit Auth</guimenu>, specify
        the authentication settings for the client, then click
        <guimenu>OK</guimenu> to save the settings.
       </para>
       <para>
        You can require <guimenu>No Authentication</guimenu>, or you can
        configure <guimenu>Incoming Authentication</guimenu>,
        <guimenu>Outgoing Authentication</guimenu>, or both. You can specify
        only one user name and password pair for each client. The
        credentials can be different for incoming and outgoing
        authentication for a client. The credentials can be different for
        each client.
       </para>
      </step>
      <step>
       <para>
        Repeat the previous steps for each iSCSI client that can access this
        target group.
       </para>
      </step>
      <step>
       <para>
        After the client assignments are configured, click
        <guimenu>Next</guimenu>.
       </para>
      </step>
     </substeps>
    </step>
    <step>
     <para>
      Click <guimenu>Finish</guimenu> to save and apply the settings.
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.iscsi.target.tg_modify">
   <title>Modifying an iSCSI LIO Target Group</title>
   <para>
    You can modify an existing iSCSI LIO target group as follows:
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      Add or remove target LUN devices from a target group
     </para>
    </listitem>
    <listitem>
     <para>
      Add or remove clients for a target group
     </para>
    </listitem>
    <listitem>
     <para>
      Modify the client LUN-to-target LUN mappings for a client of a target
      group
     </para>
    </listitem>
    <listitem>
     <para>
      Modify the user name and password credentials for a client
      authentication (incoming, outgoing, or both)
     </para>
    </listitem>
   </itemizedlist>
   <para>
    To view or modify the settings for an iSCSI LIO target group:
   </para>
   <procedure>
    <step>
     <para>
      Start &yast; and launch <menuchoice> <guimenu>Network
      Services</guimenu> <guimenu>iSCSI LIO Target</guimenu> </menuchoice>.
     </para>
    </step>
    <step>
     <para>
      Switch to the <guimenu>Targets</guimenu> tab.
     </para>
    </step>
    <step>
     <para>
      Select the iSCSI LIO target group to be modified, then click
      <guimenu>Edit</guimenu>.
     </para>
    </step>
    <step>
     <para>
      On the Modify iSCSI Target LUN Setup page, add LUNs to the target
      group, edit the LUN assignments, or remove target LUNs from the group.
      After all desired changes have been made to the group, click
      <guimenu>Next</guimenu>.
     </para>
     <para>
      For option information, see
      <xref linkend="il.iscsi.target.target_group.options"/>.
     </para>
    </step>
    <step>
     <para>
      On the Modify iSCSI Target Client Setup page, configure information
      for the clients that are permitted to access LUNs in the target group.
      After all desired changes have been made to the group, click
      <guimenu>Next</guimenu>.
     </para>
    </step>
    <step>
     <para>
      Click <guimenu>Finish</guimenu> to save and apply the settings.
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.iscsi.target.tg_delete">
   <title>Deleting an iSCSI LIO Target Group</title>
   <para>
    Deleting an iSCSI LIO target group removes the definition of the group,
    and the related setup for clients, including LUN mappings and
    authentication credentials. It does not destroy the data on the
    partitions. To give clients access again, you can allocate the target
    LUNs to a different or new target group, and configure the client access
    for them.
   </para>
   <procedure>
    <step>
     <para>
      Start &yast; and launch <menuchoice> <guimenu>Network
      Services</guimenu> <guimenu>iSCSI LIO Target</guimenu> </menuchoice>.
     </para>
    </step>
    <step>
     <para>
      Switch to the <guimenu>Targets</guimenu> tab.
     </para>
    </step>
    <step>
     <para>
      Select the iSCSI LIO target group to be deleted, then click
      <guimenu>Delete</guimenu>.
     </para>
    </step>
    <step>
     <para>
      When you are prompted, click <guimenu>Continue</guimenu> to confirm
      the deletion, or click <guimenu>Cancel</guimenu> to cancel it.
     </para>
    </step>
    <step>
     <para>
      Click <guimenu>Finish</guimenu> to save and apply the settings.
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.iscsi.initiator">
  <title>Configuring iSCSI Initiator</title>

  <para>
   The iSCSI initiator, also called an iSCSI client, can be used to connect
   to any iSCSI target. This is not restricted to the iSCSI target solution
   explained in
   <xref linkend="sec.iscsi.target" xrefstyle="SectTitleOnPage"/>. The
   configuration of iSCSI initiator involves two major steps: the discovery
   of available iSCSI targets and the setup of an iSCSI session. Both can be
   done with &yast;.
  </para>

  <sect2 xml:id="sec.iscsi.initiator.yast">
   <title>Using &yast; for the iSCSI Initiator Configuration</title>
   <para>
    The iSCSI Initiator Overview in &yast; is divided into three tabs:
   </para>
   <variablelist>
    <varlistentry>
     <term>Service:</term>
     <listitem>
      <para>
       The <guimenu>Service</guimenu> tab can be used to enable the iSCSI
       initiator at boot time. It also offers to set a unique
       <guimenu>Initiator Name</guimenu> and an iSNS server to use for the
       discovery. The default port for iSNS is 3205.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Connected Targets:</term>
     <listitem>
      <para>
       The <guimenu>Connected Targets</guimenu> tab gives an overview of the
       currently connected iSCSI targets. Like the <guimenu>Discovered
       Targets</guimenu> tab, it also gives the option to add new targets to
       the system.
      </para>
      <para>
       On this page, you can select a target device, then toggle the
       start-up setting for each iSCSI target device:
      </para>
      <formalpara>
       <title>Automatic:</title>
       <para>
        This option is used for iSCSI targets that are to be connected when
        the iSCSI service itself starts up. This is the typical
        configuration.
       </para>
      </formalpara>
      <formalpara>
       <title>Onboot:</title>
       <para>
        This option is used for iSCSI targets that are to be connected
        during boot; that is, when root (<filename>/</filename>) is on
        iSCSI. As such, the iSCSI target device will be evaluated from the
        initrd on server boots.
       </para>
      </formalpara>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Discovered Targets:</term>
     <listitem>
      <para>
       The <guimenu>Discovered Targets</guimenu> tab provides the
       possibility of manually discovering iSCSI targets in the network.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <sect3 xml:id="sec.iscsi.initiator.yast.configuration">
    <title>Configuring the iSCSI Initiator</title>
    <procedure>
     <step>
      <para>
       Start &yast; and launch <menuchoice> <guimenu>Network
       Services</guimenu> <guimenu>iSCSI LIO Target</guimenu> </menuchoice>.
      </para>
     </step>
     <step>
      <para>
       Switch to the <guimenu>Services</guimenu> tab.
      </para>
      <informalfigure>
       <mediaobject>
        <imageobject role="fo">
         <imagedata fileref="iscsi_init_service_a.png" width="80%" format="PNG"/>
        </imageobject>
        <imageobject role="html">
         <imagedata fileref="iscsi_init_service_a.png" width="100%" format="PNG"/>
        </imageobject>
       </mediaobject>
      </informalfigure>
     </step>
     <step>
      <para>
       Under <guimenu>Service Start</guimenu>, specify how you want the
       iSCSI initiator service to be started:
      </para>
      <itemizedlist mark="bullet" spacing="normal">
       <listitem>
        <formalpara>
         <title>When Booting:</title>
         <para>
          The service starts automatically on server restart.
         </para>
        </formalpara>
       </listitem>
       <listitem>
        <formalpara>
         <title>Manually:</title>
         <para>
          (Default) You must start the service manually after a server
          restart by running <command>sudo systemctl start iscsi
          iscsid</command>.
         </para>
        </formalpara>
       </listitem>
      </itemizedlist>
     </step>
     <step>
      <para>
       Specify or verify the <guimenu>Initiator Name</guimenu>.
      </para>
      <para>
       Specify a well-formed iSCSI qualified name (IQN) for the iSCSI
       initiator on this server. The initiator name must be globally unique
       on your network. The IQN uses the following general format:
      </para>
<screen>iqn.yyyy-mm.com.mycompany:n1:n2</screen>
      <para>
       where n1 and n2 are alphanumeric characters. For example:
      </para>
<screen>iqn.1996-04.de.suse:01:a5dfcea717a</screen>
      <para>
       The <guimenu>Initiator Name</guimenu> is automatically completed with
       the corresponding value from the
       <filename>/etc/iscsi/initiatorname.iscsi</filename> file on the
       server.
      </para>
      <para>
       If the server has iBFT (iSCSI Boot Firmware Table) support, the
       <guimenu>Initiator Name</guimenu> is completed with the corresponding
       value in the IBFT, and you are not able to change the initiator name
       in this interface. Use the BIOS Setup to modify it instead. The iBFT
       is a block of information containing various parameters useful to the
       iSCSI boot process, including iSCSI target and initiator descriptions
       for the server.
      </para>
     </step>
     <step>
      <para>
       Use either of the following methods to discover iSCSI targets on the
       network.
      </para>
      <itemizedlist mark="bullet" spacing="normal">
       <listitem>
        <formalpara>
         <title>iSNS:</title>
         <para>
          To use iSNS (Internet Storage Name Service) for discovering iSCSI
          targets, continue with
          <xref linkend="sec.iscsi.initiator.yast.isn" xrefstyle="HeadingOnPage"/>.
         </para>
        </formalpara>
       </listitem>
       <listitem>
        <formalpara>
         <title>Discovered Targets:</title>
         <para>
          To discover iSCSI target devices manually, continue with
          <xref linkend="sec.iscsi.initiator.yast.discovered" xrefstyle="HeadingOnPage"/>.
         </para>
        </formalpara>
       </listitem>
      </itemizedlist>
     </step>
    </procedure>
   </sect3>
   <sect3 xml:id="sec.iscsi.initiator.yast.isn">
    <title>Discovering iSCSI Targets by Using iSNS</title>
    <para>
     Before you can use this option, you must have already installed and
     configured an iSNS server in your environment. For information, see
     <xref linkend="cha.isns" xrefstyle="ChapTitleOnPage"/>.
    </para>
    <procedure>
     <step>
      <para>
       In &yast;, select<guimenu> iSCSI Initiator</guimenu>, then select
       the <guimenu>Service</guimenu> tab.
      </para>
     </step>
     <step>
      <para>
       Specify the IP address of the iSNS server and port. The default port
       is 3205.
      </para>
     </step>
     <step>
      <para>
       Click <guimenu>Finish</guimenu> to save and apply your changes.
      </para>
     </step>
    </procedure>
   </sect3>
   <sect3 xml:id="sec.iscsi.initiator.yast.discovered">
    <title>Discovering iSCSI Targets Manually</title>
    <para>
     Repeat the following process for each of the iSCSI target servers that
     you want to access from the server where you are setting up the iSCSI
     initiator.
    </para>
    <procedure>
     <step>
      <para>
       In &yast;, select<guimenu> iSCSI Initiator</guimenu>, then select
       the <guimenu>Discovered Targets</guimenu> tab.
      </para>
     </step>
     <step>
      <para>
       Click <guimenu>Discovery</guimenu> to open the iSCSI Initiator
       Discovery dialog box.
      </para>
     </step>
     <step>
      <para>
       Enter the IP address and change the port if needed. The default port
       is 3260.
      </para>
     </step>
     <step>
      <para>
       If authentication is required, deselect <guimenu>No
       Authentication</guimenu>, then specify the credentials for
       <guimenu>Incoming</guimenu> or <guimenu>Outgoing</guimenu>
       authentication.
      </para>
     </step>
     <step>
      <para>
       Click <guimenu>Next</guimenu> to start the discovery and connect to
       the iSCSI target server.
      </para>
     </step>
     <step>
      <para>
       If credentials are required, after a successful discovery, use
       <guimenu>Connect</guimenu> to activate the target.
      </para>
      <para>
       You are prompted for authentication credentials to use the selected
       iSCSI target.
      </para>
     </step>
     <step>
      <para>
       Click <guimenu>Next</guimenu> to finish the configuration.
      </para>
      <para>
       The target now appears in <guimenu>Connected Targets</guimenu> and
       the virtual iSCSI device is now available.
      </para>
     </step>
     <step>
      <para>
       Click <guimenu>Finish</guimenu> to save and apply your changes.
      </para>
     </step>
     <step>
      <para>
       You can find the local device path for the iSCSI target device by
       using the <command>lsscsi</command> command.
      </para>
     </step>
    </procedure>
   </sect3>
   <sect3 xml:id="sec.iscsi.initiator.yast.startup">
    <title>Setting the Start-up Preference for iSCSI Target Devices</title>
    <procedure>
     <step>
      <para>
       In &yast;, select<guimenu> iSCSI Initiator</guimenu>, then select
       the <guimenu>Connected Targets</guimenu> tab to view a list of the
       iSCSI target devices that are currently connected to the server.
      </para>
     </step>
     <step>
      <para>
       Select the iSCSI target device that you want to manage.
      </para>
     </step>
     <step>
      <para>
       Click <guimenu>Toggle Start-Up</guimenu> to modify the setting:
      </para>
      <formalpara>
       <title>Automatic:</title>
       <para>
        This option is used for iSCSI targets that are to be connected when
        the iSCSI service itself starts up. This is the typical
        configuration.
       </para>
      </formalpara>
      <formalpara>
       <title>Onboot:</title>
       <para>
        This option is used for iSCSI targets that are to be connected
        during boot; that is, when root (<filename>/</filename>) is on
        iSCSI. As such, the iSCSI target device will be evaluated from the
        initrd on server boots.
       </para>
      </formalpara>
     </step>
     <step>
      <para>
       Click <guimenu>Finish</guimenu> to save and apply your changes.
      </para>
     </step>
    </procedure>
   </sect3>
  </sect2>

  <sect2 xml:id="sec.iscsi.initiator.manually">
   <title>Setting Up the iSCSI Initiator Manually</title>
   <para>
    Both the discovery and the configuration of iSCSI connections require a
    running iscsid. When running the discovery the first time, the internal
    database of the iSCSI initiator is created in the directory
    <filename>/var/lib/open-iscsi</filename>.
   </para>
   <para>
    If your discovery is password protected, provide the authentication
    information to iscsid. Because the internal database does not exist when
    doing the first discovery, it cannot be used at this time. Instead, the
    configuration file <filename>/etc/iscsid.conf</filename> must be edited
    to provide the information. To add your password information for the
    discovery, add the following lines to the end of
    <filename>/etc/iscsid.conf</filename>:
   </para>
<screen>discovery.sendtargets.auth.authmethod = CHAP
discovery.sendtargets.auth.username = <replaceable>username</replaceable>
discovery.sendtargets.auth.password = <replaceable>password</replaceable></screen>
   <para>
    The discovery stores all received values in an internal persistent
    database. In addition, it displays all detected targets. Run this
    discovery with the following command:
   </para>
<screen>sudo iscsiadm <option>-m discovery --type=st --portal=<replaceable>target_ip</replaceable></option>
</screen>
   <para>
    The output should look like the following:
   </para>
<screen>10.44.171.99:3260,1 iqn.2006-02.com.example.iserv:systems</screen>
   <para>
    To discover the available targets on an <literal>iSNS</literal> server,
    use the following command:
   </para>
<screen>sudo iscsiadm --mode discovery --type isns --portal <replaceable>target_ip</replaceable></screen>
   <para>
    For each target defined on the iSCSI target, one line appears. For more
    information about the stored data, see
    <xref linkend="sec.iscsi.initiator.database" xrefstyle="SectTitleOnPage"/>.
   </para>
   <para>
    The special <option>--login</option> option of
    <command>iscsiadm</command> creates all needed devices:
   </para>
<screen>sudo iscsiadm -m node -n iqn.2006-02.com.example.iserv:systems --login</screen>
   <para>
    The newly generated devices show up in the output of
    <command>lsscsi</command> and can now be mounted.
   </para>
  </sect2>

  <sect2 xml:id="sec.iscsi.initiator.database">
   <title>The iSCSI Client Databases</title>
   <para>
    All information that was discovered by the iSCSI initiator is stored in
    two database files that reside in
    <filename>/var/lib/open-iscsi</filename>. There is one database for the
    discovery of targets and one for the discovered nodes. When accessing a
    database, you first must select if you want to get your data from the
    discovery or from the node database. Do this with the <option>-m
    discovery</option> and <option>-m node</option> parameters of
    <command>iscsiadm</command>. Using <command>iscsiadm</command> with one
    of these parameters gives an overview of the stored records:
   </para>
<screen>&prompt.user;sudo iscsiadm -m discovery
10.44.171.99:3260,1 iqn.2006-02.com.example.iserv:systems
</screen>
   <para>
    The target name in this example is
    <literal>iqn.2006-02.com.example.iserv:systems</literal>. This name is
    needed for all actions that relate to this special data set. To examine
    the content of the data record with the ID
    <literal>iqn.2006-02.com.example.iserv:systems</literal>, use the
    following command:
   </para>
<screen>&prompt.user;sudo iscsiadm -m node --targetname iqn.2006-02.com.example.iserv:systems
node.name = iqn.2006-02.com.example.iserv:systems
node.transport_name = tcp
node.tpgt = 1
node.active_conn = 1
node.startup = manual
node.session.initial_cmdsn = 0
node.session.reopen_max = 32
node.session.auth.authmethod = CHAP
node.session.auth.username = joe
node.session.auth.password = ********
node.session.auth.username_in = <replaceable>empty</replaceable>
node.session.auth.password_in = <replaceable>empty</replaceable>
node.session.timeo.replacement_timeout = 0
node.session.err_timeo.abort_timeout = 10
node.session.err_timeo.reset_timeout = 30
node.session.iscsi.InitialR2T = No
node.session.iscsi.ImmediateData = Yes
....</screen>
   <para>
    To edit the value of one of these variables, use the command
    <command>iscsiadm</command> with the <option>update</option> operation.
    For example, if you want iscsid to log in to the iSCSI target when it
    initializes, set the variable <option>node.startup</option> to the value
    <option>automatic</option>:
   </para>
<screen>sudo iscsiadm -m node -n iqn.2006-02.com.example.iserv:systems \
-p ip:port --op=update --name=node.startup --value=automatic</screen>
   <para>
    Remove obsolete data sets with the <literal>delete</literal> operation.
    If the target <literal>iqn.2006-02.com.example.iserv:systems</literal>
    is no longer a valid record, delete this record with the following
    command:
   </para>
<screen>sudo iscsiadm -m node -n iqn.2006-02.com.example.iserv:systems \
-p ip:port --op=delete
</screen>
   <important>
    <para>
     Use this option with caution because it deletes the record without any
     additional confirmation prompt.
    </para>
   </important>
   <para>
    To get a list of all discovered targets, run the <command>sudo iscsiadm
    -m node</command> command.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.iscsi.installation">
  <title>Using iSCSI Disks when Installing</title>

  <para>
   Booting from an iSCSI disk on x86_64 and IBM &power; architectures is
   supported, when iSCSI-enabled firmware is used.
  </para>

  <para>
   To use iSCSI disks during installation, it is necessary to add the
   following parameter to the boot option line:
  </para>

<screen>withiscsi=1</screen>

  <para>
   During installation, an additional screen appears that provides the
   option to attach iSCSI disks to the system and use them in the
   installation process.
  </para>
 </sect1>
  
 <sect1 xml:id="sec.iscsi.unmap">
   <title>Checking iSCSI UNMAP Support</title>
   <remark>toms 2015-09-18: FATE#316345</remark>
   <para>The UNMAP command is used by SCSI to support <link
     xlink:href="http://en.wikipedia.org/wiki/Thin_provisioning">Thin Provisioning</link>.
     It is described in the <link 
       xlink:href="http://www.t10.org/cgi-bin/ac.pl?t=f&amp;f=sbc3r29.pdf">SBC-3 document, revision 29</link>.</para>
    <para>The UNMAP command allows a SCSI target to present a virtual
      disk interface, where each front-end virtual disk block may or may
      not be mapped to a real physical disk block. (This also works for
      tape, but that does not matter here.)</para>
    <para>Using this methodology, a target can for example present a 1
      TByte disk, but it may start out with only 10 GByte of real
      storage. The first time the system writes to any block on the
      front-end of this disk, a real back-end disk block is allocated and
      then written to. The disk intelligence keeps track of which
      front-end blocks are connected to back-end blocks (i.e. are
      already allocated).</para>
    <para>In such a case, the disk is usually created with each and
      every block being marked as <quote>deallocated</quote>, for
      example, not being mapped to a real physical block.</para>
   <para>As each disk block is used, it is marked as being <quote>allocated</quote>.</para>
    <para>There are two ways to deallocate a block once it has been
      used. The first way is the <command>SCSI WRITE_SAME</command>
      command, and the second is the SCSI UNMAP command.</para>
    <para>This section focuses on testing the SCSI UNMAP command. It
      might also be beneficial to test the WRITE_SAME command.</para>

   <sect2>
     <title>Requirements</title>
     <para>You need:</para>
     <itemizedlist>
       <listitem>
          <para>an iSCSI target (the TUT, target under test), running on
            a Linux host</para>
       </listitem>
       <listitem>
         <para>The open-iscsi initiator installed on that host</para>
       </listitem>
       <listitem>
         <para>the sg3 tools</para>
       </listitem>
     </itemizedlist>
   </sect2>
   
   <sect2>
     <title>Target Setup</title>
     <para>In order to work with UNMAP, do the following as target setup:</para>
     <procedure>
       <step>
         <para>Install the <package>tgt</package> package:</para>
         <screen>&prompt.root;<command>zypper</command> in tgt</screen>
       </step>
       <step>
          <para>Change the configuration file
              <filename>/etc/tgt/targets.conf</filename> to:</para>
         <screen>default-driver iscsi
ignore-errors yes
include /etc/tgt/conf.d/*.conf</screen>
       </step>
       <step>
          <para>Create the file <filename>/etc/tgt/test.conf</filename>
            with the following content:</para>
         <screen>&lt;target iqn.2001-04.net.gonzoleeman:test.disk.laptop.002>
    backing-store /alt2/big_disc_file.tgt
    vendor_id LeeMan
    thin_provisioning 1
&lt;/target></screen>
          <para>Note the <literal>thin_provisioning</literal> line which
            is required to enable support for the UNAMP command.</para>
          <remark>lee 2015-09-18: Also NOTE that this file is on an ext4
            filesystem. I am not sure if this matters.</remark>
       </step>
       <step>
         <para>Set up the back-end file <filename>/alt/big_disc_file.tgt</filename>
         with the <command>tgtimg</command> command:</para>
         <screen>&prompt.root;<command>tgtimg</command> --op new --device-type disk --type disk \
       --size 1G --file /alt2/big_disc_file.tgt</screen>
       </step>
       <step>
         <para>Start the back-end target daemon:</para>
         <screen>&prompt.root;<command>rcrgtd</command> start</screen>
       </step>
       <step>
         <para>Make sure there were no error message on the command line or in
         <filename>/var/log/messages</filename>.
           <remark>toms 2015-09-18: Does it really write to /var/log/messages or
           is systemd used?</remark>
         </para>
       </step>
     </procedure>
   </sect2>
   
   <sect2>
     <title>Initiator Setup</title>
     <para>In order to work with UNMAP, do the following as initiator setup:</para>
     <procedure>
       <step>
         <para>Install the latest <package>open-iscsi</package> package:</para>
         <screen>&prompt.root;<command>zypper</command> in open-iscsi</screen>
       </step>
       <step>
         <para>Use &systemd; to start all the relevant services:</para>
         <screen>&prompt.root;<command>systemctl</command> start iscsid.socket
&prompt.root;<command>systemctl</command> start iscsid.service
&prompt.root;<command>systemctl</command> start iscsi.service</screen>
       </step>
       <step>
         <para>Verify if the <package>sg3</package> package is installed.</para>
       </step>
     </procedure>
   </sect2>
   
   <sect2>
     <title>Connecting Initiator to Target</title>
     <para></para>
     <screen>&prompt.root;<command>iscsiadm</command> -m discovery -t st -p 192.168.20.2 -I default -l
...
192.168.20.2:3260,1 iqn.2001-04.net.gonzoleeman:test.disk.laptop.002
Logging in to [iface: default, target: iqn.2001-04.net.gonzoleeman:test.disk.laptop.002, portal: 192.168.20.2,3260] (multiple)
Login to [iface: default, target: iqn.2001-04.net.gonzoleeman:test.disk.laptop.002, portal: 192.168.20.2,3260] successful.
&prompt.root;<command>ls</command> /dev/sd?
/dev/sda  /dev/sdb  /dev/sdc</screen>
      <para>Assuming, <filename>/dev/sdc</filename> was added, verify it
        with <command>sg_inq</command>:</para>
     <screen>&prompt.root;<command>sg_inq</command> /dev/sdc
standard INQUIRY:
  PQual=0  Device_type=0  RMB=0  version=0x05  [SPC-3]
  [AERC=0]  [TrmTsk=1]  NormACA=0  HiSUP=0  Resp_data_format=2
  SCCS=0  ACC=0  TPGS=0  3PC=0  Protect=0  [BQue=0]
  EncServ=0  MultiP=0  [MChngr=0]  [ACKREQQ=0]  Addr16=0
  [RelAdr=0]  WBus16=0  Sync=0  Linked=0  [TranDis=0]  CmdQue=1
  [SPI: Clocking=0x0  QAS=0  IUS=0]
    length=66 (0x42)   Peripheral device type: disk
 Vendor identification: LeeMan
 Product identification: VIRTUAL-DISK
 Product revision level: 0001
 Unit serial number:                               beaf11</screen>
   </sect2>
   
   <sect2>
     <title>Testing the SCSI UNMAP Command</title>
      <para>In order to test the UNMAP command, the following steps are
        necessary:</para>
     <procedure>
       <step>
          <para><xref linkend="sec.iscsi.unmap.verify"
              xrefstyle="select:title nopage"/>, using <command>sq_vpd</command></para>
       </step>
       <step>
         <para><xref linkend="sec.iscsi.unmap.writeblock"
           xrefstyle="select:title nopage"/>, using <command>dd</command></para>
       </step>
       <step>
         <para><xref linkend="sec.iscsi.unmap.verifyblockmapped"
           xrefstyle="select:title nopage"/>, using <command>sq_get_lba_status</command>
         </para>
       </step>
       <step>
         <para><xref linkend="sec.iscsi.unmap.unmapblock"
           xrefstyle="select:title nopage"/>, using <command>sg_unmap</command></para>
       </step>
       <step>
         <para><xref linkend="sec.iscsi.unmap.verifyunmap"
           xrefstyle="select:title nopage"/>, using <command>sg_get_lba_status</command></para>
       </step>
     </procedure>
     
     <sect3 xml:id="sec.iscsi.unmap.verify">
       <title>Verify that UNMAP is supported</title>
       <para>Verify that the UNMAP is supported with <command>sg_vpd</command>:</para>
       <screen>&prompt.root;<command>sg_vpd</command> -p 0xb2 /dev/sdc
Logical block provisioning VPD page (SBC):
  Unmap command supported (LBPU): 1
  Write same (16) with unmap bit supported (LBWS): 1
  Write same (10) with unmap bit supported (LBWS10): 1
  Logical block provisioning read zeros (LBPRZ): 1
  Anchored LBAs supported (ANC_SUP): 0
  Threshold exponent: 0
  Descriptor present (DP): 0
  Provisioning type: 2</screen>
       <para>Notice that <literal>Unmap command supported</literal> is "1".</para>
        <para>Some SCSI targets do not even display this page, in which
          case you might see:</para>
       <screen>&prompt.root;<command>sg_vpd</command> -p 0xb2 /dev/sdc
VPD page=0xb2
fetching VPD page failed</screen>
     </sect3>
     
     <sect3 xml:id="sec.iscsi.unmap.writeblock">
       <title>Write to a Block</title>
       <para>Write to a block to make sure it is mapped:</para>
       <screen>&prompt.root;<command>dd</command> if=/dev/zero of=/dev/sdc seek=1024 count=8
8+0 records in
8+0 records out
4096 bytes (4.1 kB) copied, 0.000830997 s, 4.9 MB/s</screen>
        <para>This writes 4k (8192 512-byte blocks) bytes of zeros to
          our thin-provisioned iSCSI target to an offset of 524288 byte
          (1024 512-byte blocks).</para>
     </sect3>
     
     <sect3 xml:id="sec.iscsi.unmap.verifyblockmapped">
       <title>Verify the Block is Mapped</title>
       <para>Verify that blocks got allocated (mapped):</para>
       <screen>&prompt.root;<command>sg_get_lba_status</command> -l 1024 /dev/sdc
descriptor LBA: 0x0000000000000400  blocks: 16776192  mapped</screen>
        <para>Note that the number of blocks that actually gets mapped
          or unmapped at a time is up to the target. In this case, it
          looks like our target allocated about 16 MBytes.</para>
     </sect3>
     
     <sect3 xml:id="sec.iscsi.unmap.unmapblock">
       <title>Unmap the Block</title>
       <para>Unmap the block with:</para>
       <screen>&prompt.root;<command>sg_unmap</command> -v -l 1024 -n 8 /dev/sdc 
    unmap cdb: 42 00 00 00 00 00 00 00 18 00</screen>
     </sect3>
     
     <sect3 xml:id="sec.iscsi.unmap.verifyunmap">
       <title>Verify that UNMAP Works</title>
       <para>Finally, check again to see if the block has been unmapped:</para>
       <screen>&prompt.root;<command>sg_get_lba_status</command> -l 1024 /dev/sdc
descriptor LBA: 0x0000000000000400  blocks: 8  deallocated</screen>
       <para>This shows that our target passes.</para>
        <para>Notice that our target just deallocated the 8 blocks we
          specified. If we check eight blocks further (not needed for the
          test, but interesting), we see that much of the
          earlier-allocated chunk is still there:</para>
       <screen>&prompt.root;<command>sg_get_lba_status</command> -l 1032 /dev/sdc
descriptor LBA: 0x0000000000000408  blocks: 16776184  mapped</screen>
     </sect3>
   </sect2>
 </sect1> 
 
 <sect1 xml:id="sec.iscsi.trouble">
  <title>Troubleshooting iSCSI</title>

  <para>
   This section describes some known issues and possible solutions for iSCSI
   target and iSCSI initiator issues.
  </para>

  <sect2 xml:id="sec.iscsi.trouble.no_service">
   <title>Portal Error When Setting Up Target LUNs on an iSCSI LIO Target Server</title>
   <para>
    When adding or editing an iSCSI LIO target group, you get an error:
   </para>
<screen>Problem setting network portal <replaceable>ip_address</replaceable>:3260</screen>
   <para>
    The <filename>/var/log/YasT2/y2log</filename> log file contains the
    following error:
   </para>
<screen>find: `/sys/kernel/config/target/iscsi': No such file or directory</screen>
   <para>
    This problem occurs if the iSCSI LIO Target Server software is not
    currently running. To resolve this issue, exit &yast;, manually start
    iSCSI LIO at the command line with <command>systemctl start
    target</command>, then try again.
   </para>
   <para>
    You can also enter the following to check if
    <command>configfs</command>, <command>iscsi_target_mod</command>, and
    <command>target_core_mod</command> are loaded. A sample response is
    shown.
   </para>
<screen>&prompt.user;sudo lsmod | grep iscsi
iscsi_target_mod      295015  0
target_core_mod       346745  4
iscsi_target_mod,target_core_pscsi,target_core_iblock,target_core_file
configfs               35817  3 iscsi_target_mod,target_core_mod
scsi_mod              231620  16
iscsi_target_mod,target_core_pscsi,target_core_mod,sg,sr_mod,mptctl,sd_mod,
scsi_dh_rdac,scsi_dh_emc,scsi_dh_alua,scsi_dh_hp_sw,scsi_dh,libata,mptspi,
mptscsih,scsi_transport_spi</screen>
  </sect2>

  <sect2 xml:id="sec.iscsi.trouble.not_visible">
   <title>iSCSI LIO Targets Are Not Visible from Other Computers</title>
   <para>
    If you use a firewall on the target server, you must open the iSCSI port
    that you are using to allow other computers to see the iSCSI LIO
    targets. For information, see <xref linkend="sec.iscsi.target.start"/>.
   </para>
  </sect2>

  <sect2 xml:id="sec.iscsi.trouble.package_loss">
   <title>Data Packets Dropped for iSCSI Traffic</title>
   <para>
    A firewall might drop packets if it gets too busy. The default for the
    SUSE Firewall is to drop packets after three minutes. If you find that
    iSCSI traffic packets are being dropped, you can consider configuring
    the SUSE Firewall to queue packets instead of dropping them when it gets
    too busy.
   </para>
  </sect2>

  <sect2 xml:id="sec.iscsi.trouble.lvm">
   <title>Using iSCSI Volumes with LVM</title>
   <para>
    Use the troubleshooting tips in this section when using LVM on iSCSI
    targets.
   </para>
   <sect3 xml:id="sec.iscsi.trouble.lvm.boot_initiator">
    <title>Check if the iSCSI Initiator Discovery Occurs at Boot</title>
    <para>
     When you set up the iSCSI Initiator, ensure that you enable discovery
     at boot time so that udev can discover the iSCSI devices at boot time
     and set up the devices to be used by LVM.
    </para>
   </sect3>
   <sect3 xml:id="sec.iscsi.trouble.lvm.boot_target">
    <title>Check that iSCSI Target Discovery Occurs at Boot</title>
    <para>
     Remember that <filename>udev</filename> provides the default setup for
     devices. Ensure that all of the applications that create devices are
     started at boot time so that <command>udev</command> can recognize and
     assign devices for them at system start-up. If the application or
     service is not started until later, <command>udev</command> does not
     create the device automatically as it would at boot time.
    </para>
   </sect3>
  </sect2>

  <sect2 xml:id="sec.iscsi.trouble.mount">
   <title>iSCSI Targets Are Mounted When the Configuration File Is Set to Manual</title>
   <para>
    When Open-iSCSI starts, it can mount the targets even if the
    <literal>node.startup</literal> option is set to manual in the
    <filename>/etc/iscsi/iscsid.conf</filename> file if you manually
    modified the configuration file.
   </para>
   <para>
    Check the
    <filename>/etc/iscsi/nodes/<replaceable>target_name</replaceable>/<replaceable>ip_address</replaceable>,<replaceable>port</replaceable>/default</filename>
    file. It contains a <literal>node.startup</literal> setting that
    overrides the <filename>/etc/iscsi/iscsid.conf</filename> file. Setting
    the mount option to manual by using the &yast; interface also sets
    <literal>node.startup = manual</literal> in the
    <filename>/etc/iscsi/nodes/<replaceable>target_name</replaceable>/<replaceable>ip_address</replaceable>,<replaceable>port</replaceable>/default
    </filename>files.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.iscsi.terminology">
  <title>iSCSI LIO Target Terminology</title>

  <variablelist>
   <varlistentry>
    <term>backstore</term>
    <listitem>
     <para>
      A physical storage object that provides the actual storage underlying
      an iSCSI endpoint.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>CDB (command descriptor block)</term>
    <listitem>
     <para>
      The standard format for SCSI commands. CDBs are commonly 6, 10, or 12
      bytes long, though they can be 16 bytes or of variable length.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>CHAP (Challenge Handshake Authentication Protocol)</term>
    <listitem>
     <para>
      A point-to-point protocol (PPP) authentication method used to confirm
      the identity of one computer to another. After the Link Control
      Protocol (LCP) connects the two computers, and the CHAP method is
      negotiated, the authenticator sends a random Challenge to the peer.
      The peer issues a cryptographically hashed Response that depends upon
      the Challenge and a secret key. The authenticator verifies the hashed
      Response against its own calculation of the expected hash value, and
      either acknowledges the authentication or terminates the connection.
      CHAP is defined in the RFC 1994.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>CID (connection identifier)</term>
    <listitem>
     <para>
      A 16bit number, generated by the initiator, that uniquely
      identifies a connection between two iSCSI devices. This number is
      presented during the login phase.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>endpoint</term>
    <listitem>
     <para>
      The combination of an iSCSI Target Name with an iSCSI TPG (IQN + Tag).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>EUI (extended unique identifier)</term>
    <listitem>
     <para>
      A 64bit number that uniquely identifies every device in the world.
      The format consists of 24 bits that are unique to a given company, and
      40 bits assigned by the company to each device it builds.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>initiator</term>
    <listitem>
     <para>
      The originating end of an SCSI session. Typically a controlling device
      such as a computer.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>IPS (Internet Protocol storage)</term>
    <listitem>
     <para>
      The class of protocols or devices that use the IP protocol to move
      data in a storage network. FCIP (Fibre Channel over Internet
      Protocol), iFCP (Internet Fibre Channel Protocol), and iSCSI (Internet
      SCSI) are all examples of IPS protocols.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>IQN (iSCSI qualified name)</term>
    <listitem>
     <para>
      A name format for iSCSI that uniquely identifies every device in the
      world (for example:
      <filename>iqn.5886.com.acme.tapedrive.sna12345678</filename>).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>ISID (initiator session identifier)</term>
    <listitem>
     <para>
      A 48bit number, generated by the initiator, that uniquely
      identifies a session between the initiator and the target. This value
      is created during the login process, and is sent to the target with a
      Login PDU.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>MCS (multiple connections per session)</term>
    <listitem>
     <para>
      A part of the iSCSI specification that allows multiple TCP/IP
      connections between an initiator and a target.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>MPIO (multipath I/O)</term>
    <listitem>
     <para>
      A method by which data can take multiple redundant paths between a
      server and storage.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>network portal</term>
    <listitem>
     <para>
      The combination of an iSCSI endpoint with an IP address plus a TCP
      (Transmission Control Protocol) port. TCP port 3260 is the port number
      for the iSCSI protocol, as defined by IANA (Internet Assigned Numbers
      Authority).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>SAM (SCSI architectural model)</term>
    <listitem>
     <para>
      A document that describes the behavior of SCSI in general terms,
      allowing for different types of devices communicating over various
      media.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>target</term>
    <listitem>
     <para>
      The receiving end of an SCSI session, typically a device such as a
      disk drive, tape drive, or scanner.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>target group (TG)</term>
    <listitem>
     <para>
      A list of SCSI target ports that are all treated the same when
      creating views. Creating a view can help facilitate LUN (logical unit
      number) mapping. Each view entry specifies a target group, host group,
      and a LUN.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>target port</term>
    <listitem>
     <para>
      The combination of an iSCSI endpoint with one or more LUNs.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>target port group (TPG)</term>
    <listitem>
     <para>
      A list of IP addresses and TCP port numbers that determines which
      interfaces a specific iSCSI target will listen to.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>target session identifier (TSID)</term>
    <listitem>
     <para>
      A 16bit number, generated by the target, that uniquely identifies a
      session between the initiator and the target. This value is created
      during the login process, and is sent to the initiator with a Login
      Response PDU (protocol data units).
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec.iscsi.info">
  <title>Additional Information</title>

  <para>
   The iSCSI protocol has been available for several years. There are many
   reviews comparing iSCSI with SAN solutions, benchmarking performance, and
   there also is documentation describing hardware solutions. Important
   pages for more information about open-iscsi are:
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     <citetitle>Open-iSCSI Project</citetitle>
     (<link xlink:href="http://www.open-iscsi.org/"/>)
    </para>
   </listitem>
   <listitem>
    <para>
     <citetitle>AppNote: iFolder on Open Enterprise Server Linux Cluster
     using iSCSI</citetitle>
     (<link xlink:href="http://www.novell.com/coolsolutions/appnote/15394.html"/>)
    </para>
   </listitem>
  </itemizedlist>

  <para>
   There is also some online documentation available. See the man pages for
   <command>iscsiadm</command>, <command>iscsid</command>,
   <filename>ietd.conf</filename>, and <command>ietd</command> and the
   example configuration file <filename>/etc/iscsid.conf</filename>.
  </para>
 </sect1>
</chapter>
