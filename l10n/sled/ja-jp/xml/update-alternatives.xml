<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook51-profile.xsl"
                 type="text/xml"
                 title="Profiling step"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="update-alternatives.xml" version="5.1" xml:id="cha-update-alternative">
 <title><command>update-alternatives</command>: 複数のバージョンのコマンドとファイルの管理</title>
 <info>
  <abstract>
   <para>
    システムに同じツールの複数のバージョンがインストールされていることがよくあります。管理者に選択肢を提供し、異なる複数のバージョンを並行してインストールして使用できるようにするために、alternativesシステムでは、このような複数のバージョンを一貫性を持って管理することができます。
   </para>
  </abstract>
 <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>

  <sect1 xml:id="sec-ua-concept">
   <title>概要</title>
   <para>
    <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase>では、一部のプログラムが同じまたは類似のタスクを実行します。たとえば、Java 1.7とJava 1.8が両方ともシステムにインストールされている場合、alternativesシステムスクリプト(<command>update-alternatives</command>)がRPMパッケージ内から呼び出されます。デフォルトでは、alternativesシステムはバージョン1.8を指し示します。上位バージョンの優先度が高くなります。ただし、管理者はデフォルトを変更することができ、汎用名としてバージョン1.7を指すことができます。
   </para>
   <para>
    この章では、以下の用語を使用します。
   </para>
   <variablelist>
    <title>用語集</title>
    <varlistentry>
     <term>管理ディレクトリ</term>
     <listitem>
      <para>
       デフォルトの<filename class="directory">/var/lib/rpm/alternatives</filename>ディレクトリには、alternativesの現在の状態に関する情報が含まれています。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>代わりとなる製品</term>
     <listitem>
      <para>
       ファイルシステム内の特定のファイルの名前。alternativesシステムを使用して汎用名でアクセス可能にすることができます。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>alternativesディレクトリ</term>
     <listitem>
      <para>
       シンボリックリンクを含むデフォルトの<filename class="directory">/etc/alternatives</filename>ディレクトリ。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>汎用名</term>
     <listitem>
      <para>
       alternativesシステムを使用して使用可能な複数のファイルのうちの1つを指し示す名前(たとえば、<command>/usr/bin/edit</command>)。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>リンクグループ</term>
     <listitem>
      <para>
       グループとして更新できる関連するシンボリックリンクのセット。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>マスタリンク</term>
     <listitem>
      <para>
       グループ内の他のリンクの設定方法を決定するリンクグループ内のリンク。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>スレーブリンク</term>
     <listitem>
      <para>
       マスタリンクによって制御されるリンクグループ内のリンク。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>シンボリックリンク(Symlink)</term>
     <listitem>
      <para>
       同じファイルシステム内の別のファイルへの参照となるファイル。alternativesシステムは、alternativesディレクトリ内のシンボリックリンクを使用して、ファイルのバージョンを切り替えます。
      </para>
      <para>
       alternativesディレクトリ内のシンボリックリンクは、<command>update-alternatives</command>コマンドによって管理者が変更できます。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <para>
    alternativesシステムは、シンボリックリンクに関する情報を作成、削除、維持、および表示するための<command>update-alternatives</command>コマンドを提供します。これらのシンボリックリンクは、通常、コマンドを指しますが、JARアーカイブ、マニュアルページ、およびその他のファイルを指すこともできます。この章の例では、コマンドとマニュアルページを使用しますが、他のファイルタイプにも適用できます。
   </para>
   <para>
    alternativesシステムはalternativesディレクトリを使用して、使用可能なalternativesへのリンクを収集します。alternativeを含む新しいパッケージがインストールされると、新しいalternativeがシステムに追加されます。新しいパッケージのalternativeがデフォルトとして選択されるかどうかは、その優先順位と設定されたモードに依存します。通常は、上位バージョンのパッケージの優先度が高くなります。alternativesシステムは、次の2つのモードで動作することができます。
   </para>
   <itemizedlist>
    <listitem>
     <formalpara>
      <title>自動モード</title>
      <para>
       このモードでは、alternativesシステムによって、グループ内のリンクが、グループに適した最優先のalternativesを確実に指し示すようになります。
      </para>
     </formalpara>
    </listitem>
    <listitem>
     <formalpara>
      <title>手動モード</title>
      <para>
       このモードでは、alternativesシステムによって、システム管理者の設定は変更されません。
      </para>
     </formalpara>
    </listitem>
   </itemizedlist>
   <para>
    たとえば、<command>java</command>コマンドのalternativesシステムでのリンク階層は次のようになっています。
   </para>
   <example>
    <title><command>java</command>コマンドのalternativesシステム</title>
    <screen>/usr/bin/java <co xml:id="co-ua-java-name"/>
 -&gt; /etc/alternatives/java <co xml:id="co-ua-java-symbolic-link"/>
     -&gt; /usr/lib64/jvm/jre-10-openjdk/bin/java <co xml:id="co-ua-java-alternatives"/></screen>
    
    <calloutlist>
     <callout arearefs="co-ua-java-name">
      <para>
       汎用名。
      </para>
     </callout>
     <callout arearefs="co-ua-java-symbolic-link">
      <para>
       alternativesディレクトリ内のシンボリックリンク。
      </para>
     </callout>
     <callout arearefs="co-ua-java-alternatives">
      <para>
       alternativesの1つ。
      </para>
     </callout>
    </calloutlist>
   </example>
  </sect1>

  <sect1 xml:id="sec-ua-use-cases">
   <title>使用例</title>
   <para>
    デフォルトでは、<command>update-alternatives</command>スクリプトはRPMパッケージ内から呼び出されます。あるパッケージがインストールまたは削除されると、このスクリプトはそのすべてのシンボリックリンクに対処します。ただし、以下の操作についてはコマンドラインから手動で実行することができます。
   </para>
   <itemizedlist>
    <listitem>
     <para>
      汎用名に対する現在のalternativesを表示する。
     </para>
    </listitem>
    <listitem>
     <para>
      alternativeのデフォルトを変更する。
     </para>
    </listitem>
    <listitem>
     <para>
     alternativeの関連ファイルのセットを作成する。
     </para>
    </listitem>
   </itemizedlist>
  </sect1>

  <sect1 xml:id="sec-ua-view-all">
   <title>alternativesの概要の取得</title>
   <para>
    すべての設定済みのalternativesの名前を取得するには、次を使用します。
   </para>
 <screen><prompt>&gt; </prompt><command>ls /var/lib/alternatives</command></screen>
   <para>
    すべての設定済みのalternativesの概要およびその値を取得するには、次を使用します
   </para>
   <screen><prompt>&gt; </prompt><command>sudo</command> <command>update-alternatives --get-selections</command>
asadmin                        auto     /usr/bin/asadmin-2.7
awk                            auto     /usr/bin/gawk
chardetect                     auto     /usr/bin/chardetect-3.6
dbus-launch                    auto     /usr/bin/dbus-launch.x11
default-displaymanager         auto     /usr/lib/X11/displaymanagers/gdm
[...]</screen>
  </sect1>

  <sect1 xml:id="sec-ua-view">
   <title>特定のalternativesに関する詳細の表示</title>
   <para>
    alternativesを確認する最も簡単な方法は、コマンドのシンボリックリンクをたどることです。たとえば、<command>java</command>コマンドが何を参照しているか知りたい場合は、次のコマンドを使用します。
   </para>
   <screen><prompt>&gt; </prompt><command>readlink --canonicalize /usr/bin/java</command>
/usr/lib64/jvm/jre-10-openjdk/bin/java</screen>
   <para>
    同じパスが表示されている場合(この例では、<filename>/usr/bin/java</filename>)、このコマンドに対して使用可能なalternativesはありません。
   </para>
   
   <para>
    すべてのalternatives(スレーブを含む)を表示するには、<option>--display</option>オプションを使用します。
   </para>
   <screen><prompt>&gt; </prompt><command>sudo</command> <command>update-alternatives --display java</command>
java - auto mode
  link best version is /usr/lib64/jvm/jre-1.8.0-openjdk/bin/java
  link currently points to /usr/lib64/jvm/jre-1.8.0-openjdk/bin/java
  link java is /usr/bin/java
  slave java.1.gz is /usr/share/man/man1/java.1.gz
  slave jre is /usr/lib64/jvm/jre
  slave jre_exports is /usr/lib64/jvm-exports/jre
  slave keytool is /usr/bin/keytool
  slave keytool.1.gz is /usr/share/man/man1/keytool.1.gz
  slave orbd is /usr/bin/orbd
  slave orbd.1.gz is /usr/share/man/man1/orbd.1.gz
[...]</screen>
  </sect1>

  <sect1 xml:id="sec-ua-set">
   <title>alternativesのデフォルトバージョンの設定</title>
   <para>
    デフォルトでは、<filename>/usr/bin</filename>のコマンドは、優先順位が最も高いalternativesディレクトリを参照します。たとえば、デフォルトでは、コマンド<command>java</command>に対して次のバージョン番号が表示されます。
   </para>
   <screen><prompt>&gt; </prompt><command>java -version</command>
openjdk version "10.0.1" 2018-04-17
OpenJDK Runtime Environment (build 10.0.1+10-suse-lp150.1.11-x8664)
OpenJDK 64-Bit Server VM (build 10.0.1+10-suse-lp150.1.11-x8664, mixed mode)</screen>
   <para>
    デフォルトの<command>java</command>コマンドを変更して前のバージョンを参照するには、次のコマンドを実行します。
   </para>
   <screen><prompt>&gt; </prompt><command>sudo</command> <command>update-alternatives --config java</command>
root's password:
There are 2 choices for the alternative java (providing /usr/bin/java).

  Selection    Path                                       Priority   Status
------------------------------------------------------------
* 0            /usr/lib64/jvm/jre-10-openjdk/bin/java      2005      auto mode
  1            /usr/lib64/jvm/jre-1.8.0-openjdk/bin/java   1805      manual mode
  2            /usr/lib64/jvm/jre-10-openjdk/bin/java      2005      manual mode
  3            /usr/lib64/jvm/jre-11-openjdk/bin/java      0         manual mode

Press &lt;enter&gt; to keep the current choice[*], or type selection number:</screen>
   <para>
    システムおよびインストールされているバージョンに応じて、正確なJavaバージョン番号は変わります。<literal>1</literal>を選択すると、<command>java</command>に対して次のバージョン番号が表示されます。
   </para>
   <screen><prompt>&gt; </prompt><command>java -version</command>
java version "1.8.0_171"
OpenJDK Runtime Environment (IcedTea 3.8.0) (build 1.8.0_171-b11 suse-lp150.2.3.1-x86_64)
OpenJDK 64-Bit Server VM (build 25.171-b11, mixed mode)</screen>
   <para>
    また、次の点に注意してください。
   </para>
   <itemizedlist>
    <listitem>
     <para>
      手動モードを使用して、別のJavaバージョンをインストールする場合、alternativesシステムはリンクに触れず、汎用名も変更しません。
     </para>
    </listitem>
    <listitem>
     <para>
      自動モードを使用して、別のJavaバージョンをインストールする場合、alternativesシステムはJavaマスタリンクとすべてのスレーブリンクを変更します(<xref linkend="sec-ua-view"/>を参照)。マスタ-スレーブの関係を確認するには、次のコマンドを使用します。
     </para>
     <screen><prompt>&gt; </prompt><command>sudo</command> <command>update-alternatives --display java</command></screen>
    </listitem>
   </itemizedlist>
  </sect1>

  <sect1 xml:id="sec-ua-install">
   <title>カスタムalternativesのインストール</title>
   <para>
    このセクションでは、システムでカスタムalternativesを設定する方法について説明します。この例には、以下の前提があります。
   </para>
   <itemizedlist>
    <listitem>
     <para>
      同様の機能を備えた<command>foo-2</command>と<command>foo-3</command>という2つのスクリプトがあります。
     </para>
    </listitem>
    <listitem>
     <para>
      これらのスクリプトは、<filename>/usr/bin</filename>内のシステムツールとの競合を避けるために、<filename>/usr/local/bin</filename>ディレクトリに保存されています。
     </para>
    </listitem>
    <listitem>
     <para>
      <command>foo-2</command>または<command>foo-3</command>のいずれかを指し示すマスタリンク<command>foo</command>があります。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    使用しているシステムにalternativesを用意するには、次の手順を実行します。
   </para>
   <procedure>
    <step>
     <para>
      スクリプトを<filename>/usr/local/bin</filename>ディレクトリにコピーします。
     </para>
    </step>
    <step>
     <para>
      スクリプトを実行可能にします。
     </para>
     <screen><prompt>&gt; </prompt><command>sudo</command> <command>chmod +x /usr/local/bin/foo-{2,3}</command></screen>
    </step>
    <step>
     <para>
      両方のスクリプトに対して<command>update-alternatives</command>を実行します。
     </para>
     <screen><prompt>&gt; </prompt><command>sudo</command> update-alternatives --install \
   /usr/local/bin/foo <co xml:id="co-ua-ua-install-usr-local-bin-foo"/>\
   foo <co xml:id="co-ua-ua-install-foo"/>\
   /usr/local/bin/foo-2 <co xml:id="co-ua-ua-install-usr-local-bin-foo-path"/>\
   200 <co xml:id="co-ua-ua-install-prio"/>
<prompt>&gt; </prompt><command>sudo</command> update-alternatives --install \
   /usr/local/bin/foo <xref linkend="co-ua-ua-install-usr-local-bin-foo"/>\
   foo <xref linkend="co-ua-ua-install-foo"/>\
   /usr/local/bin/foo-3 <xref linkend="co-ua-ua-install-usr-local-bin-foo-path"/>\
   300 <xref linkend="co-ua-ua-install-prio"/></screen>
     <para>
      <option>--install</option>の後のオプションには、次の意味があります。
     </para>
     <calloutlist>
      <callout arearefs="co-ua-ua-install-usr-local-bin-foo">
       <para>
        汎用名。混乱を避けるため、これは通常、バージョン番号のないスクリプト名です。
       </para>
      </callout>
      <callout arearefs="co-ua-ua-install-foo">
       <para>
        マスタリンクの名前。同じである必要があります。
       </para>
      </callout>
      <callout arearefs="co-ua-ua-install-usr-local-bin-foo-path">
       <para>
        <filename>/usr/local/bin</filename>にある元のスクリプトへのパス。
       </para>
      </callout>
      <callout arearefs="co-ua-ua-install-prio">
       <para>
        優先度。<command>foo-2</command>に、<command>foo-3</command>よりも低い優先度を与えます。意味のある数値の増加を使用して、優先度を分けることをお勧めします。たとえば、<command>foo-2</command>の優先度を200、<command>foo-3</command>の優先度を300にします。
       </para>
      </callout>
     </calloutlist>
    </step>
    <step>
     <para>
      マスタリンクを確認します。
     </para>
     <screen><prompt>&gt; </prompt><command>sudo</command> <command>update-alternatives --display foo</command>
foo - auto mode
  link best version is /usr/local/bin/foo-3
  link currently points to /usr/local/bin/foo-3
  link foo is /usr/local/bin/foo
/usr/local/bin/foo-2 - priority 200
/usr/local/bin/foo-3 - priority 300</screen>
    </step>
   </procedure>
   <para>
    上記の手順を完了したら、マスタリンク<command>/usr/local/bin/foo</command>を使用できます。
   </para>
   <para>
    必要に応じて、追加のalternativesをインストールすることもできます。alternativeを削除するには、次のコマンドを使用します。
   </para>
   <screen><prompt>&gt; </prompt><command>sudo</command> <command>update-alternatives --remove foo /usr/local/bin/foo-2</command></screen>
   <para>
    このスクリプトが削除されると、fooグループのalternativesシステムは次のようになります。
   </para>
   <screen><prompt>&gt; </prompt><command>sudo</command> <command>update-alternatives --display foo</command>
foo - auto mode
  link best version is /usr/local/bin/foo-3
  link currently points to /usr/local/bin/foo-3
  link foo is /usr/local/bin/foo
/usr/local/bin/foo-3 - priority 300</screen>
  </sect1>

  <sect1 xml:id="sec-ua-slave">
   <title>依存するalternativesの定義</title>
   <para>
    alternativesがあっても、スクリプト自体は十分なものではありません。ほとんどのコマンドは、完全にスタンドアロンというわけではありません。通常、これらのコマンドには、拡張機能、設定、マニュアルページなどの追加ファイルが付属しています。マスタリンクに依存するalternativesを作成するには、<emphasis>スレーブalternatives</emphasis>を使用します。
   </para>
   <para>
    <xref linkend="sec-ua-install"/>の例を拡張し、次のマニュアルページと環境設定ファイルを用意すると仮定します。
   </para>
   <itemizedlist>
    <listitem>
     <para>
      <filename>/usr/local/man/man1</filename>ディレクトリに格納された2つのマニュアルページ(<filename>foo-2.1.gz</filename>および<filename>foo-3.1.gz</filename>)。
     </para>
    </listitem>
    <listitem>
     <para>
      <filename>/etc</filename>に格納された2つの環境設定ファイル(<filename>foo-2.conf</filename>および<filename>foo-3.conf</filename>)。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    以下の手順に従って、alternativesに追加ファイルを追加します。
   </para>
   <procedure>
    <step>
     <para>
      環境設定ファイルを<filename>/etc</filename>にコピーします。
     </para>
     <screen><prompt>&gt; </prompt><command>sudo</command> <command>cp foo-{2,3}.conf /etc</command></screen>
    </step>
    <step>
     <para>
      マニュアルページを<filename>/usr/local/man/man1</filename>ディレクトリにコピーします。
     </para>
     <screen><prompt>&gt; </prompt><command>sudo</command> <command>cp foo-{2,3}.1.gz /usr/local/man/man1/</command></screen>
    </step>
    <step>
     <para>
      <option>--slave</option>オプションを使用して、メインスクリプトにスレーブリンクを追加します。
     </para>
     <screen><prompt>&gt; </prompt><command>sudo</command> <command>update-alternatives --install \
   /usr/local/bin/foo foo /usr/local/bin/foo-2 200 \
   --slave /usr/local/man/man1/foo.1.gz \
   foo.1.gz \
   /usr/local/man/man1/foo-2.1.gz \
   --slave /etc/foo.conf \
   foo.conf \
   /etc/foo-2.conf</command>
<prompt>&gt; </prompt><command>sudo</command> <command>update-alternatives --install \
   /usr/local/bin/foo foo /usr/local/bin/foo-3 300 \
   --slave /usr/local/man/man1/foo.1.gz \
   foo.1.gz \
   /usr/local/man/man1/foo-3.1.gz \
   --slave /etc/foo.conf \
   foo.conf \
   /etc/foo-3.conf</command></screen>
    </step>
    <step>
     <para>マスタリンクを確認します。</para>
     <screen>foo - auto mode
  link best version is /usr/local/bin/foo-3
  link currently points to /usr/local/bin/foo-3
  link foo is /usr/local/bin/foo
  slave foo.1.gz is /usr/local/man/man1/foo.1.gz
  slave foo.conf is /etc/foo.conf
/usr/local/bin/foo-2 - priority 200
  slave foo.1.gz: /usr/local/man/man1/foo-2.1.gz
  slave foo.conf: /etc/foo-2.conf
/usr/local/bin/foo-3 - priority 300
  slave foo.1.gz: /usr/local/man/man1/foo-3.1.gz
  slave foo.conf: /etc/foo-3.conf</screen>
    </step>
   </procedure>
   <para>
    <command>update-alternatives --config foo</command>を使用してリンクを<command>foo-2</command>に変更すると、スレーブリンクもすべて変更されます。
   </para>
  </sect1>

  
</chapter>
