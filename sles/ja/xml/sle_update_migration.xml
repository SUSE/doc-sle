<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_migration.xml" version="5.0" xml:id="cha.update.spmigration">
 <title>サービスパックのマイグレーション</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    SUSEは、新しいサービスパックにアップグレードするためのグラフィカルツールとコマンドラインツールを提供します。たとえば、シンプルなコマンドラインツール、直感的なグラフィカルユーザインタフェース、サービスパックの<quote>ロールバック</quote>のサポートなどです。この章では、これらのツールを使用してサービスパックのマイグレーションを実行する方法を順を追って説明します。
   </para>
  </abstract>
 </info>
 <sect1 xml:id="sec.update.migr.conceptual-overview">
  <title>概念の概要</title>

  <para>
   SUSEは、SUSE Linux Enterpriseファミリ用の新しいサービスパックを定期的にリリースしています。お客様が新しいサービスパックに容易に移行してダウンタイムを最小限に抑えることができるよう、SUSEはシステム実行中のオンラインマイグレーションをサポートしています。
  </para>

  <para>
   SLE 12 SP2から、YaST WagonはYaSTマイグレーション(GUI)およびZypperマイグレーション(コマンドライン)に置き換えられました。次の機能がサポートされています。
  </para>

  <itemizedlist>
   <listitem>
    <para>
     最初のRPMが更新されるまで、システムは常に定義済みの状態
    </para>
   </listitem>
   <listitem>
    <para>
     最初のRPMが更新されるまでは、キャンセルが可能
    </para>
   </listitem>
   <listitem>
    <para>
     エラーが発生した場合、簡単に回復
    </para>
   </listitem>
   <listitem>
    <para>
     システムツールによって<quote>ロールバック</quote>、バックアップ/復元は不要
    </para>
   </listitem>
   <listitem>
    <para>
     アクティブなすべてのリポジトリを使用
    </para>
   </listitem>
   <listitem>
    <para>
     サービスパックをスキップ可能
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.supported-scenarios-and-versions">
  <title>サポートされるソフトウェアシナリオと製品バージョン</title>

  <para>
   SUSEは、オフラインまたはオンラインによって次のシナリオをサポートします。
  </para>

  <variablelist>
   <varlistentry>
    <term>オンライン</term>
    <listitem>
     <para>
      SCC(SUSEカスタマーセンター)、SM(Subscription Management Tool)、SUSE Manager
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>オフライン</term>
    <listitem>
     <para>
      ブートDVD、フラッシュディスク、ISOイメージ、AutoYaST、<quote>プレーンRPM</quote>、およびサードパーティ製ツール
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   次のバージョンからのマイグレーションがサポートされます。
  </para>

  <variablelist>
   <varlistentry>
    <term>オンライン</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 12
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>オフライン</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 11 SP3/SP4、SUSE Linux Enterprise 12
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>手動/サードパーティ</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 12
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec.update.migr.workflow">
  <title>サービスパックのマイグレーションのワークフロー</title>

  <para>
   サービスパックのマイグレーションは、YaST、<command>zypper</command>、またはAutoYaSTにより実行できます。
  </para>

  <para>
   サービスパックのマイグレーションを開始する前に、SUSEカスタマーセンターでシステムを登録する必要があります。DVDから派生した自己ビルドリポジトリを使用してマイグレーションを実行することはできません。
  </para>

  <para>
   どの方法を使用する場合も、サービスパックのマイグレーションは次の手順で構成されます。
  </para>

  <orderedlist>
   <listitem>
    <para>
     登録システムで、マイグレーションターゲットの候補を見つけます。
    </para>
   </listitem>
   <listitem>
    <para>
     マイグレーションターゲットを1つ選択します。
    </para>
   </listitem>
   <listitem>
    <para>
     新しいリポジトリを要求して有効にします。
    </para>
   </listitem>
   <listitem>
    <para>
     マイグレーションを実行します。
    </para>
   </listitem>
  </orderedlist>



  <para>
   マイグレーションターゲットのリストは、インストールおよび登録されている製品に応じて異なります。新しいSPがまだ利用可能になっていない拡張機能がインストールされている場合、マイグレーションターゲットが提供されない可能性があります。
  </para>

  <para>
   ホストで使用可能なマイグレーションターゲットのリストは、常にSUSEカスタマーセンターから取得され、インストールされている製品または拡張機能に応じて異なります。
  </para>
 </sect1>
 <sect1 xml:id="sec.update.migr.cancel.spm">
  <title>サービスパックのマイグレーションのキャンセル</title>

  <para>
   サービスパックのマイグレーションは、マイグレーションプロセスの特定の段階でのみキャンセルできます。
  </para>

  <orderedlist>
   <listitem>
    <para>
     パッケージのアップグレードが開始されるまで、システムには、サービスやリポジトリなどの最小限の変更しか加えられません。以前の状態に戻すには、<filename>/etc/zypp/repos.d/*</filename>を復元します。
    </para>
   </listitem>
   <listitem>
    <para>
     パッケージのアップグレードが開始された後は、Snapperスナップショットを使用して以前の状態に戻すことができます(<xref linkend="cha.snapper"/>を参照してください)。
    </para>
   </listitem>
   <listitem>
    <para>
     マイグレーションターゲットが選択された後、SUSEカスタマーセンターによってリポジトリデータが変更されます。この状態を手動で元に戻すには、<command>SUSEConnect</command> <option>--rollback</option>を使用します。
    </para>
   </listitem>
  </orderedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.yast.onlinemigr">
  <title>オンラインマイグレーションツール(YaST)を使用した移行</title>

  <para>
   YaSTを使用してサービスパックのマイグレーションを実行するには、<guimenu>Online Migration (オンラインマイグレーション)</guimenu>ツールを使用します。デフォルトでは、YaSTはサードパーティリポジトリからパッケージをインストールしません。パッケージがサードパーティリポジトリからインストールされている場合、YaSTは、SUSEから提供されている同じパッケージによってパッケージが置き換えられるのを防ぎます。
  </para>

  <note>
   <title>インストールサイズの削減</title>
   <para>
    SPのマイグレーションの実行時に、YaSTは推奨パッケージをすべてインストールします。特にカスタム最小インストールの場合、これによってシステムのインストールサイズが大幅に増加することがあります。
   </para>
   <para>
    このデフォルトの動作を変更して、必須パッケージのみがインストールされるようにするには、<filename>/etc/zypp/zypp.conf</filename>を調整して次の変数を設定します。
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   これにより、パッチや新しいパッケージのインストールなど、すべてのパッケージ操作の動作が変更されます。
  </para>

  <para>
   サービスパックのマイグレーションを開始するには、次の手順を実行します。
  </para>

  <procedure xml:id="pro.update.migr.yast">
   <step>
    <para>
     YaSTオンラインアップデートを実行して、システム用の最新のパッケージのアップデートを取得します。
    </para>
   </step>
   <step>
    <para>
     パッケージ
     <package>yast2-migration</package>
     およびその依存関係をインストールします(YaSTの<menuchoice> <guimenu>ソフトウェア</guimenu> <guimenu>ソフトウェア管理</guimenu> </menuchoice>)。
    </para>
   </step>
   <step>
    <para>
     YaSTを再起動します。再起動しないと、新しくインストールしたモジュールがコントロールセンターに表示されません。
    </para>
   </step>
   <step>
    <para>
     YaSTで<menuchoice><guimenu>システム</guimenu> <guimenu>Online Migration (オンラインマイグレーション)</guimenu></menuchoice>を起動します。可能性のあるマイグレーションターゲットと概要がYaSTによって表示されます。システムで使用可能なマイグレーションターゲットが複数ある場合は、リストから1つを選択します。
    </para>
   </step>
   <step>
    <para>
     リストからマイグレーションターゲットを1つ選択し、<guimenu>次へ</guimenu>で続行します。
    </para>
   </step>
   <step>
    <para>
     マイグレーションツールによってアップデートリポジトリが提供される場合は、<guimenu>はい</guimenu>で続行することをお勧めします。
    </para>
   </step>
   <step>
    <para>
     <remark>toms 2015-09-09: FATE#319140</remark>［Online Migration (オンラインマイグレーション)］ツールにより、DVDまたはローカルサーバから提供されている古いリポジトリが検出される場合は、それらを無効にすることを強くお勧めします。古いリポジトリは以前のSPのものです。SCCまたはSMTの古いリポジトリは自動的に削除されます。
    </para>
   </step>
   <step>
    <para>
     概要を確認し、<guimenu>Next (次へ)</guimenu>をクリックしてマイグレーションを続行します。<guimenu>Start Update (アップデートの開始)</guimenu>を選択して確認します。
    </para>
    <remark>toms 2016-07-13: What to do in case of problems?</remark>
   </step>
   <step>
    <para>
     マイグレーションが正常に完了したら、システムを再起動します。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.zypper.onlinemigr">
  <title>Zypperによるマイグレーション</title>

  <para>
   Zypperを使用してサービスパックのマイグレーションを実行するには、コマンドラインツール<command>zypper</command> <option>migration</option>を使用します。
  </para>

  <note>
   <title>インストールサイズの削減</title>
   <para>
    SPのマイグレーションの実行時に、YaSTは推奨パッケージをすべてインストールします。特にカスタム最小インストールの場合、これによってシステムのインストールサイズが大幅に増加することがあります。
   </para>
   <para>
    このデフォルトの動作を変更して、必須パッケージのみがインストールされるようにするには、<filename>/etc/zypp/zypp.conf</filename>を調整して次の変数を設定します。
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   これにより、パッチや新しいパッケージのインストールなど、すべてのパッケージ操作の動作が変更されます。1回の起動に対してのみZypperの動作を変更するには、パラメータ<option>--no-recommends</option>をコマンドラインに追加します。
  </para>

  <para>
   サービスパックのマイグレーションを開始するには、次の手順を実行します。
  </para>

  <procedure xml:id="pro.update.migr.zypper">
   <step>
    <para>
     SUSE Linux Enterpriseマシンをまだ登録していない場合は登録します。
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --regcode <replaceable>YOUR_REGISTRATION_CODE</replaceable></screen>
   </step>
   <step>
    <para>
     最新のアップデートをインストールします。
    </para>
<screen><prompt>root # </prompt><command>zypper</command> patch</screen>
   </step>
   <step>
    <para>
     パッケージ
     <package>zypper-migration-plugin</package>
     およびその依存関係をインストールします。
    </para>
<screen><prompt>root # </prompt><command>zypper</command> migration</screen>
   </step>
   <step>
    <para>
     <command>zypper</command> <option>migration</option>を実行します。
    </para>
<screen><prompt>root # </prompt><command>zypper</command> migration
Executing 'zypper  patch-check'

Refreshing service 'SUSE_Linux_Enterprise_Server_12_x86_64'.
Loading repository data...
Reading installed packages...
0 patches needed (0 security patches)

Available migrations:

    1 | SUSE Linux Enterprise Server 12 SP1 x86_64
    2 | SUSE Linux Enterprise Server 12 SP2 x86_64</screen>
    <para>
     マイグレーションプロセスに関する注記
    </para>
    <itemizedlist>
     <listitem>
      <para>
       システムで使用可能なマイグレーションターゲットが複数ある場合は、Zypperでリストから1つを選択できます。これはSPを1つまたは複数スキップするのと同じことです。基本製品(SLES、SLED)のオンラインマイグレーションを使用できるのは、メジャーバージョンのSP間のみであることに注意してください。
      </para>
     </listitem>
     <listitem>
      <para>
       デフォルトでは、Zypperは、<command>zypper</command> <option>dup</option>に渡されるオプション<option>--no-allow-vendor-change</option>を使用します。パッケージがサードパーティリポジトリからインストールされている場合、このオプションにより、SUSEから提供されている同じパッケージによって該当するパッケージが置き換えられるのを防ぎます。
      </para>
     </listitem>
     <listitem>
      <para>
       <remark>toms 2015-09-09: FATE#319140</remark>Zypperにより、DVDまたはローカルサーバから提供されている古いリポジトリが検出される場合は、それらを無効にすることを強くお勧めします。古いSCCまたはSMTリポジトリは自動的に削除されます。
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     すべての変更内容を確認します。特に、削除されるパッケージに注意してください。「<literal>y</literal>」と入力して続行します(アップグレードするパッケージの正確な数はシステムによって異なる可能性があります)。
    </para>
<screen>266 packages to upgrade, 54 to downgrade, 17 new, 8 to reinstall, 5 to remove, 1 to change arch.
Overall download size: 285.1 MiB. Already cached: 0 B  After the operation, additional 139.8 MiB will be used.
Continue? [y/n/? shows all options] (y):</screen>
    <para>
     シェルをスクロールするには、<keycombo> <keycap function="shift"/> <keycap function="pageup"/> </keycombo>または<keycombo> <keycap function="shift"/> <keycap function="pagedown"/> </keycombo>キーを使用します。
    </para>
   </step>
   <step>
    <para>
     マイグレーションが正常に完了したら、システムを再起動します。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.plainzypper.onlinemigr">
  <title>プレーンZypperによるマイグレーション</title>

  <para>
   YaSTマイグレーションまたはZypperマイグレーションを使用できない場合でも、プレーンZypperといくつかの手動操作でマイグレートできます。サービスパックのマイグレーションを開始するには、次の手順を実行します。
  </para>

  <procedure>
   <step>
    <para>
     SUSE Linux Enterpriseの古いリポジトリを使用してパッケージ管理ツールを更新します。
    </para>
<screen><prompt>root # </prompt><command>zypper</command> patch--updatestack-only</screen>
   </step>
   <step>
    <para>
     システムが登録済みの場合、登録を解除する必要はありません。
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --de-register</screen>
   </step>
   <step>
    <para>
     古いインストールソースとリポジトリを削除して、サードパーティリポジトリを調整します。
    </para>
   </step>
   <step>
    <para>
     新しいインストールソースを追加します。これはローカルソースまたはリモートソースです(プレースホルダ<replaceable>REPOSITORY</replaceable>は、<xref linkend="tab.update.nmm.repositories.sp2"/>を参照してください)。
    </para>
<screen><prompt>root # </prompt><command>zypper</command> addrepo <replaceable>REPOSITORY</replaceable></screen>
    <para>
     SUSEカスタマーセンターまたはSubscription Management Toolを使用することもできます。x86-64では、SUSE Linux Enterprise 12 SP1のコマンドは次のとおりです。
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> -p SLES/12.2/x86_64 <replaceable>OPTIONS</replaceable></screen>
    <para>
     クロスアーキテクチャアップグレードはサポートされていません。
    </para>
   </step>
   <step>
    <para>
     マイグレーションを完了します。
    </para>
<screen><prompt>root # </prompt><command>zypper</command> ref -f -s
<prompt>root # </prompt><command>zypper</command> dup --no-allow-vendor-change --no-recommends</screen>
    <para>
     最初のコマンドは、すべてのサービスとリポジトリを更新します。2番目のコマンドは、ディストリビューションのアップグレードを実行します。ここでは最後の2つのオプションが重要です。<option>-no-allow-vendor-change</option>は、サードパーティRPMによって基本システムのRPMが上書きされないようにします。<option>--no-recommends</option>オプションは、初期インストール時に選択解除したパッケージが再び追加されないようにします。
    </para>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec.update.migr.ownscripts.onlinemigr">
  <title>手動マイグレーション</title>
  <remark>toms 2016-07-13: Is this supported?</remark>
  <para>
   手動マイグレーション、つまり独自のスクリプトを使用したマイグレーションでは、システムの各要素についてより深い知識が必要になります。したがって、次の手順は熟練したユーザーにのみ推奨します。
  </para>

  <para>
   システムを手動で移行するには、次の手順を実行します。
  </para>

  <procedure>
   <step>
    <para>
     システムを準備します。
    </para>
    <substeps>
     <step>
      <para>
       現在のシステムをSCCから登録解除します。
      </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --de-register</screen>
     </step>
     <step>
      <para>
       DVDから提供された古いインストールソースを無効にします。たとえば、<filename>/etc/zypp/repos.d/SLES12-12-0.repo</filename>を調べます。
      </para>
     </step>
     <step>
      <para>
       サードパーティリポジトリを検索し、URLを調整します。
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     SUSEカスタマーセンター経由でリモートリポジトリを追加するのか、ローカルリポジトリを追加するのかを決定します。
    </para>
    <variablelist>
     <varlistentry>
      <term>SCC経由のリモートインストールソース</term>
      <listitem>
       <para>
        オンラインチャネル経由で新しいインストールソースを追加します。
       </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> -p SLES/12.2/x86_64 -r <replaceable>CODE</replaceable> -e <replaceable>EMAIL</replaceable></screen>
       <para>
        システムが正しく登録されているかどうかを確認します。
       </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --status</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>ローカルインストールソース</term>
      <listitem>
       <para>
        ローカルインストールソースを追加します。
       </para>
<screen><prompt>root # </prompt><command>zypper</command> ar -f http://example.com/media/SLES12SP2/
<prompt>root # </prompt><command>zypper</command> ar dvd:///?devices=/dev/sr0 SLES12SP2</screen>
      </listitem>
     </varlistentry>
    </variablelist>
   </step>
   <step>
    <para>
     すべてのリポジトリを更新します。
    </para>
<screen><prompt>root # </prompt><command>zypper</command> --releasever 12.2 ref -f -s</screen>
   </step>
   <step>
    <para>
     <command>zypper dup</command>でディストリビューションアップグレードを実行します。
    </para>
<screen><prompt>root # </prompt><command>zypper</command> --releasever 12.2 dup --no-allow-vendor-change --recommends</screen>
   </step>
   <step>
    <para>
     システムをまだ登録していない場合は、登録します。
    </para>
   </step>
   <step>
    <para>
     システムが正しく登録されていることを確認します。
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --status</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.rollback">
  <title>サービスパックのロールバック</title>

  <para>
   サービスパックの有効性が認められない場合は、SUSE Linux Enterpriseをサービスパックのマイグレーションが開始される前の状態に戻すことができます。
  </para>

  <procedure xml:id="pro.update.migr.rollback">
   <step>
    <para>
     すべてのSnapperスナップショットのリストを取得します。
    </para>
    <screen><prompt>root # </prompt><command>snapper</command> list</screen>
    <para>
     出力を確認し、次のステップで使用する番号を選択します。Snapperの詳細については、<xref linkend="cha.snapper"/>を参照してください。
    </para>
   </step>
   <step>
    <para>
     ロールバックするSnapperスナップショットを選択します。前のステップで選択した番号を入力します。
    </para>
<screen><prompt>root # </prompt><command>snapper</command> rollback <replaceable>NUMBER</replaceable></screen>
   </step>
   <step>
    <para>
     ブートローダを復元します(詳細については、<xref linkend="cha.grub2"/>を参照してください)。
    </para>
<screen><prompt>root # </prompt><command>grub2</command> boot menu</screen>
    <para>
     ブート中に、登録が自動的にリセットされます。
    </para>
   </step>
   <step>
    <para>
     システムが正しく登録されているかどうかを確認します(詳細については、<xref linkend="sec.update.registersystem"/>も参照してください)。
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --status</screen>
   </step>
   <step>
    <para>
     必要に応じて、登録を修復します。
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --rollback</screen>
   </step>
  </procedure>
 </sect1>
</chapter>
