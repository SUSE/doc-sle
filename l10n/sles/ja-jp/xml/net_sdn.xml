<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_sdn.xml" version="5.0" xml:id="sec-network-openvswitch">
 <title><phrase role="productname">Open vSwitch</phrase>によるソフトウェア定義型ネットワーキング</title>

 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>

 <para>
  SDN(Software-defined networking)とは、トラフィックの送信先を制御するシステム(<emphasis></emphasis>「コントロールプレーン」)と、選択されたあて先にトラフィックを転送する基盤システム(<emphasis></emphasis>「データプレーン」または<emphasis></emphasis>「転送プレーン」)を分離することを意味します。これは、従来は原則として柔軟性のない1台のスイッチで実現されていた機能を、スイッチ(データプレーン)とそのコントローラ(コントロールプレーン)に分離できるようになったことを意味します。このモデルでは、コントローラはプログラム可能であり、ネットワーク条件の変化に対して非常に柔軟かつ速やかに適応できます。
 </para>

 <para>
  <phrase role="productname">Open vSwitch</phrase>は、<phrase role="productname">OpenFlow</phrase>プロトコルと互換性がある分散仮想多層スイッチを実装するソフトウェアです。<phrase role="productname">OpenFlow</phrase>を使用すると、コントローラアプリケーションがスイッチの設定を変更できるようになります。<phrase role="productname">OpenFlow</phrase>は、TCPプロトコル上に階層化され、さまざまなハードウェアやソフトウェアで実装されます。したがって、1つのコントローラで、複数のまったく異なるスイッチを操作できます。
 </para>

 <sect2 xml:id="sec-network-openvswitch-advantage">
  <title><phrase role="productname">Open vSwitch</phrase>の利点</title>
  <para>
   <phrase role="productname">Open vSwitch</phrase>によるソフトウェア定義型ネットワーキングには、さまざまな利点があり、特に仮想マシンと併用した場合に威力を発揮します。
  </para>
  <remark>
   Tried to create short version of this:
   https://github.com/openvswitch/ovs/blob/master/WHY-OVS.md
   - sknorr, 2015-09-30
  </remark>
  <itemizedlist>
   <listitem>
    <para>
     ネットワーキングの状態を簡単に識別できます。
    </para>
   </listitem>
   <listitem>
    <para>
     ネットワークとそのライブ状態をホスト間で移動できます。
    </para>
   </listitem>
   <listitem>
    <para>
     ネットワークの動作状態を追跡可能であり、外部ソフトウェアでそれらに対応できます。
    </para>
   </listitem>
   <listitem>
    <para>
     ネットワークパケットでタグを適用および操作して、送信元や送信先のマシンを識別したり、他のネットワーキングコンテキストを管理したりできます。タグ付けルールを設定および移行できます。
    </para>
    <remark>
     Feedback from Éric Bischoff: "[...] isn't that _how OVS works_, rather
     than _what OVS can do_?"
     =&gt; Added second sentence. It does ultimately seem like a feature to me,
       though. Leaving it in for the moment.
     - sknorr, 2015-10-15
    </remark>
   </listitem>
   <listitem>
    <para>
     <phrase role="productname">Open vSwitch</phrase>は、GREプロトコル(<emphasis></emphasis>「Generic Routing Encapsulation」)を実装しています。これにより、たとえば複数のプライベートVMネットワークを相互に接続できます。
    </para>
   </listitem>
   <listitem>
    <para>
     <phrase role="productname">Open vSwitch</phrase>は単独でも使用できますが、ネットワーキングハードウェアと統合するように設計されており、ハードウェアスイッチを制御できます。
    </para>
   </listitem>
  </itemizedlist>
 </sect2>

 <sect2 xml:id="sec-network-openvswitch-install">
  <title><phrase role="productname">Open vSwitch</phrase>のインストール</title>
  <procedure>
   <step>
    <para>
     <phrase role="productname">Open vSwitch</phrase>と付属のパッケージをインストールします。
    </para>
<screen><prompt role="root"># </prompt><command>zypper</command> install openvswitch openvswitch-switch</screen>
    <para>
     <phrase role="productname">Open vSwitch</phrase>をKVM hypervisorと併用する場合は、さらに<package>tunctl</package>をインストールます。<phrase role="productname">Open vSwitch</phrase>をXen hypervisorと併用する場合は、さらに<package>openvswitch-kmp-xen</package>をインストールします。
    </para>
   </step>
   <step>
    <para>
     <phrase role="productname">Open vSwitch</phrase>サービスを有効にします。
    </para>
<screen><prompt role="root"># </prompt><command>systemctl</command> enable openvswitch</screen>

   </step>
   <step>
    <para>
     コンピュータを再起動するか<command>systemctl</command>を使用して、<phrase role="productname">Open vSwitch</phrase>サービスをただちに開始します。
    </para>
<screen><prompt role="root"># </prompt><command>systemctl</command> start openvswitch</screen>
   </step>
   <step>
    <para>
     <phrase role="productname">Open vSwitch</phrase>が有効になったかどうかを確認するには、次のコマンドを使用します。
    </para>
<screen><prompt role="root"># </prompt><command>systemctl</command> status openvswitch</screen>
   </step>
  </procedure>
 </sect2>

 <sect2 xml:id="sec-network-openvswitch-userspace">
  <title><phrase role="productname">Open vSwitch</phrase>のデーモンとユーティリティの概要</title>
  <para>
   <phrase role="productname">Open vSwitch</phrase>は、さまざまなコンポーネントで構成されます。カーネルモジュールとさまざまなユーザ空間コンポーネントはその一部です。カーネルモジュールは、データパスを高速化するために使用されますが、<phrase role="productname">Open vSwitch</phrase>の最小インストールには必要ありません。
  </para>
  <sect3 xml:id="sec-network-openvswitch-daemon">
   <title>デーモン</title>
   <para>
    <phrase role="productname">Open vSwitch</phrase>の中核を成す実行可能ファイルは、2つのデーモンです。<systemitem>openvswitch</systemitem>サービスを開始することで、それらのデーモンを間接的に起動することになります。
   </para>
   <para>
    <phrase role="productname">Open vSwitch</phrase>のメインデーモン(<command>ovs-vswitchd</command>)は、スイッチの実装を提供します。<phrase role="productname">Open vSwitch</phrase>データベースデーモン(<command>ovsdb-server</command>)は、<phrase role="productname">Open vSwitch</phrase>の設定と状態が保存されるデータベースとして機能します。
   </para>
  </sect3>
  <sect3 xml:id="sec-network-openvswitch-utility">
   <title>ユーティリティ</title>
   <para>
    <phrase role="productname">Open vSwitch</phrase>には、その操作に役立つさまざまなユーティリティも付属しています。次に、すべてのコマンドではなく、重要なコマンドについてのみ説明します。
   </para>

   <variablelist xml:id="vl-ovs-utility">
    <varlistentry>
     <term><command>ovsdb-tool</command>
     </term>
     <listitem>
      <para>
       <phrase role="productname">Open vSwitch</phrase>データベースの作成、アップグレード、圧縮、およびクエリを実行します。<phrase role="productname">Open vSwitch</phrase>データベースでトランザクションを実行します。
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><command>ovs-appctl</command>
     </term>
     <listitem>
      <para>
       実行中の<command>ovs-vswitchd</command>デーモンまたは<command>ovsdb-server</command>デーモンを設定します。
      </para>
     </listitem>
    </varlistentry>


    <varlistentry>
     <term><command>ovs-dpctl</command>、<command>ovs-dpctl-top</command>
     </term>
     <listitem>
      <para>
       データパスを作成、変更、視覚化、および削除します。このツールを使用すると、データパス管理を同様に実行している<command>ovs-vswitchd</command>の動作の妨げになる可能性があります。したがって、通常は診断を目的としてのみ使用します。
      </para>
      <para>
       <command>ovs-dpctl-top</command>は、<command>top</command>と同様の方法でデータパスを視覚化します。
       <remark>Is visualize/ation the right word? - sknorr, 2015-09-30</remark>
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>ovs-ofctl</command>
     </term>
     <listitem>
      <para>
       <phrase role="productname">OpenFlow</phrase>プロトコルを遵守するスイッチを管理します。<command>ovs-ofctl</command>は、<phrase role="productname">Open vSwitch</phrase>とのやり取り以外にも使用できます。
      </para>
     </listitem>
    </varlistentry>




    <varlistentry>
     <term><command>ovs-vsctl</command>
     </term>
     <listitem>
      <para>
       設定データベースに対する上位インタフェースを提供します。データベースのクエリおよび変更に使用できます。実際には、<command>ovs-vswitchd</command>のステータスを表示するほか、その設定を行うためにも使用できます。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect3>
 </sect2>

 <sect2 xml:id="sec-network-openvswitch-bridge">
  <title><phrase role="productname">Open vSwitch</phrase>によるブリッジの作成</title>
  <para>
   次の設定例では、<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>でデフォルトで使用されるWickedネットワークサービスを使用します。Wickedの詳細については、<xref linkend="sec-network-manconf"/>を参照してください。
  </para>
  <para>
   <phrase role="productname">Open vSwitch</phrase>をすでにインストールして起動している場合は、次の手順に従います。
  </para>
  <procedure>
   <step>
    <para>
     仮想マシンで使用するブリッジを設定するには、次のような内容のファイルを作成します。
    </para>
<screen>STARTMODE='auto'<co xml:id="ovs-ifcfg-mode"/>
BOOTPROTO='dhcp'<co xml:id="ovs-ifcfg-protocol"/>
OVS_BRIDGE='yes'<co xml:id="ovs-ifcfg-bridge"/>
OVS_BRIDGE_PORT_DEVICE_1='<replaceable>eth0</replaceable>'<co xml:id="ovs-ifcfg-port"/></screen>
    <calloutlist>
     <callout arearefs="ovs-ifcfg-mode">
      <para>
       ネットワークサービスの開始時に自動的にブリッジを設定します。
      </para>
     </callout>
     <callout arearefs="ovs-ifcfg-protocol">
      <para>
       IPアドレスの設定に使用するプロトコル。
      </para>
     </callout>
     <callout arearefs="ovs-ifcfg-bridge">
      <para>
       <phrase role="productname">Open vSwitch</phrase>ブリッジとして設定するよう指定します。
      </para>
     </callout>
     <callout arearefs="ovs-ifcfg-port">
      <para>
       ブリッジに追加する必要があるデバイスを選択します。デバイスを追加するには、デバイスごとに追加の行をファイルに追加します。
      </para>
<screen>OVS_BRIDGE_PORT_DEVICE_<replaceable>SUFFIX</replaceable>='<replaceable>DEVICE</replaceable>'</screen>
      <para>
       <replaceable>SUFFIX</replaceable>には、任意の英数字文字列を指定できます。ただし、既存の定義を上書きしないように、各デバイスの<replaceable>SUFFIX</replaceable>が固有であることを確認します。
      </para>
     </callout>
    </calloutlist>
    <para>
     ファイルに<filename>ifcfg-br0</filename>という名前を付けて、ディレクトリ<filename>/etc/sysconfig/network</filename>に保存します。<replaceable>br0</replaceable>の代わりに任意の名前を指定できます。ただし、ファイル名は<literal>ifcfg-</literal>で始まる必要があります。
    </para>
    <para>
     他のオプションの詳細については、<literal>ifcfg</literal>のマニュアルページ(<command>man 5 ifcfg</command>)および<literal>ifcfg-ovs-bridge</literal>のマニュアルページ(<command>man 5 ifcfg-ovs-bridge</command>)を参照してください。
    </para>
   </step>
   <step>
    <para>
     ブリッジを起動します。
     <remark>"Start" is weird - sknorr, 2015-10-26</remark>
    </para>
<screen><prompt role="root"># </prompt><command>wicked</command> ifup <replaceable>br0</replaceable></screen>
    <para>
     Wickedが実行されると、ブリッジの名前、およびその横に状態<literal>up</literal>が出力されるはずです。
    </para>
   </step>
  </procedure>
 </sect2>

 <sect2 xml:id="sec-network-openvswitch-kvm">
  <title>KVMで直接<phrase role="productname">Open vSwitch</phrase>を使用する</title>
  <para>
   <xref linkend="sec-network-openvswitch-bridge"/>の説明に従ってブリッジを作成した後は、KVM/QEMUで作成した仮想マシンのネットワークアクセスを、<phrase role="productname">Open vSwitch</phrase>を使用して管理できます。
  </para>
  <procedure>
   <step>
    <para>
     Wickedの機能を最大限に活用できるように、ブリッジの既存の設定をいくつか変更します。作成済みの<filename>/etc/sysconfig/network/ifcfg-br0</filename>を開いて、新しいポートデバイス用の行を追加します。
    </para>
<screen>OVS_BRIDGE_PORT_DEVICE_2='<replaceable>tap0</replaceable>'</screen>
    <para>
     さらに、<literal>BOOTPROTO</literal>を<literal>none</literal>に設定します。ファイルは次のようになるはずです。
    </para>
<screen>STARTMODE='auto'
BOOTPROTO='none'
OVS_BRIDGE='yes'
OVS_BRIDGE_PORT_DEVICE_1='<replaceable>eth0</replaceable>'
OVS_BRIDGE_PORT_DEVICE_2='<replaceable>tap0</replaceable>'</screen>
    <para>
     新しいポートデバイス<replaceable>tap0</replaceable>は、次のステップで設定します。
    </para>
   </step>
   <step>
    <para>
     次に、<replaceable>tap0</replaceable>デバイスの設定ファイルを追加します。
    </para>
<screen>STARTMODE='auto'
BOOTPROTO='none'
TUNNEL='tap'</screen>
    <para>
     ファイルに<filename>ifcfg-tap0</filename>という名前を付けて、ディレクトリ<filename>/etc/sysconfig/network</filename>に保存します。
    </para>
    <tip>
     <title>tapデバイスへのアクセスを他のユーザに許可する</title>
     <para>
      <systemitem class="username">root</systemitem>以外のユーザとして起動した仮想マシンからこのtapデバイスを使用できるようにするには、次の行を追加します。
     </para>
<screen>TUNNEL_SET_OWNER=<replaceable>USER_NAME</replaceable></screen>
     <para>
      グループ全体にアクセスを許可するには、次の行を追加します。
     </para>
<screen>TUNNEL_SET_GROUP=<replaceable>GROUP_NAME</replaceable></screen>
    </tip>
   </step>
   <step>
    <para>
     最後に、最初の<literal>OVS_BRIDGE_PORT_DEVICE</literal>として定義されているデバイスの設定を開きます。名前は、変更していなければ、<literal>eth0</literal>です。したがって、<filename>/etc/sysconfig/network/ifcfg-eth0</filename>を開いて、次のオプションが設定されていることを確認します。
    </para>
<screen>STARTMODE='auto'
BOOTPROTO='none'</screen>
    <para>
     このファイルがまだ作成されていない場合は、作成してください。
    </para>
   </step>
   <step>
    <para>
     Wickedを使用して、ブリッジインタフェースを再起動します。
    </para>
<screen><prompt role="root"># </prompt><command>wicked</command> ifreload <replaceable>br0</replaceable></screen>
    <para>
     これにより、新しく定義したブリッジポートデバイスの再ロードもトリガされます。
    </para>
   </step>
   <step>
    <para>
     仮想マシンを起動するには、たとえば次の手順を実行します。
    </para>
<screen><prompt role="root"># </prompt><command>qemu-kvm</command> \
-drive file=<replaceable>/PATH/TO/DISK-IMAGE</replaceable><co xml:id="co-ovs-pathimage"/> \
-m 512 -net nic,vlan=0,macaddr=00:11:22:EE:EE:EE \
-net tap,ifname=<replaceable>tap0</replaceable>,script=no,downscript=no<co xml:id="co-ovs-tapdevice"/></screen>
    <calloutlist>
     <callout arearefs="co-ovs-pathimage">
      <para>
       起動するQEMUディスクイメージへのパス。
      </para>
     </callout>
     <callout arearefs="co-ovs-tapdevice">
      <para>
       前に作成したtapデバイス(<literal>tap0</literal>)を使用します。
      </para>
     </callout>
    </calloutlist>
    <para>
     KVM/QEMUの使用の詳細については、<xref linkend="part-virt-qemu"/>を参照してください。
    </para>
   </step>
  </procedure>
 </sect2>

 <sect2 xml:id="sec-network-openvswitch-libvirt">
  <title><systemitem class="library">libvirt</systemitem>による<phrase role="productname">Open vSwitch</phrase>の使用</title>
  <para>
   <xref linkend="sec-network-openvswitch-bridge"/>の説明に従ってブリッジを作成した後は、<systemitem class="library">libvirt</systemitem>で管理している既存の仮想マシンに、ブリッジを追加できます。<systemitem class="library">libvirt</systemitem>はすでに<phrase role="productname">Open vSwitch</phrase>ブリッジを一部サポートしているので、ネットワーキング設定を変更せずに<xref linkend="sec-network-openvswitch-bridge"/>で作成したブリッジを使用できます。
  </para>
  <procedure>
   <step>
    <para>
     対象の仮想マシンのドメインXMLファイルを開きます。
    </para>
<screen><prompt role="root"># </prompt><command>virsh</command> edit <replaceable>VM_NAME</replaceable></screen>
    <para>
     <replaceable>VM_NAME</replaceable>を、対象の仮想マシンの名前で置き換えます。これにより、デフォルトのテキストエディタが開きます。
    </para>
   </step>
   <step>
    <para>
     ドキュメントのネットワーキングセクションを探します。このセクションは、<literal>&lt;interface type=&quot;...&quot;&gt;</literal>で始まって、<literal>&lt;/interface&gt;</literal>で終わります。
    </para>
    <para>
     既存のセクションを、次のようなネットワーキングセクションで置き換えます。
    </para>
<screen>&lt;interface type='bridge'&gt;
  &lt;source bridge='br0'/&gt;
  &lt;virtualport type='openvswitch'/&gt;
&lt;/interface&gt;</screen>
    <important>
     <title><phrase role="productname">Open vSwitch</phrase>における<command>virsh iface-*</command>および仮想マシンマネージャとの互換性</title>
     <para>
      現時点では、<phrase role="productname">Open vSwitch</phrase>における<systemitem class="library">libvirt</systemitem>との互換性は、<command>virsh iface-*</command>ツールおよび仮想マシンマネージャを使用した場合には認められていません。これらのツールを使用すると、設定が壊れる可能性があります。
     </para>
    </important>
   </step>
   <step>
    <para>
     これで、仮想マシンを通常通りに起動または再起動できるようになります。
    </para>
   </step>
  </procedure>
  <para>
   <systemitem class="library">libvirt</systemitem>の使用の詳細については、<xref linkend="part-virt-libvirt"/>を参照してください。
  </para>
 </sect2>

 <sect2 xml:id="sec-network-openvswitch-more">
   <title>詳細情報</title>

   <para>
     SDNの詳細については、<phrase role="productname">Open vSwitch</phrase>プロジェクトのWebサイト(<link xlink:href="https://docs.openvswitch.org/en/latest/#documentation"/>)のドキュメントセクションを参照してください。
   </para>
 </sect2>
</sect1>
