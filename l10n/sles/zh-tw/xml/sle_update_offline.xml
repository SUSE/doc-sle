<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_offline.xml" version="5.0" xml:id="cha-upgrade-offline">
 <title>離線升級</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>是</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    本章介紹如何使用從安裝媒體開機的 YaST，來升級現有的 SUSE Linux Enterprise 安裝。YaST 安裝程式有多種啟動方法，例如從 DVD 啟動、透過網路啟動或從系統所在的硬碟啟動。
   </para>
  </abstract>
 </info>
 <sect1 xml:id="sec-upgrade-offline-conceptual-overview">
  <title>概念綜覽</title>
  <para>
   在升級系統之前，請先閱讀<xref linkend="cha-update-preparation"/>。
  </para>
  <para>
   若要升級系統，請像執行全新安裝時那樣，從安裝來源開機。不過，當開機螢幕出現時，您需要選取<guimenu>升級</guimenu> (而不是<guimenu>安裝</guimenu>)。可從以下媒體啟動升級：
  </para>

  <itemizedlist>
   <listitem>
    <formalpara>
     <title>抽取式媒體</title>
     <para>
      包括 CD、DVD 或 USB 大量儲存裝置等媒體。如需詳細資訊，請參閱 <xref linkend="sec-upgrade-offline-dvd"/>。
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>網路資源</title>
     <para>
      您可以從本地媒體開機並選取相應的網路安裝類型，或者透過 PXE 開機。如需詳細資訊，請參閱 <xref linkend="sec-upgrade-offline-network"/>。
     </para>
    </formalpara>
   </listitem>
  </itemizedlist>
 </sect1>


 <sect1 xml:id="sec-upgrade-offline-dvd">
  <title>從安裝媒體啟動升級</title>
  
  <para>
   下面的程序說明如何從 DVD 開機，不過，您也可以使用其他本地安裝媒體，例如 USB 大量儲存裝置上的 ISO 影像。要選取的媒體和開機方法取決於系統架構，以及機器使用的是傳統 BIOS 還是 UEFI。
  </para>
  <procedure xml:id="pro-update-sle12-offline-dvd">
   <title>以手動方式升級至 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> <phrase role="productnumber"><phrase os="sles;sled">15 SP3</phrase></phrase></title>
   <step>
    <para>
     選取並準備開機媒體，請參閱<xref linkend="part-prep"/>。
    </para>
   </step>
   <step>
    <para>
     插入 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> <phrase role="productnumber"><phrase os="sles;sled">15 SP3</phrase></phrase> 的整合安裝程式 DVD，並將機器開機。隨即會依次顯示<guimenu>歡迎使用</guimenu>螢幕和開機螢幕。
    </para>
   </step>
   <step>
    <para>
     選擇性：若要強制安裝程式僅安裝 DVD 中的套件而不安裝網路來源中的套件，請新增開機選項 <option>media_upgrade=1</option>。
    </para>
   </step>
   <step>
    <para>
     在開機功能表中選取<emphasis>升級</emphasis>以啟動系統。
    </para>
   </step>
   <step>
    <para>
     如<xref linkend="sec-upgrade-offline-yast"/>中所述繼續執行升級程序。
    </para>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec-upgrade-offline-network">
  <title>從網路來源啟動升級</title>
  <para>
   若要從網路安裝來源開始升級，請確定符合以下要求：
  </para>
  <variablelist>
   <title>從網路安裝來源升級的要求</title>
   <varlistentry>
    <term>網路安裝來源</term>
    <listitem>
     <para>
      網路安裝來源已依據<xref linkend="cha-deployment-instserver"/>所述完成設定。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>網路連接和網路服務</term>
    <listitem>
     <para>
      安裝伺服器與目標機器的網路連接均必須正常。必需的網路服務如下：
     </para>
     <itemizedlist>
      <listitem><para>網域名稱服務</para></listitem>
      <listitem><para>DHCP (僅在透過 PXE 開機時需要，可在設定期間手動設定 IP)</para></listitem>
      <listitem><para>OpenSLP (選擇性)</para></listitem>
     </itemizedlist>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>開機媒體</term>
    <listitem>
     <para>
      可開機的 SUSE Linux Enterprise DVD、ISO 影像或正常運作的 PXE 設定。如需透過 PXE 開機的詳細資料，請參閱<xref linkend="sec-deployment-prep-boot-pxeprep"/>。請參閱<xref linkend="cha-remote-installation"/>，深入瞭解從遠端伺服器開始升級的相關資訊。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <sect2 xml:id="sec-update-sle-manual-network-boot-from-dvd">
   <title>以手動方式透過網路安裝來源升級 — 從 DVD 開機</title>
  
   <para>
    此程序舉例說明如何從 DVD 開機，不過，您也可以使用其他本地安裝媒體，例如 USB 大量儲存裝置上的 ISO 影像。如何選取開機方法以及從媒體啟動系統取決於系統架構，以及機器使用的是傳統 BIOS 還是 UEFI。如需詳細資料，請參閱以下連結。
   </para>

   <procedure xml:id="pro-update-sle-manual-network-boot-from-dvd">

    <step>
     <para>
      插入 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> <phrase role="productnumber"><phrase os="sles;sled">15 SP3</phrase></phrase> 的整合安裝程式 DVD，並將機器開機。隨即會依次顯示<guimenu>歡迎使用</guimenu>螢幕和開機螢幕。
     </para>
    </step>
    <step>
     <para>
      選取要使用的網路安裝來源類型 (FTP、HTTP、NFS、SMB 或 SLP)。通常可以按 <keycap>F4</keycap> 選取此選項，但是，如果您機器上裝配的是 UEFI 而不是傳統 BIOS，則您可能需要手動調整開機參數。如需詳細資料，請參閱<xref linkend="cha-boot-parameters"/>與<xref linkend="cha-install"/>。
     </para>
    </step>
    <step>
     <para>
      如<xref linkend="sec-upgrade-offline-yast"/>中所述繼續執行升級程序。
     </para>
    </step>
   </procedure>
  </sect2>
  <sect2 xml:id="sec-update-sle-manual-network-pxe-boot">
   <title>以手動方式透過網路安裝來源升級 — 透過 PXE 開機</title>
   <para>
    若要透過 PXE 開機從網路安裝來源執行升級，請依照以下步驟操作：
   </para>
   <procedure xml:id="pro-update-sle-manual-network-pxe-boot">
    <step>
     <para>
      調整 DHCP 伺服器的設定以提供透過 PXE 開機時所需的位址資訊。如需詳細資料，請參閱<xref linkend="pro-deployment-dhcp-server"/>。
     </para>
    </step>
    <step>
     <para>
      設定 TFTP 伺服器，以存放透過 PXE 開機時所需的開機影像。為此，請使用 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> <phrase role="productnumber"><phrase os="sles;sled">15 SP3</phrase></phrase> 的安裝程式 DVD，或遵循<xref linkend="sec-deployment-tftp-server"/>中的指示。
     </para>
    </step>
    <step>
     <para>
      在目標機器上準備 PXE 開機和網路喚醒功能。
     </para>
    </step>
    <step>
     <para>
      啟始目標系統開機，並使用 VNC 遠端連接到這部機器所執行的安裝常式。如需詳細資訊，請參閱 <xref linkend="sec-remote-installation-monitor-vnc"/>。
     </para>
    </step>
    <step>
     <para>
      如<xref linkend="sec-upgrade-offline-yast"/>中所述繼續執行升級程序。
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>

 <sect1 xml:id="sec-upgrade-offline-yast">
  <title>升級 SUSE Linux Enterprise</title>
  <para>
   <remark>taroth 2014-11-13: argh, the following is terminology hell regarding
     the software strings: "upgrade"/"update" are used intermittently and
     without clear differentiation...</remark>
  </para>
  <para>
   在升級系統之前，請先閱讀<xref linkend="cha-update-preparation"/>。若要執行自動移轉，請執行下列步驟：
  </para>
  <procedure>
   <note>
    <title>SUSE Customer Center 和網際網路連接</title>
    <para>
     如果已在 SUSE Customer Center 中註冊要升級的系統，請確定在執行以下程序期間可以連接網際網路。
    </para>
   </note>
   <step>
    <para>
     (從安裝媒體或網路) 開機後，請在開機螢幕上選取<guimenu>升級</guimenu>項目。
    </para>
    <warning>
     <title>不當的選擇可能會導致資料遺失</title>
     <para>
      此時請務必選取<guimenu>升級</guimenu>。如果錯誤地選取了<guimenu>安裝</guimenu>，將會執行全新安裝，因而會覆寫您的資料分割區。
     </para>
    </warning>
    <para>
     YaST 將會啟動安裝系統。
    </para>
   </step>
   <step>
    <para>
     在<guimenu>歡迎</guimenu>畫面上，選擇<guimenu>語言</guimenu>和<guimenu>鍵盤</guimenu>按<guimenu>繼續</guimenu>以繼續。
    </para>
    <para>
     YaST 將會檢查您的分割區上是否已安裝 SUSE Linux Enterprise 系統。
    </para>
   </step>
   <step>
    <para>
     在<guimenu>選取升級</guimenu>螢幕上，選取要升級的分割區，然後按<guimenu>下一步</guimenu>。
    </para>
   </step>
   <step>
    <para>
     YaST 會掛接選取的分割區，並顯示所升級產品的授權合約。若要繼續升級，請接受授權條款。
    </para>
   </step>
   <step>
    <para>
     在<guimenu>之前使用的儲存庫</guimenu>螢幕上，調整儲存庫的狀態。預設會移除所有儲存庫。如果您未新增任何自訂儲存庫，請不要變更設定。將從 DVD 安裝待升級的套件，您可在下一步驟中選擇性地啟用預設線上儲存庫。
 </para>
 <para>
如果您有自訂儲存庫，可以採取以下兩種做法：
</para>
<itemizedlist>
    <listitem>
        <para>
    讓儲存庫保留「已移除」狀態。在升級期間，將會移除從此儲存庫安裝的軟體。在沒有任何與新版本相符的儲存庫版本可用的情況下，請使用此方法。
</para>
</listitem>
<listitem>
    <para>
    更新並啟用與新版本相符的儲存庫。在清單中按一下該儲存庫以變更其 URL，然後按一下<guimenu>變更</guimenu>。可透過選取<guimenu>切換狀態</guimenu>，直至其狀態設定為<guimenu>啟用</guimenu>來啟用儲存庫。
</para>
</listitem>
</itemizedlist>
<para>
不要保留上一版本中的儲存庫，否則系統可能不穩定甚至根本無法工作。然後按一下<guimenu>下一步</guimenu>繼續。
    </para>
   </step>
   <step>
    <para>
     下一步驟取決於是否已在 SUSE Customer Center 中註冊升級的系統。
    </para>
    <substeps>
     <step>
      <para>
       如果未在 SUSE Customer Center 中註冊系統，YaST 將顯示一則快顯訊息，建議使用另一個安裝媒體，即 SLE-15-SP3-Full-<replaceable>ARCH</replaceable>-GM-media1.iso 影像。
      </para>
      <para>
       如果您沒有該媒體，那麼不註冊系統就無法升級。
      </para>
     </step>
     <step>
      <para>
       如果已在 SUSE Customer Center 中註冊系統，YaST 將會顯示可能的移轉目標和摘要。
      </para>
      <para>
       從清單中選取一個移轉目標，然後按一下<guimenu>下一步</guimenu>繼續操作。
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     在下一個對話方塊中，您可以選擇新增額外的安裝媒體。如果您有額外的安裝媒體，請啟動<guimenu>我要安裝其他附加產品</guimenu>選項，並指定媒體類型。
    </para>
   </step>
   <step>
    <para>
     檢查升級的<guimenu>安裝設定</guimenu>。
    </para>
   </step>
   <step>
    <para>
     如果所有設定都如您所願，請按一下<guimenu>更新</guimenu>啟動安裝與移除程序。
    </para>
    <tip>
     <title>在 SMT 用戶端上升級失敗</title>
     <para>
      如果要升級的機器是 SMT 用戶端並且升級失敗，請參閱<xref linkend="pro-sec-update-prep-smt-de-register"/>，然後重新啟動升級程序。
     </para>
    </tip>
   </step>
   <step>
    <para>
     升級程序成功完成後，請依據<xref linkend="sec-upgrade-postupgrade-checks"/>所述執行升級後檢查。
    </para>
   </step>
  </procedure>
  <remark>2021-03-11 jufa: considering removing sub-section as only 1 section</remark>
  <sect2 xml:id="sec-upgrade-postupgrade-checks">
   <title>升級後檢查</title>
   <itemizedlist>
    <listitem>
     <para>
      檢查任何<quote>孤立的套件</quote>。執行升級程序期間可能會將套件重新命名、移除、合併或分割。因此，有些套件可能會變成孤立狀態，不再受支援。系統會自動移除孤立的套件。以下指令可以列出這些套件：
     </para>
<screen><prompt>tux &gt; </prompt>zypper packages --orphaned --unneeded</screen>
     <para>
      請使用該清單確定仍然需要的套件以及可以安全移除的套件。
     </para>
    </listitem>
    <listitem>
     <para>
      檢查所有 <filename>*.rpmnew</filename> 和 <filename>*.rpmsave</filename> 檔案，檢查其內容，並在可能的情況下合併適宜的變更。如果升級包括對某個預設組態檔案的變更，套件會寫入上述其中一個檔案類型，而不會覆寫該組態檔案。其中，<filename>*.rpmnew</filename> 包含新的預設組態且將原始檔案保持原樣不變，而 <filename>*.rpmsave</filename> 是原始組態的副本且已由新的預設檔案取代。
     </para>
     <para>
      您無需搜尋整個檔案系統中的 <filename>*.rpmnew</filename> 和 <filename>*.rpmsave</filename> 檔案，最重要的檔案都已儲存在 <filename>/etc</filename> 目錄中。使用以下指令可以列出這些檔案：
     </para>
<screen><prompt>tux &gt; </prompt>find /etc -print | egrep "rpmnew$|rpmsave$"</screen>
    </listitem>
   </itemizedlist>
  </sect2>

 </sect1>

 <sect1 xml:id="sec-upgrade-offline-automated" os="sles">
  <title>使用 AutoYaST 升級</title>
  <para>
   升級程序可以自動執行。如需詳細資料，請參閱<xref linkend="CreateProfile-upgrade"/>。
  </para>
 </sect1>

 <sect1 xml:id="sec-upgrade-offline-manager">
  <title>使用 SUSE Manager 升級</title>
  <para>
   SUSE Manager 是一個伺服器解決方案，用於提供適用於 SUSE Linux Enterprise 用戶端的更新、修補程式和安全性修正程式。它隨附一組工具和一個 Web 式使用者介面，用於執行管理任務。如需 SUSE Manager 的詳細資訊，請參閱<link xlink:href="https://www.suse.com/products/suse-manager/"/>。
  </para>
  <para>
   您可以使用 SUSE Manager 來執行系統升級。透過整合的 AutoYaST 技術，可以從一個主要版本升級至下一個主要版本。
  </para>

  <para>
  如果您的機器由 SUSE Manager 管理，請依據 SUSE Manager 文件所述更新機器。<link xlink:href="https://documentation.suse.com/suma/"/> 上的《<citetitle>SUSE Manager Upgrade Guide</citetitle>》(SUSE Manager 升級指南) 中介紹了<citetitle>用戶端移轉</citetitle>程序。
 </para>
 </sect1>
 <sect1 xml:id="sec-update-reg-status-after-rollback">
  <title>復原後更新註冊狀態</title>

  <para>
   執行 Service Pack 升級時，需要在註冊伺服器上變更組態，以提供對新儲存庫的存取權限。如果升級程序被中斷或回復 (透過從備份或快照還原)，註冊伺服器上的資訊將與系統的狀態不一致。這可能會導致您無法存取更新儲存庫，或者導致在用戶端上使用錯誤的儲存庫。
  </para>

  <para>
   若透過 Snapper 進行復原，系統將會向註冊伺服器傳送通知，確保在開機過程中設定正確儲存庫的存取權限。如果使用其他方法還原了系統，或者與註冊伺服器通訊失敗，請在用戶端上手動觸發復原程序。例如，在因網路問題而無法存取伺服器時，可以手動觸發復原程序。若要復原，請執行：
  </para>

<screen><prompt>tux &gt; </prompt><command>sudo</command> <command>snapper</command> rollback</screen>

  <para>
   建議您永遠使用以下指令來檢查系統上是否已設定正確的儲存庫 (特別是在重新整理服務後)：
  </para>

<screen><prompt>tux &gt; </prompt><command>sudo</command> <command>zypper</command> ref -s</screen>

  <para>
   此功能在 
   <package>rollback-helper </package>
   套件中可用。
  </para>
 </sect1>
 <sect1 xml:id="sec-update-registersystem">


  <title>註冊系統</title>

  <para>
   如果在執行升級之前未註冊系統，您隨時都可使用 YaST 中的<guimenu>產品註冊</guimenu>模組來註冊系統。
  </para>

  <para>
   註冊系統可以獲得以下優勢：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     有資格獲得支援
    </para>
   </listitem>
   <listitem>
    <para>
     取得安全性更新和錯誤修復
    </para>
   </listitem>
   <listitem>
    <para>
     存取 SUSE Customer Center
    </para>
   </listitem>
  </itemizedlist>

  <procedure>
   <step>
    <para>
     啟動 YaST 並選取<menuchoice> <guimenu> 軟體</guimenu>
     <guimenu> 產品註冊</guimenu> </menuchoice> 以開啟<guimenu>註冊</guimenu>對話方塊。
    </para>
   </step>
   <step>
    <para>
     提供與您或您的組織用於管理訂閱的 SUSE 帳戶關聯的<guimenu>電子郵件</guimenu>地址。如果您還沒有 SUSE 帳戶，請前往 SUSE Customer Center 首頁 (<link xlink:show="new" xlink:href="https://scc.suse.com/"/>) 建立一個帳戶。
    </para>
   </step>
   <step>
    <para>
     輸入與 <guimenu>SUSE Linux Enterprise Server</guimenu> 副本一起收到的「<phrase role="productname"><phrase os="sles">註冊代碼</phrase></phrase>」。
    </para>
   </step>
   <step>
     <para>
      如果您的網路上有一個或多個本地註冊伺服器可用，您可以從清單中選擇其中一個伺服器。
     </para>
   </step>
   <step xml:id="st-y2-register-final">
    <para>
     若要開始註冊，請繼續執行<guimenu>下一步</guimenu>。
    </para>
    <para>
     成功註冊後，YaST 將列出系統可用的延伸、附加產品和模組。若要選取並安裝它們，請繼續<xref linkend="sec-add-ons-extensions"/>。
    </para>
   </step>
  </procedure>
 </sect1>

</chapter>
