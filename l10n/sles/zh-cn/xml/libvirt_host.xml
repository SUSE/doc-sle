<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="libvirt_host.xml" version="5.0" xml:id="cha-libvirt-host">
 <info>
  <title>准备 VM 主机服务器</title>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <para>
  在可以安装 Guest 虚拟机之前，需要准备好 VM 主机服务器，以便为 Guest 提供正常运行所需的资源。具体而言，您需要配置：
 </para>
 <itemizedlist>
  <listitem>
   <para>
    <emphasis>网络</emphasis>：使 Guest 能够利用主机提供的网络连接。
   </para>
  </listitem>
  <listitem>
   <para>
    一个可从主机访问的<emphasis>储存池</emphasis>，以使 Guest 能够储存其磁盘映像。
   </para>
  </listitem>
 </itemizedlist>
 <sect1 xml:id="libvirt-host-network">
  <title>配置网络</title>

  <para>
   有两个常用网络配置可为 VM Guest 提供网络连接：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     一个<emphasis>网桥</emphasis>。这是为 Guest 提供网络连接的默认方式，也是建议的方式。
    </para>
   </listitem>
   <listitem>
    <para>
     一个已启用转发的<emphasis>虚拟网络</emphasis>。
    </para>
   </listitem>
  </itemizedlist>

  <sect2 xml:id="libvirt-networks-bridged">
   <title>网桥</title>
   <para>
    网桥配置为 VM Guest 提供第 2 层交换机，可以基于与端口关联的 MAC 地址在网桥上的端口之间交换第 2 层以太网包。这样 VM Guest 便可通过第 2 层连接访问 VM 主机服务器的网络。此配置类似于将 VM Guest 的虚拟以太网网线连接到与主机以及主机上运行的其他 VM Guest 共享的集线器。该配置通常称为<emphasis>共享物理设备</emphasis>。
   </para>
   <para>
    当 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 配置为 KVM 或 Xen 超级管理程序时，网桥配置是它的默认配置。如果您只想将 VM Guest 连接到 VM 主机服务器的 LAN，则此为首选配置。
   </para>
   <para>
    要使用哪个工具创建网桥取决于您在 VM 主机服务器上使用哪个服务来管理网络连接：
   </para>
   <itemizedlist>
    <listitem>
     <para>
      如果网络连接由 <systemitem>wicked</systemitem> 管理，请使用 YaST 或命令行来创建网桥。服务器主机默认使用 <systemitem>wicked</systemitem>。
     </para>
    </listitem>
    <listitem>
     <para>
      如果网络连接由 NetworkManager 管理，请使用 NetworkManager 命令行工具 <command>nmcli</command> 创建网桥。台式机和笔记本电脑默认使用 NetworkManager。
     </para>
    </listitem>
   </itemizedlist>
   <sect3 xml:id="libvirt-networks-bridged-yast">
    <title>使用 YaST 管理网桥</title>
    <para>
     本节包含使用 YaST 添加或去除网桥的过程。
    </para>
    <sect4 xml:id="libvirt-networks-bridged-yast-add">
     <title>添加网桥</title>
     <para>
      要在 VM 主机服务器上添加网桥，请执行以下步骤：
     </para>
     <procedure>
      <step>
       <para>
        启动 <menuchoice><guimenu>YaST</guimenu><guimenu>系统</guimenu><guimenu>网络设置</guimenu></menuchoice>。
       </para>
      </step>
      <step>
       <para>
        激活<guimenu>概述</guimenu>选项卡并单击<guimenu>添加</guimenu>。
       </para>
      </step>
      <step>
       <para>
        从<guimenu>设备类型</guimenu>列表中选择<guimenu>网桥</guimenu>，然后在<guimenu>配置名称</guimenu>项中输入网桥设备接口名称。单击<guimenu>下一步</guimenu>按钮继续。
       </para>
      </step>
      <step>
       <para>
        在<guimenu>地址</guimenu>选项卡中指定网络细节，例如 DHCP/静态 IP 地址、子网掩码或主机名。
       </para>
       <para>
        仅当您也将设备指派到与 DHCP 服务器连接的网桥时，<guimenu>动态地址</guimenu>才有作用。
       </para>
       <para>
        如果您打算创建不与实际网络设备连接的虚拟网桥，请使用<guimenu>静态指派的 IP 地址</guimenu>。在这种情况下，比较好的做法是使用私用 IP 地址范围（例如 <literal>192.168.0.0/16</literal>、<literal>172.16.0.0/12</literal> 或 <literal>10.0.0.0/8</literal>）内的地址。
       </para>
       <para>
        要创建仅在不同 Guest 之间充当连接点，而不连接到主机系统的网桥，请将 IP 地址设置为 <literal>0.0.0.0</literal>，将子网掩码设置为 <literal>255.255.255.255</literal>。网络脚本会将此特殊地址作为未设置的 IP 地址来处理。
       </para>
      </step>
      <step>
       <para>
        激活<guimenu>桥接的设备</guimenu>选项卡，然后激活您要包含在网桥中的网络设备。
       </para>
      </step>
      <step>
       <para>
        单击<guimenu>下一步</guimenu>返回到<guimenu>概述</guimenu>选项卡，然后单击<guimenu>确定</guimenu>确认。现在，新网桥应在 VM 主机服务器上处于活动状态。
       </para>
      </step>
     </procedure>
    </sect4>
    <sect4 xml:id="libvirt-networks-bridged-yast-rm">
     <title>删除网桥</title>
     <para>
      要删除现有网桥，请执行以下步骤：
     </para>
     <procedure>
      <step>
       <para>
        启动 <menuchoice><guimenu>YaST</guimenu><guimenu>系统</guimenu><guimenu>网络设置</guimenu></menuchoice>。
       </para>
      </step>
      <step>
       <para>
        从<guimenu>概述</guimenu>选项卡上的列表中选择您要删除的网桥设备。
       </para>
      </step>
      <step>
       <para>
        单击<guimenu>删除</guimenu>以删除该网桥，然后单击<guimenu>确定</guimenu>确认。
       </para>
      </step>
     </procedure>
    </sect4>
   </sect3>
   <sect3 xml:id="libvirt-networks-bridged-add-brctl">
    <title>通过命令行管理网桥</title>
    <para>
     本节包含使用命令行添加或去除网桥的过程。
    </para>
    <sect4 xml:id="libvirt-networks-bridged-add-brctl-add">
     <title>添加网桥</title>
     <para>
      要在 VM 主机服务器上添加新网桥设备，请执行以下步骤：
     </para>
     <procedure>
      <step>
       <para>
        在要创建新网桥的 VM 主机服务器上以 <systemitem class="username">root</systemitem> 身份登录。
       </para>
      </step>
      <step>
       <para>
        为新网桥选择一个名称（在本示例中为 <replaceable>virbr_test</replaceable>），然后运行以下命令
       </para>
<screen><prompt role="root"># </prompt>ip link add name <replaceable>VIRBR_TEST</replaceable> type bridge</screen>
      </step>
      <step>
       <para>
        检查是否已在 VM 主机服务器上创建了网桥：
       </para>
<screen><prompt role="root"># </prompt>bridge vlan
[...]
virbr_test  1 PVID Egress Untagged
</screen>
       <para>
        <literal>virbr_test</literal> 存在，但不与任何物理网络接口相关联。
       </para>
      </step>
      <step>
       <para>
        启动该网桥，并在其中添加一个网络接口：
       </para>
<screen>
<prompt role="root"># </prompt>ip link set virbr_test up
<prompt role="root"># </prompt>ip link set eth1 master virbr_test
</screen>
       <important>
        <title>网络接口必须未被使用</title>
        <para>
         只能指派尚未被其他网桥使用的网络接口。
        </para>
       </important>
      </step>
      <step>
       <para>
        （可选）启用 STP（请参见<link xlink:href="https://en.wikipedia.org/wiki/Spanning_Tree_Protocol">生成树协议</link>）
       </para>
<screen><prompt role="root"># </prompt>bridge link set dev virbr_test cost 4</screen>
      </step>
     </procedure>
    </sect4>
    <sect4 xml:id="libvirt-networks-bridged-add-brctl-del">
     <title>删除网桥</title>
     <para>
      要通过命令行删除 VM 主机服务器上的现有网桥设备，请执行以下步骤：
     </para>
     <procedure>
      <step>
       <para>
        在要从中删除现有网桥的 VM 主机服务器上以 <systemitem class="username">root</systemitem> 身份登录。
       </para>
      </step>
      <step>
       <para>
        列出现有网桥，以识别要去除的网桥的名称：
       </para>
<screen><prompt role="root"># </prompt>bridge vlan
[...]
virbr_test  1 PVID Egress Untagged
</screen>
      </step>
      <step>
       <para>
        删除网桥：
       </para>
<screen><prompt role="root"># </prompt>ip link delete dev virbr_test</screen>
      </step>
     </procedure>
    </sect4>
   </sect3>
   <sect3 xml:id="libvirt-networks-bridged-add-nm">
    <title>使用 <command>nmcli</command> 添加网桥</title>
    <para>
     本节介绍使用 NetworkManager 的命令行工具 <command>nmcli</command> 添加网桥的过程。
    </para>
    <procedure>
     <step>
      <para>
       列出活动网络连接：
      </para>
<screen>
<prompt>&gt; </prompt><command>sudo</command> nmcli connection show --active
NAME                   UUID                                  TYPE      DEVICE
Ethernet connection 1  84ba4c22-0cfe-46b6-87bb-909be6cb1214  ethernet  eth0
</screen>
     </step>
     <step>
      <para>
       添加名为 <literal>br0</literal> 的新网桥设备，并校验是否已创建该设备：
      </para>
<screen>
<prompt>&gt; </prompt><command>sudo</command> nmcli connection add type bridge ifname br0
Connection 'bridge-br0' (36e11b95-8d5d-4a8f-9ca3-ff4180eb89f7) \
successfully added.
<prompt>&gt; </prompt><command>sudo</command> nmcli connection show --active
NAME                   UUID                                  TYPE      DEVICE
bridge-br0             36e11b95-8d5d-4a8f-9ca3-ff4180eb89f7  bridge    br0
Ethernet connection 1  84ba4c22-0cfe-46b6-87bb-909be6cb1214  ethernet  eth0
</screen>
     </step>
     <step>
      <para>
       （可选）可以查看网桥设置：
      </para>
<screen>
<prompt>&gt; </prompt><command>sudo</command> nmcli -f bridge connection show bridge-br0
bridge.mac-address:                     --
bridge.stp:                             yes
bridge.priority:                        32768
bridge.forward-delay:                   15
bridge.hello-time:                      2
bridge.max-age:                         20
bridge.ageing-time:                     300
bridge.group-forward-mask:              0
bridge.multicast-snooping:              yes
bridge.vlan-filtering:                  no
bridge.vlan-default-pvid:               1
bridge.vlans:                           --
</screen>
     </step>
     <step>
      <para>
       将网桥设备链接到物理以太网设备 <literal>eth0</literal>：
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> nmcli connection add type bridge-slave ifname eth0 master br0</screen>
     </step>
     <step>
      <para>
       禁用 <literal>eth0</literal> 接口并启用新网桥：
      </para>
<screen>
<prompt>&gt; </prompt><command>sudo</command> nmcli connection down "Ethernet connection 1"
<prompt>&gt; </prompt><command>sudo</command> nmcli connection up bridge-br0
Connection successfully activated (master waiting for slaves) \
(D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/9)
</screen>
     </step>
    </procedure>
   </sect3>
   <sect3 xml:id="sec-xen-net-vlan">
    <title>使用 VLAN 接口</title>
    <para>
     有时需要在两台 VM 主机服务器之间或者 VM Guest 系统之间创建私用连接。例如，将 VM Guest 迁移到其他网段中的主机时，或者创建只有 VM Guest 系统能够连接到的私用网桥（即使是在不同 VM 主机服务器系统上运行）时。构建此类连接的简单方法是设置 VLAN 网络。
    </para>
    <para>
     VLAN 接口通常在 VM 主机服务器上设置。它们可以将不同的 VM 主机服务器系统互连，或者可以设置为其他仅限虚拟连接的网桥的物理接口。甚至可以创建一个使用 VLAN 作为物理接口（该接口在 VM 主机服务器中没有 IP 地址）的网桥。这样，Guest 系统就无法通过此网络访问主机。
    </para>
    <para>
     运行 YaST 模块<menuchoice><guimenu>系统</guimenu><guimenu>网络设置</guimenu></menuchoice>。执行以下过程设置 VLAN 设备：
    </para>
    <procedure>
     <title>使用 YaST 设置 VLAN 接口</title>
     <step>
      <para>
       单击<guimenu>添加</guimenu>以创建新网络接口。
      </para>
     </step>
     <step>
      <para>
       在<guimenu>硬件</guimenu>对话框中，选择<guimenu>设备类型</guimenu> <guimenu>VLAN</guimenu>。
      </para>
     </step>
     <step>
      <para>
       将<guimenu>配置名称</guimenu>的值更改为 VLAN 的 ID。请注意，VLAN ID <literal>1</literal> 通常用于管理目的。
      </para>
     </step>
     <step>
      <para>
       单击<guimenu>下一步</guimenu>。
      </para>
     </step>
     <step>
      <para>
       将 VLAN 设备应连接到的借口选择为下面的 <guimenu>VLAN 的实际接口</guimenu>。如果所需的接口未显示在列表中，请先在不指定 IP 地址的情况下设置此接口。
      </para>
     </step>
     <step>
      <para>
       选择将 IP 地址指派到 VLAN 设备的所需方法。
      </para>
     </step>
     <step>
      <para>
       单击<guimenu>下一步</guimenu>完成配置。
      </para>
     </step>
    </procedure>
    <para>
     还可将 VLAN 接口用作网桥的物理接口。这样便可以连接多个仅限 VM 主机服务器的网络，以及实时迁移与此类网络连接的 VM Guest 系统。
    </para>
    <para>
     YaST 并非始终允许不设置 IP 地址。但有时可能需要这种功能，尤其是应该连接仅限 VM 主机服务器的网络时。在这种情况下，请使用特殊地址 <literal>0.0.0.0</literal> 和网络掩码 <literal>255.255.255.255</literal>。系统脚本会将此地址当作未设置 IP 地址来处理。
    </para>
   </sect3>
  </sect2>

  <sect2 xml:id="libvirt-networks-virtual">
   <title>虚拟网络</title>
   <para>
    <systemitem class="library">libvirt</systemitem> 管理的虚拟网络类似于桥接的网络，但通常不与 VM 主机服务器建立第 2 层连接。与 VM 主机服务器物理网络的连接通过第 3 层转发来实现，与第 2 层桥接网络相比，第 3 层转发在 VM 主机服务器上引入了额外的包处理。虚拟网络还为 VM Guest 提供 DHCP 和 DNS 服务。有关 <systemitem class="library">libvirt</systemitem> 虚拟网络的详细信息，请参见 <link xlink:href="https://libvirt.org/formatnetwork.html"/> 上的《<citetitle>Network XML format</citetitle>》（网络 XML 格式）文档。
   </para>
   <para>
    <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 上的标准 <systemitem class="library">libvirt</systemitem> 安装中已预定义了一个名为 <literal>default</literal> 的虚拟网络。该虚拟网络提供网络的 DHCP 和 DNS 服务，并可使用网络地址转换 (NAT) 转发模式连接到 VM 主机服务器的物理网络。尽管 <literal>default</literal> 虚拟网络是预定义的，但它需要由管理员显式启用。有关 <systemitem class="library">libvirt</systemitem> 支持的转发模式的详细信息，请参见 <link xlink:href="https://libvirt.org/formatnetwork.html#elementsConnect"/> 上《<citetitle>Network XML format</citetitle>》（网络 XML 格式）文档中的“<citetitle>Connectivity</citetitle>”（连接）一节。
   </para>
   <para>
    <systemitem class="library">libvirt</systemitem> 管理的虚拟网络可用于满足各种用例，但通常是在进行无线连接或动态/零星网络连接的 VM 主机服务器（例如便携式计算机）上使用。虚拟网络也适用于 VM 主机服务器网络的 IP 地址有限的情形，可用来在虚拟网络与 VM 主机服务器的网络之间转发包。不过，大多数服务器用例更适合网桥配置，其中的 VM Guest 会连接到 VM 主机服务器的 LAN。
   </para>
   <warning>
    <title>启用转发模式</title>
    <para>
     在 <systemitem class="library">libvirt</systemitem> 虚拟网络中启用转发模式会通过将 <filename>/proc/sys/net/ipv4/ip_forward</filename> 和 <filename>/proc/sys/net/ipv6/conf/all/forwarding</filename> 设置为 1 在 VM 主机服务器中启用转发，而这本质上是将 VM 主机服务器转变成路由器。重启动 VM 主机服务器的网络可能会重设置值并禁用转发。要避免这种行为，请通过编辑 <filename>/etc/sysctl.conf</filename> 文件并添加以下设置，在 VM 主机服务器中显式启用转发：
    </para>
<screen>net.ipv4.ip_forward = 1</screen>
<screen>net.ipv6.conf.all.forwarding = 1</screen>
   </warning>
   <sect3 xml:id="libvirt-networks-virtual-vmm">
    <title>使用虚拟机管理器管理虚拟网络</title>
    <para>
     您可以使用虚拟机管理器定义、配置和操作虚拟网络。
    </para>
    <sect4 xml:id="libvirt-networks-virtual-vmm-define">
     <title>定义虚拟网络</title>
     <procedure>
      <step>
       <para>
        启动虚拟机管理器。在可用连接列表中，右键单击您需要为其配置虚拟网络的连接名称，然后选择<guimenu>细节</guimenu>。
       </para>
      </step>
      <step>
       <para>
        在<guimenu>连接细节</guimenu>窗口中，单击<guimenu>虚拟网络</guimenu>选项卡。您会看到可用于当前连接的所有虚拟网络的列表。右侧会显示选定虚拟网络的细节。
       </para>
       <figure>
        <title>连接细节</title>
        <mediaobject>
         <imageobject role="fo">
          <imagedata fileref="libvirt_vmm_conndetails.png" width="45%"/>
         </imageobject>
         <imageobject role="html">
          <imagedata fileref="libvirt_vmm_conndetails.png" width="45%"/>
         </imageobject>
        </mediaobject>
       </figure>
      </step>
      <step>
       <para>
        要添加新虚拟网络，请单击<guimenu>添加</guimenu>。
       </para>
      </step>
      <step>
       <para>
        为新虚拟机指定名称。
       </para>
       <figure>
        <title>创建虚拟网络</title>
        <mediaobject>
         <imageobject role="fo">
          <imagedata fileref="libvirt_vmm_vnet_ipv4.png" width="45%"/>
         </imageobject>
         <imageobject role="html">
          <imagedata fileref="libvirt_vmm_vnet_ipv4.png" width="45%"/>
         </imageobject>
        </mediaobject>
       </figure>
      </step>
      <step>
       <para>
        指定网络模式。对于 <guimenu>NAT</guimenu> 和<guimenu>路由</guimenu>类型，可以指定要将网络通讯转发到的设备。<guimenu>NAT</guimenu>（网络地址转换）会重新映射虚拟网络地址空间并允许共享单个 IP 地址，<guimenu>路由</guimenu>不会对来自虚拟网络的数据包进行任何转换即将其转发到 VM 主机服务器的物理网络。
       </para>
      </step>
      <step>
       <para>
        如果您需要 IPv4 网络，请选中<guimenu>启用 IPv4</guimenu> 并指定 IPv4 网络地址。如果您需要 DHCP 服务器，请选中<guimenu>启用 DHCPv4</guimenu> 并指定可指派的 IP 地址范围。
       </para>
      </step>
      <step>
       <para>
        如果您需要 IPv6 网络，请选中<guimenu>启用 IPv6</guimenu> 并指定 IPv6 网络地址。如果您需要 DHCP 服务器，请选中<guimenu>启用 DHCPv6</guimenu> 并指定可指派的 IP 地址范围。
       </para>
      </step>
      <step>
       <para>
        如果您要指定与虚拟网络名称不同的域名，请在 <guimenu>DNS 域名</guimenu>下选择<guimenu>自定义</guimenu>，并在此处输入所需的域名。
       </para>
      </step>
      <step>
       <para>
        单击<guimenu>完成</guimenu>以创建新虚拟网络。VM 主机服务器上即会有一个新的虚拟网桥 <literal>virbr<replaceable>X</replaceable></literal>，该网桥对应于新建的虚拟网络。您可以使用 <command>bridge link</command> 进行检查。<systemitem class="library">libvirt</systemitem> 会自动添加 iptables 规则来允许传入/传出挂接到新 <emphasis>virbr<replaceable>X</replaceable></emphasis> 设备的 Guest 的流量。
       </para>
      </step>
     </procedure>
    </sect4>
    <sect4 xml:id="libvirt-networks-virtual-vmm-start">
     <title>启动虚拟网络</title>
     <para>
      要启动某个暂时停止的虚拟网络，请执行以下步骤：
     </para>
     <procedure>
      <step>
       <para>
        启动虚拟机管理器。在可用连接列表中，右键单击您需要为其配置虚拟网络的连接名称，然后选择<guimenu>细节</guimenu>。
       </para>
      </step>
      <step>
       <para>
        在<guimenu>连接细节</guimenu>窗口中，单击<guimenu>虚拟网络</guimenu>选项卡。您会看到可用于当前连接的所有虚拟网络的列表。
       </para>
      </step>
      <step>
       <para>
        要启动虚拟网络，请单击<guimenu>启动</guimenu>。
       </para>
      </step>
     </procedure>
    </sect4>
    <sect4 xml:id="libvirt-networks-virtual-vmm-stop">
     <title>停止虚拟网络</title>
     <para>
      要停止活动的虚拟网络，请执行以下步骤：
     </para>
     <procedure>
      <step>
       <para>
        启动虚拟机管理器。在可用连接列表中，右键单击您需要为其配置虚拟网络的连接名称，然后选择<guimenu>细节</guimenu>。
       </para>
      </step>
      <step>
       <para>
        在<guimenu>连接细节</guimenu>窗口中，单击<guimenu>虚拟网络</guimenu>选项卡。您会看到可用于当前连接的所有虚拟网络的列表。
       </para>
      </step>
      <step>
       <para>
        选择要停止的虚拟网络，然后单击<guimenu>停止</guimenu>。
       </para>
      </step>
     </procedure>
    </sect4>
    <sect4 xml:id="libvirt-networks-virtual-vmm-delete">
     <title>删除虚拟网络</title>
     <para>
      要删除 VM 主机服务器中的虚拟网络，请执行以下步骤：
     </para>
     <procedure>
      <step>
       <para>
        启动虚拟机管理器。在可用连接列表中，右键单击您需要为其配置虚拟网络的连接名称，然后选择<guimenu>细节</guimenu>。
       </para>
      </step>
      <step>
       <para>
        在<guimenu>连接细节</guimenu>窗口中，单击<guimenu>虚拟网络</guimenu>选项卡。您会看到可用于当前连接的所有虚拟网络的列表。
       </para>
      </step>
      <step>
       <para>
        选择要删除的虚拟网络，然后单击<guimenu>删除</guimenu>。
       </para>
      </step>
     </procedure>
    </sect4>
    <sect4 xml:id="libvirt-networks-virtual-vmm-nsswitch">

     <title>使用 <command>nsswitch</command> 获取 NAT 网络的 IP 地址（在 KVM 中）</title>
     <itemizedlist>
      <listitem>
       <para>
        在 VM 主机服务器上，安装用来为 libvirt 提供 NSS 支持的 libvirt-nss：
       </para>
<screen><prompt>&gt; </prompt><command>sudo</command> zypper in libvirt-nss</screen>
      </listitem>
      <listitem>
       <para>
        将 <literal>libvirt</literal> 添加到 <filename>/etc/nsswitch.conf</filename>：
       </para>
<screen>...
hosts:  files libvirt mdns_minimal [NOTFOUND=return] dns
...</screen>
      </listitem>
      <listitem>
       <para>
        如果 NSCD 正在运行，请将其重启动：
       </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl restart nscd</screen>
      </listitem>
     </itemizedlist>
     <para>
      现在，您可以从主机按名称访问 Guest 系统了。
     </para>
     <para>
      NSS 模块的功能有限。它会读取 <filename>/var/lib/libvirt/dnsmasq/*.status</filename> 文件，以在描述 <command>dnsmasq</command> 所提供的每个租约的 JSON 记录中查找主机名和对应的 IP 地址。只能使用受 <command>dnsmasq</command> 支持且由 libvirt 管理的桥接网络在这些 VM 主机服务器上执行主机名转换。
     </para>
    </sect4>
   </sect3>
   <sect3 xml:id="libvirt-networks-virtual-virsh">
    <title>使用 <command>virsh</command> 管理虚拟网络</title>
    <para>
     您可以使用 <command>virsh</command> 命令行工具来管理 <systemitem class="library">libvirt</systemitem> 提供的虚拟网络。要查看所有与网络相关的 <command>virsh</command> 命令，请运行以下命令
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> virsh help network
Networking (help keyword 'network'):
 net-autostart                  autostart a network
        net-create                     create a network from an XML file
        net-define                     define (but don't start) a network from an XML file
        net-destroy                    destroy (stop) a network
        net-dumpxml                    network information in XML
        net-edit                       edit XML configuration for a network
        net-event                      Network Events
        net-info                       network information
        net-list                       list networks
        net-name                       convert a network UUID to network name
        net-start                      start a (previously defined) inactive network
        net-undefine                   undefine an inactive network
        net-update                     update parts of an existing network's configuration
 net-uuid                       convert a network name to network UUID</screen>
    <para>
     要查看特定 <command>virsh</command> 命令的简要帮助信息，请运行 <command>virsh help <replaceable>VIRSH_COMMAND</replaceable></command>：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> virsh help net-create
  NAME
    net-create - create a network from an XML file

  SYNOPSIS
    net-create &lt;file&gt;

  DESCRIPTION
    Create a network.

  OPTIONS
    [--file] &lt;string&gt;  file containing an XML network description</screen>
    <sect4 xml:id="libvirt-networks-virtual-virsh-create">
     <title>创建网络</title>

     <para>
      要创建新的<emphasis>运行中</emphasis>虚拟网络，请运行以下命令
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> virsh net-create <replaceable>VNET_DEFINITION.xml</replaceable></screen>
     <para>
      <replaceable>VNET_DEFINITION.xml</replaceable> XML 文件包含 <systemitem class="library">libvirt</systemitem> 接受的虚拟网络的定义。
     </para>
     <para>
      要定义新虚拟网络但不激活它，请运行以下命令
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> virsh net-define <replaceable>VNET_DEFINITION.xml</replaceable></screen>
     <para>
      以下示例说明了不同类型的虚拟网络的定义。
     </para>
     <example xml:id="ex-libvirt-net-nat">
      <title>基于 NAT 的网络</title>
      <para>
       下面的配置允许进行 VM Guest 传出连接（如果 VM 主机服务器上提供此功能）。当没有 VM 主机服务器网络时，此配置可让 Guest 互相直接通讯。
      </para>
<screen>
&lt;network&gt;
&lt;name&gt;vnet_nated&lt;/name&gt;<co xml:id="vnet-xml-name"/>
&lt;bridge name="virbr1"/&gt;<co xml:id="vnet-xml-bridge"/>
 &lt;forward mode="nat"/&gt;<co xml:id="vnet-xml-forward"/>
 &lt;ip address="192.168.122.1" netmask="255.255.255.0"&gt;<co xml:id="vnet-xml-ip"/>
  &lt;dhcp&gt;
   &lt;range start="192.168.122.2" end="192.168.122.254"/&gt;<co xml:id="vnet-xml-dhcp"/>
   &lt;host mac="52:54:00:c7:92:da" name="host1.testing.com" \
    ip="192.168.1.23.101"/&gt;<co xml:id="vnet-xml-dhcp-host"/>
   &lt;host mac="52:54:00:c7:92:db" name="host2.testing.com" \
    ip="192.168.1.23.102"/&gt;
   &lt;host mac="52:54:00:c7:92:dc" name="host3.testing.com" \
    ip="192.168.1.23.103"/&gt;
  &lt;/dhcp&gt;
 &lt;/ip&gt;
&lt;/network&gt;
</screen>
      <calloutlist>
       <callout arearefs="vnet-xml-name">
        <para>
         新虚拟网络的名称。
        </para>
       </callout>
       <callout arearefs="vnet-xml-bridge">
        <para>
         用于构造虚拟网络的网桥设备的名称。定义 &lt;forward&gt; 模式为“<literal>nat</literal>”或“<literal>route</literal>”的新网络（或者不包含 &lt;forward&gt; 元素的隔离网络）时，<systemitem class="library">libvirt</systemitem> 将自动为网桥设备生成唯一的名称（如果未指定名称）。
        </para>
       </callout>
       <callout arearefs="vnet-xml-forward">
        <para>
         包含 &lt;forward&gt; 元素表示该虚拟网络将连接到物理 LAN。<literal>mode</literal> 属性指定转发方法。最常用的模式为“<literal>nat</literal>”（网络地址转换，默认值）、“<literal>route</literal>”（直接转发到物理网络，不执行地址转换）和“<literal>bridge</literal>”（在 <systemitem class="library">libvirt</systemitem> 外部配置的网桥）。如果不指定 &lt;forward&gt; 元素，虚拟网络将与其他网络相隔离。有关转发模式的完整列表，请参见 <link xlink:href="https://libvirt.org/formatnetwork.html#elementsConnect"/>。
        </para>
       </callout>
       <callout arearefs="vnet-xml-ip">
        <para>
         网桥的 IP 地址和网络掩码。
        </para>
       </callout>
       <callout arearefs="vnet-xml-dhcp">
        <para>
         为虚拟网络启用 DHCP 服务器，并提供 <literal>start</literal> 和 <literal>end</literal> 属性所指定的范围内的 IP 地址。
        </para>
       </callout>
       <callout arearefs="vnet-xml-dhcp-host">
        <para>
         可选的 &lt;host&gt; 元素指定内置 DHCP 服务器要为其分配名称和预定义 IP 地址的主机。任何 IPv4 host 元素都必须指定以下设置：要为其指派给定名称的主机的 MAC 地址、要指派到该主机的 IP，以及 DHCP 服务器要为该主机分配的名称。IPv6 host 元素与 IPv4 略有不同，它没有 <literal>mac</literal> 属性，因为 MAC 地址在 IPv6 中没有明确的含义。IPv6 中使用 <literal>name</literal> 属性来标识要为其指派 IPv6 地址的主机。对于 DHCPv6，<literal>name</literal> 是由客户端发送到服务器的客户端主机的纯文本名称。请注意，您也可以使用这种指派特定 IP 地址的方法来代替 IPv4 中的 <literal>mac</literal> 属性。
        </para>
       </callout>
      </calloutlist>
     </example>
     <example>
      <title>路由网络</title>
      <para>
       下面的配置会在不应用任何 NAT 的情况下将流量从虚拟网络路由到 LAN。必须在 VM 主机服务器网络上的路由器的路由表中预定义 IP 地址范围。
      </para>
<screen>
&lt;network&gt;
 &lt;name&gt;vnet_routed&lt;/name&gt;
 &lt;bridge name="virbr1"/&gt;
 &lt;forward mode="route" dev="eth1"/&gt;<co xml:id="vnet-xml-route"/>
 &lt;ip address="192.168.122.1" netmask="255.255.255.0"&gt;
  &lt;dhcp&gt;
   &lt;range start="192.168.122.2" end="192.168.122.254"/&gt;
  &lt;/dhcp&gt;
 &lt;/ip&gt;
&lt;/network&gt;
</screen>
      <calloutlist>
       <callout arearefs="vnet-xml-route">
        <para>
         Guest 流量只能通过 VM 主机服务器上的 <systemitem>eth1</systemitem> 网络设备传出。
        </para>
       </callout>
      </calloutlist>
     </example>
     <example>
      <title>隔离网络</title>
      <para>
       此配置提供完全隔离的专用网络。Guest 可以相互通讯以及与 VM 主机服务器通讯，但无法访问 LAN 上的任何其他计算机，因为 XML 说明中没有 &lt;forward&gt; 元素。
      </para>
<screen>&lt;network&gt;
 &lt;name&gt;vnet_isolated&lt;/name&gt;
 &lt;bridge name="virbr3"/&gt;
 &lt;ip address="192.168.152.1" netmask="255.255.255.0"&gt;
  &lt;dhcp&gt;
   &lt;range start="192.168.152.2" end="192.168.152.254"/&gt;
  &lt;/dhcp&gt;
 &lt;/ip&gt;
 &lt;/network&gt;
</screen>
     </example>
     <example>
      <title>使用 VM 主机服务器上的现有网桥</title>
      <para>
       此配置说明如何使用 VM 主机服务器的现有网桥 <literal>br0</literal>。VM Guest 直接连接到物理网络。其 IP 地址全部都在物理网络的子网中，并且传入和传出连接不存在任何限制。
      </para>
<screen>&lt;network&gt;
        &lt;name&gt;host-bridge&lt;/name&gt;
        &lt;forward mode="bridge"/&gt;
        &lt;bridge name="br0"/&gt;
&lt;/network&gt;
</screen>
     </example>
    </sect4>
    <sect4 xml:id="libvirt-networks-virtual-virsh-list">
     <title>列出网络</title>
     <para>
      要列出 <systemitem class="library">libvirt</systemitem> 可用的所有虚拟网络，请运行以下命令：
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> virsh net-list --all

 Name                 State      Autostart     Persistent
----------------------------------------------------------
 crowbar              active     yes           yes
 vnet_nated           active     yes           yes
 vnet_routed          active     yes           yes
 vnet_isolated        inactive   yes           yes</screen>

     <para>
      要列出可用域，请运行以下命令：
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> virsh list
 Id    Name                           State
----------------------------------------------------
 1     nated_sles12sp3                running
 ...</screen>
     <para>
      要获取运行中域的接口列表，请运行 <option>domifaddr <replaceable>DOMAIN</replaceable></option>，或选择性地指定接口，以在输出中仅列出此接口。默认情况下，会额外输出接口的 IP 和 MAC 地址：
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> virsh domifaddr nated_sles12sp3 --interface vnet0 --source lease
 Name       MAC address          Protocol     Address
-------------------------------------------------------------------------------
 vnet0      52:54:00:9e:0d:2b    ipv6         fd00:dead:beef:55::140/64
 -          -                    ipv4         192.168.100.168/24</screen>
     <para>
      要列显与指定域关联的所有虚拟接口的简要信息，请运行以下命令：
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> virsh domiflist nated_sles12sp3
Interface  Type       Source       Model       MAC
---------------------------------------------------------
vnet0      network    vnet_nated   virtio      52:54:00:9e:0d:2b</screen>
    </sect4>
    <sect4 xml:id="libvirt-networks-virtual-virsh-info">
     <title>获取有关网络的细节</title>
     <para>
      要获取有关网络的详细信息，请运行以下命令：
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> virsh net-info vnet_routed
Name:           vnet_routed
UUID:           756b48ff-d0c6-4c0a-804c-86c4c832a498
Active:         yes
Persistent:     yes
Autostart:      yes
Bridge:         virbr5</screen>
    </sect4>
    <sect4 xml:id="libvirt-networks-virtual-virsh-start">
     <title>启动网络</title>
     <para>
      要启动某个已定义的非活动网络，请使用以下命令查找其名称（或唯一标识符，即 UUID）：
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> virsh net-list --inactive
 Name                 State      Autostart     Persistent
----------------------------------------------------------
 vnet_isolated        inactive   yes           yes</screen>
     <para>
      然后运行:
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> virsh net-start vnet_isolated
Network vnet_isolated started</screen>
    </sect4>
    <sect4 xml:id="libvirt-networks-virtual-virsh-stop">
     <title>停止网络</title>
     <para>
      要停止某个活动的网络，请使用以下命令查找其名称（或唯一标识符，即 UUID）：
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> virsh net-list --inactive
 Name                 State      Autostart     Persistent
----------------------------------------------------------
 vnet_isolated        active     yes           yes</screen>
     <para>
      然后运行:
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> virsh net-destroy vnet_isolated
Network vnet_isolated destroyed</screen>
    </sect4>
    <sect4 xml:id="libvirt-networks-virtual-virsh-undefine">
     <title>去除网络</title>
     <para>
      要从 VM 主机服务器中永久去除某个非活动网络的定义，请运行以下命令：
     </para>
<screen><prompt>&gt; </prompt><command>sudo</command> virsh net-undefine vnet_isolated
Network vnet_isolated has been undefined</screen>
    </sect4>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="libvirt-host-storage">
  <title>配置储存池</title>

  <para>
   在 VM 主机服务器本身上管理 VM Guest 时，您可以访问 VM 主机服务器的整个文件系统，以挂接或创建虚拟硬盘，或将现有映像挂接到 VM Guest。但通过远程主机管理 VM Guest 时无法做到这些。出于此原因，<systemitem class="library">libvirt</systemitem> 支持可从远程计算机访问的所谓<quote>储存池</quote>。
  </para>

  <tip>
   <title>CD/DVD ISO 映像</title>
   <para>
    如果希望能够从远程客户端访问 VM 主机服务器上的 CD/DVD ISO 映像，需要将这些映像也放在储存池中。
   </para>
  </tip>

  <para>
   <systemitem class="library">libvirt</systemitem> 可识别两种不同类型的储存资源：卷和池。
  </para>

  <variablelist>
   <varlistentry>
    <term>储存卷</term>
    <listitem>
     <para>
      储存卷是可指派到 Guest 的储存设备 — 虚拟磁盘或 CD/DVD/软盘映像。从物理上讲，它可以是块设备（例如分区或逻辑卷），也可以是 VM 主机服务器上的某个文件。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>储存池</term>
    <listitem>
     <para>
      储存池是 VM 主机服务器上可用于储存卷的储存资源，类似于台式计算机的网络储存。从物理上而言，它可分为以下类型之一：
     </para>
     <variablelist>
      <varlistentry>
       <term>文件系统目录 (<guimenu>dir</guimenu>)</term>
       <listitem>
        <para>
         用于存放映像文件的目录。文件可以是支持的磁盘格式之一（raw 或 qcow2），也可以是 ISO 映像。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>物理磁盘设备 (<guimenu>disk</guimenu>)</term>
       <listitem>
        <para>
         使用整个物理磁盘作为储存空间。系统会为添加到池的每个卷创建一个分区。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>预格式化的块设备 (<guimenu>fs</guimenu>)</term>
       <listitem>
        <para>
         指定要使用的分区，该分区与文件系统目录池（用于存放映像文件的目录）的使用方式相同。唯一的区别在于，使用文件系统目录时，<systemitem class="library">libvirt</systemitem> 会负责挂载设备。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>iSCSI 目标 (iscsi)</term>
       <listitem>
        <para>
         在 iSCSI 目标上设置池。您需要先登录卷一次才能将卷用于 <systemitem class="library">libvirt</systemitem>。使用 YaST <guimenu>iSCSI 发起端</guimenu>来检测和登录卷<phrase os="sles">，有关细节，请参见<xref linkend="book-storage"/></phrase>。不支持在 iSCSI 池中创建卷；每个现有逻辑单元号 (LUN) 都代表一个卷。每个卷/LUN 还需要一个有效的（空）分区表或磁盘标签，这样您才能使用该卷。如果没有分区表或磁盘标签，请使用 <command>fdisk</command> 添加：
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> fdisk -cu /dev/disk/by-path/ip-192.168.2.100:3260-iscsi-iqn.2010-10.com.example:[...]-lun-2
Device contains neither a valid DOS partition table, nor Sun, SGI
or OSF disklabel
Building a new DOS disklabel with disk identifier 0xc15cdc4e.
Changes will remain in memory only, until you decide to write them.
After that, of course, the previous content won't be recoverable.

Warning: invalid flag 0x0000 of partition table 4 will be corrected by w(rite)

Command (m for help): w
The partition table has been altered!

Calling ioctl() to re-read partition table.
Syncing disks.</screen>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>LVM 卷组 (logical)</term>
       <listitem>
        <para>
         使用 LVM 卷组作为池。您可以使用预定义的卷组，或者通过指定要使用的设备来创建组。储存卷会创建为卷上的分区。
        </para>
        <warning>
         <title>删除基于 LVM 的池</title>
         <para>
          在储存管理器中删除基于 LVM 的池时，也会删除卷组。这会导致池中储存的所有数据丢失且不可恢复！
         </para>
        </warning>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>多路径设备 (<guimenu>mpath</guimenu>)</term>
       <listitem>
        <para>
         目前，多路径支持仅限于向 Guest 指派现有设备。不支持从 <systemitem class="library">libvirt</systemitem> 内部创建卷或配置多路径。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>网络导出的目录 (<guimenu>netfs</guimenu>)</term>
       <listitem>
        <para>
         指定要使用的网络目录，该网络目录与文件系统目录池（用于存放映像文件的目录）的使用方式相同。唯一的区别在于，使用文件系统目录时，<systemitem class="library">libvirt</systemitem> 会负责挂载目录。支持的协议为 NFS。
        </para>
       </listitem>
      </varlistentry>


      <varlistentry>
       <term>SCSI 主机适配器 (<guimenu>scsi</guimenu>)</term>
       <listitem>
        <para>
         SCSI 主机适配器的使用方式与 iSCSI 目标基本相同。我们建议使用基于 <filename>/dev/disk/by-*</filename> 的设备名称而不是 <filename>/dev/sd<replaceable>X</replaceable></filename>。后者可能会发生变化（例如，添加或拆除硬盘时）。不支持在 iSCSI 池中创建卷。每个现有 LUN（逻辑单元号）都代表一个卷。
        </para>
       </listitem>
      </varlistentry>
     </variablelist>
    </listitem>
   </varlistentry>
  </variablelist>

  <warning>
   <title>安全考虑因素</title>
   <para>
    为了避免数据丢失或损坏，请不要尝试使用也用于在 VM 主机服务器上构建储存池的资源，例如 LVM 卷组、iSCSI 目标等。无需从 VM 主机服务器连接到这些资源，也无需在 VM 主机服务器上挂载这些资源 — <systemitem class="library">libvirt</systemitem> 将负责这些事项。
   </para>
   <para>
    不要在 VM 主机服务器上按标签挂载分区。在某些情况下，分区可能是从 VM Guest 内部使用 VM 主机服务器上已有的名称标记的。
   </para>
  </warning>

  <sect2 xml:id="sec-libvirt-storage-virsh">
   <title>使用 <command>virsh</command> 管理储存设备</title>
   <para>
    您也可以使用 <command>virsh</command> 通过命令行管理储存。不过，SUSE 目前不支持创建储存池。因此，本节仅会介绍启动、停止和删除池以及卷管理等功能。
   </para>
   <para>
    运行 <command>virsh help pool</command> 和 <command>virsh help volume</command> 可分别获取用于管理池和卷的所有 <command>virsh</command> 子命令列表。
   </para>
   <sect3 xml:id="sec-libvirt-storage-virsh-list-pools">
    <title>列出池和卷</title>
    <para>
     执行以下命令可以列出当前处于活动状态的所有池。要同时列出非活动池，请添加选项 <option>--all</option>：
    </para>
<screen><prompt>&gt; </prompt>virsh pool-list --details</screen>
    <para>
     可以使用 <literal>pool-info</literal> 子命令获取有关特定池的细节：
    </para>
<screen><prompt>&gt; </prompt>virsh pool-info <replaceable>POOL</replaceable></screen>
    <para>
     默认情况下，只能按池列出卷。要列出某个池中的所有卷，请输入以下命令。
    </para>
<screen><prompt>&gt; </prompt>virsh vol-list --details <replaceable>POOL</replaceable></screen>
    <para>
     目前，<command>virsh</command> 不提供任何可显示某个卷是否已由 Guest 使用的工具。下面的过程说明如何列出所有池中当前已被 VM Guest 使用的卷。
    </para>
    <procedure xml:id="pro-libvirt-storage-virsh-list-vols">
     <title>列出 VM 主机服务器上当前使用的所有储存卷</title>
     <step>
      <para>
       将以下内容保存到某个文件（例如 ~/libvirt/guest_storage_list.xsl）来创建一个 XSLT 样式表：
      </para>
<screen>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;xsl:stylesheet version="1.0"
  xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:output method="text"/&gt;
  &lt;xsl:template match="text()"/&gt;
  &lt;xsl:strip-space elements="*"/&gt;
  &lt;xsl:template match="disk"&gt;
    &lt;xsl:text&gt;  &lt;/xsl:text&gt;
    &lt;xsl:value-of select="(source/@file|source/@dev|source/@dir)[1]"/&gt;
    &lt;xsl:text&gt;&amp;#10;&lt;/xsl:text&gt;
  &lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;</screen>
     </step>
     <step>
      <para>
       在外壳中运行以下命令：假设 Guest 的 XML 定义全部储存在默认位置 (<filename>/etc/libvirt/qemu</filename>)。<command>xsltproc</command> 由软件包 <systemitem class="resource">libxslt</systemitem> 提供。
      </para>
<screen>SSHEET="$HOME/libvirt/guest_storage_list.xsl"
cd /etc/libvirt/qemu
for FILE in *.xml; do
  basename $FILE .xml
  xsltproc $SSHEET $FILE
done</screen>
     </step>
    </procedure>
   </sect3>
   <sect3 xml:id="sec-libvirt-storage-virsh-start-pools">
    <title>启动、停止和删除池</title>
    <para>
     使用 <command>virsh</command> pool 子命令来启动、停止或删除池。在以下示例中，请将 <replaceable>POOL</replaceable> 替换为池的名称或其 UUID：
    </para>
    <variablelist>
     <varlistentry>
      <term>停止池</term>
      <listitem>
<screen><prompt>&gt; </prompt>virsh pool-destroy <replaceable>POOL</replaceable></screen>
       <note>
        <title>池的状态不会影响挂接的卷</title>
        <para>
         无论池处于什么状态（<guimenu>活动</guimenu>（已停止）或<guimenu>非活动</guimenu>（已启动）），池中挂接到 VM Guest 的卷都始终可用。池的状态只会影响到能否通过远程管理将卷挂接到 VM Guest。
        </para>
       </note>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>删除存储池</term>
      <listitem>
<screen><prompt>&gt; </prompt>virsh pool-delete <replaceable>POOL</replaceable></screen>
       <warning>
        <title>删除储存池</title>
        <para>
         请参见<xref linkend="deleting-storage-pools"/>
        </para>
       </warning>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>启动池</term>
      <listitem>
<screen><prompt>&gt; </prompt>virsh pool-start <replaceable>POOL</replaceable></screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>启用池自动启动功能</term>
      <listitem>
<screen><prompt>&gt; </prompt>virsh pool-autostart <replaceable>POOL</replaceable></screen>
       <para>
        只有标记为 autostart 的池才会自动在 VM 主机服务器重引导时启动。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>禁用池自动启动功能</term>
      <listitem>
<screen><prompt>&gt; </prompt>virsh pool-autostart <replaceable>POOL</replaceable> --disable</screen>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="sec-libvirt-storage-virsh-add-volumes">
    <title>将卷添加到储存池</title>
    <para>
     <command>virsh</command> 提供了两种将卷添加到储存池的方法：在 XML 定义中使用 <literal>vol-create</literal> 和 <literal>vol-create-from</literal> 添加，或者使用 <literal>vol-create-as</literal> 通过命令行参数添加。SUSE 目前不支持前一种方法，因此本节重点介绍 <literal>vol-create-as</literal> 子命令。
    </para>
    <para>
     要将卷添加到现有池，请输入以下命令：
    </para>
<screen><prompt>&gt; </prompt>virsh vol-create-as <replaceable>POOL</replaceable><co xml:id="co-vol-create-as-pool"/><replaceable>NAME</replaceable><co xml:id="co-vol-create-as-name"/> 12G --format<co xml:id="co-vol-create-as-capacity"/><replaceable>raw|qcow2</replaceable><co xml:id="co-vol-create-as-format"/> --allocation 4G<co xml:id="co-vol-create-as-alloc"/></screen>
    <calloutlist>
     <callout arearefs="co-vol-create-as-pool">
      <para>
       卷要添加到的池的名称
      </para>
     </callout>
     <callout arearefs="co-vol-create-as-name">
      <para>
       卷的名称
      </para>
     </callout>
     <callout arearefs="co-vol-create-as-capacity">
      <para>
       卷的大小，在本示例中为 12 GB。使用后缀 k、M、G、T 来分别表示千字节、兆字节、千兆字节和万亿字节。
      </para>
     </callout>
     <callout arearefs="co-vol-create-as-format">
      <para>
       卷的格式。SUSE 目前支持 <literal>raw</literal> 和 <literal>qcow2</literal>。
      </para>
     </callout>
     <callout arearefs="co-vol-create-as-alloc">
      <para>
       可选的参数。默认情况下，<command>virsh</command> 将创建一个按需增长的稀疏映像文件。使用此参数指定应分配的空间量（本示例中为 4 GB）。使用后缀 k、M、G、T 来分别表示千字节、兆字节、千兆字节和万亿字节。
      </para>
      <para>
       如果不指定此参数，将生成不包含分配量的稀疏映像文件。要创建非稀疏卷，请使用此参数指定整个映像大小（在本示例中为 <literal>12G</literal>）。
      </para>
     </callout>
    </calloutlist>
    <sect4 xml:id="sec-libvirt-storage-virsh-add-volumes-clone">
     <title>克隆现有卷</title>
     <para>
      将卷添加到池的另一种方法是克隆现有卷。请始终在原始实例所在的同一个池中创建新实例。
     </para>
<screen><prompt>&gt; </prompt>virsh vol-clone <replaceable>NAME_EXISTING_VOLUME</replaceable><co xml:id="co-vol-clone-existing"/><replaceable>NAME_NEW_VOLUME</replaceable><co xml:id="co-vol-clone-new"/> --pool <replaceable>POOL</replaceable><co xml:id="co-vol-clone-pool"/></screen>
     <calloutlist>
      <callout arearefs="co-vol-clone-existing">
       <para>
        要克隆的现有卷的名称
       </para>
      </callout>
      <callout arearefs="co-vol-clone-new">
       <para>
        新卷的名称
       </para>
      </callout>
      <callout arearefs="co-vol-clone-pool">
       <para>
        可选的参数。<systemitem class="library">libvirt</systemitem> 会尝试自动查找现有卷。如果找不到，请指定此参数。
       </para>
      </callout>
     </calloutlist>
    </sect4>
   </sect3>
   <sect3 xml:id="sec-libvirt-storage-virsh-del-volumes">
    <title>从储存池中删除卷</title>
    <para>
     要从池中永久删除某个卷，请使用 <literal>vol-delete</literal> 子命令：
    </para>
<screen><prompt>&gt; </prompt>virsh vol-delete <replaceable>NAME</replaceable> --pool <replaceable>POOL</replaceable></screen>
    <para>
     <option>--pool</option> 为可选项。<systemitem class="library">libvirt</systemitem> 会尝试自动查找卷。如果找不到，请指定此参数。
    </para>
    <warning>
     <title>删除卷时不会进行检查</title>
     <para>
      无论卷当前是否已在活动或非活动的 VM Guest 中使用，都将一律被删除。无法恢复已删除的卷。
     </para>
     <para>
      只能使用<xref linkend="pro-libvirt-storage-virsh-list-vols"/>中所述的方法来检测某个卷是否已由 VM Guest 使用。
     </para>
    </warning>
   </sect3>
   <sect3 xml:id="libvirt-storage-virsh-attach-volumes">
    <title>将卷挂接到 VM Guest</title>
    <para>
     按照<xref linkend="sec-libvirt-storage-virsh-add-volumes"/>中所述创建卷后，可将其挂接到虚拟机并作为硬盘使用：
    </para>
<screen><prompt>&gt; </prompt>virsh attach-disk <replaceable>DOMAIN</replaceable> <replaceable>SOURCE_IMAGE_FILE</replaceable> <replaceable>TARGET_DISK_DEVICE</replaceable></screen>
    <para>
     例如：
    </para>
<screen><prompt>&gt; </prompt>virsh attach-disk sles12sp3 /virt/images/example_disk.qcow2 sda2</screen>
    <para>
     要检查是否已挂接新磁盘，请检查 <command>virsh dumpxml</command> 命令的结果：
    </para>
<screen><prompt role="root"># </prompt>virsh dumpxml sles12sp3
[...]
&lt;disk type='file' device='disk'&gt;
 &lt;driver name='qemu' type='raw'/&gt;
 &lt;source file='/virt/images/example_disk.qcow2'/&gt;
 &lt;backingStore/&gt;
 &lt;target dev='sda2' bus='scsi'/&gt;
 &lt;alias name='scsi0-0-0'/&gt;
 &lt;address type='drive' controller='0' bus='0' target='0' unit='0'/&gt;
&lt;/disk&gt;
[...]</screen>
    <sect4>
     <title>热插入或持久更改</title>
     <para>
      可将磁盘挂接到活动和非活动的域。挂接操作由 <option>--live</option> 和 <option>--config</option> 选项控制：
     </para>
     <variablelist>
      <varlistentry>
       <term><option>--live</option></term>
       <listitem>
        <para>
         将磁盘热插入到活动域。挂接操作不会保存在域配置中。对非活动域使用 <option>--live</option> 会出错。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term><option>--config</option></term>
       <listitem>
        <para>
         持久更改域配置。下一次启动域后，挂接的磁盘将可用。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term><option>--live</option><option>--config</option></term>
       <listitem>
        <para>
         热插入磁盘并将其添加到持久域配置中。
        </para>
       </listitem>
      </varlistentry>
     </variablelist>
     <tip>
      <title><command>virsh attach-device</command></title>
      <para>
       <command>virsh attach-device</command> 是 <command>virsh attach-disk</command> 的更通用的形式。可以使用此命令将其他类型的设备挂接到域。
      </para>
     </tip>
    </sect4>
   </sect3>
   <sect3 xml:id="libvirt-storage-virsh-detach-volumes">
    <title>从 VM Guest 分离卷</title>
    <para>
     要从域分离磁盘，请使用 <command>virsh detach-disk</command>：
    </para>
<screen><prompt role="root"># </prompt>virsh detach-disk <replaceable>DOMAIN</replaceable> <replaceable>TARGET_DISK_DEVICE</replaceable></screen>
    <para>
     例如：
    </para>
<screen><prompt role="root"># </prompt>virsh detach-disk sles12sp3 sda2</screen>
    <para>
     可以按照<xref linkend="libvirt-storage-virsh-attach-volumes"/>中所述，使用 <option>--live</option> 和 <option>--config</option> 选项来控制挂接操作。
    </para>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-libvirt-storage-vmm">
   <title>使用虚拟机管理器管理储存设备</title>
   <para>
    虚拟机管理器提供了一个图形界面，即储存管理器，用于管理储存卷和池。要访问储存管理器，请右键单击某个连接并选择<guimenu>细节</guimenu>，或者高亮显示某个连接并选择<menuchoice> <guimenu>编辑</guimenu> <guimenu>连接细节</guimenu> </menuchoice>。选择<guimenu>储存</guimenu>选项卡。
   </para>
   <informalfigure>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="virt_virt-manager_storage.png" width="60%"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="virt_virt-manager_storage.png" width="60%"/>
     </imageobject>
    </mediaobject>
   </informalfigure>
   <sect3 xml:id="sec-libvirt-storage-vmm-addpool">
    <title>添加储存池</title>
    <para>
     要添加储存池，请执行以下操作：
    </para>
    <procedure>
     <step>
      <para>
       单击左下角的<guimenu>添加</guimenu>。<guimenu>添加新储存池</guimenu>对话框即会显示。
      </para>
     </step>
     <step>
      <para>
       提供池的<guimenu>名称</guimenu>（只能包含字母数字字符以及 <literal>_</literal>、<literal>-</literal> 或 <literal>&#x002E;</literal>），然后选择一种<guimenu>类型</guimenu>。
      </para>
      <informalfigure>
       <mediaobject>
        <imageobject role="fo">
         <imagedata fileref="virt_virt-manager_storage_add.png" width="60%"/>
        </imageobject>
        <imageobject role="html">
         <imagedata fileref="virt_virt-manager_storage_add.png" width="60%"/>
        </imageobject>
       </mediaobject>
      </informalfigure>
     </step>
     <step>
      <para>
       在下面指定所需的细节。具体的值取决于您要创建的池类型。
      </para>
      <important>
       <para>
        不支持 ZFS 池。
       </para>
      </important>
      <variablelist>
       <varlistentry>
        <term><emphasis role="bold">类型：</emphasis> <guimenu>dir</guimenu></term>
        <listitem>
         <itemizedlist mark="bullet" spacing="normal">
          <listitem>
           <para>
            <guimenu>目标路径</guimenu>：指定现有目录。
           </para>
          </listitem>
         </itemizedlist>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><emphasis role="bold">类型：</emphasis> <guimenu>disk</guimenu></term>
        <listitem>
         <itemizedlist mark="bullet" spacing="normal">
          <listitem>
           <para>
            <guimenu>格式</guimenu>：设备分区表的格式。一般情况下，使用 <guimenu>auto</guimenu> 应该不会有问题。如果有问题，请通过在 VM 主机服务器上运行命令 <command>parted</command>
            <option>-l</option> 获取所需的格式。
           </para>
          </listitem>
          <listitem>
           <para>
            <guimenu>源路径</guimenu>：设备的路径。建议使用基于 <filename>/dev/disk/by-*</filename> 的设备名称而不是简单的 <filename>/dev/sd<replaceable>X</replaceable></filename>，因为后者可能会发生变化（例如，添加或拆除硬盘时）。您需要指定类似整个磁盘而不是磁盘上的分区（如果存在）的路径。
           </para>
          </listitem>
         </itemizedlist>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><emphasis role="bold">类型：</emphasis> <guimenu>fs</guimenu></term>
        <listitem>
         <itemizedlist mark="bullet" spacing="normal">
          <listitem>
           <para>
            <guimenu>目标路径</guimenu>：VM 主机服务器文件系统上的挂载点。
           </para>
          </listitem>
          <listitem>
           <para>
            <guimenu>格式</guimenu>：设备的文件系统格式。使用默认值 <literal>auto</literal> 应该不会有问题。
           </para>
          </listitem>
          <listitem>
           <para>
            <guimenu>源路径</guimenu>：设备文件的路径。建议使用基于 <filename>/dev/disk/by-*</filename> 的设备名称而不是 <filename>/dev/sd<replaceable>X</replaceable></filename>，因为后者可能会发生变化（例如，添加或拆除硬盘时）。
           </para>
          </listitem>
         </itemizedlist>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><emphasis role="bold">类型：</emphasis> <guimenu>iscsi</guimenu></term>
        <listitem>
         <para>
          通过在 VM 主机服务器上运行以下命令来获取所需的数据：
         </para>
<screen><prompt>&gt; </prompt><command>sudo</command> iscsiadm --mode node</screen>
         <para>
          此命令将返回采用以下格式的 iSCSI 卷列表。以粗体文本显示的元素是必需的：
         </para>
<screen><emphasis role="bold">IP_ADDRESS</emphasis>:PORT,TPGT <emphasis role="bold">TARGET_NAME_(IQN)</emphasis></screen>
         <itemizedlist mark="bullet" spacing="normal">
          <listitem>
           <para>
            <guimenu>目标路径</guimenu>：包含设备文件的目录。使用 <literal>/dev/disk/by-path</literal>（默认值）或 <literal>/dev/disk/by-id</literal>。
           </para>
          </listitem>
          <listitem>
           <para>
            <guimenu>主机名</guimenu>：iSCSI 服务器的主机名或 IP 地址。
           </para>
          </listitem>
          <listitem>
           <para>
            <guimenu>源 IQN</guimenu>：iSCSI 目标名称（iSCSI 限定的名称）。
           </para>
          </listitem>
          <listitem>
           <para>
            <guimenu>发起端 IQN</guimenu>：iSCSI 发起端名称。
           </para>
          </listitem>
         </itemizedlist>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><emphasis role="bold">类型：</emphasis> <guimenu>logical</guimenu></term>
        <listitem>
         <itemizedlist mark="bullet" spacing="normal">
          <listitem>
           <para>
            <guimenu>卷组名称</guimenu>：指定现有卷组的设备路径。
           </para>
          </listitem>
         </itemizedlist>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><emphasis role="bold">类型：</emphasis> <guimenu>mpath</guimenu></term>
        <listitem>
         <itemizedlist mark="bullet" spacing="normal">
          <listitem>
           <para>
            <guimenu>目标路径</guimenu>：目前对多路径的支持仅限于通过它来使所有多路径设备可用。因此，请在此处指定任意字符串，此字符串随后将被忽略。必须指定路径，否则 XML 解析器将会失败。
           </para>
          </listitem>
         </itemizedlist>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><emphasis role="bold">类型：</emphasis> <guimenu>netfs</guimenu></term>
        <listitem>
         <itemizedlist mark="bullet" spacing="normal">
          <listitem>
           <para>
            <guimenu>目标路径</guimenu>：VM 主机服务器文件系统上的挂载点。
           </para>
          </listitem>
          <listitem>
           <para>
            <guimenu>主机名</guimenu>：要导出网络文件系统的服务器的 IP 地址或主机名。
           </para>
          </listitem>
          <listitem>
           <para>
            <guimenu>源路径</guimenu>：正在导出的服务器上的目录。
           </para>
          </listitem>
         </itemizedlist>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><emphasis role="bold">类型：</emphasis> <guimenu>rbd</guimenu></term>
        <listitem>
         <itemizedlist>
          <listitem>
           <para>
            <guimenu>主机名</guimenu>：导出的 RADOS 块设备所在服务器的主机名。
           </para>
          </listitem>
          <listitem>
           <para>
            <guimenu>源名称</guimenu>：服务器上 RADOS 块设备的名称。
           </para>
          </listitem>
         </itemizedlist>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><emphasis role="bold">类型：</emphasis> <guimenu>scsi</guimenu></term>
        <listitem>
         <itemizedlist mark="bullet" spacing="normal">
          <listitem>
           <para>
            <guimenu>目标路径</guimenu>：包含设备文件的目录。使用 <literal>/dev/disk/by-path</literal>（默认值）或 <literal>/dev/disk/by-id</literal>。
           </para>
          </listitem>
          <listitem>
           <para>
            <guimenu>源路径</guimenu>：SCSI 适配器的名称。
           </para>
          </listitem>
         </itemizedlist>
        </listitem>
       </varlistentry>
      </variablelist>
      <note>
       <title>文件浏览</title>
       <para>
        从远程位置操作时，无法通过单击<guimenu>浏览</guimenu>使用文件浏览器。
       </para>
      </note>
     </step>
     <step>
      <para>
       单击<guimenu>完成</guimenu>以添加储存池。
      </para>
     </step>
    </procedure>
   </sect3>
   <sect3 xml:id="sec-libvirt-storage-vmm-manage">
    <title>管理储存池</title>
    <para>
     您可以通过虚拟机管理器的储存管理器在池中创建或删除卷。您还可以暂时停用或永久删除现有的储存池。SUSE 目前不支持更改池的基本配置。
    </para>
    <sect4 xml:id="sec-libvirt-storage-vmm-manage-pool">
     <title>启动、停止和删除池</title>
     <para>
      储存池的用途是提供 VM 主机服务器上的块设备，远程管理 VM Guest 时，可将这些设备添加到其中。要暂时禁止远程访问某个池，请单击储存管理器左下角的<guimenu>停止</guimenu>。停止的池标记为<guimenu>状态：非活动</guimenu>，并在列表窗格中灰显。默认情况下，新建的池在 VM 主机服务器<guimenu>引导</guimenu>时会自动启动。
     </para>
     <para>
      要启动某个非活动的池并再次使其可从远程位置使用，请单击储存管理器左下角的<guimenu>启动</guimenu>。
     </para>
     <note>
      <title>池的状态不会影响挂接的卷</title>
      <para>
       无论池处于什么状态（<guimenu>活动</guimenu>（已停止）或<guimenu>非活动</guimenu>（已启动）），池中挂接到 VM Guest 的卷都始终可用。池的状态只会影响到能否通过远程管理将卷挂接到 VM Guest。
      </para>
     </note>
     <para>
      要永久禁止访问某个池，请单击储存管理器左下角的<guimenu>删除</guimenu>。您只能删除非活动的池。删除某个池不会实际擦除其在 VM 主机服务器上的内容，而只会删除池配置。不过，在删除池时需要额外小心，尤其是删除基于 LVM 卷组的工具时：
     </para>
     <warning xml:id="deleting-storage-pools">
      <title>删除储存池</title>
      <para>
       删除基于<emphasis>本地</emphasis>文件系统目录、本地分区或磁盘的储存池不会影响到这些池中当前挂接到 VM Guest 的卷的可用性。
      </para>
      <para>
       如果删除 iSCSI、SCSI、LVM 组或网络导出的目录这些类型的池，将无法再从 VM Guest 访问这些池中的卷。尽管卷本身不会被删除，但 VM 主机服务器将不再可以访问这些资源。
      </para>
      <para>
       创建足够大的新池或者直接从主机系统挂载/访问这些资源时，iSCSI/SCSI 目标或网络导出的目录中的卷将再次可供访问。
      </para>
      <para>
       删除基于 LVM 组的储存池时，将擦除 LVM 组定义，并且该 LVM 组将不再存在于主机系统上。其配置将不可恢复，并且此池中的所有卷都会丢失。
      </para>
     </warning>
    </sect4>
    <sect4 xml:id="sec-libvirt-storage-vmm-manage-volume-add">
     <title>将卷添加到储存池</title>
     <para>
      借助虚拟机管理器，您可以在所有储存池（多路径、iSCSI 或 SCSI 类型的池除外）中创建卷。这些池中的卷相当于 LUN，无法从 <systemitem class="library">libvirt</systemitem> 内部更改。
     </para>
     <procedure>
      <step>
       <para>
        可以使用储存管理器创建新卷，或者在将新储存设备添加到 VM Guest 时创建新卷。在以上任一情况下，请从左侧面板中选择一个储存池，然后单击<guimenu>创建新卷</guimenu>。
       </para>
      </step>
      <step>
       <para>
        指定映像的<guimenu>名称</guimenu>并选择映像格式。
       </para>
       <para>
        SUSE 目前仅支持 <literal>raw</literal> 或 <literal>qcow2</literal> 映像。后一个选项在基于 LVM 组的池中不可用。
       </para>
       <para>
        在<guimenu>最大容量</guimenu>的旁边，指定允许磁盘映像达到的最大大小。除非您使用 <literal>qcow2</literal> 映像，否则还可以设置最初应该分配的<guimenu>分配</guimenu>量。如果这两个值不同，将会创建一个按需增长的稀疏映像文件。
       </para>
       <para>
        对于 <literal>qcow2</literal> 映像，可以使用一个构成基本映像的<guimenu>后备储存</guimenu>（也称为<quote>后备文件</quote>）。这样新建的 <literal>qcow2</literal> 映像便只会记录对基本映像进行的更改。
       </para>
      </step>
      <step>
       <para>
        单击<guimenu>完成</guimenu>开始创建卷。
       </para>
      </step>
     </procedure>
    </sect4>
    <sect4 xml:id="sec-libvirt-storage-vmm-manage-volume-delete">
     <title>从储存池中删除卷</title>
     <para>
      只能在储存管理器中删除卷：选择相应卷并单击<guimenu>删除卷</guimenu>。单击<guimenu>是</guimenu>确认。
     </para>
     <warning>
      <title>即使卷处于使用中状态，也能将其删除</title>
      <para>
       即使活动或非活动的 VM Guest 中当前正在使用卷，也能将卷删除。无法恢复已删除的卷。
      </para>
      <para>
       储存管理器中的<guimenu>使用对象</guimenu>列会指示某个卷是否已由 VM Guest 使用。
      </para>
     </warning>
    </sect4>
   </sect3>
  </sect2>
 </sect1>
</chapter>
