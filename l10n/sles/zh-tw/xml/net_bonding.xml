<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_bonding.xml" version="5.0" xml:id="sec-network-iface-bonding">
 <title>設定結合裝置</title>

 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>

 <para>
  對於某些系統而言，實作的網路連接除了需要符合一般乙太網路裝置的標準資料安全性或可用性要求之外，還需要符合其他要求。在這些情況下，數個乙太網路裝置可以結集成單個 Bonding 裝置。
 </para>

 <para>
  bonding 裝置的組態是透過 bonding 模組選項來設定，而其行為主要受 Bonding 裝置的模式影響。該模式預設為 <systemitem>active-backup</systemitem>，這表示如果使用中的連接埠發生故障，另一個結合連接埠將變成使用中連接埠。可以使用以下結合模式：
 </para>

 <variablelist>
  <varlistentry>
   <term><guimenu>0</guimenu> (balance-rr)</term>
   <listitem>
    <para>
     封包依次透過第一個到最後一個可用介面傳輸。提供容錯和負載平衡。
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>1</guimenu> (active-backup)</term>
   <listitem>
    <para>
     只有一個網路介面處於使用中狀態。如果它失敗，另一個介面將變成使用中狀態。此設定是 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 的預設設定。提供容錯。
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>2</guimenu> (balance-xor)</term>
   <listitem>
    <para>
     流量會根據結合中包含的裝置數量在所有可用介面間拆分。這需要交換器的支援。提供容錯和負載平衡。
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>3</guimenu> (broadcast)</term>
   <listitem>
    <para>
     在所有介面上廣播所有流量。需要交換器的支援。提供容錯。
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>4</guimenu> (802.3ad)</term>
   <listitem>
    <para>
     將介面聚合成共用相同速度和雙工設定的群組。需要介面驅動程式中的 <command>ethtool</command> 支援，以及支援 IEEE 802.3ad 動態鏈結聚合並進行了相應設定的交換器。提供容錯和負載平衡。
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>5</guimenu> (balance-tlb)</term>
   <listitem>
    <para>
     調適性傳輸負載平衡。需要介面驅動程式中的 <command>ethtool</command> 支援，但不需要交換器支援。提供容錯和負載平衡。
    </para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>6</guimenu> (balance-alb)</term>
   <listitem>
    <para>
     調適性負載平衡。需要介面驅動程式中的 <command>ethtool</command> 支援，但不需要交換器支援。提供容錯和負載平衡。
    </para>
   </listitem>
  </varlistentry>
 </variablelist>

 <para>
  如需各種模式的詳細描述，請參閱 <link xlink:href="https://www.kernel.org/doc/Documentation/networking/bonding.txt"/>。
 </para>

 <tip>
  <title>Bonding 和 Xen</title>
  <para>
   Bonding 裝置僅適用於具有多個實際網路卡的機器。在大多數組態中，這表示您只應該在 Dom0 中使用結合組態。此外，只有在您將多個網路卡指定給 VM 客體系統的情況下，在 VM 客體中設定結合才有用。
  </para>
 </tip>

 <note arch="power">
  <title>
   IBM POWER：ibmveth 不支援結合模式 5 和 6 (balance-tlb/balance-alb)
  </title>
  <para>
   tlb/alb 結合組態與 Power 韌體之間存在衝突。簡言之，處於 tlb/alb 模式的結合驅動程式會傳送同時包含來源與目的地 MAC 位址 (列做虛擬乙太網路 MAC 位址) 的乙太網路迴路封包。Power 韌體不支援這些封包。因此，ibmveth 不支援結合模式 5 和 6。
  </para>
 </note>

 <para>
  若要設定 bonding 裝置，請執行以下程序：
 </para>

 <procedure>
  <step>
   <para>
    執行 <menuchoice><guimenu>YaST</guimenu> <guimenu> 系統</guimenu>
    <guimenu> 網路設定</guimenu></menuchoice>。
   </para>
  </step>
  <step>
   <para>
    使用「<guimenu>新增</guimenu>」，然後將「<guimenu>裝置類型</guimenu>」變更為「<guimenu>Bond</guimenu>」。按<guimenu>繼續</guimenu>以繼續。
   </para>
   <informalfigure>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="bond_configuration.png" width="70%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="bond_configuration.png" width="65%" format="PNG"/>
     </imageobject>
    </mediaobject>
   </informalfigure>
  </step>
  <step>
   <para>
    選取為結合裝置指定 IP 位址的方法。有三種方法可供您選擇：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      無 IP 位址
     </para>
    </listitem>
    <listitem>
     <para>
      動態位址 (透過 DHCP 或 Zeroconf)
     </para>
    </listitem>
    <listitem>
     <para>
      靜態指定的 IP 位址
     </para>
    </listitem>
   </itemizedlist>
   <para>
    請使用適合您環境的方法。
   </para>
  </step>
  <step>
   <para>
    在<guimenu>結合連接埠</guimenu>索引標籤中，透過核取相關核取方塊以選取應包含在結合中的乙太網路裝置。
   </para>
  </step>
  <step>
   <para>
    編輯<guimenu>結合驅動程式選項</guimenu>並選取結合模式。
   </para>
  </step>
  <step>
   <para>
    確認參數 <literal>miimon=100</literal> 已新增至「<guimenu>Bond 驅動程式選項</guimenu>」。若沒有此參數，就無法定期檢查資料的完整性。
   </para>
  </step>
  <step>
   <para>
    按「<guimenu>下一步</guimenu>」，然後按一下「<guimenu>確定</guimenu>」離開 YaST，以建立裝置。
   </para>
  </step>
 </procedure>

 <sect2 xml:id="sec-network-iface-bonding-hotplug">
  <title>結合連接埠的熱插拔</title>
  <para>
   在特定網路環境 (如高可用性) 中，有時需要以另一個結合連接埠介面取代目前的介面。原因可能在於網路裝置不斷發生故障。解決方案是設定結合連接埠的熱插拔。
  </para>
  <para>
   請依一般方式設定 Bond (根據 <command>man 5 ifcfg-bonding</command>)，例如：
  </para>
<screen>ifcfg-bond0
          STARTMODE='auto' # or 'onboot'
          BOOTPROTO='static'
          IPADDR='192.168.0.1/24'
          BONDING_MASTER='yes'
          BONDING_SLAVE_0='eth0'
          BONDING_SLAVE_1='eth1'
          BONDING_MODULE_OPTS='mode=active-backup miimon=100'</screen>
  <para>
   使用 <literal>STARTMODE=hotplug</literal> 和 <literal>BOOTPROTO=none</literal> 可指定結合連接埠：
  </para>
<screen>ifcfg-eth0
          STARTMODE='hotplug'
          BOOTPROTO='none'

ifcfg-eth1
          STARTMODE='hotplug'
          BOOTPROTO='none'</screen>

  <para>
   <literal>BOOTPROTO=none</literal> 會使用 <command>ethtool</command> 選項 (若提供)，但不會使用 <command>ifup eth0</command> 設定連結。這是因為結合連接埠介面由結合裝置控制。
  </para>
  <para>
   <literal>STARTMODE=hotplug</literal> 會使結合連接埠介面在可用時自動加入結合。
  </para>
  <para>
   需要變更 <filename>/etc/udev/rules.d/70-persistent-net.rules</filename> 中的 <systemitem>udev</systemitem> 規則，以便依匯流排 ID (udev <systemitem>KERNELS</systemitem> 關鍵字等同於 <command>hwinfo --netcard</command> 中的「SysFS BusID」) 比對裝置，而不是依 MAC 位址比對。這樣將允許更換有缺陷的硬體 (位於同一插槽但 MAC 不同的網路卡)，並避免在結合變更其所有結合連接埠的 MAC 位址時出現混淆。
  </para>
  <para>
   例如：
  </para>
<screen>SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*",
KERNELS=="0000:00:19.0", ATTR{dev_id}=="0x0", ATTR{type}=="1",
KERNEL=="eth*", NAME="eth0"</screen>
  <para>
   在開機時，systemd <systemitem>network.service</systemitem> 不會等待熱插拔結合連接埠就緒，而是等待結合就緒，後者至少需要有一個結合連接埠可用。當從系統中移除一個結合連接埠介面 (從 NIC 驅動程式解除結合、執行 NIC 驅動程式的 <command>rmmod</command> 指令，或真正移除 PCI 熱插拔) 時，核心會自動將其從結合中移除。當新增新網路卡至系統 (更換插槽中的硬體) 時，<systemitem>udev</systemitem> 會使用基於匯流排的永久命名規則將其重新命名為結合連接埠的名稱，並為其呼叫 <command>ifup</command>。呼叫 <command>ifup</command> 會自動將新卡加入結合。
   <remark>
    ke: I think this can stay that way for now.
   </remark>
  </para>
 </sect2>


</sect1>
