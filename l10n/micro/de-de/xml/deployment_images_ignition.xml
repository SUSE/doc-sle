<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="deployment_images_ignition.xml" version="5.0" xml:id="cha-images-ignition">
  <title>Konfiguration mit Ignition</title>
  <info>
    <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
      <dm:bugtracker/>
      <dm:translation>yes</dm:translation>
    </dm:docmanager>
    <abstract>
      <para>
        In diesem Abschnitt finden Sie Informationen zum Bereitstellungstool Ignition, mit dem ein Computer eingerichtet wird. Hier erfahren Sie, wie Sie die erforderlichen Konfigurationsdateien für die Computerdefinition bereitstellen.
      </para>
    </abstract>
  </info>
  <sect1 xml:id="sec-about-ignition">
    <title>Informationen zu Ignition</title>

    <para>
      Mit dem Bereitstellungstool Ignition können Sie ein System beim ersten Starten gemäß Ihrer Spezifikation konfigurieren. Wenn das System erstmalig gestartet wird, wird Ignition als Teil von <filename>initramfs</filename> geladen und sucht eine Konfigurationsdatei in einem bestimmten Verzeichnis (auf einem USB-Speicherstick; alternativ können Sie eine URL angeben). Alle Änderungen werden vorgenommen, bevor der Kernel vom temporären Dateisystem zum echten Root-Dateisystem wechselt (bevor der Befehl <literal>switch_root</literal> ausgeführt wird).
    </para>

    <para>
      Ignition nutzt eine Konfigurationsdatei im JSON-Format. Die Datei trägt den Namen <filename>config.ign</filename>.
    </para>
  </sect1>
  <sect1 xml:id="sec-ignition-configuration">
    <title><filename>config.ign</filename></title>

    <para>
      <filename>config.ign</filename> ist eine JSON-Konfigurationsdatei, die Anweisungen für Ignition enthält. Sie können die Datei entweder manuell in JSON erstellen oder das Tool Fuel Ignition (<link xlink:href="https://opensuse.github.io/fuel-ignition/"/>) verwenden, um einen einfachen Satz von Anweisungen zu generieren. Beachten Sie, dass das Tool Fuel Ignition keinen vollständigen Satz von Optionen bietet, sodass Sie die Datei möglicherweise manuell ändern müssen.
    </para>

    <para>
      Zur besseren Lesbarkeit für Menschen können Sie die Datei <filename>config.fcc</filename> auch in YAML erstellen und in JSON transpilieren. Detaillierte Informationen finden Sie in <xref linkend="sec-converting-config"/>.
    </para>

    <para>
      Bei der Installation auf einem Bare-Metal-System muss sich die Konfigurationsdatei <filename>config.ign</filename> im Unterverzeichnis <filename>ignition</filename> auf dem Konfigurationsmedium mit der Bezeichnung <literal>ignition</literal> befinden. Die Verzeichnisstruktur muss wie folgt aussehen:
    </para>

<screen>
&lt;root directory&gt;
└── ignition
    └── config.ign

 </screen>

    <para>
      Falls Sie einen virtuellen QEMU-/KVM-Computer konfigurieren möchten, geben Sie den Pfad zur Datei <filename>config.ign</filename> als Attribut des Befehls <command>qemu</command> an. Beispiel:
    </para>

<screen>
-fw_cfg name=opt/com.coreos/config,file=<replaceable>PATH_TO_config.ign</replaceable>
 </screen>

    <para>
      Die Datei <filename>config.ign</filename> enthält verschiedene Datentypen – Objekte, Zeichenketten, Ganzzahlen, boolesche Werte und Objektlisten. Eine vollständige Spezifikation finden Sie unter <link xlink:href="https://coreos.github.io/ignition/configuration-v3_3/">Ignition
      specification v3.3.0</link>.
    </para>

    <para>
      Das Attribut <literal>version</literal> ist obligatorisch und muss bei SLE Micro entweder auf <literal>3.3.0</literal> oder auf eine beliebige niedrigere Version eingestellt werden. Ansonsten funktioniert Ignition nicht.
    </para>

    <para>
      Wenn Sie sich als „root“ bei Ihrem System anmelden möchten, müssen Sie mindestens ein Passwort für <systemitem class="username">root</systemitem> angeben. Es wird allerdings empfohlen, den Zugriff mithilfe von SSH-Schlüsseln einzurichten. Wenn Sie ein Passwort konfigurieren möchten, müssen Sie ein sicheres Passwort verwenden. Falls Sie ein zufällig erzeugtes Passwort heranziehen, muss dieses Passwort mindestens 10 Zeichen enthalten. Wenn Sie Ihr Passwort manuell erstellen, verwenden Sie mehr als 10 Zeichen und kombinieren Sie Großbuchstaben, Kleinbuchstaben und Ziffern.
    </para>

    <sect2 xml:id="sec-ignition-examples">
      <title>Konfigurationsbeispiele</title>
      <para>
        In diesem Abschnitt finden Sie einige gängige Beispiele für die Ignition-Konfiguration sowohl im JSON- als auch im YAML-Format. Wenn Sie die Konfiguration im YAML-Format erstellen, müssen Sie die Konfiguration in JSON transpilieren, wie in <xref linkend="sec-converting-config"/> beschrieben.
      </para>
      <important>
        <title>Deklarieren von Inhalt außerhalb der standardmäßigen Subvolumes</title>
        <para>
          Falls Sie Dateien außerhalb von <xref linkend="sec-default-partitioning" xrefstyle="template:default mounted directories"/> erstellen möchten, müssen Sie die Verzeichnisse mit dem Attribut <literal>filesystem</literal> definieren.
        </para>
      </important>
      <note>
        <title>Das Attribut <literal>version</literal> ist obligatorisch</title>
        <para>
          Schließen Sie die Versionsspezifikation in <filename>config.ign</filename> (Version 3.3.0 oder niedriger) bzw. in <filename>config.fcc</filename> (Version 1.4.0 oder niedriger) ein.
        </para>
      </note>
      <sect3 xml:id="sec-ignition-storage">
        <title>Speicherkonfiguration</title>
        <para>
          Mit dem Attribut <literal>storage</literal> können Sie Partitionen und RAID konfigurieren, Dateisysteme definieren, Dateien erstellen usw. Zum Definieren von Partitionen verwenden Sie das Attribut <literal>disks</literal>. Mit dem Attribut <literal>filesystem</literal> können Sie Partitionen formatieren und Einhängepunkte bestimmter Partitionen definieren. Mit dem Attribut <literal>files</literal> können Sie Dateien im Dateisystem erstellen. Die genannten Attribute werden in den nachfolgenden Abschnitten beschrieben.
        </para>
        <sect4 xml:id="sec-storage-disks">
          <title>Das Attribut <literal>disks</literal></title>
          <para>
            Das Attribut <literal>disks</literal> ist eine Liste mit Geräten, sodass Sie Partitionen auf diesen Geräten definieren können. Das Attribut <literal>disks</literal> muss mindestens ein Gerät (<literal>device</literal>) enthalten. Andere Attribute sind optional. Im folgenden Beispiel wird ein einzelnes virtuelles Gerät verwendet und die Festplatte wird in vier Partitionen aufgeteilt:
          </para>
<screen>
    {
    "variant": "fcos",
    "version": "3.3.0",
    "storage": {
        "disks": [
            {
                "device": "/dev/vda",
                "wipe_table": true,
                "partitions": [
                    {
                        "label": "root",
                        "number": 1,
                        "type_guid": "4F68BCE3-E8CD-4DB1-96E7-FBCAF984B709"
                    },
                    {
                        "label": "boot",
                        "number": 2,
                        "type_guid": "BC13C2FF-59E6-4262-A352-B275FD6F7172"
                    },
                    {
                        "label": "swap",
                        "number": 3,
                        "type_guid": "0657FD6D-A4AB-43C4-84E5-0933C84B4F4F"
                    },
                    {
                        "label": "home",
                        "number": 4,
                        "type_guid": "933AC7E1-2EB4-4F13-B844-0E14E2AEF915"
                    }
                ]
            }
        ]
    }
}
     </screen>
          <para>
            Das gleiche Beispiel im YAML-Format:
          </para>
<screen>
variant: fcos
version: 1.4.0
storage:
  disks:
    - device: "/dev/vda"
      wipeTable: true
      partitions: 
        - label: root
          number: 1
          typeGuid: 4F68BCE3-E8CD-4DB1-96E7-FBCAF984B709
        - label: boot
          number: 2
          typeGuid: BC13C2FF-59E6-4262-A352-B275FD6F7172
        - label: swap
          number: 3
          typeGuid: 0657FD6D-A4AB-43C4-84E5-0933C84B4F4F
        - label: home
          number: 4
          typeGuid: 933AC7E1-2EB4-4F13-B844-0E14E2AEF915
 </screen>
        </sect4>
        <sect4 xml:id="sec-storage-raid">
          <title>Das Attribut <literal>raid</literal></title>
          <para>
            <literal>raid</literal> ist eine Liste mit RAID-Arrays. Die folgenden Attribute für <literal>raid</literal> sind obligatorisch:
          </para>
          <variablelist>
            <varlistentry>
              <term>level</term>
              <listitem>
                <para>
                  Ebene des jeweiligen RAID-Arrays (linear, raid0, raid1, raid2, raid3, raid4, raid5, raid6)
                </para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>geeignet sind</term>
              <listitem>
                <para>
                  Liste mit Geräten im Array (anhand ihrer absoluten Pfade referenziert)
                </para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>Name</term>
              <listitem>
                <para>
                  Name für das md-Gerät
                </para>
              </listitem>
            </varlistentry>
          </variablelist>
<screen>
      {
    "variant": "fcos",
    "version": "3.3.0",
    "storage": {
        "raid": [
            {
                "name": "system",
                "level": "raid1",
                "devices": [
                    "/dev/sda",
                    "/dev/sdb"
                ]
            }
        ]
    }
}
     </screen>
          <para>
            Das gleiche Beispiel im YAML-Format:
          </para>
<screen>
variant: fcos
version: 1.4.0
storage:
  - raid: data
    name: system
    level: raid1
    devices: "/dev/sda", "/dev/sdb"
      
 </screen>
        </sect4>
        <sect4 xml:id="sec-storage-filesystem">
          <title>Das Attribut <literal>filesystem</literal></title>
          <para>
            <literal>filesystem</literal> muss die folgenden Attribute enthalten:
          </para>
          <variablelist>
            <varlistentry>
              <term>Gerät</term>
              <listitem>
                <para>
                  Absoluter Pfad zum Gerät, bei physischen Festplatten in der Regel <literal>/dev/sda</literal>
                </para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>Format</term>
              <listitem>
                <para>
                  Dateisystemformat (btrfs, ext4, xfs, vfat oder swap)
                </para>
                <note>
                  <para>
                    Für SLE Micro muss das <literal>root</literal>-Dateisystem mit btrfs formatiert werden.
                  </para>
                </note>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>
            Das folgende Beispiel zeigt die Verwendung des Attributs <literal>filesystem</literal>. Das Verzeichnis <filename>/opt</filename> wird in die Partition <literal>/dev/sda1</literal> eingehängt, die mit btrfs formatiert ist. Die Partitionstabelle wird nicht gelöscht.
          </para>
<screen>
{
    "variant": "fcos",
    "version": "3.3.0",
    "storage": {
        "filesystems": [
            {
                "path": "/opt",
                "device": "/dev/sda1",
                "format": "btrfs",
                "wipe_filesystem": false
            }
        ]
    }
}
</screen>
          <para>
            Das gleiche Beispiel im YAML-Format:
          </para>
<screen>
variant: fcos
version: 1.4.0
storage:
  filesystems:
    - path: /opt
      device: "/dev/sda1"
      format: btrfs
      wipe_filesystem: false
 </screen>
        </sect4>
        <sect4 xml:id="sec-storage-files">
          <title>Das Attribut <literal>files</literal></title>
          <para>
            Mit dem Attribut <literal>files</literal> können Sie beliebige Dateien auf Ihrem Computer erstellen. Falls Sie Dateien außerhalb von <xref linkend="sec-default-partitioning" xrefstyle="template:default mounted directories"/> erstellen möchten, müssen Sie die Verzeichnisse mit dem Attribut <literal>filesystem</literal> definieren.
          </para>
          <para>
            Im folgenden Beispiel wird ein Hostname mit dem Attribut <literal>files</literal> erstellt. Die Datei <filename>/etc/hostname</filename> wird mit dem Hostnamen <emphasis>slemicro-1</emphasis> erstellt.
          </para>
          <note>
            <title>Unterschiedliche Zahlensysteme in JSON und YAML</title>
            <para>
              Beachten Sie, dass JSON das dezimale Zahlensystem verwendet, sodass der <literal>mode</literal>-Wert der dezimalen Schreibweise der Zugriffsrechte entspricht. Für die oktale Schreibweise sollten Sie in diesem Fall YAML verwenden.
            </para>
          </note>
<screen>
{
    "variant": "fcos",
    "version": "3.3.0",
    "storage": {
        "files": [
            {
                "path": "/etc/hostname",
                "mode": 420,
                "overwrite": true,
                "contents": {
                    "inline": "slemicro-1"
                }
            }
        ]
    }
}
</screen>
          <para>
            Das gleiche Beispiel in YAML:
          </para>
<screen>
variant: fcos
version: 1.4.0
storage:
  files:
    - path: /etc/hostname
      mode: 0644
      overwrite: true
      contents:
        inline: "slemicro-1"
 </screen>
        </sect4>
        <sect4 xml:id="sec-storage-directories">
          <title>Das Attribut <literal>directories</literal></title>
          <para>
            Das Attribut <literal>directories</literal> ist eine Liste mit Verzeichnissen, die im Dateisystem erstellt werden. Das Attribut <literal>directories</literal> muss mindestens ein Attribut <literal>path</literal> enthalten.
          </para>
<screen>
{
    "variant": "fcos",
    "version": "3.3.0",
    "storage": {
        "directories": [
            {
                "path": "/mnt/backup",
                "user": {
                    "name": "tux"
                }
            }
        ]
    }
}
</screen>
          <para>
            Das gleiche Beispiel in YAML:
          </para>
<screen>
variant: fcos
version: 1.4.0
storage:
  directories:
    - path: /mnt/backup
      user: 
       - name: tux    
 </screen>
        </sect4>
      </sect3>
      <sect3 xml:id="sec-ignition-users">
        <title>Benutzerverwaltung</title>
        <para>
          Mit dem Attribut <literal>passwd</literal> können Sie Benutzer hinzufügen. Wenn Sie sich bei Ihrem System anmelden möchten, erstellen Sie <systemitem class="username">root</systemitem> und legen Sie das <systemitem class="username">root</systemitem>-Passwort fest und/oder fügen Sie den SSH-Schlüssel in die Ignition-Konfiguration ein. Sie müssen einen Hash für das <systemitem class="username">root</systemitem>-Passwort generieren, z. B. mit dem Befehl <command>openssl</command>:
        </para>
<screen>
 openssl passwd -6
 </screen>
        <para>
          Der Befehl erstellt einen Hash für das ausgewählte Passwort. Tragen Sie diesen Hash als Wert für das Attribut <literal>password_hash</literal> ein.
        </para>
<screen>
variant: fcos
version: 1.0.0
passwd:
  users:
   - name: root
     password_hash: "$6$PfKm6Fv5WbqOvZ0C$g4kByYM.D2B5GCsgluuqDNL87oeXiHqctr6INNNmF75WPGgkLn9O9uVx4iEe3UdbbhaHbTJ1vpZymKWuDIrWI1"
     ssh_authorized_keys: 
       - ssh-rsa long...key user@host
 </screen>
        <para>
          Das Attribut <literal>users</literal> muss mindestens ein Attribut <literal>name</literal> enthalten. <literal>ssh_authorized_keys</literal> ist eine Liste von SSH-Schlüsseln für den Benutzer.
        </para>
        <note>
          <title>Erstellen anderer Benutzer als <systemitem class="username">root</systemitem></title>
          <para>
            Wenn Sie andere Benutzer als <systemitem class="username">root</systemitem> erstellen, müssen Sie <filename>/home</filename>-Verzeichnisse für die Benutzer definieren, da diese Verzeichnisse (in der Regel <filename>/home/<replaceable>USER_NAME</replaceable></filename>) nicht standardmäßig eingehängt werden. Deklarieren Sie daher diese Verzeichnisse mit dem Attribut <literal>storage</literal>/<literal>filesystem</literal>. Für „tux“ sieht das Beispiel folgendermaßen aus:
          </para>
<screen>
        {
  "ignition": {
    "version": "3.2.0"
  },
  "passwd": {
    "users": [
      {
        "name": "tux",
        "passwordHash": "$2a$10$US9XSqLOqMmGq/OnhlVjPOwuZREh2.iEtlwD5LI7DKgV24NJU.wO6"
      }
    ]
  },
  "storage": {
    "filesystems": [
      {
        "device": "/dev/disk/by-label/ROOT",
        "format": "btrfs",
        "mountOptions": [
          "subvol=/@/home"
        ],
        "path": "/home",
        "wipeFilesystem": false
      }
    ]
  }
}
      </screen>
          <para>
            Das gleiche Beispiel in YAML:
          </para>
<screen>
version: 1.2.0
passwd:
  users:
    - name: tux
      passwordHash: $2a$10$US9XSqLOqMmGq/OnhlVjPOwuZREh2.iEtlwD5LI7DKgV24NJU.wO6
storage:
  filesystems:
    - device: /dev/disk/by-label/ROOT
      format: btrfs
      mountOptions:
        - subvol=/@/home
      path: /home
      wipeFilesystem: false
      </screen>
        </note>
      </sect3>
      <sect3 xml:id="sec-ignition-systemd">
        <title>Aktivieren von <literal>systemd</literal>-Diensten</title>
        <para>
          Sollen <systemitem class="daemon">systemd</systemitem>-Dienste aktiviert werden, geben Sie diese Dienste im Attribut <literal>systemd</literal> an. <literal>name</literal> muss den genauen Namen des zu aktivierenden Dienstes enthalten (mit Suffix).
        </para>
<screen>
variant: fcos
version: 1.0.0
systemd:
  units:
  - name: sshd.service
    enabled: true
 </screen>
<screen>
  {
  "ignition": {
    "version": "3.0.0"
  },
  "systemd": {
    "units": [
      {
        "enabled": true,
        "name": "sshd.service"
      }
    ]
  }
}
 </screen>
        <para>
          Das gleiche Beispiel in YAML:
        </para>
<screen>
variant: fcos
version: 1.0.0
systemd:
  units:
  - name: sshd.service
    enabled: true
 </screen>
      </sect3>
    </sect2>

    <sect2 xml:id="sec-converting-config">
      <title>Konvertieren einer YAML <literal>fcc</literal>-Datei in JSON <literal>ign</literal></title>
      <para>
        Soll die Ignition-Konfiguration leichter für Menschen lesbar sein, können Sie eine zweiphasige Konfiguration verwenden. Bereiten Sie zunächst die Konfiguration in YAML als <literal>fcc</literal>-Datei vor und transpilieren Sie diese Konfiguration dann nach JSON. Die Transpilation kann mit dem <literal>butane</literal>-Tool vorgenommen werden.
      </para>
      <para>
        Während der Transpilation überprüft <literal>butane</literal> außerdem die Syntax der YAML-Datei, sodass eventuelle Fehler in der Struktur erkannt werden. Fügen Sie ein Repository für die neueste Version des <literal>butane</literal>-Tools hinzu:
      </para>
<screen>
<prompt>&gt; </prompt><command>sudo</command>  zypper ar -f \
  https://download.opensuse.org/repositories/devel:/kubic:/ignition/<replaceable>DISTRIBUTION</replaceable>/ \
  devel_kubic_ignition
 </screen>
      <para>
        <replaceable>DISTRIBUTION</replaceable> entspricht dabei einer der folgenden Bezeichnungen (je nach Ihrer Distribution):
      </para>
      <itemizedlist>
        <listitem>
          <para>
            <literal>openSUSE_Tumbleweed</literal>
          </para>
        </listitem>
        <listitem>
          <para>
            <literal>openSUSE_Leap_$release_number</literal>
          </para>
        </listitem>
        <listitem>
          <para>
            <literal>15.a</literal>
          </para>
        </listitem>
      </itemizedlist>
      <para>
        Nun können Sie das <literal>butane</literal>-Tool installieren:
      </para>
<screen>
<prompt>&gt; </prompt><command>sudo</command>  zypper in butane
 </screen>
      <para>
        Nun können Sie <literal>butane</literal> mit folgendem Befehl aufrufen:
      </para>
<screen>
<prompt>&gt; </prompt> butane -p -o config.ign config.fcc
 </screen>
      <para>
        mit folgenden Bedeutungen
      </para>
      <itemizedlist>
        <listitem>
          <para>
            <filename>config.fcc</filename> ist der Pfad der YAML-Konfigurationsdatei
          </para>
        </listitem>
        <listitem>
          <para>
            <filename>config.ign</filename> ist der Pfad der ausgegebenen JSON-Konfigurationsdatei
          </para>
        </listitem>
        <listitem>
          <para>
            Mit der Befehlsoption <option>-p</option> können Sie Zeilenumbrüche in die Ausgabedatei einfügen und damit die Lesbarkeit der Datei erhöhen.
          </para>
        </listitem>
      </itemizedlist>
    </sect2>
  </sect1>
</chapter>
