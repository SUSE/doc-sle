<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xml:base="net_samba.xml" id="cha.samba">
 <title>Samba</title><indexterm id="idx.Samba" class="startofrange"> <primary>Samba</primary> </indexterm> <indexterm> <primary>SMB</primary> <see>Samba</see> </indexterm> <indexterm> <primary>Mac OS X</primary> <secondary>Dateien freigeben</secondary> </indexterm> <indexterm> <primary>Windows</primary> <secondary>Dateien freigeben</secondary> </indexterm> <indexterm> <primary>OS/2</primary> <secondary>Dateien freigeben</secondary> </indexterm> <indexterm> <primary>Linux</primary> <secondary>Dateien freigeben mit einem anderen Betriebssystem</secondary> </indexterm>
 <abstract>
  <para>
   Mit Samba kann ein Unix-Computer als Datei- und Druckserver für Mac OS X-, Windows- und OS/2-Computer konfiguriert werden. Samba ist mittlerweile ein sehr umfassendes und komplexes Produkt. Konfigurieren Sie Samba mit YaST oder indem Sie die Konfigurationsdatei manuell bearbeiten.
  </para>
 </abstract>
 <sect1 id="sec.samba.term">
  <title>Terminologie</title>

  <para>
   Im Folgenden werden einige Begriffe erläutert, die in der Samba-Dokumentation und im YaST-Modul verwendet werden.
  </para>

  <variablelist>
   <varlistentry>
    <term>SMB-Protokoll</term>
    <listitem>
     <para>
      <indexterm> <primary>Samba</primary> <secondary>SMB</secondary> </indexterm> <indexterm> <primary>protocols</primary> <secondary>SMB</secondary> </indexterm> <indexterm> <primary>smbd</primary> </indexterm> Samba verwendet das SMB-Protokoll (Server Message Block), das auf den <phrase role="productname">NetBIOS</phrase>-Diensten basiert. Microsoft veröffentlichte das Protokoll, damit auch andere Softwarehersteller Anbindungen an ein Microsoft-Domänennetzwerk einrichten konnten. Samba setzt das SMB- auf das TCP/IP-Protokoll auf. Entsprechend muss auf allen Clients das TCP/IP-Protokoll installiert sein. <indexterm> <primary>Samba</primary> <secondary>TCP/IP und</secondary> </indexterm>
     </para>
     
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>CIFS-Protokoll</term>
    <listitem>
     <para>
      <indexterm> <primary>Samba</primary> <secondary>CIFS</secondary> </indexterm> <indexterm> <primary>Protokolle</primary> <secondary>CIFS</secondary> </indexterm> Das CIFS-Protokoll (Common Internet File System) ist ein weiteres von Samba unterstütztes Protokoll. CIFS definiert ein Standardprotokoll für den Fernzugriff auf Dateisysteme über das Netzwerk, das Benutzergruppen die netzwerkweite Zusammenarbeit und gemeinsame Dokumentbenutzung ermöglicht.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NetBIOS<indexterm> <primary>Samba</primary> <secondary>Namen</secondary> </indexterm></term>
    <listitem>
     <para>
      <indexterm> <primary>NetBIOS</primary> </indexterm> NetBIOS ist eine Softwareschnittstelle (API) für die Kommunikation zwischen Computern, die einen Name Service bereitstellen. Mit diesem Dienst können die an das Netzwerk angeschlossenen Computer Namen für sich reservieren. Nach dieser Reservierung können die Computer anhand ihrer Namen adressiert werden. Für die Überprüfung der Namen gibt es keine zentrale Instanz. Jeder Computer im Netzwerk kann beliebig viele Namen reservieren, solange die Namen noch nicht Gebrauch sind. Die NetBIOS-Schnittstelle kann in unterschiedlichen Netzwerkarchitekturen implementiert werden. Eine Implementierung, die relativ eng mit der Netzwerkhardware arbeitet, ist <phrase role="productname">NetBEUI</phrase> (häufig auch als <phrase role="productname">NetBIOS</phrase> bezeichnet). Mit NetBIOS implementierte Netzwerkprotokolle sind IPX (NetBIOS über TCP/IP) von Novell und TCP/IP.
     </para>
     <para>
      Die per TCP/IP übermittelten NetBIOS-Namen haben nichts mit den in der Datei <filename>/etc/hosts</filename> oder per DNS vergebenen Namen zu tun. NetBIOS ist ein eigener, vollständig unabhängiger Namensraum. Es empfiehlt sich jedoch, für eine einfachere Administration NetBIOS-Namen zu vergeben, die den jeweiligen DNS-Hostnamen entsprechen, oder DNS nativ zu verwenden. Für einen Samba-Server ist dies die Voreinstellung.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Samba-Server<indexterm> <primary>Samba</primary> <secondary>Server</secondary> </indexterm></term>
    <listitem>
     <para>
      Samba-Server stellt SMB/CIFS-Dienste sowie NetBIOS over IP-Namensdienste für Clients zur Verfügung. Für Linux gibt es drei Dämonen für Samba-Server: smbd für SMB/CIFS-Dienste, nmbd für Naming Services und winbind für Authentifizierung.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Samba-Client<indexterm id="idx.Samba_clients" class="startofrange"> <primary>Samba</primary> <secondary>Clients</secondary> </indexterm></term>
    <listitem>
     <para>
      Der Samba-Client ist ein System, das Samba-Dienste von einem Samba-Server über das SMB-Protokoll nutzt. Das Samba-Protokoll wird von allen gängigen Betriebssystemen wie Mac OS X, Windows und OS/2 unterstützt. Auf den Computern muss das TCP/IP-Protokoll installiert sein. Für die verschiedenen UNIX-Versionen stellt Samba einen Client zur Verfügung. Für Linux gibt es zudem ein Dateisystem-Kernel-Modul für SMB, das die Integration von SMB-Ressourcen auf Linux-Systemebene ermöglicht. Sie brauchen für den Samba-Client keinen Dämon auszuführen.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Freigaben</term>
    <listitem>
     <para>
      <indexterm> <primary>Samba</primary> <secondary>Freigaben</secondary> </indexterm>SMB-Server stellen den Clients Ressourcen in Form von Freigaben (Shares) zur Verfügung. Freigaben sind Drucker und Verzeichnisse mit ihren Unterverzeichnissen auf dem Server. Eine Freigabe wird unter einem eigenen Namen exportiert und kann von Clients unter diesem Namen angesprochen werden. Der Freigabename kann frei vergeben werden. Er muss nicht dem Namen des exportierten Verzeichnisses entsprechen. Ebenso wird einem Drucker ein Name zugeordnet. Clients können mit diesem Namen auf den Drucker zugreifen. <indexterm> <primary>Drucken</primary> <secondary>Samba</secondary> </indexterm> <indexterm> <primary>Samba</primary> <secondary>Drucker</secondary> </indexterm> <indexterm class="endofrange" startref="idx.Samba_clients"/>
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>DC</term>
    <listitem>
     <para>
      <indexterm> <primary>Samba</primary> <secondary>DC</secondary> </indexterm> Ein Domänencontroller (DC) ist ein Server, der Konten in der Domäne verwaltet. Zur Datenreplikation stehen zusätzliche Domain Controller in einer Domäne zur Verfügung.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 id="sec.samba.install">
  <title>Installieren eines Samba-Servers</title>

  <para>
   Zur Installation eines Samba-Servers starten Sie YaST, und wählen Sie <menuchoice><guimenu>Software</guimenu> <guimenu>Software installieren oder löschen</guimenu></menuchoice>. Wählen Sie <menuchoice><guimenu>Anzeigen</guimenu> <guimenu>Schemata</guimenu></menuchoice> und dann <guimenu>Dateiserver</guimenu>. Bestätigen Sie die Installation der erforderlichen Pakete, um den Installationsvorgang abzuschließen.
  </para>
 </sect1>
 
 <sect1 id="sec.samba.serv.inst">
  <title>Konfigurieren eines Samba-Servers</title><indexterm> <primary>Samba</primary> <secondary>Installieren</secondary> </indexterm> <indexterm> <primary>Samba</primary> <secondary>Server</secondary> </indexterm> <indexterm> <primary>Samba</primary> <secondary>Konfigurieren</secondary> </indexterm> <indexterm> <primary>Konfigurieren</primary> <secondary>Samba</secondary> </indexterm>

  

  <para os="sled">
   Informationen zum Konfigurieren eines Samba-Servers finden Sie in der Dokumentationen für SUSE Linux Enterprise Server.
  </para>

  



  
 </sect1>
 <sect1 id="sec.samba.client.inst">
  <title>Konfigurieren der Clients</title><indexterm> <primary>Samba</primary> <secondary>Clients</secondary> </indexterm>

  <para>
   Clients können auf den Samba-Server nur über TCP/IP zugreifen. NetBEUI oder NetBIOS über IPX können mit Samba nicht verwendet werden.
  </para>

  <sect2 id="sec.samba.client.inst.yast">
   <title>Konfigurieren eines Samba-Clients mit YaST</title><indexterm> <primary>YaST</primary> <secondary>Samba</secondary> <tertiary>Clients</tertiary> </indexterm> <indexterm> <primary>Samba</primary> <secondary>Clients</secondary> </indexterm> <indexterm> <primary>Konfigurieren</primary> <secondary>Samba</secondary> <tertiary>Clients</tertiary> </indexterm>
   <para>
    Konfigurieren Sie einen Samba-Client, um auf Ressourcen (Dateien oder Drucker) auf dem Samba- oder Windows-Server zuzugreifen. Geben Sie im Dialogfeld <menuchoice> <guimenu>Netzwerkdienste</guimenu> <guimenu>Windows-Domänenmitgliedschaft</guimenu></menuchoice> die NT- oder Active Directory-Domäne oder -Arbeitsgruppe an. Wenn Sie <guimenu>Zusätzlich SMB-Informationen für Linux-Authentifizierung verwenden </guimenu> aktivieren, erfolgt die Benutzerauthentifizierung über den Samba&amp;#x2011;, NT- oder Kerberos-Server.
   </para>
   <para>
    Klicken Sie für erweiterte Konfigurationsoptionen auf <guimenu>Einstellungen für Experten</guimenu>. Sie können z. B. über die Tabelle <guimenu>Serververzeichnisse einhängen</guimenu> das automatische Einhängen des Server-Basisverzeichnisses bei der Authentifizierung aktivieren. Auf diese Weise können Benutzer auf ihre Home-Verzeichnisse zugreifen, wenn diese in CIFS gehostet sind. Einzelheiten finden Sie auf der man-Seite zu <systemitem>pam_mount</systemitem>.
   </para>
   <para>
    Bestätigen Sie zum Abschluss alle Einstellungen, um die Konfiguration zu beenden.
   </para>
  </sect2>
 </sect1>
 <sect1 id="sec.samba.anmeld.serv">
  <title>Samba als Anmeldeserver</title><indexterm> <primary>Samba</primary> <secondary>Anmelden</secondary> </indexterm>

  <para>
   In Netzwerken, in denen sich überwiegend Windows-Clients befinden, ist es oft wünschenswert, dass sich Benutzer nur mit einem gültigen Konto und zugehörigem Passwort anmelden dürfen. In einem Windows-basierten Netzwerk wird diese Aufgabe von einem Primary Domain Controller (PDC) übernommen. Sie können einen Windows NT-Server verwenden, der als PDC konfiguriert ist; diese Aufgabe kann aber auch mithilfe eines Samba-Servers ausgeführt werden. Es müssen Einträge im Abschnitt <literal>[global]</literal> von <filename>smb.conf</filename> vorgenommen werden. Diese werden in <xref linkend="dat.samba.smb.conf.dom"/> beschrieben.
  </para>

  <example id="dat.samba.smb.conf.dom">
   <title>Abschnitt „global“ in smb.conf</title>
<screen>[global]
    workgroup = WORKGROUP
    domain logons = Yes
    domain master = Yes</screen>
  </example>

  <para>
   Die Benutzerkonten und Passwörter müssen in ein Windows-konformes Verschlüsselungsformat umgewandelt werden. Dies erfolgt mit dem Befehl <command>smbpasswd<option>-a name</option></command>. Da nach dem Windows-Domänenkonzept auch die Computer selbst ein Domänenkonto benötigen, wird dieses mit den folgenden Kommandos angelegt:
  </para>

<screen>useradd hostname\$
smbpasswd -a -m hostname</screen><indexterm> <primary>commands</primary> <secondary>smbpasswd</secondary> </indexterm>

  <para>
   Mit dem Befehl <command>useradd</command> wird ein Dollarzeichen hinzugefügt. Der Befehl <command>smbpasswd</command> fügt dieses bei der Verwendung des Parameters <option>-m</option> automatisch hinzu. In der kommentierten Beispielkonfiguration (<filename>/usr/share/doc/packages/Samba/examples/smb.conf.SuSE</filename>) sind Einstellungen enthalten, die diese Aufgabe automatisieren.
  </para>

<screen>add machine script = /usr/sbin/useradd -g nogroup -c "NT Machine Account" \
-s /bin/false %m\$
     </screen>

  <para>
   Um sicherzustellen, dass Samba dieses Skript korrekt ausführen kann, wählen Sie einen Samba-Benutzer mit den erforderlichen Administratorberechtigungen und fügen Sie ihn zur Gruppe <systemitem class="groupname">ntadmin</systemitem> hinzu. Anschließend können Sie allen Mitgliedern der Linux-Gruppe den Status <literal>Domain Admin</literal> zuweisen, indem Sie folgendes Kommando eingeben:
  </para>

<screen>net groupmap add ntgroup="Domain Admins" unixgroup=ntadmin</screen>
 </sect1>
 
 <sect1 id="samba.advanced">
  <title>Weitere Themen</title>

  <para>
   In diesem Abschnitt lernen Sie fortgeschrittene Vefahren zur Verwaltung des Client- und des Serverteils der Samba-Suite kennen.
  </para>

  <sect2 id="samba.advanced.compress">
   <title>Transparente Dateikomprimierung mit Btrfs</title>
   <para>
    Mit Samba können die Clients die Flags für die Datei- und Verzeichniskomprimierung für Freigaben, die sich im Btrfs-Dateisystem befinden, im Fernverfahren bearbeiten. Windows Explorer bietet im Dialogfeld <menuchoice><guimenu>Datei</guimenu><guimenu>Eigenschaften</guimenu><guimenu>Erweitert</guimenu></menuchoice> die Möglichkeit, die Dateien/Verzeichnisse zur transparenten Komprimierung zu kennzeichnen:
   </para>
   <figure>
    <title>Dialogfeld <guimenu>Erweiterte Attribute</guimenu> in Windows Explorer</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="samba_win_expl_advattr.png" width="30%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="samba_win_expl_advattr.png" width="30%" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    Die zur Komprimierung gekennzeichneten Dateien werden beim Zugreifen oder Ändern transparent durch das zugrunde liegende Dateisystem komprimiert bzw. dekomprimiert. Damit sparen Sie Speicherplatz, doch beim Zugreifen auf die Datei wird die CPU stärker beansprucht. Neue Dateien und Verzeichnisse übernehmen das Komprimierungs-Flag vom übergeordneten Verzeichnis, sofern sie nicht mit der Option FILE_NO_COMPRESSION erstellt werden.
   </para>
   <para>
    Komprimierte Dateien und Verzeichnisse werden in Windows Explorer anders dargestellt als nicht komprimierte Dateien und Verzeichnisse:
   </para>
   <figure>
    <title>Windows Explorer-Anzeige mit komprimierten Dateien</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="samba_win_expl_view_compressed.png" width="30%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="samba_win_expl_view_compressed.png" width="30%" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    Sie können die Komprimierung der Samba-Freigabe wahlweise manuell aktivieren (fügen Sie hierzu
   </para>
<screen>vfs objects = btrfs</screen>
   <para>
    in die Freigabekonfiguration in <filename>/etc/samba/smb.conf</filename> ein) oder mit YaST. Wählen Sie hierzu <menuchoice><guimenu>Netzwerkdienste</guimenu><guimenu>Samba-Server</guimenu><guimenu>Hinzufügen</guimenu></menuchoice>, und aktivieren Sie die Option <guimenu>Btrfs-Funktionen verwenden</guimenu>.
   </para>
  </sect2>

  <sect2 id="samba.advanced.snapshots">
   <title>Aufnahmen</title>
   <para>
    Snapshots (auch als Schattenkopien bezeichnet) sind Kopien des Zustands eines Subvolumens in einem Dateisystem zu einem bestimmten Zeitpunkt. Die Verwaltung dieser Snapshots in Linux erfolgt mit Snapper. Die Snapshots werden auf dem Btrfs-Dateisystem sowie auf LVM-Volumes mit Thin-Provisioning unterstützt. Die Samba-Suite unterstützt die Verwaltung von Remote-Snapshots über das FSRVP-Protokoll sowohl auf Server- als auch auf Clientseite.
   </para>
   <sect3 id="samba.advanced.snapshots.client">
    <title>Frühere Versionen</title>
    <para>
     Die Snapshots auf einem Samba-Server können für entfernte Windows-Clients als Datei- oder Verzeichnis-Vorgängerversionen gezeigt werden.
    </para>
    <para>
     Zum Aktivieren von Snapshots auf einem Samba-Server müssen die folgenden Voraussetzungen erfüllt sein:
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       Die SMB-Netzwerkfreigabe befindet sich auf einem Btrfs-Subvolume.
      </para>
     </listitem>
     <listitem>
      <para>
       Für den Pfad der SMB-Netzwerkfreigabe ist eine zugehörige Snapper-Konfigurationsdatei vorhanden. Sie können die Snapper-Datei wie folgt erstellen:
      </para>
<screen>snapper -c &lt;cfg_name&gt; create-config <option>/path/to/share</option></screen>
      <para>
       Weitere Informationen zu Snapper finden Sie in <xref linkend="cha.snapper"/>.
      </para>
     </listitem>
     <listitem>
      <para>
       Der Snapshot-Verzeichnisbaum muss den Zugriff für relevante Benutzer ermöglichen. Weitere Informationen finden Sie auf der man-Seite zu vfs_snapper (<command>man 8 vfs_snapper</command>) im Abschnitt zu den Berechtigungen.
      </para>
     </listitem>
    </itemizedlist>
    <para>
     Sollen Remote-Snapshots unterstützt werden, 
müssen Sie die Datei <filename>/etc/samba/smb.conf</filename> bearbeiten. Verwenden Sie hierzu wahlweise <menuchoice><guimenu>YaST</guimenu><guimenu>Netzwerkdienste</guimenu><guimenu>Samba-Server</guimenu></menuchoice>, oder bearbeiten Sie den relevanten Freigabeabschnitt manuell mit
    </para>
<screen>vfs objects = snapper</screen>
    <para>
     Damit die manuellen Änderungen an <filename>smb.conf</filename> in Kraft treten, müssen Sie den Samba-Service wie folgt neu starten:
    </para>
<screen>systemctl restart nmb.service smb.service</screen>
    <figure id="fig.yast2.samba.snapshot">
     <title>Hinzufügen einer neuen Samba-Freigabe mit aktivierter Snapshot-Aufnahme</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="yast2_samba_snapshot.png" width="70%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="yast2_samba_snapshot.png" width="75%" format="PNG"/>
      </imageobject>
     </mediaobject>
    </figure>
    <para>
     Nach der Konfiguration können Sie auf die Snapshots, die Snapper für den Samba-Freigabepfad erstellt hat, in Windows Explorer über die Registerkarte <guimenu>Vorgängerversionen</guimenu> für eine Datei oder ein Verzeichnis zugreifen.
    </para>
    <figure id="fig.samba.win_explorer">
     <title>Die Registerkarte <guimenu>Vorgängerversionen</guimenu> in Windows Explorer</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="samba_winexpl_previous_versions.png" width="70%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="samba_winexpl_previous_versions.png" width="75%" format="PNG"/>
      </imageobject>
     </mediaobject>
    </figure>
   </sect3>
   <sect3 id="samba.advanced.snapshots.server">
    <title>Remote-Snapshots für Freigaben</title>
    <para>
     Standardmäßig können Snapshots lediglich lokal auf dem Samba-Server erstellt und gelöscht werden (mit dem Kommandozeilenprogramm Snapper oder mit der Zeitleistenfunktion in Snapper).
    </para>
    <para>
     Sie können Samba so konfigurieren, dass Anfragen zum Erstellen und Löschen von Snapshots für Freigaben verarbeitet werden, die von entfernten Hosts über das FSRVP (File Server Remote VSS-Protokoll) gesendet werden.
    </para>
    <para>
     Neben den Konfigurationsschritten und Voraussetzungen in <xref linkend="samba.advanced.snapshots.client"/> ist die folgende globale Konfiguration in <filename>/etc/samba/smb.conf</filename> erforderlich:
    </para>
<screen>[global]
rpc_daemon:fssd = fork
registry shares = yes
include = registry</screen>
    <para>
     FSRVP-Clients (auch <command>rpcclient</command> in Samba und <command>DiskShadow.exe</command> in Windows Server 2012) können dann Samba anweisen, einen Snapshot für eine bestimmte Freigabe zu erstellen und den Snapshot als neue Freigabe zu zeigen.
    </para>
   </sect3>
   <sect3 id="samba.advanced.snapshots.client.linux">
    <title>Fernverwaltung von Snapshots in Linux mit <command>rpcclient</command></title>
    <para>
     Das Paket <systemitem>samba-client</systemitem> umfasst einen FSRVP-Client, der im Fernverfahren eine Anfrage an einen Windows-/Samba-Server stellen kann, einen Snapshot für eine bestimmte Freigabe zu erstellen und zu zeigen. Anschließend können Sie die gezeigte Freigabe mit den vorhandenen Werkzeugen in SUSE Linux Enterprise Server einhängen und die Dateien in dieser Freigabe sichern. Die Anfragen werden über die Binärdatei <command>rpcclient</command> an den Server gesendet.
    </para>
    <example>
     <title>Anfordern eines Snapshots für eine Windows Server 2012-Freigabe mit <command>rpcclient</command></title>
     <para>
      Stellen Sie eine Verbindung zum Server <literal>win-server.example.com</literal> als Administrator in der Domäne <literal>EXAMPLE</literal> her:
     </para>
<screen># rpcclient -U '<replaceable>EXAMPLE</replaceable>\Administrator' ncacn_np:<replaceable>win-server.example.com</replaceable>[ndr64,sign]
Enter EXAMPLE/Administrator's password:</screen>
     <para>
      Überprüfen Sie, ob die SMB-Freigabe für <command>rpcclient</command> sichtbar ist:
     </para>
<screen>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark: 
path:   C:\Shares\windows_server_2012_share
password:       (null)</screen>
     <para>
      Überprüfen Sie, ob die SMB-Freigabe das Erstellen von Snapshots unterstützt:
     </para>
<screen>rpcclient $&gt; fss_is_path_sup windows_server_2012_share \
UNC \\WIN-SERVER\windows_server_2012_share\ supports shadow copy requests</screen>
     <para>
      Fordern Sie die Erstellung eines Snapshots für eine Freigabe an:
     </para>
<screen>rpcclient $&gt; fss_create_expose backup ro windows_server_2012_share
13fe880e-e232-493d-87e9-402f21019fb6: shadow-copy set created
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
\\WIN-SERVER\windows_server_2012_share\ shadow-copy added to set
13fe880e-e232-493d-87e9-402f21019fb6: prepare completed in 0 secs
13fe880e-e232-493d-87e9-402f21019fb6: commit completed in 1 secs
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
share windows_server_2012_share@{1C26544E-8251-445F-BE89-D1E0A3938777} \
exposed as a snapshot of \\WIN-SERVER\windows_server_2012_share\</screen>
     <para>
      Überprüfen Sie, ob der Snapshot der Freigabe durch den Server gezeigt wird:
     </para>
<screen>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark: 
path:   C:\Shares\windows_server_2012_share
password:       (null)

netname: windows_server_2012_share@{1C26544E-8251-445F-BE89-D1E0A3938777}
remark: (null)
path:   \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy{F6E6507E-F537-11E3-9404-B8AC6F927453}\Shares\windows_server_2012_share\
password:       (null)</screen>
     <para>
      Versuchen Sie, den Snapshot der Freigabe zu löschen:
     </para>
<screen>rpcclient $&gt; fss_delete windows_server_2012_share \
13fe880e-e232-493d-87e9-402f21019fb6 1c26544e-8251-445f-be89-d1e0a3938777
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
\\WIN-SERVER\windows_server_2012_share\ shadow-copy deleted</screen>
     <para>
      Überprüfen Sie, ob der Snapshot der Freigabe durch den Server entfernt wurde:
     </para>
<screen>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark: 
path:   C:\Shares\windows_server_2012_share
password:       (null)</screen>
    </example>
   </sect3>
   <sect3 id="samba.advanced.snapshots.client.winserver">
    <title>Fernverwaltung von Snapshots in Windows mit <command>DiskShadow.exe</command></title>
    <para>
     Sie können Snapshots von SMB-Freigaben auf dem Linux Samba-Server auch über die Windows-Umgebung, die als Client auftritt, verwalten. Mit dem Dienstprogramm <command>DiskShadow.exe</command> in Windows Server 2012 verwalten Sie Remote-Freigaben ähnlich wie mit <command>rpcclient</command> (siehe <xref linkend="samba.advanced.snapshots.client.linux"/>). Zunächst muss jedoch der Samba-Server ordnungsgemäß eingerichtet werden.
    </para>
    <para>
     Im Folgenden wird erläutert, wie Sie einen Samba-Server so konfigurieren, dass der Windows Server-Client die Snapshots der Freigaben auf dem Samba-Server verwalten kann. EXAMPLE bezeichnet hierbei die Active Directory-Domäne in der Testumgebung, fsrvp-server.example.com ist der Hostname des Samba-Servers, und <filename>/srv/smb</filename> ist der Pfad zur SMB-Freigabe.
    </para>
    <procedure>
     <title>Ausführliche Konfiguration des Samba-Servers</title>
     <step performance="required">
      <para>
       Treten Sie der Active Directory-Domäne mithilfe von YaST bei.
      </para>
     </step>
     <step performance="required">
      <para>
       Prüfen Sie, ob der DNS-Eintrag der Active Directory-Domäne korrekt ist:
      </para>
<screen>fsrvp-server:~ # net -U 'Administrator' ads dns register \
fsrvp-server.example.com &lt;IP address&gt;
Successfully registered hostname with DNS</screen>
     </step>
     <step performance="required">
      <para>
       Erstellen Sie ein Btrfs-Subvolume unter <filename>/srv/smb</filename>:
      </para>
<screen>fsrvp-server:~ # btrfs subvolume create /srv/smb</screen>
     </step>
     <step performance="required">
      <para>
       Erstellen Sie eine Snapper-Konfigurationsdatei für den Pfad <filename>/srv/smb</filename>:
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; create-config /srv/smb</screen>
     </step>
     <step performance="required">
      <para>
       Erstellen Sie eine neue Freigabe mit dem Pfad <filename>/srv/smb</filename>, und aktivieren Sie in YaST das Kontrollkästchen <guimenu>Snapshots zeigen</guimenu>. Fügen Sie in jedem Fall die folgenden Snippets in den globalen Abschnitt der Datei <filename>/etc/samba/smb.conf</filename> ein (siehe <xref linkend="samba.advanced.snapshots.server"/>):
      </para>
<screen>[global]
 rpc_daemon:fssd = fork
 registry shares = yes
 include = registry</screen>
     </step>
     <step performance="required">
      <para>
       Starten Sie Samba mit <command>systemctl restart nmb.service smb.service</command> neu.
      </para>
     </step>
     <step performance="required">
      <para>
       Konfigurieren Sie die Snapper-Berechtigungen:
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; set-config \
ALLOW_USERS="EXAMPLE\\\\Administrator EXAMPLE\\\\win-client$"</screen>
      <para>
       Überprüfen Sie, ob alle unter ALLOW_USERS aufgeführten Benutzer auch die Berechtigung für das Traversal des Unterverzeichnisses <filename>.snapshots</filename> besitzen.
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; set-config SYNC_ACL=yes</screen>
      <important>
       <title>Escape-Zeichen bei Pfaden</title>
       <para>
        Gehen Sie mit dem Escape-Zeichen „\“ vorsichtig vor! Setzen Sie das Escape-Zeichen zweimal, damit der Wert in <filename>/etc/snapper/configs/&lt;snapper_config&gt;</filename> ordnungsgemäß auskommentiert wird.
       </para>
      </important>
      <para>
       „EXAMPLE\win-client$“ bezeichnet das Windows-Clientkonto. Die anfänglichen FSRVP-Anfragen von Windows werden mit diesem Konto ausgegeben.
      </para>
     </step>
     <step performance="required">
      <para>
       Erteilen Sie dem Windows-Clientkonto die erforderlichen Berechtigungen:
      </para>
<screen>fsrvp-server:~ # net -U 'Administrator' rpc rights grant \
"EXAMPLE\\win-client$" SeBackupPrivilege
Successfully granted rights.</screen>
      <para>
       Für den Benutzer „EXAMPLE\Administrator“ muss das obige Kommando nicht ausgeführt werden, da diese Konto bereits die Berechtigungen besitzt.
      </para>
     </step>
    </procedure>
    <procedure>
     <title>Einrichten des Windows-Clients und Ausführen von <command>DiskShadow.exe</command></title>
     <step performance="required">
      <para>
       Booten Sie Windows Server 2012 (Beispiel-Hostname: WIN-CLIENT).
      </para>
     </step>
     <step performance="required">
      <para>
       Treten Sie derselben Active Directory-Domäne EXAMPLE bei wie mit dem SUSE Linux Enterprise-Server.
      </para>
     </step>
     <step performance="required">
      <para>
       Booten Sie den Computer neu.
      </para>
     </step>
     <step performance="required">
      <para>
       Öffnen Sie die Powershell.
      </para>
     </step>
     <step performance="required">
      <para>
       Starten Sie <command>DiskShadow.exe</command>, und beginnen Sie den Sicherungsvorgang:
      </para>
<screen>PS C:\Users\Administrator.EXAMPLE&gt; diskshadow.exe
Microsoft DiskShadow version 1.0
Copyright (C) 2012 Microsoft Corporation
On computer:  WIN-CLIENT,  6/17/2014 3:53:54 PM

DISKSHADOW&gt; begin backup</screen>
     </step>
     <step performance="required">
      <para>
       Geben Sie an, dass die Schattenkopie auch beim Beenden des Programms, beim Zurücksetzen und beim Neubooten erhalten bleiben soll:
      </para>
<screen>DISKSHADOW&gt; set context PERSISTENT</screen>
     </step>
     <step performance="required">
      <para>
       Überprüfen Sie, ob die angegebene Freigabe Snapshots unterstützt, und erstellen Sie einen Snapshot:
      </para>
<screen>DISKSHADOW&gt; add volume \\fsrvp-server\sles_snapper

DISKSHADOW&gt; create
Alias VSS_SHADOW_1 for shadow ID {de4ddca4-4978-4805-8776-cdf82d190a4a} set as \
 environment variable.
Alias VSS_SHADOW_SET for shadow set ID {c58e1452-c554-400e-a266-d11d5c837cb1} \
 set as environment variable.

Querying all shadow copies with the shadow copy set ID \
 {c58e1452-c554-400e-a266-d11d5c837cb1}

 * Shadow copy ID = {de4ddca4-4978-4805-8776-cdf82d190a4a}     %VSS_SHADOW_1%
    - Shadow copy set: {c58e1452-c554-400e-a266-d11d5c837cb1}  %VSS_SHADOW_SET%
    - Original count of shadow copies = 1
    - Original volume name: \\FSRVP-SERVER\SLES_SNAPPER\ \
      [volume not on this machine]
    - Creation time: 6/17/2014 3:54:43 PM
    - Shadow copy device name: 
      \\FSRVP-SERVER\SLES_SNAPPER@{31afd84a-44a7-41be-b9b0-751898756faa}
    - Originating machine: FSRVP-SERVER
    - Service machine: win-client.example.com
    - Not exposed
    - Provider ID: {89300202-3cec-4981-9171-19f59559e0f2}
    - Attributes:  No_Auto_Release Persistent FileShare

Number of shadow copies listed: 1</screen>
     </step>
     <step performance="required">
      <para>
       Beenden Sie den Sicherungsvorgang:
      </para>
<screen>DISKSHADOW&gt; end backup</screen>
     </step>
     <step performance="required">
      <para>
       Versuchen Sie, den erstellten Snapshot zu löschen, und überprüfen Sie, ob er tatsächlich gelöscht wurde:
      </para>
<screen>DISKSHADOW&gt; delete shadows volume \\FSRVP-SERVER\SLES_SNAPPER\
Deleting shadow copy {de4ddca4-4978-4805-8776-cdf82d190a4a} on volume \
 \\FSRVP-SERVER\SLES_SNAPPER\ from provider \
{89300202-3cec-4981-9171-19f59559e0f2} [Attributes: 0x04000009]...

Number of shadow copies deleted: 1

DISKSHADOW&gt; list shadows all

Querying all shadow copies on the computer ...
No shadow copies found in system.</screen>
     </step>
    </procedure>
   </sect3>
  </sect2>
 </sect1>
 <sect1 id="sec.samba.info">
  <title>Weiterführende Informationen</title>

  <para>
   Die Dokumentation zu Samba ist im Paket <systemitem>samba-doc</systemitem> enthalten, das standardmäßig nicht installiert wird. Installieren Sie das Paket mit <command>zypper install samba-doc</command>. Wenn Samba installiert ist, können Sie in die Kommandozeile <command>apropos</command> <option>samba</option> eingeben und einige man-Seiten aufrufen. Alternativ dazu finden Sie im Verzeichnis <filename>/usr/share/doc/packages/samba </filename> weitere Online-Dokumentationen und Beispiele. Eine kommentierte Beispielkonfiguration (<filename>smb.conf.SuSE</filename>) finden Sie im Unterverzeichnis <filename>examples</filename>. Auch in der Datei <filename>/usr/share/doc/packages/samba/README.SUSE</filename> finden Sie zusätzliche Informationen zu Samba. <indexterm> <primary>Konfigurationsdateien</primary> <secondary>smb.conf</secondary> </indexterm>
  </para>

  <para>
   Das Samba-Team stellt in Samba HOWTO (siehe <ulink url="https://wiki.samba.org"/>) einen Abschnitt zur Fehlerbehebung zur Verfügung. In Teil V ist außerdem eine ausführliche Anleitung zum Überprüfen der Konfiguration enthalten. 
  </para><indexterm class="endofrange" startref="idx.Samba"/>
 </sect1>
</chapter>
