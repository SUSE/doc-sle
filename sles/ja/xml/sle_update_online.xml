<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_online.xml" version="5.0" xml:id="cha.update.online">
 <title>オンラインでのアップグレード</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    SUSEは、動作中のシステムを新しいサービスパックにアップグレードするための直感的なグラフィカルツールとシンプルなコマンドラインツールを提供します。これらのツールは、サービスパックの<quote>ロールバック</quote>などをサポートしています。この章では、これらのツールを使用してサービスパックのアップグレードを実行する方法を順を追って説明します。
   </para>
  </abstract>
 </info>
 <sect1 xml:id="sec.update.migr.conceptual-overview">
  <title>概念の概要</title>

  <para>
   SUSEは、SUSE Linux Enterpriseファミリ用の新しいサービスパックを定期的にリリースしています。お客様が新しいサービスパックに容易に移行してダウンタイムを最小限に抑えることができるよう、SUSEはシステム実行中のオンラインマイグレーションをサポートしています。
  </para>

  <para>
   SLE 12から、YaST WagonはYaSTマイグレーション(GUI)およびZypperマイグレーション(コマンドライン)に置き換えられました。次の機能がサポートされています。
  </para>

  <itemizedlist>
   <listitem>
    <para>
     最初のRPMが更新されるまで、システムは常に定義済みの状態
    </para>
   </listitem>
   <listitem>
    <para>
     最初のRPMが更新されるまでは、キャンセルが可能
    </para>
   </listitem>
   <listitem>
    <para>
     エラーが発生した場合、簡単に回復
    </para>
   </listitem>
   <listitem>
    <para>
     システムツールによって<quote>ロールバック</quote>、バックアップ/復元は不要
    </para>
   </listitem>
   <listitem>
    <para>
     アクティブなすべてのリポジトリを使用
    </para>
   </listitem>
   <listitem>
    <para>
     サービスパックをスキップ可能
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.workflow">
  <title>サービスパックのマイグレーションのワークフロー</title>

  <para>
   サービスパックのマイグレーションは、YaST、<command>zypper</command>、またはAutoYaSTにより実行できます。
  </para>

  <para>
   サービスパックのマイグレーションを開始する前に、SUSEカスタマーセンターまたはローカルSMTサーバでシステムを登録する必要があります。SUSE Managerも使用できます。
  </para>

  <para>
   どの方法を使用する場合も、サービスパックのマイグレーションは次の手順で構成されます。
  </para>

  <orderedlist>
   <listitem>
    <para>
     登録システムで、マイグレーションターゲットの候補を見つけます。
    </para>
   </listitem>
   <listitem>
    <para>
     マイグレーションターゲットを1つ選択します。
    </para>
   </listitem>
   <listitem>
    <para>
     新しいリポジトリを要求して有効にします。
    </para>
   </listitem>
   <listitem>
    <para>
     マイグレーションを実行します。
    </para>
   </listitem>
  </orderedlist>



  <para>
   マイグレーションターゲットのリストは、インストールおよび登録されている製品に応じて異なります。新しいSPがまだ利用可能になっていない拡張機能がインストールされている場合、マイグレーションターゲットが提供されない可能性があります。
  </para>

  <para>
   ホストで使用可能なマイグレーションターゲットのリストは、常にSUSEカスタマーセンターから取得され、インストールされている製品または拡張機能に応じて異なります。
  </para>
 </sect1>
 <sect1 xml:id="sec.update.migr.cancel.spm">
  <title>サービスパックのマイグレーションのキャンセル</title>

  <para>
   サービスパックのマイグレーションは、マイグレーションプロセスの特定の段階でのみキャンセルできます。
  </para>

  <orderedlist>
   <listitem>
    <para>
     パッケージのアップグレードが開始されるまで、システムには、サービスやリポジトリなどの最小限の変更しか加えられません。以前の状態に戻すには、<filename>/etc/zypp/repos.d/*</filename>を復元します。
    </para>
   </listitem>
   <listitem>
    <para>
     パッケージのアップグレードが開始された後は、Snapperスナップショットを使用して以前の状態に戻すことができます(<xref linkend="cha.snapper"/>を参照してください)。
    </para>
   </listitem>
   <listitem>
    <para>
     マイグレーションターゲットが選択された後、SUSEカスタマーセンターによってリポジトリデータが変更されます。この状態を手動で元に戻すには、<command>SUSEConnect</command>
     <option> --rollback</option>を使用します。
    </para>
   </listitem>
  </orderedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.yast.onlinemigr">
  <title>オンラインマイグレーションツール(YaST)を使用したアップグレード</title>

  <para>
   YaSTを使用してサービスパックのマイグレーションを実行するには、<guimenu>Online Migration (オンラインマイグレーション)</guimenu>ツールを使用します。デフォルトでは、YaSTはサードパーティリポジトリからパッケージをインストールしません。パッケージがサードパーティリポジトリからインストールされている場合、YaSTは、SUSEから提供されている同じパッケージによってパッケージが置き換えられるのを防ぎます。
  </para>

  <note>
   <title>インストールサイズの削減</title>
   <para>
    SPのマイグレーションの実行時に、YaSTは推奨パッケージをすべてインストールします。特にカスタム最小インストールの場合、これによってシステムのインストールサイズが大幅に増加することがあります。
   </para>
   <para>
    このデフォルトの動作を変更して、必須パッケージのみがインストールされるようにするには、<filename>/etc/zypp/zypp.conf</filename>を調整して次の変数を設定します。
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   これにより、パッチや新しいパッケージのインストールなど、すべてのパッケージ操作の動作が変更されます。
  </para>

  <para>
   サービスパックのマイグレーションを開始するには、次の手順を実行します。
  </para>

  <procedure xml:id="pro.update.migr.yast">
   <step>
    <para>
     登録サーバ上の未使用の拡張機能をすべて無効にして、将来、依存関係の競合が発生が発生するのを防ぎます。拡張機能を覚えていなくても、後でYaSTによって未使用の拡張機能リポジトリが検出され、無効にされます。
    </para>
   </step>
   <step>
    <para>
     更新するマシンで実行されているGNOMEセッションにログインしている場合は、テキストコンソールに切り替えます。GNOMEセッション内からアップデートを実行することはお勧めしません。これは、リモートマシンからログインしている場合には該当しません(ただし、GNOMEでVNCセッションを実行している場合を除きます)。
    </para>
   </step>
   <step>
    <para>
     LTSSの加入者である場合は、LTSS拡張機能リポジトリがアクティブであることを確認します。
    </para>
   </step>
   <step>
    <para>
     YaSTオンラインアップデートを実行して、システム用の最新のパッケージのアップデートを取得します。
    </para>
   </step>
   <step>
    <para>
     パッケージ
     <package>yast2-migration</package>
     およびその依存関係をインストールします(YaSTの<menuchoice>
     <guimenu> ソフトウェア</guimenu> <guimenu> ソフトウェア管理</guimenu>
     </menuchoice> )。
    </para>
   </step>
   <step>
    <para>
     YaSTを再起動します。再起動しないと、新しくインストールしたモジュールがコントロールセンターに表示されません。
    </para>
   </step>
   <step>
    <para>
     YaSTで<menuchoice> <guimenu>システム</guimenu> <guimenu> Online Migration (オンラインマイグレーション)</guimenu> </menuchoice>を起動します。可能性のあるマイグレーションターゲットと概要がYaSTによって表示されます。システムで使用可能なマイグレーションターゲットが複数ある場合は、リストから1つを選択します。
    </para>
   </step>
   <step>
    <para>
     リストからマイグレーションターゲットを1つ選択し、<guimenu>次へ</guimenu>で続行します。
    </para>
   </step>
   <step>
    <para>
     マイグレーションツールによってアップデートリポジトリが提供される場合は、<guimenu>はい</guimenu>で続行することをお勧めします。
    </para>
   </step>
   <step>
    <para>
     <remark>toms 2015-09-09: FATE#319140</remark>［Online Migration (オンラインマイグレーション)］ツールにより、DVDまたはローカルサーバから提供されている古いリポジトリが検出される場合は、それらを無効にすることを強くお勧めします。古いリポジトリは以前のSPのものです。SCCまたはSMTの古いリポジトリは自動的に削除されます。
    </para>
   </step>
   <step>
    <para>
     概要を確認し、<guimenu>Next (次へ)</guimenu>をクリックしてマイグレーションを続行します。<guimenu>Start Update (アップデートの開始)</guimenu>を選択して確認します。
    </para>
    <remark>toms 2016-07-13: What to do in case of problems?</remark>
   </step>
   <step>
    <para>
     マイグレーションが正常に完了したら、システムを再起動します。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.zypper.onlinemigr">
  <title>Zypperによるアップグレード</title>

  <para>
   Zypperを使用してサービスパックのマイグレーションを実行するには、コマンドラインツール<command>zypper</command> <option> migration</option>を使用します。
  </para>

  <note>
   <title>インストールサイズの削減</title>
   <para>
    SPのマイグレーションの実行時に、YaSTは推奨パッケージをすべてインストールします。特にカスタム最小インストールの場合、これによってシステムのインストールサイズが大幅に増加することがあります。
   </para>
   <para>
    このデフォルトの動作を変更して、必須パッケージのみがインストールされるようにするには、<filename>/etc/zypp/zypp.conf</filename>を調整して次の変数を設定します。
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   これにより、パッチや新しいパッケージのインストールなど、すべてのパッケージ操作の動作が変更されます。1回の起動に対してのみZypperの動作を変更するには、パラメータ<option>--no-recommends</option>をコマンドラインに追加します。
  </para>

  <para>
   サービスパックのマイグレーションを開始するには、次の手順を実行します。
  </para>

  <procedure xml:id="pro.update.migr.zypper">
   <step>
    <para>
     更新するマシンで実行されているGNOMEセッションにログインしている場合は、テキストコンソールに切り替えます。GNOMEセッション内からアップデートを実行することはお勧めしません。これは、リモートマシンからログインしている場合には該当しません(ただし、GNOMEでVNCセッションを実行している場合を除きます)。
    </para>
   </step>
   <step>
    <para>
     SUSE Linux Enterpriseマシンをまだ登録していない場合は登録します。
    </para>
<screen>sudo <command>SUSEConnect</command> --regcode <replaceable>YOUR_REGISTRATION_CODE</replaceable></screen>
   </step>
   <step>
    <para>
     LTSSの加入者である場合は、LTSS拡張機能リポジトリがアクティブであることを確認します。
    </para>
   </step>
   <step>
    <para>
     最新のアップデートをインストールします。
    </para>
<screen>sudo <command>zypper</command> patch</screen>
   </step>
   <step>
    <para>
     次のようにして <package>zypper-migration-plugin</package> パッケージとその依存関係をインストールします。
    </para>
<screen>sudo <command>zypper</command> in zypper-migration-plugin</screen>
   </step>
   <step>
    <para>
     <command>zypper</command> <option> migration</option>を実行します。
    </para>
<screen><prompt>tux &gt; </prompt>sudo <command>zypper</command> migration
Executing 'zypper  patch-check'

Refreshing service 'SUSE_Linux_Enterprise_Server_12_x86_64'.
Loading repository data...
Reading installed packages...
0 patches needed (0 security patches)

Available migrations:

    1 | SUSE Linux Enterprise Server 12 SP1 x86_64
    2 | SUSE Linux Enterprise Server 12 SP2 x86_64</screen>
    <para>
     マイグレーションプロセスに関する注記
    </para>
    <itemizedlist>
     <listitem>
      <para>
       システムで使用可能なマイグレーションターゲットが複数ある場合は、Zypperでリストから1つを選択できます。これはSPを1つまたは複数スキップするのと同じことです。基本製品(SLES、SLED)のオンラインマイグレーションを使用できるのは、メジャーバージョンのSP間のみであることに注意してください。
      </para>
     </listitem>
     <listitem>
      <para>
       デフォルトでは、Zypperは、<option>zypper</option> dup<command>に渡されるオプション</command> <option>--no-allow-vendor-change</option>を使用します。パッケージがサードパーティリポジトリからインストールされている場合、このオプションにより、SUSEから提供されている同じパッケージによって該当するパッケージが置き換えられるのを防ぎます。
      </para>
     </listitem>
     <listitem>
      <para>
       <remark>toms 2015-09-09: FATE#319140</remark>Zypperにより、DVDまたはローカルサーバから提供されている古いリポジトリが検出される場合は、それらを無効にすることを強くお勧めします。古いSCCまたはSMTリポジトリは自動的に削除されます。
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     すべての変更内容を確認します。特に、削除されるパッケージに注意してください。「<literal>y</literal>」と入力して続行します(アップグレードするパッケージの正確な数はシステムによって異なる可能性があります)。
    </para>
<screen>266 packages to upgrade, 54 to downgrade, 17 new, 8 to reinstall, 5 to remove, 1 to change arch.
Overall download size: 285.1 MiB. Already cached: 0 B  After the operation, additional 139.8 MiB will be used.
Continue? [y/n/? shows all options] (y):</screen>
    <para>
     シェルをスクロールするには、<keycombo> <keycap function="shift"/> <keycap function="pageup"/>
     </keycombo>   または<keycombo> <keycap function="shift"/>
     <keycap function="pagedown"/> </keycombo>   キーを使用します。
    </para>
   </step>
   <step>
    <para>
     マイグレーションが正常に完了したら、システムを再起動します。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.plainzypper.onlinemigr">
  <title>プレーンZypperによるアップグレード</title>

  <para>
   YaSTマイグレーションまたはZypperマイグレーションを使用できない場合でも、プレーンZypperといくつかの手動操作でマイグレートできます。サービスパックのマイグレーションを開始するには、次の手順を実行します。
  </para>

  <procedure>
   <step>
    <para>
     更新するマシンで実行されているGNOMEセッションにログインしている場合は、テキストコンソールに切り替えます。GNOMEセッション内からアップデートを実行することはお勧めしません。これは、リモートマシンからログインしている場合には該当しません(ただし、GNOMEでVNCセッションを実行している場合を除きます)。
    </para>
   </step>
   <step>
    <para>
     SUSE Linux Enterpriseの古いリポジトリを使用してパッケージ管理ツールを更新します。
    </para>
<screen>sudo <command>zypper</command> patch --updatestack-only</screen>
   </step>
   <step>
    <para>
     システムが登録済みの場合、登録を解除する必要はありません。
    </para>
<screen>sudo <command>SUSEConnect</command> --de-register</screen>
   </step>
   <step>
    <para>
     古いインストールソースとリポジトリを削除して、サードパーティリポジトリを調整します。
    </para>
   </step>
   <step>
    <para>
     新しいインストールソースを追加します。これはローカルソースまたはリモートソースです(プレースホルダ<replaceable>REPOSITORY</replaceable>は、<xref linkend="sec.update.nmm.repositories"/>を参照してください)。
    </para>
<screen>sudo <command>zypper</command> addrepo <replaceable>REPOSITORY</replaceable></screen>
    <para>
     SUSEカスタマーセンターまたはSubscription Management Toolを使用することもできます。x86-64では、SUSE Linux Enterprise 12 SP1のコマンドは次のとおりです。
    </para>
<screen>sudo <command>SUSEConnect</command> -p SLES/12.2/x86_64 <replaceable>OPTIONS</replaceable></screen>
    <para>
     クロスアーキテクチャアップグレードはサポートされていません。
    </para>
    <para>
     Zypperによって古いカーネルと新しいカーネルの競合が表示されます。［Solution 1］を選択して続行します。
    </para>
<screen>Problem: product:SLES-12.2-0.x86_64 conflicts with kernel &lt; 4.4 provided by kernel-default-<replaceable>version</replaceable>
 Solution 1: Following actions will be done:
  replacement of kernel-default-<replaceable>version</replaceable> with kernel-default-<replaceable>version</replaceable>
  deinstallation of kernel-default-<replaceable>version</replaceable>
 Solution 2: do not install product:SLES-12.2-0.x86_64
</screen>
   </step>
   <step>
    <para>
     マイグレーションを完了します。
    </para>
<screen>sudo <command>zypper</command> ref -f -s
sudo <command>zypper</command> dup --no-allow-vendor-change --no-recommends</screen>
    <para>
     最初のコマンドは、すべてのサービスとリポジトリを更新します。2番目のコマンドは、ディストリビューションのアップグレードを実行します。ここでは最後の2つのオプションが重要です。<option>-no-allow-vendor-change</option>は、サードパーティRPMによって基本システムのRPMが上書きされないようにします。<option>--no-recommends</option>オプションは、初期インストール時に選択解除したパッケージが再び追加されないようにします。
    </para>
   </step>
  </procedure>
 </sect1>



 <sect1 xml:id="sec.update.migr.rollback">
  <title>サービスパックのロールバック</title>

  <para>
   サービスパックの有効性が認められない場合は、SUSE Linux Enterpriseシステムをサービスパックのマイグレーションが開始される前の状態に戻すことができます。このためには、スナップショットが有効なBtrfsルートパーティションであることが前提条件です(これはSLES 12のインストール時のデフォルトです)。詳細については、<xref linkend="cha.snapper"/>を参照してください。
  </para>

  <procedure xml:id="pro.update.migr.rollback">
   <step>
    <para>
     すべてのSnapperスナップショットのリストを取得します。
    </para>
    <screen>sudo snapper list</screen>
    <para>
     出力を確認して、サービスパックのマイグレーションの開始直前に作成されたスナップショットを見つけます。列<guimenu>Description</guimenu>には対応するステートメントが含まれており、スナップショットには列<guimenu>Userdata</guimenu>に<literal>important</literal>というマークが付いています。列<guimenu>#</guimenu>のスナップショット番号と、列<guimenu>Date</guimenu>の日付を覚えます。
    </para>
   </step>
   <step>
    <para>
     システムを再起動します。ブートメニューから<guimenu>Start boot loader from a read-only snapshot (読み込み専用スナップショットからブートローダを起動)</guimenu>を選択して、前の手順で覚えた日付と番号が付いたスナップショットを選択します。2番目のブートメニュー(スナップショットのブートメニュー)がロードされます。<literal>SLES 12</literal>で始まるエントリを選択して起動します。
    </para>
   </step>
   <step>
    <para>
     システムが以前の状態で起動し、システムパーティションは読み込み専用でマウントされます。<systemitem class="username">root</systemitem>としてログインし、正しいスナップショットを選択しているかどうかを確認します。また、すべてが正常に機能することも確認します。ルートファイルシステムが読み込み専用でマウントされているため、機能が制限されることに注意してください。
    </para>
    <para>
     問題がある場合、または間違ったスナップショットをブートした場合は、再起動して、ブート元として別のスナップショットを選択します。この時点では、恒久的な変更は加えられていません。スナップショットが正しく、正常に機能する場合、次のコマンドを実行して変更を確定します。
    </para>
    <screen>snapper rollback</screen>
    <para>
     続いて再起動を行います。ブート画面で、デフォルトのブートエントリを選択して、復元されたシステムで再起動します。
    </para>
   </step>
   <step>
    <para>
     リポジトリの設定が適切にリセットされているかどうかを確認します。さらに、すべての製品が適切に登録されているかどうかも確認します。いずれかが間違っていると、後でシステムを更新しようとしてもできなかったり、間違ったパッケージリポジトリを使用してシステムが更新されたりすることがあります。
    </para>
    <para>
     次の手順を開始する前に、システムがインターネットにアクセスできることを確認してください。
    </para>
    <substeps>
     <step>
      <para>
       次のコマンドを実行して、サービスとリポジトリを更新します。
      </para>
      <screen>sudo zypper ref -fs</screen>
     </step>
     <step>
      <para>
       次のコマンドを実行して、アクティブなリポジトリのリストを取得します。
      </para>
      <screen>sudo zypper lr</screen>
      <para>
       このコマンドの出力を入念に確認します。更新対象として追加したサービスとリポジトリが一覧にされていてはなりません。たとえば、SLES 12 SP1からSLES 12 SP2へのサービスパックマイグレーションをロールバックする場合、リポジトリ<literal>SLES12-SP2-Pool</literal>および<literal>SLES12-SP2-Updates</literal><emphasis/>「ではなく」、<literal>SP1</literal>のバージョンが含まれている必要があります。
      </para>
      <para>
       間違ったリポジトリが一覧にされている場合は必ず削除し、必要に応じて、製品またはサービスパックのバージョンに一致するバージョンに置き換えます。サポートされるマイグレーションパスのリポジトリのリストについては、<xref linkend="sec.update.nmm.repositories"/>を参照してください。
      </para>
     </step>
     <step>
      <para>
       最後に、次のコマンドを実行して、インストールされているすべての製品の登録状態を確認します。
      </para>
      <screen>SUSEConnect --status</screen>
      <para>
       すべての製品が「<literal>登録されています</literal>」とレポートされる必要があります。そうなっていない場合は、次のコマンドを実行して登録を修復します。
      </para>
      <screen>SUSEConnect --rollback</screen>
     </step>
    </substeps>
   </step>
  </procedure>
  <para>
   以上で、システムは正常にサービスパックのマイグレーション開始直前にキャプチャされた状態に戻りました。
  </para>
 </sect1>
</chapter>
