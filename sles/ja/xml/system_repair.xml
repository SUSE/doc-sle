<?xml version="1.0" encoding="UTF-8"?>
<sect2 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="system_repair.xml" version="5.0" xml:id="sec.trouble.data.recover.rescue">
 <title>レスキューシステムの使用</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info><indexterm> <primary>レスキューシステム</primary></indexterm><indexterm><primary>システム</primary><secondary>レスキュー </secondary></indexterm>
 <para>
  システムが起動し正常に稼動するのに失敗する理由はいくつか考えられます。最も一般的な理由としては、システムクラッシュによるファイルシステムの破損や、ブートローダ設定の破損があります。
 </para>
 <para>
  このような状況の解決を支援するため、<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>には、ブート可能なレスキューシステムが含まれています。レスキューシステムは、RAMディスクにロードして、ルートファイルシステムとしてマウントできる小さなLinuxシステムで、これを利用して外部からLinuxパーティションにアクセスすることができます。レスキューシステムを使用して、システムの重要な部分を復元したり、適切な変更を行ったりできます。
 </para>
 <itemizedlist mark="bullet" spacing="normal">
  <listitem>
   <para>
    任意の種類の設定ファイルを操作できます。
   </para>
  </listitem>
  <listitem>
   <para>
    ファイルシステムの欠陥をチェックして、自動修復プロセスを開始することができます。
   </para>
  </listitem>
  <listitem>
   <para>
    インストールされているシステムを、<quote>他のルート</quote>環境内からアクセスすることができます。
   </para>
  </listitem>
  <listitem>
   <para>
    ブートローダの設定を確認、変更、および再インストールできます。
   </para>
  </listitem>
  <listitem>
   <para>
    正常にインストールされていないデバイスドライバや使用不能なカーネルを修復できます。
   </para>
  </listitem>
  <listitem>
   <para>
    partedコマンドを使って、パーティションサイズを変更できます。このツールの詳細については、GNU PartedのWebサイト(<link xlink:href="http://www.gnu.org/software/parted/parted.html"/>)を参照してください。
   </para>
  </listitem>
 </itemizedlist>
 <para>
  レスキューシステムは、さまざまなソースや場所からロードすることができます。一番簡単な方法は、オリジナルのインストールメディアからレスキューシステムをブートすることです。
 </para>
 <note os="sles" arch="zseries">
  <title>IBM z Systemsでのレスキューシステムの起動</title>
  <para>
   IBM z Systemsでは、レスキュー目的でインストールシステムを使用することができます。レスキューシステムを起動するには、<xref linkend="sec.zseries.rescue"/>の指示に従ってください。
  </para>
 </note>
 <procedure><indexterm> <primary>レスキューシステム</primary> <secondary>メディアによる起動</secondary></indexterm>
  <step>
   <para>
    インストールメディアをDVDドライブに挿入します。
   </para>
  </step>
  <step>
   <para>
    システムを再起動します。
   </para>
  </step>
  <step>
   <para>
    ブート画面で、<keycap>F4</keycap>を押し、<guimenu>DVD-ROM</guimenu>を選択します。次に、メインメニューから<guimenu>レスキューシステム</guimenu>を選択します。
   </para>
  </step>
  <step>
   <para>
    <literal>Rescue:</literal>プロンプトに「<literal>root</literal>」と入力します。パスワードは必要ありません。
   </para>
  </step>
 </procedure>
 <procedure xml:id="proc.trouble.data.recover.rescue.network"><indexterm> <primary>レスキューシステム</primary><secondary>ネットワークソースからの起動</secondary> </indexterm>
  <para>
   ハードウェア設定にDVDドライブが含まれていない場合は、ネットワークソースからレスキューシステムをブートできます。次の例は、リモートブートの場合のシナリオです。DVDなど、他のブートメディアを使用する場合は、<filename>info</filename>ファイルを適宜変更し、通常のインストールと同様にブートします。
  </para>
  <step>
   <para>
    PXEブートセットアップの設定を入力し、<literal>install=<replaceable>protocol</replaceable>://<replaceable>instsource</replaceable></literal>行と<literal>rescue=1</literal>行を追加します。修復システムを起動する必要がある場合は、代わりに<literal>repair=1</literal>を使用します。通常のインストールと同様に、<replaceable>protocol</replaceable>はサポートする任意のネットワークプロトコル(NFS、HTTP、FTPなど)を表しています。また、<replaceable>instsource</replaceable>は、ネットワークインストールソースへのパスを表します。
   </para>
  </step>
  <step>
   <para>
    <xref linkend="sec.deployment.prep_boot.wol"/>に説明したように、<quote>Wake on LAN</quote><phrase os="sles;sled">を使用してシステムをブートします。</phrase>
   </para>
  </step>
  <step>
   <para>
    <literal>Rescue:</literal>プロンプトに「<literal>root</literal>」と入力します。パスワードは必要ありません。
   </para>
  </step>
 </procedure>
 <para>
  レスキューシステムが起動したら、<keycombo><keycap function="alt"/><keycap>F1</keycap></keycombo>～<keycombo><keycap function="alt"/><keycap>F6</keycap></keycombo>キーを使って、仮想コンソールを使用することができます。
 </para>
 <para>
  シェルおよび他の多くの便利なユーティリティ(マウントプログラムなど)は、<filename>/bin</filename>ディレクトリにあります。<filename>/sbin</filename>ディレクトリには、ファイルシステムを確認して修復するための重要なファイルおよびネットワークユーティリティが入っています。このディレクトリには、最も重要なバイナリも入っています。たとえばシステム保守用には<command>fdisk</command>、<command>mkfs</command>、<command>mkswap</command>、<command>mount</command>、および<command>shutdown</command>があり、ネットワーク保守用には<command>ip</command>および<command>ss</command>があります。<filename>/usr/bin</filename>ディレクトリには、vi editor、find、less、およびsshがあります。
 </para>
 <para>
  システムメッセージを表示するには、<command>dmesg</command>コマンドを使用するか、または<command>journalctl</command>を使用してシステムログを参照してください。
 </para>
 <sect3 xml:id="sec.trouble.data.recover.rescue.file">
  <title>環境設定ファイルの確認と修正</title>
  <para>
   レスキューシステムを使った環境設定情報の修正例として、環境設定ファイルが壊れたためシステムが正常にブートできなくなった場合を考えてみましょう。このような場合は、レスキューシステムを使って設定ファイルを修復します。
  </para>
  <procedure>
   <para>
    環境設定ファイルを修正するには、以下の手順に従ってください。
   </para>
   <step>
    <para>
     前述のいずれかの方法を使って、レスキューシステムを起動します。
    </para>
   </step>
   <step>
    <para>
     /dev/sda6<filename>下にあるルートファイルシステムをレスキューシステムにマウントするには、以下のコマンドを使用します。</filename>
    </para>
<screen>mount /dev/sda6 /mnt</screen>
    <para>
     システム中のすべてのディレクトリが、<filename>/mnt</filename>下に配置されます。
    </para>
   </step>
   <step>
    <para>
     マウントしたルートファイルシステムのディレクトリに移動します。
    </para>
<screen>cd /mnt</screen>
   </step>
   <step>
    <para>
     問題の発生している設定ファイルを、viエディタで開きます。次に、設定内容を修正して、ファイルを保存します。
    </para>
   </step>
   <step>
    <para>
     レスキューシステムから、ルートファイルシステムをアンマウントします。
    </para>
<screen>umount /mnt</screen>
   </step>
   <step>
    <para>
     コンピュータを再起動します。
    </para>
   </step>
  </procedure>
 </sect3>
 <sect3 xml:id="sec.trouble.data.recover.rescue.filesystem">
  <title>ファイルシステムの修復と確認</title><indexterm> <primary>ファイルシステム</primary> <secondary>修復</secondary> </indexterm>
  <para>
   一般的に、稼動システムではファイルシステムを修復できません。重大な問題が見つかった場合、ルートファイルシステムをブートできなくなることさえあります。この場合、システムブートは<quote>カーネルパニック</quote>で終了します。この場合、外部からシステムを修復するしか方法はありません。レスキューシステムには、<literal>btrfs</literal><literal>、ext2</literal>、<literal>ext3</literal>、<literal>ext4</literal>、<literal>reiserfs</literal>、<literal>xfs</literal>、<literal>dosfs</literal>、および<literal>vfat</literal>の各ファイルシステムを確認し、修復するユーティリティが用意されています。コマンド<command>fsck.</command><replaceable>FILESYSTEM</replaceable>を探します。たとえば、<literal>btrfs</literal>のファイルシステムを確認する必要がある場合、<command>fsck.btrfs</command>を使用します。
  </para>

 </sect3>
 <sect3 xml:id="sec.trouble.data.recover.rescue.access">
  <title>インストール済みシステムへのアクセス</title>
  <para>
   レスキューシステムからインストール済みのシステムにアクセスする必要がある場合は、それを<emphasis>change root</emphasis>(ルート変更)環境で行う必要があります。これは、たとえば、ブートローダの設定を変更したり、ハードウェア設定ユーティリティを実行するために行います。
  </para>
  <para>
   インストール済みシステムに基づいたchange root(ルート変更)環境を設定するには、以下の手順に従ってください。
  </para>
  <procedure>
   <step>
    <para>
     <command>lsblk</command>を実行して、ルートパーティションに対応するノードを確認します。ここの例では<filename>/dev/sda2</filename>です。
    </para>
<screen>lsblk
NAME        MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT
sda           8:0    0 149,1G  0 disk
├─sda1        8:1    0     2G  0 part  [SWAP]
├─sda2        8:2    0    20G  0 part  /
└─sda3        8:3    0   127G  0 part
  └─cr_home 254:0    0   127G  0 crypt /home</screen>
   </step>
   <step>
    <para>
     インストール済みシステムからルートパーティションをマウントします。
    </para>
<screen>mount /dev/sda2 /mnt</screen>
   </step>
   <step>
    <para>
     <filename>/proc</filename>、<filename>/dev</filename>、および<filename>/sys</filename>パーティションをマウントします。
    </para>
<screen>mount -t proc none /mnt/proc
mount --rbind /dev /mnt/dev
mount --rbind /sys /mnt/sys</screen>
   </step>
   <step>
    <para>
     これで、<systemitem>bash</systemitem>シェルを維持したまま、新規の環境に<quote>ルートを変更</quote>できます。
    </para>
<screen>chroot /mnt /bin/bash</screen>
   </step>
   <step>
    <para>
     最後に、インストール済みシステムから、残りのパーティションをマウントします。
    </para>
<screen>mount -a</screen>
   </step>
   <step>
    <para>
     これで、インストール済みシステムにアクセスできるようになります。システムを再起動する前に、<command>umount </command><option>-a</option>を使ってパーティションをアンマウントし、<quote>exit</quote>コマンドを実行して<command>change root</command>(ルート変更)環境を終了してください。
    </para>
   </step>
  </procedure>
  <warning>
   <title>制限</title>
   <para>
    インストール済みシステムのファイルやアプリケーションにフルアクセスできますが、いくつかの制限事項もあります。実行中のカーネルは、レスキューシステムでブートされたカーネルであり、ルート変更環境でブートされたカーネルではありません。このカーネルは、必要最低限のハードウェアしかサポートしておらず、カーネルのバージョンが同一でない限り、インストール済みシステムからカーネルモジュールを追加することはできません。常に、現在実行中の(レスキュー)カーネルのバージョンを<command>uname -r</command>でチェックし、次に、一致するサブディレクトリがchange root環境の <filename>/lib/modules</filename>ディレクトリに存在するかどうか調べてください。存在する場合は、インストールされたモジュールを使用できます。そうでない場合は、フラッシュディスクなど、他のメディアにある正しいバージョンを提供する必要があります。多くの場合、レスキューカーネルのバージョンは、インストールされているバージョンと異なります。その場合は、たとえば、サウンドカードなどに簡単にアクセスすることはできません。また、GUIも利用できません。
   </para>
   <para>
    また、<keycombo><keycap function="alt"/><keycap>F1</keycap></keycombo>から<keycombo><keycap function="alt"/><keycap>F6</keycap></keycombo>を使ってコンソールを切り替えると、<quote>change root</quote>(ルート変更)環境は終了することに注意してください。
   </para>
  </warning>
 </sect3>
 <sect3 xml:id="sec.trouble.data.recover.rescue.grub">
  <title>ブートローダの変更と再インストール</title>
  <para>
   場合によっては、ブートローダが壊れてしまい、システムをブートできなくなることもあります。たとえば、ブートローダが正常に機能しないと、起動ルーチンは物理ドライブとそのLinuxファイルシステム中の場所とを関連付けられず、正常な処理を行うことができません。
  </para>
  <para>
   ブートローダの設定を確認し、ブートローダを再インストールするには、次の手順に従います。
  </para>
  <procedure>
   <step>
    <para>
     <xref linkend="sec.trouble.data.recover.rescue.access"/>の説明に従って、インストール済みシステムにアクセスするために必要な作業を行います。
    </para>
   </step>
   <step>
    <para>
     GRUB 2ブートローダがシステムにインストールされていることを確認します。インストールされていない場合、<systemitem>grub2</systemitem>パッケージをインストールして実行します。
    </para>
<screen>grub2-install /dev/sda</screen>
   </step>
   <step>
    <para>
     次のファイルが<xref linkend="cha.grub2"/>に示されているGRUB 2の設定ルールに従って正しく設定されているかどうかチェックし、必要に応じて修正します。
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       <filename>/etc/default/grub</filename>
      </para>
     </listitem>
     <listitem>
      <para>
       <filename>/boot/grub2/device.map</filename> (オプションファイルで、手動で作成した場合にのみ存在します。)
      </para>
     </listitem>
     <listitem>
      <para>
       <filename>/boot/grub2/grub.cfg</filename> (このファイルが生成されます。編集しないでください。)
      </para>
     </listitem>
     <listitem>
      <para>
       <filename>/etc/sysconfig/bootloader</filename>
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     次のコマンドシーケンスを使って、ブートローダを再インストールします。
    </para>
<screen>grub2-mkconfig -o /boot/grub2/grub.cfg</screen>
   </step>
   <step>
    <para>
     パーティションをアンマウントして、「change root」 (ルート変更)環境からログアウトします。次に、システムを再起動します。
    </para>
<screen>umount -a
exit
reboot</screen>
   </step>
  </procedure>
 </sect3>
 <sect3 xml:id="sec.trouble.data.recover.rescue.dud">
  <title>カーネルインストールの修復</title>
  <para>
   カーネルアップデートによって、システムの操作に影響する可能性のある新しいバグが導入される場合があります。たとえば、一部のシステムハードウェアのドライバに障害が発生し、そのハードウェアのアクセスや使用ができなくなることがあります。その場合は、機能した最後のカーネルに戻すか(システムで使用可能な場合)、インストールメディアから元のカーネルをインストールします。
  </para>
  <tip>
   <title>更新後も最後のカーネルを保持する方法</title>
   <para>
    正常でないカーネルアップデート後にブートできなくなることを防ぐには、カーネルの複数バージョン機能を使用して、更新後にどのカーネルを保持するか<systemitem>libzypp</systemitem>に指示します。
   </para>
   <para>
    たとえば、最後の2つのカーネルと現在実行中のカーネルを常に保持するには、次のコードを、
   </para>
<screen>multiversion.kernels = latest,latest-1,running</screen>
   <para>
    <filename>/etc/zypp/zypp.conf</filename>ファイルに追加します。詳細については、<xref linkend="cha.tuning.multikernel"/>を参照してください。
   </para>
  </tip>
  <para>
   また、<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>でサポートされていないデバイスのドライバが破損し、その再インストールまたはアップデートが必要な場合があります。たとえば、ハードウェアベンダが、ハードウェアRAIDコントローラなどの特定のデバイスを使用している場合は、オペレーティングシステムによって認識されるバイナリドライバが必要です。ベンダは、通常、要求されたドライバの修正または更新バージョンを含むドライバアップデートディスク(DUD)をリリースします。
  </para>
  <para>
   両方のケースで、レスキューモードでインストールされているシステムにアクセスし、カーネル関係の問題を修正する必要があります。さもないと、システムが正しくブートしないことがあります。
  </para>
  <procedure>
   <step>
    <para>
     <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>メディアからのブート
    </para>
   </step>
   <step>
    <para>
     正常でないカーネルアップデート後に修復を行っている場合、次のステップはスキップしてください。DUD(ドライバアップデートディスク)を使用する必要がある場合は、<keycap>F6</keycap>を押して、ブートメニューの表示後にドライバアップデートをロードし、 ドライバアップデートへのパスまたはURLを選択して、<guimenu>はい</guimenu>をクリックして確認します。
    </para>
   </step>
   <step>
    <para>
     ブートメニューから<guimenu>レスキューシステム</guimenu>を選択し、<keycap function="enter"/>を押します。DUDの使用を選択した場合は、ドライバアップデートの保存先を指定するように要求されます。
    </para>
   </step>
   <step>
    <para>
     <literal>Rescue:</literal>プロンプトに「<literal>root</literal>」と入力します。パスワードは必要ありません。
    </para>
   </step>
   <step>
    <para>
     ターゲットシステムを手動でマウントし、新しい環境に<quote>change root</quote>(ルート変更)します。詳細については、<xref linkend="sec.trouble.data.recover.rescue.access"/>を参照してください。
    </para>
   </step>
   <step>
    <para>
     DUDを使用する場合は、障害のあるデバイスドライバパッケージのインストール/再インストール/アップデートを行います。インストールされたカーネルバージョンがインストールするドライバのバージョンと正確に一致することを常に確認してください。
    </para>
    <para>
     障害のあるカーネルアップデートのインストールを修復する場合は、次の手順で、インストールメディアから元のカーネルをインストールできます。
    </para>
    <substeps performance="required">
     <step>
      <para>
       DVDデバイスを<command>hwinfo --cdrom</command>で識別し、識別したデバイスを<command>mount /dev/sr0 /mnt</command>でマウントします。
      </para>
     </step>
     <step>
      <para>
       DVD上のカーネルファイルが保存されているディレクトリにナビゲートします(たとえば、 <command>cd /mnt/suse/x86_64/</command>)。
      </para>
     </step>
     <step>
      <para>
       必要なパッケージ<systemitem>kernel-*</systemitem>、<systemitem>kernel-*-base</systemitem>、および<systemitem>kernel-*-extra</systemitem>のカスタマイズしたバージョンを、<command>rpm -i</command>コマンドでインストールします。
      </para>
     </step>

    </substeps>
   </step>
   <step>
    <para>
     設定ファイルを更新し、必要に応じてブートローダを再初期化します。詳細については、<xref linkend="sec.trouble.data.recover.rescue.grub"/>を参照してください。
    </para>
   </step>
   <step>
    <para>
     システムドライブからブート可能なメディアをすべて除去し、再起動します。
    </para>
   </step>
  </procedure>
 </sect3>
</sect2>
