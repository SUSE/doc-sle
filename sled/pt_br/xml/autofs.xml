<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="autofs.xml" version="5.0" xml:id="cha.autofs">
 <title>Montagem sob demanda com o Autofs</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes (sim)</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    O <systemitem>autofs</systemitem> é um programa que monta automaticamente diretórios especificados sob demanda. Ele se baseia em um módulo do kernel para alta eficiência e pode gerenciar diretórios locais e compartilhamentos de rede. Estes pontos de montagem automática apenas são montados quando acessados e desmontados após um determinado período de inatividade. Este comportamento sob demanda economiza largura de banda e promove um melhor desempenho do que as montagens estáticas gerenciadas por <filename>/etc/fstab</filename>. Enquanto o <systemitem>autofs</systemitem> é um script de controle, o <command>automount</command> é o comando (daemon) que faz a montagem automática propriamente dita.
   </para>
  </abstract>
 </info><indexterm> <primary>AutoFS</primary></indexterm>
 <sect1 xml:id="sec.autofs.installation">
  <title>Instalação</title>

  <para>
   O <systemitem>autofs</systemitem> não é instalado no <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> por padrão. Para usar seus recursos de montagem automática, instale-o primeiro com
  </para>

<screen>sudo zypper install autofs</screen>
 </sect1>
 <sect1 xml:id="sec.autofs.configuration">
  <title>Configuração</title>

  <para>
   Você deve configurar o <systemitem>autofs</systemitem> manualmente editando seus arquivos de configuração com um editor de texto, como o <command>vim</command>. Há duas etapas básicas para configurar o <systemitem>autofs</systemitem>: o arquivo de mapa <emphasis>master</emphasis> e os arquivos de mapa específicos.
  </para>

  <sect2 xml:id="sec.autofs.configuration.master_map">
   <title>O arquivo de mapa master</title>
   <para>
    O arquivo de configuração master padrão do <systemitem>autofs</systemitem> é <filename>/etc/auto.master</filename>. É possível mudar seu local modificando o valor da opção <option>DEFAULT_MASTER_MAP_NAME</option> em <filename>/etc/sysconfig/autofs</filename>. Veja a seguir o conteúdo do padrão para o <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase>:
   </para>
<screen>#
# Sample auto.master file
# This is an automounter map and it has the following format
# key [ -mount-options-separated-by-comma ] location
# For details of the format look at autofs(5).<co xml:id="co.autofs.manpage"/>
#
#/misc  /etc/auto.misc<co xml:id="co.autofs.map"/>
#/net -hosts
#
# Include /etc/auto.master.d/*.autofs<co xml:id="co.autofs.include"/>
#
#+dir:/etc/auto.master.d
#
# Include central master map if it can be found using
# nsswitch sources.
#
# Note that if there are entries for /net or /misc (as
# above) in the included master map any keys that are the
# same will not be seen as the first read key seen takes
# precedence.
#
+auto.master<co xml:id="co.autofs.plus"/></screen>
   <calloutlist>
    <callout arearefs="co.autofs.manpage">
     <para>
      A página de manual do <systemitem>autofs</systemitem> (<command>man 5 autofs</command>) oferece muitas informações úteis sobre o formato dos mapas do automounter.
     </para>
    </callout>
    <callout arearefs="co.autofs.map">
     <para>
      Embora comentado (#) por padrão, esse é um exemplo de sintaxe de mapeamento simples do automounter.
     </para>
    </callout>
    <callout arearefs="co.autofs.include">
     <para>
      Caso seja necessário dividir o mapa master em vários arquivos, remova o comentário da linha e insira os mapeamentos (com o sufixo <literal>.autofs</literal>) no diretório <filename>/etc/auto.master.d/</filename>.
     </para>
    </callout>
    <callout arearefs="co.autofs.plus">
     <para>
      <literal>+auto.master</literal> garante que os que usam o NIS ainda localizem o mapa master.
     </para>
    </callout>
   </calloutlist>
   <para>
    As entradas no <filename>auto.master</filename> possuem três campos com a seguinte sintaxe:
   </para>
<screen>mount point      map name      options</screen>
   <variablelist>
    <varlistentry>
     <term>mount point</term>
     <listitem>
      <para>
       O local base para montar o sistema de arquivos do <systemitem>autofs</systemitem>, como <literal>/home</literal>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>map name</term>
     <listitem>
      <para>
       O nome da origem do mapa para usar na montagem. Para ver a sintaxe dos arquivos de mapa, consulte a <xref linkend="autofs.mapfiles"/>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>opções</term>
     <listitem>
      <para>
       Estas opções (se especificadas) serão aplicadas como padrão a todas as entradas no mapa determinado.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <tip>
    <title>Para obter mais informações</title>
    <para>
     Para obter informações mais detalhadas sobre os valores específicos do <literal>map-type</literal>, <literal>format</literal> e <literal>options</literal> opcional, consulte a página de manual do <guimenu>auto.master</guimenu> (<command>man 5 auto.master</command>).
    </para>
   </tip>
   <para>
    A seguinte entrada no <filename>auto.master</filename> instrui o <systemitem>autofs</systemitem> a procurar em <filename>/etc/auto.smb</filename> e criar pontos de montagem no diretório <filename>/smb</filename>.
   </para>
<screen>/smb   /etc/auto.smb</screen>
   <sect3 xml:id="autofs.directmount">
    <title>Montagens diretas</title>
    <para>
     As montagens diretas criam um ponto de montagem no caminho especificado dentro do arquivo de mapa relevante. Em vez de especificar o ponto de montagem em <filename>auto.master</filename>, substitua o campo do ponto de montagem por <literal>/-</literal>. Por exemplo, a seguinte linha instrui o <systemitem>autofs</systemitem> a criar um ponto de montagem no local especificado em <filename>auto.smb</filename>:
    </para>
<screen>/-        /etc/auto.smb</screen>
    <tip>
     <title>Mapas sem o caminho completo</title>
     <para>
      Se o arquivo de mapa não for especificado com seu local completo ou caminho de rede, ele será localizado usando a configuração NSS (Name Service Switch):
     </para>
<screen>/-        auto.smb</screen>
    </tip>
   </sect3>
  </sect2>

  <sect2 xml:id="autofs.mapfiles">
   <title>Arquivos de mapa</title>
   <important>
    <title>Outros tipos de mapas</title>
    <para>
     Embora os <emphasis>arquivos</emphasis> sejam os tipos de mapas mais comuns para montagem automática com o <systemitem>autofs</systemitem>, existem também outros tipos. Uma especificação de mapa pode ser a saída de um comando ou o resultado de uma consulta no LDAP ou banco de dados. Para obter informações mais detalhadas sobre os tipos de mapas, consulte a página de manual <command>man 5 auto.master</command>.
    </para>
   </important>
   <para>
    Os arquivos de mapa especificam o local de origem (local ou rede) e o ponto de montagem no qual montar a origem localmente. O formato geral dos mapas é parecido com o mapa master. A diferença é que as <emphasis>opções</emphasis> aparecem entre o ponto de montagem e o local, e não no final da entrada:
   </para>
<screen>mount point      options      location</screen>
   <variablelist>
    <varlistentry>
     <term>mount point</term>
     <listitem>
      <para>
       Especifica onde montar o local de origem. Pode ser o nome de um diretório único (a chamada montagem <emphasis>indireta</emphasis>) a ser adicionado ao ponto de montagem base especificado em <filename>auto.master</filename> ou o caminho completo do ponto de montagem (montagem direta, consulte a <xref linkend="autofs.directmount"/>).
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>opções</term>
     <listitem>
      <para>
       Especifica a lista de opções de montagem separadas por vírgulas referentes às entradas relevantes. Se <filename>auto.master</filename> também incluir opções para este arquivo de mapa, elas serão anexadas.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>location</term>
     <listitem>
      <para>
       Especifica o local de onde o sistema de arquivos deverá ser montado. Normalmente, trata-se de um volume NFS ou SMB na notação usual <literal>host_name:path_name</literal>. Se o sistema de arquivos a ser montado começar com uma "/" (como as entradas locais <filename>/dev</filename> ou os compartilhamentos smbfs), será necessário incluir um prefixo de dois-pontos ":", como <literal>:/dev/sda1</literal>.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.autofs.debugging">
  <title>Operação e depuração</title>

  <para>
   Esta seção apresenta informações sobre como controlar a operação do serviço <systemitem>autofs</systemitem> e como ver mais informações sobre depuração ao ajustar a operação do automounter.
  </para>

  <sect2 xml:id="sec.autofs.debugging.service">
   <title>Controlando o serviço <systemitem>autofs</systemitem></title>
   <para>
    A operação do serviço <systemitem>autofs</systemitem> é controlada pelo <systemitem class="daemon">systemd</systemitem>. A sintaxe geral do comando <command>systemctl</command> do <systemitem>autofs</systemitem> é
   </para>
<screen>sudo systemctl <replaceable>sub-command</replaceable> autofs</screen>
   <para>
    em que o <replaceable>subcomando</replaceable> é um dos seguintes:
   </para>
   <variablelist>
    <varlistentry>
     <term>habilitar</term>
     <listitem>
      <para>
       Inicia o daemon automounter na inicialização.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>start</term>
     <listitem>
      <para>
       Inicia o daemon automounter.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>parar</term>
     <listitem>
      <para>
       Para o daemon automounter. Os pontos de montagem automática não estão acessíveis.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>status</term>
     <listitem>
      <para>
       Imprime o status atual do serviço <systemitem>autofs</systemitem> juntamente com a parte de um arquivo de registro relevante.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>restart</term>
     <listitem>
      <para>
       Para e inicia o automounter, terminando todos os daemons em execução e iniciando novos daemons.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>reload</term>
     <listitem>
      <para>
       Verifica o mapa <filename>auto.master</filename> atual, reinicia os daemons que tiveram suas entradas modificadas e inicia daemons novos para entradas novas.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec.autofs.debugging.problems">
   <title>Depurando problemas do automounter</title>
   <para>
    Se você tiver algum problema para montar diretórios com o <systemitem>autofs</systemitem>, convém executar o daemon <command>automount</command> manualmente e observar as mensagens de saída:
   </para>
   <procedure>
    <step>
     <para>
      Pare o <systemitem>autofs</systemitem>.
     </para>
<screen>sudo systemctl stop autofs</screen>
    </step>
    <step>
     <para>
      De um terminal, execute o <command>automount</command> manualmente em primeiro plano, gerando a saída verbosa.
     </para>
<screen>sudo automount -f -v</screen>
    </step>
    <step>
     <para>
      De outro terminal, tente montar os sistemas de arquivos de montagem automática acessando os pontos de montagem (por exemplo, por <command>cd</command> ou <command>ls</command>).
     </para>
    </step>
    <step>
     <para>
      Verifique a saída do <command>automount</command> do primeiro terminal para obter mais informações sobre o motivo da falha na montagem ou de não haver nenhuma tentativa.
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.autofs.nfs">
  <title>Montando automaticamente um compartilhamento NFS</title>

  <para>
   O procedimento a seguir ilustra como configurar o <systemitem>autofs</systemitem> para montar automaticamente um compartilhamento NFS disponível na rede. Ele usa as informações mencionadas anteriormente e assume que você esteja familiarizado com as exportações NFS. Para obter mais informações sobre NFS, consulte o <xref linkend="cha.nfs"/>.
  </para>

  <procedure>
   <step>
    <para>
     Edite o arquivo de mapa master <filename>/etc/auto.master</filename>:
    </para>
<screen>sudo vim /etc/auto.master</screen>
    <para>
     Adicione uma nova entrada para a nova montagem NFS ao final de <filename>/etc/auto.master</filename>:
    </para>
<screen>/nfs      /etc/auto.nfs      --timeout=10</screen>
    <para>
     Ela informa ao <systemitem>autofs</systemitem> que o ponto de montagem base é <filename>/nfs</filename>, os compartilhamentos NFS estão especificados no mapa <filename>/etc/auto.nfs</filename> e todos os compartilhamentos nesse mapa serão automaticamente desmontados após 10 segundos de inatividade.
    </para>
   </step>
   <step>
    <para>
     Crie um novo arquivo de mapa para os compartilhamentos NFS:
    </para>
<screen>sudo vim /etc/auto.nfs</screen>
    <para>
     Normalmente, o <filename>/etc/auto.nfs</filename> inclui uma linha separada para cada compartilhamento NFS. Seu formato está descrito na <xref linkend="autofs.mapfiles"/>. Adicione a linha que descreve o ponto de montagem e o endereço de rede do compartilhamento NFS:
    </para>
<screen>export      jupiter.com:/home/geeko/doc/export</screen>
    <para>
     A linha acima indica que o diretório <filename>/home/geeko/doc/export</filename> no host <literal>jupiter.com</literal> será montado automaticamente no diretório <filename>/nfs/export</filename> no host local (<filename>/nfs</filename> é tirado do mapa <filename>auto.master</filename>) quando solicitado. O diretório <filename>/nfs/export</filename> será criado automaticamente pelo <systemitem>autofs</systemitem>.
    </para>
   </step>
   <step>
    <para>
     Se preferir, comente a linha relacionada em <filename>/etc/fstab</filename> caso já tenha montado o mesmo compartilhamento NFS estaticamente. A linha deve ser parecida com o seguinte:
    </para>
<screen>#jupiter.com:/home/geeko/doc/export /nfs/export nfs defaults 0 0</screen>
   </step>
   <step>
    <para>
     Recarregue o <systemitem>autofs</systemitem> e verifique se está funcionando:
    </para>
<screen>sudo systemctl restart autofs</screen>
<screen># ls -l /nfs/export
total 20
drwxr-xr-x  6 1001 users 4096 Oct 25 08:56 ./
drwxr-xr-x  3 root root     0 Apr  1 09:47 ../
drwxr-xr-x  5 1001 users 4096 Jan 14  2013 .images/
drwxr-xr-x 10 1001 users 4096 Aug 16  2013 .profiled/
drwxr-xr-x  3 1001 users 4096 Aug 30  2013 .tmp/
drwxr-xr-x  4 1001 users 4096 Oct 25 08:56 SLE-12-manual/</screen>
    <para>
     Se você conseguir ver a lista de arquivos no compartilhamento remoto, o <systemitem>autofs</systemitem> estará funcionando.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.autofs.advanced">
  <title>Tópicos avançados</title>

  <para>
   Esta seção descreve os tópicos que vão além da introdução básica sobre o <systemitem>autofs</systemitem>: montagem automática dos compartilhamentos NFS disponíveis na sua rede, uso de curingas em arquivos de mapa e informações específicas do sistema de arquivos CIFS.
  </para>

  <sect2 xml:id="sec.autofs.advanced.net">
   <title>Ponto de montagem <filename>/net</filename></title>
   <para>
    Este ponto de montagem ajudante é útil quando você usa muitos compartilhamentos NFS. O <filename>/net</filename> monta automaticamente todos os compartilhamentos NFS na rede local sob demanda. A entrada já está presente no arquivo <filename>auto.master</filename>, portanto, tudo o que você precisa fazer é remover o comentário dela e reiniciar o <systemitem>autofs</systemitem>:
   </para>
<screen>/net      -hosts</screen>
<screen>systemctl restart autofs</screen>
   <para>
    Por exemplo, se você tem um servidor chamado <literal>jupiter</literal> com um compartilhamento NFS denominado <filename>/export</filename>, pode montá-lo digitando
   </para>
<screen># cd /net/jupiter/export</screen>
   <para>
    na linha de comando.
   </para>
  </sect2>

  <sect2 xml:id="sec.autofs.advanced.wildcards">
   <title>Usando curingas para montar subdiretórios automaticamente</title>
   <para>
    Se você tem um diretório com subdiretórios que precisa montar um a um automaticamente (a situação mais comum é o diretório <filename>/home</filename> com subdiretórios pessoais de usuários individuais), o <systemitem>autofs</systemitem> tem a solução ideal para você.
   </para>
   <para>
    No caso de diretórios pessoais, adicione a seguinte linha em <filename>auto.master</filename>:
   </para>
<screen>/home      /etc/auto.home</screen>
   <para>
    Será necessário adicionar o mapeamento correto ao arquivo <filename>/etc/auto.home</filename> para que os diretórios pessoais dos usuários sejam montados automaticamente. Uma solução é criar entradas separadas para cada diretório:
   </para>
<screen>wilber      jupiter.com:/home/wilber
penguin      jupiter.com:/home/penguin
tux      jupiter.com:/home/tux
[...]</screen>
   <para>
    Isso é bastante incomum, já que você precisa gerenciar a lista de usuários dentro de <filename>auto.home</filename>. É possível usar o asterisco ''*'' no lugar do ponto de montagem e o E comercial ''&amp;'' no lugar do diretório a ser montado:
   </para>
<screen>*      jupiter:/home/&amp;</screen>
  </sect2>

  <sect2 xml:id="sec.autofs.advanced.cifs">
   <title>Montando automaticamente o sistema de arquivos CIFS</title>
   <para>
    Para montar automaticamente um compartilhamento SMB/CIFS (consulte o <xref linkend="cha.samba"/> para obter mais informações sobre o protocolo SMB/CIFS), é necessário modificar a sintaxe do arquivo de mapa. Adicione <option>-fstype=cifs</option> no campo de opção e inclua um prefixo de '':'' no local do compartilhamento.
   </para>
<screen>mount point      -fstype=cifs      ://jupiter.com/export</screen>
  </sect2>
 </sect1>
</chapter>
