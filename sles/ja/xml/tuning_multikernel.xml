<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="tuning_multikernel.xml" version="5.0" xml:id="cha.tuning.multikernel">
 <title>複数バージョンのカーネルのインストール</title>
 <info>
  <abstract>
   <para>
    <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>では、複数バージョンのカーネルを並行でインストールできます。2番目のカーネルをインストールすると、ブートエントリとinitrdfが自動的に作成されるので、手動での設定が別途必要になることはありません。マシンをリブートすると、新しく追加したカーネルが追加のブートオプションとして利用できるようになります。
   </para>

   <para>
    この機能を使用すると、カーネルのアップデートを安全な状態でテストでき、実績のある以前のカーネルにいつでもフォールバックできます。そのためには、YaSTのオンラインアップデートやアップデートアプレットなどのアップデートツールを使用せず、この章で説明するプロセスに従います。
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <warning>

  <title>サポートエンタイトルメント</title>
  <para>
   独自にコンパイルしたカーネルやサードパーティのカーネルをインストールすると、マシンのサポートエンタイトルメントが全面的に無効になります。<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>に付属するカーネルおよび<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>の正式なアップデートチャネルで配布されるカーネルのみがサポートされています。
  </para>
 </warning>
 <tip>
  <title>ブートローダ設定カーネルの確認</title>
  <para>
   別のカーネルをインストールした後は、デフォルトのブートエントリを目的に合わせて設定するために、ブートローダ設定を確認することをお勧めします。詳細については、<xref linkend="sec.grub2.yast2.config"/>を参照してください。
  </para>
 </tip>
 <sect1 xml:id="cha.tuning.multikernel.enable">
  <title>マルチバージョンサポートの有効化と設定</title>



  <para>
   SUSE Linux Enterprise 12への複数バージョンのソフトウェアパッケージのインストール(マルチバージョンサポート)は、デフォルトで有効になっています。この設定を確認するには、次の手順に従います。
  </para>

  <procedure>
   <step>
    <para>
     任意のエディタで、<systemitem class="username">root</systemitem>ユーザとして<filename>/etc/zypp/zypp.conf</filename>を開きます。
    </para>
   </step>
   <step>
    <para>
     文字列<literal>multiversion</literal>を検索します。この機能に対応しているすべてのカーネルパッケージでマルチバージョンサポートが有効になっている場合、次の行はコメント解除された状態で表示されます。
    </para>
<screen>multiversion = provides:multiversion(kernel)</screen>
   </step>
   <step>
    <para>
     マルチバージョンサポートを特定のカーネルに限定するには、それらのパッケージの名前をカンマ区切りリストとして<filename>/etc/zypp/zypp.conf</filename>の<literal>multiversion</literal>オプションに追記します。たとえば、次のような記述とします。
    </para>
<screen>multiversion = kernel-default,kernel-default-base,kernel-source</screen>
   </step>
   <step>
    <para>
     変更を保存します。
    </para>
   </step>
  </procedure>

  <warning>
   <title>KMP (カーネルモジュールパッケージ)</title>
   <para>
    アップデートした新しいカーネル用に、ベンダーが提供する必須のカーネルモジュール(カーネルモジュールパッケージ)もインストールされていることを確認してください。最終的にカーネルモジュールが見つからなくても、カーネルアップデートプロセスで警告は表示されません。これは、システム上に保持されている古いカーネルによって依然としてパッケージ要件が満たされているためです。
   </para>
  </warning>

  <sect2 xml:id="cha.tuning.multikernel.enable.keep">
   <title>使用していないカーネルの自動削除</title>
   <para>
    マルチバージョンサポートを有効にして新しいカーネルを頻繁にテストしていると、ブートメニューが急速に複雑になります。<filename>/boot</filename>パーティションはスペースが限られていることが普通なので、<filename>/boot</filename>のオーバーフローに伴う問題が発生することがあります。YaSTや以下で説明するZypperなどを使用して、使用されていないバージョンのカーネルを手動で削除できますが、このようなカーネルを自動的に削除するように<systemitem class="library">libzypp</systemitem>を設定することもできます。デフォルトでは、どのカーネルも削除されません。
   </para>
   <procedure>
    <step>
     <para>
      任意のエディタで、<systemitem class="username">root</systemitem>ユーザとして<filename>/etc/zypp/zypp.conf</filename>を開きます。
     </para>
    </step>
    <step>
     <para>
      文字列<literal>multiversion.kernels</literal>を検索し、その行のコメント指定を解除することで、このオプションを有効にします。このオプションは、以下の各値のカンマ区切りリストをとります。
     </para>
     <formalpara>
      <title><literal><replaceable>3.12.24-7.1</replaceable></literal>:</title>
      <para>
       指定されたバージョン番号のカーネルを保持します。
      </para>
     </formalpara>
     <formalpara>
      <title><literal>latest</literal>:</title>
      <para>
       最新のバージョン番号のカーネルを保持します。
      </para>
     </formalpara>
     <formalpara>
      <title><literal>latest-N</literal>:</title>
      <para>
       N番目に新しいバージョン番号のカーネルを保持します。
      </para>
     </formalpara>
     <formalpara>
      <title><literal>running</literal>:</title>
      <para>
       実行しているカーネルを保持します。
      </para>
     </formalpara>
     <formalpara>
      <title><literal>oldest</literal>:</title>
      <para>
       最も古いバージョン番号のカーネルを保持します(これは<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>に元から付属しているバージョンのカーネルです)。
      </para>
     </formalpara>
     <formalpara>
      <title><literal>oldest+N</literal></title>
      <para>
       N番目に古いバージョン番号のカーネルを保持します。
      </para>
     </formalpara>
     <para>
      たとえば、次のように指定します。
     </para>
     <variablelist>
      <varlistentry>
       <term><literal>multiversion.kernels = latest,running</literal>
       </term>
       <listitem>
        <para>
         最新バージョンのカーネルおよび現在実行しているカーネルを保持します。これはマルチバージョン機能を有効にしない場合に似ていますが、古いバージョンのカーネルが削除される時期が、インストールの直後ではなく、「次回のリブートの後」<emphasis/>である点が異なります。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term><literal>multiversion.kernels = latest,latest-1,running</literal>
       </term>
       <listitem>
        <para>
         最新とその次に新しいバージョンのカーネルおよび現在実行しているカーネルを保持します。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term><literal> multiversion.kernels = latest,running,<replaceable>3.12.25.rc7-test</replaceable></literal>
       </term>
       <listitem>
        <para>
         最新バージョンのカーネル、現在実行しているカーネル、および<replaceable>3.12.25.rc7-test</replaceable>バージョンのカーネルを保持します。
        </para>
       </listitem>
      </varlistentry>
     </variablelist>
     <tip>
      <title><literal>実行している</literal>カーネルの保持</title>
      <para>
       特別な設定を使用している場合でない限り、<literal/>実行しているカーネルを必ず保持するようにします。実行しているカーネルを保持しない場合、カーネルをアップデートすると、そのカーネルは削除されます。これにより、現在実行しているカーネル用のモジュールが削除されてロードできなくなるため、アップデート後すぐにシステムを再起動することが必要になります。
      </para>
     </tip>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 xml:id="cha.tuning.multikernel.yast">
  <title>YaSTによる複数のカーネルバージョンのインストールと削除</title>

  <procedure>
   <step>
    <para>
     YaSTを起動し、<menuchoice><guimenu>ソフトウェア</guimenu><guimenu>Software Management (ソフトウェア管理)</guimenu></menuchoice>を選択してソフトウェアマネージャを開きます。
    </para>
   </step>
   <step>
    <para>
     <menuchoice><guimenu>表示</guimenu><guimenu>パッケージグループ</guimenu><guimenu>Multiversion Packages (マルチバージョンパッケージ)</guimenu></menuchoice>を選択して、複数のバージョンを提供できるすべてのパッケージを一覧表示します。
    </para>
    <figure>
     <title>YaSTソフトウェアマネージャ: マルチバージョン表示</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="yast2_sw_multiversion.png" width="90%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="yast2_sw_multiversion.png" width="90%" format="PNG"/>
      </imageobject>
     </mediaobject>
    </figure>
   </step>
   <step>
    <para>
     パッケージを選択し、そのパッケージの<guimenu>バージョン</guimenu>タブを下部ペインの左側で開きます。
    </para>
   </step>
   <step>
    <para>
     パッケージをインストールするには、そのチェックボックスをクリックします。インストールの対象として選択されていることを示す緑色のチェックマークが表示されます。
    </para>
    <para>
     すでにインストール済みのパッケージ(白いチェックマークで表示)を削除するには、削除の対象として選択されていることを示す赤色の<literal>X</literal>が表示されるまで、そのパッケージのチェックボックスをクリックします。
    </para>
   </step>
   <step>
    <para>
     <guimenu>Accept (受け入れ)</guimenu>をクリックしてインストールを開始します。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="cha.tuning.multikernel.zypper">
  <title>Zypperによる複数のカーネルバージョンのインストールと削除</title>

  <procedure>
   <step>
    <para>
     コマンド<command>zypper se -s 'kernel*'</command>を使用して、存在するすべてのカーネルパッケージを一覧表示します。
    </para>
<screen><?dbsuse-fo font-size="7pt"?>

S | Name           | Type       | Version         | Arch   | Repository        
--+----------------+------------+-----------------+--------+-------------------
v | kernel-default | package    | 2.6.32.10-0.4.1 | x86_64 | Alternative Kernel
i | kernel-default | package    | 2.6.32.9-0.5.1  | x86_64 | (System Packages) 
  | kernel-default | srcpackage | 2.6.32.10-0.4.1 | noarch | Alternative Kernel
i | kernel-default | package    | 2.6.32.9-0.5.1  | x86_64 | (System Packages)
...</screen>
   </step>
   <step>
    <para>
     インストールする場合は、次のように正確なバージョンを指定します。
    </para>
<screen>zypper in kernel-default-2.6.32.10-0.4.1</screen>
   </step>
   <step>
    <para>
     カーネルをアンインストールする場合は、コマンド<command>zypper se -si 'kernel*'</command>を使用して、インストールされているすべてのカーネルを一覧表示し、<command>zypper rm </command><replaceable>PACKAGENAME-VERSION</replaceable>を使用して、目的のパッケージを削除します。
    </para>
   </step>
  </procedure>
 </sect1>
</chapter>
