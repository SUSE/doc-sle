<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="klp.xml" version="5.0" xml:id="cha-klp" xml:lang="ja">
 <title>KLPによるライブカーネルパッチ</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    このドキュメントでは、KLP (カーネルライブパッチ)適用テクノロジーの基本原理について説明するとともに、SLE Live Patchingサービスの使用ガイドラインを提供します。
   </para>
  </abstract>
 </info>
 <para>
  KLPでは、再起動せずにLinuxカーネルに最新のセキュリティアップデートを適用できます。これにより、ミッションクリティカルなシステムにとって特に重要なシステムのアップタイムと可用性が最大化されます。
 </para>
 <para>
  このドキュメントで提供される情報は、AMD64/Intel 64、POWER、およびIBM Zアーキテクチャに関連しています。
 </para>
 <sect1 xml:id="sec-klp-advantages">
  <title>カーネルライブパッチの利点</title>

  <para>
   KLPにはいくつかの利点があります。
  </para>

  <itemizedlist>
   <listitem>
    <para>
     多数のサーバを自動的に最新状態に保つことは、組織が特定のコンプライアンス認定を取得または維持するために不可欠です。KLPは、コストのかかる保守ウィンドウの必要性を削減しながら、コンプライアンスの達成に役立ちます。
    </para>
   </listitem>
   <listitem>
    <para>
     サービスレベル契約を締結している企業は、特定レベルのシステムのアクセシビリティとアップタイムを保証する必要があります。ライブパッチにより、ダウンタイムを発生させることなくシステムにパッチを適用できます。
    </para>
   </listitem>
   <listitem>
    <para>
     KLPは標準のシステムアップデートメカニズムの一部であるため、専門的なトレーニングや複雑な保守ルーチンの導入の必要はありません。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec-klp-overview">
  <title>カーネルライブパッチの概要</title>

  <para>
   カーネルライブパッチは、メインのカーネルパッケージとは別のコードが変更されたパッケージとして提供されます。ライブパッチは累積的であるため、最新のパッチには、カーネルパッケージの以前のものからのすべての修正が含まれています。各カーネルライブパッケージは発行された正確なカーネルリビジョンに関連付けられています。ライブパッチパッケージバージョン番号は修正が追加されるたびに増加します。
  </para>

  <important>
   <title>カーネルアップデートと比較したライブパッチ</title>
   <para>
    ライブパッチには重要な修正のみが含まれ、再起動が必要な通常のカーネルアップデートに置き換わるものではありません。ライブパッチは、適切なカーネルアップデートおよび再起動が実行されるまでカーネルを保護する一時的な対策として検討してください。
   </para>
  </important>

  <para>
   次の図は、ライブパッチとカーネルアップデートの全体的な関係を示しています。現在アクティブなライブパッチによって対処されるCVEと不具合レポートのリストは、<command>klp -v patches</command>コマンドを使用して表示できます。
  </para>

  <informalfigure>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="klp.png" width="80%"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="klp.png" width="100%"/>
    </imageobject>
   </mediaobject>
  </informalfigure>

  <para>
   ライブパッチとともに複数のバージョンのカーネルパッケージをインストールすることができます。これらのパッケージは競合しません。実行中のカーネル用にライブパッチとともにアップデートされたカーネルパッケージをインストールできます。この場合、システムを再起動するように求められる場合があります。SLE Live Patchingサブスクリプションを持つユーザは、実行中のカーネルのライブパッチアップデートがある限り、テクニカルサポートを受ける資格があります(<xref linkend="sec-klp-lifecycle"/>を参照)。
  </para>

  <para>
   KLPを有効にすると、すべてのカーネルアップデートにライブパッチパッケージが付属します。このライブパッチには修正は含まれておらず、対応するカーネルの将来のライブパッチのシードとして機能します。これらの空のシードパッチは<literal>初期パッチ</literal>と呼ばれます。
  </para>

  <sect2 xml:id="sec-klp-scope">
   <title>カーネルライブパッチのスコープ</title>
   <para>
    SLE Live Patchingのスコープには、SUSE Common Vulnerability Scoring System (CVSS、SUSE CVSSはCVSS v3.0システムに基づく)レベル7以上の脆弱性の修正と、システムの安定性またはデータ破損に関連するバグ修正が含まれます。ただし、指定されたカテゴリに該当するすべての修正のライブパッチを作成することは技術的に不可能な場合があります。したがって、SUSEではカーネルライブパッチの作成が技術的な理由で不可能な状況で修正をスキップする権利を留保します。現在、対象となる修正の95%以上がライブパッチとしてリリースされています。CVSS (SUSE CVSSレーティングのベース)の詳細については、「<link xlink:href="https://www.first.org/cvss/">Common Vulnerability Scoring System SIG</link>」を参照してください。
   </para>
  </sect2>

  <sect2 xml:id="sec-klp-limitations">
   <title>カーネルライブパッチの制限</title>
   <para>
    KLPには、関数の置換と、相互に依存する関数セットの置換の適切な処理が含まれます。これは、古いコードへの呼び出しを別のメモリ位置にある更新されたコードにリダイレクトすることによって行われます。データ構造の変更は、データがそのまま残り、拡張または再解釈できないため、状況をより複雑にします。データ構造の間接的な変更を許可する技術はありますが、一部の修正はライブパッチに変換できません。この状況では、システムの再起動が、修正を適用する唯一の方法です。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-klp-enable-with-yast2">
  <title>YaSTを使用したカーネルライブパッチの有効化</title>

  <para>
   ご使用のシステムでKLPを有効にするには、アクティブなSLESおよびSLE Live Patchingサブスクリプションが必要です。サブスクリプションのステータスを確認し、SLE Live Patchingサブスクリプションの登録コードを取得するには、<link xlink:href="https://scc.suse.com/">SUSE Customer Center</link>を参照してください。
  </para>

  <para>
   カーネルライブパッチをシステムで有効にするには、次の手順に従います。
  </para>

  <procedure>
   <step>
    <para>
     <command>yast2 registration</command>コマンドを実行して、<guimenu>拡張機能の選択</guimenu>をクリックします。
    </para>
   </step>
   <step>
    <para>
     入手可能な拡張機能のリストで<guimenu>SUSE Linux Enterprise Live Patching 15</guimenu>を選択し、<guimenu>次へ</guimenu>をクリックします。
    </para>
   </step>
   <step>
    <para>
     ライセンス条項を確認し、<guimenu>次へ</guimenu>をクリックします。
    </para>
   </step>
   <step>
    <para>
     SLE Live Patchingの登録コードを入力し、<guimenu>次へ</guimenu>をクリックします。
    </para>
   </step>
   <step>
    <para>
     <guimenu>Installation Summary (インストールの概要)</guimenu>と選択されている<guimenu>Patterns (パターン)</guimenu>を確認します。<systemitem>Live
     Patching</systemitem>と<systemitem>SLE Live Patching Lifecycle
     Data</systemitem>パターンが、依存関係を満たすための追加のパッケージとともにインストール用に自動的に選択される必要があります。
    </para>
   </step>
   <step>
    <para>
     <guimenu>Accept (承諾)</guimenu>をクリックしてインストールを完了します。これにより、システムに基本のカーネルライブパッチコンポーネント、初期ライブパッチ、および必要な依存関係がインストールされます。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-klp-enable-cli">
  <title>コマンドラインからのカーネルライブパッチの有効化</title>

  <para>
   カーネルライブパッチを有効にするには、アクティブなSLESおよびSLES Live Patchingサブスクリプションが必要です。サブスクリプションのステータスを確認し、SLES Live Patchingサブスクリプションの登録コードを取得するには、<link xlink:href="https://scc.suse.com/">SUSE Customer Center</link>を参照してください。
  </para>

  <procedure>
   <step>
    <para>
     <command>sudo SUSEConnect --list-extensions</command>を実行します。SLES Live Patchingの正確なアクティベーションコマンドに注意します。コマンド出力の例(省略形):
    </para>
<screen>$ SUSEConnect --list-extensions
...
SUSE Linux Enterprise Live Patching <phrase role="productnumber"><phrase os="sles;sled">15 SP4</phrase></phrase> x86_64
Activate with: SUSEConnect -p sle-module-live-patching/15.4/x86_64 \
  -r ADDITIONAL REGCODE</screen>
   </step>
   <step>
    <para>
     取得したコマンドに続いて<option>-r <replaceable>LIVE_PATCHING_REGISTRATION_CODE</replaceable></option>を使用してSLES Live Patchingを有効にします。例:
    </para>
<screen>SUSEConnect -p sle-module-live-patching/15.4/x86_64 \
  -r <replaceable>LIVE_PATCHING_REGISTRATION_CODE</replaceable></screen>
   </step>
   <step>
    <para>
     コマンド<command>zypper install -t pattern lp_sles</command>を使用して必要なパッケージと依存関係をインストールします。
    </para>
   </step>
  </procedure>

  <para>
   この時点で、システムはすでにライブパッチが適用されています。
  </para>

  <para>
   プロセスがバックグラウンドでどのように機能するかを次に示します。パッケージインストールシステムが、ライブパッチを適用できるカーネルがインストールされていること、およびソフトウェアチャネルにそのカーネルのライブパッチがあることを検出すると、システムはインストール用のライブパッチを選択します。カーネルはパッケージインストールの一部としてライブパッチ<emphasis></emphasis>修復を受信します。製品インストールが完了する前でも、カーネルにライブパッチが適用されます。
  </para>
 </sect1>
 <sect1 xml:id="sec-klp-perform">
  <title>カーネルライブパッチの適用</title>

  <para>
   カーネルライブパッチは、定期的なシステムアップデートの一部としてインストールされます。ただし、認識すべきいくつかのことがあります。
  </para>

  <itemizedlist>
   <listitem>
    <para>
     <package>kernel-livepatch-*</package>パッケージが実行中のカーネル用にインストールされている場合、カーネルにライブパッチが適用されます。コマンド<command>zypper se --details kernel-livepatch-*</command>を使用して、システムにインストールされているカーネルライブパッチパッケージを確認できます。
    </para>
   </listitem>
   <listitem>
    <para>
     <package>kernel-default</package>パッケージがインストールされる場合、アップデートマネージャはシステムを再起動するように求めます。このメッセージが表示されないようにするには、パッチ適用操作からカーネルアップデートを除外できます。これは、Zypperを使用してパッケージロックを追加することで実行できます。SUSE Managerはチャネルコンテンツをフィルタすることもできます(<link xlink:href="https://documentation.suse.com/external-tree/en-us/suma/4.1/suse-manager/administration/live-patching.html">Live Patching with SUSE Manager (SUSE Managerによるライブパッチ適用)</link>を参照)。
    </para>
   </listitem>
   <listitem>
    <para>
     <command>klp status</command>コマンドを使用してパッチ適用ステータスを確認できます。インストール済みのパッチを調べるには、<command>klp -v patches</command>コマンドを実行します。
    </para>
   </listitem>
   <listitem>
    <para>
     システムに複数のカーネルパッケージがインストールされている可能性がありますが、任意の時点で実行されるのはそれらの1つのみであることに注意してください。同様に、複数のライブパッチパッケージがインストールされる場合がありますが、カーネルにロードされるライブパッチは1つのみです。
    </para>
   </listitem>
   <listitem>
    <para>
     アクティブなライブパッチは、<literal>initrd</literal>に含まれています。これは、予期しない再起動が発生した場合に、ライブパッチ修正が適用された状態でシステムが起動するため、再びパッチを適用する必要がないことを意味します。
    </para>
   </listitem>
  </itemizedlist>

  <sect2 xml:id="sec-klp-lifecycle">
   <title>ライブパッチの有効期限を確認する</title>
   <para>
    <package>lifecycle-data-sle-module-live-patching</package>がインストールされていることを確認し、<command>zypper lifecycle</command>コマンドを実行します。出力の<literal>Package end of support if different from product</literal>セクションにライブパッチの有効期限が表示されるはずです。
   </para>
   <para>
    すべてのライブパッチは基盤となるカーネルパッケージのリリースから1年間、アップデートを受け取ります。「<link xlink:href="https://www.suse.com/products/live-patching/current-patches/">Maintained kernels, patch updates and lifecyclepage</link>」ページでは、製品の拡張機能をインストールすることなく、実行中のカーネルバージョンに基づいて有効期限を確認できます。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-klp-troubleshoot">
  <title>カーネルライブパッチの問題のトラブルシューティング</title>

  <sect2 xml:id="sec-klp-man-patch-downgrade">
   <title>手動によるパッチのダウングレード</title>
   <para>
    最新のライブパッチに問題がある場合は、現在インストールされているライブパッチを以前のバージョンにダウングレードできます。システムで問題が発生する前に、パッチのダウングレードを実行することをお勧めします。システムログにカーネル警告またはカーネルエラートレースが含まれているシステムは、パッチのダウングレード手順に適していない場合があることに注意してください。システムがパッチダウングレードの要件を満たしているかどうか不明な場合は、SUSEテクニカルサポートに連絡してください。
   </para>
   <procedure>
    <title>手動によるパッチのダウングレード</title>
    <step>
     <para>
      <command>klp -v patches</command>コマンドを使用して実行中のライブパッチを特定します。<literal>RPM:</literal>で開始される行に現在実行中のパッチが表示されます。例:
     </para>
<screen>RPM: kernel-livepatch-5_3_18-24_29-default-2-2.1.x86_64</screen>
     <para>
      前の例の<literal>5_3_18-24_29-default</literal>は、実行中のカーネルの正確なバージョンを示しています。
     </para>
    </step>
    <step>
     <para>
      コマンド<command>zypper search -s kernel-livepatch-<replaceable>RUNNING_KERNEL_VERSION</replaceable>-default</command>を使用して、以前のバージョンのパッチを検索します。このコマンドは、使用可能なパッケージバージョンのリストを返します。新しいライブパッチパッケージがリリースされるたびに、バージョン番号が1つずつ増加することに注意してください。現在のリリースより1つ前のバージョン番号を選択してください。
     </para>
    </step>
    <step>
     <para>
      コマンド<command>zypper in --oldpackage kernel-livepatch-<replaceable>RUNNING_KERNEL_VERSION</replaceable>-default=<replaceable>DESIRED_VERSION</replaceable></command>を使用して目的のバージョンをインストールします。
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
</chapter>
