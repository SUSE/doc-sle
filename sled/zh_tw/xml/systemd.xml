<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="systemd.xml" version="5.0" xml:id="cha.systemd">

 <title><systemitem class="daemon">systemd</systemitem> 精靈</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <para>
  程式 <systemitem class="daemon">systemd</systemitem> 是程序 ID 為 1 的程序。負責以所需的方式啟始化系統。<systemitem class="daemon">systemd</systemitem> 由核心直接啟動，訊號 9 (通常會終止程序) 對它不起作用。所有其他程式不是由 systemd 直接啟動，就是由它的子程序啟動。
 </para>
 <para>
  從 <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 12 起，systemd 取代了常用的 System V init 精靈。<systemitem class="daemon">systemd</systemitem> 與 System V init 完全相容 (透過支援 init 程序檔)。systemd 的其中一個主要優點在於它透過積極主動的平行服務啟動，使開機速度顯著加快。另外，systemd 僅在切實需要服務時才會啟動該服務。它在開機時不會無條件地啟動精靈，而是在第一次需要時予以啟動。systemd 還支援「核心控制群組」(cgroup)，對系統狀態拍攝快照並還原等等。如需詳細資料，請參閱 <link xlink:href="http://www.freedesktop.org/wiki/Software/systemd/"/>。
 </para>

 <sect1 xml:id="sec.boot.systemd.concept">
  <title>systemd 概念</title>

  <para>
   本節將詳細討論 systemd 背後的概念。
  </para>

  <sect2 xml:id="sec.boot.systemd.whatissystemd">
   <title>systemd 是什麼</title>
   <para>
    systemd 是適用於 Linux 的系統和工作階段管理員，它與 System V 及 LSB init 程序檔相容。主要功能如下：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      提供積極主動的平行化功能
     </para>
    </listitem>
    <listitem>
     <para>
      使用插槽及 D-Bus 啟用方式來啟動服務
     </para>
    </listitem>
    <listitem>
     <para>
      提供精靈的隨需啟動
     </para>
    </listitem>
    <listitem>
     <para>
      使用 Linux cgroup 追蹤程序
     </para>
    </listitem>
    <listitem>
     <para>
      支援對系統狀態拍攝快照並還原
     </para>
    </listitem>
    <listitem>
     <para>
      維護掛接點和自動掛接點
     </para>
    </listitem>
    <listitem>
     <para>
      實作事務相關型複雜的服務控制邏輯
     </para>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="sec.boot.systemd.unitfile">
   <title>單位檔案</title>
   <para>
    單位組態檔案針對以下項目的資訊進行編碼︰服務、插槽、裝置、掛接點、自動掛接點、交換檔或分割區、啟動目標、所監視之檔案系統的路徑、受 systemd 控制和監督的計時器、暫時系統狀態快照、資源管理片段或外部建立的程序群組。<quote>
單位檔案</quote>是 systemd 用於表示下列項目的通用術語︰
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <formalpara>
      <title>服務</title>
      <para>
       程序相關資訊 (例如執行精靈)；檔案名以 .service 結尾
      </para>
     </formalpara>
    </listitem>
    <listitem>
     <formalpara>
      <title>目標</title>
      <para>
       用於將單位分組以及在啟動期間用作同步點；檔案名以 .target 結尾
      </para>
     </formalpara>
    </listitem>
    <listitem>
     <formalpara>
      <title>插槽</title>
      <para>
       IPC 或網路插槽或檔案系統 FIFO 的相關資訊，適用於插槽型啟動 (如 <systemitem class="daemon">inetd</systemitem>)；檔案名以 .socket 結尾
      </para>
     </formalpara>
    </listitem>
    <listitem>
     <formalpara>
      <title>路徑</title>
      <para>
       用於觸發其他單位 (例如，在檔案變更時執行服務)；檔案名以 .path 結尾
      </para>
     </formalpara>
    </listitem>
    <listitem>
     <formalpara>
      <title>計時器</title>
      <para>
       受控計時器的相關資訊，適用於計時器型啟動；檔案名以 .timer 結尾
      </para>
     </formalpara>
    </listitem>
    <listitem>
     <formalpara>
      <title>掛接點</title>
      <para>
       通常由 fstab 產生器自動產生；檔案名以 .mount 結尾
      </para>
     </formalpara>
    </listitem>
    <listitem>
     <formalpara>
      <title>自動掛接點</title>
      <para>
       檔案系統自動掛接點的相關資訊；檔案名以 .automount 結尾
      </para>
     </formalpara>
    </listitem>
    <listitem>
     <formalpara>
      <title>Swap</title>
      <para>
       用於記憶體分頁之交換裝置或檔案相關資訊；檔案名以 .swap 結尾
      </para>
     </formalpara>
    </listitem>
    <listitem>
     <formalpara>
      <title>裝置</title>
      <para>
       sysfs/udev(7) 裝置樹中所展示之裝置的相關資訊；檔案名以 .automount 結尾
      </para>
     </formalpara>
    </listitem>
    <listitem>
     <formalpara>
      <title>範圍/片段</title>
      <para>
       分階層管理程序群組之資源的概念；檔案名以 .scope/.slice 結尾
      </para>
     </formalpara>
    </listitem>
   </itemizedlist>
   <para>
    如需有關 systemd.unit 的詳細資訊，請參閱 <link xlink:href="http://www.freedesktop.org/software/systemd/man/systemd.unit.html"/>
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.boot.systemd.basics">
  <title>基本用法</title>

  <para>
   System V init 系統使用若干個指令來處理服務 - init 程序檔、<command>insserv</command>、<command>telinit</command> 及其他。systemd 可以簡化服務管理，因為對於大部分處理服務的任務，只需記住一條指令︰<command>systemctl</command>。它使用<quote>
指令加子指令</quote>表示法，與 <command>git</command> 或 <command>zypper</command> 相似︰
  </para>

<screen>systemctl <replaceable>GENERAL OPTIONS</replaceable> <replaceable>SUBCOMMAND</replaceable> <replaceable>SUBCOMMAND OPTIONS</replaceable></screen>

  <para>
   如需完整的手冊，請參閱 <command>man 1 systemctl</command>。
  </para>

  <tip>
   <title>終端機輸出和 Bash 完成法</title>
   <para>
    如果輸出進入終端機 (而不是進入管線或檔案之類)，依預設，systemd 指令會將長輸出傳送到切換程式。使用 <option>--no-pager</option> 選項可關閉切換模式。
   </para>
   <para>
    systemd 還支援 bash 完成法，它可讓您輸入子指令的第一個字母，然後按 <keycap function="tab"/> 自動填全子指令。此功能僅可用於 <systemitem>bash</systemitem> 外圍程序，並且需要安裝套件 <systemitem class="resource">bash-completion</systemitem>。
   </para>
  </tip>

  <sect2 xml:id="sec.boot.systemd.basics.services">
   <title>管理正在執行的系統中的服務</title>
   <para>
    用於管理服務的子指令與透過 System V init 管理服務的子指令相同 (<command>start</command>、<command>stop</command>、...)。下面列出了服務管理指令的通用語法︰
   </para>
   <variablelist>
    <varlistentry>
     <term>systemd</term>
     <listitem>
<screen>systemctl reload|restart|start|status|stop|<replaceable>...</replaceable> <replaceable>MY_SERVICE(S)</replaceable></screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>System V init</term>
     <listitem>
<screen>rc<replaceable>MY_SERVICE(S)</replaceable> reload|restart|start|status|stop|<replaceable>...</replaceable></screen>
     </listitem>
    </varlistentry>
   </variablelist>
   <para>
    systemd 可讓您一次管理多個服務。它不是像 System V init 那樣依次執行 init 程序檔，而是執行類似如下的指令︰
   </para>
<screen>systemctl start <replaceable>MY_1ST_SERVICE</replaceable> <replaceable>MY_2ND_SERVICE</replaceable></screen>
   <para>
    如果您要列出系統上可用的所有服務︰
   </para>
<screen>systemctl list-unit-files --type=service</screen>
   <para>
    下表列出了 systemd 和 System V init 的最重要的服務管理指令︰
   </para>
   <table rowsep="1">
    <title>服務管理指令</title>
    <tgroup cols="3">
     <colspec colnum="1" colname="1" colwidth="50*"/>
     <colspec colnum="2" colname="2" colwidth="30*"/>
     <colspec colnum="3" colname="3" colwidth="20*"/>
     <thead>
      <row>
       <entry colname="1">
        <para>
         任務
        </para>
       </entry>
       <entry colname="2">
        <para>
         systemd 指令
        </para>
       </entry>
       <entry colname="3">
        <para>
         System V init 指令
        </para>
       </entry>
      </row>
     </thead>
     <tbody>
      <row>
       <entry colname="1">
        <formalpara>
         <title>啟動</title>
         <para/>
        </formalpara>
       </entry>
       <entry colname="2">
<screen>start</screen>
       </entry>
       <entry colname="3">
<screen>start</screen>
       </entry>
      </row>
      <row>
       <entry colname="1">
        <formalpara>
         <title>停止</title>
         <para/>
        </formalpara>
       </entry>
       <entry colname="2">
<screen>stop</screen>
       </entry>
       <entry colname="3">
<screen>stop</screen>
       </entry>
      </row>
      <row>
       <entry colname="1">
        <formalpara>
         <title>重新啟動</title>
         <para>
          關閉服務，然後啟動這些服務。如果某項服務並未執行，則會將其啟動。
         </para>
        </formalpara>
       </entry>
       <entry colname="2">
<screen>restart</screen>
       </entry>
       <entry colname="3">
<screen>restart</screen>
       </entry>
      </row>
      <row>
       <entry colname="1">
        <formalpara>
         <title>有條件地重新啟動</title>
         <para>
          如果服務目前正在執行中，則予以重新啟動。對於未在執行中的服務，則不執行任何動作。
         </para>
        </formalpara>
       </entry>
       <entry colname="2">
<screen>try-restart</screen>
       </entry>
       <entry colname="3">
<screen>try-restart</screen>
       </entry>
      </row>
      <row>
       <entry colname="1">
        <formalpara>
         <title>重新載入</title>
         <para>
          指示服務重新載入它們的組態檔案，而不中斷操作。使用案例︰指示 Apache 重新載入修改過的 <filename>httpd.conf</filename> 組態檔案。請注意，並非所有服務都支援重新載入。
         </para>
        </formalpara>
       </entry>
       <entry colname="2">
<screen>reload</screen>
       </entry>
       <entry colname="3">
<screen>reload</screen>
       </entry>
      </row>
      <row>
       <entry colname="1">
        <formalpara>
         <title>重新載入或重新啟動</title>
         <para>
          如果服務支援重新載入，則重新載入服務，否則重新啟動服務。如果某項服務並未執行，則會將其啟動。
         </para>
        </formalpara>
       </entry>
       <entry colname="2">
<screen>reload-or-restart</screen>
       </entry>
       <entry colname="3">
<screen>n/a</screen>
       </entry>
      </row>
      <row>
       <entry colname="1">
        <formalpara>
         <title>有條件地重新載入或重新啟動</title>
         <para>
          如果服務支援重新載入，則重新載入服務，否則重新啟動那些目前正在執行的服務。對於未在執行中的服務，則不執行任何動作。
         </para>
        </formalpara>
       </entry>
       <entry colname="2">
<screen>reload-or-try-restart</screen>
       </entry>
       <entry colname="3">
<screen>n/a</screen>
       </entry>
      </row>
      <row>
       <entry colname="1">
        <formalpara>
         <title>取得詳細的狀態資訊</title>
         <para>
          列出服務狀態的相關資訊。<systemitem class="daemon">systemd</systemitem> 指令顯示詳細資料，例如描述、可執行檔、狀態、cgroup 及服務發出的最新訊息 (請參閱<xref linkend="sec.boot.systemd.basics.services_debugging"/>)。使用 System V init 顯示的詳細資料級別因服務而異。
         </para>
        </formalpara>
       </entry>
       <entry colname="2">
<screen>status</screen>
       </entry>
       <entry colname="3">
<screen>status</screen>
       </entry>
      </row>
      <row>
       <entry colname="1">
        <formalpara>
         <title>取得簡要的狀態資訊</title>
         <para>
          顯示服務是否處於使用中狀態。
         </para>
        </formalpara>
       </entry>
       <entry colname="2">
<screen>is-active</screen>
       </entry>
       <entry colname="3">
<screen>status</screen>
       </entry>
      </row>
     </tbody>
    </tgroup>
   </table>
  </sect2>

  <sect2 xml:id="sec.boot.systemd.basics.services_enabling">
   <title>永久啟用/停用服務</title>
   <para>
    上一節中提及的服務管理指令可讓您操作目前工作階段的服務。systemd 還可讓您永久啟用或停用服務，使之可以按要求自動啟動，或者始終無法使用。此操作可以透過 YaST 或在指令行上執行。
   </para>
   <sect3 xml:id="sec.boot.systemd.basics.services_enabling.cmd">
    <title>在指令行上啟用/停用服務</title>
    <para>
     下表列出了 systemd 和 System V init 的啟用和停用指令︰
    </para>
    <important>
     <title>服務啟動</title>
     <para>
      在指令行上啟用服務時，服務不會自動啟動。系統將其排定為下一次系統啟動或執行層級/目標變更時啟動。若要在啟用服務之後立即啟動它，請明確執行 <command>systemctl start <replaceable>我的服務</replaceable></command>或 <command>rc <replaceable>我的服務</replaceable> start</command>。
     </para>
    </important>
    <table rowsep="1">
     <title>用於啟用和停用服務的指令</title>
     <tgroup cols="3">
      <colspec colnum="1" colname="1" colwidth="32*"/>
      <colspec colnum="2" colname="2" colwidth="40*"/>
      <colspec colnum="3" colname="3" colwidth="28*"/>
      <thead>
       <row>
        <entry colname="1">
         <para>
          任務
         </para>
        </entry>
        <entry colname="2">
         <para>
          <systemitem class="daemon">systemd</systemitem> 指令
         </para>
        </entry>
        <entry colname="3">
         <para>
          System V init 指令
         </para>
        </entry>
       </row>
      </thead>
      <tbody>
       <row>
        <entry colname="1">
         <formalpara>
          <title>啟用</title>
          <para/>
         </formalpara>
        </entry>
        <entry colname="2">
         <para>
          <command>systemctl enable <replaceable>我的服務</replaceable></command>
         </para>
        </entry>
        <entry colname="3">
         <para>
          <command>insserv <replaceable>我的服務</replaceable></command>、<command>chkconfig -a <replaceable>我的服務</replaceable></command>
         </para>
        </entry>
       </row>
       <row>
        <entry colname="1">
         <formalpara>
          <title>停用</title>
          <para/>
         </formalpara>
        </entry>
        <entry colname="2">
         <para>
          <command>systemctl disable <replaceable>我的服務</replaceable>.service</command>
         </para>
        </entry>
        <entry colname="3">
         <para>
          <command>insserv -r <replaceable>我的服務</replaceable></command>、<command>chkconfig -d <replaceable>我的服務</replaceable></command>
         </para>
        </entry>
       </row>
       <row>
        <entry colname="1">
         <formalpara>
          <title>檢查</title>
          <para>
           顯示是否已啟用某個服務。
          </para>
         </formalpara>
        </entry>
        <entry colname="2">
         <para>
          <command>systemctl is-enabled <replaceable>我的服務</replaceable></command>
         </para>
        </entry>
        <entry colname="3">
         <para>
          <command>chkconfig <replaceable>我的服務</replaceable></command>
         </para>
        </entry>
       </row>
       <row>
        <entry colname="1">
         <formalpara>
          <title>重新啟用</title>
          <para>
           與重新啟動服務相似，此指令先停用服務，然後再啟用該服務。若要使用服務的預設值重新啟用服務，可使用此任務。
          </para>
         </formalpara>
        </entry>
        <entry colname="2">
         <para>
          <command>systemctl reenable <replaceable>我的服務</replaceable></command>
         </para>
        </entry>
        <entry colname="3">
         <para>
          無
         </para>
        </entry>
       </row>
       <row>
        <entry colname="1">
         <formalpara>
          <title>遮罩</title>
          <para>
           <quote>
停用</quote>某項服務之後，仍然可以手動啟動它。若要徹底停用服務，您需要予以遮罩。使用須謹慎。
          </para>
         </formalpara>
        </entry>
        <entry colname="2">
         <para>
          <command>systemctl mask <replaceable>我的服務</replaceable></command>
         </para>
        </entry>
        <entry colname="3">
         <para>
          無
         </para>
        </entry>
       </row>
       <row>
        <entry colname="1">
         <formalpara>
          <title>取消遮罩</title>
          <para>
           遮罩某項服務之後，惟有先將其取消遮罩，才能再次予以使用。
          </para>
         </formalpara>
        </entry>
        <entry colname="2">
         <para>
          <command>systemctl unmask <replaceable>我的服務</replaceable></command>
         </para>
        </entry>
        <entry colname="3">
         <para>
          無
         </para>
        </entry>
       </row>
      </tbody>
     </tgroup>
    </table>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.boot.systemd.boot">
  <title>系統啟動和目標管理</title>

  <para>
   啟動系統和關閉系統的整個程序由 init 維護。依此觀點，核心可以視為背景程序，以維護所有其他程序，並根據其他程式的要求來調整 CPU 時間和硬體存取。
  </para>

  <sect2 xml:id="sec.boot.systemd.targets">
   <title>目標與執行層級的比較</title>
   <para>
    使用 System V init 時，系統將開機進入<quote>
執行層級</quote>。執行層級定義了系統的啟動方式，以及在所執行的系統中可以使用哪些服務。執行層級標有編號；最常見的執行層級是 <literal>0</literal> (關閉系統)、<literal>3</literal> (多重使用者，包含網路) 和 <literal>5</literal> (多重使用者，包含網路及顯示管理員)。
   </para>
   <para>
    systemd 透過使用<quote>
目標單位</quote>引入新的概念。不過，它仍然與執行層級概念完全相容。目標單位是有名稱而不是有編號的，它有多個作用。例如，目標 <systemitem>local-fs.target</systemitem> 和 <systemitem>swap.target</systemitem> 掛接本地檔案系統和交換空間。
   </para>
   <para>
    目標 <systemitem>graphical.target</systemitem> 提供包含網路和顯示管理員功能的多重使用者系統，與執行層級 5 相當。複雜的目標，例如 <systemitem>graphical.target</systemitem> 透過結合其他目標的子集用作<quote>
中繼</quote>目標。因為 systemd 能夠組合現有目標，便於使用者更便利地建立自訂目標，因此提供了可觀的靈活性。
   </para>
   <para>
    下列清單顯示了最重要的 systemd 目標單位。如需完整清單，請參閱 <command>man 7 systemd.special</command>。
   </para>
   <variablelist>
    <title>選定的 systemd 目標單位</title>
    <varlistentry>
     <term><systemitem>default.target</systemitem>
     </term>
     <listitem>
      <para>
       預設開機的目標。這並非<quote>
真實</quote>目標，而是一個符號連結，指向 <systemitem>graphic.target</systemitem> 之類的另一個目標。可透過 YaST 永久變更 (請參閱<xref linkend="sec.boot.runlevel.edit"/>)。若要為某個工作階段變更它，請在開機提示處使用核心參數 <literal>systemd.unit=<replaceable>我的目標.target</replaceable></literal>。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><systemitem>emergency.target</systemitem>
     </term>
     <listitem>
      <para>
       在主控台上啟動緊急外圍程序。請僅在開機提示符處以如下格式使用它︰<literal>systemd.unit=emergency.target</literal>。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><systemitem>graphical.target</systemitem>
     </term>
     <listitem>
      <para>
       啟動包含網路、多重使用者支援和顯示管理員功能的系統。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><systemitem>halt.target</systemitem>
     </term>
     <listitem>
      <para>
       關閉系統。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><systemitem>mail-transfer-agent.target</systemitem>
     </term>
     <listitem>
      <para>
       啟動傳送和接收郵件所需的所有服務。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><systemitem>multi-user.target</systemitem>
     </term>
     <listitem>
      <para>
       啟動包含網路的多重使用者系統。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><systemitem>reboot.target</systemitem>
     </term>
     <listitem>
      <para>
       系統重新開機。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><systemitem>rescue.target</systemitem>
     </term>
     <listitem>
      <para>
       啟動不包含網路的單一使用者系統。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <para>
    為了保持與 System V init 執行層級系統相容，systemd 提供了名為 <literal>runlevel<replaceable>X</replaceable>.target</literal> 的特殊目標，可映射至編號為 <replaceable>X</replaceable> 的相應執行層級。
   </para>
   <para>
    如果您要知道目前的目標，請使用指令︰<command>systemctl get-default</command>
   </para>
   <table rowsep="1">
    <title>System V 執行層級和 <systemitem class="daemon">systemd</systemitem> 目標單位</title>
    <tgroup cols="3">
     <colspec colnum="1" colname="1" colwidth="20*"/>
     <colspec colnum="2" colname="2" colwidth="40*"/>
     <colspec colnum="3" colname="3" colwidth="40*"/>
     <thead>
      <row>
       <entry>
        <para>
         System V 執行層級
        </para>
       </entry>
       <entry>
        <para>
         <systemitem class="daemon">systemd</systemitem> 目標
        </para>
       </entry>
       <entry>
        <para>
         用途
        </para>
       </entry>
      </row>
     </thead>
     <tbody>
      <row>
       <entry>
        <para>
         0
        </para>
       </entry>
       <entry>
        <para>
         <systemitem>runlevel0.target</systemitem>、<systemitem>halt.target</systemitem>、 <systemitem>poweroff.target</systemitem>
        </para>
       </entry>
       <entry>
        <para>
         關閉系統
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         1, S
        </para>
       </entry>
       <entry>
        <para>
         <systemitem>runlevel1.target</systemitem>、<systemitem>rescue.target</systemitem>、
        </para>
       </entry>
       <entry>
        <para>
         單一使用者模式
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         2
        </para>
       </entry>
       <entry>
        <para>
         <systemitem>runlevel2.target</systemitem>、<systemitem>multi-user.target</systemitem>、
        </para>
       </entry>
       <entry>
        <para>
         本地多重使用者，不包含遠端網路
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         3
        </para>
       </entry>
       <entry>
        <para>
         <systemitem>runlevel3.target</systemitem>、<systemitem>multi-user.target</systemitem>、
        </para>
       </entry>
       <entry>
        <para>
         完整的多重使用者，包含網路
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         4
        </para>
       </entry>
       <entry>
        <para>
         <systemitem>runlevel4.target</systemitem>
        </para>
       </entry>
       <entry>
        <para>
         未使用/使用者定義
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         5
        </para>
       </entry>
       <entry>
        <para>
         <systemitem>runlevel5.target</systemitem>、 <systemitem>graphical.target</systemitem>、
        </para>
       </entry>
       <entry>
        <para>
         完整的多重使用者，包含網路及顯示管理員
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         6
        </para>
       </entry>
       <entry>
        <para>
         <systemitem>runlevel6.target</systemitem>、 <systemitem>reboot.target</systemitem>、
        </para>
       </entry>
       <entry>
        <para>
         系統重新開機
        </para>
       </entry>
      </row>
     </tbody>
    </tgroup>
   </table>
   <important>
    <title>systemd 忽略 <filename>/etc/inittab</filename></title>
    <para>
     System V init 系統中的執行層級在 <filename>/etc/inittab</filename> 中設定。systemd <emphasis>不</emphasis>使用此組態。如需如何建立您自己的可開機目標的指示，請參閱<xref linkend="sec.boot.systemd.custom.targets"/>。
    </para>
   </important>
   <sect3 xml:id="sec.boot.systemd.targets.commands">
    <title>用於變更目標的指令</title>
    <para>
     請使用下列指令來操作目標單位︰
    </para>
    <informaltable rowsep="1">
     <tgroup cols="3">
      <colspec colnum="1" colname="1" colwidth="20*"/>
      <colspec colnum="2" colname="2" colwidth="50*"/>
      <colspec colnum="3" colname="3" colwidth="30*"/>
      <thead>
       <row>
        <entry colname="1">
         <para>
          任務
         </para>
        </entry>
        <entry colname="2">
         <para>
          systemd 指令
         </para>
        </entry>
        <entry colname="3">
         <para>
          System V init 指令
         </para>
        </entry>
       </row>
      </thead>
      <tbody>
       <row>
        <entry colname="1">
         <para>
          變更目前的目標/執行層級
         </para>
        </entry>
        <entry colname="2">
         <para>
          <command>systemctl isolate</command>
          <replaceable>我的目標</replaceable>.target
         </para>
        </entry>
        <entry colname="3">
         <para>
          <command>telinit</command> <replaceable> X</replaceable>
         </para>
        </entry>
       </row>
       <row>
        <entry colname="1">
         <para>
          變更為預設目標/執行層級
         </para>
        </entry>
        <entry colname="2">
         <para>
          <command>systemctl default</command>
         </para>
        </entry>
        <entry colname="3">
         <para>
          無
         </para>
        </entry>
       </row>
       <row>
        <entry colname="1">
         <para>
          取得目前的目標/執行層級
         </para>
        </entry>
        <entry colname="2">
         <para>
          <command>systemctl list-units --type=target</command>
         </para>
         <para>
          對 systemd 而言，使用中的目標一般不止一個。該指令列出目前處於使用中狀態的所有目標。
         </para>
        </entry>
        <entry colname="3">
         <para>
          <command>who -r</command>
         </para>
         <para>
          或
         </para>
         <para>
          <command>runlevel</command>
         </para>
        </entry>
       </row>
       <row>
        <entry colname="1">
         <para>
          永久性變更預設的執行層級
         </para>
        </entry>
        <entry colname="2">
         <para>
          使用服務管理員或執行下列指令︰
         </para>
         <para>
          <command>ln -sf /usr/lib/systemd/system/</command>
          <replaceable>我的目標</replaceable>.target /etc/systemd/system/default.target
         </para>
        </entry>
        <entry colname="3">
         <para>
          使用服務管理員或變更以下行
         </para>
         <para>
          <command>id:</command> <replaceable>X</replaceable>:initdefault:
         </para>
         <para>
          (位於 <filename>/etc/inittab</filename> 中)
         </para>
        </entry>
       </row>
       <row>
        <entry colname="1">
         <para>
          變更目前開機程序的預設執行層級
         </para>
        </entry>
        <entry colname="2">
         <para>
          在開機提示的選項中輸入下列文字：
         </para>
         <para>
          <command>systemd.unit=</command>
          <replaceable>我的目標</replaceable>.target
         </para>
        </entry>
        <entry colname="3">
         <para>
          在開機提示中輸入所需的執行層級編號。
         </para>
        </entry>
       </row>
       <row>
        <entry colname="1">
         <para>
          顯示目標/執行層級的相依性
         </para>
        </entry>
        <entry colname="2">
         <para>
          <command>systemctl show -p "Requires"</command>
          <replaceable>我的目標</replaceable>.target
         </para>
         <para>
          <command>systemctl show -p "Wants"</command>
          <replaceable>我的目標</replaceable>.target
         </para>
         <para>
          <quote>Requires</quote> 會列出硬相依性 (必須解析的相依性)，而 <quote>Wants</quote> 則列出軟相依性 (可行時解析的相依性)。
         </para>
        </entry>
        <entry colname="3">
         <para>
          無
         </para>
        </entry>
       </row>
      </tbody>
     </tgroup>
    </informaltable>
   </sect3>
  </sect2>

  <sect2 xml:id="sec.boot.systemd.debug">
   <title>系統啟動除錯</title>
   <para>
    systemd 針對系統啟動過程提供了分析方法。您可以方便地檢閱所有服務及其狀態的清單 (而不必剖析 <filename>/varlog/</filename>)。systemd 還允許您掃描啟動程序，以瞭解每項服務耗費多長時間啟動。
   </para>
   <sect3 xml:id="sec.boot.systemd.debug.review">
    <title>檢閱服務啟動</title>
    <para>
     若要檢閱自從系統開機以來已啟動的完整服務清單，請輸入指令 <command>systemctl</command>。這將列出所有使用中的服務，如下方所述 (已縮短)。若要獲得特定服務的詳細資訊，請使用 <command>systemctl status <replaceable>我的服務</replaceable></command>。
    </para>
    <example>
     <title>列出使用中的服務</title>
<screen><prompt role="root">root # </prompt>systemctl
UNIT                        LOAD   ACTIVE SUB       JOB DESCRIPTION
[...]
iscsi.service               loaded active exited    Login and scanning of iSC+
kmod-static-nodes.service   loaded active exited    Create list of required s+
libvirtd.service            loaded active running   Virtualization daemon
nscd.service                loaded active running   Name Service Cache Daemon
ntpd.service                loaded active running   NTP Server Daemon
polkit.service              loaded active running   Authorization Manager
postfix.service             loaded active running   Postfix Mail Transport Ag+
rc-local.service            loaded active exited    /etc/init.d/boot.local Co+
rsyslog.service             loaded active running   System Logging Service
[...]
LOAD   = Reflects whether the unit definition was properly loaded.
ACTIVE = The high-level unit activation state, i.e. generalization of SUB.
SUB    = The low-level unit activation state, values depend on unit type.

161 loaded units listed. Pass --all to see loaded but inactive units, too.
To show all installed unit files use 'systemctl list-unit-files'.</screen>
    </example>
    <para>
     若要限制為輸出無法啟動的服務，請使用 <option>--failed</option> 選項︰
    </para>
    <example>
     <title>列出失敗的服務</title>
<screen><prompt role="root">root # </prompt>systemctl --failed
UNIT                   LOAD   ACTIVE SUB    JOB DESCRIPTION
apache2.service        loaded failed failed     apache
NetworkManager.service loaded failed failed     Network Manager
plymouth-start.service loaded failed failed     Show Plymouth Boot Screen

[...]</screen>
    </example>
   </sect3>
   <sect3 xml:id="sec.boot.systemd.debug.time">
    <title>啟動時間除錯</title>
    <para>
     為了對系統啟動時間除錯，systemd 提供了 <command>systemd-analyze</command> 指令。它會顯示總啟動時間以及按啟動時間排序的服務清單，還可以產生 SVG 圖，其中顯示各服務相對於其他服務所耗費的啟動時間。
    </para>
    <variablelist>
     <varlistentry>
      <term>列出系統啟動時間</term>
      <listitem>
<screen><prompt role="root">root # </prompt>systemd-analyze
Startup finished in 2666ms (kernel) + 21961ms (userspace) = 24628ms</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>列出服務啟動時間</term>
      <listitem>
<screen><prompt role="root">root # </prompt>systemd-analyze blame
  6472ms systemd-modules-load.service
  5833ms remount-rootfs.service
  4597ms network.service
  4254ms systemd-vconsole-setup.service
  4096ms postfix.service
  2998ms xdm.service
  2483ms localnet.service
  2470ms SuSEfirewall2_init.service
  2189ms avahi-daemon.service
  2120ms systemd-logind.service
  1210ms xinetd.service
  1080ms ntp.service
[...]
    75ms fbset.service
    72ms purge-kernels.service
    47ms dev-vda1.swap
    38ms bluez-coldplug.service
    35ms splash_early.service</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>服務啟動時間圖</term>
      <listitem>
<screen><prompt role="root">root # </prompt>systemd-analyze plot &gt; jupiter.example.com-startup.svg</screen>
       <informalfigure>
        <mediaobject>
         <imageobject role="fo">
          <imagedata fileref="systemd_startup.svg" width="75%" format="SVG"/>
         </imageobject>
         <imageobject role="html">
          <imagedata fileref="systemd_startup.png" width="75%" format="PNG"/>
         </imageobject>
        </mediaobject>
       </informalfigure>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="sec.boot.systemd.debug.complete">
    <title>檢閱完成的啟動程序</title>
    <para>
     上述指令可用於檢閱已啟動的服務及其啟動所耗費的時間。如果您需要知道更多詳細資料，可以在開機提示中輸入下列參數，指示 <systemitem class="daemon">systemd</systemitem> 詳細記錄完整的啟動程序︰
    </para>
<screen>systemd.log_level=debug systemd.log_target=kmsg</screen>
    <para>
     現在，<systemitem class="daemon">systemd</systemitem> 會將記錄訊息寫入核心環緩衝區。該緩衝區可透過 <command>dmesg</command> 檢視︰
    </para>
<screen>dmesg -T | less</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="sec.boot.systemd.sysv_compatibility">
   <title>System V 相容性</title>
   <para>
    Systemd 與 System V 相容，因此，您仍可以使用現有的 System V init 程序檔。但是，至少有一個已知問題會導致 System V init 程序檔不能依原樣與 Systemd 配合使用：透過 init 程序檔中的 <command>su</command> 或 <command>sudo</command> 以其他使用者身分啟動服務，會導致程序檔失敗，從而產生<quote>拒絕存取</quote>錯誤。
   </para>
   <para>
    使用 <command>su</command> 或 <command>sudo</command> 變更使用者時，會啟動 PAM 工作階段。完成 init 程序檔後會終止此工作階段。因此，init 程序檔啟動的服務也會終止。若要解決此問題，請執行下列步驟：
   </para>
   <procedure>
    <step>
     <para>
      建立與 init 程序檔同名、副檔名為 <filename>.service</filename> 的服務檔案包裝程式。
     </para>
<screen>[Unit]
Description=<replaceable>DESCRIPTION</replaceable>
After=network.target

[Service]
User=<replaceable>USER</replaceable>
Type=forking<co xml:id="co.service_wrapper.type"/>
PIDFile=<replaceable>PATH TO PID FILE</replaceable><xref linkend="co.service_wrapper.type" xrefstyle="select:label nopage"/>
ExecStart=<replaceable>PATH TO INIT SCRIPT</replaceable> start
ExecStop=<replaceable>PATH TO INIT SCRIPT</replaceable> stop
ExecStopPost=/usr/bin/rm -f <replaceable>PATH TO PID FILE</replaceable><xref linkend="co.service_wrapper.type" xrefstyle="select:label nopage"/>

[Install]
WantedBy=multi-user.target<co xml:id="co.service_wrapper.target"/></screen>
     <para>
      以適當的值取代 <replaceable>UPPERCASE LETTERS</replaceable> 中寫入的所有值。
     </para>
     <calloutlist>
      <callout arearefs="co.service_wrapper.type">
       <para>
        選擇性 — 僅當 init 程序檔啟動精靈時才使用。
       </para>
      </callout>
      <callout arearefs="co.service_wrapper.target">
       <para>
        <literal>multi-user.target</literal> 在開機到 <literal>graphical.target</literal> 時也會啟動 init 程序檔。如果只應在開機到顯示管理員時才將它啟動，請在此處使用 <literal>graphical.target</literal>。
       </para>
      </callout>
     </calloutlist>
    </step>
    <step>
     <para>
      使用 <command>systemctl start <replaceable>應用程式</replaceable></command>啟動精靈。
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.boot.runlevel.edit">
  <title>使用 YaST 管理 服務</title>

  <para>
   基本服務管理也可以透過 YaST 服務管理員模組實現。該模組不僅支援啟動、停止、啟用和停用服務，還可用於顯示服務的狀態以及變更預設目標。若要啟動 YaST 模組，請選取<menuchoice> <guimenu>YaST</guimenu>
   <guimenu> 系統</guimenu> <guimenu> 服務管理員</guimenu> </menuchoice>。
  </para>

  <figure xml:id="fig.yast2.runlevel">
   <title>服務管理員</title>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="yast2_runlevel.png" width="75%" format="PNG"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="yast2_runlevel.png" width="75%" format="PNG"/>
    </imageobject>
   </mediaobject>
  </figure>

  <variablelist>
   <varlistentry>
    <term>變更<guimenu>預設系統目標</guimenu>
    </term>
    <listitem>
     <para>
      若要變更系統開機進入的目標，請從<guimenu>預設系統目標</guimenu>下拉方塊中選擇目標。最常用的目標是<guimenu>圖形介面</guimenu> (啟動圖形登入畫面) 和<guimenu>多重使用者</guimenu> (以指令行模式啟動系統)。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>啟動或停止服務</term>
    <listitem>
     <para>
      從表中選取服務。<guimenu>使用中</guimenu>欄顯示它目前是在執行中 (<guimenu>使用中</guimenu>) 還是未執行 (<guimenu>非使用中</guimenu>)。其狀態可透過選擇<guimenu>啟動/停止</guimenu>進行切換。
     </para>
     <para>
      如果啟動或停止服務，會變更其對目前執行中工作階段而言的狀態。若要在整個重新開機期間變更服務的狀態，您需要啟用或停用服務。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>啟用或停用服務</term>
    <listitem>
     <para>
      從表中選取服務。<guimenu>已啟用</guimenu>欄顯示它目前是<guimenu>已啟用</guimenu>還是<guimenu>已停用</guimenu>。其狀態可透過選擇<guimenu>啟用/停用</guimenu>進行切換。
     </para>
     <para>
      透過啟用或停用服務，可設定在開機期間是否啟動該服務 (<guimenu>已啟用</guimenu> 或<guimenu>已停用</guimenu>)。此設定不影響目前的工作階段。若要變更該服務在目前工作階段中的狀態，您需要予以啟動或停止。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>檢視狀態訊息</term>
    <listitem>
     <para>
      若要檢視服務的狀態訊息，請從清單中選取該服務，然後選擇<guimenu>
顯示詳細資料</guimenu>。您看到的輸出與 <command>systemctl </command> <option>-l</option> status <replaceable>我的服務</replaceable>指令產生的輸出完全相同。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <warning>
   <title>錯誤的執行層級設定可能會造成系統損害</title>
   <para>
    錯誤的執行層級設定可能會導致系統無法使用。在您套用變更之前，請務必確定您知道它們的後果。
   </para>
  </warning>
 </sect1>
 <sect1 xml:id="sec.boot.systemd.custom">
  <title>自訂 <systemitem>systemd</systemitem></title>

  <para>
   下列各節列出了 <systemitem>systemd</systemitem> 自訂的一些範例。
  </para>

  <warning>
   <title>避免覆寫自訂</title>
   <para>
    請務必在 <filename>/etc/systemd/</filename> 中而<emphasis>絕非</emphasis> <filename>/usr/lib/systemd/</filename> 中自訂。否則，下次更新 systemd 時會覆寫您的變更。
   </para>
  </warning>

  <sect2 xml:id="sec.boot.systemd.custom.service">
   <title>自訂服務檔案</title>
   <para>
    systemd 服務檔案位於 <filename>/usr/lib/systemd/system</filename> 中。如果您要自訂服務檔案，請執行下列步驟：
   </para>
   <procedure>
    <step>
     <para>
      將要修改的檔案從 <filename>/usr/lib/systemd/system</filename> 複製到 <filename>/etc/systemd/system</filename>。保持檔案名稱不變。
     </para>
    </step>
    <step>
     <para>
      根據需要修改 <filename>/etc/systemd/system</filename> 中的副本。
     </para>
    </step>
    <step>
     <para>
      如需組態變更概觀，請使用 <command>systemd-delta</command> 指令。它會比較並識別哪些組態檔案覆寫其他組態檔案。如需詳細資料，請參閱 <command>sleha-init</command> man 頁面。
     </para>
    </step>
   </procedure>
   <para>
    <filename>/etc/systemd</filename> 中修改過的檔案優先於 <filename>/usr/lib/systemd/system</filename> 中的原始檔案，前提是它們的檔案名稱相同。
   </para>
  </sect2>

  <sect2 xml:id="sec.boot.systemd.custom.drop-in">
   <title>建立<quote>
放入式</quote>檔案</title>
   <para>
    如果您只想在組態檔案中新增若干行或修改一小部分，可以使用<quote>放入式</quote>檔案。放入式檔案可讓您延伸單位檔案的組態，而不必編輯或覆寫單位檔案本身。
   </para>
   <para>
    例如，若要變更位於 <filename>/usr/lib/systemd/system/<replaceable>FOOBAR.SERVICE</replaceable></filename> 中 <replaceable>FOOBAR</replaceable> 服務的一個值，請依照以下步驟操作︰
   </para>
   <procedure>
    <step>
     <para>
      建立名為 <filename>/etc/systemd/system/<replaceable>我的服務</replaceable>.service.d/</filename> 的目錄。
     </para>
     <para>
      注意字尾為 <literal>.d</literal>。該目錄必須命名為要透過所放入之檔案修補的服務。
     </para>
    </step>
    <step>
     <para>
      在該目錄中，建立 <filename><replaceable>WHATEVERMODIFICATION</replaceable>.conf</filename> 檔案。
     </para>
     <para>
      確保該檔案僅包含待修改值所在的行。
     </para>
    </step>
    <step>
     <para>
      將您所做的變更儲存到檔案中。它將用作原始檔案的延伸。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.boot.systemd.custom.targets">
   <title>建立自訂目標</title>
   <para>
    在 System V init SUSE 系統上並未使用執行層級 4，便於管理員自行建立執行層級組態。systemd 可讓您建立任意個自訂目標。建議您在開始時先在 <systemitem>graphical.target</systemitem> 等現有的目標上調整。
   </para>
   <procedure>
    <step>
     <para>
      將組態檔案 <filename>/usr/lib/systemd/system/graphical.target</filename> 複製到 <filename>/etc/systemd/system/<replaceable>我的目標</replaceable>.target</filename>，並依據需要調整該檔案。
     </para>
    </step>
    <step>
     <para>
      上一步中複製的組態檔案已涵蓋該目標的必要的 (<quote>
硬</quote>) 相依性。若要一併納入需要的 (<quote>軟</quote>) 相依項，請建立目錄 <filename>/etc/systemd/system/<replaceable>我的目標</replaceable>.target.wants</filename>。
     </para>
    </step>
    <step>
     <para>
      對每個需要的服務，建立從 <filename>/usr/lib/systemd/system</filename> 連到 <filename>/etc/systemd/system/<replaceable>我的目標</replaceable>.target.wants</filename> 的符號連結。
     </para>
    </step>
    <step>
     <para>
      目標設定完畢後，重新載入 systemd 組態以便能夠使用新目標︰
     </para>
<screen>systemctl daemon-reload</screen>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.boot.systemd.advanced">
  <title>進階用法</title>

  <para>
   下列各節涵蓋進階主題，適用於系統管理員。如需更為進階的 systemd 文件，請參閱 Lennart Pöttering 針對管理員撰寫的 systemd 系列文章，網址為 <link xlink:href="http://0pointer.de/blog/projects"/>。
  </para>

  <sect2 xml:id="sec.boot.systemd.advanced.tmp">
   <title>清理暫存目錄</title>
   <para>
    <systemitem class="daemon">systemd</systemitem> 支援定期清理暫存目錄。將會自動移轉並啟用前一系統版本中的組態。<literal>tmpfiles.d</literal> (負責管理暫存檔案) 將從 <filename>/etc/tmpfiles.d/*.conf</filename>、<filename>/run/tmpfiles.d/*.conf</filename> 和 <filename>/usr/lib/tmpfiles.d/*.conf</filename> 檔案中讀取其組態。<filename>/etc/tmpfiles.d/*.conf</filename> 中的組態將會覆寫其他兩個目錄中的相關組態 (<filename>/usr/lib/tmpfiles.d/*.conf</filename> 是套件將其組態檔案儲存到的位置)。
   </para>
   <para>
    組態格式為每個路徑一行，該行包含動作與路徑、(選擇性) 模式、擁有權、期限和引數欄位，具體視動作而定。以下範例將取消連結 X11 鎖定檔案：
   </para>
<screen>Type Path               Mode UID  GID  Age Argument
r    /tmp/.X[0-9]*-lock</screen>
   <para>
    若要取得 tmpfile 計時器的狀態：
   </para>
<screen>systemctl status systemd-tmpfiles-clean.timer
systemd-tmpfiles-clean.timer - Daily Cleanup of Temporary Directories
 Loaded: loaded (/usr/lib/systemd/system/systemd-tmpfiles-clean.timer; static)
 Active: active (waiting) since Tue 2014-09-09 15:30:36 CEST; 1 weeks 6 days ago
   Docs: man:tmpfiles.d(5)
         man:systemd-tmpfiles(8)

Sep 09 15:30:36 jupiter systemd[1]: Starting Daily Cleanup of Temporary Directories.
Sep 09 15:30:36 jupiter systemd[1]: Started Daily Cleanup of Temporary Directories.</screen>
   <para>
    如需處理暫存檔案的詳細資訊，請參閱 <command>man 5 tmpfiles.d</command>。
   </para>
  </sect2>

  <sect2 xml:id="sec.boot.systemd.advanced.logging">
   <title>系統記錄</title>
   <para>
    <xref linkend="sec.boot.systemd.basics.services_debugging"/>說明如何檢視給定服務的記錄訊息。然而，記錄的訊息顯示並不局限為服務記錄。您還可以存取和查詢 <systemitem class="daemon">systemd</systemitem> 寫入的完整記錄訊息 — 亦即<quote>日誌</quote>。使用指令 <command>systemd-journalctl</command> 可顯示從最舊項目開始的完整記錄訊息。如需套用過濾器或變更輸出格式等選項的資訊，請參閱 <command>man 1 systemd-journalctl</command>。
   </para>
  </sect2>

  <sect2 xml:id="sec.boot.systemd.advanced.snapshots">
   <title>快照</title>
   <para>
    您可以使用 <command>isolate</command> 子指令將 <systemitem class="daemon">systemd</systemitem> 的目前狀態儲存到指定的快照，日後可以回復到該狀態。此功能在測試服務或自訂目標時非常有用，因為它允許您隨時回到定義的狀態。快照僅在目前工作階段中可用，重新開機時將自動刪除。快照名稱必須以 <filename>.snapshot</filename> 結尾。
   </para>
   <variablelist>
    <varlistentry>
     <term>建立快照</term>
     <listitem>
<screen>systemctl snapshot <replaceable>MY_SNAPSHOT</replaceable>.snapshot</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>刪除快照</term>
     <listitem>
<screen>systemctl delete <replaceable>MY_SNAPSHOT</replaceable>.snapshot</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>檢視快照</term>
     <listitem>
<screen>systemctl show <replaceable>MY_SNAPSHOT</replaceable>.snapshot</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>啟動快照</term>
     <listitem>
<screen>systemctl isolate <replaceable>MY_SNAPSHOT</replaceable>.snapshot</screen>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>





  <sect2 xml:id="sec.boot.systemd.advanced.kernel_modules">
   <title>載入核心模組</title>
   <para>
    使用 <systemitem class="daemon">systemd</systemitem>，可透過 <filename>/etc/modules-load.d</filename> 中的組態檔案，在開機時自動載入核心模組。該檔案應命名為 <replaceable>MODULE</replaceable>.conf 並包含以下內容︰
   </para>
<screen># load module <replaceable>MODULE</replaceable> at boot time
<replaceable>MODULE</replaceable></screen>
   <para>
    如果某個套件安裝了用於載入核心模組的組態檔案，該檔案將安裝到 <filename>/usr/lib/modules-load.d</filename>。如果存在兩個同名的組態檔案，將優先使用 <filename>/etc/modules-load.d</filename> 中的組態檔案。
   </para>
   <para>
    如需詳細資訊，請參閱 <systemitem>modules-load.d(5)</systemitem> 線上文件。
   </para>
  </sect2>



  <sect2 xml:id="sec.boot.systemd.advanced.before.local">
   <title>載入服務之前執行動作</title>
   <para>
    使用 System V 時，需要在載入服務之前執行的 init 動作必須在 <filename>/etc/init.d/before.local</filename> 中指定。systemd 不再支援此程序。如果您需要在啟動服務之前執行動作，請執行以下步驟：
   </para>
   <variablelist>
    <varlistentry>
     <term>載入核心模組</term>
     <listitem>
      <para>
       在 <filename>/etc/modules-load.d</filename> 目錄中建立一個 drop-in 檔案 (如需語法，請參閱 <command>man modules-load.d</command>)
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>
     建立檔案或目錄，清理目錄，變更擁有權
     </term>
     <listitem>
      <para>
       在 <filename>/etc/tmpfiles.d</filename> 中建立一個 drop-in 檔案 (如需語法，請參閱 <command>man tmpfiles.d</command>)
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>其他任務</term>
     <listitem>
      <para>
       從以下範本建立一個系統服務檔案，例如 <filename>/etc/systemd/system/before.service</filename>：
      </para>
<screen>[Unit]
Before=<replaceable>NAME OF THE SERVICE YOU WANT THIS SERVICE TO BE STARTED BEFORE</replaceable>
[Service]
Type=oneshot
RemainAfterExit=true
ExecStart=<replaceable>YOUR_COMMAND</replaceable>
# beware, executable is run directly, not through a shell, check the man pages
# systemd.service and systemd.unit for full syntax
[Install]
# target in which to start the service
WantedBy=multi-user.target
#WantedBy=graphical.target</screen>
      <para>
       建立服務檔案後，應執行以下指令 (以 <systemitem class="username">root</systemitem> 身分)：
      </para>
<screen>systemctl daemon-reload
systemctl enable before</screen>
      <para>
       每次修改服務檔案時，都需要執行：
      </para>
<screen>systemctl daemon-reload</screen>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>



  <sect2 xml:id="sec.boot.systemd.advanced.cgroups">
   <title>核心控制群組 (cgroup)</title>
   <para>
    在傳統 System V init 系統上不一定能將程序明確指派給繁衍它的服務。有些服務 (例如 Apache) 會繁衍許多協力廠商程序 (例如 CGI 或 Java 程序)，這些程序本身又會繁衍許多程序。這導致您很難明確指派，甚至根本無法明確指派。另外，服務在不當終止後，可能殘留部分子項保持活動狀態。
   </para>
   <para>
    systemd 將每個服務放入它自己的 cgroup 中，從而解決此問題。cgroup 是一項核心功能，允許將程序及其所有子程序聚合至分層組織的群組中。systemd 根據相應的服務為每個 cgroup 命名。由於程序未經特許不得<quote>
離開</quote>其 cgroup，因此這樣可以有效地使用服務名稱標記該服務繁衍的所有程序。
   </para>
   <para>
    若要列出屬於服務的所有程序，請使用指令 <command>systemd-cgls</command>。結果類似於以下範例 (已縮短) ︰
   </para>
   <example>
    <title>列出屬於服務的所有程序</title>
<screen><prompt role="root">root # </prompt>systemd-cgls --no-pager
├─1 /usr/lib/systemd/systemd --switched-root --system --deserialize 20
├─user.slice
│ └─user-1000.slice
│   ├─session-102.scope
│   │ ├─12426 gdm-session-worker [pam/gdm-password]
│   │ ├─15831 gdm-session-worker [pam/gdm-password]
│   │ ├─15839 gdm-session-worker [pam/gdm-password]
│   │ ├─15858 /usr/lib/gnome-terminal-server

[...]

└─system.slice
  ├─systemd-hostnamed.service
  │ └─17616 /usr/lib/systemd/systemd-hostnamed
  ├─cron.service
  │ └─1689 /usr/sbin/cron -n
  ├─ntpd.service
  │ └─1328 /usr/sbin/ntpd -p /var/run/ntp/ntpd.pid -g -u ntp:ntp -c /etc/ntp.conf
  ├─postfix.service
  │ ├─ 1676 /usr/lib/postfix/master -w
  │ ├─ 1679 qmgr -l -t fifo -u
  │ └─15590 pickup -l -t fifo -u
  ├─sshd.service
  │ └─1436 /usr/sbin/sshd -D

[...]</screen>
   </example>
   <para>
    如需 cgroup 的詳細資訊，請參閱<xref linkend="cha.tuning.cgroups"/>。
   </para>
  </sect2>

  <sect2 xml:id="sec.boot.systemd.advanced.kill">
   <title>終止服務 (傳送信號)</title>
   <para>
    如<xref linkend="sec.boot.systemd.advanced.cgroups"/>中所述，在 System V init 系統中不一定能將程序指派給其父服務，導致難以終止服務及其所有子項。未終止的子程序將保留為廢止程序。
   </para>
   <para>
    systemd 的理念在於將每個服務限制在 cgroup 中，從而得以明確識別服務的所有子程序，因此可讓您傳送信號給這些程序中的每個程序。可使用 <command>systemctl kill</command> 將信號傳送給服務。如需可用信號清單，請參閱 <command>man 7 signals</command>。
   </para>
   <variablelist>
    <varlistentry>
     <term>將 <systemitem>SIGTERM</systemitem> 傳送給服務</term>
     <listitem>
      <para>
       <systemitem>SIGTERM</systemitem> 是傳送的預設信號。
      </para>
<screen>systemctl kill <replaceable>MY_SERVICE</replaceable></screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>將<replaceable>信號</replaceable>傳送給服務</term>
     <listitem>
      <para>
       可使用 <option>-s</option> 選項指定應傳送的信號。
      </para>
<screen>systemctl kill -s <replaceable>SIGNAL</replaceable> <replaceable>MY_SERVICE</replaceable></screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>選取程序</term>
     <listitem>
      <para>
       依預設，<command>kill</command> 指令會將信號傳送給指定 cgroup 的 <option>all</option> 程序。您可以將傳送目標限制為 <option>control</option> 或 <option>main</option> 程序。後者非常實用，如下例透過傳送 <systemitem>SIGHUP</systemitem> 強制服務重新載入其組態所示︰
      </para>
<screen>systemctl kill -s SIGHUP --kill-who=main <replaceable>MY_SERVICE</replaceable></screen>
     </listitem>
    </varlistentry>
   </variablelist>

   <warning>
    <title>不支援終止或重新啟動 D-BUS 服務</title>
    <para>
     D-Bus 服務是 systemd 用戶端與做為 pid 1 執行的 systemd 管理員之間進行通訊的訊息匯流排。雖然 <systemitem class="daemon">dbus</systemitem> 是一個獨立的精靈，但它也是 init 基礎架構的組成部分。
    </para>
    <para>
     在執行中系統內終止或重新啟動 <systemitem class="daemon">dbus</systemitem> 的效果類似於嘗試終止或重新啟動 pid 1。此操作將中斷 systemd 用戶端與伺服器間的通訊，並使大多數 systemd 功能不可用。
    </para>
    <para>
     因此，不建議也不支援終止或重新啟動 <systemitem class="daemon">dbus</systemitem>。
    </para>
   </warning>

  </sect2>



  <sect2 xml:id="sec.boot.systemd.basics.services_debugging">
   <title>服務除錯</title>
   <para>
    systemd 依預設不會過度記錄詳細資料。如果服務啟動成功，則不會產生任何輸出。如果啟動失敗，則會顯示簡短的錯誤訊息。不過，<command>systemctl status</command> 可讓您以不同方式對服務的啟動和作業進行除錯。
   </para>
   <para>
    systemd 隨附自己的記錄機製 (<quote>
日誌</quote>)，可以記錄系統訊息，便於您一併顯示服務訊息與狀態訊息。<command>status</command> 指令的工作方式與 <command>tail</command> 相似，也可以採用不同的格式顯示記錄訊息，因此成為功能強大的除錯工具。
   </para>
   <variablelist>
    <varlistentry>
     <term>顯示服務啟動失敗</term>
     <listitem>
      <para>
       每當服務啟動失敗時，使用 <command>systemctl status <replaceable>我的服務</replaceable></command>可獲得詳細的錯誤訊息︰
      </para>
<screen><prompt role="root">root # </prompt>systemctl start apache2
Job failed. See system journal and 'systemctl status' for details.
<prompt role="root">root # </prompt>systemctl status apache2
   Loaded: loaded (/usr/lib/systemd/system/apache2.service; disabled)
   Active: failed (Result: exit-code) since Mon, 04 Jun 2012 16:52:26 +0200; 29s ago
   Process: 3088 ExecStart=/usr/sbin/start_apache2 -D SYSTEMD -k start (code=exited, status=1/FAILURE)
   CGroup: name=systemd:/system/apache2.service

Jun 04 16:52:26 g144 start_apache2[3088]: httpd2-prefork: Syntax error on line
205 of /etc/apache2/httpd.conf: Syntax error on li...alHost&gt;</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>顯示最後 <replaceable>N</replaceable> 條服務訊息</term>
     <listitem>
      <para>
       <command>status</command> 子指令的預設行為是顯示服務發出的最近 10 條訊息。若要變更要顯示的訊息數，請使用 <option>--lines=<replaceable>N</replaceable></option> 參數︰
      </para>
<screen>systemctl status ntp
systemctl --lines=20 status ntp</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>以附加模式顯示服務訊息</term>
     <listitem>
      <para>
       若要顯示服務訊息的<quote>
即時串流</quote>，請使用 <option>--follow</option> 選項，其工作方式與 <command>tail </command> <option>-f</option> 相似︰
      </para>
<screen>systemctl --follow status ntp</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>訊息輸出格式</term>
     <listitem>
      <para>
       <option>--output=<replaceable>模式</replaceable></option>參數可讓您變更服務訊息的輸出格式。最重要的可用模式如下︰
      </para>
      <variablelist>
       <varlistentry>
        <term><option>short</option>
        </term>
        <listitem>
         <para>
          預設格式。顯示記錄訊息及易於理解的時戳。
         </para>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><option>verbose</option>
        </term>
        <listitem>
         <para>
          完整輸出所有欄位。
         </para>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><option>cat</option>
        </term>
        <listitem>
         <para>
          精簡輸出，不含時戳。
         </para>
        </listitem>
       </varlistentry>
      </variablelist>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.boot.systemd.info">
  <title>更多資訊</title>

  <para>
   如需 systemd 的詳細資訊，請參閱下列線上資源︰
  </para>

  <variablelist>
   <varlistentry>
    <term>首頁</term>
    <listitem>
     <para>
      <link xlink:href="http://www.freedesktop.org/wiki/Software/systemd"/>
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>管理員的 systemd</term>
    <listitem>
     <para>
      Lennart Pöttering 是 systemd 的原著者之一，他撰寫了一系列部落格文章 (寫本章時已有 13 篇)，其網址為 <link xlink:href="http://0pointer.de/blog/projects"/>。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
</chapter>
