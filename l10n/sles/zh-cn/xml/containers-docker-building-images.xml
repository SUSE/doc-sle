<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="containers-docker-building-images.xml" xml:id="cha-docker-building-images" xml:lang="zh-cn" version="5.0">
 <info>
  <title>创建自定义容器映像</title>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <para>
  要创建自定义映像，需要有 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 的基本映像。您可以使用任何预构建的 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 映像。
 </para>
 <sect1 xml:id="sec-download-prebuild-images">
  <title>提取基本 SLES 映像</title>

  <para>
   要获取 SUSE Linux Enterprise 12 SP3 和更高版本的预构建基本映像，请使用以下命令：
  </para>

<screen>
      <prompt>&gt; </prompt>docker pull registry.suse.com/suse/
      <replaceable>IMAGENAME</replaceable>
    </screen>

  <para>
   例如，对于 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 15，命令如下：
  </para>

<screen><prompt>&gt; </prompt>docker pull registry.suse.com/suse/sle15</screen>

  <para>
   不需要使用 <literal>sle2docker</literal>，因为系统会从 Docker 注册表中提取该映像。
  </para>

  <para>
   有关获取特定基本映像的信息，请参见<xref linkend="sec-sle-base-images"/>。
  </para>

  <para>
   容器映像准备就绪后，便可以按照<xref linkend="sec-customize-prebuild-images"/>中所述对其进行自定义。
  </para>
 </sect1>
 
 <sect1 xml:id="sec-customize-prebuild-images">
  <title>自定义 SLES 容器映像</title>

  <para>
   预构建的映像未配置任何软件源，也不包含任何模块或扩展。它们包含一个 <link xlink:href="https://github.com/SUSE/container-suseconnect">zypper 服务</link>，该服务根据运行容器的 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 主机的配置联系 SUSE® Customer Center 或 Repository Mirroring Tool (RMT) 服务器。该服务会获取容器映像所用产品的可用软件源列表。您还可以直接在 <filename>Dockerfile</filename> 中声明扩展。有关详细信息，请参见<xref linkend="sec-docker-sle-images-customizing-the-images-extensions"/>。
  </para>

  <note>
  <title>SLE_BCI 软件源</title>
  <para>
  从 SUSE Linux Enterprise 15 SP3 开始，默认基本映像会包含 <literal>SLE_BCI</literal> 软件源。仅当某个容器是在未注册的 SLES 主机上构建的或是在此类主机上运行时，或者当容器无法使用注册身份凭证时，才使用此软件源。该软件源提供了一部分 SUSE Linux Enterprise 15 SP3 软件包，用于自定义 SLES 容器映像。无需注册即可使用该软件源，但 SUSE 不对其提供支持。
  </para>
  </note>

  <para>
   您不需要在容器映像中添加任何身份凭证，因为 <systemitem class="daemon">docker</systemitem> 守护程序会自动将计算机身份凭证插入到容器中的 <literal>/run/secrets</literal> 目录。这同样适用于主机系统的 <filename>/etc/SUSEConnect</filename> 文件，该文件会自动插入到 <filename>/run/secrets</filename> 目录中。
  </para>

  <note>
   <title>身份凭证和安全性</title>
   <para>
    <filename>/run/secrets</filename> 目录的内容永远不会包含在容器映像中，因此不存在身份凭证泄露的风险。
   </para>
  </note>

  <note xml:id="note-build-images-different-codebase">
   <title>在已于 RMT 中注册的系统上构建映像</title>
   <para>
    如果用于构建容器映像的主机系统已在 RMT 中注册，则默认行为只允许构建其代码库与主机相同的容器。例如，如果您的容器主机是 SLE 15 系统，则默认只能在该主机上构建基于 SLE 15 的映像。要为不同的 SLE 版本（例如，SLE 15 主机上的 SLE 12）构建映像，可将目标版本的主机计算机身份凭证插入到容器中（如下所述）。请注意，如果 RMT 服务器使用自我签名证书，则需要将匹配的 CA 证书添加到 <filename><replaceable>CA 可信证书储存区</replaceable>/rmt-server.pem</filename> 中的容器才能接受证书。
   </para>
   <para>
    如果主机系统已在 SUSE Customer Center 中注册，则此限制不适用。
   </para>
  </note>

  <note>
   <title>在公有云中的按需 SLE 实例上构建容器映像</title>
   <para>
    在公有云（AWS、GCE 或 Azure）中以按需或即用即付实例形式启动的 SLE 实例上构建容器映像需要执行额外的步骤。要安装软件包和更新，需将<quote>按需</quote>公有云实例连接到更新基础结构。此基础结构基于 SUSE 在不同公有云提供商处运营的 RMT 服务器工作。
   </para>
   <para>
    因此，您的计算机需要找到所需的服务并向其进行身份验证。可以使用 <literal>containerbuild-regionsrv</literal> 服务来执行此操作。通过各公有云提供商的商城提供的公有云映像中提供此服务。在构建映像之前，必须通过运行以下命令在公有云实例上启动此服务：
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl start containerbuild-regionsrv</screen>
   <para>
    要让该服务在系统启动时自动启动，请启用该服务：
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl enable containerbuild-regionsrv</screen>
   <para>
    SLE 基本映像提供的 Zypper 插件将连接到此服务，并检索身份验证细节以及有关要与哪个更新服务器通讯的信息。为此，必须在启用主机网络的情况下构建容器，例如：
   </para>
<screen>
        <prompt>&gt; </prompt>docker build --network host
        <replaceable>build-directory/</replaceable>
      </screen>
   <para>
    由于公有云中的更新基础结构基于 RMT 工作，因此，为不同于主机 SLE 版本的 SLE 版本构建 SLE 映像也存在同样的限制（参见<xref linkend="note-build-images-different-codebase"/>）。
   </para>
  </note>

  <para>
   要获取软件源列表，请使用以下命令：
  </para>

<screen><prompt>&gt; </prompt><command>sudo</command> zypper ref -s</screen>

  <para>
   这会自动将所有软件源添加到容器中。对于添加到系统中的每个软件源，将在 <filename>/etc/zypp/repos.d</filename> 下创建一个新文件。这些软件源的 URL 包含一个在 12 小时后自动失效的访问令牌。要续订该令牌，请运行 <command>zypper ref -s</command> 命令。将这些文件包含在容器映像中不会带来任何安全风险。
  </para>

  <para>
   要使用一组不同的身份凭证，请将自定义 <filename>/etc/zypp/credentials.d/SCCcredentials</filename> 文件放入容器映像中。该文件中的计算机身份凭证包含您要使用的订阅。这同样适用于 <filename>SUSEConnect</filename> 文件：要覆盖运行容器的主机系统上的现有文件，请将自定义 <filename>/etc/SUSEConnect</filename> 文件添加到容器映像中。
  </para>

  <para>
   现在，您便可以按照<xref linkend="sec-docker-sle-images-customizing-the-images-sles12sp3"/>中所述使用 <literal>Dockerfile</literal> 来创建自定义容器映像。
  </para>

  <para>
   如果您要将应用程序移到容器中，请参见<xref linkend="cha-docker-containerize-app"/>。
  </para>

  <para>
   编辑 <filename>Dockerfile</filename> 后，通过在 <filename>Dockerfile</filename> 所在的同一目录中运行以下命令来构建映像：
  </para>

<screen><prompt>&gt; </prompt>docker build .</screen>

  <para>
   有关 <literal>docker build</literal> 选项的详细信息，请参见<link xlink:href="https://docs.docker.com/engine/reference/commandline/build/">官方 Docker 文档</link>。
  </para>

  <note>
   <title>创建应用程序映像</title>
   <para>
    有关如何为在容器中运行的应用程序创建 <filename>Dockerfile</filename> 的信息，请参见<xref linkend="cha-docker-containerize-app"/>。
   </para>
  </note>

  <sect2 xml:id="sec-docker-sle-images-customizing-the-images-sles12sp3">
   <title>为 SLE 12 SP3 和更高版本创建自定义映像</title>
   <para>
    下面的 <filename>Dockerfile</filename> 会创建一个基于 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server </phrase></phrase> 15 的简单容器映像：
   </para>
<screen>
        FROM registry.suse.com/suse/sle15

        RUN zypper ref -s
        RUN zypper -n in vim
      </screen>
   <para>
    如果 Docker 主机计算机已在内部 RMT 服务器中注册，则该映像需要 RMT 使用的 SSL 证书：
   </para>
<screen>
        FROM registry.suse.com/suse/sle15

        # Import the crt file of our private SMT server
        ADD http://smt.<replaceable>example.com</replaceable>/smt.crt /etc/pki/trust/anchors/smt.crt
        RUN update-ca-certificates

        RUN zypper ref -s
        RUN zypper -n in vim
      </screen>
  </sect2>

  <sect2 xml:id="sec-docker-sle-images-metainfo">
   <title>SLE 容器映像中的元信息</title>
   <para>
    从 SUSE Linux Enterprise 12 SP3 开始，所有基本容器映像都包含构建时戳和说明等信息。此信息以附加到基本映像的标签形式提供，因此可用于派生的映像和容器（参见<xref linkend="sec-labels"/>）。可以使用 <command>docker inspect</command> 查看此信息：
   </para>
<screen>
        <prompt>&gt; </prompt>docker inspect registry.suse.com/suse/sle15
        [...]
        "Labels": {
            "com.suse.sle.base.created": "2020-11-23T11:51:32.695975200Z",
            "com.suse.sle.base.description": "Image containing a minimal environment for containers based on SUSE Linux Enterprise Server 15 SP2.",
            "com.suse.sle.base.disturl": "obs://build.suse.de/SUSE:SLE-15-SP2:Update:CR/images/4a8871be8078bcef2e2417e2a98fc3a0-sles15-image",
            "com.suse.sle.base.reference": "registry.suse.com/suse/sle15:15.2.8.2.794",
            "com.suse.sle.base.title": "SUSE Linux Enterprise Server 15 SP2 Base Container",
            "com.suse.sle.base.url": "https://www.suse.com/products/server/",
            "com.suse.sle.base.vendor": "SUSE LLC",
            "com.suse.sle.base.version": "15.2.8.2.794",
            "org.openbuildservice.disturl": "obs://build.suse.de/SUSE:SLE-15-SP2:Update:CR/images/4a8871be8078bcef2e2417e2a98fc3a0-sles15-image",
            "org.opencontainers.image.created": "2020-11-23T11:51:32.695975200Z",
            "org.opencontainers.image.description": "Image containing a minimal environment for containers based on SUSE Linux Enterprise Server 15 SP2.",
            "org.opencontainers.image.title": "SUSE Linux Enterprise Server 15 SP2 Base Container",
            "org.opencontainers.image.url": "https://www.suse.com/products/server/",
            "org.opencontainers.image.vendor": "SUSE LLC",
            "org.opencontainers.image.version": "15.2.8.2.794",
            "org.opensuse.reference": "registry.suse.com/suse/sle15:15.2.8.2.794"
        },
        [...]
      </screen>
   <para>
    所有标签将显示两次，以确保在派生映像中有关原始基本映像的信息仍然可见，不会被覆盖。
   </para>
  </sect2>

  <sect2 xml:id="sec-docker-sle-images-customizing-the-images-extensions">
   <title>将 SLE 扩展和模块添加到映像中</title>
   <para>
    如果您订阅了要在自定义映像中使用的 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 扩展或模块，可以通过指定 <literal>ADDITIONAL_MODULES</literal> 环境变量将它们添加到容器映像中：
   </para>
<screen>ENV ADDITIONAL_MODULES sle-module-desktop-applications,sle-module-development-tools</screen>
  </sect2>
 </sect1>


</chapter>
