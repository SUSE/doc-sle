<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="deployment_image.xml" version="5.0" role="General" xml:id="cha-deployment-clone-image">
 <title>複製磁碟影像</title>
 <info>
  <abstract>
   <para>
    本章介紹如何使用複製的影像來安裝 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>。此程序主要用於虛擬化環境中。
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>是</dm:translation>
  </dm:docmanager>
 </info>
 <sect1 xml:id="sec-deployment-clone-image-overview">
  <title>綜覽</title>
  <para>
   <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 提供了一個程序檔來清理每項安裝的獨特組態。隨著 <systemitem class="daemon">systemd</systemitem> 的推出，可以在不同的位置及檔案中使用並設定唯一的系統識別碼。因此，建議不要再使用複製方式來建構系統影像。可以使用 KIWI 建立影像，具體請參閱 <link xlink:href="https://doc.suse.com/kiwi/"/>。
  </para>
  <para>
   若要複製機器的磁碟，請參閱您虛擬化環境的相關文件。
  </para>
 </sect1>
 <sect1 xml:id="sec-deployment-clone-image-clean">
  <title>清理唯一的系統識別碼</title>
  <warning>
   <title>重要組態遺失</title>
   <para>
    執行以下程序會永久刪除重要的系統組態資料。如果生產環境中在使用複製品的來源系統，請對複製的影像執行清理程序檔。
   </para>
  </warning>
  <para>
   若要清理所有唯一的系統識別碼，請在複製磁碟影像之前或之後執行以下程序。如果對複製品執行此程序，則需要對每個複製品都執行。因此，我們建議建立一個不在生產環境中使用，而是僅用做新複製品來源的<literal>黃金影像</literal>。已對該黃金影像執行清理操作，可立即使用複製品。
  </para>
  <para>
   例如，<command>clone-master-clean-up</command> 指令會移除以下資料：
  </para>
  <itemizedlist>
   <listitem>
    <para>交換檔</para>
   </listitem>
   <listitem>
    <para>Zypper 儲存庫</para>
   </listitem>
   <listitem>
    <para>SSH 主機和用戶端金鑰</para>
   </listitem>
   <listitem>
    <para>暫存目錄，例如 <filename>/tmp/*</filename></para>
   </listitem>
   <listitem>
    <para>Postfix 資料</para>
   </listitem>
   <listitem>
    <para>HANA 防火牆程序檔</para>
   </listitem>
   <listitem>
    <para>systemd 記錄</para>
   </listitem>
  </itemizedlist>
  <procedure>
   <step>
    <para>
     使用 <command>zypper</command> 安裝 <package>clone-master-clean-up</package>：
    </para>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>zypper</command> install clone-master-clean-up</screen>
   </step>
   <step>
    <para>
     編輯 <filename>/etc/sysconfig/clone-master-clean-up</filename> 以設定 <command>clone-master-clean-up</command> 的行為。此組態檔案定義是否應移除 UID 大於 1000 的使用者、<filename>/etc/sudoers</filename> 檔案、用於安裝套件的軟體儲存庫和 Btrfs 快照。
    </para>
   </step>
   <step>
    <para>
     執行以下程序檔來移除現有的組態和唯一的識別碼：
    </para>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>clone-master-clean-up</command></screen>
   </step>
  </procedure>
 </sect1>
</chapter>
