<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="apparmor_start.xml" version="5.0" xml:id="cha-apparmor-start">
 <title>入门</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:bugtracker>
        </dm:bugtracker>
	<dm:translation>yes</dm:translation>
      </dm:docmanager>
    </info>
    <para>
  请仔细考虑以下事项，以便为在系统上成功部署 <phrase>AppArmor</phrase> 做好准备：
 </para>
 <procedure>
  <step>
   <para>
    确定要构建配置文件的应用程序。有关详细信息，请参见<xref linkend="sec-apparmor-start-choose"/>。
   </para>
  </step>
  <step>
   <para>
    根据<xref linkend="sec-apparmor-start-build"/>中的简要说明构建需要的配置文件。检查结果并在必要时调整配置文件。
   </para>
  </step>
  <step>
   <para>
    每当环境发生变化或者您需要对 <phrase>AppArmor</phrase> 的报告工具记录的安全事件作出反应时，请更新您的配置文件。有关详细信息，请参见 <xref linkend="sec-apparmor-start-update"/>.
   </para>
  </step>
 </procedure>
 <sect1 xml:id="sec-apparmor-start-install">
  <title>安装 <phrase>AppArmor</phrase></title>

  <para>
   在任何安装的 <phrase role="productname"><phrase os="sled">SUSE® Linux Enterprise Desktop</phrase></phrase> 上，无论安装了哪些模式，默认都会安装并运行 <phrase>AppArmor</phrase>。<phrase>AppArmor</phrase> 的完整功能实例需要下面列出的软件包：
  </para>

  <itemizedlist spacing="compact" mark="bullet">
   <listitem>
    <para>
     <systemitem class="resource">apparmor-docs</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem class="resource">apparmor-parser</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem class="resource">apparmor-profiles</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem class="resource">apparmor-utils</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem class="resource">audit</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem class="resource">libapparmor1</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem class="resource">perl-libapparmor</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem class="resource">yast2-apparmor</systemitem>
    </para>
   </listitem>
  </itemizedlist>

  <tip>
   <para>
    如果您的系统上未安装 <phrase>AppArmor</phrase>，请安装 <systemitem class="resource">apparmor</systemitem> 模式以安装完整的 <phrase>AppArmor</phrase>。请使用 YaST 软件管理模块进行安装，或者在命令行上使用 Zypper：
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> zypper in -t pattern apparmor</screen>
  </tip>
 </sect1>
 <sect1 xml:id="sec-apparmor-start-enable">
  <title>启用和禁用 <phrase>AppArmor</phrase></title>

  <para>
   在任何全新安装的 <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 上，默认都会将 <phrase>AppArmor</phrase> 配置为运行状态。可以通过两种方式切换 <phrase>AppArmor</phrase> 的状态：
  </para>

  <variablelist>
   <varlistentry>
    <term>使用 YaST 服务管理器</term>
    <listitem>
     <para>
      通过在系统引导时所执行的脚本序列中去除或添加引导脚本来禁用或启用 <phrase>AppArmor</phrase>。重引导时将应用状态更改。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>使用 <phrase>AppArmor</phrase> 配置窗口</term>
    <listitem>
     <para>
      可以使用 YaST <phrase>AppArmor</phrase> 控制面板关闭或打开 <phrase>AppArmor</phrase>，以在运行中的系统上切换其状态。在控制面板中所执行的更改将即时应用。控制面板会触发 <phrase>AppArmor</phrase> 停止或启动事件，并在系统引导序列中去除或添加它的引导脚本。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   要通过从系统引导时所执行的脚本序列中去除 <phrase>AppArmor</phrase> 永久将其禁用，请执行以下操作：
  </para>

  <procedure>
   <step>
    <para>
     启动 YaST。
    </para>
   </step>
   <step>
    <para>
     选择<menuchoice> <guimenu>系统</guimenu> <guimenu>服务管理器</guimenu> </menuchoice>。
    </para>
   </step>
   <step>
    <para>
     在服务列表中单击 <literal>apparmor</literal> 所在的行将其选中，然后在窗口的下半部分单击<guimenu>启用/禁用</guimenu>。在 <literal>apparmor</literal> 行中检查<guimenu>已启用</guimenu>是否已更改为<guimenu>已禁用</guimenu>。
    </para>
   </step>
   <step>
    <para>
     单击<guimenu>确定</guimenu>进行确认。
    </para>
   </step>
  </procedure>

  <para>
   <phrase>AppArmor</phrase> 在重引导时不会初始化，并会保持非活动状态，直到您重新将其启用。使用 YaST <guimenu>服务管理器</guimenu>工具重新启用服务的操作与禁用服务类似。
  </para>

  <para>
   使用“<phrase>AppArmor</phrase> 配置”窗口在运行中的系统上切换 <phrase>AppArmor</phrase> 的状态。应用这些更改并重引导系统后，这些更改将生效。要切换 <phrase>AppArmor</phrase> 的状态，请执行以下操作：
  </para>

  <procedure>
   <step>
    <para>
     启动 YaST，选择 <guimenu><phrase>AppArmor</phrase> 配置</guimenu>，然后在主窗口中单击<guimenu>设置</guimenu>。
    </para>
   </step>
   <step>
    <para>
     选中<guimenu>启用 <phrase>AppArmor</phrase></guimenu> 以启用 <phrase>AppArmor</phrase>，或取消选中该选项以禁用 <phrase>AppArmor</phrase>。
    </para>
   </step>
   <step>
    <para>
     单击 <guimenu>AppArmor 配置</guimenu>窗口中的<guimenu><phrase></phrase>完成</guimenu>。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-apparmor-start-choose">
  <title>选择要构建配置文件的应用程序</title>

  <para>
   您只需保护在您的特定设置中会受到攻击的程序，因此只需为实际运行的程序使用配置文件。使用以下列表来确定最可能的候选程序：
  </para>

  <simplelist>
   <member>网络代理</member>
   <member>Web 应用程序</member>
   <member>Cron 作业</member>
  </simplelist>

  <para>
   要了解哪些进程当前以开放网络端口运行并且可能需要配置文件来进行限制，请作为 <systemitem class="username">root</systemitem> 运行 <command>aa-unconfined</command>。
  </para>

  <example xml:id="ex-unconfined">
   <title>aa-unconfined<command> 的输出</command></title>
<screen>19848 /usr/sbin/cupsd not confined
19887 /usr/sbin/sshd not confined
19947 /usr/lib/postfix/master not confined
1328 /usr/sbin/smbd confined by '/usr/sbin/smbd (enforce)'</screen>
  </example>

  <para>
   上例中标注为 <literal>not confined</literal> 的每个进程都可能需要定制的配置文件来进行限制。标有 <literal>confined by</literal> 的进程已受 <phrase>AppArmor</phrase> 保护。
  </para>

  <tip>
   <title>更多信息</title>
   <para>
    有关如何选择要构建配置文件的正确应用程序的详细信息，请参见<xref linkend="sec-apparmor-concept-determine"/>。
   </para>
  </tip>
 </sect1>
 <sect1 xml:id="sec-apparmor-start-build">
  <title>构建和修改配置文件</title>

  <para>
   <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 上的 <phrase>AppArmor</phrase> 随附了预配置的配置文件集，用于最重要的应用程序。此外，您也可使用 <phrase>AppArmor</phrase> 来为所需的任何应用程序创建您自己的配置文件。
  </para>

  <para>
   管理配置文件有两种方式。一种是使用 YaST <phrase>AppArmor</phrase> 模块提供的图形前端，另一种是使用 <phrase>AppArmor</phrase> 套件自身提供的命令行工具。主要差别是，YaST 仅支持 <phrase>AppArmor</phrase> 配置文件的基本功能，而命令行工具可让您以更细微的方式更新/调整配置文件。
  </para>

  <para>
   对每个应用程序执行以下步骤以创建配置文件：
  </para>

  <procedure xml:id="proc-genprof">
   <step xml:id="st-genprof1">
    <para>
     以 <systemitem class="username">root</systemitem> 身份运行 <command>aa-genprof</command>
     <replaceable>PROGRAM_NAME</replaceable>，让 <phrase>AppArmor</phrase> 创建应用程序配置文件的大致轮廓。
    </para>
    <para>
     <emphasis>或</emphasis>
    </para>
    <para>

     通过运行 <menuchoice>
     <guimenu>YaST</guimenu> <guimenu>安全和用户</guimenu>
     <guimenu><phrase>AppArmor</phrase> 配置</guimenu> <guimenu>手动添加配置文件</guimenu> </menuchoice>并指定要构建配置文件的应用程序的完整路径，来创建基本配置文件的轮廓。
    </para>
    <para>
     系统会创建新的基本配置文件的轮廓并将其置于学习模式，这意味着，它会记录您正在执行的程序的每个活动，但目前还不会对程序进行限制。
    </para>
   </step>
   <step xml:id="st-genprof2">
    <para>
     运行应用程序的所有操作，让 <phrase>AppArmor</phrase> 完全了解程序的每个活动。
    </para>
   </step>
   <step xml:id="st-genprof3">
    <para>
     在 aa-genprof 中键入 <keycap>S</keycap>，以便让 <phrase>AppArmor</phrase> 分析在<xref linkend="st-genprof2"/> 中生成的日志文件。
    </para>
    <para>
     <phrase>AppArmor 扫描在程序运行期间记录的日志，然后请求您为每个记录的事件设置访问权限。</phrase>请对每个文件进行设置或使用通配。
    </para>
   </step>
   <step>
    <para>
     依据应用程序的复杂性，可能必须重复<xref linkend="st-genprof2"/>和<xref linkend="st-genprof3"/>。限制应用程序，在限制条件下执行应用程序并处理任何新的日志事件。要准确限制应用程序功能的完整范围，您可能必须经常重复此过程。
    </para>
   </step>
   <step xml:id="st-genprof4">
    <para>
     完成 <command>aa-genprof</command> 后，您的配置文件即设置为强制模式。系统会应用该配置文件，而 <phrase>AppArmor</phrase> 将根据该配置文件限制应用程序。
    </para>
    <para>
     如果某应用程序的现有配置文件处于控诉模式，对此应用程序启动 <command>aa-genprof</command> 时，此配置文件在退出此学习周期后仍会处于学习模式。有关更改配置文件模式的更多信息，请参见<xref linkend="sec-apparmor-commandline-profiling-summary-complain"/>和<xref linkend="sec-apparmor-commandline-profiling-summary-enforce"/>。
    </para>
   </step>
  </procedure>

  <para>
   使用您限制的应用程序执行所需的每一项任务，以测试您的配置文件设置。正常情况下，受限制的应用程序会顺利运行，您完全不会察觉到 <phrase>AppArmor</phrase> 活动。但是，如果您注意到应用程序的某些行为异常，请检查系统日志以查看 <phrase>AppArmor</phrase> 对应用程序的限制是否过于严格。根据系统上所使用的日志机制，可从以下几个位置查找 <phrase>AppArmor</phrase> 日志项：
  </para>

  <simplelist>
   <member><filename>/var/log/audit/audit.log</filename>
   </member>
   <member>命令 <command>journalctl | grep -i apparmor</command>
   </member>
   <member>命令 <command>dmesg -T</command>
   </member>
  </simplelist>

  <para>
   要调整配置文件，可按<xref linkend="sec-apparmor-commandline-profiling-summary-logprof"/>所述再次分析与此应用程序相关的日志消息。发出提示时，请确定访问权限或限制。
  </para>

  <tip>
   <title>更多信息</title>
   <para>
    有关配置文件构建和修改的更多信息，请参见<xref linkend="cha-apparmor-profiles"/>、<xref linkend="cha-apparmor-yast"/>和<xref linkend="cha-apparmor-commandline"/>。
   </para>
  </tip>
 </sect1>
 <sect1 xml:id="sec-apparmor-start-update">
  <title>更新您的配置文件</title>

  <para>
   软件和系统配置会随着时间的流逝而更改。因此，可能需要不定期对 <phrase>AppArmor</phrase> 的配置文件设置进行一定的微调。<phrase>AppArmor 会检查系统日志以查找策略违例或其他 AppArmor 事件，并使您能够相应地调整配置文件。</phrase><phrase></phrase>不在任何配置文件定义范围内的任何应用程序行为均可通过 <command>aa-logprof</command> 解决。有关更多信息，请参见<xref linkend="sec-apparmor-commandline-profiling-summary-logprof"/>。
  </para>
 </sect1>
</chapter>
