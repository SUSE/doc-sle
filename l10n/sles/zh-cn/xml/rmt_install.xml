<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="rmt_install.xml" version="5.0" xml:id="cha-rmt-installation">
 <title>RMT 安装和配置</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:translation>yes</dm:translation>
      </dm:docmanager>
    </info>
    <para>
  SUSE Linux Enterprise Server 15 及以上版本中包含 RMT。可以在安装 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 的过程中直接安装 RMT，或在运行中系统上安装 RMT。安装好软件包后，请使用 YaST 执行初始配置。
 </para>
 <warning>
  <title>RMT 服务器将会与安装服务器发生冲突</title>
  <para>
   将一台服务器配置为 RMT 服务器时，会安装并配置监听端口为 80 的 NGINX Web 服务器。
  </para>
  <para>
   而在将一台计算机配置为安装服务器时，会自动安装 Apache Web 服务器并将其配置为监听端口 80。
  </para>
  <para>
   请勿尝试在同一台服务器上启用这两项功能。一台服务器无法同时托管 Apache Web 服务器和 NGINX Web 服务器。
  </para>
 </warning>
 <sect1 xml:id="sec-rmt-storage-requirements">
  <title>储存要求</title>

  <para>
   下载的软件包储存在 <filename>/usr/share/rmt/public/repo</filename> 中，其为 <filename>/var/lib/rmt/public/repo/</filename> 的符号链接。
  </para>

  <para>
   RMT 服务器所需的储存空间取决于以下可变因素：您镜像的储存库和体系结构的数量以及启用的产品数量。一般来说，将储存空间设为所有已启用储存库总大小的 1.5 倍应当就已足够。其中，每个 SUSE Linux Enterprise 版本（包括所有扩展）大约 200 GB。
  </para>
 </sect1>
 <sect1 xml:id="sec-rmt-installation-yast">
  <title>在系统安装期间安装</title>

  <para>
   要在系统安装期间安装 RMT，请选择 <package>rmt-server</package>
   软件包。您可在安装期间的<emphasis>安装设置</emphasis>步骤中进行<emphasis>软件</emphasis>选择时选择该软件包。
  </para>

  <figure>
   <title>RMT 模式</title>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="rmt_installation.png" width="70%" format="PNG"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="rmt_installation.png" width="70%" format="PNG"/>
    </imageobject>
   </mediaobject>
  </figure>

  <para>
   我们建议您在使用 <command>zypper patch</command> 命令安装 SUSE Linux Enterprise Server 后，立即检查是否有可用的 RMT 更新。SUSE 会不断发布 RMT 的维护更新，因此可能会有更新的软件包。
  </para>
 </sect1>
 <sect1 xml:id="sec-rmt-installation-zypper">
  <title>在现有系统上安装</title>

  <para>
   要在运行中的 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 系统上安装 RMT，请使用 <command>zypper</command>：
  </para>

<screen><prompt>tux &gt; </prompt><command>sudo</command> <command>zypper in rmt-server</command></screen>
 </sect1>
 <sect1 xml:id="sec-rmt-installation-yast-configuration">
  <title>使用 YaST 配置 RMT</title>

  <para>
   按以下过程所述使用 YaST 配置 RMT。假设在新安装的系统上执行此过程。
  </para>

  <procedure>
   <step>
    <para>
     使用 <literal>rmt</literal> 模块启动 YaST。
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> <command>yast2 rmt</command></screen>
    <para>
     或者，您也可以启动 YaST，然后选择<menuchoice> <guimenu>网络服务</guimenu> <guimenu>RMT 配置</guimenu> </menuchoice>。
    </para>
   </step>
   <step>
    <para>
     输入您的组织身份凭证。要获取您的身份凭证，请参见<xref linkend="sec-rmt-mirroring-credentials"/>。
    </para>
   </step>
   <step>
    <para>
     输入新 MariaDB 用户和数据库名称的身份凭证。系统即会创建此用户。然后选择<guimenu>下一步</guimenu>。
    </para>
    <para>
     如果已设置 MariaDB <literal>root</literal> 用户的口令，您需要输入该口令。如果未设置 <literal>root</literal> 的口令，系统会要求您输入一个新口令。
    </para>
   </step>
   <step>
    <para>
     输入 SSL 证书的常用名。该常用名通常应为服务器的<emphasis>完全限定域名</emphasis> (<emphasis>FQDN</emphasis>)。输入您要用来作为其他常用名连接 RMT 服务器的所有域名和 IP 地址。
    </para>
    <para>
     输入所有常用名后，选择<guimenu>下一步</guimenu>。
    </para>
    <tip>
     <title>RMT 的证书位置</title>

     <itemizedlist>
      <listitem>
       <para>
        <filename>/etc/rmt/ssl/rmt-ca.crt</filename>
       </para>
       <para>
        此为 <command>yast2 rmt</command> 用来验证 RMT 服务器证书的 CA 证书束。仅当此文件不存在时，<command>yast2 rmt</command> 才会创建该文件。
       </para>
      </listitem>
      <listitem>
       <para>
        <filename>/etc/rmt/ssl/rmt-server.crt</filename> 和 <filename>/etc/rmt/ssl/rmt-server.key</filename>
       </para>
       <para>
        仅当服务器证书和私用密钥不存在时，<command>yast2 rmt</command> 才会生成新的服务器证书和私用密钥。要重新生成此证书，请参见<xref linkend="cha-manage-certificates-https"/>。
       </para>
      </listitem>
     </itemizedlist>
    </tip>
   </step>
   <step>
    <para>
     如果此系统上启用了 <systemitem class="daemon">firewalld</systemitem>，请选中相应复选框打开必需的端口。
    </para>
    <figure>
     <title>在 <systemitem class="daemon">firewalld</systemitem> 中启用端口</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="rmt_firewalld.png" width="60%"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="rmt_firewalld.png" width="65%"/>
      </imageobject>
     </mediaobject>
    </figure>
    <para>
     如果现在尚未启用 <systemitem class="daemon">firewalld</systemitem> 而您打算稍后启用它，可始终通过运行 <command>yast2 rmt</command> 模块来打开相应端口。
    </para>
    <tip>
     <title>微调 <systemitem class="daemon">firewalld</systemitem> 设置</title>
     <para>
      单击<guimenu>防火墙细节</guimenu>，可仅打开特定网络接口的相应端口。
     </para>
    </tip>
    <para>
     按<guimenu>下一步</guimenu>继续。
    </para>
   </step>
   <step>
    <para>
     要查看摘要，请单击<guimenu>下一步</guimenu>。单击<guimenu>完成</guimenu>关闭 YaST。YaST 即会启用并启动所有 <systemitem class="daemon">systemd</systemitem> 服务和计时器。
    </para>
   </step>
  </procedure>
  </sect1>
  <sect1>
  <title>启用 SLP 声明</title>

  <para>
   RMT 包含 SLP 服务说明文件 <filename>/etc/slp.reg.d/rmt-server.reg</filename>。要启用 RMT 服务的 SLP 声明，请执行以下步骤：
  </para>
  <procedure>
   <step>
    <para>
     如果 <systemitem class="daemon">firewalld</systemitem> 正在运行，请打开相应端口并重新装载 <systemitem class="daemon">firewalld</systemitem> 配置：
    </para>
<screen>
<prompt>tux &gt; </prompt><command>sudo</command> firewall-cmd --permanent --add-port=427/tcp
success
<prompt>tux &gt; </prompt><command>sudo</command> firewall-cmd --permanent --add-port=427/udp
success
<prompt>tux &gt; </prompt><command>sudo</command> firewall-cmd --reload
</screen>
   </step>
   <step>
    <para>
     校验是否安装了 SLP 服务器，如果可能，安装该服务器：
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> zypper install openslp-server</screen>
   </step>
   <step>
    <para>
     启用并启动 SLP 服务：
    </para>
<screen>
<prompt>tux &gt; </prompt><command>sudo</command> systemctl enable slpd.service
<prompt>tux &gt; </prompt><command>sudo</command> systemctl restart slpd.service
</screen>
   </step>
  </procedure>

 </sect1>
</chapter>
