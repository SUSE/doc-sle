<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="security_policy_kit.xml" version="5.0" xml:id="cha-security-policykit">
 <title>使用 PolKit 进行授权</title>
 <info>
      <abstract>
        <para>
    PolKit（以前称为 PolicyKit）是一个应用程序框架，充当非特权用户会话与特权系统环境之间的协商者。每当用户会话中的某个进程尝试在系统环境中执行操作时，系统就会查询 PolKit。根据配置（在所谓的<quote>策略</quote>中指定）的不同，回答可能为<quote>是</quote>、<quote>否</quote>或<quote>需要身份验证</quote>。与 sudo 等传统的特权授权程序不同，PolKit 不会向整个会话授予 <systemitem class="username">root</systemitem> 权限，而只向相关的操作授予该权限。
   </para>
      </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:bugtracker>
        </dm:bugtracker>
	<dm:translation>yes</dm:translation>
      </dm:docmanager>
    </info>
    <sect1 xml:id="sec-security-policykit-oview">
  <title>概念概述</title>

  <para>

   PolKit 会按用户、组或名称限制特定的操作。然后，它会定义允许这些用户如何执行此操作。
  </para>

  <sect2 xml:id="sec-security-policykit-agents">
   <title>可用的身份验证代理</title>
   <para>
    当用户使用图形环境或通过控制台启动会话时，每个会话由<emphasis>授权</emphasis>和<emphasis>身份验证代理</emphasis>构成。授权以系统消息总线上的一个服务的形式来实现，而身份验证代理用于对启动会话的用户进行身份验证。当前用户需要证明其真实性（例如，使用通行口令）。
   </para>
   <para>
    每个桌面环境都有自己的身份验证代理。通常，无论您选择哪个环境，都会自动启动该代理。
   </para>

  </sect2>

  <sect2 xml:id="sec-security-policykit-structure">
   <title>PolKit 的结构</title>
   <para>
    PolKit 的配置取决于<emphasis>操作</emphasis>和<emphasis>授权规则</emphasis>：
   </para>
   <variablelist>
    <varlistentry>
     <term>操作（文件扩展名 <filename>*.policy</filename>）</term>
     <listitem>
      <para>
       以 XML 文件形式编写，位于 <filename>/usr/share/polkit-1/actions</filename> 中。每个文件定义一个或多个操作，每个操作都包含说明和默认权限。尽管系统管理员可以编写自己的规则，但 PolKit 的文件不可编辑。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>授权规则（文件扩展名 <filename>*.rules</filename>）</term>
     <listitem>
      <para>
       以 JavaScript 文件形式编写，位于以下两个位置：<filename>/usr/share/polkit-1/rules.d </filename>（用于第三方软件包）和 <filename>/etc/polkit-1/rules.d</filename>（用于本地配置）。每个规则文件都会引用操作文件中指定的操作。规则确定允许对用户子集实施哪些限制。例如，某个规则文件可能会否决某个限制性权限，并且允许某些用户允许该权限。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec-security-policykit-oview-commands">
   <title>可用的命令</title>
   <para>
    PolKit 包含若干用于特定任务的命令（有关更多细节，另请参见特定的手册页）：
   </para>
   <variablelist>
    <varlistentry>
     <term><command>pkaction</command>
     </term>
     <listitem>
      <para>
       获取有关所定义操作的细节。有关更多信息，请参见<xref linkend="sec-security-policykit-query"/>。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>pkcheck</command>
     </term>
     <listitem>
      <para>
       检查 <option>--process</option> 或 <option>--system-bus-name</option> 所指定的进程是否获得授权。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>pkexec</command>
     </term>
     <listitem>
      <para>
       允许获得授权的用户以另一用户的身份执行特定程序。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>pkttyagent</command>
     </term>
     <listitem>
      <para>
       启动文本身份验证代理。如果桌面环境没有自己的身份验证代理，将使用此代理。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec-security-policykit-oview-authorizations">
   <title>可用的策略和支持的应用程序</title>
   <para>
    目前，并非所有需要特权的应用程序都使用 PolKit。下面列出了 <phrase role="productname"><phrase os="sles">SUSE® Linux Enterprise Server</phrase></phrase> 上提供的最重要的策略，这些策略按其使用场合类别排序。
   </para>
   <variablelist>
    <varlistentry>
     <term>PulseAudio</term>
     <listitem>
      <simplelist>
       <member>设置 PulseAudio 守护程序的调度优先级</member>
      </simplelist>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>CUPS</term>
     <listitem>
      <simplelist>
       <member>添加、去除、编辑、启用或禁用打印机</member>
      </simplelist>
     </listitem>
    </varlistentry>
    
    <varlistentry>
     <term>GNOME</term>
     <listitem>
      <simplelist>
       <member>使用 GConf 修改系统和必需的值</member>
       <member>更改系统时间</member>
      </simplelist>
     </listitem>
    </varlistentry>
    <varlistentry os="sles;osuse">
     <term>libvirt</term>
     <listitem>
      <simplelist>
       <member>管理和监视本地虚拟化系统</member>
      </simplelist>
     </listitem>
    </varlistentry>
    
    <varlistentry>
     <term>PolKit</term>
     <listitem>
      <simplelist>
       <member>读取和更改其他用户的特权</member>
       <member>修改默认值</member>
      </simplelist>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>PackageKit</term>
     <listitem>
      <simplelist>
       <member>更新和去除软件包</member>
       <member>更改和刷新储存库</member>
       <member>安装本地文件</member>
       <member>回滚</member>
       <member>导入储存库密钥</member>
       <member>接受 EULA</member>
       <member>设置网络代理</member>
      </simplelist>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>系统</term>
     <listitem>
      <simplelist>
       <member>网络唤醒</member>
       <member>挂载或卸载固定、可热插拔和加密的设备</member>
       <member>弹出和解密可移动媒体</member>
       <member>启用或禁用 WLAN</member>
       <member>启用或禁用蓝牙</member>
       <member>设备访问</member>
       <member>停止、挂起、休眠和重启动系统</member>
       <member>移除扩展坞</member>
       <member>更改电源管理设置</member>
      </simplelist>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>YaST</term>
     <listitem>
      <simplelist>
       <member>注册产品</member>
       <member>更改系统时间和语言</member>
      </simplelist>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-security-policykit-types">
  <title>授权类型</title>

  <para>
   每当支持 PolKit 的进程执行特权操作时，系统都会询问 PolKit 此进程是否有权这样做。PolKit 根据针对此进程定义的策略做出回答。回答可能为<literal>是</literal>、<literal>否</literal>或<literal>需要身份验证</literal>。默认情况下，策略包含自动应用于所有用户的<literal>隐式</literal>特权。您也可以指定应用于特定用户的<literal>显式</literal>特权。
  </para>

  <sect2 xml:id="sec-security-policykit-policies-implicit">
   <title>隐式特权</title>
   <para>
    可以针对任何活动和非活动的会话定义隐式特权。活动会话是您当前正在使用的会话，例如，当您切换到另一个控制台后，它就会变成非活动会话。如果将隐式特权设置为<quote>否</quote>，则不会为任何用户授权；设置为<quote>是</quote>则会为所有用户授权。不过，隐式特权通常用于请求身份验证。
   </para>
   <para>
    用户可以通过以 <systemitem class="username">root</systemitem> 身份或者以本身的身份进行身份验证来授权。这两种身份验证方法存在四种变体：
   </para>
   <variablelist>
    <varlistentry>
     <term>身份验证</term>
     <listitem>
      <para>
       用户始终需要进行身份验证。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>一次性身份验证</term>
     <listitem>
      <para>
       身份验证绑定到当前运行的程序实例。重启动该程序后，用户需要再次进行身份验证。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>保留会话身份验证</term>
     <listitem>
      <para>
       身份验证对话框会提供一个勾选按钮<guimenu>记住此会话的授权</guimenu>。如果选中此项，身份验证将一直有效，直至用户注销。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>无限期保留身份验证</term>
     <listitem>
      <para>
       身份验证对话框会提供一个勾选按钮<guimenu>记住授权</guimenu>。如果选中此项，用户只需进行一次身份验证。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec-security-policykit-policies-explicit">
   <title>显式特权</title>
   <para>
    显式特权可向特定用户授予。可以不受限制地授予特权，或者，在使用约束时，将特权限制为仅对活动会话和/或本地控制台有效。
   </para>
   <para>
    不仅可以向用户授予特权，而且还可以阻止用户。阻止的用户无法执行需要授权的操作，即使默认的隐式策略允许通过身份验证授权也不例外。
   </para>
  </sect2>

  <sect2 xml:id="sec-security-policykit-policies-default">
   <title>默认特权</title>
   <para>
    支持 PolKit 的每个应用程序都随附了由应用程序开发人员定义的一组默认隐式策略。这些策略就是所谓的<quote>上游默认设置</quote>。上游默认设置定义的特权不一定是在 SUSE 系统上默认激活的特权。<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 随附了一组可以覆盖上游默认设置的预定义特权：
   </para>
   <variablelist>
    <varlistentry>
     <term><filename>/etc/polkit-default-privs.standard</filename>
     </term>
     <listitem>
      <para>
       定义适合大多数桌面系统的特权
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><filename>/etc/polkit-default-privs.restrictive</filename>
     </term>
     <listitem>
      <para>
       设计用于集中管理的计算机<phrase os="sles">。默认处于活动状态。</phrase>
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <para>
    要在两组默认特权之间切换，请在 <filename>/etc/sysconfig/security</filename> 中将 <varname>POLKIT_DEFAULT_PRIVS</varname> 的值调整为 <literal>restrictive</literal> 或 <literal>standard</literal>。然后以 <systemitem class="username">root</systemitem> 身份运行 <command>set_polkit_default_privs</command> 命令。
   </para>
   <para>
    请勿修改上述列表中的两个文件。要定义您自己的自定义特权集，请使用 <filename>/etc/polkit-default-privs.local</filename>。有关详细信息，请参考 <xref linkend="sec-security-policykit-change-modify-config-implicit"/>。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-security-policykit-query">
  <title>查询特权</title>

  <para>
   要查询特权，请使用 PolKit 中包含的 <command>pkaction</command> 命令。
  </para>

  <para>
   PolKit 随附了用于更改特权以及以另一用户身份执行命令的命令行工具（有关简要概述，请参见<xref linkend="sec-security-policykit-oview-commands"/>）。每个现有策略都有一个自述性的唯一名称用于标识自身。使用 <command>pkaction</command> 命令可列出所有可用策略。有关详细信息，请参见 <command>man pkaction</command>。
  </para>

  <para>
   如果您要显示给定策略（例如 <literal>org.freedesktop.login1.reboot</literal>）所需的授权，请按如下方式使用 <command>pkaction</command>：
  </para>

<screen><prompt>&gt; </prompt>pkaction -v --action-id=org.freedesktop.login1.reboot
org.freedesktop.login1.reboot:
  description:       Reboot the system
  message:           Authentication is required to allow rebooting the system
  vendor:            The systemd Project
  vendor_url:        http://www.freedesktop.org/wiki/Software/systemd
  icon:
  implicit any:      auth_admin_keep
  implicit inactive: auth_admin_keep
  implicit active:   yes</screen>

  <para>
   关键字 <literal>auth_admin_keep</literal> 表示用户需要输入通行口令。
  </para>

  <note>
   <title><phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 上使用的 <command>pkaction</command> 限制</title>
   <para>
    <command>pkaction</command> 始终针对上游默认设置运行。因此，无法使用它来列出或恢复 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 随附的默认设置。要执行此操作，请参见<xref linkend="sec-security-policykit-change-defaults"/>。
   </para>
  </note>
 </sect1>
 <sect1 xml:id="sec-security-policykit-change-modify-config">
  <title>修改配置文件</title>

  <para>
   当您想要在不同的计算机上部署相同的策略集（例如，部署到特定团队的计算机）时，可以采用通过修改配置文件来调整特权的做法。您可以通过修改配置文件来更改隐式和显式特权。
  </para>

  <sect2 xml:id="sec-security-policykit-change-modify-config-actions">
   <title>添加操作规则</title>
   <para>
    可用的操作取决于您在系统上安装了哪些附加软件包。如需简要概述，请使用 <command>pkaction</command> 列出定义的所有规则。
   </para>
   <para>
    如要了解如何将 <command>gparted</command> 命令（<quote>GNOME 分区编辑器</quote>）集成到 PolKit 中，请参见下面的示例。
   </para>
   <para>
    文件 <filename>/usr/share/polkit-1/actions/org.opensuse.policykit.gparted.policy</filename> 包含以下内容：
   </para>
<screen>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE policyconfig PUBLIC
 "-//freedesktop//DTD PolicyKit Policy Configuration 1.0//EN"
 "http://www.freedesktop.org/standards/PolicyKit/1.0/policyconfig.dtd"&gt;
&lt;policyconfig&gt; <co xml:id="co-polkit-actions-policyconfig"/>

  &lt;action id="org-opensuse-policykit-gparted"&gt; <co xml:id="co-polkit-actions-action"/>
    &lt;message&gt;Authentication is required to run the GParted Partition Editor&lt;/message&gt;
    &lt;icon_name&gt;gparted&lt;/icon_name&gt;
    &lt;defaults&gt; <co xml:id="co-polkit-actions-defaults"/>
      &lt;allow_any&gt;auth_admin&lt;/allow_any&gt;
      &lt;allow_inactive&gt;auth_admin&lt;/allow_inactive&gt;
     &lt; allow_active&gt;auth_admin&lt;/allow_active&gt;
    &lt;/defaults&gt;
    &lt;annotate <co xml:id="co-polkit-actions-annotate"/>
      key="org.freedesktop.policykit.exec.path"&gt;/usr/sbin/gparted&lt;/annotate&gt;
    &lt;annotate <xref linkend="co-polkit-actions-annotate"/>
      key="org.freedesktop.policykit.exec.allow_gui"&gt;true&lt;/annotate&gt;
  &lt;/action&gt;

&lt;/policyconfig&gt;</screen>
   <calloutlist>
    <callout arearefs="co-polkit-actions-policyconfig">
     <para>
      策略文件的根元素。
     </para>
    </callout>
    <callout arearefs="co-polkit-actions-action">
     <para>
      仅包含一个操作。
     </para>
    </callout>
    <callout arearefs="co-polkit-actions-defaults">
     <para>
      <literal>defaults</literal> 元素包含多个权限，这些权限在 SSH、VNC 等远程会话中使用（<literal>allow_inactive</literal> 元素）、在通过 TTY 或 X 显示器直接登录到计算机时使用（<literal>allow_active</literal> 元素），或者在这两种情况下均可使用（<literal>allow_any</literal> 元素）。值 <literal>auth_admin</literal> 指示需要以管理用户的身份进行身份验证。
     </para>
    </callout>
    <callout arearefs="co-polkit-actions-annotate">
     <para>
      <literal>annotate</literal> 元素包含有关 PolKit 如何执行操作的具体信息。在本例中，它包含可执行文件的路径，并指出是否允许 GUI 打开 X 显示器。
     </para>
    </callout>
   </calloutlist>
   <para>
    要添加您自己的策略，请创建采用上述结构的 <filename>.policy</filename> 文件，将适当的值添加到 <literal>id</literal> 属性，并定义默认权限。
   </para>
  </sect2>

  <sect2 xml:id="sec-security-policykit-change-modify-config-authrules">
   <title>添加授权规则</title>
   <para>
    您自己的授权规则会否决默认设置。要添加您自己的设置，请将您的文件储存在 <filename>/etc/polkit-1/rules.d/</filename> 下。
   </para>
   <para>
    此目录中的文件名以两位数开头，后接一个描述性名称，以 <filename>.rules</filename> 结尾。这些文件中的函数按其排序顺序执行。例如，<filename>00-foo.rules</filename> 排在 <filename>60-bar.rules</filename> 甚至 <filename>90-default-privs.rules</filename> 的前面（因而也会在它们的前面执行）。
   </para>
   <para>
    在文件中，脚本会检查 <filename>.policy</filename> 文件中定义的指定操作 ID。例如，如果您要允许 <systemitem class="groupname">admin</systemitem> 组的任何成员执行 <command>gparted</command> 命令，请检查操作 ID <literal>org.opensuse.policykit.gparted</literal>：
   </para>
<screen>/* Allow users in admin group to run GParted without authentication */
polkit.addRule(function(action, subject) {
    if (action.id == "org.opensuse.policykit.gparted" &amp;&amp;
        subject.isInGroup("admin")) {
        return polkit.Result.YES;
    }
});</screen>
   <para>
    <link xlink:href="http://www.freedesktop.org/software/polkit/docs/latest/ref-api.html"/> 上提供了 PolKit API 中各函数的所有类和方法的说明。
   </para>
  </sect2>

  <sect2 xml:id="sec-security-policykit-change-modify-config-implicit">
   <title>修改隐式特权的配置文件</title>
   <para>
    <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 随附了两组默认授权，分别位于 <filename>/etc/polkit-default-privs.standard</filename> 和 <filename>/etc/polkit-default-privs.restrictive</filename> 中。有关更多信息，请参考<xref linkend="sec-security-policykit-policies-default"/>。
   </para>
   <para>
    自定义特权在 <filename>/etc/polkit-default-privs.local</filename> 中定义。此处定义的特权始终优先于其他配置文件中定义的特权。要定义您的自定义特权集，请执行以下操作：
   </para>
   <procedure>
    <step>
     <para>
      打开 <filename>/etc/polkit-default-privs.local</filename>。要定义特权，请使用以下格式为每个策略添加一行：
     </para>
<screen><replaceable>&lt;privilege_identifier&gt;</replaceable>     <replaceable>&lt;any session&gt;</replaceable>:<replaceable>&lt;inactive session&gt;</replaceable>:<replaceable>&lt;active session&gt;</replaceable></screen>
     <para>
      例如：
     </para>
<screen>org.freedesktop.policykit.modify-defaults     auth_admin_keep_always</screen>
     <para>
      下面是对 <replaceable>SESSION</replaceable> 占位符有效的值：
     </para>
     <variablelist>
      <varlistentry>
       <term><literal>yes</literal>
       </term>
       <listitem>
        <para>
         授予特权
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term><literal>no</literal>
       </term>
       <listitem>
        <para>
         拦截
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term><literal>auth_self</literal>
       </term>
       <listitem>
        <para>
         用户每次请求特权时都需要使用自己的口令进行身份验证
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term><literal>auth_self_keep_session</literal>
       </term>
       <listitem>
        <para>
         用户需要为每个会话使用自己的口令进行一次身份验证，会向其授予对整个会话的特权
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term><literal>auth_self_keep_always</literal>
       </term>
       <listitem>
        <para>
         用户需要使用自己的口令进行一次身份验证，会向其授予对当前及将来的会话的特权
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term><literal>auth_admin</literal>
       </term>
       <listitem>
        <para>
         用户每次请求特权时都需要使用 <systemitem class="username">root</systemitem> 的口令进行身份验证
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term><literal>auth_admin_keep_session</literal>
       </term>
       <listitem>
        <para>
         用户需要为每个会话使用 <systemitem class="username">root</systemitem> 的口令进行一次身份验证，会向其授予对整个会话的特权
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term><literal>auth_admin_keep_always</literal>
       </term>
       <listitem>
        <para>
         用户需要使用 <systemitem class="username">root</systemitem> 的口令进行一次身份验证，会向其授予对当前及将来的会话的特权
        </para>
       </listitem>
      </varlistentry>
     </variablelist>
    </step>
    <step>
     <para>
      以 <systemitem class="username">root</systemitem> 身份运行，以使更改生效：
     </para>
<screen># /sbin/set_polkit_default_privs</screen>
    </step>
    <step>
     <para>
      （可选）使用 <command>pkaction</command> 命令检查所有特权标识符的列表。
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-security-policykit-change-defaults">
  <title>恢复默认特权</title>

  <para>
   <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 随附了一组默认已激活因而会覆盖上游默认设置的预定义特权。有关详细信息，请参考 <xref linkend="sec-security-policykit-policies-default"/>。
  </para>

  <para>
   由于 PolKit 图形工具和命令行工具始终针对上游默认设置运行，<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 另外提供了命令行工具 <command>set_polkit_default_privs</command>。此工具可将特权重设置为 <filename>/etc/polkit-default-privs.*</filename> 中定义的值，但 <command>set_polkit_default_privs</command> 只会重设置已设为上游默认设置的策略。
  </para>

  <procedure>
   <title>恢复 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 默认设置</title>
   <step>
    <para>
     确保 <filename>/etc/polkit-default-privs.local</filename> 不包含默认策略的任何覆盖操作。
    </para>
    <important>
     <title>自定义策略配置</title>
     <para>
      在执行下一步骤期间，将在默认设置的最前面应用 <filename>/etc/polkit-default-privs.local</filename> 中定义的策略。
     </para>
    </important>
   </step>
   <step>
    <para>
     要先将所有策略重设置为上游默认设置，然后再应用 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 默认设置，请执行以下命令：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> rm -f /var/lib/polkit/* &amp;&amp; set_polkit_default_privs</screen>
   </step>
  </procedure>
 </sect1>
</chapter>
