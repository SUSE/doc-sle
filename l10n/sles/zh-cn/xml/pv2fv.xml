<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="pv2fv.xml" version="5.0" xml:id="pv-to-fv">
  <info>
    <title>Xen：将半虚拟 (PV) Guest 转换为全虚拟 (FV/HVM) Guest</title>
    <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
      <dm:translation>yes</dm:translation>
    </dm:docmanager>
  </info>
  <para>
    本章介绍如何将 Xen 半虚拟机转换为 Xen 全虚拟机。
  </para>
  <procedure>
    <title>Guest 端</title>
    <para>
      要在 FV 模式下启动 Guest，需要在 Guest 中执行以下步骤。
    </para>
    <step>
      <para>
        在转换 Guest 之前，安装所有待应用的补丁并重引导 Guest。
      </para>
    </step>
    <step>
      <para>
        FV 计算机使用 <literal>-default</literal> 内核。如果尚未安装此内核，请安装 <literal>kernel-default</literal> 软件包（在 PV 模式下运行时）。
      </para>
    </step>
    <step>
      <para>
        PV 计算机通常使用 <literal>vda*</literal> 这样的磁盘名称。这些名称必须更改为 FV <literal>hd*</literal> 语法。此更改必须在以下文件中进行：
      </para>
      <itemizedlist>
        <listitem>
          <para>
            <filename>/etc/fstab</filename>
          </para>
        </listitem>
        <listitem>
          <para>
            <filename>/boot/grub/menu.lst</filename>（仅适用于 SLES 11）
          </para>
        </listitem>
        <listitem>
          <para>
            <filename>/boot/grub*/device.map</filename>
          </para>
        </listitem>
        <listitem>
          <para>
            <filename>/etc/sysconfig/bootloader</filename>
          </para>
        </listitem>
        <listitem>
          <para>
            <filename>/etc/default/grub</filename>（仅适用于 SLES 12 和 15）
          </para>
        </listitem>
      </itemizedlist>
      <note>
        <title>建议使用 UUID</title>
        <para>
          应在 <filename>/etc/fstab</filename> 中使用 UUID 或逻辑卷。通过 UUID 可以方便地使用挂接的网络存储设备、多路径和虚拟化。要确定磁盘的 UUID，请使用 <command>blkid</command> 命令。
        </para>
      </note>
    </step>
    <step>
      <para>
        为了避免在使用所需模块重新生成 <filename>initrd</filename> 时出现任何错误，可以使用 <command>ln</command> 创建一个从 <filename>/dev/hda2</filename> 到 <filename>/dev/xvda2</filename> 等的符号链接：
      </para>
<screen>ln -sf /dev/xvda2 /dev/hda2
ln -sf /dev/xvda1 /dev/hda1
.....</screen>
    </step>
    <step>
      <para>
        PV 和 FV 计算机使用不同的磁盘和网络驱动程序模块。必须手动将这些 PV 模块添加到 initrd。预期的模块是 <literal>xen-vbd</literal>（用于磁盘）和 <literal>xen-vnif</literal>（用于网络）。这些是全虚拟化 VM Guest 仅有的 PV 驱动程序。所有其他模块（例如 <literal>ata_piix</literal>、<literal>ata_generic</literal> 和 <literal>libata</literal>）应会自动添加。
      </para>
      <tip>
        <title>将模块添加到 initrd</title>
        <itemizedlist>
          <listitem>
            <para>
              在 SLES 11 上，可以将模块添加到 <filename>/etc/sysconfig/kernel</filename> 文件中的 <literal>INITRD_MODULES</literal> 行。例如：
            </para>
<screen>INITRD_MODULES="xen-vbd xen-vnif"</screen>
            <para>
              运行 <command>dracut</command> 以构建包含这些模块的新 initrd。
            </para>
          </listitem>
          <listitem>
            <para>
              在 SLES 12 和 15 上，打开或创建 <filename>/etc/dracut.conf.d/10-virt.conf</filename>，并通过添加以下示例所示的行使用 <literal>force_drivers</literal> 来添加这些模块（注意前导空格）。
            </para>
<screen>force_drivers+=" xen-vbd xen-vnif"</screen>
            <para>
              运行 <command>dracut -f --kver
              <replaceable>KERNEL_VERSION</replaceable>-default</command> 以构建包含所需模块的新 initrd（用于内核的默认版本）。
            </para>
            <formalpara>
              <title>确定您的内核版本</title>
              <para>
                使用 <command>uname -r</command> 命令可获取系统上当前使用的版本。
              </para>
            </formalpara>
          </listitem>
        </itemizedlist>
      </tip>
    </step>
    <step>
      <para>
        在关闭 Guest 之前，使用 <command>yast
        bootloader</command> 将默认引导参数设置为 <literal>-default</literal> 内核。
      </para>
    </step>
    <step>
      <para>
        在 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 11 下，如果 Guest 上在运行 X 服务器，您需要调整 <filename>/etc/X11/xorg.conf</filename> 文件来调整 X 驱动程序。搜索 <literal>fbdev</literal> 并将其更改为 <literal>cirrus</literal>。
      </para>
<screen>Section "Device"
          Driver       "cirrus"
          ......
          EndSection</screen>
      <note>
        <title><phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 12/15 和 Xorg</title>
        <para>
          在 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 12/15 下，Xorg 将自动调整 X 服务器能够正常运行所需的驱动程序。
        </para>
      </note>
    </step>
    <step>
      <para>
        关闭 Guest。
      </para>
    </step>
  </procedure>
  <procedure>
    <title>主机端</title>
    <para>
      以下步骤说明了需要在主机上执行的操作。
    </para>
    <step>
      <para>
        要以 FV 模式启动 Guest，必须修改 VM 的配置以匹配 FV 配置。使用 <command>virsh edit [DOMAIN]</command> 可轻松编辑 VM 的配置。建议进行以下更改：
      </para>
      <itemizedlist>
        <listitem>
          <para>
            确保将 OS 部分中的 machine、type 和 <literal>loader</literal> 项从 <literal>xenpv</literal> 更改为 <literal>xenfv</literal>。更新后的 OS 部分应如下所示：
          </para>
<screen>&lt;os&gt;
          &lt;type arch='x86_64' machine='xenfv'&gt;hvm&lt;/type&gt;
          &lt;loader&gt;/usr/lib/xen/boot/hvmloader&lt;/loader&gt;
          &lt;boot dev='hd'/&gt;
&lt;/os&gt;</screen>
        </listitem>
        <listitem>
          <para>
            在 OS 部分，去除所有特定于 PV Guest 的内容：
          </para>
          <itemizedlist>
            <listitem>
<screen>&lt;bootloader&gt;pygrub&lt;/bootloader&gt;</screen>
            </listitem>
            <listitem>
<screen>&lt;kernel&gt;/usr/lib/grub2/x86_64-xen/grub.xen&lt;/kernel&gt;</screen>
            </listitem>
            <listitem>
<screen>&lt;cmdline&gt;xen-fbfront.video=4,1024,768&lt;/cmdline&gt;</screen>
            </listitem>
          </itemizedlist>
        </listitem>
        <listitem>
          <para>
            在 devices 部分，采用以下形式添加 qemu 模拟器：
          </para>
<screen>&lt;emulator&gt;/usr/lib/xen/bin/qemu-system-i386&lt;/emulator&gt;</screen>
        </listitem>
        <listitem>
          <para>
            更新磁盘配置，使目标设备和总线使用 FV 语法。这需要将 <literal>xen</literal> 磁盘总线替换为 <literal>ide</literal>，并将 <literal>vda</literal> 目标设备替换为 <literal>hda</literal>。更改应如下所示：
          </para>
<screen>&lt;target dev='hda' bus='ide'/&gt;</screen>
        </listitem>
        <listitem>
          <para>
            将鼠标和键盘的总线从 <literal>xen</literal> 更改为 <literal>ps2</literal>。另外添加一个新的 USB 绘图板设备：
          </para>
<screen>&lt;input type='mouse' bus='ps2'/&gt;
          &lt;input type='keyboard' bus='ps2'/&gt;
&lt;input type='tablet' bus='usb'/&gt;</screen>
        </listitem>
        <listitem>
          <para>
            将控制台目标类型从 <literal>xen</literal> 更改为 <literal>serial</literal>：
          </para>
<screen>&lt;console type='pty'&gt;
          &lt;target type='serial' port='0'/&gt;
&lt;/console&gt;</screen>
        </listitem>
        <listitem>
          <para>
            将视频配置从 <literal>xen</literal> 更改为 <literal>cirrus</literal>，其中 VRAM 大小为 8 MB：
          </para>
<screen>&lt;video&gt;
          &lt;model type='cirrus' vram='8192' heads='1' primary='yes'/&gt;
&lt;/video&gt;</screen>
        </listitem>
        <listitem>
          <para>
            如果需要，向 VM 的功能添加 <literal>acpi</literal> 和 <literal>apic</literal>：
          </para>
<screen>&lt;features&gt;
          &lt;acpi/&gt;
          &lt;apic/&gt;
&lt;/features&gt;</screen>
        </listitem>
      </itemizedlist>
    </step>
    <step>
      <para>
        启动 Guest（使用 <command>virsh</command> 或 <command>virt-manager</command>）。如果 Guest 运行的是 kernel-default（通过 <command>uname -a</command> 校验），计算机将以全虚拟模式运行。
      </para>
    </step>
  </procedure>
  <note>
    <title>guestfs-tools</title>
    <para>
      要编写此过程的脚本，或直接在磁盘映像上工作，可以使用 guestfs-tools 套件（有关详细信息，请参见<xref linkend="sec-guestfs-tools"/>）。有多种工具可以帮助修改磁盘映像。
    </para>
  </note>
</chapter>
