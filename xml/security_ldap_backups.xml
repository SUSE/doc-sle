<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1
[
  <!ENTITY % entities SYSTEM "entity-decl.ent">
    %entities;
]>

<sect1 xmlns="http://docbook.org/ns/docbook" 
  xmlns:xi="http://www.w3.org/2001/XInclude" 
  xmlns:xlink="http://www.w3.org/1999/xlink" 
  version="5.0" 
  xml:id="sec-security-ldap-backup">
  <title>Making Backups and Restores</title>
  <para>
    &ds389; supports making offline and online backups. The 
    <command>dsctl</command> command makes offline database backups, and the
    <command>dsconf</command> command makes online database backups. Back up 
    the LDAP server configuration directory, to enable complete restoration 
    in case of a major failure.
  </para>
  
  <sect2 xml:id="sec-security-ldap-backup-config">
    <title>Backing Up the Server Configuration</title>
      <para>
        Your LDAP server configuration is in 
        <filename>/etc/dirsrv/slapd-<replaceable>instance-name</replaceable></filename>. This contains certificates, keys, and the
        <filename>dse.ldif</filename> file. Make a compressed backup of this 
        directory with the <command>tar</command> command:
      </para>
      <screen>&prompt.sudo;tar caf config_slapd-<replaceable>ldap1</replaceable>_$(date +%Y-%m-%d_%H-%M-%S).tar.gz /etc/dirsrv/slapd-<replaceable>ldap1</replaceable>/
tar: Removing leading `/' from member names</screen>
      <para>
        To restore this configuration, move the existing configuration (if
        it exists), unpack the backup archive, and copy it to 
        <filename>/etc/dirsrv/slapd-<replaceable>instance-name</replaceable></filename>:
      </para>
      <screen>&prompt.sudo;mv /etc/dirsrv/slapd-<replaceable>ldap1/</replaceable> <replaceable>/etc/dirsrv/old/slapd-ldap1-old/</replaceable>
&prompt.sudo;tar -xvzf <replaceable>config_slapd-ldap1_2021-07-28_09-27.tar.gz</replaceable>
&prompt.sudo;cp -r <replaceable>etc/dirsrv/slapd-ldap1</replaceable> <replaceable>/etc/dirsrv/slapd-ldap1</replaceable></screen>
  </sect2>
  
  <sect2 xml:id="sec-security-ldap-offline-backup">
  <title>Offline Database Backup and Restore</title>
    <para>
    The <command>dsctl</command> command makes offline backups. Stop the 
    server, then make the backup using your instance name:
    </para>
    <screen>&prompt.sudo;dsctl <replaceable>ldap1</replaceable> stop
Instance <replaceable>"ldap1"</replaceable> has been stopped     
&prompt.sudo;dsctl <replaceable>ldap1</replaceable> db2bak
db2bak successful</screen>
    <para>
      This example creates a backup archive at 
      <filename>/var/lib/dirsrv/slapd-ldap1/bak/ldap1-2021_07_26_13_03_17</filename>.
    </para>
    <para>
      Restore from this backup, naming the directory containing the backup
      archive:
    </para>
    <screen>&prompt.sudo;dsctl <replaceable>ldap1</replaceable> bak2db <replaceable>/var/lib/dirsrv/slapd-ldap1/bak/ldap1-2021_07_26_13_03_17/</replaceable>
bak2db successful</screen>
    <para>
      Then start the server:
    </para>
    <screen>&prompt.sudo;dsctl <replaceable>ldap1</replaceable> start
Instance "<replaceable>ldap1</replaceable>" has been started</screen>
    <para>
      You may also create LDIF backups:
    </para>
      <screen>&prompt.sudo;dsctl ldap1 db2ldif  --replication userRoot
ldiffile: <replaceable>/var/lib/dirsrv/slapd-ldap1/ldif/ldap1-userRoot-2021_07_28_08_47_30.ldif</replaceable>
db2ldif successful</screen>
      <para>
        Restore this backup with the name of the archive, then start
        the server:
      </para>
      <screen>&prompt.sudo;dsctl ldif2db userRoot <replaceable>/var/lib/dirsrv/slapd-ldap1/ldif/ldap1-userRoot-2021_07_28_08_47_30.ldif</replaceable>
&prompt.sudo;dsctl ldap1 start</screen>
  </sect2>
  
  <sect2 xml:id="sec-security-ldap-online-backup">
  <title>Online Database Backup and Restore</title>
    <para>
      Use the <command>dsconf</command> to make an online backup of your LDAP
      database:
    </para>
    <screen>&prompt.sudo;dsconf <replaceable>ldap1</replaceable> backup create
The backup create task has finished successfully</screen>
    <para>
      This creates 
      <replaceable>/var/lib/dirsrv/slapd-ldap1/bak/ldap1-2021_07_28_09_46_08</replaceable>. Restore it:
    </para>
    <screen>&prompt.sudo;dsconf <replaceable>ldap1</replaceable> backup restore <replaceable>/var/lib/dirsrv/slapd-ldap1/bak/ldap1-2021_07_28_09_46_08</replaceable></screen>
  
  </sect2>
  
</sect1>