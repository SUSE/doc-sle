<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="storage_iscsi.xml" version="5.0" xml:id="cha.iscsi" xml:lang="ja">
 <title>IPネットワークの大容量記憶域 - iSCSI</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:bugtracker>
          </dm:bugtracker>
        <dm:translation>yes</dm:translation>
      </dm:docmanager>
    </info>
    <para>
  サーバの運用、またはコンピュータセンターの重要なタスクの1つには、サーバシステムに対してハードディスクスペースを提供することがあります。この用途には、多くの場合、ファイバチャネルが使用されます。iSCSI(Internet SCSI)ソリューションは、ファイバチャネルに対する低コストの代替であり、コモディティサーバおよびEthernetネットワーキング装置を活用することができます。Linux iSCSIは、iSCSIイニシエータおよびiSCSI LIOターゲットのソフトウェアの提供により、Linuxサーバを中央ストレージシステムに接続します。
 </para>
 <figure>
  <title>iSNSサーバによるiSCSI SAN</title>
  <mediaobject>
   <imageobject role="fo">
    <imagedata fileref="iscsi_san_a.png" width="80%" format="SVG"/>
   </imageobject>
   <imageobject role="html">
    <imagedata fileref="iscsi_san_a.png" width="100%" format="PNG"/>
   </imageobject>
  </mediaobject>
 </figure>
 <note>
  <title>LIO</title>
  <para>
   LIO (<link xlink:href="http://linux-iscsi.org"/>)は、Linux用の標準のオープンソースマルチプロトコルSCSIターゲットです。LIOは、Linuxカーネルのバージョン2.6.38以降において、Linuxにおける標準の統一ストレージターゲットとして、STGT (SCSI Target)フレームワークにとって代わりました。<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 12では、古いバージョンのiSCSIターゲットサーバにiSCSI LIOターゲットサーバに代わっています。
  </para>
 </note>
 <para>
  iSCSIは、ストレージネットワーキングプロトコルであり、ブロックストレージデバイスとサーバ間のTCP/IPネットワーク上でSCSIパケットのデータ転送を容易にします。iSCSIターゲットソフトウェアは、ターゲットサーバ上で実行され、論理ユニットをiSCSIターゲットデバイスとして定義します。iSCSIイニシエータソフトウェアは異なるサーバ上で実行され、ターゲットデバイスに接続して、そのサーバ上でストレージデバイスを使用できるようにします。
 </para>
 <para>
  iSCSI LIOターゲットサーバおよびiSCSIイニシエータサーバは、LAN内のIPレベルでSCSIパケットを送信して通信します。イニシエータサーバ上のアプリケーションがiSCSI LIOターゲットデバイスに対する照会を開始すると、オペレーティングシステムが必要なSCSIコマンドを発行します。するとSCSIコマンドが、<emphasis>iSCSIイニシエータ</emphasis>と呼ばれるソフトウェアによってIPパケットに組み込まれ、必要に応じて暗号化されます。パケットは社内IPネットワークで、<emphasis>iSCSI LIOターゲットサーバ</emphasis>または単純に<emphasis>iSCSIターゲット</emphasis>と呼ばれる、対応するiSCSIリモートステーションに転送されます。
 </para>
 <para>
  多くのストレージソリューションが、iSCSIによるアクセス手段を提供しています。また、LinuxサーバにiSCSIターゲットの役割をさせることもできます。この場合、Linuxサーバをファイルシステムサービス用に最適化しておくことが重要です。iSCSIターゲットはLinux内のブロックデバイスにアクセスします。したがってRAIDソリューションを使用することでディスク容量を増やし、メモリも増量してデータキャッシングを向上させることができます。RAIDの詳細については、<xref linkend="cha.raid" xrefstyle="ChapTitleOnPage"/>も参照してください。
 </para>
 <sect1 xml:id="sec.iscsi.install">
  <title>iSCSI LIOターゲットサーバとiSCSIイニシエータのインストール</title>

  <para>
   iSCSIイニシエータはデフォルトでインストールされますが(<systemitem class="resource">open-iscsi</systemitem>パッケージと<systemitem class="resource">yast2-iscsi-client</systemitem>パッケージ)、iSCSI LIOターゲットパッケージは手動でインストールする必要があります。
  </para>

  <important>
   <title>イニシエータとターゲットを同一サーバで実行することはできない</title>
   <para>
    iSCSIターゲットソフトウェアとiSCSIイニシエータソフトウェアを、運用環境内の同じサーバ上で実行することはできません。
   </para>
  </important>

  <para>
   iSCSI LIOターゲットサーバをインストールするには、端末コンソールで次のコマンドを実行します。
  </para>

<screen>sudo zypper in yast2-iscsi-lio-server</screen>

  <para>
   iSCSIイニシエータまたはその依存関係をインストールする必要がある場合は、コマンド<command>sudo zypper in yast2-iscsi-client</command>を実行します。
  </para>

  <para>
   または、YaSTソフトウェア管理モジュールを使用してインストールします。
  </para>

  <para>
   先に示したパッケージ以外の必要なパッケージは、インストーラによって自動的に組み込まれるか、またはそれぞれのYaSTモジュールの初回実行時にインストールされます。
  </para>
 </sect1>
 <sect1 xml:id="sec.iscsi.target">
  <title>iSCSI LIOターゲットサーバのセットアップ</title>

  <para>
   本項では、YaSTを使用してiSCSI LIOターゲットサーバを構成し、iSCSI LIOのターゲットデバイスを設定する方法について説明します。任意のiSCSIイニシエータソフトウェアを使用して、ターゲットデバイスにアクセスすることができます。
  </para>

  <sect2 xml:id="sec.iscsi.target.start">
   <title>iSCSI LIOターゲットサービスの起動およびファイアウォールの設定</title>
   <para>
    iSCSI LIOターゲットサービスは、マニュアルで開始するようデフォルトで設定されています。同サービスを、システムのブート時に自動的に開始するよう設定できます。サーバでファイアウォールを使用していて、iSCSI LIOターゲットをほかのコンピュータでも利用可能としたい場合は、ターゲットへのアクセスに使用する各アダプタ用に、ファイアウォール内のポートを開放する必要があります。TCPポート3260が、iSCSIプロトコル用のポート番号です。これは、IANA (Internet Assigned Numbers Authority)により定義されています。
   </para>
   <procedure>
    <step>
     <para>
      YaSTを起動し、<menuchoice><guimenu>ネットワークサービス</guimenu><guimenu>iSCSI LIOターゲット</guimenu></menuchoice>の順に起動します。
     </para>
    </step>
    <step>
     <para>
      <guimenu>サービス</guimenu>タブに切り替えます。
     </para>
     <informalfigure>
      <mediaobject>
       <imageobject role="fo">
        <imagedata fileref="lio_service_a.png" width="80%" format="PNG"/>
       </imageobject>
       <imageobject role="html">
        <imagedata fileref="lio_service_a.png" width="100%" format="PNG"/>
       </imageobject>
      </mediaobject>
     </informalfigure>
    </step>
    <step>
     <para>
      <guimenu>サービスを開始</guimenu>で、iSCSI LIOターゲットサービスの開始方法を指定します。
     </para>
     <itemizedlist mark="bullet" spacing="normal">
      <listitem>
       <formalpara>
        <title>ブート時:</title>
        <para>
         サービスは、サーバの再起動時に自動的に開始します。
        </para>
       </formalpara>
      </listitem>
      <listitem>
       <formalpara>
        <title>手動:</title>
        <para>
         (デフォルト)サーバの再起動後、<command>sudo systemctl start target</command>コマンドを実行して、手動でサービスを開始する必要があります。ターゲットデバイスは、サービスを開始するまで利用できません。
        </para>
       </formalpara>
      </listitem>
     </itemizedlist>
    </step>
    <step>
     <para>
      サーバでファイアウォールを使用していて、iSCSI LIOターゲットをほかのコンピュータでも利用可能としたい場合は、ターゲットへのアクセスに使用する各アダプタインタフェース用に、ファイアウォール内のポート3260を開放します。このポートがネットワークインタフェースのすべてに対してクローズしている場合、iSCSI LIOターゲットはほかのコンピュータでは利用できません。
     </para>
     <para>
      サーバでファイアウォールを使用していない場合、ファイアウォール設定は無効です。この場合、次の手順をスキップして、<guimenu>終了</guimenu>を使用して設定ダイアログから移動するか、別のタブに切り替えて設定を続行します。
     </para>
     <substeps performance="required">
      <step>
       <para>
        <guimenu>サービス</guimenu>タブで、<guimenu>ファイアウォールのポートを開く</guimenu>チェックボックスをオンにして、ファイアウォール 設定を有効にします。
       </para>
      </step>
      <step>
       <para>
        <guimenu>ファイアウォールの詳細</guimenu>をクリックして、使用するネットワークインタフェースを確認または設定します。すべての利用可能なネットワークインタフェースが一覧表示され、デフォルトではすべてが選択されています。ポートを開く必要が<emphasis>ない</emphasis>すべてのインタフェースを選択解除します。<guimenu>OK</guimenu>をクリックして設定を保存します。
       </para>
      </step>
     </substeps>
    </step>
    <step>
     <para>
      <guimenu>完了</guimenu>をクリックして、iSCSI LIOターゲットサービスの設定を保存して適します。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.iscsi.target.authenticate">
   <title>iSCSI LIOターゲットおよびクライアントのディスカバリに対する認証の設定  </title>
   <para>
    iSCSI LIOターゲットサーバソフトウェアは、PPP-CHAP (Point-to-Point Protocol Challenge Handshake Authentication Protocol)をサポートしています。これは、<citetitle>Internet Engineering Task Force (IETF) RFC 1994</citetitle> (<link xlink:href="http://www.ietf.org/rfc/rfc1994.txt"/>)で定義されている、3方向の認証方法です。サーバはこの認証方法を、ターゲット上のファイルへのアクセスにではなく、iSCSI LIOのターゲットとクライアントのディスカバリ用に使用します。ディスカバリへのアクセスを制限しない場合は、<guimenu>認証なし</guimenu>を選択します。デフォルトでは<guimenu>認証なし</guimenu>のオプションが有効になっています。このサーバ上のすべてのiSCSI LIOターゲットは、認証を要求しないので、同じネットワーク上のどのiSCSIイニシエータクライアントによっても検出することができます。このサーバは、ディスカバリに対する認証を必要としない、同じネットワーク上のどのiSCSIイニシエータクライアントも検出することができます。
   </para>
   <para>
    よりセキュアな設定に対する認証が必要な場合は、incoming認証、outgoing認証またはその両方を使用できます。 <guimenu>incoming認証</guimenu>では、iSCSIイニシエータに、iSCSI LIOターゲット上でディスカバリを実行するパーミッションがあることを証明するよう求めます。イニシエータは、incomingのユーザ名とパスワードを入力する必要があります。<guimenu>outgoing認証</guimenu>では、iSCSI LIOターゲットに、自らが目的のターゲットであることをイニシエータに対して証明するよう求めます。iSCSI LIOターゲットは、outgoingのユーザ名とパスワードを、iSCSIイニシエータに提供する必要があります。ユーザ名とパスワードの組み合わせは、incomingとoutgoingディスカバリで異なっても構いません。ディスカバリに対する認証を有効にしない場合、その設定は、すべてのiSCSI LIOターゲットグループに適用されます。
   </para>
   <important>
    <title>セキュリティ</title>
    <para>
     セキュリティ上の理由により、運用環境では、ターゲットおよびクライアントのディスカバリに認証を使用することを推奨します。
    </para>
   </important>
   <para>
    iSCSI LIOターゲットに対して認証の初期設定を行うには
   </para>
   <procedure>
    <step>
     <para>
      YaSTを起動し、<menuchoice><guimenu>ネットワークサービス</guimenu><guimenu>iSCSI LIOターゲット</guimenu></menuchoice>の順に起動します。
     </para>
    </step>
    <step>
     <para>
      <guimenu>グローバル</guimenu>タブに切り替えます。
     </para>
     <informalfigure>
      <mediaobject>
       <imageobject role="fo">
        <imagedata fileref="lio_global_noauth_a.png" width="80%" format="PNG"/>
       </imageobject>
       <imageobject role="html">
        <imagedata fileref="lio_global_noauth_a.png" width="100%" format="PNG"/>
       </imageobject>
      </mediaobject>
     </informalfigure>
    </step>
    <step>
     <para>
      デフォルトでは、認証は無効(<guimenu>認証なし</guimenu>)です。認証を有効にするには、<guimenu>受信認証</guimenu>または<guimenu>送信認証</guimenu>、あるいはその両方を選択します。
     </para>
    </step>
    <step>
     <para>
      選択した認証方法に対して資格情報を提供します。ユーザ名とパスワードの組み合わせは、incomingとoutgoingディスカバリで異なっても構いません。
     </para>
    </step>
    <step>
     <para>
      <guimenu>完了</guimenu>をクリックして、設定を保存して適用します。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.iscsi.target.storage">
   <title>ストレージスペースの準備</title>
   <para>
    iSCSI LIOターゲットの設定により、既存のブロックデバイスをiSCSIイニシエータにエクスポートします。YaSTのパーティショナを使用して、またはコマンドラインからpartedによってデバイスのパーティション分割を行うことで、未フォーマットのパーティションやデバイスを設定し、ターゲットデバイスで使用するストレージスペースを準備する必要があります。iSCSI LIO ターゲットは、Linux、Linux LVM、またはLinux RAIDファイルシステムIDで未フォーマットのパーティションを使用できます。詳細については、<xref linkend="sec.yast2.i_y2_part_expert"/>を参照してください。
   </para>
   <important>
    <title>iSCSIターゲットデバイスをマウントしない</title>
    <para>
     iSCSIターゲットとして使用するデバイスやパーティションを設定したら、ローカルパス経由で直接アクセスしないでください。作成時にはマウントポイントは指定しないでください。
    </para>
   </important>
   <sect3 xml:id="sec.iscsi.target.storage.vm">
    <title>仮想環境でのデバイスのパーティション分割</title>
    <para>
     仮想マシンのゲストサーバを、iSCSI LIOターゲットサーバとして使用できます。本項では、Xen仮想マシンにパーティションを割り当てる方法を説明します。また、<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>でサポートされている他の仮想環境も使用できます。
    </para>
    <para>
     Xen仮想環境で、iSCSI LIOターゲットデバイスに使用するストレージスペースをゲストの仮想マシンに割り当て、ゲスト環境内の仮想ディスクとしてそのスペースにアクセスします。各仮想ディスクは、ディスク全体、パーティション、ボリュームなどの物理ブロックデバイスでも、Xenホストサーバ上の大規模な物理ディスク上の単一イメージファイルが仮想ディスクになっている、ファイルバックディスクイメージのいずれでも可能です。最適なパフォーマンスを得るためには、物理ディスクまたはパーティションから各仮想ディスクを作成してください。ゲストの仮想マシンに仮想ディスクを設定したら、ゲストサーバを起動し、物理サーバの場合と同じ方法で、新しいブランクの仮想ディスクをiSCSIターゲットデバイスとして設定します。
    </para>
    <para>
     ファイルバックディスクイメージがXenホストサーバ上に作成され、Xenゲストサーバに割り当てられます。デフォルトでは、Xenはファイルバックディスクイメージを<filename>/var/lib/xen/images/<replaceable>vm_name</replaceable></filename>ディレクトリに保存します。ここで<filename><replaceable>vm_name</replaceable></filename>は仮想マシンの名前です。
    </para>
   </sect3>
  </sect2>

  <sect2 xml:id="sec.iscsi.target.target_group">
   <title>iSCSI LIOターゲットグループの設定</title>
   <para>
    YaSTを使用して、iSCSI LIOターゲットデバイスを設定することができます。YaSTでは、<command>lio-utils</command>ソフトウェアにより提供されるAPIを使用します。iSCSI LIO ターゲットは、Linux、Linux LVM、またはLinux RAIDファイルシステムIDで未フォーマットのパーティションを使用できます。
   </para>
   <important>
    <para>
     始める前に、<xref linkend="sec.iscsi.target.storage" xrefstyle="SectTitleOnPage"/>に記載しているように、iSCSI LIOターゲットとして使用する未フォーマットのパーティションを作成してください。
    </para>
   </important>
   <procedure>
    <step>
     <para>
      YaSTを起動し、<menuchoice><guimenu>ネットワークサービス</guimenu><guimenu>iSCSI LIOターゲット</guimenu></menuchoice>の順に起動します。
     </para>
    </step>
    <step>
     <para>
      <guimenu>ターゲット</guimenu>タブに切り替えます。
     </para>
     <informalfigure>
      <mediaobject>
       <imageobject role="fo">
        <imagedata fileref="lio_targets_a.png" width="80%" format="PNG"/>
       </imageobject>
       <imageobject role="html">
        <imagedata fileref="lio_targets_a.png" width="100%" format="PNG"/>
       </imageobject>
      </mediaobject>
     </informalfigure>
    </step>
    <step>
     <para>
      <guimenu>追加</guimenu>をクリックして、新しいiSCSI LIOのターゲットグループとデバイスを定義します。
     </para>
     <para>
      iSCSI LIOターゲットソフトウェアにより、<guimenu>ターゲット</guimenu>、<guimenu>識別子</guimenu>、<guimenu>ポータルグループ</guimenu>、<guimenu>IPアドレス</guimenu>、および<guimenu>ポート番号</guimenu>の各フィールドが自動的に記入されます。<guimenu>認証を使用する</guimenu>が、デフォルトで選択されています。
     </para>
     <substeps performance="required">
      <step>
       <para>
        複数のネットワークインタフェースがある場合は、IPアドレスのドロップダウンリストを使って、このターゲットグループ用に使用するネットワークインタフェースのIPアドレスを選択します。すべてのアドレスでサーバにアクセスできるようにするには、<guimenu>Bind All IP Addresses (すべてのIPアドレスをバインド)</guimenu>を選択します。
       </para>
      </step>
      <step>
       <para>
        このターゲットグループに対してクライアント認証を不要にする場合は、<guimenu>認証を使用する</guimenu>を選択解除します。
       </para>
      </step>
      <step>
       <para>
        <guimenu>追加</guimenu>をクリックします。デバイスまたはパーティションのパスを入力するか、または<guimenu>参照</guimenu>を使用して追加します。オプションで名前を指定して、<guimenu>OK</guimenu>をクリックします。0から始まるLUN番号が自動的に作成されます。フィールドを空にしておくと、名前が自動的に生成されます。
       </para>
      </step>
      <step>
       <para>
        (オプション)前の手順を繰り返し、このターゲットグループにさらにターゲットを追加します。
       </para>
      </step>
      <step>
       <para>
        目的のターゲットがすべてグループに追加されたら、<guimenu>次へ</guimenu>をクリックします。
       </para>
      </step>
     </substeps>
    </step>
    <step>
     <para>
      <guimenu>iSCSIターゲットクライアントセットアップの変更</guimenu>ページで、ターゲットグループ内のLUNへのアクセスを許可されるクライアントに関する情報を設定します。
     </para>
     <informalfigure>
      <mediaobject>
       <imageobject role="fo">
        <imagedata fileref="lio_target_client_a.png" width="80%" format="PNG"/>
       </imageobject>
       <imageobject role="html">
        <imagedata fileref="lio_target_client_a.png" width="100%" format="PNG"/>
       </imageobject>
      </mediaobject>
     </informalfigure>
     <para>
      ターゲットグループに対して1つ以上のクライアントを指定すると、<guimenu>LUNを編集</guimenu>、<guimenu>認証を編集</guimenu>、<guimenu>削除</guimenu>、および<guimenu>コピー</guimenu>の各ボタンが有効になります。<guimenu>追加</guimenu>または<guimenu>コピー</guimenu>を使用して、ターゲットグループにさらにクライアントを追加できます。
     </para>
     <itemizedlist xml:id="il.iscsi.target.target_group.options" mark="bullet" spacing="normal">
      <title>［iSCSIターゲットの変更］: オプション</title>
      <listitem>
       <formalpara>
        <title>追加:</title>
        <para>
         選択したiSCSI LIOターゲットグループに、新たなクライアントのエントリを追加します。
        </para>
       </formalpara>
      </listitem>
      <listitem>
       <formalpara>
        <title>LUNを編集:</title>
        <para>
         iSCSI LIOターゲットグループ内のどのLUNが、選択したクライアントにマップするかを設定します。割り当てられたターゲットのそれぞれを、任意のクライアントLUNにマップすることができます。
        </para>
       </formalpara>
      </listitem>
      <listitem>
       <formalpara>
        <title>認証を編集:</title>
        <para>
         選択したクライアントに対する好みの認証方法を設定します。認証なしを指定することも、incoming認証、outgoing認証、またはその両方を設定することもできます。 
        </para>
       </formalpara>
      </listitem>
      <listitem>
       <formalpara>
        <title>削除:</title>
        <para>
         選択したクライアントのエントリを、ターゲットグループに割り当てられたクライアントの一覧から削除します。
        </para>
       </formalpara>
      </listitem>
      <listitem>
       <formalpara>
        <title>コピー:</title>
        <para>
         同じLUNのマッピングと認証設定を持つ新たなクライアントのエントリを、選択したクライアントのエントリとして追加します。これにより、容易に同じ共有LUNを、クラスタ内の各ノードに順々に割り当てることができます。
        </para>
       </formalpara>
      </listitem>
     </itemizedlist>
     <substeps performance="required">
      <step>
       <para>
        <guimenu>追加</guimenu>をクリックして、クライアント名を指定し、<guimenu>TPGからLUNをインポート</guimenu>チェックボックスを選択または選択解除してから、<guimenu>OK</guimenu>をクリックして設定を保存します。
       </para>
      </step>
      <step>
       <para>
        クライアントのエントリを選択して、<guimenu>LUNを編集</guimenu>をクリックし、LUNのマッピングを変更してiSCSI LIOターゲットグループ内のどのLUNを選択したクライアントに割り当てるかを指定して、<guimenu>OK</guimenu>をクリックして変更内容を保存します。
       </para>
       <para>
        iSCSI LIOターゲットグループが複数のLUNで構成されている場合は、1つまたは複数のLUNを、選択したクライアントに割り当てることができます。デフォルトでは、グループ内の利用可能なLUNのそれぞれが、クライアントLUNに割り当てられます。
       </para>
       <para>
        LUNの割り当てを変更するには、次の操作の1つ以上を実行します。
       </para>
       <itemizedlist mark="bullet" spacing="normal">
        <listitem>
         <formalpara>
          <title>追加:</title>
          <para>
           <guimenu>追加</guimenu>をクリックして新しい<guimenu>クライアントLUN</guimenu>のエントリを作成し、<guimenu>変更</guimenu>ドロップダウンリストを使用して、それにターゲットLUNをマップします。
          </para>
         </formalpara>
        </listitem>
        <listitem>
         <formalpara>
          <title>削除:</title>
          <para>
           <guimenu>クライアントLUN</guimenu>のエントリを選択して、<guimenu>削除</guimenu>をクリックしてターゲットLUNのマッピングを削除します。
          </para>
         </formalpara>
        </listitem>
        <listitem>
         <formalpara>
          <title>変更:</title>
          <para>
           <guimenu>クライアントLUN</guimenu>のエントリを選択し、<guimenu>変更</guimenu>ドロップダウンリストを使用して、それにマップするターゲットLUNを選択します。
          </para>
         </formalpara>
        </listitem>
       </itemizedlist>
       <para>
        一般的な割り当のプランには、次のようなものがあります。
       </para>
       <itemizedlist mark="bullet" spacing="normal">
        <listitem>
         <para>
          1台のサーバが、クライアントとして登録されています。ターゲットグループ内のLUNがすべて、それに割り当てられています。
         </para>
         <para>
          このグループ化戦略を使用して、特定のサーバに対して、iSCSI SANストレージを論理的にグループ化することができます。
         </para>
        </listitem>
        <listitem>
         <para>
          複数の独立したサーバが、クライアントとして登録されています。1つまたは複数のターゲットLUNが、それぞれのサーバに割り当てられています。それぞれのLUNは、1台のサーバのみに割り当てられています。
         </para>
         <para>
          このグループ化戦略を使用して、データセンター内の特定の部門またはサービスのカテゴリに対して、iSCSI SANストレージを論理的にグループ化することができます。
         </para>
        </listitem>
        <listitem>
         <para>
          クラスタの各ノードが、クライアントとして登録されています。共有のターゲットLUNがすべて、各ノードに割り当てられています。すべてのノードがデバイスに接続されていますが、ほとんどのファイルシステムに対して、クラスタソフトウェアによってデバイスによるアクセスがロックされ、一度に1つのノード上にのみデバイスがマウントされます。共有ファイルシステム(OCFS2など)では、複数のノードが同時に同じファイル構造をマウントし、読み込みおよび書き込みアクセスを持つ同じファイルを開くことが可能です。
         </para>
         <para>
          このグループ化戦略を使用して、特定のサーバクラスタに対して、iSCSI SANストレージを論理的にグループ化することができます。
         </para>
        </listitem>
       </itemizedlist>
      </step>
      <step>
       <para>
        クライアントのエントリを選択して、<guimenu>認証を編集</guimenu>をクリックし、クライアントに対する認証設定を指定して、<guimenu>OK</guimenu>をクリックして設定を保存します。
       </para>
       <para>
        <guimenu>認証なし</guimenu>とすることも、<guimenu>incoming認証</guimenu>、<guimenu>outgoing認証</guimenu>、またはその両方を設定することもできます。各クライアントに対して指定できるユーザ名とパスワードの組み合わせは、1つだけです。クライアントに対するincoming認証とoutgoing認証の資格情報は、異なっても構いません。資格情報は、クライアントごとに異なっても構いません。
       </para>
      </step>
      <step>
       <para>
        このターゲットグループにアクセスできる各iSCSIクライアントについて、前の手順を繰り返します。
       </para>
      </step>
      <step>
       <para>
        クライアントの割り当てを設定し終わったら、<guimenu>次へ</guimenu>をクリックします。
       </para>
      </step>
     </substeps>
    </step>
    <step>
     <para>
      <guimenu>完了</guimenu>をクリックして、設定を保存して適用します。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.iscsi.target.tg_modify">
   <title>iSCSI LIOターゲットグループの変更</title>
   <para>
    以下のようにして、iSCSI LIOターゲットグループに変更を加えることができます。
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      ターゲットLUNデバイスをターゲットグループに追加または削除する    
     </para>
    </listitem>
    <listitem>
     <para>
      ターゲットグループに対してクライアントを追加または削除する  
     </para>
    </listitem>
    <listitem>
     <para>
      ターゲットグループのクライアントに対して、クライアントLUNからターゲットLUNへのマッピングを変更する
     </para>
    </listitem>
    <listitem>
     <para>
      クライアント認証(incoming、outgoing、または両方)用のユーザ名とパスワードの資格情報を変更する
     </para>
    </listitem>
   </itemizedlist>
   <para>
    iSCSI LIOターゲットグループに対する設定を確認または変更するには:
   </para>
   <procedure>
    <step>
     <para>
      YaSTを起動し、<menuchoice><guimenu>ネットワークサービス</guimenu><guimenu>iSCSI LIOターゲット</guimenu></menuchoice>の順に起動します。
     </para>
    </step>
    <step>
     <para>
      <guimenu>ターゲット</guimenu>タブに切り替えます。
     </para>
    </step>
    <step>
     <para>
      変更するiSCSI LIOターゲットグループを選択して、<guimenu>編集</guimenu>をクリックします。
     </para>
    </step>
    <step>
     <para>
      [iSCSIターゲットLUNのセットアップを変更]ページで、ターゲットグループにLUNを追加し、LUNの割り当てを編集するか、またはターゲットLUNをグループから削除します。すべてグループに目的の変更が行われたら、<guimenu>次へ</guimenu>をクリックします。
     </para>
     <para>
      オプション情報については、「<xref linkend="il.iscsi.target.target_group.options"/>」を参照してください。
     </para>
    </step>
    <step>
     <para>
      [iSCSIターゲットクライアントセットアップの変更]ページで、ターゲットグループ内のLUNへのアクセスを許可されるクライアントに関する情報を設定します。すべてグループに目的の変更が行われたら、<guimenu>次へ</guimenu>をクリックします。
     </para>
    </step>
    <step>
     <para>
      <guimenu>完了</guimenu>をクリックして、設定を保存して適用します。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.iscsi.target.tg_delete">
   <title>iSCSI LIOターゲットグループの削除</title>
   <para>
    iSCSI LIOターゲットグループを削除すると、グループの定義と、クライアントに対する関連のセットアップ(LUNのマッピングや認証資格情報を含む)が削除されます。パーティション上のデータは破棄されません。クライアントに再度アクセス権を付与するには、ターゲットLUNを別のまたは新規のターゲットグループに割り当てて、それらに対するクライアントアクセスを設定します。
   </para>
   <procedure>
    <step>
     <para>
      YaSTを起動し、<menuchoice><guimenu>ネットワークサービス</guimenu><guimenu>iSCSI LIOターゲット</guimenu></menuchoice>の順に起動します。
     </para>
    </step>
    <step>
     <para>
      <guimenu>ターゲット</guimenu>タブに切り替えます。
     </para>
    </step>
    <step>
     <para>
      削除するiSCSI LIOターゲットグループを選択して、<guimenu>削除</guimenu>をクリックします。
     </para>
    </step>
    <step>
     <para>
      確認のメッセージが表示されたら、<guimenu>続行</guimenu>をクリックして削除を確認するか、<guimenu>キャンセル</guimenu>をクリックしてキャンセルします。
     </para>
    </step>
    <step>
     <para>
      <guimenu>完了</guimenu>をクリックして、設定を保存して適用します。
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.iscsi.initiator">
  <title>iSCSIイニシエータの設定</title>

  <para>
   任意のiSCSIターゲットに接続するには、iSCSIイニシエータ(iSCSIクライアントとも呼ぶ)を使用できます。これは、<xref linkend="sec.iscsi.target" xrefstyle="SectTitleOnPage"/>で説明されているターゲットソリューションだけに限りません。iSCSIイニシエータの設定には、利用可能なiSCSIターゲットの検出と、iSCSIセッションの設定という2つの主要ステップがあります。どちらの設定も、YaSTを使って行うことができます。
  </para>

  <sect2 xml:id="sec.iscsi.initiator.yast">
   <title>YaSTを使ったiSCSIイニシエータの設定</title>
   <para>
    YaSTの［iSCSIイニシエータの概要］が3つのタブに分割されます。
   </para>
   <variablelist>
    <varlistentry>
     <term>サービス:</term>
     <listitem>
      <para>
       <guimenu>サービス</guimenu>タブでは、ブート時にiSCSIイニシエータを有効にできます。固有の<guimenu>イニシエータ名</guimenu>とディスカバリに使用するiSNSサーバも設定できます。iSNSのデフォルトポートは3205です。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>接続したターゲット:</term>
     <listitem>
      <para>
       <guimenu>Connected Targets</guimenu>タブには、現在接続しているiSCSIターゲットの概要が表示されます。このタブにも、<guimenu>検出されたターゲット</guimenu>タブのように、システムに新しいターゲットを追加するオプションが用意されています。
      </para>
      <para>
       このページでは、ターゲットデバイスを選択して、各iSCSIターゲットデバイスの起動時の設定を切り替えることができます。
      </para>
      <formalpara>
       <title>自動:</title>
       <para>
        このオプションは、iSCSIサービス自体の起動時に接続するiSCSIターゲットに使用されます。これが通常の設定です。
       </para>
      </formalpara>
      <formalpara>
       <title>Onboot(起動時):</title>
       <para>
        このオプションは、起動時、つまりルート(<filename>/</filename>)がiSCSI上にある場合に接続するiSCSIターゲットに使用します。したがって、iSCSIターゲットデバイスはサーバの起動時にinitrdによって評価されます。
       </para>
      </formalpara>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>検出されたターゲット:</term>
     <listitem>
      <para>
       <guimenu>検出されたターゲット</guimenu>タブでは、ネットワーク内のiSCSIターゲットを手動で検出することができます。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <sect3 xml:id="sec.iscsi.initiator.yast.configuration">
    <title>iSCSIイニシエータの設定</title>
    <procedure>
     <step>
      <para>
       YaSTを起動し、<menuchoice><guimenu>ネットワークサービス</guimenu><guimenu>iSCSI LIOターゲット</guimenu></menuchoice>の順に起動します。
      </para>
     </step>
     <step>
      <para>
       <guimenu>サービス</guimenu>タブに切り替えます。
      </para>
      <informalfigure>
       <mediaobject>
        <imageobject role="fo">
         <imagedata fileref="iscsi_init_service_a.png" width="80%" format="PNG"/>
        </imageobject>
        <imageobject role="html">
         <imagedata fileref="iscsi_init_service_a.png" width="100%" format="PNG"/>
        </imageobject>
       </mediaobject>
      </informalfigure>
     </step>
     <step>
      <para>
       <guimenu>サービスを開始</guimenu>で、iSCSIイニシエータサービスの開始方法を指定します。
      </para>
      <itemizedlist mark="bullet" spacing="normal">
       <listitem>
        <formalpara>
         <title>ブート時:</title>
         <para>
          サービスは、サーバの再起動時に自動的に開始します。
         </para>
        </formalpara>
       </listitem>
       <listitem>
        <formalpara>
         <title>手動:</title>
         <para>
          (デフォルト)サーバの再起動後、<command>sudo systemctl start iscsi iscsid</command>コマンドを実行して、手動でサービスを開始する必要があります。
         </para>
        </formalpara>
       </listitem>
      </itemizedlist>
     </step>
     <step>
      <para>
       <guimenu>イニシエータ名</guimenu>を指定、または確認します。
      </para>
      <para>
       このサーバ上のiSCSIイニシエータに、正しい形式のiSCSI修飾名(IQN)を指定します。イニシエータ名はネットワーク全体で固有のものでなければなりません。IQNは次の一般的なフォーマットを使用します。
      </para>
<screen>iqn.yyyy-mm.com.mycompany:n1:n2</screen>
      <para>
       ここでn1とn2はアルファベットか数字です。次に例を示します。
      </para>
<screen>iqn.1996-04.de.suse:01:a5dfcea717a</screen>
      <para>
       <guimenu>イニシエータ名</guimenu>には、サーバ上の<filename>/etc/iscsi/initiatorname.iscsi</filename>ファイルから対応する値が自動的に入力されます。
      </para>
      <para>
       サーバがiBFT(iSCSI Boot Firmware Table)をサポートしている場合は、<guimenu>イニシエータ名</guimenu>にはIBFT内の対応する値が入力され、このインタフェースではイニシエータ名を変更できません。代わりにBIOSセットアップを使用して変更してください。iBFTは、サーバのiSCSIターゲットとイニシエータの説明を含む、iSCSIの起動プロセスに便利な各種パラメータを含んだ情報ブロックです。
      </para>
     </step>
     <step>
      <para>
       次のいずれかの方法を使用して、ネットワーク上のiSCSIターゲットを検出します。
      </para>
      <itemizedlist mark="bullet" spacing="normal">
       <listitem>
        <formalpara>
         <title>iSNS:</title>
         <para>
          iSNS (Internet Storage Name Service)を使用してiSCSIターゲットを検出するには、続いて<xref linkend="sec.iscsi.initiator.yast.isn" xrefstyle="HeadingOnPage"/>を実行します。
         </para>
        </formalpara>
       </listitem>
       <listitem>
        <formalpara>
         <title>検出されたターゲット:</title>
         <para>
          iSCSIターゲットデバイスを手動で検出するには、続いて<xref linkend="sec.iscsi.initiator.yast.discovered" xrefstyle="HeadingOnPage"/>を実行します。
         </para>
        </formalpara>
       </listitem>
      </itemizedlist>
     </step>
    </procedure>
   </sect3>
   <sect3 xml:id="sec.iscsi.initiator.yast.isn">
    <title>iSNSによるiSCSIターゲットの検出</title>
    <para>
     このオプションを使用する前に、ご使用の環境内でiSNSサーバをインストールし、設定しておく必要があります。詳細については、<xref linkend="cha.isns" xrefstyle="ChapTitleOnPage"/>を参照してください。
    </para>
    <procedure>
     <step>
      <para>
       YaSTで<guimenu>iSCSIイニシエータ</guimenu>を選択し、次に<guimenu>サービス</guimenu>タブを選択します。
      </para>
     </step>
     <step>
      <para>
       iSNSサーバのIPアドレスとポートを指定します。デフォルトのポートは3205です。
      </para>
     </step>
     <step>
      <para>
       <guimenu>完了</guimenu>をクリックして、変更を保存、および適用します。
      </para>
     </step>
    </procedure>
   </sect3>
   <sect3 xml:id="sec.iscsi.initiator.yast.discovered">
    <title>iSCSIターゲットの手動検出</title>
    <para>
     iSCSIイニシエータを設定しているサーバからアクセスする各iSCSIターゲットサーバについて、次の手順を繰り返し実行します。
    </para>
    <procedure>
     <step>
      <para>
       YaSTで<guimenu>iSCSIイニシエータ</guimenu>を選択し、次に<guimenu>検出されたターゲット</guimenu>タブを選択します。
      </para>
     </step>
     <step>
      <para>
       <guimenu>検出</guimenu>をクリックして［iSCSIイニシエータの検出］ダイアログボックスを開きます。
      </para>
     </step>
     <step>
      <para>
       IPアドレスを入力し、必要に応じてポートを変更します。デフォルトポートは3260です。
      </para>
     </step>
     <step>
      <para>
       認証が必要な場合は、<guimenu>認証なし</guimenu>の選択を解除して、<guimenu>受信</guimenu>または<guimenu>送信</guimenu>認証用の資格情報を指定します。
      </para>
     </step>
     <step>
      <para>
       <guimenu>次へ</guimenu>をクリックして、検出を開始し、iSCSIターゲットサーバに接続します。
      </para>
     </step>
     <step>
      <para>
       資格情報が必要な場合は、検出成功後、<guimenu>接続</guimenu>を使用してターゲットを有効化します。
      </para>
      <para>
       指定したiSCSIターゲットを使用するための、認証資格情報の提供を促されます。
      </para>
     </step>
     <step>
      <para>
       <guimenu>次へ</guimenu>をクリックして、設定を完了します
      </para>
      <para>
       これでターゲットが<guimenu>接続したターゲット</guimenu>に表示され、仮想iSCSIデバイスが使用可能になります。
      </para>
     </step>
     <step>
      <para>
       <guimenu>完了</guimenu>をクリックして、変更を保存、および適用します。
      </para>
     </step>
     <step>
      <para>
       <command>lsscsi</command>コマンドを使用すると、iSCSIターゲットデバイスのローカルデバイスパスを検出することができます。
      </para>
     </step>
    </procedure>
   </sect3>
   <sect3 xml:id="sec.iscsi.initiator.yast.startup">
    <title>iSCSIターゲットデバイスの起動設定</title>
    <procedure>
     <step>
      <para>
       YaSTで、<guimenu>iSCSIイニシエータ</guimenu>を選択し、次に<guimenu>接続したターゲット</guimenu>タブを選択して、現在サーバに接続されているiSCSIターゲットデバイスの一覧を表示することができます。
      </para>
     </step>
     <step>
      <para>
       管理するiSCSIターゲットデバイスを選択します。
      </para>
     </step>
     <step>
      <para>
       <guimenu>起動の切り替え</guimenu>をクリックして設定を変更します。
      </para>
      <formalpara>
       <title>自動:</title>
       <para>
        このオプションは、iSCSIサービス自体の起動時に接続するiSCSIターゲットに使用されます。これが通常の設定です。
       </para>
      </formalpara>
      <formalpara>
       <title>Onboot(起動時):</title>
       <para>
        このオプションは、起動時、つまりルート(<filename>/</filename>)がiSCSI上にある場合に接続するiSCSIターゲットに使用します。したがって、iSCSIターゲットデバイスはサーバの起動時にinitrdによって評価されます。
       </para>
      </formalpara>
     </step>
     <step>
      <para>
       <guimenu>完了</guimenu>をクリックして、変更を保存、および適用します。
      </para>
     </step>
    </procedure>
   </sect3>
  </sect2>

  <sect2 xml:id="sec.iscsi.initiator.manually">
   <title>手動によるiSCSIイニシエータの設定</title>
   <para>
    iSCSI接続の検出や設定を行うには、iscsidが稼働していなければなりません。初めて検出(ディスカバリ)を実行する場合、iSCSIイニシエータの内部データベースが、<filename>/var/lib/open-iscsi</filename>ディレクトリに作成されます。
   </para>
   <para>
    ディスカバリがパスワードにより保護されている場合は、iscsidに認証情報を渡します。最初にディスカバリを実行する時には内部データベースが存在していないため、現時点でこれは使用できません。かわりに、<filename>/etc/iscsid.conf</filename>設定ファイルを編集して、情報を指定する必要があります。パスワード情報をiscsidに渡すには、<filename>/etc/iscsid.conf</filename>ファイルの最後に、次の行を追加します。
   </para>
<screen>discovery.sendtargets.auth.authmethod = CHAP
discovery.sendtargets.auth.username = <replaceable>username</replaceable>
discovery.sendtargets.auth.password = <replaceable>password</replaceable></screen>
   <para>
    ディスカバリは、受け取ったすべての値を内部データベースに保存します。また、検出したターゲットをすべて表示します。次のコマンドで、このディスカバリを実行します。  
   </para>
<screen>sudo iscsiadm <option>-m discovery --type=st --portal=<replaceable>target_ip</replaceable></option>
</screen>
   <para>
    次のように出力されます。
   </para>
<screen>10.44.171.99:3260,1 iqn.2006-02.com.example.iserv:systems</screen>
   <para>
    <literal>iSNS</literal>サーバで使用できるターゲットを検出するには、次のコマンドを使用します。
   </para>
<screen>sudo iscsiadm --mode discovery --type isns --portal <replaceable>target_ip</replaceable></screen>
   <para>
    iSCSIターゲットに定義されている各ターゲットが、それぞれ1行に表示されます。保存されたデータの詳細については、<xref linkend="sec.iscsi.initiator.database" xrefstyle="SectTitleOnPage"/>を参照してください。
   </para>
   <para>
   <command> iscsiadm</command>コマンドの<option>--login</option>オプションを使用すると、必要なすべてのデバイスが作成されます。
   </para>
<screen>sudo iscsiadm -m node -n iqn.2006-02.com.example.iserv:systems --login</screen>
   <para>
    新しく生成されたデバイスは<command>lsscsi</command>コマンドの出力に表示され、マウントできるようになります。
   </para>
  </sect2>

  <sect2 xml:id="sec.iscsi.initiator.database">
   <title>iSCSIクライアントデータベース</title>
   <para>
    iSCSIイニシエータが検出した情報は、<filename>/var/lib/open-iscsi</filename>に格納されている2つのデータベースファイルに保管されます。1つは、ディスカバリが検出したターゲット用のデータベースで、もう1つは検出したノード用のデータベースです。データベースにアクセスする場合、まずデータをディスカバリ用データベースから取得するのか、またはノードデータベースから取得するのかを指定する必要があります。指定するには、<option>iscsiadm</option>コマンドの<option>-m discovery</option>または<command>-m node</command>パラメータを使用します。<command>iscsiadm</command>コマンドに、どちらかのパラメータを指定して実行すると、そのデータベースに保管されているレコードの概要が表示されます。
   </para>
<screen><prompt>tux &gt; </prompt>sudo iscsiadm -m discovery
10.44.171.99:3260,1 iqn.2006-02.com.example.iserv:systems
</screen>
   <para>
    この例のターゲット名は<literal>iqn.2006-02.com.example.iserv:systems</literal>です。このデータセットに関連する操作を行う場合に、この名前が必要になります。ID <literal>iqn.2006-02.com.example.iserv:systems</literal>のデータレコードのコンテンツを調べるには、次のコマンドを使用します。
   </para>
<screen><prompt>tux &gt; </prompt>sudo iscsiadm -m node --targetname iqn.2006-02.com.example.iserv:systems
node.name = iqn.2006-02.com.example.iserv:systems
node.transport_name = tcp
node.tpgt = 1
node.active_conn = 1
node.startup = manual
node.session.initial_cmdsn = 0
node.session.reopen_max = 32
node.session.auth.authmethod = CHAP
node.session.auth.username = joe
node.session.auth.password = ********
node.session.auth.username_in = <replaceable>empty</replaceable>
node.session.auth.password_in = <replaceable>empty</replaceable>
node.session.timeo.replacement_timeout = 0
node.session.err_timeo.abort_timeout = 10
node.session.err_timeo.reset_timeout = 30
node.session.iscsi.InitialR2T = No
node.session.iscsi.ImmediateData = Yes
....</screen>
   <para>
    これらの変数の値を変更する場合は、<command>iscsiadm</command>コマンドで<option>update</option>オプションを使用します。たとえば、初期化時にiscidをiSCSIターゲットにログインさせる場合は、値に<option>automatic</option>と<option>node.startup</option>を設定します。
   </para>
<screen>sudo iscsiadm -m node -n iqn.2006-02.com.example.iserv:systems \
-p ip:port --op=update --name=node.startup --value=automatic</screen>
   <para>
    <literal>delete</literal>で、古くなったデータセットを削除します。ターゲット<literal>iqn.2006-02.com.example.iserv:systems</literal>が有効なレコードでなくなった場合は、次のコマンドでこのレコードを削除してください。
   </para>
<screen>sudo iscsiadm -m node -n iqn.2006-02.com.example.iserv:systems \
-p ip:port --op=delete
</screen>
   <important>
    <para>
     このオプションでは、確認のメッセージを表示せずにレコードを削除するため、使用する際には細心の注意を払うようにしてください。
    </para>
   </important>
   <para>
    検出したすべてのターゲットのリストを取得するには、<command>sudo iscsiadm -m node</command>コマンドを実行します。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.iscsi.installation">
  <title>インストール時のiSCSIディスクの使用</title>

  <para>
   iSCSI対応のファームウェアを使用している場合は、x86_64およびIBM POWERの各アーキテクチャ上のiSCSIディスクからのブートがサポートされています。
  </para>

  <para>
   インストール時にiSCSIディスクを使用するには、次のパラメータをブートオプション行に追加する必要があります。
  </para>

<screen>withiscsi=1</screen>

  <para>
   インストール中に、インストールプロセスで使用するiSCSIディスクをシステムに接続するオプションが記載された、追加の画面が表示されます。
  </para>
 </sect1>
  
 <sect1 xml:id="sec.iscsi.unmap">
   <title>iSCSI UNMAPサポートの確認</title>
   <remark>toms 2015-09-18: FATE#316345</remark>
   <para>UNMAPコマンドは、<link xlink:href="http://en.wikipedia.org/wiki/Thin_provisioning">シンプロビジョニング</link>をサポートするためにSCSIによって使用されます。詳しくは、<link xlink:href="http://www.t10.org/cgi-bin/ac.pl?t=f&amp;f=sbc3r29.pdf">SBC-3資料、29版</link>を参照してください。</para>
    <para>UNMAPコマンドにより、SCSIターゲットは仮想ディスクインタフェースを提示できます。各フロントエンド仮想ディスクブロックは、実際の物理ディスクブロックにマップされている場合もあれば、されていない場合もあります。(テープ装置にも動作しますが、ここでは取り上げません。)</para>
    <para>この方式を使用して、ターゲットは、たとえば1TBのディスクを提示できますが、実際のストレージは10GBに過ぎません。このディスクのフロントエンドの任意のブロックにシステムが最初に書き込むとき、実バックエンドディスクブロックが割り振られて、書き込まれます。ディスクインテリジェンスにより、どのフロントエンドブロックがバックエンドブロックに接続されているか(割り振り済みか)を追跡できます。</para>
    <para>この場合、通常、ディスクは、すべてのブロックに<quote>deallocated</quote>のマークが付けられて(実物理ブロックにマップされていない)作成されます。</para>
   <para>ディスクブロックが使用されると、<quote>allocated</quote>のマークが付きます。</para>
    <para>一度使用されたブロックの割り振りを解除する方法は2つあります。<command>SCSI WRITE_SAME</command>コマンドを使用する方法と、SCSI UNMAPコマンドを使用する方法です。</para>
    <para>このセクションでは、SCSI UNMAPコマンドのテストを取り上げます。WRITE_SAMEコマンドのテストにも役立つでしょう。</para>

   <sect2>
     <title>要件</title>
     <para>この方法では、次のものが必要になります。</para>
     <itemizedlist>
       <listitem>
          <para>iSCSIターゲット(TUT - テスト時のターゲット)、Linuxホストで稼働中</para>
       </listitem>
       <listitem>
         <para>そのホストにインストールされているopen-iscsiイニシエータ</para>
       </listitem>
       <listitem>
         <para>sg3ツール</para>
       </listitem>
     </itemizedlist>
   </sect2>
   
   <sect2>
     <title>ターゲットセットアップ</title>
     <para>UNMAPを使用して作業するには、ターゲットセットアップとして以下を実行します。</para>
     <procedure>
       <step>
         <para>次のようにして <package>tgt</package> パッケージをインストールします。</para>
         <screen><prompt>root # </prompt><command>zypper</command> in tgt</screen>
       </step>
       <step>
          <para>環境設定ファイル、<filename>/etc/tgt/targets.conf</filename>を次に変更します。</para>
         <screen>default-driver iscsi
ignore-errors yes
include /etc/tgt/conf.d/*.conf</screen>
       </step>
       <step>
          <para>次の内容で<filename>/etc/tgt/test.conf</filename>ファイルを作成します。</para>
         <screen>&lt;target iqn.2001-04.net.gonzoleeman:test.disk.laptop.002&gt;
    backing-store /alt2/big_disc_file.tgt
    vendor_id LeeMan
    thin_provisioning 1
&lt;/target&gt;</screen>
          <para><literal>thin_provisioning</literal>行が、UNMAPコマンドのサポートを有効にするために必要なことに注意してください。</para>
          <remark>lee 2015-09-18: Also NOTE that this file is on an ext4
            filesystem. I am not sure if this matters.</remark>
       </step>
       <step>
         <para>バックエンドファイル、<filename>/alt/big_disc_file.tgt</filename> を<command>tgtimg</command>コマンドを使用して設定します。</para>
         <screen><prompt>root # </prompt><command>tgtimg</command> --op new --device-type disk --type disk \
       --size 1G --file /alt2/big_disc_file.tgt</screen>
       </step>
       <step>
         <para>バックエンドターゲットデーモンを起動します。</para>
         <screen><prompt>root # </prompt><command>rcrgtd</command> start</screen>
       </step>
       <step>
         <para>コマンドライン、または<filename>/var/log/messages</filename>にエラーメッセージがないことを確認します<remark>toms 2015-09-18:
         Does it really write to /var/log/messages or is systemd
         used?</remark>。
         </para>
       </step>
     </procedure>
   </sect2>
   
   <sect2>
     <title>イニシエータセットアップ</title>
     <para>UNMAPを使用して作業するには、イニシエータセットアップとして以下を実行します。</para>
     <procedure>
       <step>
         <para>最新の <package>open-iscsi</package> パッケージをインストールします。</para>
         <screen><prompt>root # </prompt><command>zypper</command> in open-iscsi</screen>
       </step>
       <step>
         <para><systemitem class="daemon">systemd</systemitem>を使用して、すべての関連サービスを始動します。</para>
         <screen><prompt>root # </prompt><command>systemctl</command> start iscsid.socket
<prompt>root # </prompt><command>systemctl</command> start iscsid.service
<prompt>root # </prompt><command>systemctl</command> start iscsi.service</screen>
       </step>
       <step>
         <para>パッケージ、 <package>sg3</package> がインストールされているかどうか確認します。</para>
       </step>
     </procedure>
   </sect2>
   
   <sect2>
     <title>イニシエータのターゲットへの接続</title>
     <para/>
     <screen><prompt>root # </prompt><command>iscsiadm</command> -m discovery -t st -p 192.168.20.2 -I default -l
...
192.168.20.2:3260,1 iqn.2001-04.net.gonzoleeman:test.disk.laptop.002
Logging in to [iface: default, target: iqn.2001-04.net.gonzoleeman:test.disk.laptop.002, portal: 192.168.20.2,3260] (multiple)
Login to [iface: default, target: iqn.2001-04.net.gonzoleeman:test.disk.laptop.002, portal: 192.168.20.2,3260] successful.
<prompt>root # </prompt><command>ls</command> /dev/sd?
/dev/sda  /dev/sdb  /dev/sdc</screen>
      <para><filename>/dev/sdc</filename>が追加されていることが前提であり、<command>sg_inq</command>を使用して確認します。</para>
     <screen><prompt>root # </prompt><command>sg_inq</command> /dev/sdc
standard INQUIRY:
  PQual=0  Device_type=0  RMB=0  version=0x05  [SPC-3]
  [AERC=0]  [TrmTsk=1]  NormACA=0  HiSUP=0  Resp_data_format=2
  SCCS=0  ACC=0  TPGS=0  3PC=0  Protect=0  [BQue=0]
  EncServ=0  MultiP=0  [MChngr=0]  [ACKREQQ=0]  Addr16=0
  [RelAdr=0]  WBus16=0  Sync=0  Linked=0  [TranDis=0]  CmdQue=1
  [SPI: Clocking=0x0  QAS=0  IUS=0]
    length=66 (0x42)   Peripheral device type: disk
 Vendor identification: LeeMan
 Product identification: VIRTUAL-DISK
 Product revision level: 0001
 Unit serial number:                               beaf11</screen>
   </sect2>
   
   <sect2>
     <title>SCSI UNMAPコマンドのテスト</title>
      <para>UNMAPコマンドをテストするには、以下の手順が必要です。</para>
     <procedure>
       <step>
          <para><xref linkend="sec.iscsi.unmap.verify" xrefstyle="select:title nopage"/>、<command>sq_vpd</command>を使用</para>
       </step>
       <step>
         <para><xref linkend="sec.iscsi.unmap.writeblock" xrefstyle="select:title nopage"/>、<command>dd</command>を使用</para>
       </step>
       <step>
         <para><xref linkend="sec.iscsi.unmap.verifyblockmapped" xrefstyle="select:title nopage"/>、<command>sq_get_lba_status</command>を使用
         </para>
       </step>
       <step>
         <para><xref linkend="sec.iscsi.unmap.unmapblock" xrefstyle="select:title nopage"/>、<command>sg_unmap</command>を使用</para>
       </step>
       <step>
         <para><xref linkend="sec.iscsi.unmap.verifyunmap" xrefstyle="select:title nopage"/>、<command>sq_get_lba_status</command>を使用</para>
       </step>
     </procedure>
     
     <sect3 xml:id="sec.iscsi.unmap.verify">
       <title>UNMAPがサポートされていることの確認</title>
       <para><command>sg_vpd</command>コマンドにより、UNMAPがサポートされていることを確認します。</para>
       <screen><prompt>root # </prompt><command>sg_vpd</command> -p 0xb2 /dev/sdc
Logical block provisioning VPD page (SBC):
  Unmap command supported (LBPU): 1
  Write same (16) with unmap bit supported (LBWS): 1
  Write same (10) with unmap bit supported (LBWS10): 1
  Logical block provisioning read zeros (LBPRZ): 1
  Anchored LBAs supported (ANC_SUP): 0
  Threshold exponent: 0
  Descriptor present (DP): 0
  Provisioning type: 2</screen>
       <para><literal>Unmap command supported</literal>が「1」であることに注意します。</para>
        <para>SCSIターゲットによってはこのページが表示されません。その場合、以下が表示されます。</para>
       <screen><prompt>root # </prompt><command>sg_vpd</command> -p 0xb2 /dev/sdc
VPD page=0xb2
fetching VPD page failed</screen>
     </sect3>
     
     <sect3 xml:id="sec.iscsi.unmap.writeblock">
       <title>ブロックへの書き込み</title>
       <para>ブロックへ書き込んで、ブロックがマップされていることを確認します。</para>
       <screen><prompt>root # </prompt><command>dd</command> if=/dev/zero of=/dev/sdc seek=1024 count=8
8+0 records in
8+0 records out
4096 bytes (4.1 kB) copied, 0.000830997 s, 4.9 MB/s</screen>
        <para>ここでは4k(8192 512バイトブロック)バイトのゼロがシンプロビジョニングされたiSCSIターゲットに、オフセット、524288バイト(1024 512バイトブロック)まで書き込まれます。</para>
     </sect3>
     
     <sect3 xml:id="sec.iscsi.unmap.verifyblockmapped">
       <title>このブロックがマップされていることを確認します。</title>
       <para>ブロックが割り振り済み(マップ済み)であることを確認します。</para>
       <screen><prompt>root # </prompt><command>sg_get_lba_status</command> -l 1024 /dev/sdc
descriptor LBA: 0x0000000000000400  blocks: 16776192  mapped</screen>
        <para>一度にマップまたはマップ解除される実際のブロック数は、ターゲットによって異なることに注意してください。この場合は、ターゲットに割り振られたのは16MBです。</para>
     </sect3>
     
     <sect3 xml:id="sec.iscsi.unmap.unmapblock">
       <title>ブロックのマップ解除</title>
       <para>以下によってブロックのマップを解除します。</para>
       <screen><prompt>root # </prompt><command>sg_unmap</command> -v -l 1024 -n 8 /dev/sdc 
    unmap cdb: 42 00 00 00 00 00 00 00 18 00</screen>
     </sect3>
     
     <sect3 xml:id="sec.iscsi.unmap.verifyunmap">
       <title>UNMAPが正常に動作したことを確認します。</title>
       <para>最後に、ブロックのマップが解除されたかどうか、再度確認します。</para>
       <screen><prompt>root # </prompt><command>sg_get_lba_status</command> -l 1024 /dev/sdc
descriptor LBA: 0x0000000000000400  blocks: 8  deallocated</screen>
       <para>この例のターゲットパスを示します。</para>
        <para>ターゲットが、指定した8ブロックのみの割り振りを解除したことに注意してください。この8ブロックをさらに調べると(これ以上は必要ありませんが、興味深いことがわかります)、以前に割り振られたチャンクの多くがまだ残っていることがわかります。</para>
       <screen><prompt>root # </prompt><command>sg_get_lba_status</command> -l 1032 /dev/sdc
descriptor LBA: 0x0000000000000408  blocks: 16776184  mapped</screen>
     </sect3>
   </sect2>
 </sect1> 
 
 <sect1 xml:id="sec.iscsi.trouble">
  <title>iSCSIのトラブルシューティング</title>

  <para>
   本項では、iSCSIターゲットとiSCSIイニシエータに関するいくつかの既知の問題と、考えられる解決策について説明します。
  </para>

  <sect2 xml:id="sec.iscsi.trouble.no_service">
   <title>iSCSI LIOターゲットサーバにターゲットLUNをセットアップする際のポータルエラー</title>
   <para>
    iSCSI LIOターゲットグループの追加または編集を行う際に、次のエラーが発生する:
   </para>
<screen>Problem setting network portal <replaceable>ip_address</replaceable>:3260</screen>
   <para>
    <filename>/var/log/YasT2/y2log</filename>ログファイルに、次のエラーが含まれている:
   </para>
<screen>find: `/sys/kernel/config/target/iscsi': No such file or directory</screen>
   <para>
    この問題は、iSCSI LIOターゲットサーバソフトウェアがその時点で実行中ではない場合に発生します。この問題を解決するには、YaSTを終了して、コマンドラインで手動で<command>systemctl start target</command>を実行してiSCSI LIOを起動し、再試行します。
   </para>
   <para>
    次のように入力して、<command>configfs</command>、<command>iscsi_target_mod</command>、および<command>target_core_mod</command>がロードされているかどうかチェックすることもできます。サンプルの応答を示しています。
   </para>
<screen><prompt>tux &gt; </prompt>sudo lsmod | grep iscsi
iscsi_target_mod      295015  0
target_core_mod       346745  4
iscsi_target_mod,target_core_pscsi,target_core_iblock,target_core_file
configfs               35817  3 iscsi_target_mod,target_core_mod
scsi_mod              231620  16
iscsi_target_mod,target_core_pscsi,target_core_mod,sg,sr_mod,mptctl,sd_mod,
scsi_dh_rdac,scsi_dh_emc,scsi_dh_alua,scsi_dh_hp_sw,scsi_dh,libata,mptspi,
mptscsih,scsi_transport_spi</screen>
  </sect2>

  <sect2 xml:id="sec.iscsi.trouble.not_visible">
   <title>iSCSI LIOターゲットが他のコンピュータで表示されない</title>
   <para>
    ターゲットサーバでファイアウォールを使用している場合は、他のコンピュータでiSCSI LIOターゲットを表示できるようにするために使用するiSCSIポートを開く必要があります。詳細については、<xref linkend="sec.iscsi.target.start"/>を参照してください。
   </para>
  </sect2>

  <sect2 xml:id="sec.iscsi.trouble.package_loss">
   <title>iSCSIトラフィックのデータパッケージがドロップされる</title>
   <para>
    ファイアウォールは、過剰にビジーになるとパケットをドロップすることがあります。SUSEファイアウォールのデフォルトは、3分後にパケットをドロップすることです。iSCSIトラフィックのパケットがドロップされていることが分かった場合は、ファイアウォールがビジーになったとき、パケットをドロップする代わりにキューに入れるように、SUSEファイアウォールを設定することができます。
   </para>
  </sect2>

  <sect2 xml:id="sec.iscsi.trouble.lvm">
   <title>LVMでiSCSIボリュームを使用する</title>
   <para>
    iSCSIターゲットでLVMを使用する際には、本項のトラブルシューティングのヒントを使用してください。
   </para>
   <sect3 xml:id="sec.iscsi.trouble.lvm.boot_initiator">
    <title>ブート時にiSCSIイニシエータの検出が行われるかどうかを確認する</title>
    <para>
     iSCSIイニシエータをセットアップする際には、udevがブート時にiSCSIデバイスを検出し、LVMによるそれらのデバイスの使用をセットアップできるように、ブート時の検出を有効にしてください。
    </para>
   </sect3>
   <sect3 xml:id="sec.iscsi.trouble.lvm.boot_target">
    <title>iSCSIターゲットの検出がブート時に起きることを確認する</title>
    <para>
     <filename>udev</filename>は、デバイスのデフォルトセットアップを提供することを思い出してください。デバイスを作成するすべてのアプリケーションがブート時に起動されることを確認してください。これにより、<command>udev</command>がシステム起動時にそれらを認識し、デバイスを割り当てることができます。アプリケーションまたはサービスが後まで起動しない場合は、<command>udev</command>がブート時のように自動的にデバイスを作成することはありません。
    </para>
   </sect3>
  </sect2>

  <sect2 xml:id="sec.iscsi.trouble.mount">
   <title>設定ファイルが手動に設定されていると、iSCSIターゲットがマウントされる</title>
   <para>
    Open-iSCSIは、<filename>/etc/iscsi/iscsid.conf</filename>ファイルで<literal>node.startup</literal>オプションが手動に設定されている場合でも、設定ファイルを手動で変更すれば、起動時にターゲットをマウントできます。
   </para>
   <para>
    <filename>/etc/iscsi/nodes/<replaceable>target_name</replaceable>/<replaceable>ip_address</replaceable>,<replaceable>port</replaceable>/default</filename>ファイルを確認してください。このファイルには、<filename>/etc/iscsi/iscsid.conf</filename>ファイルを上書きする<literal>node.startup</literal>設定が含まれています。YaSTインタフェースを使用してマウントオプションを手動に設定すると、<filename>/etc/iscsi/nodes/<replaceable>target_name</replaceable>/<replaceable>ip_address</replaceable>,<replaceable>port</replaceable>/default </filename>ファイルでも<literal>node.startup = manual</literal>が設定されます。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.iscsi.terminology">
  <title>iSCSI LIOターゲットの用語</title>

  <variablelist>
   <varlistentry>
    <term>backstore</term>
    <listitem>
     <para>
      iSCSIのエンドポイントの基礎となる実際のストレージを提供する、物理的ストレージオブジェクト。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>CDB (command descriptor block))</term>
    <listitem>
     <para>
      SCSIコマンドの標準フォーマット CDBは一般的に6、10、または12バイトの長さですが、16バイトまたは可変長でも構いません。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>CHAP (Challenge Handshake Authentication Protocol)</term>
    <listitem>
     <para>
      ポイントツーポイントプロトコル(PPP)の認証方法で、あるコンピュータのアイデンティティを別のコンピュータに対して確認するために使用します。Link Control Protocol (LCP)によって2台のコンピュータが接続され、CHAPメソッドがネゴシエートされた後、認証者はランダムなチャレンジをピアに送信します。ピアは、チャレンジおよび秘密鍵に依存した、暗号学的にハッシュされたレスポンスを発行します。認証者は、ハッシュされたレスポンスを、予想されるハッシュ値の自身の計算に対して検証し、認証を了承するか、接続を終了します。CHAPは、RFC 1994で定義されています。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>CID (接続識別子)</term>
    <listitem>
     <para>
      イニシエータが生成する16ビットの番号で、2つのiSCSIデバイス間の接続を、一意に識別するもの。この番号は、ログインフェーズの間に提示されます。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>エンドポイント</term>
    <listitem>
     <para>
      iSCSIターゲット名とiSCSI TPG (IQN + Tag)の組み合わせ
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>EUI (extended unique identifier)</term>
    <listitem>
     <para>
      世界中のあらゆるデバイスを一意に識別する、64ビットの番号。フォーマットは、会社ごとに一意である24ビットと、その会社が自社の各デバイスに割り当てる40ビットで構成されます。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>イニシエータ</term>
    <listitem>
     <para>
      SCSIセッションの開始エンド。通常は、コンピュータなどの制御デバイス。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>IPS (Internet Protocol storage)</term>
    <listitem>
     <para>
      IPプロトコルを使用してストレージネットワーク内のデータを移動する、プロトコルまたはデバイスのクラス。FCIP (Fibre Channel over Internet Protocol)、iFCP (Internet Fibre Channel Protocol)、およびiSCSI (Internet SCSI)は、すべてIPSプロトコルの例です。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>IQN (iSCSI qualified name)</term>
    <listitem>
     <para>
      世界中のあらゆるデバイスを一意に識別する、iSCSIの名前形式(たとえば: <filename>iqn.5886.com.acme.tapedrive.sn‐a12345678</filename>)。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>ISID (initiator session identifier)</term>
    <listitem>
     <para>
      イニシエータが生成する48ビットの番号で、イニシエータとターゲット間のセッションを一意に識別するもの。この値はログインプロセスの間に作成され、ログインPDUとともにターゲットに送られます。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>MCS (multiple connections per session)</term>
    <listitem>
     <para>
      iSCSI仕様の一部で、イニシエータとターゲット間での複数のTCP/IP接続を可能にするもの。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>MPIO (multipath I/O)</term>
    <listitem>
     <para>
      サーバとストレージ間でデータが複数の冗長パスをとることができるメソッド。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>ネットワークポータル</term>
    <listitem>
     <para>
      iSCSIエンドポイントおよびIPアドレスとTCP (転送制御プロトコル)ポートの組み合わせ。TCPポート3260が、iSCSIプロトコル用のポート番号です。これは、IANA (Internet Assigned Numbers Authority)により定義されています。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>SAM (SCSI architectural model)</term>
    <listitem>
     <para>
      SCSIの動作を一般的な表記で記載した文書で、異なる種類のデバイスがさまざまなメディア上で通信することを可能にするもの。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>ターゲット</term>
    <listitem>
     <para>
      SCSIセッションの受信側で、通常はディスクドライブ、テープドライブ、スキャナなどのデバイス。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>ターゲットグループ(TG)</term>
    <listitem>
     <para>
      ビューの作成時にすべて同じ扱いを受ける、SCSIターゲットポートのリスト。ビューを作成することで、LUN (論理ユニット番号)のマッピングが容易になります。それぞれのビューエントリが、ターゲットグループ、ホストグループ、およびLUNを指定します。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>ターゲットポート</term>
    <listitem>
     <para>
      iSCSIエンドポイントと、1つ以上のLUNの組み合わせ。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>ターゲットポートグループ(TPG)</term>
    <listitem>
     <para>
      IPアドレスとTCPポート番号のリストで、特定のiSCSIターゲットがどのインタフェースから受信するかを決定するもの。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>ターゲットセッション識別子(TSID)</term>
    <listitem>
     <para>
      ターゲットが生成する 16ビットの番号で、イニシエータとターゲット間のセッションを一意に識別するもの。この値はログインプロセスの間に作成され、ログインレスポンスPDU(プロトコルデータユニット)とともにイニシエータに送られます。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec.iscsi.info">
  <title>追加情報</title>

  <para>
   iSCSIプロトコルは、数年に渡って利用されています。iSCSIとSANソリューションの比較やパフォーマンスのベンチマークは多くのレビューで取り上げられており、ハードウェアソリューションについて説明したドキュメントもあります。open-iscsiの詳細に関する代表的なサイトを以下に示します。
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     <citetitle>Open-iSCSI Project</citetitle> (<link xlink:href="http://www.open-iscsi.org/"/>)
    </para>
   </listitem>
   <listitem>
    <para>
     <citetitle>AppNote: iFolder on Open Enterprise Server Linux Cluster using iSCSI</citetitle> (<link xlink:href="http://www.novell.com/coolsolutions/appnote/15394.html"/>)
    </para>
   </listitem>
  </itemizedlist>

  <para>
   このほか、オンラインマニュアルも利用できます。i<command>scsiadm</command>、<command>iscsid</command>、<filename>ietd.conf</filename>および<command>ietd</command>の各マニュアルページのほか、環境設定ファイルのサンプル<filename> /etc/iscsid.conf</filename>も参照してください。
  </para>
 </sect1>
</chapter>
