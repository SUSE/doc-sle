<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ay_custom_user_scripts.xml" version="5.0" xml:id="createprofile-scripts">
 <title>Custom user scripts</title>

 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>

 <para>
  By adding scripts to the auto-installation process you can customize the
  installation according to your needs and take control in different stages of
  the installation.
 </para>

 

 <para os="slemicro">
  In the auto-installation process, three types of scripts can be executed at
  different points in time during the installation:
 </para>

 <para>
  All scripts need to be in the &lt;scripts&gt; section.
 </para>

 <itemizedlist mark="bullet" spacing="normal">
  <listitem>
   <para>
    <literal>pre-scripts</literal> (very early, before anything else really
    happens)
   </para>
  </listitem>
  <listitem>
   <para>
    <literal>postpartitioning-scripts</literal> (after partitioning and
    mounting to <filename>/mnt</filename> but before RPM installation)
   </para>
  </listitem>
  <listitem>
   <para>
    <literal>chroot-scripts</literal> (after the package installation, before
    the first boot)
   </para>
  </listitem>
  
  
 </itemizedlist>

 <sect2 xml:id="pre-install-scripts">
  <title>Pre-install scripts</title>
  <para>
   Executed before YaST does any real change to the system (before
   partitioning and package installation but after the hardware detection).
  </para>
  <para>
   You can use a pre-script to modify your control file and let AutoYaST reread it.
   Find your control file in <filename>/tmp/profile/autoinst.xml</filename>.
   Adjust the file and store the modified version in
   <filename>/tmp/profile/modified.xml</filename>. AutoYaST will read the modified
   file after the pre-script finishes.
  </para>
  <para>
   It is also possible to modify the storage devices in your pre-scripts. For
   example, you can create new partitions or change the configuration of
   certain technologies like multipath. AutoYaST always inspects the storage
   devices again after executing all the pre-install scripts.
  </para>
  <note>
   <title>Pre-install scripts with confirmation</title>
   <para>
    Pre-scripts are executed at an early stage of the installation. This means
    if you have requested to confirm the installation, the pre-scripts will be
    executed before the confirmation screen shows up
    (<literal>profile/install/general/mode/confirm</literal>).
   </para>
  </note>
  <note>
   <title>Pre-install and Zypper</title>
   <para>
    To call <emphasis>Zypper</emphasis> in the pre-install script you will need
    to set the environment variable
    <emphasis>ZYPP_LOCKFILE_ROOT="/var/run/autoyast"</emphasis> to prevent
    conflicts with the running YaST process.
   </para>
  </note>
  <para>
   Pre-Install Script elements must be placed as follows:
  </para>
<screen>&lt;scripts&gt;
  &lt;pre-scripts config:type="list"&gt;
    &lt;script&gt;
      ...
    &lt;/script&gt;
  &lt;/pre-scripts&gt;
&lt;/scripts&gt;</screen>
 </sect2>

 <sect2 xml:id="postpartitioning-install-scripts">
  <title>Post-partitioning scripts</title>
  <para>
   Executed after YaST has done the partitioning and written
   <filename>/etc/fstab</filename>. The empty system is already mounted to
   <filename>/mnt</filename>.
  </para>
  <para>
   Post-partitioning script elements must be placed as follows:
  </para>
<screen>&lt;scripts&gt;
  &lt;postpartitioning-scripts config:type="list"&gt;
    &lt;script&gt;
      ...
    &lt;/script&gt;
  &lt;/postpartitioning-scripts&gt;
&lt;/scripts&gt;</screen>
 </sect2>

 <sect2 xml:id="chroot-scripts">
  <title>Chroot environment scripts</title>
  <para>
   Chroot scripts are executed before the machine reboots for the first
   time. You can execute chroot scripts before the installation chroots
   into the installed system and configures the boot loader, or you can
   execute a script after the chroot into the installed system has
   happened (look at the <literal>chrooted</literal> parameter for that).
  </para>
  <para>
   Chroot Environment script elements must be placed as follows:
  </para>
<screen>&lt;scripts&gt;
  &lt;chroot-scripts config:type="list"&gt;
    &lt;script&gt;
      ...
    &lt;/script&gt;
  &lt;/chroot-scripts&gt;
&lt;/scripts&gt;</screen>
 </sect2>

 

 

 <sect2 xml:id="scripts-syntax">
  <title>Script XML representation</title>
  
  <para os="slemicro">
   Most of the XML elements described below can be used for all the script
   types described above.
  </para>
  
  <variablelist>
   <title>Script XML representation</title>
   <varlistentry>
    <term><literal>location</literal></term>
    <listitem>
     <para>
      Define a location from where the script gets fetched. Locations can be
      the same as for the control file (HTTP, FTP, NFS, etc.). Additionally a
      relative URL can be used that defines a path relative to the directory
      with the control file, using the syntax
      <literal>relurl://script.sh</literal>.
     </para>
<screen>&lt;location&gt;http://10.10.0.1/myPreScript.sh&lt;/location&gt;</screen>
     <para>
      Either <literal>location</literal> or <literal>source</literal> must be
      defined.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>source</literal></term>
    <listitem>
     <para>
      The script itself (source code), encapsulated in a CDATA tag. If you do
      not want to put the whole shell script into the XML control file, refer
      to the location parameter.
     </para>
<screen>&lt;source&gt;
&lt;![CDATA[
echo "Testing the pre script" &gt; /tmp/pre-script_out.txt
]]&gt;
&lt;/source&gt;</screen>
     <para>
      Either <literal>location</literal> or <literal>source</literal> must be
      defined.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>interpreter</literal></term>
    <listitem>
     <para>
      Specify the interpreter that must be used for the script. Any interpreter
      available in the given environment can be specified. It is possible to
      provide a full path to the interpreter, including parameters. There are
      also deprecated keywords interpreter "shell", "perl" and "python" that
      are supported by the <literal>debug</literal> flag.
     </para>
<screen>&lt;interpreter&gt;/bin/bash -x&lt;/interpreter&gt;</screen>
     <para>
      Optional; default is <literal>shell</literal>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>file name</literal></term>
    <listitem>
     <para>
      The file name of the script. It will be stored in a temporary directory
      under <filename>/tmp</filename>.
     </para>
<screen>&lt;filename&gt;myPreScript5.sh&lt;/filename&gt;</screen>
     <para>
      Optional; default is the type of the script (pre-scripts in this case).
      If you have more than one script, you should define different names for
      each script. If <literal>filename</literal> is not defined and
      <literal>location</literal> is defined, the file name from the location
      path will be used.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>feedback</literal></term>
    <listitem>
     <para>
      If this boolean is <literal>true</literal>, output and error messages of
      the script (STDOUT and STDERR) will be shown in a pop-up. The user needs
      to confirm them via the OK button.
     </para>
<screen>&lt;feedback config:type="boolean"&gt;true&lt;/feedback&gt;</screen>
     <para>
      Optional; default is <literal>false</literal>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>feedback_type</literal></term>
    <listitem>
     <para>
      This can be <literal>message</literal>, <literal>warning</literal> or
      <literal>error</literal>. Set the timeout for these pop-ups in the
      &lt;report&gt; section.
     </para>
<screen>&lt;feedback_type&gt;warning&lt;/feedback_type&gt;</screen>
     <para>
      Optional; if missing, an always-blocking pop-up is used.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>debug</literal></term>
    <listitem>
     <para>
      If this is <literal>true</literal>, every single line of a shell script
      is logged. Perl scripts are run with warnings turned on. This only works
      for the deprecated keyword <literal>interpreter</literal>. For other
      languages, give the path to the interpreter as a parameter in the
      <literal>interpreter</literal> value, for example
      "&lt;interpreter&gt;ruby -w&lt;/interpreter&gt;".
     </para>
<screen>&lt;debug config:type="boolean"&gt;true&lt;/debug&gt;</screen>
     <para>
      Optional; default is <literal>true</literal>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>notification</literal></term>
    <listitem>
     <para>
      This text will be shown in a pop-up for the time the script is running in
      the background.
     </para>
<screen>&lt;notification&gt;Please wait while script is running...&lt;/notification&gt;</screen>
     <para>
      Optional; if not configured, no notification pop-up will be shown.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>param-list</literal></term>
    <listitem>
     <para>
      It is possible to specify parameters given to the script being called.
      You may have more than one <literal>param</literal> entry. They are
      concatenated by a single space character on the script command line. If
      any shell quoting should be necessary (for example to protect embedded
      spaces) you need to include this.
     </para>
<screen>&lt;param-list config:type="list"&gt;
  &lt;param&gt;par1&lt;/param&gt;
  &lt;param&gt;par2 par3&lt;/param&gt;
  &lt;param&gt;"par4.1 par4.2"&lt;/param&gt;
&lt;/param-list&gt;</screen>
     <para>
      Optional; if not configured, no parameters get passed to script.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>rerun</literal></term>
    <listitem>
     <para>
      A script is only run once. Even if you use <literal>ayast</literal>_setup
      to run an XML file multiple times, the script is only run once. Change
      this default behavior by setting this boolean to <literal>true</literal>.
     </para>
<screen>&lt;rerun config:type="boolean"&gt;true&lt;/rerun&gt;</screen>
     <para>
      Optional; default is <literal>false</literal>, meaning that scripts only
      run once.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><literal>chrooted</literal></term>
    <listitem>
     <para>
      During installation, the new system is mounted at
      <filename>/mnt</filename>. If this parameter is set to
      <literal>false</literal>, AutoYaST does not run <command>chroot</command> and
      does not install the boot loader at this stage. If the parameter is set
      to <literal>true</literal>, AutoYaST performs a <command>chroot</command>
      into <filename>/mnt</filename> and installs the boot loader. The result
      is that to change anything in the newly-installed system, you no longer
      need to use the <filename>/mnt</filename> prefix.
     </para>
<screen>&lt;chrooted config:type="boolean"&gt;true&lt;/chrooted&gt;</screen>
     <para>
      Optional; default is <literal>false</literal>. This option is only
      available for chroot environment scripts.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect2>

 
</sect1>
