<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="xen_host_network.xml" version="5.0" xml:id="cha-xen-network">
  
  <title>虚拟网络</title>
  <info>
    <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
      <dm:bugtracker/>
      <dm:translation>yes</dm:translation>
    </dm:docmanager>
  </info>
  <para>
    VM Guest 系统需要通过特定的方式来与其他 VM Guest 系统或本地网络通讯。用于连接 VM Guest 系统的网络接口由一个分离式设备驱动程序构成，也就是说，任何虚拟以太网设备在 Dom0 中都有一个对应的网络接口。此接口设置为访问 Dom0 中运行的虚拟网络。<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 的系统配置中全面集成了桥接式虚拟网络，您可以通过 YaST 配置该网络。
  </para>
  <para>
    安装 Xen VM 主机服务器时，系统会在常规网络配置期间建议一种桥接式网络配置。用户可以选择在安装期间更改配置，并可根据本地需求对其进行自定义。
  </para>
  <para>
    如果需要，可以在执行默认的物理服务器安装后，使用 YaST 中的<systemitem>Install Hypervisor and
    Tools</systemitem>模块来安装 Xen VM 主机服务器。此模块会使系统做好托管虚拟机的准备，包括调用默认网桥功能的建议。
  </para>
  <para>
    如果使用 <systemitem>rpm</systemitem> 或 <systemitem>zypper</systemitem> 手动安装了 Xen VM 主机服务器所需的软件包，则其余的系统配置需要由管理员手动完成，或者通过 YaST 完成。
  </para>
  <para>
    <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 中默认不使用 Xen 提供的网络脚本。这些脚本仅供参考，并且已禁用。<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 中使用的网络配置通过 YaST 系统配置完成，该系统配置类似于 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 中的网络接口配置。
  </para>
  <para>
    有关管理网桥的更多一般信息，请参见<xref linkend="libvirt-networks-bridged"/>。
  </para>
  <sect1 xml:id="sec-xen-vdevices">
    <title>Guest 系统的网络设备</title>

    

    

    <para>
      Xen 超级管理程序可以提供不同类型的网络接口来连接 VM Guest 系统。首选网络设备应该是半虚拟化网络接口。此类网络接口的系统要求最低，却能实现最高的传输速率。最多可为每个 VM Guest 提供八个网络接口。
    </para>

    <para>
      无法感知半虚拟化硬件的系统可能无法使用此方案。有多个模拟网络接口可用于将系统连接到只能以全虚拟化模式运行的网络。您可以自行选用以下模拟产品：
    </para>

    <itemizedlist mark="bullet" spacing="normal">
      <listitem>
        <para>
          Realtek 8139 (PCI)。这是默认的模拟网卡。
        </para>
      </listitem>
      <listitem>
        <para>
          AMD PCnet32 (PCI)
        </para>
      </listitem>
      <listitem>
        <para>
          NE2000 (PCI)
        </para>
      </listitem>
      <listitem>
        <para>
          NE2000 (ISA)
        </para>
      </listitem>
      <listitem>
        <para>
          Intel e100 (PCI)
        </para>
      </listitem>
      <listitem>
        <para>
          Intel e1000 及其衍生产品 e1000-82540em、e1000-82544gc 和 e1000-82545em (PCI)
        </para>
      </listitem>
    </itemizedlist>

    <para>
      以上网络接口全部都是软件接口。由于每个网络接口都必须具有唯一的 MAC 地址，因此已向这些接口可以使用的 Xensource 指派了一个地址范围。
    </para>

    <tip>
      <title>虚拟网络接口和 MAC 地址</title>
      <para>
        虚拟化环境中的默认 MAC 地址配置会创建类似于 00:16:3E:xx:xx:xx 的随机 MAC 地址。一般情况下，可用 MAC 地址的数量应该足够大才能获得唯一地址。但是，如果您的安装规模非常大，或者要确保随机 MAC 地址指派不会造成问题，您也可以手动指派这些地址。
      </para>
    </tip>

    <para>
      进行调试或系统管理时，知道 Dom0 中的哪个虚拟接口连接到正在运行的 Guest 中的哪个以太网设备可能很有帮助。可以从 Dom0 中的设备名称获得此信息。所有虚拟设备都遵循命名规则 <literal>vif&lt;domain
      number&gt;.&lt;interface_number&gt;</literal>。
    </para>

    <para>
      例如，在 Dom0 中，ID 为 5 的 VM Guest 的第三个接口 (eth2) 的设备名称是 <literal>vif5.2</literal>。要获取所有可用接口的列表，请运行 <command>ip a</command> 命令。
    </para>

    <para>
      设备名称不包含有关此接口连接到哪个网桥的任何信息，但 Dom0 中提供了此信息。要大致了解有关哪个接口连接到哪个网桥的信息，请运行 <command>bridge link</command> 命令。输出可能如下所示：
    </para>

<screen><prompt>&gt; </prompt><command>sudo</command> bridge link
2: eth0 state DOWN : &lt;NO-CARRIER,BROADCAST,MULTICAST,SLAVE,UP&gt; mtu 1500 master br0
3: eth1 state UP : &lt;BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP&gt; mtu 1500 master br1
</screen>

    <para>
      此示例中配置了三个网桥：<literal>br0</literal>、<literal>br1</literal> 和 <literal>br2</literal>。当前为 <literal>br0</literal> 和 <literal>br1</literal> 各添加了一个真实的以太网设备，分别是 <literal>eth0</literal> 和 <literal>eth1</literal>。
    </para>
  </sect1>
  <sect1 xml:id="sec-xen-net-host-route">
    <title>Xen 中基于主机的路由</title>

    <para>
      可以将 Xen 设置为在控制 Dom0 中使用基于主机的路由，不过，YaST 目前还不能很好地支持此设置，需要手动对配置文件进行大量的编辑才能使用此设置。因此，此任务需要由高级管理员来完成。
    </para>

    <para>
      仅当使用固定 IP 地址时，以下配置才起作用。在此过程中不能使用 DHCP，因为 VM Guest 和 VM 主机服务器系统都必须知道 IP 地址。
    </para>

    <para>
      要创建路由式 Guest，最简单的方法就是将网络从桥接网络更改为路由网络。要执行以下过程，必须先安装一个使用桥接网络的 VM Guest。例如，VM 主机服务器名为 earth，IP 为 192.168.1.20；VM Guest 名为 alice，IP 为 192.168.1.21。
    </para>

    <procedure xml:id="proc-xen-network-route-ipv4">
      <title>配置路由式 IPv4 VM Guest</title>
      <step>
        <para>
          确保 alice 已关机。使用 <systemitem>xl</systemitem> 命令关机并检查。
        </para>
      </step>
      <step>
        <para>
          在 VM 主机服务器 earth 上准备网络配置：
        </para>
        <substeps performance="required">
          <step>
            <para>
              创建一个用于路由流量的热插拔接口。为此，请创建包含以下内容的 <filename>/etc/sysconfig/network/ifcfg-alice.0</filename> 文件：
            </para>
<screen>NAME="Xen guest alice"
BOOTPROTO="static"
STARTMODE="hotplug"
     </screen>
          </step>
          <step>
            <para>
              确保已启用 IP 转发：
            </para>
            <substeps>
              <step>
                <para>
                  在 YaST 中，转到<menuchoice><guimenu>网络设置</guimenu><guimenu>路由</guimenu></menuchoice>。
                </para>
              </step>
              <step>
                <para>
                  进入<guimenu>路由</guimenu>选项卡，激活<guimenu>启用 IPv4 转发</guimenu>和<guimenu>启用 IPv6 转发</guimenu>选项。
                </para>
              </step>
              <step>
                <para>
                  确认设置并退出 YaST。
                </para>
              </step>
            </substeps>
          </step>
          <step>
            <para>
              将以下配置应用于 <systemitem class="daemon">firewalld</systemitem>：
            </para>
            <itemizedlist mark="bullet" spacing="normal">
              <listitem>
                <para>
                  将 alice.0 添加到公共区域中的设备：
                </para>
<screen><prompt>&gt; </prompt><command>sudo</command> firewall-cmd --zone=public --add-interface=alice.0</screen>
              </listitem>
              <listitem>
                <para>
                  告知防火墙要转发哪个地址：
                </para>
<screen><prompt>&gt; </prompt><command>sudo</command> firewall-cmd --zone=public \
--add-forward-port=port=80:proto=tcp:toport=80:toaddr="192.168.1.21/32,0/0"</screen>
              </listitem>
              <listitem>
                <para>
                  使运行时配置更改永久生效：
                </para>
<screen><prompt>&gt; </prompt><command>sudo</command> firewall-cmd --runtime-to-permanent</screen>
              </listitem>
            </itemizedlist>
          </step>
          <step>
            <para>
              将一个静态路由添加到 alice 的接口。为此，请将以下行添加到 <filename>/etc/sysconfig/network/routes</filename> 的末尾：
            </para>
<screen>192.168.1.21  -  -  alice.0</screen>
          </step>
          <step>
            <para>
              为确保 VM 主机服务器连接的交换机和路由器知道路由接口，请在 earth 上激活 <literal>proxy_arp</literal>。将以下行添加到 <filename>/etc/sysctl.conf</filename> 中：
            </para>
<screen>net.ipv4.conf.default.proxy_arp = 1
net.ipv4.conf.all.proxy_arp = 1</screen>
          </step>
          <step>
            <para>
              使用以下命令激活所有更改：
            </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl restart systemd-sysctl wicked</screen>
          </step>
        </substeps>
      </step>
      <step>
        <para>
          按照<xref linkend="sec-xen-manage-xl"/>中所述，通过更改 alice 的 vif 接口配置继续完成 VM Guest 的 Xen 配置。对配置过程中生成的文本文件进行以下更改：
        </para>
        <substeps performance="required">
          <step>
            <para>
              去除以下代码段
            </para>
<screen>bridge=br0</screen>
          </step>
          <step>
            <para>
              添加以下代码段：
            </para>
<screen>vifname=vifalice.0</screen>
            <para>
              或
            </para>
<screen>vifname=vifalice.0=emu</screen>
            <para>
              （针对全虚拟化域）。
            </para>
          </step>
          <step>
            <para>
              按如下所示更改用于设置接口的脚本：
            </para>
<screen>script=/etc/xen/scripts/vif-route-ifup</screen>
          </step>
          <step>
            <para>
              激活新配置并启动 VM Guest。
            </para>
          </step>
        </substeps>
      </step>
      <step>
        <para>
          其余配置任务必须在 VM Guest 内部完成。
        </para>
        <substeps performance="required">
          <step>
            <para>
              使用 <command>xl
              console</command> <replaceable>DOMAIN</replaceable> 打开与 VM Guest 连接的控制台，然后登录。
            </para>
          </step>
          <step>
            <para>
              检查 Guest IP 是否设置为 192.168.1.21。
            </para>
          </step>
          <step>
            <para>
              为 VM Guest 提供用于连接 VM 主机服务器的主机路由和默认网关。为此，请将以下行添加到 <filename>/etc/sysconfig/network/routes</filename> 中：
            </para>
<screen>192.168.1.20 - - eth0
default 192.168.1.20 - -
     </screen>
          </step>
        </substeps>
      </step>
      <step>
        <para>
          最后，测试从 VM Guest 到外部世界的网络连接，以及从网络到 VM Guest 的连接。
        </para>
      </step>
    </procedure>
  </sect1>
  <sect1 xml:id="sec-xen-net-masquerade">
    <title>创建掩蔽网络设置</title>

    <para>
      创建掩蔽网络设置与创建路由设置的过程相似。不过，创建掩蔽网络设置时不需要 proxy_arp，并且某些防火墙规则不同。要为 IP 地址为 192.168.100.1 并且其主机在 <literal>br0</literal> 上有自己的外部接口的 Guest（名为 dolly）创建掩蔽网络，请执行以下操作。为了简化配置，此处仅将已安装的 Guest 修改为使用掩蔽网络：
    </para>

    <procedure>
      <title>配置掩蔽式 IPv4 VM Guest</title>
      <step>
        <para>
          使用 <command>xl shutdown</command>
          <replaceable>DOMAIN</replaceable> 关闭 VM Guest 系统。
        </para>
      </step>
      <step>
        <para>
          在 VM 主机服务器上准备网络配置：
        </para>
        <substeps performance="required">
          <step>
            <para>
              创建一个用于路由流量的热插拔接口。为此，请创建包含以下内容的 <filename>/etc/sysconfig/network/ifcfg-dolly.0</filename> 文件：
            </para>
<screen>NAME="Xen guest dolly"
BOOTPROTO="static"
STARTMODE="hotplug"
     </screen>
          </step>
          <step>
            <para>
              编辑文件 <filename>/etc/sysconfig/SuSEfirewall2</filename>，在其中添加以下配置：
            </para>
            <itemizedlist mark="bullet" spacing="normal">
              <listitem>
                <para>
                  将 dolly.0 添加到 FW_DEV_DMZ 中的设备：
                </para>
<screen>FW_DEV_DMZ="dolly.0"</screen>
              </listitem>
              <listitem>
                <para>
                  在防火墙中打开路由：
                </para>
<screen>FW_ROUTE="yes"</screen>
              </listitem>
              <listitem>
                <para>
                  在防火墙中打开掩蔽：
                </para>
<screen>FW_MASQUERADE="yes"</screen>
              </listitem>
              <listitem>
                <para>
                  告知防火墙要掩蔽哪个网络：
                </para>
<screen>FW_MASQ_NETS="192.168.100.1/32"</screen>
              </listitem>
              <listitem>
                <para>
                  从掩蔽例外中去除网络：
                </para>
<screen>FW_NOMASQ_NETS=""</screen>
              </listitem>
              <listitem>
                <para>
                  最后，使用以下命令重启动防火墙：
                </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl restart SuSEfirewall2</screen>
              </listitem>
            </itemizedlist>
          </step>
          <step>
            <para>
              向 dolly 的接口添加一个静态路由。为此，请将以下行添加到 <filename>/etc/sysconfig/network/routes</filename> 的末尾：
            </para>
<screen>192.168.100.1 - - dolly.0</screen>
          </step>
          <step>
            <para>
              使用以下命令激活所有更改：
            </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl restart wicked</screen>
          </step>
        </substeps>
      </step>
      <step>
        <para>
          继续完成 VM Guest 的 Xen 配置。
        </para>
        <substeps performance="required">
          <step>
            <para>
              按照<xref linkend="sec-xen-manage-xl"/>中所述更改 dolly 的 vif 接口配置。
            </para>
          </step>
          <step>
            <para>
              去除下面一项：
            </para>
<screen>bridge=br0</screen>
          </step>
          <step>
            <para>
              添加以下代码段：
            </para>
<screen>vifname=vifdolly.0</screen>
          </step>
          <step>
            <para>
              按如下所示更改用于设置接口的脚本：
            </para>
<screen>script=/etc/xen/scripts/vif-route-ifup</screen>
          </step>
          <step>
            <para>
              激活新配置并启动 VM Guest。
            </para>
          </step>
        </substeps>
      </step>
      <step>
        <para>
          其余配置任务需在 VM Guest 内部完成。
        </para>
        <substeps performance="required">
          <step>
            <para>
              使用 <command>xl
              console</command> <replaceable>DOMAIN</replaceable> 打开与 VM Guest 连接的控制台，然后登录。
            </para>
          </step>
          <step>
            <para>
              检查 Guest IP 是否设置为 192.168.100.1。
            </para>
          </step>
          <step>
            <para>
              为 VM Guest 提供用于连接 VM 主机服务器的主机路由和默认网关。为此，请将以下行添加到 <filename>/etc/sysconfig/network/routes</filename> 中：
            </para>
<screen>192.168.1.20 - - eth0
default 192.168.1.20 - -
     </screen>
          </step>
        </substeps>
      </step>
      <step>
        <para>
          最后，测试从 VM Guest 到外部世界的网络连接。
        </para>
      </step>
    </procedure>
  </sect1>
  
  <sect1 xml:id="sec-xen-net-special">
    <title>特殊配置</title>

    <para>
      在 Xen 中可以使用许多可行的网络配置。以下配置默认未激活：
    </para>

    <sect2 xml:id="sec-xen-net-throttle">
      <title>虚拟网络中的带宽限制</title>
      <para>
        在 Xen 中，您可以限制虚拟 Guest 在访问网桥时可使用的网络传输速率。要配置该限制，需要按照<xref linkend="sec-xen-manage-xl"/>中所述修改 VM Guest 配置。
      </para>
      <para>
        在配置文件中，先搜索连接到虚拟网桥的设备。配置如下所示：
      </para>
<screen>vif = [ 'mac=00:16:3e:4f:94:a9,bridge=br0' ]</screen>
      <para>
        要添加最大传输速率，请按如下所示在配置中添加参数 <systemitem>rate</systemitem>：
      </para>
<screen>vif = [ 'mac=00:16:3e:4f:94:a9,bridge=br0,rate=100Mb/s' ]</screen>
      <para>
        速率单位为 <literal>Mb/s</literal>（每秒兆位数）或 <literal>MB/s</literal>（每秒兆字节数）。在上面的示例中，虚拟接口的最大传输速率为 100 兆位。默认情况下，Guest 与虚拟网桥之间的带宽没有限制。
      </para>
      <para>
        您甚至可以通过指定用于定义信用补充粒度的时段来微调该行为：
      </para>
<screen>vif = [ 'mac=00:16:3e:4f:94:a9,bridge=br0,rate=100Mb/s@20ms' ]</screen>
    </sect2>

    <sect2 xml:id="sec-xen-net-monitor">
      <title>监视网络流量</title>
      <para>
        要监视特定接口上的流量，不妨使用一个实用的小应用程序 <systemitem>iftop</systemitem>，它可在终端中显示当前网络流量。
      </para>
      <para>
        运行 Xen VM 主机服务器时，需要定义受监视接口。Dom0 用来访问物理网络的接口是网桥设备，例如 <systemitem>br0</systemitem>。但在您的系统上可能不是这样。要监视发往物理接口的所有流量，请以 <systemitem class="username">root</systemitem> 身份运行终端并使用以下命令：
      </para>
<screen>iftop -i br0</screen>
      <para>
        要监视特定 VM Guest 的特殊网络接口的网络流量，请提供正确的虚拟接口。例如，要监视 ID 为 5 的域的第一个以太网设备，请使用以下命令：
      </para>
<screen>ftop -i vif5.0</screen>
      <para>
        要退出 <command>iftop</command>，请按 <keycap>Q</keycap> 键。手册页 <command>man 8 iftop</command> 中介绍了更多选项和可行做法。
      </para>
    </sect2>
  </sect1>
</chapter>
