<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="tuning_logfiles.xml" version="5.0" xml:id="cha-tuning-logfiles"> <title>分析和管理系统日志文件</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:bugtracker>
          </dm:bugtracker>
        <dm:translation>yes</dm:translation>
      </dm:docmanager>
    </info>
    <para>
  系统日志文件分析是分析系统时最重要的任务之一。事实上，在对系统进行维护或查错时，第一件事就是要查看系统日志文件。<phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 会自动详细记录系统上发生的几乎一切事件。自从过渡到 <systemitem class="daemon">systemd</systemitem> 之后，内核消息以及已在 <systemitem class="daemon">systemd</systemitem> 中注册的系统服务的消息都将记录在 <systemitem class="daemon">systemd</systemitem> 日记中（请参见<xref linkend="cha-journalctl"/>）。其他日志文件（主要是系统应用程序的日志文件）将以纯文本格式写入，并可使用编辑器或分页器轻松阅读。还可以使用脚本来分析这些文件。这可让您过滤其内容。
 </para>
 <sect1 xml:id="sec-tuning-logfiles-logs">
  <title><filename>/var/log/</filename> 中的系统日志文件</title>

  <para>
   系统日志文件始终位于 <filename>/var/log</filename> 目录下。以下列表提供了在完成默认安装后 <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 中所有系统日志文件的概述。根据您的安装范围，<filename>/var/log</filename> 还会包含此处未列出的其他服务和应用程序中的日志文件。下面所述的某些文件和目录以<quote>占位符</quote>表示，仅当安装相应的应用程序时才会使用它们。大多数日志文件仅对 <systemitem class="username">root</systemitem> 用户可见。
  </para>

  <variablelist>

   <varlistentry>
    <term><filename>apparmor/</filename>
    </term>
    <listitem>
     <para>
      <phrase>AppArmor</phrase> 日志文件。有关 <phrase>AppArmor</phrase> 的详细信息，请参见<xref linkend="part-apparmor"/>。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>audit/</filename>
    </term>
    <listitem>
     <para>
      来自审计框架的日志。有关详细信息，请参见<xref linkend="part-audit"/>。
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><filename>ConsoleKit/</filename>
    </term>
    <listitem>
     <para>
      <systemitem class="daemon">ConsoleKit</systemitem> 守护程序（用于跟踪哪些用户已登录，以及他们如何与计算机交互的守护程序）的日志。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>cups/</filename>
    </term>
    <listitem>
     <para>
      通用 Unix 打印系统 (<systemitem class="daemon">cups</systemitem>) 的访问和错误日志。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>firewall</filename>
    </term>
    <listitem>
     <para>
      防火墙日志。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>gdm/</filename>
    </term>
    <listitem>
     <para>
      来自 GNOME 显示管理器的日志文件。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>krb5/</filename>
    </term>
    <listitem>
     <para>
      来自 Kerberos 网络身份验证系统的日志文件。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>lastlog</filename>
    </term>
    <listitem>
     <para>
      包含每个用户上次登录相关信息的数据库。可使用命令 <command>lastlog</command> 进行查看。有关详细信息，请参见 <command>man 8 lastlog</command>。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>localmessages</filename>
    </term>
    <listitem>
     <para>
      某些引导脚本的日志消息，例如，DHCP 客户端的日志。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>mail*</filename>
    </term>
    <listitem>
     <para>
      邮件服务器（<systemitem class="service">postfix</systemitem>、<systemitem class="service">sendmail</systemitem>）日志。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>messages</filename>
    </term>
    <listitem>
     <para>
      这是所有内核和系统日志消息的默认保存位置，出现问题时应首先查看该位置（以及 <filename>/var/log/warn</filename>）。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>NetworkManager</filename>
    </term>
    <listitem>
     <para>
      NetworkManager 日志文件。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>news/</filename>
    </term>
    <listitem>
     <para>
      来自新闻服务器的日志消息。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>chrony/</filename>
    </term>
    <listitem>
     <para>
      来自网络时间协议守护程序 (<systemitem class="resource">chrony</systemitem>) 的日志。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>pk_backend_zypp*</filename>
    </term>
    <listitem>
     <para>
      PackageKit（使用 <systemitem class="library">libzypp</systemitem> 后端）日志文件。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>samba/</filename>
    </term>
    <listitem>
     <para>
      来自 Samba、Windows SMB/CIFS 文件服务器的日志文件。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>warn</filename>
    </term>
    <listitem>
     <para>
      所有系统警告和错误的日志。出现问题时，应首先查看此位置（以及 <systemitem class="daemon">systemd</systemitem> 日记的输出）。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>wtmp</filename>
    </term>
    <listitem>
     <para>
      所有登录/注销活动<remark>sknorr, 2014-08-21: why was "runlevel changes" commented out here?
Is this a systemd-related change? Should this then be removed entirely?</remark>和远程连接的数据库。可使用命令 <command>last</command> 进行查看。有关详细信息，请参见 <command>man 1 last</command>。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>Xorg.0.log</filename>
    </term>
    <listitem>
     <para>
      X.Org 启动日志文件。如果在启动 X.Org 时出现问题，请参考此文件。来自先前 X.Org 启动的日志文件副本的文件编号为 Xorg.<replaceable>? </replaceable>.log。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>YaST2/</filename>
    </term>
    <listitem>
     <para>
      所有 YaST 日志文件。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>zypp/</filename>
    </term>
    <listitem>
     <para>
      <systemitem class="library">libzypp</systemitem> 日志文件。可参考这些文件获取软件包安装历史。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>zypper.log</filename>
    </term>
    <listitem>
     <para>
      来自命令行安装程序 <command>zypper</command> 的日志。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec-tuning-logfiles-view">
  <title>查看和分析日志文件</title>

  <para>
   要查看日志文件，可以使用任何文本编辑器。此外，还可以使用一个简单的 YaST 模块来查看 YaST 控制中心的<menuchoice> <guimenu>杂项</guimenu>
   <guimenu>系统日志</guimenu> </menuchoice>下提供的系统日志。
  </para>

  <para>
   要在文本控制台中查看日志文件，请使用命令 <command>less</command> 或 <command>more</command>。使用 <command>head</command> 和 <command>tail</command> 可查看日志文件的开头和结尾。要实时查看日志文件的追加项，请使用 <command>tail</command> <option>-f</option>。有关如何使用这些工具的信息，请查看它们的手册页。
  </para>

  <para>
   要在日志文件中搜索字符串或正则表达式，请使用 <command>grep</command>。<command>awk</command> 可用于分析和重新写入日志文件。
  </para>
 </sect1>
 <sect1 xml:id="sec-tuning-logfiles-logrotate">
  <title>使用 <command>logrotate</command> 管理日志文件</title>

  <para>
   <filename>/var/log</filename> 下的日志文件每天增长，很快就会变得非常庞大。<command>logrotate</command> 工具可帮助您管理日志文件及其增长。使用此工具可以自动轮换、去除、压缩和通过邮件发送日志文件。可以定期（每日、每周或每月）或者在超过特定大小时处理日志文件。
  </para>

  <para>
   通常由 <systemitem class="daemon">systemd</systemitem> 每日运行 <command>logrotate</command>，因此只会每日修改一次日志文件。但存在一些例外情况：因超过大小限制而修改日志文件时、如果一天内多次运行 <command>logrotate</command>，或者如果启用 <option>--force</option>。使用 <filename>/var/lib/misc/logrotate.status</filename> 可以了解上次轮换特定文件的时间。
  </para>

  <para>
   <command>logrotate</command> 的主要配置文件是 <filename>/etc/logrotate.conf</filename>。生成日志文件的系统软件包和程序（例如 <systemitem class="resource">apache2</systemitem>）将其自身的配置文件放在 <filename>/etc/logrotate.d/</filename> 目录中。通过 <filename>/etc/logrotate.conf</filename> 添加 <filename>/etc/logrotate.d/</filename> 的内容。
  </para>

  <example xml:id="ex-tuning-logfiles-logrotate-config">
   <title><filename>/etc/logrotate.conf</filename> 的示例</title>
   <para>
    <remark>
     taroth 2017-12-14: for the sake of using the prompt entities
     (<prompt>tux &gt; </prompt> or <prompt role="root">root # </prompt>) consistently in our docs:
     please do not mix several example commands within one screen
     and do not use '#' to refer to an example command - this makes
     it impossible to mark the individual commands with a proper
     prompt
    </remark>
   </para>
<screen># see "man logrotate" for details
# rotate log files weekly
weekly

# keep 4 weeks worth of backlogs
rotate 4

# create new (empty) log files after rotating old ones
create

# use date as a suffix of the rotated file
dateext

# uncomment this if you want your log files compressed
#compress

# comment these to switch compression to use gzip or another
# compression scheme
compresscmd /usr/bin/bzip2
uncompresscmd /usr/bin/bunzip2

# RPM packages drop log rotation information into this directory
include /etc/logrotate.d</screen>
  </example>

  <important>
   <title>避免权限冲突</title>
   <para>
    <systemitem>create</systemitem> 选项会关注 <filename>/etc/permissions*</filename> 中所指定文件的模式和所有权。如果您修改这些设置，请确保不会引发冲突。
   </para>
  </important>



 </sect1>
 <sect1 xml:id="sec-tuning-logfiles-logwatch">
  <title>使用 <command>logwatch</command> 监视日志文件</title>

  <para>
   <command>logwatch</command> 是一个可自定义且可插入的日志监视脚本。它可以分析系统日志、提取重要信息，并以直观易懂的方式显示这些信息。要使用 <command>logwatch</command>，请安装 <systemitem>logwatch</systemitem> 软件包。
  </para>

  <para>
   可在命令行上使用 <command>logwatch</command> 来生成动态报告，或通过 <systemitem class="daemon">cron</systemitem> 来定期创建自定义报告。报告可在屏幕上列显、保存到文件，或通过邮件发送到指定的地址。通过 <systemitem class="daemon">cron</systemitem> 自动生成报告时，后一种做法特别有用。
  </para>

  <para>
   在命令行上，可以告知 <command>logwatch</command> 要针对哪个服务和时间范围生成报告，以及包含信息的详细程度：
  </para>
  
<screen><?dbsuse-fo font-size="7pt"?>

# Detailed report on all kernel messages from yesterday
logwatch --service kernel --detail High --range Yesterday --print

# Low detail report on all sshd events recorded (incl. archived logs)
logwatch --service sshd --detail Low --range All --archives --print

# Mail a report on all smartd messages from May 5th to May 7th to root@localhost
logwatch --service smartd --range 'between 5/5/2005 and 5/7/2005' \
--mailto root@localhost --print
</screen>

  <para>
   <option>--range</option> 选项的语法比较复杂 — 有关细节，请参见 <command>logwatch</command> <option>--range help</option>。使用以下命令获取可查询的所有服务的列表：
  </para>

<screen><prompt>tux &gt; </prompt>ls /usr/share/logwatch/default.conf/services/ | sed 's/\.conf//g'</screen>

  <para>
   <command>logwatch</command> 可自定义程度很高。但通常默认配置便足以满足需求。默认配置文件位于 <filename>/usr/share/logwatch/default.conf/</filename> 下。切勿更改这些文件，因为下一次更新时会再次重写它们。而自定义配置会放入 <filename>/etc/logwatch/conf/</filename>（但您可以使用默认配置文件作为模板）。<filename>/usr/share/doc/packages/logwatch/HOWTO-Customize-LogWatch</filename> 中提供了有关自定义 <command>logwatch</command> 的详细操作指南。存在以下配置文件：
  </para>

  <variablelist>
   <varlistentry>
    <term><filename>logwatch.conf</filename>
    </term>
    <listitem>
     <para>
      主要配置文件。默认版本带有大量注释。可在命令行重写每个配置选项。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>ignore.conf</filename>
    </term>
    <listitem>
     <para>
      过滤掉 <command>logwatch</command> 应全局忽略的所有行。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>services/*.conf</filename>
    </term>
    <listitem>
     <para>
      该服务目录包含了可为其生成报告的每个服务的配置文件。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>logfiles/*.conf</filename>
    </term>
    <listitem>
     <para>
      有关应分析每个服务的哪些日志文件的规范。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec-tuning-logfiles-logger">
  <title>使用 <command>logger</command> 创建系统日志项</title>

  <para>
   <command>logger</command> 是用于在系统日志中创建日志项的工具。它提供了 rsyslogd 系统日志模块的外壳命令接口。例如，下面一行命令会在 <filename>/var/log/messages</filename> 中或直接在日记中（如果未运行日志记录工具）输出其消息：
  </para>

<screen><prompt>tux &gt; </prompt>logger -t Test "This message comes from $USER"</screen>

  <para>
   根据当前用户和主机名，日志将包含如下一行：
  </para>

<screen>Sep 28 13:09:31 venus Test: This message comes from tux</screen>
 </sect1>
</chapter>
