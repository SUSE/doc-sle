<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="storage_nfs.xml" version="5.0" xml:id="cha-nfs">
 <title>通过 NFS 共享文件系统</title>
 <info>
  <abstract>
   <para>
    <emphasis>网络文件系统</emphasis> (<emphasis>NFS</emphasis>) 是允许访问服务器上的文件的协议，访问方式与访问本地文件相似。
   </para>
   <para>
    <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server 会安装 NFS v4.2，后者引入了对稀疏文件、文件预分配、服务器端克隆和复制、应用程序数据块 (ADB) 和用于强制性访问控制 (MAC) 的带标签 NFS（客户端和服务器上均需要 MAC）的支持。</phrase></phrase>
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>

 <sect1 xml:id="sec-nfs-overview">
  <title>概览</title>
  <para>
   <emphasis>网络文件系统</emphasis> (NFS) 是久经考验且受到广泛支持的标准化网络协议，它允许在单独的主机之间共享文件。
  </para>
  <para>
   <emphasis>网络信息服务</emphasis> (NIS) 可用于在网络中进行集中式用户管理。将 NFS 和 NIS 结合使用可通过文件和目录权限在网络中进行访问控制。NFS 与 NIS 一起使用时网络面向用户是透明的。
  </para>
  <para>
   在默认配置中，NFS 完全信任网络，因此会信任连接到可信网络的任何计算机。在可通过物理方式访问 NFS 服务器所信任的任何网络的任何计算机上，任何具有管理员特权的用户都可以访问该服务器提供的所有文件。
  </para>
  <para>
   一般而言，此安全性级别非常适于以下情形：所信任的网络是真正的专用网络，通常局限于单个计算机机柜或机房，并且无法进行未经授权的访问。将整个子网作为一个整体信任的其他情形限制较多，需要更精密的信任机制。为了满足这些情形的需要，NFS 使用 <emphasis>Kerberos</emphasis> 基础架构来支持各种安全性级别。Kerberos 需要 NFSv4（默认使用该协议）。有关详细信息，请参见<xref linkend="cha-security-kerberos"/>。
  </para>

  <para>
   下面是 YaST 模块中使用的术语。
  </para>

  <variablelist>
   <varlistentry>
    <term>导出</term>
    <listitem>
     <para>
      由 NFS 服务器<emphasis>导出</emphasis>的目录，客户端可将其集成到系统中。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFS 客户端</term>
    <listitem>
     <para>
      NFS 客户端是通过网络文件系统协议使用来自 NFS 服务器的 NFS 服务的系统。TCP/IP 协议已集成到 Linux 内核中；无需再安装任何其他软件。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFS 服务器</term>
    <listitem>
     <para>
      NFS 服务器向客户端提供 NFS 服务。运行中的服务器依赖于以下守护程序：<systemitem class="daemon">nfsd</systemitem> (worker)、<systemitem class="daemon">idmapd</systemitem>（用于 NFSv4 的 ID 到名称映射，仅在某些场景下需要）、<systemitem class="daemon">statd</systemitem>（文件锁定）和 <systemitem class="daemon">mountd</systemitem>（挂载请求）。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFSv3</term>
    <listitem>
     <para>
      NFSv3 是版本 3 实施，支持客户端身份验证的<quote>旧版</quote>无状态 NFS。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFSv4</term>
    <listitem>
     <para>
      NFSv4 是新的版本 4 实施，支持通过 Kerberos 进行安全用户身份验证。NFSv4 只需要一个端口，因此，它比 NFSv3 更适合用于防火墙后的环境。
     </para>
     <para>
      协议指定为 <link xlink:href="https://datatracker.ietf.org/doc/html/rfc3530"/>。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>pNFS</term>
    <listitem>
     <para>
      并行 NFS，属于 NFSv4 的一种协议扩展。任何 pNFS 客户端都可以直接访问 NFS 服务器上的数据。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <important os="sles;osuse">
   <title>需要 DNS 的原因</title>
   <para>
    从理论上讲，所有导出都可以仅使用 IP 地址来完成。为避免超时，您需要一个有效的 DNS 系统。至少为了日志记录目的也应使用 DNS，因为 <systemitem class="daemon">mountd</systemitem> 守护程序执行反向查找。
   </para>
  </important>
 </sect1>

 

 <sect1 os="sles;osuse" xml:id="sec-nfs-installation">
  <title>安装 NFS 服务器</title>

   <para>
   默认不会安装 NFS 服务器。要使用 YaST 安装 NFS 服务器，请依次选择<menuchoice> <guimenu>软件</guimenu>
   <guimenu>软件管理</guimenu></menuchoice>、<guimenu>模式</guimenu>，然后启用<guimenu>服务器功能</guimenu>部分的<guimenu>文件服务器</guimenu>选项。单击<guimenu>接受</guimenu>安装所需软件包。
  </para>
  <para>
   与 NIS 一样，NFS 也是一个客户端/服务器系统。但是，一台计算机可充当这两种角色：它可以通过网络提供文件系统（导出），也可以从其他主机挂载文件系统（导入）。
  </para>

  <note>

   <title>在导出服务器上本地挂载 NFS 卷</title>
   <para>
    <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 上不支持在导出服务器本地挂载 NFS 卷。
   </para>
  </note>
 </sect1>
 <sect1 xml:id="sec-nfs-configuring-nfs-server" os="sles;osuse">
  <title>配置 NFS 服务器</title>

  <para>
   可通过 YaST 配置 NFS 服务器，也可以手动配置它。NFS 还可与 Kerberos 结合来进行身份验证。
  </para>

  <sect2 xml:id="sec-nfs-export-yast2">
   <title>使用 YaST 导出文件系统</title>
   <para>
    使用 YaST 将网络中的某台主机转换为 NFS 服务器，此服务器可将目录和文件导出到所有有权访问它的主机或导出到某个组的所有成员。因此，无需在每台主机本地安装应用程序，服务器也能提供应用程序。
   </para>
   <para>
    要设置此类服务器，请继续执行以下步骤：
   </para>
   <procedure xml:id="pro-nfs-export-yast2-nfs">
    <title>设置 NFS 服务器</title>
    <step>
     <para>
      启动 YaST 并选择<menuchoice> <guimenu>网络服务</guimenu>
      <guimenu> NFS 服务器</guimenu> </menuchoice>；请参见<xref linkend="fig-inst-nfsserver1"/>。系统会提示您安装其他软件。
     </para>

     <figure xml:id="fig-inst-nfsserver1">
      <title>NFS 服务器配置工具</title>
      <mediaobject>
       <imageobject role="fo">
        <imagedata fileref="yast2_inst_nfsserver1.png" width="75%" os="sles;sled"/>
        
       </imageobject>
       <imageobject role="html">
        <imagedata fileref="yast2_inst_nfsserver1.png" width="75%" os="sles;sled"/>
        
       </imageobject>
      </mediaobject>
     </figure>

    </step>
    <step>
     <para>
      单击<guimenu>启动</guimenu>单选按钮。
     </para>
    </step>
    <step>
     <para>
      如果 <systemitem class="daemon">firewalld</systemitem> 在系统上处于活动状态，请单独为 NFS 配置 firewalld（请参见<xref linkend="sec-security-firewall-firewalld"/>）。YaST 尚不完全支持 <systemitem class="daemon">firewalld</systemitem>，因此请忽略“防火墙不可配置”消息并继续。
     </para>
    </step>
    <step>
     <para>
      选中是否<guimenu>启用 NFSv4</guimenu>。如果您停用 NFSv4，YaST 将只支持 NFSv3。有关启用 NFSv2 的信息，请参见<xref linkend="sec-nfs-export-manual-nsfv2"/>。
     </para>
     <substeps performance="required">
      <step>
       <para>
        如果选择 NFSv4，另外还请输入相应的 NFSv4 域名。<systemitem class="daemon">idmapd</systemitem> 守护程序会使用此参数。Kerberos 设置需要该守护程序，当客户端无法处理数字用户名时，也需要使用该守护程序。如果您不运行 <systemitem class="daemon">idmapd</systemitem> 或无任何特殊要求，请将它保留为 <literal>localdomain</literal>（默认值）。有关 <systemitem class="daemon">idmapd</systemitem> 守护程序的详细信息，请参见 <xref linkend="var-nfs-export-manual-idmapd"/>。
       </para>
      </step>
     </substeps>
    </step>
    <step>
     <para>
      如果您需要安全访问服务器，请单击<guimenu>启用 GSS 安全性</guimenu>。先决条件是您的域中安装了 Kerberos 并且服务器和客户端都已采用 Kerberos 系统。
      <remark>emap 2011-0824: A reference to a Kerberos chapter
      would be good.</remark>
      单击<guimenu>下一步</guimenu>继续执行下一个配置对话框。
     </para>
    </step>
    <step>
     <para>
      单击对话框上半部分中的<guimenu>添加目录</guimenu>以导出您的目录。
     </para>
    </step>
    <step>
     <para>
      如果您尚未配置允许的主机，系统会自动弹出另一个对话框及相应的选项，供您输入客户端信息。输入主机通配符（通常您可以保留默认值不变）。
     </para>

     <para>
      可以为每个主机设置四类主机通配符：单主机（名称或 IP 地址）、网络组、通配符（如 <literal>*</literal> 表示所有计算机都能访问服务器）和 IP 网络。
     </para>
     <para>
      有关这些选项的更多信息，请参见 <literal>exports</literal> 手册页。
     </para>
    </step>
    <step>
     <para>
      单击<guimenu>完成</guimenu>以完成配置。
     </para>
    </step>
   </procedure>
  </sect2>



  <sect2 xml:id="sec-nfs-export-manual" os="sles;osuse">
   <title>手动导出文件系统</title>
   <para>
    NFS 导出服务的配置文件是 <filename>/etc/exports</filename> 和 <filename>/etc/sysconfig/nfs</filename>。如果 NFSv4 服务器配置包含经过 Kerberos 身份验证的 NFS，或者客户端不能使用数字用户名，则除了这些文件外，还需要 <filename>/etc/idmapd.conf</filename>。
   </para>
   <para>
    要启动或重启动服务，请运行命令 <command>systemctl restart nfsserver</command>。此命令还会重启动 NFS 服务器所需的 RPC 端口映射程序。
   </para>
   <para>
    为确保 NFS 服务器始终在引导时启动，请运行 <command>sudo systemctl enable nfsserver</command>。
   </para>
   <note>
    <title>NFSv4</title>
    <para>
     NFSv4 是 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 上可用的最新版 NFS 协议。现在，通过 NFSv4 导出所用的配置目录与通过 NFSv3 导出所用的目录相同。
    </para>
    <para>
     在 <phrase os="sles;sled">SUSE Linux Enterprise Server 11</phrase> 上，必须在 <filename>/etc/exports</filename> 中指定绑定挂载。该设置仍然受支持，但现在已弃用。
    </para>
   </note>
   <variablelist>
    <varlistentry>
     <term><filename>/etc/exports</filename></term>
     <listitem>
      <para>
       <filename>/etc/exports</filename> 文件包含项列表。每个条目表示共享的目录以及共享的方式。<filename>/etc/exports</filename> 中的条目通常包含：
      </para>
<screen>/<replaceable>SHARED</replaceable>/<replaceable>DIRECTORY</replaceable>   <replaceable>HOST</replaceable>(<replaceable>OPTION_LIST</replaceable>)</screen>
      <para>
       例如：
      </para>
<screen>/export/data   192.168.1.2(rw,sync)</screen>
      <para>
       在此，使用 IP 地址 <literal>192.168.1.2</literal> 标识允许的客户端。您还可以使用主机名、表示一组主机的通配符（<literal>*.abc.com</literal>、<literal>*</literal> 等）或网络组 (<literal>@my-hosts</literal>)。
      </para>
      <para>
       有关所有选项及其含义的详细说明，请参见 <filename>/etc/exports</filename> 的<literal>手册</literal>页 (<command>man exports</command>)。
      </para>
      <para>
       如果您在 NFS 服务器运行时修改了 <filename>/etc/exports</filename>，则需使用 <command>sudo systemctl restart nfsserver</command> 命令重启动 NFS 服务器，以使更改生效。
      </para>

     </listitem>
    </varlistentry>
    <varlistentry>
     <term><filename>/etc/sysconfig/nfs</filename></term>
     <listitem>
      <para>
       <filename>/etc/sysconfig/nfs</filename> 文件包含一些决定 NFSv4 服务器守护程序行为的参数。请务必将参数 <systemitem>NFS4_SUPPORT</systemitem> 设置为 <literal>yes</literal>（默认值）。<systemitem>NFS4_SUPPORT</systemitem> 决定 NFS 服务器是否支持 NFSv4 导出和客户端。
      </para>
      <para>
       如果您在 NFS 服务器运行时修改了 <filename>/etc/sysconfig/nfs</filename>，则需使用 <command>sudo systemctl restart nfsserver</command> 命令重启动 NFS 服务器，以使更改生效。
      </para>
      <tip>
       <title>挂载选项</title>
       <para>
        在 <phrase os="sles;sled">SUSE Linux Enterprise Server 11</phrase> 上，必须在 <filename>/etc/exports</filename> 中指定 <option>--bind</option> 挂载。该设置仍然受支持，但现在已弃用。现在，通过 NFSv4 导出所用的配置目录与通过 NFSv3 导出所用的目录相同。
       </para>
      </tip>
      <note xml:id="sec-nfs-export-manual-nsfv2">

       <title>NFSv2</title>
       <para>
        如果 NFS 客户端仍依赖于 NFSv2，请在服务器的 <filename>/etc/sysconfig/nfs</filename> 中设置以下几项启用该协议：
       </para>
<screen>NFSD_OPTIONS="-V2"
MOUNTD_OPTIONS="-V2"</screen>
       <para>
        重启动服务后，请使用以下命令检查版本 2 是否可用：
       </para>
<screen><prompt>&gt; </prompt>cat /proc/fs/nfsd/versions
+2 +3 +4 +4.1 +4.2</screen>
      </note>
     </listitem>
    </varlistentry>
    <varlistentry xml:id="var-nfs-export-manual-idmapd">
     <term><filename>/etc/idmapd.conf</filename></term>
     <listitem>
      <para>
       仅当使用 Kerberos 身份验证或客户端不能使用数字用户名时，才需要 <systemitem class="daemon">idmapd</systemitem> 守护程序。自 Linux 内核 2.6.39 起，Linux 客户端可以使用数字用户名。<systemitem class="daemon">idmapd</systemitem> 守护程序会将发送到服务器的 NFSv4 请求进行名称到 ID 的映射，并答复客户端。
      </para>
      <para>
       如果需要，<systemitem class="daemon">idmapd</systemitem> 需在 NFSv4 服务器上运行。客户端上的名称到 ID 映射将由以下软件包提供的 <command>nfsidmap</command> 来执行： <package>nfs-client</package>.
      </para>
      <para>
       对于可能使用 NFS 来共享文件系统的计算机，请确保以统一的方式在这些计算机间为用户指定用户名和 ID (UID)。这可以使用 NIS、LDAP 或域中的任何统一的域身份验证机制来实现。
      </para>
      <para>
       在 <filename>/etc/idmapd.conf</filename> 文件中，必须为客户端和服务器设置相同的 <literal>Domain</literal> 参数。如果您不确定，请在服务器和客户端文件中将域保留为 <literal>localdomain</literal>。配置文件样本如下：
      </para>
<screen>[General]
Verbosity = 0
Pipefs-Directory = /var/lib/nfs/rpc_pipefs
Domain = localdomain

[Mapping]
Nobody-User = nobody
Nobody-Group = nobody</screen>
      <para>
       要启动 <systemitem class="daemon">idmapd</systemitem> 守护程序，请运行 <command>systemctl start nfs-idmapd</command>。如果您在守护程序运行时修改了 <filename>/etc/idmapd.conf</filename>，则需使用 <command>systemctl start nfs-idmapd</command> 命令重启动守护程序，以使更改生效。
      </para>
      <para>
       有关更多信息，请参见 <literal>idmapd</literal> 和 <literal>idmapd.conf</literal> 的手册页（<literal>man idmapd</literal> 和 <literal>man idmapd.conf</literal>）。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>



  <sect2 xml:id="sec-nfs-kerberos">
   <title>采用 Kerberos 的 NFS</title>
   <para>
    要对 NFS 使用 Kerberos 身份验证，必须启用通用安全服务 (GSS)。在初始 YaST NFS 服务器对话框中选择<guimenu>启用 GSS 安全</guimenu>。必须具有一个有效的 Kerberos 服务器才能使用此功能。YaST 不会设置服务器，而只使用所提供的功能。要使用 Kerberos 进行身份验证，除了 YaST 配置外，至少还须完成以下步骤才能运行 NFS 配置：
   </para>
   <procedure>
    <step>
     <para>
      请确保服务器和客户端都在同一 Kerberos 域中。它们必须访问相同的 KDC（密钥分发中心）服务器并共享其 <filename>krb5.keytab</filename> 文件（在任何计算机上的默认位置是 <filename>/etc/krb5.keytab</filename>）。有关 Kerberos 的更多信息，请参见<xref linkend="cha-security-kerberos"/>。
     </para>
    </step>
    <step>
     <para>
      在客户端上运行 <command>systemctl start rpc-gssd.service</command> 启动 gssd 服务。
     </para>
    </step>
    <step os="sles;osuse">
     <para>
      在服务器上运行 <command>systemctl start rpc-svcgssd.service</command> 启动 svcgssd 服务。
     </para>
    </step>
   </procedure>
   <para>
    要进行 Kerberos 身份验证，也需要在服务器上运行 <systemitem class="daemon">idmapd</systemitem> 守护程序。有关详细信息，请参见<xref linkend="var-nfs-export-manual-idmapd"/>。
   </para>
   <para>
    有关配置采用 Kerberos 的 NFS 的更多信息，请参见<xref linkend="sec-nfs-info" xrefstyle="SectTitleOnPage"/> 中的链接。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-nfs-configuring-nfs-clients">
  <title>配置客户端</title>

  <para>
   要将主机配置为 NFS 客户端，无需安装其他软件。将默认安装所有需要的软件包。
  </para>

  <sect2 xml:id="sec-nfs-import-yast2">
   <title>使用 YaST 导入文件系统</title>
   <para>
    授权用户可以用 YaST NFS 客户端模块从 NFS 服务器将 NFS 目录挂载本地文件树。按如下所示继续：
   </para>
   <procedure xml:id="pro-nfs-import-yast2">
    <title>导入 NFS 目录</title>
    <step>
     <para>
      启动 YaST NFS 客户端模块。
     </para>
    </step>

    <step>
     <para>
      单击 <guimenu>NFS 共享</guimenu>选项卡中的<guimenu>添加</guimenu>。输入 NFS 服务器的主机名、要导入的目录以及要在本地的哪个挂载点挂载此目录。
     </para>
    </step>


    <step>
     <para>
      使用 NFSv4 时，在 <guimenu>NFS 设置</guimenu>选项卡中选择<guimenu>启用 NFSv4</guimenu>。另外，<guimenu>NFSv4 域名</guimenu>必须包含 NFSv4 服务器所用的相同值。默认域为 <literal>localdomain</literal>。
     </para>
    </step>
    <step>
     <para>
      要对 NFS 使用 Kerberos 身份验证，必须启用 GSS 安全性。选择<guimenu>启用 GSS 安全</guimenu>。
     </para>
    </step>
    <step>
     <para>
      如果您使用防火墙并希望允许从远程计算机访问服务，请启用 <guimenu>NFS 设置</guimenu>选项卡中的<guimenu>在防火墙上打开端口</guimenu>。防火墙状态将显示在复选框旁边。
     </para>
    </step>

    <step>
     <para>
      单击<guimenu>确定</guimenu>保存更改。
     </para>
    </step>
   </procedure>
   <para>
    配置写入<filename>/etc/fstab</filename>，并将挂载指定的文件系统。当您稍后启动 YaST 配置客户端时，它还将读取此文件中的现有配置。
   </para>
   <tip>
    <title>NFS 用作根文件系统</title>
    <para>
     在通过网络以 NFS 共享形式挂载根分区的（无磁盘）系统中，配置可供访问 NFS 共享的网络设备时需保持谨慎。
    </para>
    <para>
     关闭或重引导系统时，默认的处理顺序是先关闭网络连接，然后卸载根分区。对于 NFS 根文件系统，此顺序会导致问题，因为在已停用与 NFS 共享的网络连接的情况下，根分区无法完全卸载。为防止系统停用相关的网络设备，请按<xref linkend="sec-network-yast-change-start"/>中所述打开网络设备配置选项卡，然后在<guimenu>设备激活</guimenu>窗格中选择<guimenu>通过 NFSroot</guimenu>。
    </para>
   </tip>

  </sect2>

  <sect2 xml:id="sec-nfs-import">
   <title>手动导入文件系统</title>


   <para>
    手动从 NFS 服务器导入文件系统的先决条件是运行 RPC 端口映射器。<option>nfs</option> 服务负责正确启动该程序；因此，请以 <systemitem class="username">root</systemitem> 身份输入 <command>systemctl start nfs</command> 来启动该服务。然后就可以像本地分区那样使用 <command>mount</command> 将远程文件系统挂载到文件系统中：
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> mount <replaceable>HOST</replaceable>:<replaceable>REMOTE-PATH</replaceable><replaceable>LOCAL-PATH</replaceable></screen>
   <para>
    例如，要从 <systemitem>nfs.example.com</systemitem> 计算机导入用户目录，请使用：
   </para>
<screen><prompt>&gt; </prompt><command>sudo</command> mount nfs.example.com:/home /home</screen>
   <para>
    要定义客户端到 NFS 服务器的 TCP 连接计数，可以使用 <command>mount</command> 命令的 <literal>nconnect</literal> 选项。您可以指定介于 1 和 16 之间的任何数字，其中 1 是默认值（如果未指定挂载选项）。
   </para>
   <para>
    仅会在第一次挂载过程中对特定 NFS 服务器应用 <literal>nconnect</literal> 设置。如果同一客户端对同一 NFS 服务器执行挂载命令，则将共享所有已建立的连接，而不会建立新的连接。要更改 <literal>nconnect</literal> 设置，必须卸载到特定 NFS 服务器的<emphasis role="bold">所有</emphasis>客户端连接。然后，您可以为 <literal>nconnect</literal> 选项定义一个新值。
   </para>
   <para>
    您可以在 <command>mount</command> 的输出或文件 <filename>/proc/mounts</filename> 中找到当前有效的 <literal>nconnect</literal> 值。如果挂载选项没有值，则在挂载期间不会使用该选项，而是使用默认值 <emphasis>1</emphasis>。
   </para>
   <note>
    <title>连接数与 <literal>nconnect</literal> 定义的不同</title>
    <para>
     由于您可以在第一次挂载后关闭和打开连接，因此实际连接计数不必与 <literal>nconnect</literal> 的值相同。
    </para>
   </note>
   
   <sect3 xml:id="sec-nfs-automount">
    <title>使用自动挂载服务</title>
    <para>
     autofs 守护程序可用于自动挂载远程文件系统。请在 <filename>/etc/auto.master</filename> 文件中添加以下条目：
    </para>
<screen>/nfsmounts /etc/auto.nfs</screen>
    <para>
     如果 <filename>auto.nfs</filename> 文件正确填充，<filename>/nfsmounts</filename> 目录将作为客户端上所有 NFS 挂载的 root 目录。选择 <filename>auto.nfs</filename> 这个名称是为了方便起见，您可以选择任何名称。在 <filename>auto.nfs</filename> 中为所有 NFS 挂载添加条目，如下所示：
    </para>
<screen>localdata -fstype=nfs server1:/data
nfs4mount -fstype=nfs4 server2:/</screen>
    <para>
     以 <systemitem class="username">root</systemitem> 身份运行 <command>systemctl start autofs</command> 来激活该设置。对于此示例，<filename>/nfsmounts/localdata</filename>，<systemitem>server1</systemitem> 的 <filename>/data</filename> 目录将通过 NFS 挂载，<systemitem>server2</systemitem> 的 <filename>/nfsmounts/nfs4mount</filename> 将通过 NFSv4 挂载。
    </para>
    <para>
     如果在 autofs 服务正在运行时编辑了 <filename>/etc/auto.master</filename> 文件，则必须使用 <command>systemctl restart autofs</command> 重启动自动装载器才能使更改生效。
    </para>
   </sect3>
   <sect3 xml:id="sec-nfs-fstab">
    <title>手动编辑 <filename>/etc/fstab</filename></title>
    <para>
     通常，<filename>/etc/fstab</filename> 中的 NFSv3 挂载项如下：
    </para>
<screen>nfs.example.com:/data /local/path nfs rw,noauto 0 0</screen>
    <para>
     对于 NFSv4 挂载，请在第三列中使用 <literal>nfs4</literal> 而不是 <literal>nfs</literal>：
    </para>
<screen>nfs.example.com:/data /local/pathv4 nfs4 rw,noauto 0 0</screen>
    <para>
     <literal>noauto</literal> 选项可禁止在启动时自动挂载文件系统。如果您要手动安装各文件系统，可以缩短只指定挂载点的安装命令：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> mount /local/path</screen>
    <note>
     <title>启动时挂载</title>
     <para>
      如果您没有输入 <literal>noauto</literal> 选项，系统的 init 脚本将在启动时处理这些文件系统的挂载。
     </para>
    </note>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-nfs-pnfs">
   <title>并行 NFS (pNFS)</title>
   <para>
    NFS 是最老的协议之一，开发于上世纪八十年代。因此，如果您要共享小文件，NFS 通常能够满足需求。但是，当您要传送大文件或有大量的客户端要访问数据时，NFS 服务器会成为瓶颈，严重影响系统性能。这是因为文件迅速变大，而以太网的相对速度没有完全跟上这一变化。
   </para>
   <para>
    当您向普通 NFS 服务器请求文件时，服务器会查找文件元数据、收集所有数据并通过网络将数据传送到您的客户端。但是，无论文件的大小如何，性能瓶颈都会凸显出来：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      如果是小文件，则大部分时间都花在收集元数据上。
     </para>
    </listitem>
    <listitem>
     <para>
      如果是大文件，则大部分时间花在将数据从服务器传送到客户端上。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    pNFS 或并行 NFS 则突破了此种限制，因为它将文件系统元数据从数据位置分离出来。因此，pNFS 需要两类服务器：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      一个<emphasis>元数据</emphasis>或<emphasis>控制服务器</emphasis>，用于处理所有非数据通讯
     </para>
    </listitem>
    <listitem>
     <para>
      一个或多个<emphasis>储存服务器</emphasis>，用于存放数据
     </para>
    </listitem>
   </itemizedlist>
   <para>
    元数据和储存服务器组成单独一个逻辑 NFS 服务器。当客户端要读取或写入时，元数据服务器会告诉 NFSv4 客户端使用哪个储存服务器访问文件块。客户端可以直接访问该服务器上的数据。
   </para>
   <para>
    <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 仅在客户端上支持 pNFS。
   </para>
   <sect3 xml:id="sec-nfs-pnfs-yast">
    <title>使用 YaST 配置 pNFS 客户端</title>
    <para>
     请执行<xref linkend="pro-nfs-import-yast2"/>中所述的步骤，但选中 <guimenu>pNFS (v4.2)</guimenu> 复选框以及可选的 <guimenu>NFSv4 共享</guimenu>。YaST 会执行所有必需的步骤，并且会在文件 <filename>/etc/exports</filename> 中写入所有必要选项。
    </para>
   </sect3>
   <sect3 xml:id="sec-nfs-pnfs-manual">
    <title>手动配置 pNFS 客户端</title>
    <para>
     请参阅<xref linkend="sec-nfs-import"/>着手配置。大多数配置通过 NFSv4 服务器完成。对于 pNFS，唯一的区别是将 <option>minorversion</option> 选项和元数据服务器 <replaceable>MDS_服务器</replaceable>添加到您的 <command>mount</command> 命令：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> mount -t nfs4 -o minorversion=1 <replaceable>MDS_SERVER</replaceable> <replaceable>MOUNTPOINT</replaceable></screen>
    <para>
     为方便调试，请更改 <filename>/proc</filename> 文件系统中的值：
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> echo 32767 &gt; /proc/sys/sunrpc/nfsd_debug
<prompt>&gt; </prompt><command>sudo</command> echo 32767 &gt; /proc/sys/sunrpc/nfs_debug</screen>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="nfs4-acls" os="sles;osuse">
  <title>管理 NFSv4 访问控制列表</title>
  <para>
   在 Linux 中，除了针对用户、组和其他人 (<literal>ugo</literal>) 的读取、写入、执行 (<literal>rwx</literal>) 这些简单标志之外，各访问控制列表 (ACL) 没有统一的标准。控制能力相对较好的一个选择是<citetitle>《Draft POSIX ACLs》</citetitle>（POSIX ACL 草稿），它尚未得到 POSIX 的正式标准化。另一个选择是 NFSv4 ACL，它是 NFSv4 网络文件系统的一部分，目的是为了在 Linux 上的 POSIX 系统与 Microsoft Windows 上的 WIN32 系统之间提供适当的兼容性。
  </para>
  <para>
   NFSv4 ACL 不足以正确实施草稿 POSIX ACL，因此未进行在 NFSv4 客户端上映射 ACL 访问的尝试（比如使用 <command>setfacl</command>）。
  </para>
  <para>
   使用 NFSv4 时，即使在仿真模式下也无法使用草稿 POSIX ACL，并且需要直接使用 NFSv4 ACL。这意味着，虽然 <command>setfacl</command> 能够在 NFSv3 上运行，却不能在 NFSv4 上运行。为了能够在 NFSv4 文件系统上使用 NFSv4 ACL，SUSE Linux Enterprise Server 提供了 <filename>nfs4-acl-tools</filename> 软件包，其中包含下列各项：
  </para>
  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     <command>nfs4-getfacl</command>
    </para>
   </listitem>
   <listitem>
    <para>
     <command>nfs4-setfacl</command>
    </para>
   </listitem>
   <listitem>
    <para>
     <command>nfs4-editacl</command>
    </para>
   </listitem>
  </itemizedlist>
  <para>
   这些操作的运作方式与用于检查和修改 NFSv4 ACL 的 <command>getfacl</command> 和 <command>setfacl</command> 类似。仅当 NFS 服务器上的文件系统提供对 NFSv4 ACL 的全面支持时，这些命令才有效。虽然某些访问控制项 (ACE) 的特定组合可能在客户端中不可用，但客户端上运行的程序都将受到服务器施加的任何限制的影响。
  </para>
  <para>
   不支持在输出 NFS 服务器上本地挂载 NFS 卷。
  </para>
  <bridgehead>附加信息</bridgehead>
  <para>
   有关信息，请参见 <citetitle>Introduction to NFSv4 ACLs</citetitle>（NFSv4 ACL 简介，网址为 <link xlink:href="http://wiki.linux-nfs.org/wiki/index.php/ACLs#Introduction_to_NFSv4_ACLs"/>)。
  </para>
 </sect1>
 <sect1 xml:id="sec-nfs-info">
  <title>更多信息</title>
  <para>
   除了 <command>exports</command>、<command>nfs</command> 和 <command>mount</command> 的手册页外，还可在 <filename>/usr/share/doc/packages/nfsidmap/README</filename> 中找到关于配置 NFS 服务器和客户端的信息。有关更多联机文档，请参见以下网站：
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     有关网络安全的一般信息，请参见<xref linkend="cha-security-firewall"/>。
    </para>
   </listitem>
   <listitem>
    <para>
     如果您需要自动挂载 NFS 导出，请参见<xref linkend="sec-autofs-nfs"/>。
    </para>
   </listitem>
   <listitem>
    <para>
     有关使用 AutoYaST 配置 NFS 的更多细节，请参见<xref linkend="ay-nfs"/>。
    </para>
   </listitem>
   <listitem>
    <para>
     有关使用 Kerberos 保护 NFS 导出的说明，请参见<xref linkend="sec-security-kerberos-nfs"/>。
    </para>
   </listitem>
   <listitem>
    <para>
     在 <link xlink:href="http://nfs.sourceforge.net/">SourceForge</link> 上联机查找详细的技术文档。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 
 <sect1 xml:id="sec-nfs-troubleshooting">
  <title>收集信息以供 NFS 查错</title>
   <sect2 xml:id="sec-nfs-common-troubleshooting">
    <title>常见查错</title>
     <para>
      某些情况下，您可以通过读取生成的错误消息并查看 <filename>/var/log/messages</filename> 文件来了解 NFS 中的问题。但很多时候，错误消息和 <filename>/var/log/messages</filename> 中提供的信息不够详细。在这些情况下，可通过再现问题时捕获网络数据包来充分了解大部分 NFS 问题。
     </para>
 
     <para>
      明确定义问题。通过以各种方式测试系统并确定问题的发生时间来检查问题。隔离会导致问题的最简单步骤。然后尝试按照下面的过程再现问题。
     </para>
 
     <procedure>
      <title>再现问题</title>
       <step>
        <para>
         捕获网络数据包。在 Linux 上，可以使用 <package>tcpdump</package> 软件包提供的 <command>tcpdump</command> 命令。
        </para>
        <para>
         <command>tcpdump</command> 语法的示例如下：
        </para>
<screen>tcpdump -s0 -i <replaceable>eth0</replaceable> -w <replaceable>/tmp/nfs-demo.cap</replaceable> host <replaceable>x.x.x.x</replaceable></screen>
        <para>
         位置:
        </para>
        <variablelist>
         <varlistentry>
          <term>s0</term>
          <listitem>
           <para>防止数据包截断
           </para> 
          </listitem>
         </varlistentry>
         <varlistentry>
          <term>eth0</term>
          <listitem>
           <para>
            应替换为将传递数据包的本地接口的名称。您可以使用 <literal>any</literal> 值同时捕获所有接口，但使用此属性通常会导致数据质量下降并造成分析混乱。
           </para>
          </listitem>
         </varlistentry>
         <varlistentry>
          <term>w</term>
         <listitem>
          <para>
           指定要写入的捕获文件的名称。
          </para>
         </listitem>
         </varlistentry>
         <varlistentry>
          <term>x.x.x.x</term>
          <listitem>
           <para>
            应替换为 NFS 连接另一端的 IP 地址。例如，在 NFS 客户端获取 <command>tcpdump</command> 时，请指定 NFS 服务器的 IP 地址，反之亦然。
           </para>
          </listitem>
         </varlistentry>
        </variablelist>
       <note>
        <para>
         在某些情况下，只需在 NFS 客户端或 NFS 服务器任一端捕获数据就足够了。但如果不确定端到端网络的完整性，则通常需要在两端捕获数据。
        </para>
       </note>
       <para>
        请不要关闭 <command>tcpdump</command> 进程并继续下一步。
       </para>
      </step>
      <step>
       <para>
        （可选）如果问题发生在 <command>nfs mount</command> 命令本身执行过程中，您可以尝试使用 <command>nfs mount</command> 命令的高详细程度选项 (<literal>-vvv</literal>) 来获得更多输出。
       </para>
  </step>
  <step>
   <para>
    （可选）获取再现方法的 <command>strace</command>。再现步骤的 <command>strace</command> 精确记录了发生系统调用的确切时间。此信息可用于进一步确定您应关注 <literal>tcpdump</literal> 中的哪些事件。
   </para>
   <para>
    例如，如果您发现在 NFS 挂载上执行 <emphasis>mycommand --param</emphasis> 命令失败，则可以使用以下命令来 <command>strace</command> 命令：
   </para>
<screen>strace -ttf -s128 -o/tmp/nfs-strace.out mycommand --param</screen>
   <para>
    如果您未获得任何再现步骤的 <command>strace</command>，请注意问题的再现时间。检查 <filename>/var/log/messages</filename> 日志文件以隔离问题。
   </para>
  </step>
  <step>
   <para>
    一旦问题再现，按 <keycombo><keycap>CTRL</keycap><keycap>c</keycap></keycombo> 来停止在终端中运行的 <command>tcpdump</command>。如果 <command>strace</command> 命令导致挂起，还需终止 <command>strace</command> 命令。
   </para>
  </step>
  <step>
   <para>
    现在，具有分析数据包跟踪和 <command>strace</command> 数据经验的管理员可以检查 <filename>/tmp/nfs-demo.cap</filename> 和 <filename>/tmp/nfs-strace.out</filename> 中的数据。
   </para>
  </step>  
  </procedure>
 </sect2>
 
 <sect2 xml:id="sec-advance-debugging">
  <title>高级 NFS 调试</title>
   <important>
    <title>高级调试适用于专家</title>
    <para>
     请注意，以下部分仅适用于了解 NFS 代码的高技能 NFS 管理员。因此，请执行<xref linkend="sec-nfs-common-troubleshooting"/>中所述的第一步，以帮助缩小问题范围，并告知专家要了解更深入的细节可能需要哪些方面的调试代码（如果有）。</para>
   </important>
   <para>
    可启用各种调试代码来收集额外的 NFS 相关信息。不过，调试消息非常晦涩难懂，并且数据量巨大，因此使用调试代码可能会影响系统性能。它甚至有可能对系统产生的影响大到足以防止问题的发生。大多数情况下都不需要调试代码输出，对于不太熟悉 NFS 代码的人来说，通常也没什么用。  
   </para>
 
   <sect3 xml:id="sec-rpcdebug">
    <title>使用 <command>rpcdebug</command> 激活调试</title>
    <para>
     <command>rpcdebug</command> 工具可让您设置和清除 NFS 客户端和服务器调试标志。如果在 SLE 中无法访问 <command>rpcdebug</command> 工具，可以从 <package>nfs-client</package> 或 <package>nfs-kernel-server</package> 软件包为 NFS 服务器安装此工具。
    </para>
    <para>
     要设置调试标志，请运行：
    </para>
<screen>rpcdebug -m <replaceable>module</replaceable> -s flags</screen>
    <para>
     要清除调试标志，请运行：
    </para>
<screen>rpcdebug -m <replaceable>module</replaceable> -c flags</screen>
    <para>
     其中，<replaceable>module</replaceable> 可以是：
    </para>
    <variablelist>
     <varlistentry>
      <term>nfsd</term>
      <listitem>
      <para>
       NFS 服务器代码的调试
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>nfs</term>
      <listitem>
      <para>
       NFS 客户端代码的调试
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>nlm</term>
      <listitem>
       <para>
        NFS 锁管理器调试（在 NFS 客户端或 NFS 服务器端）。仅适用于 NFS v2/v3。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>rpc</term>
      <listitem>
      <para>
       远程过程调用模块调试（在 NFS 客户端或 NFS 服务器端）。
      </para>
     </listitem>
    </varlistentry> 
   </variablelist>
   <para>
    有关 <command>rpcdebug</command> 命令详细用法的信息，请参见手册页：
   </para>
<screen>man 8 rpcdebug</screen>
  </sect3>
 
 <sect3 xml:id="sec-other-nfs-debug">
  <title>针对 NFS 所依赖的其他代码激活调试</title>
  <para>
   NFS 活动可能依赖于其他相关服务，例如 NFS 挂载守护程序—<command>rpc.mountd</command>。您可以在 <filename>/etc/sysconfig/nfs</filename> 中为相关服务设置选项。
  </para>
  <para>
   例如，<filename>/etc/sysconfig/nfs</filename> 包含以下参数：
  </para>
<screen>MOUNTD_OPTIONS=""</screen>
  <para>
   要启用调试模式，必须使用 <literal>-d</literal> 选项，后跟以下任何值：<literal>all</literal>、<literal>auth</literal>、<literal>call</literal>、<literal>general</literal> 或 <literal>parse</literal>。
  </para>
  <para>
   例如，以下代码可启用所有形式的 <command>rpc.mountd</command> 日志记录：
  </para>
<screen>MOUNTD_OPTIONS="-d all"</screen>
  <para>
   有关所有可用选项，请参见手册页：
  </para>
<screen>man 8 rpc.mountd</screen>
  <para>
   更改 <filename>/etc/sysconfig/nfs</filename> 后，需要重启动服务：
  </para>
<screen>systemctl restart nfsserver  # for nfs server related changes
systemctl restart nfs  # for nfs client related changes</screen>
   </sect3>
  </sect2>
 </sect1>
</chapter>
