<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="virt_logs.xml" version="5.0" xml:id="cha-virt-logs">
  <title>收集系统信息和日志</title>
  <info>
    <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
      <dm:bugtracker/>
      <dm:translation>yes</dm:translation>
    </dm:docmanager>
  </info>
  <para>
    当虚拟化主机遇到问题时，通常需要收集详细的系统报告。可以借助 <command>supportconfig</command> 工具来实现此目的。有关 <command>supportconfig</command> 的详细信息，请参见 <link xlink:href="https://documentation.suse.com/sles/15-SP5/html/SLES-all/cha-adm-support.html"/>。
  </para>
  <para>
    在某些情况下，<command>supportconfig</command> 收集的信息并不足够，可能还需要收集从自定义日志记录或调试配置生成的日志来确定问题的原因。
  </para>
  <sect1 xml:id="sec-logs-libvirt">
    <title><systemitem class="library">libvirt</systemitem> 日志控制</title>

    <para>
      <systemitem class="library">libvirt</systemitem> 针对库和守护程序提供日志记录工具。可以通过调整日志级别、过滤器和输出设置来控制日志记录工具的行为。
    </para>

    <variablelist>
      <varlistentry>
        <term>日志级别</term>
        <listitem>
          <para>
            <systemitem class="library">libvirt</systemitem> 日志消息分为四种优先级：DEBUG、INFO、WARNING 和 ERROR。DEBUG 级别非常详细，能够在短时间内生成若干 GB 的信息。日志消息的数量按照 INFO、WARNING 和 ERROR 日志级别的顺序逐渐减少。ERROR 是默认的日志级别。
          </para>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>日志过滤器</term>
        <listitem>
          <para>
            日志过滤器提供一种仅记录与特定组件和日志级别匹配的消息的方式。日志过滤器允许收集特定组件的详细 DEBUG 日志消息，但只能从系统的其余组件收集 ERROR 级别的日志消息。默认情况下未定义日志过滤器。
          </para>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>日志输出</term>
        <listitem>
          <para>
            日志输出允许指定要将过滤的日志消息发送到的位置。可将消息发送到文件、进程的标准错误流或 journald。默认情况下，过滤的日志消息将发送到 journald。
          </para>
        </listitem>
      </varlistentry>
    </variablelist>

    <para>
      有关 <systemitem class="library">libvirt</systemitem> 的日志控制的更多细节，请参见 <link xlink:href="https://libvirt.org/logging.html"/>。
    </para>

    <para>
      默认的 <systemitem class="library">libvirt</systemitem> 安装将日志级别设置为 ERROR，未定义日志过滤器，并将日志输出设置为 journald。可以使用 <command>journalctl</command> 命令查看来自 <systemitem class="library">libvirt</systemitem> 守护程序的日志消息：
    </para>

<screen><prompt role="root"># </prompt>journalctl --unit libvirtd</screen>

    <para>
      默认的日志工具设置适合用于常规操作，可为应用程序和 <systemitem class="library">libvirt</systemitem> 用户提供有用的消息，但内部问题通常需要通过 DEBUG 级别的消息来解决。例如，假设 <systemitem class="library">libvirt</systemitem> 与 QEMU 监视器之间的交互存在一个潜在的 bug。在这种情况下，我们只需查看 <systemitem class="library">libvirt</systemitem> 与 QEMU 之间的通讯的调试消息。以下示例创建一个日志过滤器，以选择来自 QEMU 驱动程序的调试消息并将其发送到名为 <filename>/tmp/libvirtd.log</filename> 的文件
    </para>

<screen>
   log_filters="1:qemu.qemu_monitor_json"
   log_outputs="1:file:/tmp/libvirtd.log"
</screen>

    <para>
      可在 <filename>/etc/libvirt/libvirtd.conf</filename> 中找到 <systemitem class="library">libvirt</systemitem> 守护程序的日志控制。对该配置文件进行任何更改后，必须重启动该守护程序。
    </para>

<screen><prompt role="root"># </prompt>systemctl restart libvirtd.service</screen>
  </sect1>
</chapter>
