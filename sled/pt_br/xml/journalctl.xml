<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="journalctl.xml" version="5.0" xml:id="cha.journalctl">
 <title><command>journalctl</command>: consultar o diário do <systemitem class="daemon">systemd</systemitem></title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes (sim)</dm:translation>
  </dm:docmanager>
 </info>
 <para>
  Quando o <systemitem class="daemon">systemd</systemitem> substituiu os scripts init tradicionais no SUSE Linux Enterprise 12 (consulte o <xref linkend="cha.systemd"/>), ele introduziu seu próprio sistema de registro denominado <emphasis>diário</emphasis>. Não há mais necessidade de executar um serviço baseado no <systemitem>syslog</systemitem>, e todos os eventos do sistema são gravados no diário.
 </para>
 <para>
  O próprio diário é um serviço do sistema gerenciado pelo <systemitem class="daemon">systemd</systemitem>. Seu nome completo é <literal>systemd-journald.service</literal>. Ele coleta e armazena dados de registro mantendo diários indexados estruturados com base nas informações de registro recebidas do kernel, de processos dos usuários, da entrada padrão e de erros de serviços do sistema. Por padrão, o serviço <literal>systemd-journald</literal> está ativado:
 </para>
<screen># systemctl status systemd-journald
systemd-journald.service - Journal Service
   Loaded: loaded (/usr/lib/systemd/system/systemd-journald.service; static)
   Active: active (running) since Mon 2014-05-26 08:36:59 EDT; 3 days ago
     Docs: man:systemd-journald.service(8)
           man:journald.conf(5)
 Main PID: 413 (systemd-journal)
   Status: "Processing requests..."
   CGroup: /system.slice/systemd-journald.service
           └─413 /usr/lib/systemd/systemd-journald
[...]</screen>
 <sect1 xml:id="journalctl.persistent">
  <title>Tornando o diário persistente</title>

  <para>
   Por padrão, o diário armazena os dados de registro em <filename>/run/log/journal/</filename>. Como o diretório <filename>/run/</filename> é volátil por natureza, os dados de registro são perdidos na reinicialização. Para torná-los persistentes, deve haver um diretório <filename>/var/log/journal/</filename> com propriedade e permissões corretas, no qual o serviço systemd-journald pode armazenar seus dados. O <systemitem class="daemon">systemd</systemitem> criará o diretório para você (e mudará o registro para persistente), se você fizer o seguinte:
  </para>

  <procedure>
   <step>
    <para>
     Como <systemitem class="username">root</systemitem>, abra o <filename>/etc/systemd/journald.conf</filename> para edição.
    </para>
<screen># vi /etc/systemd/journald.conf</screen>
   </step>
   <step>
    <para>
     Remova o comentário da linha com <literal>Storage=</literal> e mude-a para
    </para>
<screen>[...]
[Journal]
Storage=persistent
#Compress=yes
[...]</screen>
   </step>
   <step>
    <para>
     Grave o arquivo e reinicie o systemd-journald:
    </para>
<screen>systemctl restart systemd-journald</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="journalctl.switches">
  <title>Switches úteis do <command>journalctl</command></title>

  <para>
   Esta seção apresenta várias opções comuns úteis para melhorar o comportamento padrão do <command>journalctl</command>. Todos os switches estão descritos na página de manual do <command>journalctl</command>: <command>man 1 journalctl</command>.
  </para>

  <tip>
   <title>Mensagens relacionadas a um executável específico</title>
   <para>
    Para mostrar todas as mensagens do diário relacionadas a determinado executável, especifique o caminho completo para o executável:
   </para>
<screen>journalctl /usr/lib/systemd/systemd</screen>
  </tip>

  <variablelist>
   <varlistentry>
    <term>-f</term>
    <listitem>
     <para>
      Mostra apenas as mensagens mais recentes do diário e imprime novas entradas de registro à medida que são adicionadas ao diário.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>-e</term>
    <listitem>
     <para>
      Imprime as mensagens e pula para o fim do diário para que as entradas mais recentes fiquem visíveis no paginador.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>-r</term>
    <listitem>
     <para>
      Imprime as mensagens do diário em ordem inversa para que as últimas entradas sejam listadas primeiro.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>-k</term>
    <listitem>
     <para>
      Mostra apenas as mensagens do kernel. Equivale à correspondência de campo <literal>_TRANSPORT=kernel</literal> (consulte a <xref linkend="journalctl.filtering.fields"/>).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>-u</term>
    <listitem>
     <para>
      Mostra apenas as mensagens da unidade <systemitem class="daemon">systemd</systemitem> especificada. Equivale à correspondência de campo <literal>_SYSTEMD_UNIT=<replaceable>UNIDADE</replaceable></literal> (consulte a <xref linkend="journalctl.filtering.fields"/>).
     </para>
<screen># journalctl -u apache2
[...]
Jun 03 10:07:11 pinkiepie systemd[1]: Starting The Apache Webserver...
Jun 03 10:07:12 pinkiepie systemd[1]: Started The Apache Webserver.</screen>
    </listitem>
   </varlistentry>
  </variablelist>

  <para/>
 </sect1>
 <sect1 xml:id="journalctl.filtering">
  <title>Filtrando a saída do diário</title>

  <para>
   Quando chamado sem switches, o <command>journalctl</command> mostra o conteúdo completo do diário, com as entradas mais antigas listadas primeiro. É possível filtrar a saída por switches e campos específicos.
  </para>

  <sect2 xml:id="journalctl.filtering.boot">
   <title>Filtrando com base em um número de boot</title>
   <para>
    O <command>journalctl</command> pode filtrar as mensagens com base em um boot do sistema específico. Para listar todos os boots disponíveis, execute
   </para>
<screen># journalctl --list-boots
-1 097ed2cd99124a2391d2cffab1b566f0 Mon 2014-05-26 08:36:56 EDT—Fri 2014-05-30 05:33:44 EDT
 0 156019a44a774a0bb0148a92df4af81b Fri 2014-05-30 05:34:09 EDT—Fri 2014-05-30 06:15:01 EDT</screen>
   <para>
    A primeira coluna lista a diferença de boot: <literal>0</literal> para o boot atual, <literal>-1</literal> para o anterior, <literal>-2</literal> para o anterior ao -1, etc. A segunda coluna apresenta o ID de boot e as marcações de horário de limite da sequência de boot específica.
   </para>
   <para>
    Mostrar todas as mensagens do boot atual:
   </para>
<screen># journalctl -b</screen>
   <para>
    Se você precisa ver as mensagens de diário do boot anterior, adicione um parâmetro de diferença. O seguinte exemplo representa as mensagens do boot anterior:
   </para>
<screen># journalctl -b -1</screen>
   <para>
    Uma outra maneira é listar as mensagens de boot com base no ID de boot. Para esta finalidade, use o campo _BOOT_ID:
   </para>
<screen># journalctl _BOOT_ID=156019a44a774a0bb0148a92df4af81b</screen>
  </sect2>

  <sect2 xml:id="journalctl.filtering.time">
   <title>Filtrando com base no intervalo de tempo</title>
   <para>
    É possível filtrar a saída do <command>journalctl</command> especificando a data de início e/ou de término. A especificação de data deve ser no formato "2014-06-30 9:17:16". Se a parte do horário for omitida, será considerada meia-noite. Se os segundos forem omitidos, será considerado ":00". Se a parte da data for omitida, será considerado o dia atual. Em vez da expressão numérica, é possível especificar as palavras-chave "ontem", "hoje" ou "amanhã", que se referem à meia-noite do dia anterior ao dia atual, do dia atual ou do dia posterior ao dia atual. Se você especificar "agora", vai se referir ao horário atual. É possível também especificar horários com os prefixos <literal>-</literal> ou <literal>+</literal>, que se referem aos horários antes ou depois do horário atual.
   </para>
   <para>
    Mostrar apenas novas mensagens a partir de agora e atualizar a saída continuamente:
   </para>
<screen># journalctl --since "now" -f</screen>
   <para>
    Mostrar todas as mensagens desde meia-noite passada até às 3h20:
   </para>
<screen># journalctl --since "today" --until "3:20"</screen>
  </sect2>

  <sect2 xml:id="journalctl.filtering.fields">
   <title>Filtrando com base nos campos</title>
   <para>
    É possível filtrar a saída do diário por campos específicos. A sintaxe de um campo para correspondência é <literal>FIELD_NAME=MATCHED_VALUE</literal>, como <literal>_SYSTEMD_UNIT=httpd.service</literal>. É possível especificar várias correspondências em uma única consulta para filtrar ainda mais as mensagens de saída. Consulte <command>man 7 systemd.journal-fields</command> para ver a lista de campos padrão.
   </para>
   <para>
    Mostrar mensagens produzidas por um ID de processo específico:
   </para>
<screen># journalctl _PID=1039</screen>
   <para>
    Mostrar mensagens que pertencem a determinado ID de usuário:
   </para>
<screen># journalctl _UID=1000</screen>
   <para>
    Mostrar mensagens do buffer de anel do kernel (as mesmas que o <command>dmesg</command> produz):
   </para>
<screen># journalctl _TRANSPORT=kernel</screen>
   <para>
    Mostrar mensagens da saída padrão ou de erros do serviço:
   </para>
<screen># journalctl _TRANSPORT=stdout</screen>
   <para>
    Mostrar mensagens produzidas apenas por determinado serviço:
   </para>
<screen># journalctl _SYSTEMD_UNIT=avahi-daemon.service</screen>
   <para>
    Se dois campos diferentes forem especificados, apenas as entradas que corresponderem às duas expressões ao mesmo tempo serão mostradas:
   </para>
<screen># journalctl _SYSTEMD_UNIT=avahi-daemon.service _PID=1488</screen>
   <para>
    Se duas correspondências fizerem referência ao mesmo campo, todas as entradas correspondentes a uma das expressões serão mostradas:
   </para>
<screen># journalctl _SYSTEMD_UNIT=avahi-daemon.service _SYSTEMD_UNIT=dbus.service</screen>
   <para>
    É possível usar o separador ''+'' para combinar duas expressões em um ''OR'' lógico. O seguinte exemplo mostra todas as mensagens do processo do serviço Avahi com ID de processo 1480 juntamente com todas as mensagens do serviço D-Bus:
   </para>
<screen># journalctl _SYSTEMD_UNIT=avahi-daemon.service _PID=1480 + _SYSTEMD_UNIT=dbus.service</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="journalctl.investigate">
  <title>Investigando erros do <systemitem class="daemon">systemd</systemitem></title>

  <para>
   Esta seção apresenta um exemplo simples que ilustra como localizar e corrigir o erro relatado pelo <systemitem class="daemon">systemd</systemitem> durante a inicialização do <command>apache2</command>.
  </para>

  <procedure>
   <step>
    <para>
     Tentar iniciar o serviço apache2:
    </para>
<screen># systemctl start apache2
Job for apache2.service failed. See 'systemctl status apache2' and 'journalctl -xn' for details.</screen>
   </step>
   <step>
    <para>
     Vejamos o que diz o status do serviço:
    </para>
<screen># systemctl status apache2
apache2.service - The Apache Webserver
   Loaded: loaded (/usr/lib/systemd/system/apache2.service; disabled)
   Active: failed (Result: exit-code) since Tue 2014-06-03 11:08:13 CEST; 7min ago
  Process: 11026 ExecStop=/usr/sbin/start_apache2 -D SYSTEMD -DFOREGROUND \
           -k graceful-stop (code=exited, status=1/FAILURE)</screen>
    <para>
     O ID do processo que causa a falha é 11026.
    </para>
   </step>
   <step>
    <para>
     Mostrar a versão verbosa das mensagens relacionadas ao ID de processo 11026:
    </para>
<screen># journalctl -o verbose _PID=11026
[...]
MESSAGE=AH00526: Syntax error on line 6 of /etc/apache2/default-server.conf:
[...]
MESSAGE=Invalid command 'DocumenttRoot', perhaps misspelled or defined by a module
[...]</screen>
   </step>
   <step>
    <para>
     Corrigir o erro de digitação em <filename>/etc/apache2/default-server.conf</filename>, iniciar o serviço apache2 e imprimir seu status:
    </para>
<screen># systemctl start apache2 &amp;&amp; systemctl status apache2
apache2.service - The Apache Webserver
   Loaded: loaded (/usr/lib/systemd/system/apache2.service; disabled)
   Active: active (running) since Tue 2014-06-03 11:26:24 CEST; 4ms ago
  Process: 11026 ExecStop=/usr/sbin/start_apache2 -D SYSTEMD -DFOREGROUND
           -k graceful-stop (code=exited, status=1/FAILURE)
 Main PID: 11263 (httpd2-prefork)
   Status: "Processing requests..."
   CGroup: /system.slice/apache2.service
           ├─11263 /usr/sbin/httpd2-prefork -f /etc/apache2/httpd.conf -D [...]
           ├─11280 /usr/sbin/httpd2-prefork -f /etc/apache2/httpd.conf -D [...]
           ├─11281 /usr/sbin/httpd2-prefork -f /etc/apache2/httpd.conf -D [...]
           ├─11282 /usr/sbin/httpd2-prefork -f /etc/apache2/httpd.conf -D [...]
           ├─11283 /usr/sbin/httpd2-prefork -f /etc/apache2/httpd.conf -D [...]
           └─11285 /usr/sbin/httpd2-prefork -f /etc/apache2/httpd.conf -D [...]
</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="journalctl.config">
  <title>Configuração do journald</title>

  <para>
   É possível ajustar o comportamento do serviço systemd-journald modificando <filename>/etc/systemd/journald.conf</filename>. Esta seção apresenta apenas as configurações de opção básicas. Para ver a descrição completa do arquivo, consulte <command>man 5 journald.conf</command>. Observe que é necessário reiniciar o diário para que as mudanças entrem em vigor com
  </para>

<screen># systemctl restart systemd-journald</screen>

  <sect2 xml:id="journalctl.config.systemmaxuse">
   <title>Mudando o limite de tamanho do diário</title>
   <para>
    Se os dados do registro em diário forem gravados em um local persistente (consulte a <xref linkend="journalctl.persistent"/>), eles usarão até 10% do sistema de arquivos no qual o <filename>/var/log/journal</filename> reside. Por exemplo, se <filename>/var/log/journal</filename> estiver em uma partição <filename>/var</filename> de 30 GB, o diário poderá usar até 3 GB de espaço em disco. Para mudar esse limite, altere (e remova o comentário) a opção <option>SystemMaxUse</option>:
   </para>
<screen>SystemMaxUse=50M</screen>
  </sect2>

  <sect2 xml:id="journalctl.config.ttypath">
   <title>Encaminhando o diário para <filename>/dev/ttyX</filename></title>
   <para>
    É possível encaminhar o diário para um dispositivo de terminal para você receber informações sobre mensagens do sistema na tela de terminal de sua preferência, por exemplo <literal>/dev/tty12</literal>. Mude as seguintes opções de journald para
   </para>
<screen>ForwardToConsole=yes
TTYPath=/dev/tty12</screen>
  </sect2>

  <sect2 xml:id="journalctl.config.forwardtosyslog">
   <title>Encaminhando o diário para o recurso do syslog</title>
   <para>
    O Journald é retroativamente compatível com as implementações tradicionais do syslog, como <systemitem>rsyslog</systemitem>. Verifique se as afirmativas a seguir são válidas:
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      O rsyslog está instalado.
     </para>
<screen># rpm -q rsyslog
rsyslog-7.4.8-2.16.x86_64</screen>
    </listitem>
    <listitem>
     <para>
      O serviço rsyslog está habilitado.
     </para>
<screen># systemctl is-enabled rsyslog
enabled</screen>
    </listitem>
    <listitem>
     <para>
      O encaminhamento para syslog está habilitado em <filename>/etc/systemd/journald.conf</filename>.
     </para>
<screen>ForwardToSyslog=yes</screen>
    </listitem>
   </itemizedlist>
  </sect2>
 </sect1>
 <sect1 xml:id="journalctl.yast">
  <title>Usando o YaST para filtrar o diário do <systemitem class="daemon">systemd</systemitem></title>

  <para>
   Uma forma fácil de filtrar o diário do systemd (sem ter que usar a sintaxe journalctl) é usar o módulo de diário do YaST. Após sua instalação por meio do <command>sudo zypper in yast2-journal</command>, inicie-o do YaST selecionando <menuchoice> <guimenu>Sistema</guimenu> <guimenu>Systemd Journal</guimenu> </menuchoice> (Diário do Systemd). Se preferir, inicie-o da linha de comando digitando <command>sudo yast2 journal</command>.
  </para>

  <figure xml:id="fig.journalctl.yast">
   <title>Diário do systemd no YaST</title>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="yast2_journal.png" width="80%" format="PNG"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="yast2_journal.png" width="85%" format="PNG"/>
    </imageobject>
   </mediaobject>
  </figure>

  <para>
   O módulo exibe as entradas de registro em uma tabela. A caixa de pesquisa na parte superior permite procurar as entradas que incluem determinados caracteres, semelhante ao <command>grep</command>. Para filtrar as entradas por data e horário, unidade, arquivo ou prioridade, clique em <guimenu>Mudar filtro</guimenu> e defina as respectivas opções.
  </para>
 </sect1>
</chapter>
