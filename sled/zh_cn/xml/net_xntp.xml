<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_xntp.xml" version="5.0" xml:id="cha.netz.xntp">



 <title>使用 NTP 同步时间</title>
 <info>
  <abstract>
   <para>
    NTP（网络时间协议）机制是用于同步网络上的系统时间的协议。首先，计算机从作为可靠时间源的服务器获得时间。然后将此计算机用作网络中其他计算机的时间源。这样做有双重目的，既可维护绝对时间，又可保持网络中所有计算机系统时间的同步。
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <para>
  维护确切的系统时间在许多情况下都非常重要。内置硬件时钟往往不能满足数据库或群集这样的应用程序的要求。手动更正系统时间可能会导致许多严重问题，例如向后调整时间将使关键应用程序出现故障。在网络中，通常需要同步所有计算机上的系统时间，但是手动调整时间是一种不好的方法。NTP 提供了解决这些问题的机制。NTP 服务通过网络中的可靠时间服务器持续调整系统时间。它还支持对本地参考时钟（如无线电控制的时钟）进行管理。
 </para>
 <note os="sled;osuse">
  <para>
   要通过 Active Directory 启用时间同步，请遵循<xref linkend="proc.ad.join"/>中的描述。
  </para>
 </note>
 <sect1 xml:id="sec.netz.xntp.yast">
  <title>使用 YaST 配置 NTP 客户端</title>

  <para>
   附于 <systemitem>ntp</systemitem> 包中的 NTP 守护程序 (<systemitem class="daemon">ntpd</systemitem>) 预设置为使用本地计算机时钟作为时间参考。但是，请只在没有更精确的时间源的情况下才使用硬件时钟。YaST 简化了 NTP 客户端的配置。
  </para>

  <sect2 xml:id="sec.net.ntp.yast.basic">
   <title>基本配置</title>
   <para>
    YaST NTP 客户端配置（<menuchoice><guimenu>网络服务</guimenu> <guimenu> NTP 配置</guimenu></menuchoice>）由数个选项卡组成。在<guimenu>常规设置</guimenu>选项卡上设置 <systemitem class="daemon">ntpd</systemitem> 启动模式和要查询的服务器。
   </para>
   <variablelist>
    <varlistentry>
     <term><guimenu>仅手工</guimenu>
     </term>
     <listitem>
      <para>
       如果您想手动启动 <systemitem class="daemon">ntpd</systemitem> 守护程序，请选择<guimenu>仅手动</guimenu>。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><guimenu>不用守护程序同步</guimenu>
     </term>
     <listitem>
      <para>
       选择<guimenu>不用守护程序同步</guimenu>可定期设置系统时间，而不用永久运行 <systemitem class="daemon">ntpd</systemitem>。您可以设置<guimenu>同步间隔（以分钟计）</guimenu>。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><guimenu>立即和引导时</guimenu>
     </term>
     <listitem>
      <para>
       选择<guimenu>立即和引导时</guimenu>可在引导系统时自动启动 <systemitem class="daemon">ntpd</systemitem>。建议使用此设置。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>



  <sect2 xml:id="sec.net.ntp.yast.new_sync">
   <title>更改基本配置</title>
   <para>
    供客户端查询的服务器和其他时间资源列在<guimenu>常规设置</guimenu>选项卡的下半部分。使用<guimenu>添加</guimenu>、<guimenu>编辑</guimenu>和<guimenu>删除</guimenu>可按需修改此列表。<guimenu>显示日志</guimenu>使您能够查看客户端的日志文件。
   </para>
   <para>
    单击<guimenu>添加</guimenu>可添加新的时间信息源。在随后的对话框中，选择要与其进行时间同步的源类型。下列选项可用：
   </para>
   <figure xml:id="fig.yast.ntp.selserv">
    <title>YaST：NTP 服务器</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata width="75%" fileref="yast_ntp_selserv.png" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata width="75%" fileref="yast_ntp_selserv.png" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <variablelist>
    <varlistentry>
     <term>服务器</term>
     <listitem>
      <para>
       在<guimenu>选择</guimenu>下拉列表（请参见<xref linkend="fig.yast.ntp.selserv"/>）中，确定是使用本地网络（<guimenu>本地 NTP 服务器</guimenu>）中的时间服务器设置时间同步，还是使用会考虑所在时区（<guimenu>公共 NTP 服务器</guimenu>）的基于因特网的时间服务器设置时间同步。要使用本地时间服务器，请单击<guimenu>查找</guimenu>启动 SLP 查询，查找网络中的可用时间服务器。从搜索结果列表中选择最适合的时间服务器，然后单击<guimenu>确定</guimenu>退出该对话框。要使用公共时间服务器，请选择您所在的国家或地区（时区），并从<guimenu>公共 NTP 服务器</guimenu>列表中选择适合的服务器，然后单击<guimenu>确定</guimenu>退出该对话框。在主对话框中，用<guimenu>测试</guimenu>来测试所选服务器是否可用。<guimenu>选项</guimenu>使您可以指定 <systemitem class="daemon">ntpd</systemitem> 的其他选项。
      </para>
      <para>
       使用<guimenu>访问控制选项</guimenu>，您可限制远程计算机通过您的计算机上运行的守护程序所能执行的操作。仅在选中<guimenu>安全设置</guimenu>选项卡（请参见<xref linkend="fig.yast.ntp.adv.sec"/>）上的<guimenu>限制 NTP 服务仅用于已配置的服务器</guimenu>后，才能启用此字段。选项对应于 <filename>/etc/ntp.conf</filename> 中的 <literal>restrict</literal> 子句。例如，<literal>nomodify notrap noquery</literal> 禁止服务器修改计算机的 NTP 设置并禁止使用 NTP 守护程序的陷阱工具（一种远程事件记录功能）。建议将这些限制用于超出您控制范围的服务器（例如在因特网上）。
      </para>
      <para>
       有关详细信息，请参见 <filename>/usr/share/doc/packages/ntp-doc</filename>（<systemitem>ntp-doc</systemitem> 包的一部分）。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>同级</term>
     <listitem>
      <para>
       同级是一台要与其建立对称关系的计算机：它将同时用作时间服务器和客户端。要在同一网络中用同级代替某个服务器，请输入系统的地址。该对话框的其他部分与<guimenu>服务器</guimenu>对话框相同。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>无线电时钟</term>
     <listitem>
      <para>
       要在系统中使用无线电时钟来同步时间，请在此对话框中输入时钟类型、单元号码、设备名和其他选项。单击<guimenu>驱动程序校准</guimenu>可对该驱动程序进行微调。有关本地无线电时钟如何操作的详细信息，请参见 <filename>/usr/share/doc/packages/ntp-doc/refclock.html</filename>。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>传出广播</term>
     <listitem>
      <para>
       也可以通过在网络内广播的方式来传送时间信息和查询。在此对话框中，输入应将这类广播信息发送到的地址。除非使用了像无线电控制的时钟这样的可靠时间源，否则不要激活广播。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>传入广播</term>
     <listitem>
      <para>
       如果希望客户端通过广播接收信息，请在此字段中输入应接受来自哪个地址的相应数据包。

      </para>
     </listitem>
    </varlistentry>
   </variablelist>



   <figure xml:id="fig.yast.ntp.adv.sec">
    <title>高级 NTP 配置：安全设置</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata width="75%" fileref="yast2_xntp_adv_sec.png" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata width="75%" fileref="yast2_xntp_adv_sec.png" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    在<guimenu>安全设置</guimenu>选项卡（请参见<xref linkend="fig.yast.ntp.adv.sec"/>）中，确定 <systemitem class="daemon">ntpd</systemitem> 是否应在 chroot jail 中启动。默认不会激活<guimenu>在 Chroot Jail 中运行 NTP 守护程序</guimenu>。当 <systemitem class="daemon">ntpd</systemitem> 受到攻击时，chroot jail 选项可以提高安全性，因为该选项可以防止攻击者危害整个系统。
   </para>
   <para>
    <guimenu>限制 NTP 服务用于配置过的服务器</guimenu>通过禁止远程计算机查看和修改您计算机的 NTP 设置以及禁止使用用于远程事件记录的陷阱工具，从而增强了系统的安全性。启用后，这些限制将应用于所有远程计算机，除非覆盖在<guimenu>常规设置</guimenu>选项卡的时间源列表中对个别计算机的访问控制选项。对于所有其他远程计算机，仅允许查询本地时间。
   </para>
   <para>
    如果 SuSEfirewall2 处于活动状态（默认），请启用<guimenu>打开防火墙中的端口</guimenu>。如果保持端口的关闭状态，则不可能建立与事件服务器的连接。
   </para>
  </sect2>
 </sect1>



 <sect1 xml:id="sec.netz.xntp.netconf">
  <title>手动配置网络中的 NTP</title>

  <para>

   要使用网络中的时间服务器，最简便的方式就是设置服务器参数。例如，如果可以从网络访问名为 <systemitem>ntp.example.com</systemitem> 的时间服务器，请通过添加以下行将其名称添加到文件 <filename>/etc/ntp.conf</filename> 中：
  </para>

<screen>server ntp.example.com</screen>

  <para>
   要添加更多时间服务器，请使用关键字 <literal>server</literal> 插入更多行。使用命令 <command>systemctl start ntp</command> 初始化 <systemitem class="daemon">ntpd</systemitem> 后，系统大约会花费一个小时来稳定时间以及创建用于更正本地计算机时钟的偏移文件。利用偏移文件，当计算机启动时，可以计算出硬件时钟的系统误差。可以立即使用更正功能，使系统时间保持较高的稳定性。
  </para>

  <para>
   有两种方法可将 NTP 机制用作客户端：第一种方法是客户端可以定期从已知服务器查询时间。在存在许多客户端的情况下，这种方法会给服务器带来很高的负荷。第二种方法是客户端可以等待网络中的广播时间服务器发送 NTP 广播。这种方法的缺点在于服务器的可靠性是未知的，而且如果服务器发出错误信息将导致严重问题。
  </para>

  <para>
   如果通过广播获取时间，则不需要服务器名称。此时只需在配置文件 <literal>/etc/ntp.conf</literal> 中输入 <filename>broadcastclient</filename> 一行。要以独占方式使用一个或多个已知时间服务器，请在以 <literal>servers</literal> 开头的行中输入它们的名称。
  </para>


 </sect1>



 <sect1 xml:id="sec.netz.xntp.dynamic">
  <title>运行时动态时间同步</title>



  <para>
   如果在无网络连接的情况下引导系统，则 <systemitem class="daemon">ntpd</systemitem> 将启动，但是它无法解析在配置文件中设置的时间服务器的 DNS 名称。在加密的 Wi-Fi 中使用 NetworkManager 时，可能会发生这种情况。
  </para>

  <para>
   如果希望 <systemitem class="daemon">ntpd</systemitem> 在运行时解析 DNS 名称，则必须设置 <systemitem>dynamic</systemitem> 选项。然后，当引导后建立网络时，<systemitem class="daemon">ntpd</systemitem> 将再次查找名称并可以访问时间服务器以获取时间。
  </para>

  <para>
   手动编辑 <filename>/etc/ntp.conf</filename> 并将 <systemitem>dynamic</systemitem> 添加到一个或多个 <systemitem>server</systemitem> 项：
  </para>

<screen>server ntp.example.com dynamic</screen>

  <para>
   您也可以使用 YaST 并按如下步骤操作：
  </para>

  <procedure>
   <step>
    <para>
     在 YaST 中单击<menuchoice> <guimenu>网络服务</guimenu>
     <guimenu> NTP 配置</guimenu> </menuchoice>。
    </para>
   </step>
   <step>
    <para>
     选择要配置的服务器。然后单击<guimenu>编辑</guimenu>。
    </para>
   </step>
   <step>
    <para>
     激活<guimenu>选项</guimenu>字段并添加 <literal>dynamic</literal>。如果已输入其他选项，请用空格分隔。
    </para>
   </step>
   <step>
    <para>
     单击<guimenu>确定</guimenu>关闭编辑对话框。重复之前的步骤以根据需要更改所有服务器。
    </para>
   </step>
   <step>
    <para>
     最后单击<guimenu>确定</guimenu>保存设置。
    </para>
   </step>
  </procedure>
 </sect1>



 <sect1 xml:id="sec.netz.xntp.normal">
  <title>设置本地参考时钟</title>

  <para>
   软件包 <systemitem class="daemon">ntpd</systemitem> 包含用于连接本地参考时钟的驱动程序。<systemitem class="resource">ntp-doc</systemitem> 包的文件 <filename>/usr/share/doc/packages/ntp-doc/refclock.html</filename> 中提供了受支持时钟的列表。每个驱动程序都有一个关联数字。在 NTP 中，实际配置通过伪 IP 地址实现。时钟被输入 <filename>/etc/ntp.conf</filename> 文件，就像已经在网络中存在一样。为此专门给它们指派了 <literal>127.127.<replaceable>t</replaceable>.<replaceable>u</replaceable></literal>  格式的特殊 IP 地址。其中 <replaceable>t</replaceable> 代表时钟的类型并确定要使用的驱动程序，<replaceable>u</replaceable> 代表设备并确定要使用的接口。

  </para>

  <para>
   通常，各个驱动程序都有特殊的参数来描述配置详细信息。文件 <filename>/usr/share/doc/packages/ntp-doc/drivers/driver<replaceable>NN</replaceable>.html</filename>（其中 <replaceable>NN</replaceable> 是驱动程序的编号）提供了有关特定类型时钟的信息。例如，<quote>8 型</quote>时钟（通过串行接口的无线电时钟）需要额外的方式更精确地指定时钟。以 Conrad DCF77 接收模块为例，该模块需要使用 mode 5。要使用此时钟作为首选参考，应指定关键字 <literal>prefer</literal>。由此构成的 Conrad DCF77 接收模块的完整 <literal>server</literal> 行如下：
  </para>

<screen>server 127.127.8.0 mode 5 prefer</screen>

  <para>
   其他时钟也采用相同的模式。安装 <systemitem class="resource">ntp-doc</systemitem> 包之后，可以在目录 <filename>/usr/share/doc/packages/ntp-doc</filename> 中找到 NTP 的文档。文件 <filename>/usr/share/doc/packages/ntp-doc/refclock.html</filename> 提供指向描述驱动程序参数的驱动程序页的链接。
  </para>
 </sect1>
 <sect1 xml:id="sec.netz.xntp.etr" arch="zseries">
  <title>与外部时间参考 (ETR) 的时钟同步</title>



  <para>
   支持与外部时间参考 (ETR) 时钟同步。外部时间参照每 2**20（2 的 20 次幂）微秒发出一次振荡器信号和同步信号，以将连接的所有服务器的 TOD 时钟保持同步。
  </para>

  <para>
   两个 ETR 计算机可以连接到一台计算机。如果时钟偏移超过同步检查容差，所有 CPU 都会获得一次计算机检查，表示该时钟已失步。如果发生这种情况，在该时钟再次同步前，所有与支持 XRC 的设备进行的 DASD I/O 都将停止。
  </para>

  <para>
   可通过两个 <literal>sysfs</literal> 属性激活 ETR 支持；请以 <systemitem class="username">root</systemitem> 身份运行以下命令：
  </para>

<screen>echo 1 &gt; /sys/devices/system/etr/etr0/online
echo 1 &gt; /sys/devices/system/etr/etr1/online
</screen>
 </sect1>
</chapter>
