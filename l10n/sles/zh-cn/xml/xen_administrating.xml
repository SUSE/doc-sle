<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="xen_administrating.xml" version="5.0" xml:id="cha-xen-admin">
  <title>管理任务</title>
  <info>
    <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
      <dm:bugtracker/>
      <dm:translation>yes</dm:translation>
    </dm:docmanager>
  </info>
  <para/>
  <sect1 xml:id="sec-xen-config-bootloader">
    <title>引导加载器</title>

    <para>
      引导加载器控制虚拟化软件的引导和运行方式。您可以使用 YaST 或者通过直接编辑引导加载器配置文件来修改引导加载器属性。
    </para>

    <para>
      您可以单击 <menuchoice>
      <guimenu>YaST</guimenu> <guimenu>系统</guimenu> <guimenu>引导加载器</guimenu> </menuchoice>访问 YaST 引导加载器。单击<guimenu>引导加载器选项</guimenu>选项卡，然后选择包含 Xen 内核的行作为<guimenu>默认引导部分</guimenu>。
    </para>

    <figure>
      <title>引导加载器设置</title>
      <mediaobject>
        <imageobject role="fo">
          <imagedata fileref="xen_bootloader.png" width="80%"/>
        </imageobject>
        <imageobject role="html">
          <imagedata fileref="xen_bootloader.png" width="80%"/>
        </imageobject>
      </mediaobject>
    </figure>

    <para>
      单击<guimenu>确定</guimenu>进行确认。您下次引导主机时，引导加载器可以提供 Xen 虚拟化环境。
    </para>

    <para>
      您可以使用引导加载器来指定功能，例如：
    </para>

    <itemizedlist mark="bullet" spacing="normal">
      <listitem>
        <para>
          传递内核命令行参数。
        </para>
      </listitem>
      <listitem>
        <para>
          指定内核映像和初始 RAM 磁盘。
        </para>
      </listitem>
      <listitem>
        <para>
          选择特定的超级管理程序。
        </para>
      </listitem>
      <listitem>
        <para>
          向超级管理程序传递其他参数。有关完整的参数列表，请参见 <link xlink:href="http://xenbits.xen.org/docs/unstable/misc/xen-command-line.html"/>。
        </para>
      </listitem>
    </itemizedlist>

    <para>
      可以通过编辑 <filename>/etc/default/grub</filename> 文件来自定义虚拟化环境。将以下行添加到此文件中：<literal>GRUB_CMDLINE_XEN="&lt;boot_parameters&gt;"</literal>。编辑该文件后，请不要忘记运行 <command>grub2-mkconfig -o
      /boot/grub2/grub.cfg</command>。
    </para>
  </sect1>
  <sect1 xml:id="sec-xen-config-sparse">
    <title>稀疏映像文件和磁盘空间</title>

    <para>
      如果主机的物理磁盘已没有可用空间，使用基于稀疏映像文件的虚拟磁盘的虚拟机将无法向其磁盘写入数据。因此，它会报告 I/O 错误。
    </para>

    <para>
      如果发生这种情况，您应该释放物理磁盘上的可用空间，重新挂载虚拟机的文件系统，然后将文件系统重新设置为读写模式。
    </para>

    <para>
      要检查稀疏映像文件的实际磁盘要求，请使用 <command>du -h &lt;image file&gt;</command> 命令。
    </para>

    <para>
      要增加稀疏映像文件的可用空间，请先增加文件大小，然后增加文件系统的大小。
    </para>

    <warning>
      <title>在调整大小之前备份文件</title>
      <para>
        改动分区或稀疏文件的大小始终要承担数据失败的风险。在未备份的情况下，请不要执行此操作。
      </para>
    </warning>

    <para>
      可以在 VM Guest 运行时联机调整映像文件的大小。使用以下命令增加稀疏映像文件的大小：
    </para>

<screen><prompt>&gt; </prompt><command>sudo</command> dd if=/dev/zero of=&lt;image file&gt; count=0 bs=1M seek=&lt;new size in MB&gt;</screen>

    <para>
      例如，要将 <filename>/var/lib/xen/images/sles/disk0</filename> 文件的大小增至 16GB，请使用以下命令：
    </para>

<screen><prompt>&gt; </prompt><command>sudo</command> dd if=/dev/zero of=/var/lib/xen/images/sles/disk0 count=0 bs=1M seek=16000</screen>

    <note>
      <title>增加非稀疏映像大小</title>
      <para>
        还可以增加设备的非稀疏映像文件的大小，但您必须知道上一个映像的具体结束位置。使用 seek 参数指向映像文件的末尾，然后使用如下所示的命令：
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> dd if=/dev/zero of=/var/lib/xen/images/sles/disk0 seek=8000 bs=1M count=2000</screen>
    </note>

    <para>
      请务必正确使用 seek，否则可能发生数据丢失情况。
    </para>

    <para>
      如果在 VM Guest 运行时执行大小调整操作，另外还需调整向 VM Guest 提供映像文件的循环设备的大小。首先使用以下命令检测正确的循环设备：
    </para>

<screen><prompt>&gt; </prompt><command>sudo</command> losetup -j /var/lib/xen/images/sles/disk0</screen>

    <para>
      然后使用以下命令调整循环设备（例如 <filename>/dev/loop0</filename>）的大小：
    </para>

<screen><prompt>&gt; </prompt><command>sudo</command> losetup -c /dev/loop0</screen>

    <para>
      最后使用 <command>fdisk -l /dev/xvdb</command> 命令检查 Guest 系统中块设备的大小。请将设备名称替换为已增大的磁盘的名称。
    </para>

    <para>
      调整稀疏文件中的文件系统大小所涉及到的工具取决于实际文件系统。<phrase os="sles"><xref linkend="book-storage"/>中对此做了详细说明。</phrase>
    </para>
  </sect1>
  <sect1 xml:id="sec-xen-manage-migrate">
    <title>迁移 Xen VM Guest 系统</title>

    <para>
      在 Xen 中，可将 VM Guest 系统从一台 VM 主机服务器迁移到另一台 VM 主机服务器，而且几乎不会造成服务中断。例如，可以使用此功能将一个繁忙的 VM Guest 转移到一台硬件更强大或者尚无负载的 VM 主机服务器。或者，如果 VM 主机服务器的某项服务不能中断，可将此计算机上运行的所有 VM Guest 系统迁移到其他计算机，以避免该服务中断。这只是其中的两个例子 — 在您的个人使用情形中，可能还有许多其他迁移原因。
    </para>

    <para>
      在开始之前，需要了解有关 VM 主机服务器的某些应预先注意的事项：
    </para>

    <itemizedlist mark="bullet" spacing="normal">
      <listitem>
        <para>
          所有 VM 主机服务器系统应使用类似的 CPU。CPU 的频率并不是很重要，但它们应该使用同一 CPU 系列。要获取有关所用 CPU 的详细信息，请使用 <command>cat
          /proc/cpuinfo</command>。<xref linkend="sec-xen-manage-migrate-cpu"/>中提供了有关比较主机 CPU 功能的更多细节。
        </para>
      </listitem>
      <listitem>
        <para>
          特定 Guest 系统使用的所有资源必须已在所有相关 VM 主机服务器系统上提供 — 例如，使用的所有块设备必须在两个 VM 主机服务器系统上均存在。
        </para>
      </listitem>
      <listitem>
        <para>
          如果迁移过程涉及的主机在不同的子网中运行，请确保 Guest 可以使用 DHCP 中继，或者针对采用静态网络配置的 Guest 手动设置网络。
        </para>
      </listitem>
      <listitem>
        <para>
          使用 <literal>PCI Pass-Through</literal>等特殊功能可能会造成问题。为可能会在不同 VM 主机服务器系统之间迁移 VM Guest 系统的环境部署虚拟机时，请不要实施这些功能。
        </para>
      </listitem>
      <listitem>
        <para>
          为了快速迁移，必须设置一个快速网络。如果可能，请使用 GB 以太网和快速交换机。部署 VLAN 也可能有助于避免冲突。
        </para>
      </listitem>
    </itemizedlist>

    <sect2 xml:id="sec-xen-manage-migrate-cpu">
      <title>检测 CPU 功能</title>
      <para>
        可以使用 <systemitem>cpuid</systemitem> 和 <systemitem>xen_maskcalc.py</systemitem> 工具，将您要从中迁移源 VM Guest 的主机上的 CPU 功能与目标主机上的 CPU 功能进行比较。这样，您就可以更好地预测 Guest 迁移是否会成功。
      </para>
      <procedure>
        <step>
          <para>
            在预期要运行或接收迁移的 VM Guest 的每个 Dom0 上运行 <command>cpuid -1r</command> 命令，然后在文本文件中捕获输出，例如：
          </para>
<screen>
<prompt>tux@vm_host1 &gt; </prompt>sudo cpuid -1r &gt; vm_host1.txt
<prompt>tux@vm_host2 &gt; </prompt>sudo cpuid -1r &gt; vm_host2.txt
<prompt>tux@vm_host3 &gt; </prompt>sudo cpuid -1r &gt; vm_host3.txt
</screen>
        </step>
        <step>
          <para>
            将所有输出文本文件复制到装有 <command>xen_maskcalc.py</command> 脚本的主机上。
          </para>
        </step>
        <step>
          <para>
            针对所有输出文本文件运行 <command>xen_maskcalc.py</command> 脚本：
          </para>
<screen>
<prompt>&gt; </prompt><command>sudo</command> xen_maskcalc.py vm_host1.txt vm_host2.txt vm_host3.txt
cpuid = [
    "0x00000001:ecx=x00xxxxxx0xxxxxxxxx00xxxxxxxxxxx",
    "0x00000007,0x00:ebx=xxxxxxxxxxxxxxxxxx00x0000x0x0x00"
]
</screen>
        </step>
        <step>
          <para>
            将输出的 <literal>cpuid=[...]</literal> 配置片段复制到迁移的 Guest <filename>domU.cfg</filename> 的 <command>xl</command> 配置中，或复制到其 <systemitem class="library">libvirt</systemitem> 的 XML 配置中。
          </para>
        </step>
        <step>
          <para>
            使用<emphasis>经过删减的</emphasis> CPU 配置启动源 Guest。现在，Guest 只能使用每台主机上提供的 CPU 功能。
          </para>
        </step>
      </procedure>
      <tip>
        <para>
          <systemitem class="library">libvirt</systemitem> 还支持计算用于迁移的基线 CPU。有关详细信息，请参考 <link xlink:href="https://documentation.suse.com/sles-15/html/SLES-all/article-virtualization-best-practices.html"/>。
        </para>
      </tip>
      <sect3 xml:id="sec-xen-manage-migrate-cpu-info">
        <title>更多信息</title>
        <para>
          <link xlink:href="http://etallen.com/cpuid.html"/> 上提供了有关 <systemitem>cpuid</systemitem> 的更多细节。
        </para>
        <para>
          您可以从 <link xlink:href="https://github.com/twizted/xen_maskcalc"/> 下载最新版本的 CPU 掩码计算器。
        </para>
      </sect3>
    </sect2>

    <sect2 xml:id="sec-xen-manage-migrate-block">
      <title>准备要迁移的块设备</title>
      <para>
        VM Guest 系统所需的块设备必须已在所有相关 VM 主机服务器系统上提供。要做到这一点，可以实施特定类型的共享存储，用于充当所迁移 VM Guest 系统的根文件系统的容器。常见的做法包括：
      </para>
      <itemizedlist mark="bullet" spacing="normal">
        <listitem>
          <para>
            可以设置 <literal>iSCSI</literal>，以便可从不同的系统同时访问相同的块设备。<phrase os="sles">有关 iSCSI 的详细信息，请参见<xref linkend="cha-iscsi"/>。</phrase>
          </para>
        </listitem>
        <listitem>
          <para>
            <literal>NFS</literal> 是广泛使用的根文件系统，用户可从不同的位置轻松访问该文件系统。有关详细信息，请参见<xref linkend="cha-nfs"/>。
          </para>
        </listitem>
        <listitem>
          <para>
            如果只涉及到两个 VM 主机服务器系统，则可以使用 <literal>DRBD</literal>。这会在一定程度上提高数据安全性，因为此方法会通过网络镜像使用的数据。<phrase os="sles;sled">有关详细信息，请参见 <link xlink:href="https://documentation.suse.com/sle-ha-15/"/></phrase> 上的 <citetitle>SUSE Linux Enterprise High
            Availability Extension <phrase role="productnumber"><phrase os="sles;sled">15 SP5</phrase></phrase></citetitle> 文档。
          </para>
        </listitem>
        <listitem>
          <para>
            如果提供的硬件允许对相同磁盘进行共享访问，则还可以使用 <literal>SCSI</literal>。
          </para>
        </listitem>
        <listitem>
          <para>
            <literal>NPIV</literal> 是使用光纤通道磁盘的特殊模式。但在这种情况下，所有迁移主机都必须挂接到同一个光纤通道交换机。有关 NPIV 的详细信息，请参见<xref linkend="sec-xen-config-disk"/>。一般而言，如果光纤通道环境支持 4 Gbps 或更快的连接，便可使用此方式。
          </para>
        </listitem>
      </itemizedlist>
    </sect2>

    <sect2 xml:id="sec-xen-manage-migrate-xl">
      <title>迁移 VM Guest 系统</title>
      <para>
        VM Guest 系统的实际迁移是使用以下命令完成的：
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> xl migrate &lt;domain_name&gt; &lt;host&gt;</screen>
      <para>
        迁移速度取决于将占用内存的内容保存到磁盘、发送到 VM 主机服务器并在该处装载的速度。也就是说，迁移小型 VM Guest 系统可能比迁移包含大量内存的大型系统的速度更快。
      </para>
    </sect2>
  </sect1>
  <sect1 xml:id="sec-xen-monitor">
    <title>监视 Xen</title>

    <para>
      在对众多虚拟 Guest 进行常规运维时，检查所有不同 VM Guest 系统的健全性是必不可少的功能。除了系统工具以外，Xen 还提供了数个工具用于收集有关系统的信息。
    </para>

    <tip>
      <title>监视 VM 主机服务器</title>
      <para>
        可以通过虚拟机管理器监视 VM 主机服务器的基本情况（I/O 和 CPU）。有关详细信息，请参考 <xref linkend="cha-libvirt-admin-monitor-virt-manager"/>。
      </para>
    </tip>

    <sect2 xml:id="sec-xen-monitor-xentop">
      <title>使用 <command>xentop</command> 监视 Xen</title>
      <para>
        用于收集有关 Xen 虚拟环境的信息的首选终端应用程序是 <command>xentop</command>。请注意，此工具需要一个相当宽的终端，否则它会在显示内容中插入换行符。
      </para>
      <para>
        <command>xentop</command> 提供多个命令键，可供您查看有关所监视系统的详细信息。例如：
      </para>
      <variablelist>
        <varlistentry>
          <term>D</term>
          <listitem>
            <para>
              更改屏幕两次刷新相隔的延迟时间。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term>N</term>
          <listitem>
            <para>
              同时显示网络统计信息。请注意，只会显示标准配置。如果您使用路由网络等特殊配置，将不会显示网络。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term>B</term>
          <listitem>
            <para>
              显示相应的块设备及其累计使用次数。
            </para>
          </listitem>
        </varlistentry>
      </variablelist>
      <para>
        有关 <command>xentop</command> 的详细信息，请参见手册页 <command>man 1 xentop</command>。
      </para>
      <tip>
        <title><command>virt-top</command></title>
        <para>
          libvirt 提供不限定超级管理程序的工具 <command>virt-top</command>，建议使用此工具来监视 VM Guest。有关详细信息，请参见<xref linkend="cha-libvirt-admin-monitor-virt-top"/>。
        </para>
      </tip>
    </sect2>

    <sect2 xml:id="sec-xen-monitor-tools">
      <title>其他工具</title>
      <para>
        我们还提供了许多系统工具来帮助您监视或调试运行中的 <phrase os="sles;sled">SUSE Linux Enterprise</phrase> 系统。<xref linkend="cha-util"/>中介绍了其中一些工具。以下工具特别适合用于监视虚拟化环境：
      </para>
      <variablelist>
        <varlistentry>
          <term>ip</term>
          <listitem>
            <para>
              命令行实用程序 <command>ip</command> 可用于监视任意网络接口。如果您设置了路由网络或者应用了掩蔽网络，此实用程序特别有用。要监视名为 <literal>alice.0</literal> 的网络接口，请运行以下命令：
            </para>
<screen><prompt>&gt; </prompt>watch ip -s link show alice.0</screen>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term>bridge</term>
          <listitem>
            <para>
              在标准设置中，所有 Xen VM Guest 系统都会挂接到虚拟网桥。使用 <command>bridge</command> 可以确定 VM Guest 系统中网桥与虚拟网络适配器之间的连接。例如，<command>bridge link</command> 的输出可能如下所示：
            </para>
<screen>
2: eth0 state DOWN : &lt;NO-CARRIER, ...,UP&gt; mtu 1500 master br0
8: vnet0 state UNKNOWN : &lt;BROADCAST, ...,LOWER_UP&gt; mtu 1500 master virbr0 \
  state forwarding priority 32 cost 100
</screen>
            <para>
              此输出表明系统上定义了两个虚拟网桥。一个网桥连接到物理以太网设备 <literal>eth0</literal>，另一个网桥连接到 VLAN 接口 <literal>vnet0</literal>。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term>iptables-save</term>
          <listitem>
            <para>
              使用掩蔽网络时，或者设置了多个以太网接口并与防火墙设置结合使用时，此工具特别有用，它可以帮助检查当前的防火墙规则。
            </para>
            <para>
              <command>iptables</command> 命令可用于检查所有不同的防火墙设置。要列出某个链甚至整个设置的所有规则，可以使用 <command>iptables-save</command> 或 <command>iptables
              -S</command> 命令。
            </para>
          </listitem>
        </varlistentry>
      </variablelist>
    </sect2>
  </sect1>
  <sect1 xml:id="sec-xen-admin-vhostmd">
    <title>提供 VM Guest 系统的主机信息</title>

    <para>
      在标准 Xen 环境中，VM Guest 系统只能获得有关运行它的 VM 主机服务器系统的有限信息。如果某个 Guest 应该了解有关运行它的 VM 主机服务器的更多信息，<systemitem>vhostmd</systemitem> 可为选定 Guest 提供详细信息。要设置系统以运行 <systemitem>vhostmd</systemitem>，请执行以下操作：
    </para>

    <procedure>
      <step>
        <para>
          在 VM 主机服务器上安装 vhostmd 软件包。
        </para>
      </step>
      <step>
        <para>
          要在配置中添加或去除 <literal>metric</literal> 部分，请编辑文件 <filename>/etc/vhostmd/vhostmd.conf</filename>。不过，默认设置也可正常工作。
        </para>
      </step>
      <step>
        <para>
          使用以下命令检查 <filename>vhostmd.conf</filename> 配置文件的有效性：
        </para>
<screen><prompt>&gt; </prompt>cd /etc/vhostmd
<prompt>&gt; </prompt>xmllint --postvalid --noout vhostmd.conf
    </screen>
      </step>
      <step>
        <para>
          使用 <command>sudo systemctl
          start vhostmd</command> 命令启动 vhostmd 守护程序。
        </para>
        <para>
          如果系统启动期间应自动启动 vhostmd，请运行以下命令：
        </para>
<screen><prompt>&gt; </prompt><command>sudo</command> systemctl enable vhostmd</screen>
      </step>
      <step>
        <para>
          使用以下命令将映像文件 <filename>/dev/shm/vhostmd0</filename> 挂接到名为 alice 的 VM Guest 系统：
        </para>
<screen><prompt>&gt; </prompt>xl block-attach opensuse /dev/shm/vhostmd0,,xvdb,ro</screen>
      </step>
      <step>
        <para>
          在 VM Guest 系统上登录。
        </para>
      </step>
      <step>
        <para>
          安装客户端软件包 <systemitem>vm-dump-metrics</systemitem>。
        </para>
      </step>
      <step>
        <para>
          运行 <command>vm-dump-metrics</command> 命令。要将结果保存到文件中，请使用选项 <systemitem>-d
          &lt;filename&gt;</systemitem>。
        </para>
      </step>
    </procedure>

    <para>
      <systemitem>vm-dump-metrics</systemitem> 返回的结果为 XML 输出。相应的度量项遵循 DTD <filename>/etc/vhostmd/metric.dtd</filename>。
    </para>

    <para>
      有关详细信息，请参见 VM 主机服务器系统上的手册页 <command>man 8
      vhostmd</command> 和 <filename>/usr/share/doc/vhostmd/README</filename>。在 Guest 上，请参见手册页 <command>man 1
      vm-dump-metrics</command>。
    </para>
  </sect1>
</chapter>
